(function(Pe,Ce){typeof exports=="object"&&typeof module<"u"?Ce(exports):typeof define=="function"&&define.amd?define(["exports"],Ce):(Pe=typeof globalThis<"u"?globalThis:Pe||self,Ce(Pe.JmonStudio={}))})(this,(function(Pe){"use strict";function Ce(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var Fe={exports:{}},Nt={},ye={},Se={},Ct={},It={},jt={},tr;function ze(){return tr||(tr=1,(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.regexpCode=o.getEsmExportName=o.getProperty=o.safeStringify=o.stringify=o.strConcat=o.addCodeArg=o.str=o._=o.nil=o._Code=o.Name=o.IDENTIFIER=o._CodeOrName=void 0;class e{}o._CodeOrName=e,o.IDENTIFIER=/^[a-z$_][a-z$_0-9]*$/i;class t extends e{constructor(l){if(super(),!o.IDENTIFIER.test(l))throw new Error("CodeGen: name must be a valid identifier");this.str=l}toString(){return this.str}emptyStr(){return!1}get names(){return{[this.str]:1}}}o.Name=t;class r extends e{constructor(l){super(),this._items=typeof l=="string"?[l]:l}toString(){return this.str}emptyStr(){if(this._items.length>1)return!1;const l=this._items[0];return l===""||l==='""'}get str(){var l;return(l=this._str)!==null&&l!==void 0?l:this._str=this._items.reduce((f,g)=>`${f}${g}`,"")}get names(){var l;return(l=this._names)!==null&&l!==void 0?l:this._names=this._items.reduce((f,g)=>(g instanceof t&&(f[g.str]=(f[g.str]||0)+1),f),{})}}o._Code=r,o.nil=new r("");function n(h,...l){const f=[h[0]];let g=0;for(;g<l.length;)a(f,l[g]),f.push(h[++g]);return new r(f)}o._=n;const i=new r("+");function s(h,...l){const f=[_(h[0])];let g=0;for(;g<l.length;)f.push(i),a(f,l[g]),f.push(i,_(h[++g]));return c(f),new r(f)}o.str=s;function a(h,l){l instanceof r?h.push(...l._items):l instanceof t?h.push(l):h.push(m(l))}o.addCodeArg=a;function c(h){let l=1;for(;l<h.length-1;){if(h[l]===i){const f=u(h[l-1],h[l+1]);if(f!==void 0){h.splice(l-1,3,f);continue}h[l++]="+"}l++}}function u(h,l){if(l==='""')return h;if(h==='""')return l;if(typeof h=="string")return l instanceof t||h[h.length-1]!=='"'?void 0:typeof l!="string"?`${h.slice(0,-1)}${l}"`:l[0]==='"'?h.slice(0,-1)+l.slice(1):void 0;if(typeof l=="string"&&l[0]==='"'&&!(h instanceof t))return`"${h}${l.slice(1)}`}function d(h,l){return l.emptyStr()?h:h.emptyStr()?l:s`${h}${l}`}o.strConcat=d;function m(h){return typeof h=="number"||typeof h=="boolean"||h===null?h:_(Array.isArray(h)?h.join(","):h)}function $(h){return new r(_(h))}o.stringify=$;function _(h){return JSON.stringify(h).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")}o.safeStringify=_;function E(h){return typeof h=="string"&&o.IDENTIFIER.test(h)?new r(`.${h}`):n`[${h}]`}o.getProperty=E;function w(h){if(typeof h=="string"&&o.IDENTIFIER.test(h))return new r(`${h}`);throw new Error(`CodeGen: invalid export name: ${h}, use explicit $id name mapping`)}o.getEsmExportName=w;function p(h){return new r(h.toString())}o.regexpCode=p})(jt)),jt}var Ot={},rr;function nr(){return rr||(rr=1,(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.ValueScope=o.ValueScopeName=o.Scope=o.varKinds=o.UsedValueState=void 0;const e=ze();class t extends Error{constructor(u){super(`CodeGen: "code" for ${u} not defined`),this.value=u.value}}var r;(function(c){c[c.Started=0]="Started",c[c.Completed=1]="Completed"})(r||(o.UsedValueState=r={})),o.varKinds={const:new e.Name("const"),let:new e.Name("let"),var:new e.Name("var")};class n{constructor({prefixes:u,parent:d}={}){this._names={},this._prefixes=u,this._parent=d}toName(u){return u instanceof e.Name?u:this.name(u)}name(u){return new e.Name(this._newName(u))}_newName(u){const d=this._names[u]||this._nameGroup(u);return`${u}${d.index++}`}_nameGroup(u){var d,m;if(!((m=(d=this._parent)===null||d===void 0?void 0:d._prefixes)===null||m===void 0)&&m.has(u)||this._prefixes&&!this._prefixes.has(u))throw new Error(`CodeGen: prefix "${u}" is not allowed in this scope`);return this._names[u]={prefix:u,index:0}}}o.Scope=n;class i extends e.Name{constructor(u,d){super(d),this.prefix=u}setValue(u,{property:d,itemIndex:m}){this.value=u,this.scopePath=(0,e._)`.${new e.Name(d)}[${m}]`}}o.ValueScopeName=i;const s=(0,e._)`\n`;class a extends n{constructor(u){super(u),this._values={},this._scope=u.scope,this.opts={...u,_n:u.lines?s:e.nil}}get(){return this._scope}name(u){return new i(u,this._newName(u))}value(u,d){var m;if(d.ref===void 0)throw new Error("CodeGen: ref must be passed in value");const $=this.toName(u),{prefix:_}=$,E=(m=d.key)!==null&&m!==void 0?m:d.ref;let w=this._values[_];if(w){const l=w.get(E);if(l)return l}else w=this._values[_]=new Map;w.set(E,$);const p=this._scope[_]||(this._scope[_]=[]),h=p.length;return p[h]=d.ref,$.setValue(d,{property:_,itemIndex:h}),$}getValue(u,d){const m=this._values[u];if(m)return m.get(d)}scopeRefs(u,d=this._values){return this._reduceValues(d,m=>{if(m.scopePath===void 0)throw new Error(`CodeGen: name "${m}" has no value`);return(0,e._)`${u}${m.scopePath}`})}scopeCode(u=this._values,d,m){return this._reduceValues(u,$=>{if($.value===void 0)throw new Error(`CodeGen: name "${$}" has no value`);return $.value.code},d,m)}_reduceValues(u,d,m={},$){let _=e.nil;for(const E in u){const w=u[E];if(!w)continue;const p=m[E]=m[E]||new Map;w.forEach(h=>{if(p.has(h))return;p.set(h,r.Started);let l=d(h);if(l){const f=this.opts.es5?o.varKinds.var:o.varKinds.const;_=(0,e._)`${_}${f} ${h} = ${l};${this.opts._n}`}else if(l=$?.(h))_=(0,e._)`${_}${l}${this.opts._n}`;else throw new t(h);p.set(h,r.Completed)})}return _}}o.ValueScope=a})(Ot)),Ot}var ir;function Y(){return ir||(ir=1,(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.or=o.and=o.not=o.CodeGen=o.operators=o.varKinds=o.ValueScopeName=o.ValueScope=o.Scope=o.Name=o.regexpCode=o.stringify=o.getProperty=o.nil=o.strConcat=o.str=o._=void 0;const e=ze(),t=nr();var r=ze();Object.defineProperty(o,"_",{enumerable:!0,get:function(){return r._}}),Object.defineProperty(o,"str",{enumerable:!0,get:function(){return r.str}}),Object.defineProperty(o,"strConcat",{enumerable:!0,get:function(){return r.strConcat}}),Object.defineProperty(o,"nil",{enumerable:!0,get:function(){return r.nil}}),Object.defineProperty(o,"getProperty",{enumerable:!0,get:function(){return r.getProperty}}),Object.defineProperty(o,"stringify",{enumerable:!0,get:function(){return r.stringify}}),Object.defineProperty(o,"regexpCode",{enumerable:!0,get:function(){return r.regexpCode}}),Object.defineProperty(o,"Name",{enumerable:!0,get:function(){return r.Name}});var n=nr();Object.defineProperty(o,"Scope",{enumerable:!0,get:function(){return n.Scope}}),Object.defineProperty(o,"ValueScope",{enumerable:!0,get:function(){return n.ValueScope}}),Object.defineProperty(o,"ValueScopeName",{enumerable:!0,get:function(){return n.ValueScopeName}}),Object.defineProperty(o,"varKinds",{enumerable:!0,get:function(){return n.varKinds}}),o.operators={GT:new e._Code(">"),GTE:new e._Code(">="),LT:new e._Code("<"),LTE:new e._Code("<="),EQ:new e._Code("==="),NEQ:new e._Code("!=="),NOT:new e._Code("!"),OR:new e._Code("||"),AND:new e._Code("&&"),ADD:new e._Code("+")};class i{optimizeNodes(){return this}optimizeNames(y,S){return this}}class s extends i{constructor(y,S,x){super(),this.varKind=y,this.name=S,this.rhs=x}render({es5:y,_n:S}){const x=y?t.varKinds.var:this.varKind,F=this.rhs===void 0?"":` = ${this.rhs}`;return`${x} ${this.name}${F};`+S}optimizeNames(y,S){if(y[this.name.str])return this.rhs&&(this.rhs=X(this.rhs,y,S)),this}get names(){return this.rhs instanceof e._CodeOrName?this.rhs.names:{}}}class a extends i{constructor(y,S,x){super(),this.lhs=y,this.rhs=S,this.sideEffects=x}render({_n:y}){return`${this.lhs} = ${this.rhs};`+y}optimizeNames(y,S){if(!(this.lhs instanceof e.Name&&!y[this.lhs.str]&&!this.sideEffects))return this.rhs=X(this.rhs,y,S),this}get names(){const y=this.lhs instanceof e.Name?{}:{...this.lhs.names};return U(y,this.rhs)}}class c extends a{constructor(y,S,x,F){super(y,x,F),this.op=S}render({_n:y}){return`${this.lhs} ${this.op}= ${this.rhs};`+y}}class u extends i{constructor(y){super(),this.label=y,this.names={}}render({_n:y}){return`${this.label}:`+y}}class d extends i{constructor(y){super(),this.label=y,this.names={}}render({_n:y}){return`break${this.label?` ${this.label}`:""};`+y}}class m extends i{constructor(y){super(),this.error=y}render({_n:y}){return`throw ${this.error};`+y}get names(){return this.error.names}}class $ extends i{constructor(y){super(),this.code=y}render({_n:y}){return`${this.code};`+y}optimizeNodes(){return`${this.code}`?this:void 0}optimizeNames(y,S){return this.code=X(this.code,y,S),this}get names(){return this.code instanceof e._CodeOrName?this.code.names:{}}}class _ extends i{constructor(y=[]){super(),this.nodes=y}render(y){return this.nodes.reduce((S,x)=>S+x.render(y),"")}optimizeNodes(){const{nodes:y}=this;let S=y.length;for(;S--;){const x=y[S].optimizeNodes();Array.isArray(x)?y.splice(S,1,...x):x?y[S]=x:y.splice(S,1)}return y.length>0?this:void 0}optimizeNames(y,S){const{nodes:x}=this;let F=x.length;for(;F--;){const z=x[F];z.optimizeNames(y,S)||(ne(y,z.names),x.splice(F,1))}return x.length>0?this:void 0}get names(){return this.nodes.reduce((y,S)=>B(y,S.names),{})}}class E extends _{render(y){return"{"+y._n+super.render(y)+"}"+y._n}}class w extends _{}class p extends E{}p.kind="else";class h extends E{constructor(y,S){super(S),this.condition=y}render(y){let S=`if(${this.condition})`+super.render(y);return this.else&&(S+="else "+this.else.render(y)),S}optimizeNodes(){super.optimizeNodes();const y=this.condition;if(y===!0)return this.nodes;let S=this.else;if(S){const x=S.optimizeNodes();S=this.else=Array.isArray(x)?new p(x):x}if(S)return y===!1?S instanceof h?S:S.nodes:this.nodes.length?this:new h(ue(y),S instanceof h?[S]:S.nodes);if(!(y===!1||!this.nodes.length))return this}optimizeNames(y,S){var x;if(this.else=(x=this.else)===null||x===void 0?void 0:x.optimizeNames(y,S),!!(super.optimizeNames(y,S)||this.else))return this.condition=X(this.condition,y,S),this}get names(){const y=super.names;return U(y,this.condition),this.else&&B(y,this.else.names),y}}h.kind="if";class l extends E{}l.kind="for";class f extends l{constructor(y){super(),this.iteration=y}render(y){return`for(${this.iteration})`+super.render(y)}optimizeNames(y,S){if(super.optimizeNames(y,S))return this.iteration=X(this.iteration,y,S),this}get names(){return B(super.names,this.iteration.names)}}class g extends l{constructor(y,S,x,F){super(),this.varKind=y,this.name=S,this.from=x,this.to=F}render(y){const S=y.es5?t.varKinds.var:this.varKind,{name:x,from:F,to:z}=this;return`for(${S} ${x}=${F}; ${x}<${z}; ${x}++)`+super.render(y)}get names(){const y=U(super.names,this.from);return U(y,this.to)}}class b extends l{constructor(y,S,x,F){super(),this.loop=y,this.varKind=S,this.name=x,this.iterable=F}render(y){return`for(${this.varKind} ${this.name} ${this.loop} ${this.iterable})`+super.render(y)}optimizeNames(y,S){if(super.optimizeNames(y,S))return this.iterable=X(this.iterable,y,S),this}get names(){return B(super.names,this.iterable.names)}}class v extends E{constructor(y,S,x){super(),this.name=y,this.args=S,this.async=x}render(y){return`${this.async?"async ":""}function ${this.name}(${this.args})`+super.render(y)}}v.kind="func";class P extends _{render(y){return"return "+super.render(y)}}P.kind="return";class A extends E{render(y){let S="try"+super.render(y);return this.catch&&(S+=this.catch.render(y)),this.finally&&(S+=this.finally.render(y)),S}optimizeNodes(){var y,S;return super.optimizeNodes(),(y=this.catch)===null||y===void 0||y.optimizeNodes(),(S=this.finally)===null||S===void 0||S.optimizeNodes(),this}optimizeNames(y,S){var x,F;return super.optimizeNames(y,S),(x=this.catch)===null||x===void 0||x.optimizeNames(y,S),(F=this.finally)===null||F===void 0||F.optimizeNames(y,S),this}get names(){const y=super.names;return this.catch&&B(y,this.catch.names),this.finally&&B(y,this.finally.names),y}}class I extends E{constructor(y){super(),this.error=y}render(y){return`catch(${this.error})`+super.render(y)}}I.kind="catch";class q extends E{render(y){return"finally"+super.render(y)}}q.kind="finally";class V{constructor(y,S={}){this._values={},this._blockStarts=[],this._constants={},this.opts={...S,_n:S.lines?`
`:""},this._extScope=y,this._scope=new t.Scope({parent:y}),this._nodes=[new w]}toString(){return this._root.render(this.opts)}name(y){return this._scope.name(y)}scopeName(y){return this._extScope.name(y)}scopeValue(y,S){const x=this._extScope.value(y,S);return(this._values[x.prefix]||(this._values[x.prefix]=new Set)).add(x),x}getScopeValue(y,S){return this._extScope.getValue(y,S)}scopeRefs(y){return this._extScope.scopeRefs(y,this._values)}scopeCode(){return this._extScope.scopeCode(this._values)}_def(y,S,x,F){const z=this._scope.toName(S);return x!==void 0&&F&&(this._constants[z.str]=x),this._leafNode(new s(y,z,x)),z}const(y,S,x){return this._def(t.varKinds.const,y,S,x)}let(y,S,x){return this._def(t.varKinds.let,y,S,x)}var(y,S,x){return this._def(t.varKinds.var,y,S,x)}assign(y,S,x){return this._leafNode(new a(y,S,x))}add(y,S){return this._leafNode(new c(y,o.operators.ADD,S))}code(y){return typeof y=="function"?y():y!==e.nil&&this._leafNode(new $(y)),this}object(...y){const S=["{"];for(const[x,F]of y)S.length>1&&S.push(","),S.push(x),(x!==F||this.opts.es5)&&(S.push(":"),(0,e.addCodeArg)(S,F));return S.push("}"),new e._Code(S)}if(y,S,x){if(this._blockNode(new h(y)),S&&x)this.code(S).else().code(x).endIf();else if(S)this.code(S).endIf();else if(x)throw new Error('CodeGen: "else" body without "then" body');return this}elseIf(y){return this._elseNode(new h(y))}else(){return this._elseNode(new p)}endIf(){return this._endBlockNode(h,p)}_for(y,S){return this._blockNode(y),S&&this.code(S).endFor(),this}for(y,S){return this._for(new f(y),S)}forRange(y,S,x,F,z=this.opts.es5?t.varKinds.var:t.varKinds.let){const J=this._scope.toName(y);return this._for(new g(z,J,S,x),()=>F(J))}forOf(y,S,x,F=t.varKinds.const){const z=this._scope.toName(y);if(this.opts.es5){const J=S instanceof e.Name?S:this.var("_arr",S);return this.forRange("_i",0,(0,e._)`${J}.length`,H=>{this.var(z,(0,e._)`${J}[${H}]`),x(z)})}return this._for(new b("of",F,z,S),()=>x(z))}forIn(y,S,x,F=this.opts.es5?t.varKinds.var:t.varKinds.const){if(this.opts.ownProperties)return this.forOf(y,(0,e._)`Object.keys(${S})`,x);const z=this._scope.toName(y);return this._for(new b("in",F,z,S),()=>x(z))}endFor(){return this._endBlockNode(l)}label(y){return this._leafNode(new u(y))}break(y){return this._leafNode(new d(y))}return(y){const S=new P;if(this._blockNode(S),this.code(y),S.nodes.length!==1)throw new Error('CodeGen: "return" should have one node');return this._endBlockNode(P)}try(y,S,x){if(!S&&!x)throw new Error('CodeGen: "try" without "catch" and "finally"');const F=new A;if(this._blockNode(F),this.code(y),S){const z=this.name("e");this._currNode=F.catch=new I(z),S(z)}return x&&(this._currNode=F.finally=new q,this.code(x)),this._endBlockNode(I,q)}throw(y){return this._leafNode(new m(y))}block(y,S){return this._blockStarts.push(this._nodes.length),y&&this.code(y).endBlock(S),this}endBlock(y){const S=this._blockStarts.pop();if(S===void 0)throw new Error("CodeGen: not in self-balancing block");const x=this._nodes.length-S;if(x<0||y!==void 0&&x!==y)throw new Error(`CodeGen: wrong number of nodes: ${x} vs ${y} expected`);return this._nodes.length=S,this}func(y,S=e.nil,x,F){return this._blockNode(new v(y,S,x)),F&&this.code(F).endFunc(),this}endFunc(){return this._endBlockNode(v)}optimize(y=1){for(;y-- >0;)this._root.optimizeNodes(),this._root.optimizeNames(this._root.names,this._constants)}_leafNode(y){return this._currNode.nodes.push(y),this}_blockNode(y){this._currNode.nodes.push(y),this._nodes.push(y)}_endBlockNode(y,S){const x=this._currNode;if(x instanceof y||S&&x instanceof S)return this._nodes.pop(),this;throw new Error(`CodeGen: not in block "${S?`${y.kind}/${S.kind}`:y.kind}"`)}_elseNode(y){const S=this._currNode;if(!(S instanceof h))throw new Error('CodeGen: "else" without "if"');return this._currNode=S.else=y,this}get _root(){return this._nodes[0]}get _currNode(){const y=this._nodes;return y[y.length-1]}set _currNode(y){const S=this._nodes;S[S.length-1]=y}}o.CodeGen=V;function B(R,y){for(const S in y)R[S]=(R[S]||0)+(y[S]||0);return R}function U(R,y){return y instanceof e._CodeOrName?B(R,y.names):R}function X(R,y,S){if(R instanceof e.Name)return x(R);if(!F(R))return R;return new e._Code(R._items.reduce((z,J)=>(J instanceof e.Name&&(J=x(J)),J instanceof e._Code?z.push(...J._items):z.push(J),z),[]));function x(z){const J=S[z.str];return J===void 0||y[z.str]!==1?z:(delete y[z.str],J)}function F(z){return z instanceof e._Code&&z._items.some(J=>J instanceof e.Name&&y[J.str]===1&&S[J.str]!==void 0)}}function ne(R,y){for(const S in y)R[S]=(R[S]||0)-(y[S]||0)}function ue(R){return typeof R=="boolean"||typeof R=="number"||R===null?!R:(0,e._)`!${C(R)}`}o.not=ue;const he=k(o.operators.AND);function D(...R){return R.reduce(he)}o.and=D;const ce=k(o.operators.OR);function j(...R){return R.reduce(ce)}o.or=j;function k(R){return(y,S)=>y===e.nil?S:S===e.nil?y:(0,e._)`${C(y)} ${R} ${C(S)}`}function C(R){return R instanceof e.Name?R:(0,e._)`(${R})`}})(It)),It}var W={},sr;function ee(){if(sr)return W;sr=1,Object.defineProperty(W,"__esModule",{value:!0}),W.checkStrictMode=W.getErrorPath=W.Type=W.useFunc=W.setEvaluated=W.evaluatedPropsToName=W.mergeEvaluated=W.eachItem=W.unescapeJsonPointer=W.escapeJsonPointer=W.escapeFragment=W.unescapeFragment=W.schemaRefOrVal=W.schemaHasRulesButRef=W.schemaHasRules=W.checkUnknownRules=W.alwaysValidSchema=W.toHash=void 0;const o=Y(),e=ze();function t(b){const v={};for(const P of b)v[P]=!0;return v}W.toHash=t;function r(b,v){return typeof v=="boolean"?v:Object.keys(v).length===0?!0:(n(b,v),!i(v,b.self.RULES.all))}W.alwaysValidSchema=r;function n(b,v=b.schema){const{opts:P,self:A}=b;if(!P.strictSchema||typeof v=="boolean")return;const I=A.RULES.keywords;for(const q in v)I[q]||g(b,`unknown keyword: "${q}"`)}W.checkUnknownRules=n;function i(b,v){if(typeof b=="boolean")return!b;for(const P in b)if(v[P])return!0;return!1}W.schemaHasRules=i;function s(b,v){if(typeof b=="boolean")return!b;for(const P in b)if(P!=="$ref"&&v.all[P])return!0;return!1}W.schemaHasRulesButRef=s;function a({topSchemaRef:b,schemaPath:v},P,A,I){if(!I){if(typeof P=="number"||typeof P=="boolean")return P;if(typeof P=="string")return(0,o._)`${P}`}return(0,o._)`${b}${v}${(0,o.getProperty)(A)}`}W.schemaRefOrVal=a;function c(b){return m(decodeURIComponent(b))}W.unescapeFragment=c;function u(b){return encodeURIComponent(d(b))}W.escapeFragment=u;function d(b){return typeof b=="number"?`${b}`:b.replace(/~/g,"~0").replace(/\//g,"~1")}W.escapeJsonPointer=d;function m(b){return b.replace(/~1/g,"/").replace(/~0/g,"~")}W.unescapeJsonPointer=m;function $(b,v){if(Array.isArray(b))for(const P of b)v(P);else v(b)}W.eachItem=$;function _({mergeNames:b,mergeToName:v,mergeValues:P,resultToName:A}){return(I,q,V,B)=>{const U=V===void 0?q:V instanceof o.Name?(q instanceof o.Name?b(I,q,V):v(I,q,V),V):q instanceof o.Name?(v(I,V,q),q):P(q,V);return B===o.Name&&!(U instanceof o.Name)?A(I,U):U}}W.mergeEvaluated={props:_({mergeNames:(b,v,P)=>b.if((0,o._)`${P} !== true && ${v} !== undefined`,()=>{b.if((0,o._)`${v} === true`,()=>b.assign(P,!0),()=>b.assign(P,(0,o._)`${P} || {}`).code((0,o._)`Object.assign(${P}, ${v})`))}),mergeToName:(b,v,P)=>b.if((0,o._)`${P} !== true`,()=>{v===!0?b.assign(P,!0):(b.assign(P,(0,o._)`${P} || {}`),w(b,P,v))}),mergeValues:(b,v)=>b===!0?!0:{...b,...v},resultToName:E}),items:_({mergeNames:(b,v,P)=>b.if((0,o._)`${P} !== true && ${v} !== undefined`,()=>b.assign(P,(0,o._)`${v} === true ? true : ${P} > ${v} ? ${P} : ${v}`)),mergeToName:(b,v,P)=>b.if((0,o._)`${P} !== true`,()=>b.assign(P,v===!0?!0:(0,o._)`${P} > ${v} ? ${P} : ${v}`)),mergeValues:(b,v)=>b===!0?!0:Math.max(b,v),resultToName:(b,v)=>b.var("items",v)})};function E(b,v){if(v===!0)return b.var("props",!0);const P=b.var("props",(0,o._)`{}`);return v!==void 0&&w(b,P,v),P}W.evaluatedPropsToName=E;function w(b,v,P){Object.keys(P).forEach(A=>b.assign((0,o._)`${v}${(0,o.getProperty)(A)}`,!0))}W.setEvaluated=w;const p={};function h(b,v){return b.scopeValue("func",{ref:v,code:p[v.code]||(p[v.code]=new e._Code(v.code))})}W.useFunc=h;var l;(function(b){b[b.Num=0]="Num",b[b.Str=1]="Str"})(l||(W.Type=l={}));function f(b,v,P){if(b instanceof o.Name){const A=v===l.Num;return P?A?(0,o._)`"[" + ${b} + "]"`:(0,o._)`"['" + ${b} + "']"`:A?(0,o._)`"/" + ${b}`:(0,o._)`"/" + ${b}.replace(/~/g, "~0").replace(/\\//g, "~1")`}return P?(0,o.getProperty)(b).toString():"/"+d(b)}W.getErrorPath=f;function g(b,v,P=b.opts.strictSchema){if(P){if(v=`strict mode: ${v}`,P===!0)throw new Error(v);b.self.logger.warn(v)}}return W.checkStrictMode=g,W}var Le={},or;function be(){if(or)return Le;or=1,Object.defineProperty(Le,"__esModule",{value:!0});const o=Y(),e={data:new o.Name("data"),valCxt:new o.Name("valCxt"),instancePath:new o.Name("instancePath"),parentData:new o.Name("parentData"),parentDataProperty:new o.Name("parentDataProperty"),rootData:new o.Name("rootData"),dynamicAnchors:new o.Name("dynamicAnchors"),vErrors:new o.Name("vErrors"),errors:new o.Name("errors"),this:new o.Name("this"),self:new o.Name("self"),scope:new o.Name("scope"),json:new o.Name("json"),jsonPos:new o.Name("jsonPos"),jsonLen:new o.Name("jsonLen"),jsonPart:new o.Name("jsonPart")};return Le.default=e,Le}var ar;function Ue(){return ar||(ar=1,(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.extendErrors=o.resetErrorsCount=o.reportExtraError=o.reportError=o.keyword$DataError=o.keywordError=void 0;const e=Y(),t=ee(),r=be();o.keywordError={message:({keyword:p})=>(0,e.str)`must pass "${p}" keyword validation`},o.keyword$DataError={message:({keyword:p,schemaType:h})=>h?(0,e.str)`"${p}" keyword must be ${h} ($data)`:(0,e.str)`"${p}" keyword is invalid ($data)`};function n(p,h=o.keywordError,l,f){const{it:g}=p,{gen:b,compositeRule:v,allErrors:P}=g,A=m(p,h,l);f??(v||P)?c(b,A):u(g,(0,e._)`[${A}]`)}o.reportError=n;function i(p,h=o.keywordError,l){const{it:f}=p,{gen:g,compositeRule:b,allErrors:v}=f,P=m(p,h,l);c(g,P),b||v||u(f,r.default.vErrors)}o.reportExtraError=i;function s(p,h){p.assign(r.default.errors,h),p.if((0,e._)`${r.default.vErrors} !== null`,()=>p.if(h,()=>p.assign((0,e._)`${r.default.vErrors}.length`,h),()=>p.assign(r.default.vErrors,null)))}o.resetErrorsCount=s;function a({gen:p,keyword:h,schemaValue:l,data:f,errsCount:g,it:b}){if(g===void 0)throw new Error("ajv implementation error");const v=p.name("err");p.forRange("i",g,r.default.errors,P=>{p.const(v,(0,e._)`${r.default.vErrors}[${P}]`),p.if((0,e._)`${v}.instancePath === undefined`,()=>p.assign((0,e._)`${v}.instancePath`,(0,e.strConcat)(r.default.instancePath,b.errorPath))),p.assign((0,e._)`${v}.schemaPath`,(0,e.str)`${b.errSchemaPath}/${h}`),b.opts.verbose&&(p.assign((0,e._)`${v}.schema`,l),p.assign((0,e._)`${v}.data`,f))})}o.extendErrors=a;function c(p,h){const l=p.const("err",h);p.if((0,e._)`${r.default.vErrors} === null`,()=>p.assign(r.default.vErrors,(0,e._)`[${l}]`),(0,e._)`${r.default.vErrors}.push(${l})`),p.code((0,e._)`${r.default.errors}++`)}function u(p,h){const{gen:l,validateName:f,schemaEnv:g}=p;g.$async?l.throw((0,e._)`new ${p.ValidationError}(${h})`):(l.assign((0,e._)`${f}.errors`,h),l.return(!1))}const d={keyword:new e.Name("keyword"),schemaPath:new e.Name("schemaPath"),params:new e.Name("params"),propertyName:new e.Name("propertyName"),message:new e.Name("message"),schema:new e.Name("schema"),parentSchema:new e.Name("parentSchema")};function m(p,h,l){const{createErrors:f}=p.it;return f===!1?(0,e._)`{}`:$(p,h,l)}function $(p,h,l={}){const{gen:f,it:g}=p,b=[_(g,l),E(p,l)];return w(p,h,b),f.object(...b)}function _({errorPath:p},{instancePath:h}){const l=h?(0,e.str)`${p}${(0,t.getErrorPath)(h,t.Type.Str)}`:p;return[r.default.instancePath,(0,e.strConcat)(r.default.instancePath,l)]}function E({keyword:p,it:{errSchemaPath:h}},{schemaPath:l,parentSchema:f}){let g=f?h:(0,e.str)`${h}/${p}`;return l&&(g=(0,e.str)`${g}${(0,t.getErrorPath)(l,t.Type.Str)}`),[d.schemaPath,g]}function w(p,{params:h,message:l},f){const{keyword:g,data:b,schemaValue:v,it:P}=p,{opts:A,propertyName:I,topSchemaRef:q,schemaPath:V}=P;f.push([d.keyword,g],[d.params,typeof h=="function"?h(p):h||(0,e._)`{}`]),A.messages&&f.push([d.message,typeof l=="function"?l(p):l]),A.verbose&&f.push([d.schema,v],[d.parentSchema,(0,e._)`${q}${V}`],[r.default.data,b]),I&&f.push([d.propertyName,I])}})(Ct)),Ct}var cr;function Dn(){if(cr)return Se;cr=1,Object.defineProperty(Se,"__esModule",{value:!0}),Se.boolOrEmptySchema=Se.topBoolOrEmptySchema=void 0;const o=Ue(),e=Y(),t=be(),r={message:"boolean schema is false"};function n(a){const{gen:c,schema:u,validateName:d}=a;u===!1?s(a,!1):typeof u=="object"&&u.$async===!0?c.return(t.default.data):(c.assign((0,e._)`${d}.errors`,null),c.return(!0))}Se.topBoolOrEmptySchema=n;function i(a,c){const{gen:u,schema:d}=a;d===!1?(u.var(c,!1),s(a)):u.var(c,!0)}Se.boolOrEmptySchema=i;function s(a,c){const{gen:u,data:d}=a,m={gen:u,keyword:"false schema",data:d,schema:!1,schemaCode:!1,schemaValue:!1,params:{},it:a};(0,o.reportError)(m,r,void 0,c)}return Se}var oe={},Ee={},lr;function ur(){if(lr)return Ee;lr=1,Object.defineProperty(Ee,"__esModule",{value:!0}),Ee.getRules=Ee.isJSONType=void 0;const o=["string","number","integer","boolean","null","object","array"],e=new Set(o);function t(n){return typeof n=="string"&&e.has(n)}Ee.isJSONType=t;function r(){const n={number:{type:"number",rules:[]},string:{type:"string",rules:[]},array:{type:"array",rules:[]},object:{type:"object",rules:[]}};return{types:{...n,integer:!0,boolean:!0,null:!0},rules:[{rules:[]},n.number,n.string,n.array,n.object],post:{rules:[]},all:{},keywords:{}}}return Ee.getRules=r,Ee}var ge={},dr;function hr(){if(dr)return ge;dr=1,Object.defineProperty(ge,"__esModule",{value:!0}),ge.shouldUseRule=ge.shouldUseGroup=ge.schemaHasRulesForType=void 0;function o({schema:r,self:n},i){const s=n.RULES.types[i];return s&&s!==!0&&e(r,s)}ge.schemaHasRulesForType=o;function e(r,n){return n.rules.some(i=>t(r,i))}ge.shouldUseGroup=e;function t(r,n){var i;return r[n.keyword]!==void 0||((i=n.definition.implements)===null||i===void 0?void 0:i.some(s=>r[s]!==void 0))}return ge.shouldUseRule=t,ge}var fr;function Ge(){if(fr)return oe;fr=1,Object.defineProperty(oe,"__esModule",{value:!0}),oe.reportTypeError=oe.checkDataTypes=oe.checkDataType=oe.coerceAndCheckDataType=oe.getJSONTypes=oe.getSchemaTypes=oe.DataType=void 0;const o=ur(),e=hr(),t=Ue(),r=Y(),n=ee();var i;(function(l){l[l.Correct=0]="Correct",l[l.Wrong=1]="Wrong"})(i||(oe.DataType=i={}));function s(l){const f=a(l.type);if(f.includes("null")){if(l.nullable===!1)throw new Error("type: null contradicts nullable: false")}else{if(!f.length&&l.nullable!==void 0)throw new Error('"nullable" cannot be used without "type"');l.nullable===!0&&f.push("null")}return f}oe.getSchemaTypes=s;function a(l){const f=Array.isArray(l)?l:l?[l]:[];if(f.every(o.isJSONType))return f;throw new Error("type must be JSONType or JSONType[]: "+f.join(","))}oe.getJSONTypes=a;function c(l,f){const{gen:g,data:b,opts:v}=l,P=d(f,v.coerceTypes),A=f.length>0&&!(P.length===0&&f.length===1&&(0,e.schemaHasRulesForType)(l,f[0]));if(A){const I=E(f,b,v.strictNumbers,i.Wrong);g.if(I,()=>{P.length?m(l,f,P):p(l)})}return A}oe.coerceAndCheckDataType=c;const u=new Set(["string","number","integer","boolean","null"]);function d(l,f){return f?l.filter(g=>u.has(g)||f==="array"&&g==="array"):[]}function m(l,f,g){const{gen:b,data:v,opts:P}=l,A=b.let("dataType",(0,r._)`typeof ${v}`),I=b.let("coerced",(0,r._)`undefined`);P.coerceTypes==="array"&&b.if((0,r._)`${A} == 'object' && Array.isArray(${v}) && ${v}.length == 1`,()=>b.assign(v,(0,r._)`${v}[0]`).assign(A,(0,r._)`typeof ${v}`).if(E(f,v,P.strictNumbers),()=>b.assign(I,v))),b.if((0,r._)`${I} !== undefined`);for(const V of g)(u.has(V)||V==="array"&&P.coerceTypes==="array")&&q(V);b.else(),p(l),b.endIf(),b.if((0,r._)`${I} !== undefined`,()=>{b.assign(v,I),$(l,I)});function q(V){switch(V){case"string":b.elseIf((0,r._)`${A} == "number" || ${A} == "boolean"`).assign(I,(0,r._)`"" + ${v}`).elseIf((0,r._)`${v} === null`).assign(I,(0,r._)`""`);return;case"number":b.elseIf((0,r._)`${A} == "boolean" || ${v} === null
              || (${A} == "string" && ${v} && ${v} == +${v})`).assign(I,(0,r._)`+${v}`);return;case"integer":b.elseIf((0,r._)`${A} === "boolean" || ${v} === null
              || (${A} === "string" && ${v} && ${v} == +${v} && !(${v} % 1))`).assign(I,(0,r._)`+${v}`);return;case"boolean":b.elseIf((0,r._)`${v} === "false" || ${v} === 0 || ${v} === null`).assign(I,!1).elseIf((0,r._)`${v} === "true" || ${v} === 1`).assign(I,!0);return;case"null":b.elseIf((0,r._)`${v} === "" || ${v} === 0 || ${v} === false`),b.assign(I,null);return;case"array":b.elseIf((0,r._)`${A} === "string" || ${A} === "number"
              || ${A} === "boolean" || ${v} === null`).assign(I,(0,r._)`[${v}]`)}}}function $({gen:l,parentData:f,parentDataProperty:g},b){l.if((0,r._)`${f} !== undefined`,()=>l.assign((0,r._)`${f}[${g}]`,b))}function _(l,f,g,b=i.Correct){const v=b===i.Correct?r.operators.EQ:r.operators.NEQ;let P;switch(l){case"null":return(0,r._)`${f} ${v} null`;case"array":P=(0,r._)`Array.isArray(${f})`;break;case"object":P=(0,r._)`${f} && typeof ${f} == "object" && !Array.isArray(${f})`;break;case"integer":P=A((0,r._)`!(${f} % 1) && !isNaN(${f})`);break;case"number":P=A();break;default:return(0,r._)`typeof ${f} ${v} ${l}`}return b===i.Correct?P:(0,r.not)(P);function A(I=r.nil){return(0,r.and)((0,r._)`typeof ${f} == "number"`,I,g?(0,r._)`isFinite(${f})`:r.nil)}}oe.checkDataType=_;function E(l,f,g,b){if(l.length===1)return _(l[0],f,g,b);let v;const P=(0,n.toHash)(l);if(P.array&&P.object){const A=(0,r._)`typeof ${f} != "object"`;v=P.null?A:(0,r._)`!${f} || ${A}`,delete P.null,delete P.array,delete P.object}else v=r.nil;P.number&&delete P.integer;for(const A in P)v=(0,r.and)(v,_(A,f,g,b));return v}oe.checkDataTypes=E;const w={message:({schema:l})=>`must be ${l}`,params:({schema:l,schemaValue:f})=>typeof l=="string"?(0,r._)`{type: ${l}}`:(0,r._)`{type: ${f}}`};function p(l){const f=h(l);(0,t.reportError)(f,w)}oe.reportTypeError=p;function h(l){const{gen:f,data:g,schema:b}=l,v=(0,n.schemaRefOrVal)(l,b,"type");return{gen:f,keyword:"type",data:g,schema:b.type,schemaCode:v,schemaValue:v,parentSchema:b,params:{},it:l}}return oe}var Ie={},pr;function Vn(){if(pr)return Ie;pr=1,Object.defineProperty(Ie,"__esModule",{value:!0}),Ie.assignDefaults=void 0;const o=Y(),e=ee();function t(n,i){const{properties:s,items:a}=n.schema;if(i==="object"&&s)for(const c in s)r(n,c,s[c].default);else i==="array"&&Array.isArray(a)&&a.forEach((c,u)=>r(n,u,c.default))}Ie.assignDefaults=t;function r(n,i,s){const{gen:a,compositeRule:c,data:u,opts:d}=n;if(s===void 0)return;const m=(0,o._)`${u}${(0,o.getProperty)(i)}`;if(c){(0,e.checkStrictMode)(n,`default is ignored for: ${m}`);return}let $=(0,o._)`${m} === undefined`;d.useDefaults==="empty"&&($=(0,o._)`${$} || ${m} === null || ${m} === ""`),a.if($,(0,o._)`${m} = ${(0,o.stringify)(s)}`)}return Ie}var pe={},te={},mr;function me(){if(mr)return te;mr=1,Object.defineProperty(te,"__esModule",{value:!0}),te.validateUnion=te.validateArray=te.usePattern=te.callValidateCode=te.schemaProperties=te.allSchemaProperties=te.noPropertyInData=te.propertyInData=te.isOwnProperty=te.hasPropFunc=te.reportMissingProp=te.checkMissingProp=te.checkReportMissingProp=void 0;const o=Y(),e=ee(),t=be(),r=ee();function n(l,f){const{gen:g,data:b,it:v}=l;g.if(d(g,b,f,v.opts.ownProperties),()=>{l.setParams({missingProperty:(0,o._)`${f}`},!0),l.error()})}te.checkReportMissingProp=n;function i({gen:l,data:f,it:{opts:g}},b,v){return(0,o.or)(...b.map(P=>(0,o.and)(d(l,f,P,g.ownProperties),(0,o._)`${v} = ${P}`)))}te.checkMissingProp=i;function s(l,f){l.setParams({missingProperty:f},!0),l.error()}te.reportMissingProp=s;function a(l){return l.scopeValue("func",{ref:Object.prototype.hasOwnProperty,code:(0,o._)`Object.prototype.hasOwnProperty`})}te.hasPropFunc=a;function c(l,f,g){return(0,o._)`${a(l)}.call(${f}, ${g})`}te.isOwnProperty=c;function u(l,f,g,b){const v=(0,o._)`${f}${(0,o.getProperty)(g)} !== undefined`;return b?(0,o._)`${v} && ${c(l,f,g)}`:v}te.propertyInData=u;function d(l,f,g,b){const v=(0,o._)`${f}${(0,o.getProperty)(g)} === undefined`;return b?(0,o.or)(v,(0,o.not)(c(l,f,g))):v}te.noPropertyInData=d;function m(l){return l?Object.keys(l).filter(f=>f!=="__proto__"):[]}te.allSchemaProperties=m;function $(l,f){return m(f).filter(g=>!(0,e.alwaysValidSchema)(l,f[g]))}te.schemaProperties=$;function _({schemaCode:l,data:f,it:{gen:g,topSchemaRef:b,schemaPath:v,errorPath:P},it:A},I,q,V){const B=V?(0,o._)`${l}, ${f}, ${b}${v}`:f,U=[[t.default.instancePath,(0,o.strConcat)(t.default.instancePath,P)],[t.default.parentData,A.parentData],[t.default.parentDataProperty,A.parentDataProperty],[t.default.rootData,t.default.rootData]];A.opts.dynamicRef&&U.push([t.default.dynamicAnchors,t.default.dynamicAnchors]);const X=(0,o._)`${B}, ${g.object(...U)}`;return q!==o.nil?(0,o._)`${I}.call(${q}, ${X})`:(0,o._)`${I}(${X})`}te.callValidateCode=_;const E=(0,o._)`new RegExp`;function w({gen:l,it:{opts:f}},g){const b=f.unicodeRegExp?"u":"",{regExp:v}=f.code,P=v(g,b);return l.scopeValue("pattern",{key:P.toString(),ref:P,code:(0,o._)`${v.code==="new RegExp"?E:(0,r.useFunc)(l,v)}(${g}, ${b})`})}te.usePattern=w;function p(l){const{gen:f,data:g,keyword:b,it:v}=l,P=f.name("valid");if(v.allErrors){const I=f.let("valid",!0);return A(()=>f.assign(I,!1)),I}return f.var(P,!0),A(()=>f.break()),P;function A(I){const q=f.const("len",(0,o._)`${g}.length`);f.forRange("i",0,q,V=>{l.subschema({keyword:b,dataProp:V,dataPropType:e.Type.Num},P),f.if((0,o.not)(P),I)})}}te.validateArray=p;function h(l){const{gen:f,schema:g,keyword:b,it:v}=l;if(!Array.isArray(g))throw new Error("ajv implementation error");if(g.some(q=>(0,e.alwaysValidSchema)(v,q))&&!v.opts.unevaluated)return;const A=f.let("valid",!1),I=f.name("_valid");f.block(()=>g.forEach((q,V)=>{const B=l.subschema({keyword:b,schemaProp:V,compositeRule:!0},I);f.assign(A,(0,o._)`${A} || ${I}`),l.mergeValidEvaluated(B,I)||f.if((0,o.not)(A))})),l.result(A,()=>l.reset(),()=>l.error(!0))}return te.validateUnion=h,te}var yr;function Fn(){if(yr)return pe;yr=1,Object.defineProperty(pe,"__esModule",{value:!0}),pe.validateKeywordUsage=pe.validSchemaType=pe.funcKeywordCode=pe.macroKeywordCode=void 0;const o=Y(),e=be(),t=me(),r=Ue();function n($,_){const{gen:E,keyword:w,schema:p,parentSchema:h,it:l}=$,f=_.macro.call(l.self,p,h,l),g=u(E,w,f);l.opts.validateSchema!==!1&&l.self.validateSchema(f,!0);const b=E.name("valid");$.subschema({schema:f,schemaPath:o.nil,errSchemaPath:`${l.errSchemaPath}/${w}`,topSchemaRef:g,compositeRule:!0},b),$.pass(b,()=>$.error(!0))}pe.macroKeywordCode=n;function i($,_){var E;const{gen:w,keyword:p,schema:h,parentSchema:l,$data:f,it:g}=$;c(g,_);const b=!f&&_.compile?_.compile.call(g.self,h,l,g):_.validate,v=u(w,p,b),P=w.let("valid");$.block$data(P,A),$.ok((E=_.valid)!==null&&E!==void 0?E:P);function A(){if(_.errors===!1)V(),_.modifying&&s($),B(()=>$.error());else{const U=_.async?I():q();_.modifying&&s($),B(()=>a($,U))}}function I(){const U=w.let("ruleErrs",null);return w.try(()=>V((0,o._)`await `),X=>w.assign(P,!1).if((0,o._)`${X} instanceof ${g.ValidationError}`,()=>w.assign(U,(0,o._)`${X}.errors`),()=>w.throw(X))),U}function q(){const U=(0,o._)`${v}.errors`;return w.assign(U,null),V(o.nil),U}function V(U=_.async?(0,o._)`await `:o.nil){const X=g.opts.passContext?e.default.this:e.default.self,ne=!("compile"in _&&!f||_.schema===!1);w.assign(P,(0,o._)`${U}${(0,t.callValidateCode)($,v,X,ne)}`,_.modifying)}function B(U){var X;w.if((0,o.not)((X=_.valid)!==null&&X!==void 0?X:P),U)}}pe.funcKeywordCode=i;function s($){const{gen:_,data:E,it:w}=$;_.if(w.parentData,()=>_.assign(E,(0,o._)`${w.parentData}[${w.parentDataProperty}]`))}function a($,_){const{gen:E}=$;E.if((0,o._)`Array.isArray(${_})`,()=>{E.assign(e.default.vErrors,(0,o._)`${e.default.vErrors} === null ? ${_} : ${e.default.vErrors}.concat(${_})`).assign(e.default.errors,(0,o._)`${e.default.vErrors}.length`),(0,r.extendErrors)($)},()=>$.error())}function c({schemaEnv:$},_){if(_.async&&!$.$async)throw new Error("async keyword in sync schema")}function u($,_,E){if(E===void 0)throw new Error(`keyword "${_}" failed to compile`);return $.scopeValue("keyword",typeof E=="function"?{ref:E}:{ref:E,code:(0,o.stringify)(E)})}function d($,_,E=!1){return!_.length||_.some(w=>w==="array"?Array.isArray($):w==="object"?$&&typeof $=="object"&&!Array.isArray($):typeof $==w||E&&typeof $>"u")}pe.validSchemaType=d;function m({schema:$,opts:_,self:E,errSchemaPath:w},p,h){if(Array.isArray(p.keyword)?!p.keyword.includes(h):p.keyword!==h)throw new Error("ajv implementation error");const l=p.dependencies;if(l?.some(f=>!Object.prototype.hasOwnProperty.call($,f)))throw new Error(`parent schema must have dependencies of ${h}: ${l.join(",")}`);if(p.validateSchema&&!p.validateSchema($[h])){const g=`keyword "${h}" value is invalid at path "${w}": `+E.errorsText(p.validateSchema.errors);if(_.validateSchema==="log")E.logger.error(g);else throw new Error(g)}}return pe.validateKeywordUsage=m,pe}var ve={},gr;function zn(){if(gr)return ve;gr=1,Object.defineProperty(ve,"__esModule",{value:!0}),ve.extendSubschemaMode=ve.extendSubschemaData=ve.getSubschema=void 0;const o=Y(),e=ee();function t(i,{keyword:s,schemaProp:a,schema:c,schemaPath:u,errSchemaPath:d,topSchemaRef:m}){if(s!==void 0&&c!==void 0)throw new Error('both "keyword" and "schema" passed, only one allowed');if(s!==void 0){const $=i.schema[s];return a===void 0?{schema:$,schemaPath:(0,o._)`${i.schemaPath}${(0,o.getProperty)(s)}`,errSchemaPath:`${i.errSchemaPath}/${s}`}:{schema:$[a],schemaPath:(0,o._)`${i.schemaPath}${(0,o.getProperty)(s)}${(0,o.getProperty)(a)}`,errSchemaPath:`${i.errSchemaPath}/${s}/${(0,e.escapeFragment)(a)}`}}if(c!==void 0){if(u===void 0||d===void 0||m===void 0)throw new Error('"schemaPath", "errSchemaPath" and "topSchemaRef" are required with "schema"');return{schema:c,schemaPath:u,topSchemaRef:m,errSchemaPath:d}}throw new Error('either "keyword" or "schema" must be passed')}ve.getSubschema=t;function r(i,s,{dataProp:a,dataPropType:c,data:u,dataTypes:d,propertyName:m}){if(u!==void 0&&a!==void 0)throw new Error('both "data" and "dataProp" passed, only one allowed');const{gen:$}=s;if(a!==void 0){const{errorPath:E,dataPathArr:w,opts:p}=s,h=$.let("data",(0,o._)`${s.data}${(0,o.getProperty)(a)}`,!0);_(h),i.errorPath=(0,o.str)`${E}${(0,e.getErrorPath)(a,c,p.jsPropertySyntax)}`,i.parentDataProperty=(0,o._)`${a}`,i.dataPathArr=[...w,i.parentDataProperty]}if(u!==void 0){const E=u instanceof o.Name?u:$.let("data",u,!0);_(E),m!==void 0&&(i.propertyName=m)}d&&(i.dataTypes=d);function _(E){i.data=E,i.dataLevel=s.dataLevel+1,i.dataTypes=[],s.definedProperties=new Set,i.parentData=s.data,i.dataNames=[...s.dataNames,E]}}ve.extendSubschemaData=r;function n(i,{jtdDiscriminator:s,jtdMetadata:a,compositeRule:c,createErrors:u,allErrors:d}){c!==void 0&&(i.compositeRule=c),u!==void 0&&(i.createErrors=u),d!==void 0&&(i.allErrors=d),i.jtdDiscriminator=s,i.jtdMetadata=a}return ve.extendSubschemaMode=n,ve}var le={},qt,vr;function br(){return vr||(vr=1,qt=function o(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var r,n,i;if(Array.isArray(e)){if(r=e.length,r!=t.length)return!1;for(n=r;n--!==0;)if(!o(e[n],t[n]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();if(i=Object.keys(e),r=i.length,r!==Object.keys(t).length)return!1;for(n=r;n--!==0;)if(!Object.prototype.hasOwnProperty.call(t,i[n]))return!1;for(n=r;n--!==0;){var s=i[n];if(!o(e[s],t[s]))return!1}return!0}return e!==e&&t!==t}),qt}var Dt={exports:{}},wr;function Ln(){if(wr)return Dt.exports;wr=1;var o=Dt.exports=function(r,n,i){typeof n=="function"&&(i=n,n={}),i=n.cb||i;var s=typeof i=="function"?i:i.pre||function(){},a=i.post||function(){};e(n,s,a,r,"",r)};o.keywords={additionalItems:!0,items:!0,contains:!0,additionalProperties:!0,propertyNames:!0,not:!0,if:!0,then:!0,else:!0},o.arrayKeywords={items:!0,allOf:!0,anyOf:!0,oneOf:!0},o.propsKeywords={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependencies:!0},o.skipKeywords={default:!0,enum:!0,const:!0,required:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};function e(r,n,i,s,a,c,u,d,m,$){if(s&&typeof s=="object"&&!Array.isArray(s)){n(s,a,c,u,d,m,$);for(var _ in s){var E=s[_];if(Array.isArray(E)){if(_ in o.arrayKeywords)for(var w=0;w<E.length;w++)e(r,n,i,E[w],a+"/"+_+"/"+w,c,a,_,s,w)}else if(_ in o.propsKeywords){if(E&&typeof E=="object")for(var p in E)e(r,n,i,E[p],a+"/"+_+"/"+t(p),c,a,_,s,p)}else(_ in o.keywords||r.allKeys&&!(_ in o.skipKeywords))&&e(r,n,i,E,a+"/"+_,c,a,_,s)}i(s,a,c,u,d,m,$)}}function t(r){return r.replace(/~/g,"~0").replace(/\//g,"~1")}return Dt.exports}var $r;function Ke(){if($r)return le;$r=1,Object.defineProperty(le,"__esModule",{value:!0}),le.getSchemaRefs=le.resolveUrl=le.normalizeId=le._getFullPath=le.getFullPath=le.inlineRef=void 0;const o=ee(),e=br(),t=Ln(),r=new Set(["type","format","pattern","maxLength","minLength","maxProperties","minProperties","maxItems","minItems","maximum","minimum","uniqueItems","multipleOf","required","enum","const"]);function n(w,p=!0){return typeof w=="boolean"?!0:p===!0?!s(w):p?a(w)<=p:!1}le.inlineRef=n;const i=new Set(["$ref","$recursiveRef","$recursiveAnchor","$dynamicRef","$dynamicAnchor"]);function s(w){for(const p in w){if(i.has(p))return!0;const h=w[p];if(Array.isArray(h)&&h.some(s)||typeof h=="object"&&s(h))return!0}return!1}function a(w){let p=0;for(const h in w){if(h==="$ref")return 1/0;if(p++,!r.has(h)&&(typeof w[h]=="object"&&(0,o.eachItem)(w[h],l=>p+=a(l)),p===1/0))return 1/0}return p}function c(w,p="",h){h!==!1&&(p=m(p));const l=w.parse(p);return u(w,l)}le.getFullPath=c;function u(w,p){return w.serialize(p).split("#")[0]+"#"}le._getFullPath=u;const d=/#\/?$/;function m(w){return w?w.replace(d,""):""}le.normalizeId=m;function $(w,p,h){return h=m(h),w.resolve(p,h)}le.resolveUrl=$;const _=/^[a-z_][-a-z0-9._]*$/i;function E(w,p){if(typeof w=="boolean")return{};const{schemaId:h,uriResolver:l}=this.opts,f=m(w[h]||p),g={"":f},b=c(l,f,!1),v={},P=new Set;return t(w,{allKeys:!0},(q,V,B,U)=>{if(U===void 0)return;const X=b+V;let ne=g[U];typeof q[h]=="string"&&(ne=ue.call(this,q[h])),he.call(this,q.$anchor),he.call(this,q.$dynamicAnchor),g[V]=ne;function ue(D){const ce=this.opts.uriResolver.resolve;if(D=m(ne?ce(ne,D):D),P.has(D))throw I(D);P.add(D);let j=this.refs[D];return typeof j=="string"&&(j=this.refs[j]),typeof j=="object"?A(q,j.schema,D):D!==m(X)&&(D[0]==="#"?(A(q,v[D],D),v[D]=q):this.refs[D]=X),D}function he(D){if(typeof D=="string"){if(!_.test(D))throw new Error(`invalid anchor "${D}"`);ue.call(this,`#${D}`)}}}),v;function A(q,V,B){if(V!==void 0&&!e(q,V))throw I(B)}function I(q){return new Error(`reference "${q}" resolves to more than one schema`)}}return le.getSchemaRefs=E,le}var _r;function Be(){if(_r)return ye;_r=1,Object.defineProperty(ye,"__esModule",{value:!0}),ye.getData=ye.KeywordCxt=ye.validateFunctionCode=void 0;const o=Dn(),e=Ge(),t=hr(),r=Ge(),n=Vn(),i=Fn(),s=zn(),a=Y(),c=be(),u=Ke(),d=ee(),m=Ue();function $(T){if(b(T)&&(P(T),g(T))){p(T);return}_(T,()=>(0,o.topBoolOrEmptySchema)(T))}ye.validateFunctionCode=$;function _({gen:T,validateName:M,schema:N,schemaEnv:O,opts:L},K){L.code.es5?T.func(M,(0,a._)`${c.default.data}, ${c.default.valCxt}`,O.$async,()=>{T.code((0,a._)`"use strict"; ${l(N,L)}`),w(T,L),T.code(K)}):T.func(M,(0,a._)`${c.default.data}, ${E(L)}`,O.$async,()=>T.code(l(N,L)).code(K))}function E(T){return(0,a._)`{${c.default.instancePath}="", ${c.default.parentData}, ${c.default.parentDataProperty}, ${c.default.rootData}=${c.default.data}${T.dynamicRef?(0,a._)`, ${c.default.dynamicAnchors}={}`:a.nil}}={}`}function w(T,M){T.if(c.default.valCxt,()=>{T.var(c.default.instancePath,(0,a._)`${c.default.valCxt}.${c.default.instancePath}`),T.var(c.default.parentData,(0,a._)`${c.default.valCxt}.${c.default.parentData}`),T.var(c.default.parentDataProperty,(0,a._)`${c.default.valCxt}.${c.default.parentDataProperty}`),T.var(c.default.rootData,(0,a._)`${c.default.valCxt}.${c.default.rootData}`),M.dynamicRef&&T.var(c.default.dynamicAnchors,(0,a._)`${c.default.valCxt}.${c.default.dynamicAnchors}`)},()=>{T.var(c.default.instancePath,(0,a._)`""`),T.var(c.default.parentData,(0,a._)`undefined`),T.var(c.default.parentDataProperty,(0,a._)`undefined`),T.var(c.default.rootData,c.default.data),M.dynamicRef&&T.var(c.default.dynamicAnchors,(0,a._)`{}`)})}function p(T){const{schema:M,opts:N,gen:O}=T;_(T,()=>{N.$comment&&M.$comment&&U(T),q(T),O.let(c.default.vErrors,null),O.let(c.default.errors,0),N.unevaluated&&h(T),A(T),X(T)})}function h(T){const{gen:M,validateName:N}=T;T.evaluated=M.const("evaluated",(0,a._)`${N}.evaluated`),M.if((0,a._)`${T.evaluated}.dynamicProps`,()=>M.assign((0,a._)`${T.evaluated}.props`,(0,a._)`undefined`)),M.if((0,a._)`${T.evaluated}.dynamicItems`,()=>M.assign((0,a._)`${T.evaluated}.items`,(0,a._)`undefined`))}function l(T,M){const N=typeof T=="object"&&T[M.schemaId];return N&&(M.code.source||M.code.process)?(0,a._)`/*# sourceURL=${N} */`:a.nil}function f(T,M){if(b(T)&&(P(T),g(T))){v(T,M);return}(0,o.boolOrEmptySchema)(T,M)}function g({schema:T,self:M}){if(typeof T=="boolean")return!T;for(const N in T)if(M.RULES.all[N])return!0;return!1}function b(T){return typeof T.schema!="boolean"}function v(T,M){const{schema:N,gen:O,opts:L}=T;L.$comment&&N.$comment&&U(T),V(T),B(T);const K=O.const("_errs",c.default.errors);A(T,K),O.var(M,(0,a._)`${K} === ${c.default.errors}`)}function P(T){(0,d.checkUnknownRules)(T),I(T)}function A(T,M){if(T.opts.jtd)return ue(T,[],!1,M);const N=(0,e.getSchemaTypes)(T.schema),O=(0,e.coerceAndCheckDataType)(T,N);ue(T,N,!O,M)}function I(T){const{schema:M,errSchemaPath:N,opts:O,self:L}=T;M.$ref&&O.ignoreKeywordsWithRef&&(0,d.schemaHasRulesButRef)(M,L.RULES)&&L.logger.warn(`$ref: keywords ignored in schema at path "${N}"`)}function q(T){const{schema:M,opts:N}=T;M.default!==void 0&&N.useDefaults&&N.strictSchema&&(0,d.checkStrictMode)(T,"default is ignored in the schema root")}function V(T){const M=T.schema[T.opts.schemaId];M&&(T.baseId=(0,u.resolveUrl)(T.opts.uriResolver,T.baseId,M))}function B(T){if(T.schema.$async&&!T.schemaEnv.$async)throw new Error("async schema in sync schema")}function U({gen:T,schemaEnv:M,schema:N,errSchemaPath:O,opts:L}){const K=N.$comment;if(L.$comment===!0)T.code((0,a._)`${c.default.self}.logger.log(${K})`);else if(typeof L.$comment=="function"){const ie=(0,a.str)`${O}/$comment`,re=T.scopeValue("root",{ref:M.root});T.code((0,a._)`${c.default.self}.opts.$comment(${K}, ${ie}, ${re}.schema)`)}}function X(T){const{gen:M,schemaEnv:N,validateName:O,ValidationError:L,opts:K}=T;N.$async?M.if((0,a._)`${c.default.errors} === 0`,()=>M.return(c.default.data),()=>M.throw((0,a._)`new ${L}(${c.default.vErrors})`)):(M.assign((0,a._)`${O}.errors`,c.default.vErrors),K.unevaluated&&ne(T),M.return((0,a._)`${c.default.errors} === 0`))}function ne({gen:T,evaluated:M,props:N,items:O}){N instanceof a.Name&&T.assign((0,a._)`${M}.props`,N),O instanceof a.Name&&T.assign((0,a._)`${M}.items`,O)}function ue(T,M,N,O){const{gen:L,schema:K,data:ie,allErrors:re,opts:G,self:Q}=T,{RULES:Z}=Q;if(K.$ref&&(G.ignoreKeywordsWithRef||!(0,d.schemaHasRulesButRef)(K,Z))){L.block(()=>F(T,"$ref",Z.all.$ref.definition));return}G.jtd||D(T,M),L.block(()=>{for(const de of Z.rules)ae(de);ae(Z.post)});function ae(de){(0,t.shouldUseGroup)(K,de)&&(de.type?(L.if((0,r.checkDataType)(de.type,ie,G.strictNumbers)),he(T,de),M.length===1&&M[0]===de.type&&N&&(L.else(),(0,r.reportTypeError)(T)),L.endIf()):he(T,de),re||L.if((0,a._)`${c.default.errors} === ${O||0}`))}}function he(T,M){const{gen:N,schema:O,opts:{useDefaults:L}}=T;L&&(0,n.assignDefaults)(T,M.type),N.block(()=>{for(const K of M.rules)(0,t.shouldUseRule)(O,K)&&F(T,K.keyword,K.definition,M.type)})}function D(T,M){T.schemaEnv.meta||!T.opts.strictTypes||(ce(T,M),T.opts.allowUnionTypes||j(T,M),k(T,T.dataTypes))}function ce(T,M){if(M.length){if(!T.dataTypes.length){T.dataTypes=M;return}M.forEach(N=>{R(T.dataTypes,N)||S(T,`type "${N}" not allowed by context "${T.dataTypes.join(",")}"`)}),y(T,M)}}function j(T,M){M.length>1&&!(M.length===2&&M.includes("null"))&&S(T,"use allowUnionTypes to allow union type keyword")}function k(T,M){const N=T.self.RULES.all;for(const O in N){const L=N[O];if(typeof L=="object"&&(0,t.shouldUseRule)(T.schema,L)){const{type:K}=L.definition;K.length&&!K.some(ie=>C(M,ie))&&S(T,`missing type "${K.join(",")}" for keyword "${O}"`)}}}function C(T,M){return T.includes(M)||M==="number"&&T.includes("integer")}function R(T,M){return T.includes(M)||M==="integer"&&T.includes("number")}function y(T,M){const N=[];for(const O of T.dataTypes)R(M,O)?N.push(O):M.includes("integer")&&O==="number"&&N.push("integer");T.dataTypes=N}function S(T,M){const N=T.schemaEnv.baseId+T.errSchemaPath;M+=` at "${N}" (strictTypes)`,(0,d.checkStrictMode)(T,M,T.opts.strictTypes)}class x{constructor(M,N,O){if((0,i.validateKeywordUsage)(M,N,O),this.gen=M.gen,this.allErrors=M.allErrors,this.keyword=O,this.data=M.data,this.schema=M.schema[O],this.$data=N.$data&&M.opts.$data&&this.schema&&this.schema.$data,this.schemaValue=(0,d.schemaRefOrVal)(M,this.schema,O,this.$data),this.schemaType=N.schemaType,this.parentSchema=M.schema,this.params={},this.it=M,this.def=N,this.$data)this.schemaCode=M.gen.const("vSchema",H(this.$data,M));else if(this.schemaCode=this.schemaValue,!(0,i.validSchemaType)(this.schema,N.schemaType,N.allowUndefined))throw new Error(`${O} value must be ${JSON.stringify(N.schemaType)}`);("code"in N?N.trackErrors:N.errors!==!1)&&(this.errsCount=M.gen.const("_errs",c.default.errors))}result(M,N,O){this.failResult((0,a.not)(M),N,O)}failResult(M,N,O){this.gen.if(M),O?O():this.error(),N?(this.gen.else(),N(),this.allErrors&&this.gen.endIf()):this.allErrors?this.gen.endIf():this.gen.else()}pass(M,N){this.failResult((0,a.not)(M),void 0,N)}fail(M){if(M===void 0){this.error(),this.allErrors||this.gen.if(!1);return}this.gen.if(M),this.error(),this.allErrors?this.gen.endIf():this.gen.else()}fail$data(M){if(!this.$data)return this.fail(M);const{schemaCode:N}=this;this.fail((0,a._)`${N} !== undefined && (${(0,a.or)(this.invalid$data(),M)})`)}error(M,N,O){if(N){this.setParams(N),this._error(M,O),this.setParams({});return}this._error(M,O)}_error(M,N){(M?m.reportExtraError:m.reportError)(this,this.def.error,N)}$dataError(){(0,m.reportError)(this,this.def.$dataError||m.keyword$DataError)}reset(){if(this.errsCount===void 0)throw new Error('add "trackErrors" to keyword definition');(0,m.resetErrorsCount)(this.gen,this.errsCount)}ok(M){this.allErrors||this.gen.if(M)}setParams(M,N){N?Object.assign(this.params,M):this.params=M}block$data(M,N,O=a.nil){this.gen.block(()=>{this.check$data(M,O),N()})}check$data(M=a.nil,N=a.nil){if(!this.$data)return;const{gen:O,schemaCode:L,schemaType:K,def:ie}=this;O.if((0,a.or)((0,a._)`${L} === undefined`,N)),M!==a.nil&&O.assign(M,!0),(K.length||ie.validateSchema)&&(O.elseIf(this.invalid$data()),this.$dataError(),M!==a.nil&&O.assign(M,!1)),O.else()}invalid$data(){const{gen:M,schemaCode:N,schemaType:O,def:L,it:K}=this;return(0,a.or)(ie(),re());function ie(){if(O.length){if(!(N instanceof a.Name))throw new Error("ajv implementation error");const G=Array.isArray(O)?O:[O];return(0,a._)`${(0,r.checkDataTypes)(G,N,K.opts.strictNumbers,r.DataType.Wrong)}`}return a.nil}function re(){if(L.validateSchema){const G=M.scopeValue("validate$data",{ref:L.validateSchema});return(0,a._)`!${G}(${N})`}return a.nil}}subschema(M,N){const O=(0,s.getSubschema)(this.it,M);(0,s.extendSubschemaData)(O,this.it,M),(0,s.extendSubschemaMode)(O,M);const L={...this.it,...O,items:void 0,props:void 0};return f(L,N),L}mergeEvaluated(M,N){const{it:O,gen:L}=this;O.opts.unevaluated&&(O.props!==!0&&M.props!==void 0&&(O.props=d.mergeEvaluated.props(L,M.props,O.props,N)),O.items!==!0&&M.items!==void 0&&(O.items=d.mergeEvaluated.items(L,M.items,O.items,N)))}mergeValidEvaluated(M,N){const{it:O,gen:L}=this;if(O.opts.unevaluated&&(O.props!==!0||O.items!==!0))return L.if(N,()=>this.mergeEvaluated(M,a.Name)),!0}}ye.KeywordCxt=x;function F(T,M,N,O){const L=new x(T,N,M);"code"in N?N.code(L,O):L.$data&&N.validate?(0,i.funcKeywordCode)(L,N):"macro"in N?(0,i.macroKeywordCode)(L,N):(N.compile||N.validate)&&(0,i.funcKeywordCode)(L,N)}const z=/^\/(?:[^~]|~0|~1)*$/,J=/^([0-9]+)(#|\/(?:[^~]|~0|~1)*)?$/;function H(T,{dataLevel:M,dataNames:N,dataPathArr:O}){let L,K;if(T==="")return c.default.rootData;if(T[0]==="/"){if(!z.test(T))throw new Error(`Invalid JSON-pointer: ${T}`);L=T,K=c.default.rootData}else{const Q=J.exec(T);if(!Q)throw new Error(`Invalid JSON-pointer: ${T}`);const Z=+Q[1];if(L=Q[2],L==="#"){if(Z>=M)throw new Error(G("property/index",Z));return O[M-Z]}if(Z>M)throw new Error(G("data",Z));if(K=N[M-Z],!L)return K}let ie=K;const re=L.split("/");for(const Q of re)Q&&(K=(0,a._)`${K}${(0,a.getProperty)((0,d.unescapeJsonPointer)(Q))}`,ie=(0,a._)`${ie} && ${K}`);return ie;function G(Q,Z){return`Cannot access ${Q} ${Z} levels up, current level is ${M}`}}return ye.getData=H,ye}var He={},Pr;function Vt(){if(Pr)return He;Pr=1,Object.defineProperty(He,"__esModule",{value:!0});class o extends Error{constructor(t){super("validation failed"),this.errors=t,this.ajv=this.validation=!0}}return He.default=o,He}var We={},Sr;function Je(){if(Sr)return We;Sr=1,Object.defineProperty(We,"__esModule",{value:!0});const o=Ke();class e extends Error{constructor(r,n,i,s){super(s||`can't resolve reference ${i} from id ${n}`),this.missingRef=(0,o.resolveUrl)(r,n,i),this.missingSchema=(0,o.normalizeId)((0,o.getFullPath)(r,this.missingRef))}}return We.default=e,We}var fe={},Er;function Ft(){if(Er)return fe;Er=1,Object.defineProperty(fe,"__esModule",{value:!0}),fe.resolveSchema=fe.getCompilingSchema=fe.resolveRef=fe.compileSchema=fe.SchemaEnv=void 0;const o=Y(),e=Vt(),t=be(),r=Ke(),n=ee(),i=Be();class s{constructor(h){var l;this.refs={},this.dynamicAnchors={};let f;typeof h.schema=="object"&&(f=h.schema),this.schema=h.schema,this.schemaId=h.schemaId,this.root=h.root||this,this.baseId=(l=h.baseId)!==null&&l!==void 0?l:(0,r.normalizeId)(f?.[h.schemaId||"$id"]),this.schemaPath=h.schemaPath,this.localRefs=h.localRefs,this.meta=h.meta,this.$async=f?.$async,this.refs={}}}fe.SchemaEnv=s;function a(p){const h=d.call(this,p);if(h)return h;const l=(0,r.getFullPath)(this.opts.uriResolver,p.root.baseId),{es5:f,lines:g}=this.opts.code,{ownProperties:b}=this.opts,v=new o.CodeGen(this.scope,{es5:f,lines:g,ownProperties:b});let P;p.$async&&(P=v.scopeValue("Error",{ref:e.default,code:(0,o._)`require("ajv/dist/runtime/validation_error").default`}));const A=v.scopeName("validate");p.validateName=A;const I={gen:v,allErrors:this.opts.allErrors,data:t.default.data,parentData:t.default.parentData,parentDataProperty:t.default.parentDataProperty,dataNames:[t.default.data],dataPathArr:[o.nil],dataLevel:0,dataTypes:[],definedProperties:new Set,topSchemaRef:v.scopeValue("schema",this.opts.code.source===!0?{ref:p.schema,code:(0,o.stringify)(p.schema)}:{ref:p.schema}),validateName:A,ValidationError:P,schema:p.schema,schemaEnv:p,rootId:l,baseId:p.baseId||l,schemaPath:o.nil,errSchemaPath:p.schemaPath||(this.opts.jtd?"":"#"),errorPath:(0,o._)`""`,opts:this.opts,self:this};let q;try{this._compilations.add(p),(0,i.validateFunctionCode)(I),v.optimize(this.opts.code.optimize);const V=v.toString();q=`${v.scopeRefs(t.default.scope)}return ${V}`,this.opts.code.process&&(q=this.opts.code.process(q,p));const U=new Function(`${t.default.self}`,`${t.default.scope}`,q)(this,this.scope.get());if(this.scope.value(A,{ref:U}),U.errors=null,U.schema=p.schema,U.schemaEnv=p,p.$async&&(U.$async=!0),this.opts.code.source===!0&&(U.source={validateName:A,validateCode:V,scopeValues:v._values}),this.opts.unevaluated){const{props:X,items:ne}=I;U.evaluated={props:X instanceof o.Name?void 0:X,items:ne instanceof o.Name?void 0:ne,dynamicProps:X instanceof o.Name,dynamicItems:ne instanceof o.Name},U.source&&(U.source.evaluated=(0,o.stringify)(U.evaluated))}return p.validate=U,p}catch(V){throw delete p.validate,delete p.validateName,q&&this.logger.error("Error compiling schema, function code:",q),V}finally{this._compilations.delete(p)}}fe.compileSchema=a;function c(p,h,l){var f;l=(0,r.resolveUrl)(this.opts.uriResolver,h,l);const g=p.refs[l];if(g)return g;let b=$.call(this,p,l);if(b===void 0){const v=(f=p.localRefs)===null||f===void 0?void 0:f[l],{schemaId:P}=this.opts;v&&(b=new s({schema:v,schemaId:P,root:p,baseId:h}))}if(b!==void 0)return p.refs[l]=u.call(this,b)}fe.resolveRef=c;function u(p){return(0,r.inlineRef)(p.schema,this.opts.inlineRefs)?p.schema:p.validate?p:a.call(this,p)}function d(p){for(const h of this._compilations)if(m(h,p))return h}fe.getCompilingSchema=d;function m(p,h){return p.schema===h.schema&&p.root===h.root&&p.baseId===h.baseId}function $(p,h){let l;for(;typeof(l=this.refs[h])=="string";)h=l;return l||this.schemas[h]||_.call(this,p,h)}function _(p,h){const l=this.opts.uriResolver.parse(h),f=(0,r._getFullPath)(this.opts.uriResolver,l);let g=(0,r.getFullPath)(this.opts.uriResolver,p.baseId,void 0);if(Object.keys(p.schema).length>0&&f===g)return w.call(this,l,p);const b=(0,r.normalizeId)(f),v=this.refs[b]||this.schemas[b];if(typeof v=="string"){const P=_.call(this,p,v);return typeof P?.schema!="object"?void 0:w.call(this,l,P)}if(typeof v?.schema=="object"){if(v.validate||a.call(this,v),b===(0,r.normalizeId)(h)){const{schema:P}=v,{schemaId:A}=this.opts,I=P[A];return I&&(g=(0,r.resolveUrl)(this.opts.uriResolver,g,I)),new s({schema:P,schemaId:A,root:p,baseId:g})}return w.call(this,l,v)}}fe.resolveSchema=_;const E=new Set(["properties","patternProperties","enum","dependencies","definitions"]);function w(p,{baseId:h,schema:l,root:f}){var g;if(((g=p.fragment)===null||g===void 0?void 0:g[0])!=="/")return;for(const P of p.fragment.slice(1).split("/")){if(typeof l=="boolean")return;const A=l[(0,n.unescapeFragment)(P)];if(A===void 0)return;l=A;const I=typeof l=="object"&&l[this.opts.schemaId];!E.has(P)&&I&&(h=(0,r.resolveUrl)(this.opts.uriResolver,h,I))}let b;if(typeof l!="boolean"&&l.$ref&&!(0,n.schemaHasRulesButRef)(l,this.RULES)){const P=(0,r.resolveUrl)(this.opts.uriResolver,h,l.$ref);b=_.call(this,f,P)}const{schemaId:v}=this.opts;if(b=b||new s({schema:l,schemaId:v,root:f,baseId:h}),b.schema!==b.root.schema)return b}return fe}const Un={$id:"https://raw.githubusercontent.com/ajv-validator/ajv/master/lib/refs/data.json#",description:"Meta-schema for $data reference (JSON AnySchema extension proposal)",type:"object",required:["$data"],properties:{$data:{type:"string",anyOf:[{format:"relative-json-pointer"},{format:"json-pointer"}]}},additionalProperties:!1};var Ye={},je={exports:{}},zt,Tr;function Gn(){return Tr||(Tr=1,zt={HEX:{0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,a:10,A:10,b:11,B:11,c:12,C:12,d:13,D:13,e:14,E:14,f:15,F:15}}),zt}var Lt,Mr;function Kn(){if(Mr)return Lt;Mr=1;const{HEX:o}=Gn(),e=/^(?:(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]\d|\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]\d|\d)$/u;function t(w){if(a(w,".")<3)return{host:w,isIPV4:!1};const p=w.match(e)||[],[h]=p;return h?{host:s(h,"."),isIPV4:!0}:{host:w,isIPV4:!1}}function r(w,p=!1){let h="",l=!0;for(const f of w){if(o[f]===void 0)return;f!=="0"&&l===!0&&(l=!1),l||(h+=f)}return p&&h.length===0&&(h="0"),h}function n(w){let p=0;const h={error:!1,address:"",zone:""},l=[],f=[];let g=!1,b=!1,v=!1;function P(){if(f.length){if(g===!1){const A=r(f);if(A!==void 0)l.push(A);else return h.error=!0,!1}f.length=0}return!0}for(let A=0;A<w.length;A++){const I=w[A];if(!(I==="["||I==="]"))if(I===":"){if(b===!0&&(v=!0),!P())break;if(p++,l.push(":"),p>7){h.error=!0;break}A-1>=0&&w[A-1]===":"&&(b=!0);continue}else if(I==="%"){if(!P())break;g=!0}else{f.push(I);continue}}return f.length&&(g?h.zone=f.join(""):v?l.push(f.join("")):l.push(r(f))),h.address=l.join(""),h}function i(w){if(a(w,":")<2)return{host:w,isIPV6:!1};const p=n(w);if(p.error)return{host:w,isIPV6:!1};{let h=p.address,l=p.address;return p.zone&&(h+="%"+p.zone,l+="%25"+p.zone),{host:h,escapedHost:l,isIPV6:!0}}}function s(w,p){let h="",l=!0;const f=w.length;for(let g=0;g<f;g++){const b=w[g];b==="0"&&l?(g+1<=f&&w[g+1]===p||g+1===f)&&(h+=b,l=!1):(b===p?l=!0:l=!1,h+=b)}return h}function a(w,p){let h=0;for(let l=0;l<w.length;l++)w[l]===p&&h++;return h}const c=/^\.\.?\//u,u=/^\/\.(?:\/|$)/u,d=/^\/\.\.(?:\/|$)/u,m=/^\/?(?:.|\n)*?(?=\/|$)/u;function $(w){const p=[];for(;w.length;)if(w.match(c))w=w.replace(c,"");else if(w.match(u))w=w.replace(u,"/");else if(w.match(d))w=w.replace(d,"/"),p.pop();else if(w==="."||w==="..")w="";else{const h=w.match(m);if(h){const l=h[0];w=w.slice(l.length),p.push(l)}else throw new Error("Unexpected dot segment condition")}return p.join("")}function _(w,p){const h=p!==!0?escape:unescape;return w.scheme!==void 0&&(w.scheme=h(w.scheme)),w.userinfo!==void 0&&(w.userinfo=h(w.userinfo)),w.host!==void 0&&(w.host=h(w.host)),w.path!==void 0&&(w.path=h(w.path)),w.query!==void 0&&(w.query=h(w.query)),w.fragment!==void 0&&(w.fragment=h(w.fragment)),w}function E(w){const p=[];if(w.userinfo!==void 0&&(p.push(w.userinfo),p.push("@")),w.host!==void 0){let h=unescape(w.host);const l=t(h);if(l.isIPV4)h=l.host;else{const f=i(l.host);f.isIPV6===!0?h=`[${f.escapedHost}]`:h=w.host}p.push(h)}return(typeof w.port=="number"||typeof w.port=="string")&&(p.push(":"),p.push(String(w.port))),p.length?p.join(""):void 0}return Lt={recomposeAuthority:E,normalizeComponentEncoding:_,removeDotSegments:$,normalizeIPv4:t,normalizeIPv6:i,stringArrayToHexStripped:r},Lt}var Ut,kr;function Bn(){if(kr)return Ut;kr=1;const o=/^[\da-f]{8}-[\da-f]{4}-[\da-f]{4}-[\da-f]{4}-[\da-f]{12}$/iu,e=/([\da-z][\d\-a-z]{0,31}):((?:[\w!$'()*+,\-.:;=@]|%[\da-f]{2})+)/iu;function t(l){return typeof l.secure=="boolean"?l.secure:String(l.scheme).toLowerCase()==="wss"}function r(l){return l.host||(l.error=l.error||"HTTP URIs must have a host."),l}function n(l){const f=String(l.scheme).toLowerCase()==="https";return(l.port===(f?443:80)||l.port==="")&&(l.port=void 0),l.path||(l.path="/"),l}function i(l){return l.secure=t(l),l.resourceName=(l.path||"/")+(l.query?"?"+l.query:""),l.path=void 0,l.query=void 0,l}function s(l){if((l.port===(t(l)?443:80)||l.port==="")&&(l.port=void 0),typeof l.secure=="boolean"&&(l.scheme=l.secure?"wss":"ws",l.secure=void 0),l.resourceName){const[f,g]=l.resourceName.split("?");l.path=f&&f!=="/"?f:void 0,l.query=g,l.resourceName=void 0}return l.fragment=void 0,l}function a(l,f){if(!l.path)return l.error="URN can not be parsed",l;const g=l.path.match(e);if(g){const b=f.scheme||l.scheme||"urn";l.nid=g[1].toLowerCase(),l.nss=g[2];const v=`${b}:${f.nid||l.nid}`,P=h[v];l.path=void 0,P&&(l=P.parse(l,f))}else l.error=l.error||"URN can not be parsed.";return l}function c(l,f){const g=f.scheme||l.scheme||"urn",b=l.nid.toLowerCase(),v=`${g}:${f.nid||b}`,P=h[v];P&&(l=P.serialize(l,f));const A=l,I=l.nss;return A.path=`${b||f.nid}:${I}`,f.skipEscape=!0,A}function u(l,f){const g=l;return g.uuid=g.nss,g.nss=void 0,!f.tolerant&&(!g.uuid||!o.test(g.uuid))&&(g.error=g.error||"UUID is not valid."),g}function d(l){const f=l;return f.nss=(l.uuid||"").toLowerCase(),f}const m={scheme:"http",domainHost:!0,parse:r,serialize:n},$={scheme:"https",domainHost:m.domainHost,parse:r,serialize:n},_={scheme:"ws",domainHost:!0,parse:i,serialize:s},E={scheme:"wss",domainHost:_.domainHost,parse:_.parse,serialize:_.serialize},h={http:m,https:$,ws:_,wss:E,urn:{scheme:"urn",parse:a,serialize:c,skipNormalize:!0},"urn:uuid":{scheme:"urn:uuid",parse:u,serialize:d,skipNormalize:!0}};return Ut=h,Ut}var Ar;function Hn(){if(Ar)return je.exports;Ar=1;const{normalizeIPv6:o,normalizeIPv4:e,removeDotSegments:t,recomposeAuthority:r,normalizeComponentEncoding:n}=Kn(),i=Bn();function s(p,h){return typeof p=="string"?p=d(E(p,h),h):typeof p=="object"&&(p=E(d(p,h),h)),p}function a(p,h,l){const f=Object.assign({scheme:"null"},l),g=c(E(p,f),E(h,f),f,!0);return d(g,{...f,skipEscape:!0})}function c(p,h,l,f){const g={};return f||(p=E(d(p,l),l),h=E(d(h,l),l)),l=l||{},!l.tolerant&&h.scheme?(g.scheme=h.scheme,g.userinfo=h.userinfo,g.host=h.host,g.port=h.port,g.path=t(h.path||""),g.query=h.query):(h.userinfo!==void 0||h.host!==void 0||h.port!==void 0?(g.userinfo=h.userinfo,g.host=h.host,g.port=h.port,g.path=t(h.path||""),g.query=h.query):(h.path?(h.path.charAt(0)==="/"?g.path=t(h.path):((p.userinfo!==void 0||p.host!==void 0||p.port!==void 0)&&!p.path?g.path="/"+h.path:p.path?g.path=p.path.slice(0,p.path.lastIndexOf("/")+1)+h.path:g.path=h.path,g.path=t(g.path)),g.query=h.query):(g.path=p.path,h.query!==void 0?g.query=h.query:g.query=p.query),g.userinfo=p.userinfo,g.host=p.host,g.port=p.port),g.scheme=p.scheme),g.fragment=h.fragment,g}function u(p,h,l){return typeof p=="string"?(p=unescape(p),p=d(n(E(p,l),!0),{...l,skipEscape:!0})):typeof p=="object"&&(p=d(n(p,!0),{...l,skipEscape:!0})),typeof h=="string"?(h=unescape(h),h=d(n(E(h,l),!0),{...l,skipEscape:!0})):typeof h=="object"&&(h=d(n(h,!0),{...l,skipEscape:!0})),p.toLowerCase()===h.toLowerCase()}function d(p,h){const l={host:p.host,scheme:p.scheme,userinfo:p.userinfo,port:p.port,path:p.path,query:p.query,nid:p.nid,nss:p.nss,uuid:p.uuid,fragment:p.fragment,reference:p.reference,resourceName:p.resourceName,secure:p.secure,error:""},f=Object.assign({},h),g=[],b=i[(f.scheme||l.scheme||"").toLowerCase()];b&&b.serialize&&b.serialize(l,f),l.path!==void 0&&(f.skipEscape?l.path=unescape(l.path):(l.path=escape(l.path),l.scheme!==void 0&&(l.path=l.path.split("%3A").join(":")))),f.reference!=="suffix"&&l.scheme&&g.push(l.scheme,":");const v=r(l);if(v!==void 0&&(f.reference!=="suffix"&&g.push("//"),g.push(v),l.path&&l.path.charAt(0)!=="/"&&g.push("/")),l.path!==void 0){let P=l.path;!f.absolutePath&&(!b||!b.absolutePath)&&(P=t(P)),v===void 0&&(P=P.replace(/^\/\//u,"/%2F")),g.push(P)}return l.query!==void 0&&g.push("?",l.query),l.fragment!==void 0&&g.push("#",l.fragment),g.join("")}const m=Array.from({length:127},(p,h)=>/[^!"$&'()*+,\-.;=_`a-z{}~]/u.test(String.fromCharCode(h)));function $(p){let h=0;for(let l=0,f=p.length;l<f;++l)if(h=p.charCodeAt(l),h>126||m[h])return!0;return!1}const _=/^(?:([^#/:?]+):)?(?:\/\/((?:([^#/?@]*)@)?(\[[^#/?\]]+\]|[^#/:?]*)(?::(\d*))?))?([^#?]*)(?:\?([^#]*))?(?:#((?:.|[\n\r])*))?/u;function E(p,h){const l=Object.assign({},h),f={scheme:void 0,userinfo:void 0,host:"",port:void 0,path:"",query:void 0,fragment:void 0},g=p.indexOf("%")!==-1;let b=!1;l.reference==="suffix"&&(p=(l.scheme?l.scheme+":":"")+"//"+p);const v=p.match(_);if(v){if(f.scheme=v[1],f.userinfo=v[3],f.host=v[4],f.port=parseInt(v[5],10),f.path=v[6]||"",f.query=v[7],f.fragment=v[8],isNaN(f.port)&&(f.port=v[5]),f.host){const A=e(f.host);if(A.isIPV4===!1){const I=o(A.host);f.host=I.host.toLowerCase(),b=I.isIPV6}else f.host=A.host,b=!0}f.scheme===void 0&&f.userinfo===void 0&&f.host===void 0&&f.port===void 0&&f.query===void 0&&!f.path?f.reference="same-document":f.scheme===void 0?f.reference="relative":f.fragment===void 0?f.reference="absolute":f.reference="uri",l.reference&&l.reference!=="suffix"&&l.reference!==f.reference&&(f.error=f.error||"URI is not a "+l.reference+" reference.");const P=i[(l.scheme||f.scheme||"").toLowerCase()];if(!l.unicodeSupport&&(!P||!P.unicodeSupport)&&f.host&&(l.domainHost||P&&P.domainHost)&&b===!1&&$(f.host))try{f.host=URL.domainToASCII(f.host.toLowerCase())}catch(A){f.error=f.error||"Host's domain name can not be converted to ASCII: "+A}(!P||P&&!P.skipNormalize)&&(g&&f.scheme!==void 0&&(f.scheme=unescape(f.scheme)),g&&f.host!==void 0&&(f.host=unescape(f.host)),f.path&&(f.path=escape(unescape(f.path))),f.fragment&&(f.fragment=encodeURI(decodeURIComponent(f.fragment)))),P&&P.parse&&P.parse(f,l)}else f.error=f.error||"URI can not be parsed.";return f}const w={SCHEMES:i,normalize:s,resolve:a,resolveComponents:c,equal:u,serialize:d,parse:E};return je.exports=w,je.exports.default=w,je.exports.fastUri=w,je.exports}var Rr;function Wn(){if(Rr)return Ye;Rr=1,Object.defineProperty(Ye,"__esModule",{value:!0});const o=Hn();return o.code='require("ajv/dist/runtime/uri").default',Ye.default=o,Ye}var xr;function Jn(){return xr||(xr=1,(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.CodeGen=o.Name=o.nil=o.stringify=o.str=o._=o.KeywordCxt=void 0;var e=Be();Object.defineProperty(o,"KeywordCxt",{enumerable:!0,get:function(){return e.KeywordCxt}});var t=Y();Object.defineProperty(o,"_",{enumerable:!0,get:function(){return t._}}),Object.defineProperty(o,"str",{enumerable:!0,get:function(){return t.str}}),Object.defineProperty(o,"stringify",{enumerable:!0,get:function(){return t.stringify}}),Object.defineProperty(o,"nil",{enumerable:!0,get:function(){return t.nil}}),Object.defineProperty(o,"Name",{enumerable:!0,get:function(){return t.Name}}),Object.defineProperty(o,"CodeGen",{enumerable:!0,get:function(){return t.CodeGen}});const r=Vt(),n=Je(),i=ur(),s=Ft(),a=Y(),c=Ke(),u=Ge(),d=ee(),m=Un,$=Wn(),_=(j,k)=>new RegExp(j,k);_.code="new RegExp";const E=["removeAdditional","useDefaults","coerceTypes"],w=new Set(["validate","serialize","parse","wrapper","root","schema","keyword","pattern","formats","validate$data","func","obj","Error"]),p={errorDataPath:"",format:"`validateFormats: false` can be used instead.",nullable:'"nullable" keyword is supported by default.',jsonPointers:"Deprecated jsPropertySyntax can be used instead.",extendRefs:"Deprecated ignoreKeywordsWithRef can be used instead.",missingRefs:"Pass empty schema with $id that should be ignored to ajv.addSchema.",processCode:"Use option `code: {process: (code, schemaEnv: object) => string}`",sourceCode:"Use option `code: {source: true}`",strictDefaults:"It is default now, see option `strict`.",strictKeywords:"It is default now, see option `strict`.",uniqueItems:'"uniqueItems" keyword is always validated.',unknownFormats:"Disable strict mode or pass `true` to `ajv.addFormat` (or `formats` option).",cache:"Map is used as cache, schema object as key.",serialize:"Map is used as cache, schema object as key.",ajvErrors:"It is default now."},h={ignoreKeywordsWithRef:"",jsPropertySyntax:"",unicode:'"minLength"/"maxLength" account for unicode characters by default.'},l=200;function f(j){var k,C,R,y,S,x,F,z,J,H,T,M,N,O,L,K,ie,re,G,Q,Z,ae,de,Ne,De;const Me=j.strict,_e=(k=j.code)===null||k===void 0?void 0:k.optimize,Ve=_e===!0||_e===void 0?1:_e||0,ke=(R=(C=j.code)===null||C===void 0?void 0:C.regExp)!==null&&R!==void 0?R:_,er=(y=j.uriResolver)!==null&&y!==void 0?y:$.default;return{strictSchema:(x=(S=j.strictSchema)!==null&&S!==void 0?S:Me)!==null&&x!==void 0?x:!0,strictNumbers:(z=(F=j.strictNumbers)!==null&&F!==void 0?F:Me)!==null&&z!==void 0?z:!0,strictTypes:(H=(J=j.strictTypes)!==null&&J!==void 0?J:Me)!==null&&H!==void 0?H:"log",strictTuples:(M=(T=j.strictTuples)!==null&&T!==void 0?T:Me)!==null&&M!==void 0?M:"log",strictRequired:(O=(N=j.strictRequired)!==null&&N!==void 0?N:Me)!==null&&O!==void 0?O:!1,code:j.code?{...j.code,optimize:Ve,regExp:ke}:{optimize:Ve,regExp:ke},loopRequired:(L=j.loopRequired)!==null&&L!==void 0?L:l,loopEnum:(K=j.loopEnum)!==null&&K!==void 0?K:l,meta:(ie=j.meta)!==null&&ie!==void 0?ie:!0,messages:(re=j.messages)!==null&&re!==void 0?re:!0,inlineRefs:(G=j.inlineRefs)!==null&&G!==void 0?G:!0,schemaId:(Q=j.schemaId)!==null&&Q!==void 0?Q:"$id",addUsedSchema:(Z=j.addUsedSchema)!==null&&Z!==void 0?Z:!0,validateSchema:(ae=j.validateSchema)!==null&&ae!==void 0?ae:!0,validateFormats:(de=j.validateFormats)!==null&&de!==void 0?de:!0,unicodeRegExp:(Ne=j.unicodeRegExp)!==null&&Ne!==void 0?Ne:!0,int32range:(De=j.int32range)!==null&&De!==void 0?De:!0,uriResolver:er}}class g{constructor(k={}){this.schemas={},this.refs={},this.formats={},this._compilations=new Set,this._loading={},this._cache=new Map,k=this.opts={...k,...f(k)};const{es5:C,lines:R}=this.opts.code;this.scope=new a.ValueScope({scope:{},prefixes:w,es5:C,lines:R}),this.logger=B(k.logger);const y=k.validateFormats;k.validateFormats=!1,this.RULES=(0,i.getRules)(),b.call(this,p,k,"NOT SUPPORTED"),b.call(this,h,k,"DEPRECATED","warn"),this._metaOpts=q.call(this),k.formats&&A.call(this),this._addVocabularies(),this._addDefaultMetaSchema(),k.keywords&&I.call(this,k.keywords),typeof k.meta=="object"&&this.addMetaSchema(k.meta),P.call(this),k.validateFormats=y}_addVocabularies(){this.addKeyword("$async")}_addDefaultMetaSchema(){const{$data:k,meta:C,schemaId:R}=this.opts;let y=m;R==="id"&&(y={...m},y.id=y.$id,delete y.$id),C&&k&&this.addMetaSchema(y,y[R],!1)}defaultMeta(){const{meta:k,schemaId:C}=this.opts;return this.opts.defaultMeta=typeof k=="object"?k[C]||k:void 0}validate(k,C){let R;if(typeof k=="string"){if(R=this.getSchema(k),!R)throw new Error(`no schema with key or ref "${k}"`)}else R=this.compile(k);const y=R(C);return"$async"in R||(this.errors=R.errors),y}compile(k,C){const R=this._addSchema(k,C);return R.validate||this._compileSchemaEnv(R)}compileAsync(k,C){if(typeof this.opts.loadSchema!="function")throw new Error("options.loadSchema should be a function");const{loadSchema:R}=this.opts;return y.call(this,k,C);async function y(H,T){await S.call(this,H.$schema);const M=this._addSchema(H,T);return M.validate||x.call(this,M)}async function S(H){H&&!this.getSchema(H)&&await y.call(this,{$ref:H},!0)}async function x(H){try{return this._compileSchemaEnv(H)}catch(T){if(!(T instanceof n.default))throw T;return F.call(this,T),await z.call(this,T.missingSchema),x.call(this,H)}}function F({missingSchema:H,missingRef:T}){if(this.refs[H])throw new Error(`AnySchema ${H} is loaded but ${T} cannot be resolved`)}async function z(H){const T=await J.call(this,H);this.refs[H]||await S.call(this,T.$schema),this.refs[H]||this.addSchema(T,H,C)}async function J(H){const T=this._loading[H];if(T)return T;try{return await(this._loading[H]=R(H))}finally{delete this._loading[H]}}}addSchema(k,C,R,y=this.opts.validateSchema){if(Array.isArray(k)){for(const x of k)this.addSchema(x,void 0,R,y);return this}let S;if(typeof k=="object"){const{schemaId:x}=this.opts;if(S=k[x],S!==void 0&&typeof S!="string")throw new Error(`schema ${x} must be string`)}return C=(0,c.normalizeId)(C||S),this._checkUnique(C),this.schemas[C]=this._addSchema(k,R,C,y,!0),this}addMetaSchema(k,C,R=this.opts.validateSchema){return this.addSchema(k,C,!0,R),this}validateSchema(k,C){if(typeof k=="boolean")return!0;let R;if(R=k.$schema,R!==void 0&&typeof R!="string")throw new Error("$schema must be a string");if(R=R||this.opts.defaultMeta||this.defaultMeta(),!R)return this.logger.warn("meta-schema not available"),this.errors=null,!0;const y=this.validate(R,k);if(!y&&C){const S="schema is invalid: "+this.errorsText();if(this.opts.validateSchema==="log")this.logger.error(S);else throw new Error(S)}return y}getSchema(k){let C;for(;typeof(C=v.call(this,k))=="string";)k=C;if(C===void 0){const{schemaId:R}=this.opts,y=new s.SchemaEnv({schema:{},schemaId:R});if(C=s.resolveSchema.call(this,y,k),!C)return;this.refs[k]=C}return C.validate||this._compileSchemaEnv(C)}removeSchema(k){if(k instanceof RegExp)return this._removeAllSchemas(this.schemas,k),this._removeAllSchemas(this.refs,k),this;switch(typeof k){case"undefined":return this._removeAllSchemas(this.schemas),this._removeAllSchemas(this.refs),this._cache.clear(),this;case"string":{const C=v.call(this,k);return typeof C=="object"&&this._cache.delete(C.schema),delete this.schemas[k],delete this.refs[k],this}case"object":{const C=k;this._cache.delete(C);let R=k[this.opts.schemaId];return R&&(R=(0,c.normalizeId)(R),delete this.schemas[R],delete this.refs[R]),this}default:throw new Error("ajv.removeSchema: invalid parameter")}}addVocabulary(k){for(const C of k)this.addKeyword(C);return this}addKeyword(k,C){let R;if(typeof k=="string")R=k,typeof C=="object"&&(this.logger.warn("these parameters are deprecated, see docs for addKeyword"),C.keyword=R);else if(typeof k=="object"&&C===void 0){if(C=k,R=C.keyword,Array.isArray(R)&&!R.length)throw new Error("addKeywords: keyword must be string or non-empty array")}else throw new Error("invalid addKeywords parameters");if(X.call(this,R,C),!C)return(0,d.eachItem)(R,S=>ne.call(this,S)),this;he.call(this,C);const y={...C,type:(0,u.getJSONTypes)(C.type),schemaType:(0,u.getJSONTypes)(C.schemaType)};return(0,d.eachItem)(R,y.type.length===0?S=>ne.call(this,S,y):S=>y.type.forEach(x=>ne.call(this,S,y,x))),this}getKeyword(k){const C=this.RULES.all[k];return typeof C=="object"?C.definition:!!C}removeKeyword(k){const{RULES:C}=this;delete C.keywords[k],delete C.all[k];for(const R of C.rules){const y=R.rules.findIndex(S=>S.keyword===k);y>=0&&R.rules.splice(y,1)}return this}addFormat(k,C){return typeof C=="string"&&(C=new RegExp(C)),this.formats[k]=C,this}errorsText(k=this.errors,{separator:C=", ",dataVar:R="data"}={}){return!k||k.length===0?"No errors":k.map(y=>`${R}${y.instancePath} ${y.message}`).reduce((y,S)=>y+C+S)}$dataMetaSchema(k,C){const R=this.RULES.all;k=JSON.parse(JSON.stringify(k));for(const y of C){const S=y.split("/").slice(1);let x=k;for(const F of S)x=x[F];for(const F in R){const z=R[F];if(typeof z!="object")continue;const{$data:J}=z.definition,H=x[F];J&&H&&(x[F]=ce(H))}}return k}_removeAllSchemas(k,C){for(const R in k){const y=k[R];(!C||C.test(R))&&(typeof y=="string"?delete k[R]:y&&!y.meta&&(this._cache.delete(y.schema),delete k[R]))}}_addSchema(k,C,R,y=this.opts.validateSchema,S=this.opts.addUsedSchema){let x;const{schemaId:F}=this.opts;if(typeof k=="object")x=k[F];else{if(this.opts.jtd)throw new Error("schema must be object");if(typeof k!="boolean")throw new Error("schema must be object or boolean")}let z=this._cache.get(k);if(z!==void 0)return z;R=(0,c.normalizeId)(x||R);const J=c.getSchemaRefs.call(this,k,R);return z=new s.SchemaEnv({schema:k,schemaId:F,meta:C,baseId:R,localRefs:J}),this._cache.set(z.schema,z),S&&!R.startsWith("#")&&(R&&this._checkUnique(R),this.refs[R]=z),y&&this.validateSchema(k,!0),z}_checkUnique(k){if(this.schemas[k]||this.refs[k])throw new Error(`schema with key or id "${k}" already exists`)}_compileSchemaEnv(k){if(k.meta?this._compileMetaSchema(k):s.compileSchema.call(this,k),!k.validate)throw new Error("ajv implementation error");return k.validate}_compileMetaSchema(k){const C=this.opts;this.opts=this._metaOpts;try{s.compileSchema.call(this,k)}finally{this.opts=C}}}g.ValidationError=r.default,g.MissingRefError=n.default,o.default=g;function b(j,k,C,R="error"){for(const y in j){const S=y;S in k&&this.logger[R](`${C}: option ${y}. ${j[S]}`)}}function v(j){return j=(0,c.normalizeId)(j),this.schemas[j]||this.refs[j]}function P(){const j=this.opts.schemas;if(j)if(Array.isArray(j))this.addSchema(j);else for(const k in j)this.addSchema(j[k],k)}function A(){for(const j in this.opts.formats){const k=this.opts.formats[j];k&&this.addFormat(j,k)}}function I(j){if(Array.isArray(j)){this.addVocabulary(j);return}this.logger.warn("keywords option as map is deprecated, pass array");for(const k in j){const C=j[k];C.keyword||(C.keyword=k),this.addKeyword(C)}}function q(){const j={...this.opts};for(const k of E)delete j[k];return j}const V={log(){},warn(){},error(){}};function B(j){if(j===!1)return V;if(j===void 0)return console;if(j.log&&j.warn&&j.error)return j;throw new Error("logger must implement log, warn and error methods")}const U=/^[a-z_$][a-z0-9_$:-]*$/i;function X(j,k){const{RULES:C}=this;if((0,d.eachItem)(j,R=>{if(C.keywords[R])throw new Error(`Keyword ${R} is already defined`);if(!U.test(R))throw new Error(`Keyword ${R} has invalid name`)}),!!k&&k.$data&&!("code"in k||"validate"in k))throw new Error('$data keyword must have "code" or "validate" function')}function ne(j,k,C){var R;const y=k?.post;if(C&&y)throw new Error('keyword with "post" flag cannot have "type"');const{RULES:S}=this;let x=y?S.post:S.rules.find(({type:z})=>z===C);if(x||(x={type:C,rules:[]},S.rules.push(x)),S.keywords[j]=!0,!k)return;const F={keyword:j,definition:{...k,type:(0,u.getJSONTypes)(k.type),schemaType:(0,u.getJSONTypes)(k.schemaType)}};k.before?ue.call(this,x,F,k.before):x.rules.push(F),S.all[j]=F,(R=k.implements)===null||R===void 0||R.forEach(z=>this.addKeyword(z))}function ue(j,k,C){const R=j.rules.findIndex(y=>y.keyword===C);R>=0?j.rules.splice(R,0,k):(j.rules.push(k),this.logger.warn(`rule ${C} is not defined`))}function he(j){let{metaSchema:k}=j;k!==void 0&&(j.$data&&this.opts.$data&&(k=ce(k)),j.validateSchema=this.compile(k,!0))}const D={$ref:"https://raw.githubusercontent.com/ajv-validator/ajv/master/lib/refs/data.json#"};function ce(j){return{anyOf:[j,D]}}})(Nt)),Nt}var Xe={},Qe={},Ze={},Nr;function Yn(){if(Nr)return Ze;Nr=1,Object.defineProperty(Ze,"__esModule",{value:!0});const o={keyword:"id",code(){throw new Error('NOT SUPPORTED: keyword "id", use "$id" for schema ID')}};return Ze.default=o,Ze}var we={},Cr;function Xn(){if(Cr)return we;Cr=1,Object.defineProperty(we,"__esModule",{value:!0}),we.callRef=we.getValidate=void 0;const o=Je(),e=me(),t=Y(),r=be(),n=Ft(),i=ee(),s={keyword:"$ref",schemaType:"string",code(u){const{gen:d,schema:m,it:$}=u,{baseId:_,schemaEnv:E,validateName:w,opts:p,self:h}=$,{root:l}=E;if((m==="#"||m==="#/")&&_===l.baseId)return g();const f=n.resolveRef.call(h,l,_,m);if(f===void 0)throw new o.default($.opts.uriResolver,_,m);if(f instanceof n.SchemaEnv)return b(f);return v(f);function g(){if(E===l)return c(u,w,E,E.$async);const P=d.scopeValue("root",{ref:l});return c(u,(0,t._)`${P}.validate`,l,l.$async)}function b(P){const A=a(u,P);c(u,A,P,P.$async)}function v(P){const A=d.scopeValue("schema",p.code.source===!0?{ref:P,code:(0,t.stringify)(P)}:{ref:P}),I=d.name("valid"),q=u.subschema({schema:P,dataTypes:[],schemaPath:t.nil,topSchemaRef:A,errSchemaPath:m},I);u.mergeEvaluated(q),u.ok(I)}}};function a(u,d){const{gen:m}=u;return d.validate?m.scopeValue("validate",{ref:d.validate}):(0,t._)`${m.scopeValue("wrapper",{ref:d})}.validate`}we.getValidate=a;function c(u,d,m,$){const{gen:_,it:E}=u,{allErrors:w,schemaEnv:p,opts:h}=E,l=h.passContext?r.default.this:t.nil;$?f():g();function f(){if(!p.$async)throw new Error("async schema referenced by sync schema");const P=_.let("valid");_.try(()=>{_.code((0,t._)`await ${(0,e.callValidateCode)(u,d,l)}`),v(d),w||_.assign(P,!0)},A=>{_.if((0,t._)`!(${A} instanceof ${E.ValidationError})`,()=>_.throw(A)),b(A),w||_.assign(P,!1)}),u.ok(P)}function g(){u.result((0,e.callValidateCode)(u,d,l),()=>v(d),()=>b(d))}function b(P){const A=(0,t._)`${P}.errors`;_.assign(r.default.vErrors,(0,t._)`${r.default.vErrors} === null ? ${A} : ${r.default.vErrors}.concat(${A})`),_.assign(r.default.errors,(0,t._)`${r.default.vErrors}.length`)}function v(P){var A;if(!E.opts.unevaluated)return;const I=(A=m?.validate)===null||A===void 0?void 0:A.evaluated;if(E.props!==!0)if(I&&!I.dynamicProps)I.props!==void 0&&(E.props=i.mergeEvaluated.props(_,I.props,E.props));else{const q=_.var("props",(0,t._)`${P}.evaluated.props`);E.props=i.mergeEvaluated.props(_,q,E.props,t.Name)}if(E.items!==!0)if(I&&!I.dynamicItems)I.items!==void 0&&(E.items=i.mergeEvaluated.items(_,I.items,E.items));else{const q=_.var("items",(0,t._)`${P}.evaluated.items`);E.items=i.mergeEvaluated.items(_,q,E.items,t.Name)}}}return we.callRef=c,we.default=s,we}var Ir;function Qn(){if(Ir)return Qe;Ir=1,Object.defineProperty(Qe,"__esModule",{value:!0});const o=Yn(),e=Xn(),t=["$schema","$id","$defs","$vocabulary",{keyword:"$comment"},"definitions",o.default,e.default];return Qe.default=t,Qe}var et={},tt={},jr;function Zn(){if(jr)return tt;jr=1,Object.defineProperty(tt,"__esModule",{value:!0});const o=Y(),e=o.operators,t={maximum:{okStr:"<=",ok:e.LTE,fail:e.GT},minimum:{okStr:">=",ok:e.GTE,fail:e.LT},exclusiveMaximum:{okStr:"<",ok:e.LT,fail:e.GTE},exclusiveMinimum:{okStr:">",ok:e.GT,fail:e.LTE}},r={message:({keyword:i,schemaCode:s})=>(0,o.str)`must be ${t[i].okStr} ${s}`,params:({keyword:i,schemaCode:s})=>(0,o._)`{comparison: ${t[i].okStr}, limit: ${s}}`},n={keyword:Object.keys(t),type:"number",schemaType:"number",$data:!0,error:r,code(i){const{keyword:s,data:a,schemaCode:c}=i;i.fail$data((0,o._)`${a} ${t[s].fail} ${c} || isNaN(${a})`)}};return tt.default=n,tt}var rt={},Or;function ei(){if(Or)return rt;Or=1,Object.defineProperty(rt,"__esModule",{value:!0});const o=Y(),t={keyword:"multipleOf",type:"number",schemaType:"number",$data:!0,error:{message:({schemaCode:r})=>(0,o.str)`must be multiple of ${r}`,params:({schemaCode:r})=>(0,o._)`{multipleOf: ${r}}`},code(r){const{gen:n,data:i,schemaCode:s,it:a}=r,c=a.opts.multipleOfPrecision,u=n.let("res"),d=c?(0,o._)`Math.abs(Math.round(${u}) - ${u}) > 1e-${c}`:(0,o._)`${u} !== parseInt(${u})`;r.fail$data((0,o._)`(${s} === 0 || (${u} = ${i}/${s}, ${d}))`)}};return rt.default=t,rt}var nt={},it={},qr;function ti(){if(qr)return it;qr=1,Object.defineProperty(it,"__esModule",{value:!0});function o(e){const t=e.length;let r=0,n=0,i;for(;n<t;)r++,i=e.charCodeAt(n++),i>=55296&&i<=56319&&n<t&&(i=e.charCodeAt(n),(i&64512)===56320&&n++);return r}return it.default=o,o.code='require("ajv/dist/runtime/ucs2length").default',it}var Dr;function ri(){if(Dr)return nt;Dr=1,Object.defineProperty(nt,"__esModule",{value:!0});const o=Y(),e=ee(),t=ti(),n={keyword:["maxLength","minLength"],type:"string",schemaType:"number",$data:!0,error:{message({keyword:i,schemaCode:s}){const a=i==="maxLength"?"more":"fewer";return(0,o.str)`must NOT have ${a} than ${s} characters`},params:({schemaCode:i})=>(0,o._)`{limit: ${i}}`},code(i){const{keyword:s,data:a,schemaCode:c,it:u}=i,d=s==="maxLength"?o.operators.GT:o.operators.LT,m=u.opts.unicode===!1?(0,o._)`${a}.length`:(0,o._)`${(0,e.useFunc)(i.gen,t.default)}(${a})`;i.fail$data((0,o._)`${m} ${d} ${c}`)}};return nt.default=n,nt}var st={},Vr;function ni(){if(Vr)return st;Vr=1,Object.defineProperty(st,"__esModule",{value:!0});const o=me(),e=Y(),r={keyword:"pattern",type:"string",schemaType:"string",$data:!0,error:{message:({schemaCode:n})=>(0,e.str)`must match pattern "${n}"`,params:({schemaCode:n})=>(0,e._)`{pattern: ${n}}`},code(n){const{data:i,$data:s,schema:a,schemaCode:c,it:u}=n,d=u.opts.unicodeRegExp?"u":"",m=s?(0,e._)`(new RegExp(${c}, ${d}))`:(0,o.usePattern)(n,a);n.fail$data((0,e._)`!${m}.test(${i})`)}};return st.default=r,st}var ot={},Fr;function ii(){if(Fr)return ot;Fr=1,Object.defineProperty(ot,"__esModule",{value:!0});const o=Y(),t={keyword:["maxProperties","minProperties"],type:"object",schemaType:"number",$data:!0,error:{message({keyword:r,schemaCode:n}){const i=r==="maxProperties"?"more":"fewer";return(0,o.str)`must NOT have ${i} than ${n} properties`},params:({schemaCode:r})=>(0,o._)`{limit: ${r}}`},code(r){const{keyword:n,data:i,schemaCode:s}=r,a=n==="maxProperties"?o.operators.GT:o.operators.LT;r.fail$data((0,o._)`Object.keys(${i}).length ${a} ${s}`)}};return ot.default=t,ot}var at={},zr;function si(){if(zr)return at;zr=1,Object.defineProperty(at,"__esModule",{value:!0});const o=me(),e=Y(),t=ee(),n={keyword:"required",type:"object",schemaType:"array",$data:!0,error:{message:({params:{missingProperty:i}})=>(0,e.str)`must have required property '${i}'`,params:({params:{missingProperty:i}})=>(0,e._)`{missingProperty: ${i}}`},code(i){const{gen:s,schema:a,schemaCode:c,data:u,$data:d,it:m}=i,{opts:$}=m;if(!d&&a.length===0)return;const _=a.length>=$.loopRequired;if(m.allErrors?E():w(),$.strictRequired){const l=i.parentSchema.properties,{definedProperties:f}=i.it;for(const g of a)if(l?.[g]===void 0&&!f.has(g)){const b=m.schemaEnv.baseId+m.errSchemaPath,v=`required property "${g}" is not defined at "${b}" (strictRequired)`;(0,t.checkStrictMode)(m,v,m.opts.strictRequired)}}function E(){if(_||d)i.block$data(e.nil,p);else for(const l of a)(0,o.checkReportMissingProp)(i,l)}function w(){const l=s.let("missing");if(_||d){const f=s.let("valid",!0);i.block$data(f,()=>h(l,f)),i.ok(f)}else s.if((0,o.checkMissingProp)(i,a,l)),(0,o.reportMissingProp)(i,l),s.else()}function p(){s.forOf("prop",c,l=>{i.setParams({missingProperty:l}),s.if((0,o.noPropertyInData)(s,u,l,$.ownProperties),()=>i.error())})}function h(l,f){i.setParams({missingProperty:l}),s.forOf(l,c,()=>{s.assign(f,(0,o.propertyInData)(s,u,l,$.ownProperties)),s.if((0,e.not)(f),()=>{i.error(),s.break()})},e.nil)}}};return at.default=n,at}var ct={},Lr;function oi(){if(Lr)return ct;Lr=1,Object.defineProperty(ct,"__esModule",{value:!0});const o=Y(),t={keyword:["maxItems","minItems"],type:"array",schemaType:"number",$data:!0,error:{message({keyword:r,schemaCode:n}){const i=r==="maxItems"?"more":"fewer";return(0,o.str)`must NOT have ${i} than ${n} items`},params:({schemaCode:r})=>(0,o._)`{limit: ${r}}`},code(r){const{keyword:n,data:i,schemaCode:s}=r,a=n==="maxItems"?o.operators.GT:o.operators.LT;r.fail$data((0,o._)`${i}.length ${a} ${s}`)}};return ct.default=t,ct}var lt={},ut={},Ur;function Gt(){if(Ur)return ut;Ur=1,Object.defineProperty(ut,"__esModule",{value:!0});const o=br();return o.code='require("ajv/dist/runtime/equal").default',ut.default=o,ut}var Gr;function ai(){if(Gr)return lt;Gr=1,Object.defineProperty(lt,"__esModule",{value:!0});const o=Ge(),e=Y(),t=ee(),r=Gt(),i={keyword:"uniqueItems",type:"array",schemaType:"boolean",$data:!0,error:{message:({params:{i:s,j:a}})=>(0,e.str)`must NOT have duplicate items (items ## ${a} and ${s} are identical)`,params:({params:{i:s,j:a}})=>(0,e._)`{i: ${s}, j: ${a}}`},code(s){const{gen:a,data:c,$data:u,schema:d,parentSchema:m,schemaCode:$,it:_}=s;if(!u&&!d)return;const E=a.let("valid"),w=m.items?(0,o.getSchemaTypes)(m.items):[];s.block$data(E,p,(0,e._)`${$} === false`),s.ok(E);function p(){const g=a.let("i",(0,e._)`${c}.length`),b=a.let("j");s.setParams({i:g,j:b}),a.assign(E,!0),a.if((0,e._)`${g} > 1`,()=>(h()?l:f)(g,b))}function h(){return w.length>0&&!w.some(g=>g==="object"||g==="array")}function l(g,b){const v=a.name("item"),P=(0,o.checkDataTypes)(w,v,_.opts.strictNumbers,o.DataType.Wrong),A=a.const("indices",(0,e._)`{}`);a.for((0,e._)`;${g}--;`,()=>{a.let(v,(0,e._)`${c}[${g}]`),a.if(P,(0,e._)`continue`),w.length>1&&a.if((0,e._)`typeof ${v} == "string"`,(0,e._)`${v} += "_"`),a.if((0,e._)`typeof ${A}[${v}] == "number"`,()=>{a.assign(b,(0,e._)`${A}[${v}]`),s.error(),a.assign(E,!1).break()}).code((0,e._)`${A}[${v}] = ${g}`)})}function f(g,b){const v=(0,t.useFunc)(a,r.default),P=a.name("outer");a.label(P).for((0,e._)`;${g}--;`,()=>a.for((0,e._)`${b} = ${g}; ${b}--;`,()=>a.if((0,e._)`${v}(${c}[${g}], ${c}[${b}])`,()=>{s.error(),a.assign(E,!1).break(P)})))}}};return lt.default=i,lt}var dt={},Kr;function ci(){if(Kr)return dt;Kr=1,Object.defineProperty(dt,"__esModule",{value:!0});const o=Y(),e=ee(),t=Gt(),n={keyword:"const",$data:!0,error:{message:"must be equal to constant",params:({schemaCode:i})=>(0,o._)`{allowedValue: ${i}}`},code(i){const{gen:s,data:a,$data:c,schemaCode:u,schema:d}=i;c||d&&typeof d=="object"?i.fail$data((0,o._)`!${(0,e.useFunc)(s,t.default)}(${a}, ${u})`):i.fail((0,o._)`${d} !== ${a}`)}};return dt.default=n,dt}var ht={},Br;function li(){if(Br)return ht;Br=1,Object.defineProperty(ht,"__esModule",{value:!0});const o=Y(),e=ee(),t=Gt(),n={keyword:"enum",schemaType:"array",$data:!0,error:{message:"must be equal to one of the allowed values",params:({schemaCode:i})=>(0,o._)`{allowedValues: ${i}}`},code(i){const{gen:s,data:a,$data:c,schema:u,schemaCode:d,it:m}=i;if(!c&&u.length===0)throw new Error("enum must have non-empty array");const $=u.length>=m.opts.loopEnum;let _;const E=()=>_??(_=(0,e.useFunc)(s,t.default));let w;if($||c)w=s.let("valid"),i.block$data(w,p);else{if(!Array.isArray(u))throw new Error("ajv implementation error");const l=s.const("vSchema",d);w=(0,o.or)(...u.map((f,g)=>h(l,g)))}i.pass(w);function p(){s.assign(w,!1),s.forOf("v",d,l=>s.if((0,o._)`${E()}(${a}, ${l})`,()=>s.assign(w,!0).break()))}function h(l,f){const g=u[f];return typeof g=="object"&&g!==null?(0,o._)`${E()}(${a}, ${l}[${f}])`:(0,o._)`${a} === ${g}`}}};return ht.default=n,ht}var Hr;function ui(){if(Hr)return et;Hr=1,Object.defineProperty(et,"__esModule",{value:!0});const o=Zn(),e=ei(),t=ri(),r=ni(),n=ii(),i=si(),s=oi(),a=ai(),c=ci(),u=li(),d=[o.default,e.default,t.default,r.default,n.default,i.default,s.default,a.default,{keyword:"type",schemaType:["string","array"]},{keyword:"nullable",schemaType:"boolean"},c.default,u.default];return et.default=d,et}var ft={},Ae={},Wr;function Jr(){if(Wr)return Ae;Wr=1,Object.defineProperty(Ae,"__esModule",{value:!0}),Ae.validateAdditionalItems=void 0;const o=Y(),e=ee(),r={keyword:"additionalItems",type:"array",schemaType:["boolean","object"],before:"uniqueItems",error:{message:({params:{len:i}})=>(0,o.str)`must NOT have more than ${i} items`,params:({params:{len:i}})=>(0,o._)`{limit: ${i}}`},code(i){const{parentSchema:s,it:a}=i,{items:c}=s;if(!Array.isArray(c)){(0,e.checkStrictMode)(a,'"additionalItems" is ignored when "items" is not an array of schemas');return}n(i,c)}};function n(i,s){const{gen:a,schema:c,data:u,keyword:d,it:m}=i;m.items=!0;const $=a.const("len",(0,o._)`${u}.length`);if(c===!1)i.setParams({len:s.length}),i.pass((0,o._)`${$} <= ${s.length}`);else if(typeof c=="object"&&!(0,e.alwaysValidSchema)(m,c)){const E=a.var("valid",(0,o._)`${$} <= ${s.length}`);a.if((0,o.not)(E),()=>_(E)),i.ok(E)}function _(E){a.forRange("i",s.length,$,w=>{i.subschema({keyword:d,dataProp:w,dataPropType:e.Type.Num},E),m.allErrors||a.if((0,o.not)(E),()=>a.break())})}}return Ae.validateAdditionalItems=n,Ae.default=r,Ae}var pt={},Re={},Yr;function Xr(){if(Yr)return Re;Yr=1,Object.defineProperty(Re,"__esModule",{value:!0}),Re.validateTuple=void 0;const o=Y(),e=ee(),t=me(),r={keyword:"items",type:"array",schemaType:["object","array","boolean"],before:"uniqueItems",code(i){const{schema:s,it:a}=i;if(Array.isArray(s))return n(i,"additionalItems",s);a.items=!0,!(0,e.alwaysValidSchema)(a,s)&&i.ok((0,t.validateArray)(i))}};function n(i,s,a=i.schema){const{gen:c,parentSchema:u,data:d,keyword:m,it:$}=i;w(u),$.opts.unevaluated&&a.length&&$.items!==!0&&($.items=e.mergeEvaluated.items(c,a.length,$.items));const _=c.name("valid"),E=c.const("len",(0,o._)`${d}.length`);a.forEach((p,h)=>{(0,e.alwaysValidSchema)($,p)||(c.if((0,o._)`${E} > ${h}`,()=>i.subschema({keyword:m,schemaProp:h,dataProp:h},_)),i.ok(_))});function w(p){const{opts:h,errSchemaPath:l}=$,f=a.length,g=f===p.minItems&&(f===p.maxItems||p[s]===!1);if(h.strictTuples&&!g){const b=`"${m}" is ${f}-tuple, but minItems or maxItems/${s} are not specified or different at path "${l}"`;(0,e.checkStrictMode)($,b,h.strictTuples)}}}return Re.validateTuple=n,Re.default=r,Re}var Qr;function di(){if(Qr)return pt;Qr=1,Object.defineProperty(pt,"__esModule",{value:!0});const o=Xr(),e={keyword:"prefixItems",type:"array",schemaType:["array"],before:"uniqueItems",code:t=>(0,o.validateTuple)(t,"items")};return pt.default=e,pt}var mt={},Zr;function hi(){if(Zr)return mt;Zr=1,Object.defineProperty(mt,"__esModule",{value:!0});const o=Y(),e=ee(),t=me(),r=Jr(),i={keyword:"items",type:"array",schemaType:["object","boolean"],before:"uniqueItems",error:{message:({params:{len:s}})=>(0,o.str)`must NOT have more than ${s} items`,params:({params:{len:s}})=>(0,o._)`{limit: ${s}}`},code(s){const{schema:a,parentSchema:c,it:u}=s,{prefixItems:d}=c;u.items=!0,!(0,e.alwaysValidSchema)(u,a)&&(d?(0,r.validateAdditionalItems)(s,d):s.ok((0,t.validateArray)(s)))}};return mt.default=i,mt}var yt={},en;function fi(){if(en)return yt;en=1,Object.defineProperty(yt,"__esModule",{value:!0});const o=Y(),e=ee(),r={keyword:"contains",type:"array",schemaType:["object","boolean"],before:"uniqueItems",trackErrors:!0,error:{message:({params:{min:n,max:i}})=>i===void 0?(0,o.str)`must contain at least ${n} valid item(s)`:(0,o.str)`must contain at least ${n} and no more than ${i} valid item(s)`,params:({params:{min:n,max:i}})=>i===void 0?(0,o._)`{minContains: ${n}}`:(0,o._)`{minContains: ${n}, maxContains: ${i}}`},code(n){const{gen:i,schema:s,parentSchema:a,data:c,it:u}=n;let d,m;const{minContains:$,maxContains:_}=a;u.opts.next?(d=$===void 0?1:$,m=_):d=1;const E=i.const("len",(0,o._)`${c}.length`);if(n.setParams({min:d,max:m}),m===void 0&&d===0){(0,e.checkStrictMode)(u,'"minContains" == 0 without "maxContains": "contains" keyword ignored');return}if(m!==void 0&&d>m){(0,e.checkStrictMode)(u,'"minContains" > "maxContains" is always invalid'),n.fail();return}if((0,e.alwaysValidSchema)(u,s)){let f=(0,o._)`${E} >= ${d}`;m!==void 0&&(f=(0,o._)`${f} && ${E} <= ${m}`),n.pass(f);return}u.items=!0;const w=i.name("valid");m===void 0&&d===1?h(w,()=>i.if(w,()=>i.break())):d===0?(i.let(w,!0),m!==void 0&&i.if((0,o._)`${c}.length > 0`,p)):(i.let(w,!1),p()),n.result(w,()=>n.reset());function p(){const f=i.name("_valid"),g=i.let("count",0);h(f,()=>i.if(f,()=>l(g)))}function h(f,g){i.forRange("i",0,E,b=>{n.subschema({keyword:"contains",dataProp:b,dataPropType:e.Type.Num,compositeRule:!0},f),g()})}function l(f){i.code((0,o._)`${f}++`),m===void 0?i.if((0,o._)`${f} >= ${d}`,()=>i.assign(w,!0).break()):(i.if((0,o._)`${f} > ${m}`,()=>i.assign(w,!1).break()),d===1?i.assign(w,!0):i.if((0,o._)`${f} >= ${d}`,()=>i.assign(w,!0)))}}};return yt.default=r,yt}var Kt={},tn;function pi(){return tn||(tn=1,(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.validateSchemaDeps=o.validatePropertyDeps=o.error=void 0;const e=Y(),t=ee(),r=me();o.error={message:({params:{property:c,depsCount:u,deps:d}})=>{const m=u===1?"property":"properties";return(0,e.str)`must have ${m} ${d} when property ${c} is present`},params:({params:{property:c,depsCount:u,deps:d,missingProperty:m}})=>(0,e._)`{property: ${c},
    missingProperty: ${m},
    depsCount: ${u},
    deps: ${d}}`};const n={keyword:"dependencies",type:"object",schemaType:"object",error:o.error,code(c){const[u,d]=i(c);s(c,u),a(c,d)}};function i({schema:c}){const u={},d={};for(const m in c){if(m==="__proto__")continue;const $=Array.isArray(c[m])?u:d;$[m]=c[m]}return[u,d]}function s(c,u=c.schema){const{gen:d,data:m,it:$}=c;if(Object.keys(u).length===0)return;const _=d.let("missing");for(const E in u){const w=u[E];if(w.length===0)continue;const p=(0,r.propertyInData)(d,m,E,$.opts.ownProperties);c.setParams({property:E,depsCount:w.length,deps:w.join(", ")}),$.allErrors?d.if(p,()=>{for(const h of w)(0,r.checkReportMissingProp)(c,h)}):(d.if((0,e._)`${p} && (${(0,r.checkMissingProp)(c,w,_)})`),(0,r.reportMissingProp)(c,_),d.else())}}o.validatePropertyDeps=s;function a(c,u=c.schema){const{gen:d,data:m,keyword:$,it:_}=c,E=d.name("valid");for(const w in u)(0,t.alwaysValidSchema)(_,u[w])||(d.if((0,r.propertyInData)(d,m,w,_.opts.ownProperties),()=>{const p=c.subschema({keyword:$,schemaProp:w},E);c.mergeValidEvaluated(p,E)},()=>d.var(E,!0)),c.ok(E))}o.validateSchemaDeps=a,o.default=n})(Kt)),Kt}var gt={},rn;function mi(){if(rn)return gt;rn=1,Object.defineProperty(gt,"__esModule",{value:!0});const o=Y(),e=ee(),r={keyword:"propertyNames",type:"object",schemaType:["object","boolean"],error:{message:"property name must be valid",params:({params:n})=>(0,o._)`{propertyName: ${n.propertyName}}`},code(n){const{gen:i,schema:s,data:a,it:c}=n;if((0,e.alwaysValidSchema)(c,s))return;const u=i.name("valid");i.forIn("key",a,d=>{n.setParams({propertyName:d}),n.subschema({keyword:"propertyNames",data:d,dataTypes:["string"],propertyName:d,compositeRule:!0},u),i.if((0,o.not)(u),()=>{n.error(!0),c.allErrors||i.break()})}),n.ok(u)}};return gt.default=r,gt}var vt={},nn;function sn(){if(nn)return vt;nn=1,Object.defineProperty(vt,"__esModule",{value:!0});const o=me(),e=Y(),t=be(),r=ee(),i={keyword:"additionalProperties",type:["object"],schemaType:["boolean","object"],allowUndefined:!0,trackErrors:!0,error:{message:"must NOT have additional properties",params:({params:s})=>(0,e._)`{additionalProperty: ${s.additionalProperty}}`},code(s){const{gen:a,schema:c,parentSchema:u,data:d,errsCount:m,it:$}=s;if(!m)throw new Error("ajv implementation error");const{allErrors:_,opts:E}=$;if($.props=!0,E.removeAdditional!=="all"&&(0,r.alwaysValidSchema)($,c))return;const w=(0,o.allSchemaProperties)(u.properties),p=(0,o.allSchemaProperties)(u.patternProperties);h(),s.ok((0,e._)`${m} === ${t.default.errors}`);function h(){a.forIn("key",d,v=>{!w.length&&!p.length?g(v):a.if(l(v),()=>g(v))})}function l(v){let P;if(w.length>8){const A=(0,r.schemaRefOrVal)($,u.properties,"properties");P=(0,o.isOwnProperty)(a,A,v)}else w.length?P=(0,e.or)(...w.map(A=>(0,e._)`${v} === ${A}`)):P=e.nil;return p.length&&(P=(0,e.or)(P,...p.map(A=>(0,e._)`${(0,o.usePattern)(s,A)}.test(${v})`))),(0,e.not)(P)}function f(v){a.code((0,e._)`delete ${d}[${v}]`)}function g(v){if(E.removeAdditional==="all"||E.removeAdditional&&c===!1){f(v);return}if(c===!1){s.setParams({additionalProperty:v}),s.error(),_||a.break();return}if(typeof c=="object"&&!(0,r.alwaysValidSchema)($,c)){const P=a.name("valid");E.removeAdditional==="failing"?(b(v,P,!1),a.if((0,e.not)(P),()=>{s.reset(),f(v)})):(b(v,P),_||a.if((0,e.not)(P),()=>a.break()))}}function b(v,P,A){const I={keyword:"additionalProperties",dataProp:v,dataPropType:r.Type.Str};A===!1&&Object.assign(I,{compositeRule:!0,createErrors:!1,allErrors:!1}),s.subschema(I,P)}}};return vt.default=i,vt}var bt={},on;function yi(){if(on)return bt;on=1,Object.defineProperty(bt,"__esModule",{value:!0});const o=Be(),e=me(),t=ee(),r=sn(),n={keyword:"properties",type:"object",schemaType:"object",code(i){const{gen:s,schema:a,parentSchema:c,data:u,it:d}=i;d.opts.removeAdditional==="all"&&c.additionalProperties===void 0&&r.default.code(new o.KeywordCxt(d,r.default,"additionalProperties"));const m=(0,e.allSchemaProperties)(a);for(const p of m)d.definedProperties.add(p);d.opts.unevaluated&&m.length&&d.props!==!0&&(d.props=t.mergeEvaluated.props(s,(0,t.toHash)(m),d.props));const $=m.filter(p=>!(0,t.alwaysValidSchema)(d,a[p]));if($.length===0)return;const _=s.name("valid");for(const p of $)E(p)?w(p):(s.if((0,e.propertyInData)(s,u,p,d.opts.ownProperties)),w(p),d.allErrors||s.else().var(_,!0),s.endIf()),i.it.definedProperties.add(p),i.ok(_);function E(p){return d.opts.useDefaults&&!d.compositeRule&&a[p].default!==void 0}function w(p){i.subschema({keyword:"properties",schemaProp:p,dataProp:p},_)}}};return bt.default=n,bt}var wt={},an;function gi(){if(an)return wt;an=1,Object.defineProperty(wt,"__esModule",{value:!0});const o=me(),e=Y(),t=ee(),r=ee(),n={keyword:"patternProperties",type:"object",schemaType:"object",code(i){const{gen:s,schema:a,data:c,parentSchema:u,it:d}=i,{opts:m}=d,$=(0,o.allSchemaProperties)(a),_=$.filter(g=>(0,t.alwaysValidSchema)(d,a[g]));if($.length===0||_.length===$.length&&(!d.opts.unevaluated||d.props===!0))return;const E=m.strictSchema&&!m.allowMatchingProperties&&u.properties,w=s.name("valid");d.props!==!0&&!(d.props instanceof e.Name)&&(d.props=(0,r.evaluatedPropsToName)(s,d.props));const{props:p}=d;h();function h(){for(const g of $)E&&l(g),d.allErrors?f(g):(s.var(w,!0),f(g),s.if(w))}function l(g){for(const b in E)new RegExp(g).test(b)&&(0,t.checkStrictMode)(d,`property ${b} matches pattern ${g} (use allowMatchingProperties)`)}function f(g){s.forIn("key",c,b=>{s.if((0,e._)`${(0,o.usePattern)(i,g)}.test(${b})`,()=>{const v=_.includes(g);v||i.subschema({keyword:"patternProperties",schemaProp:g,dataProp:b,dataPropType:r.Type.Str},w),d.opts.unevaluated&&p!==!0?s.assign((0,e._)`${p}[${b}]`,!0):!v&&!d.allErrors&&s.if((0,e.not)(w),()=>s.break())})})}}};return wt.default=n,wt}var $t={},cn;function vi(){if(cn)return $t;cn=1,Object.defineProperty($t,"__esModule",{value:!0});const o=ee(),e={keyword:"not",schemaType:["object","boolean"],trackErrors:!0,code(t){const{gen:r,schema:n,it:i}=t;if((0,o.alwaysValidSchema)(i,n)){t.fail();return}const s=r.name("valid");t.subschema({keyword:"not",compositeRule:!0,createErrors:!1,allErrors:!1},s),t.failResult(s,()=>t.reset(),()=>t.error())},error:{message:"must NOT be valid"}};return $t.default=e,$t}var _t={},ln;function bi(){if(ln)return _t;ln=1,Object.defineProperty(_t,"__esModule",{value:!0});const e={keyword:"anyOf",schemaType:"array",trackErrors:!0,code:me().validateUnion,error:{message:"must match a schema in anyOf"}};return _t.default=e,_t}var Pt={},un;function wi(){if(un)return Pt;un=1,Object.defineProperty(Pt,"__esModule",{value:!0});const o=Y(),e=ee(),r={keyword:"oneOf",schemaType:"array",trackErrors:!0,error:{message:"must match exactly one schema in oneOf",params:({params:n})=>(0,o._)`{passingSchemas: ${n.passing}}`},code(n){const{gen:i,schema:s,parentSchema:a,it:c}=n;if(!Array.isArray(s))throw new Error("ajv implementation error");if(c.opts.discriminator&&a.discriminator)return;const u=s,d=i.let("valid",!1),m=i.let("passing",null),$=i.name("_valid");n.setParams({passing:m}),i.block(_),n.result(d,()=>n.reset(),()=>n.error(!0));function _(){u.forEach((E,w)=>{let p;(0,e.alwaysValidSchema)(c,E)?i.var($,!0):p=n.subschema({keyword:"oneOf",schemaProp:w,compositeRule:!0},$),w>0&&i.if((0,o._)`${$} && ${d}`).assign(d,!1).assign(m,(0,o._)`[${m}, ${w}]`).else(),i.if($,()=>{i.assign(d,!0),i.assign(m,w),p&&n.mergeEvaluated(p,o.Name)})})}}};return Pt.default=r,Pt}var St={},dn;function $i(){if(dn)return St;dn=1,Object.defineProperty(St,"__esModule",{value:!0});const o=ee(),e={keyword:"allOf",schemaType:"array",code(t){const{gen:r,schema:n,it:i}=t;if(!Array.isArray(n))throw new Error("ajv implementation error");const s=r.name("valid");n.forEach((a,c)=>{if((0,o.alwaysValidSchema)(i,a))return;const u=t.subschema({keyword:"allOf",schemaProp:c},s);t.ok(s),t.mergeEvaluated(u)})}};return St.default=e,St}var Et={},hn;function _i(){if(hn)return Et;hn=1,Object.defineProperty(Et,"__esModule",{value:!0});const o=Y(),e=ee(),r={keyword:"if",schemaType:["object","boolean"],trackErrors:!0,error:{message:({params:i})=>(0,o.str)`must match "${i.ifClause}" schema`,params:({params:i})=>(0,o._)`{failingKeyword: ${i.ifClause}}`},code(i){const{gen:s,parentSchema:a,it:c}=i;a.then===void 0&&a.else===void 0&&(0,e.checkStrictMode)(c,'"if" without "then" and "else" is ignored');const u=n(c,"then"),d=n(c,"else");if(!u&&!d)return;const m=s.let("valid",!0),$=s.name("_valid");if(_(),i.reset(),u&&d){const w=s.let("ifClause");i.setParams({ifClause:w}),s.if($,E("then",w),E("else",w))}else u?s.if($,E("then")):s.if((0,o.not)($),E("else"));i.pass(m,()=>i.error(!0));function _(){const w=i.subschema({keyword:"if",compositeRule:!0,createErrors:!1,allErrors:!1},$);i.mergeEvaluated(w)}function E(w,p){return()=>{const h=i.subschema({keyword:w},$);s.assign(m,$),i.mergeValidEvaluated(h,m),p?s.assign(p,(0,o._)`${w}`):i.setParams({ifClause:w})}}}};function n(i,s){const a=i.schema[s];return a!==void 0&&!(0,e.alwaysValidSchema)(i,a)}return Et.default=r,Et}var Tt={},fn;function Pi(){if(fn)return Tt;fn=1,Object.defineProperty(Tt,"__esModule",{value:!0});const o=ee(),e={keyword:["then","else"],schemaType:["object","boolean"],code({keyword:t,parentSchema:r,it:n}){r.if===void 0&&(0,o.checkStrictMode)(n,`"${t}" without "if" is ignored`)}};return Tt.default=e,Tt}var pn;function Si(){if(pn)return ft;pn=1,Object.defineProperty(ft,"__esModule",{value:!0});const o=Jr(),e=di(),t=Xr(),r=hi(),n=fi(),i=pi(),s=mi(),a=sn(),c=yi(),u=gi(),d=vi(),m=bi(),$=wi(),_=$i(),E=_i(),w=Pi();function p(h=!1){const l=[d.default,m.default,$.default,_.default,E.default,w.default,s.default,a.default,i.default,c.default,u.default];return h?l.push(e.default,r.default):l.push(o.default,t.default),l.push(n.default),l}return ft.default=p,ft}var Mt={},kt={},mn;function Ei(){if(mn)return kt;mn=1,Object.defineProperty(kt,"__esModule",{value:!0});const o=Y(),t={keyword:"format",type:["number","string"],schemaType:"string",$data:!0,error:{message:({schemaCode:r})=>(0,o.str)`must match format "${r}"`,params:({schemaCode:r})=>(0,o._)`{format: ${r}}`},code(r,n){const{gen:i,data:s,$data:a,schema:c,schemaCode:u,it:d}=r,{opts:m,errSchemaPath:$,schemaEnv:_,self:E}=d;if(!m.validateFormats)return;a?w():p();function w(){const h=i.scopeValue("formats",{ref:E.formats,code:m.code.formats}),l=i.const("fDef",(0,o._)`${h}[${u}]`),f=i.let("fType"),g=i.let("format");i.if((0,o._)`typeof ${l} == "object" && !(${l} instanceof RegExp)`,()=>i.assign(f,(0,o._)`${l}.type || "string"`).assign(g,(0,o._)`${l}.validate`),()=>i.assign(f,(0,o._)`"string"`).assign(g,l)),r.fail$data((0,o.or)(b(),v()));function b(){return m.strictSchema===!1?o.nil:(0,o._)`${u} && !${g}`}function v(){const P=_.$async?(0,o._)`(${l}.async ? await ${g}(${s}) : ${g}(${s}))`:(0,o._)`${g}(${s})`,A=(0,o._)`(typeof ${g} == "function" ? ${P} : ${g}.test(${s}))`;return(0,o._)`${g} && ${g} !== true && ${f} === ${n} && !${A}`}}function p(){const h=E.formats[c];if(!h){b();return}if(h===!0)return;const[l,f,g]=v(h);l===n&&r.pass(P());function b(){if(m.strictSchema===!1){E.logger.warn(A());return}throw new Error(A());function A(){return`unknown format "${c}" ignored in schema at path "${$}"`}}function v(A){const I=A instanceof RegExp?(0,o.regexpCode)(A):m.code.formats?(0,o._)`${m.code.formats}${(0,o.getProperty)(c)}`:void 0,q=i.scopeValue("formats",{key:c,ref:A,code:I});return typeof A=="object"&&!(A instanceof RegExp)?[A.type||"string",A.validate,(0,o._)`${q}.validate`]:["string",A,q]}function P(){if(typeof h=="object"&&!(h instanceof RegExp)&&h.async){if(!_.$async)throw new Error("async format in sync schema");return(0,o._)`await ${g}(${s})`}return typeof f=="function"?(0,o._)`${g}(${s})`:(0,o._)`${g}.test(${s})`}}}};return kt.default=t,kt}var yn;function Ti(){if(yn)return Mt;yn=1,Object.defineProperty(Mt,"__esModule",{value:!0});const e=[Ei().default];return Mt.default=e,Mt}var Te={},gn;function Mi(){return gn||(gn=1,Object.defineProperty(Te,"__esModule",{value:!0}),Te.contentVocabulary=Te.metadataVocabulary=void 0,Te.metadataVocabulary=["title","description","default","deprecated","readOnly","writeOnly","examples"],Te.contentVocabulary=["contentMediaType","contentEncoding","contentSchema"]),Te}var vn;function ki(){if(vn)return Xe;vn=1,Object.defineProperty(Xe,"__esModule",{value:!0});const o=Qn(),e=ui(),t=Si(),r=Ti(),n=Mi(),i=[o.default,e.default,(0,t.default)(),r.default,n.metadataVocabulary,n.contentVocabulary];return Xe.default=i,Xe}var At={},Oe={},bn;function Ai(){if(bn)return Oe;bn=1,Object.defineProperty(Oe,"__esModule",{value:!0}),Oe.DiscrError=void 0;var o;return(function(e){e.Tag="tag",e.Mapping="mapping"})(o||(Oe.DiscrError=o={})),Oe}var wn;function Ri(){if(wn)return At;wn=1,Object.defineProperty(At,"__esModule",{value:!0});const o=Y(),e=Ai(),t=Ft(),r=Je(),n=ee(),s={keyword:"discriminator",type:"object",schemaType:"object",error:{message:({params:{discrError:a,tagName:c}})=>a===e.DiscrError.Tag?`tag "${c}" must be string`:`value of tag "${c}" must be in oneOf`,params:({params:{discrError:a,tag:c,tagName:u}})=>(0,o._)`{error: ${a}, tag: ${u}, tagValue: ${c}}`},code(a){const{gen:c,data:u,schema:d,parentSchema:m,it:$}=a,{oneOf:_}=m;if(!$.opts.discriminator)throw new Error("discriminator: requires discriminator option");const E=d.propertyName;if(typeof E!="string")throw new Error("discriminator: requires propertyName");if(d.mapping)throw new Error("discriminator: mapping is not supported");if(!_)throw new Error("discriminator: requires oneOf keyword");const w=c.let("valid",!1),p=c.const("tag",(0,o._)`${u}${(0,o.getProperty)(E)}`);c.if((0,o._)`typeof ${p} == "string"`,()=>h(),()=>a.error(!1,{discrError:e.DiscrError.Tag,tag:p,tagName:E})),a.ok(w);function h(){const g=f();c.if(!1);for(const b in g)c.elseIf((0,o._)`${p} === ${b}`),c.assign(w,l(g[b]));c.else(),a.error(!1,{discrError:e.DiscrError.Mapping,tag:p,tagName:E}),c.endIf()}function l(g){const b=c.name("valid"),v=a.subschema({keyword:"oneOf",schemaProp:g},b);return a.mergeEvaluated(v,o.Name),b}function f(){var g;const b={},v=A(m);let P=!0;for(let V=0;V<_.length;V++){let B=_[V];if(B?.$ref&&!(0,n.schemaHasRulesButRef)(B,$.self.RULES)){const X=B.$ref;if(B=t.resolveRef.call($.self,$.schemaEnv.root,$.baseId,X),B instanceof t.SchemaEnv&&(B=B.schema),B===void 0)throw new r.default($.opts.uriResolver,$.baseId,X)}const U=(g=B?.properties)===null||g===void 0?void 0:g[E];if(typeof U!="object")throw new Error(`discriminator: oneOf subschemas (or referenced schemas) must have "properties/${E}"`);P=P&&(v||A(B)),I(U,V)}if(!P)throw new Error(`discriminator: "${E}" must be required`);return b;function A({required:V}){return Array.isArray(V)&&V.includes(E)}function I(V,B){if(V.const)q(V.const,B);else if(V.enum)for(const U of V.enum)q(U,B);else throw new Error(`discriminator: "properties/${E}" must have "const" or "enum"`)}function q(V,B){if(typeof V!="string"||V in b)throw new Error(`discriminator: "${E}" values must be unique strings`);b[V]=B}}}};return At.default=s,At}const xi={$schema:"http://json-schema.org/draft-07/schema#",$id:"http://json-schema.org/draft-07/schema#",title:"Core schema meta-schema",definitions:{schemaArray:{type:"array",minItems:1,items:{$ref:"#"}},nonNegativeInteger:{type:"integer",minimum:0},nonNegativeIntegerDefault0:{allOf:[{$ref:"#/definitions/nonNegativeInteger"},{default:0}]},simpleTypes:{enum:["array","boolean","integer","null","number","object","string"]},stringArray:{type:"array",items:{type:"string"},uniqueItems:!0,default:[]}},type:["object","boolean"],properties:{$id:{type:"string",format:"uri-reference"},$schema:{type:"string",format:"uri"},$ref:{type:"string",format:"uri-reference"},$comment:{type:"string"},title:{type:"string"},description:{type:"string"},default:!0,readOnly:{type:"boolean",default:!1},examples:{type:"array",items:!0},multipleOf:{type:"number",exclusiveMinimum:0},maximum:{type:"number"},exclusiveMaximum:{type:"number"},minimum:{type:"number"},exclusiveMinimum:{type:"number"},maxLength:{$ref:"#/definitions/nonNegativeInteger"},minLength:{$ref:"#/definitions/nonNegativeIntegerDefault0"},pattern:{type:"string",format:"regex"},additionalItems:{$ref:"#"},items:{anyOf:[{$ref:"#"},{$ref:"#/definitions/schemaArray"}],default:!0},maxItems:{$ref:"#/definitions/nonNegativeInteger"},minItems:{$ref:"#/definitions/nonNegativeIntegerDefault0"},uniqueItems:{type:"boolean",default:!1},contains:{$ref:"#"},maxProperties:{$ref:"#/definitions/nonNegativeInteger"},minProperties:{$ref:"#/definitions/nonNegativeIntegerDefault0"},required:{$ref:"#/definitions/stringArray"},additionalProperties:{$ref:"#"},definitions:{type:"object",additionalProperties:{$ref:"#"},default:{}},properties:{type:"object",additionalProperties:{$ref:"#"},default:{}},patternProperties:{type:"object",additionalProperties:{$ref:"#"},propertyNames:{format:"regex"},default:{}},dependencies:{type:"object",additionalProperties:{anyOf:[{$ref:"#"},{$ref:"#/definitions/stringArray"}]}},propertyNames:{$ref:"#"},const:!0,enum:{type:"array",items:!0,minItems:1,uniqueItems:!0},type:{anyOf:[{$ref:"#/definitions/simpleTypes"},{type:"array",items:{$ref:"#/definitions/simpleTypes"},minItems:1,uniqueItems:!0}]},format:{type:"string"},contentMediaType:{type:"string"},contentEncoding:{type:"string"},if:{$ref:"#"},then:{$ref:"#"},else:{$ref:"#"},allOf:{$ref:"#/definitions/schemaArray"},anyOf:{$ref:"#/definitions/schemaArray"},oneOf:{$ref:"#/definitions/schemaArray"},not:{$ref:"#"}},default:!0};var $n;function Ni(){return $n||($n=1,(function(o,e){Object.defineProperty(e,"__esModule",{value:!0}),e.MissingRefError=e.ValidationError=e.CodeGen=e.Name=e.nil=e.stringify=e.str=e._=e.KeywordCxt=e.Ajv=void 0;const t=Jn(),r=ki(),n=Ri(),i=xi,s=["/properties"],a="http://json-schema.org/draft-07/schema";class c extends t.default{_addVocabularies(){super._addVocabularies(),r.default.forEach(E=>this.addVocabulary(E)),this.opts.discriminator&&this.addKeyword(n.default)}_addDefaultMetaSchema(){if(super._addDefaultMetaSchema(),!this.opts.meta)return;const E=this.opts.$data?this.$dataMetaSchema(i,s):i;this.addMetaSchema(E,a,!1),this.refs["http://json-schema.org/schema"]=a}defaultMeta(){return this.opts.defaultMeta=super.defaultMeta()||(this.getSchema(a)?a:void 0)}}e.Ajv=c,o.exports=e=c,o.exports.Ajv=c,Object.defineProperty(e,"__esModule",{value:!0}),e.default=c;var u=Be();Object.defineProperty(e,"KeywordCxt",{enumerable:!0,get:function(){return u.KeywordCxt}});var d=Y();Object.defineProperty(e,"_",{enumerable:!0,get:function(){return d._}}),Object.defineProperty(e,"str",{enumerable:!0,get:function(){return d.str}}),Object.defineProperty(e,"stringify",{enumerable:!0,get:function(){return d.stringify}}),Object.defineProperty(e,"nil",{enumerable:!0,get:function(){return d.nil}}),Object.defineProperty(e,"Name",{enumerable:!0,get:function(){return d.Name}}),Object.defineProperty(e,"CodeGen",{enumerable:!0,get:function(){return d.CodeGen}});var m=Vt();Object.defineProperty(e,"ValidationError",{enumerable:!0,get:function(){return m.default}});var $=Je();Object.defineProperty(e,"MissingRefError",{enumerable:!0,get:function(){return $.default}})})(Fe,Fe.exports)),Fe.exports}var Ci=Ni();const Ii=Ce(Ci),ji={$schema:"http://json-schema.org/draft-07/schema#",title:"JMON Composition (Multi-Track, Extended)",description:"A declarative music format supporting synthesis, MIDI, score notation, key changes, arbitrary metadata, annotations, and custom presets. Time values should use the bars:beats:ticks format (e.g., '2:1:240') for precise musical timing. This format is independent of BPM and follows professional DAW standards.",type:"object",required:["format","version","bpm","sequences"],properties:JSON.parse(`{"format":{"type":"string","const":"jmonTone","description":"The format identifier for the JMON schema."},"version":{"type":"string","description":"JMON schema version."},"bpm":{"type":"number","minimum":20,"maximum":400,"description":"Tempo in beats per minute."},"keySignature":{"type":"string","pattern":"^[A-G](#|b)?m?$","description":"Key signature (e.g., 'C', 'Am', 'F#')."},"keySignatureMap":{"type":"array","description":"Map of key signature changes over time.","items":{"type":"object","required":["time","keySignature"],"properties":{"time":{"oneOf":[{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format (e.g., '2:0:0')."},{"type":"number","description":"Legacy: Time in beats (deprecated)."}],"description":"Time of the key signature change."},"keySignature":{"type":"string","pattern":"^[A-G](#|b)?m?$","description":"New key signature at this time."}},"additionalProperties":false}},"timeSignature":{"type":"string","pattern":"^\\\\d+/\\\\d+$","description":"Time signature for the composition (e.g., '4/4')."},"tempoMap":{"type":"array","description":"Map of tempo changes over time.","items":{"type":"object","required":["time","bpm"],"properties":{"time":{"oneOf":[{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format (e.g., '4:0:0')."},{"type":"number","description":"Legacy: Time in beats (deprecated)."}],"description":"The time point for the tempo change."},"bpm":{"type":"number","minimum":20,"maximum":400,"description":"Tempo in beats per minute at this time point."}},"additionalProperties":false}},"transport":{"type":"object","description":"Settings controlling global playback and looping.","properties":{"startOffset":{"oneOf":[{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format (e.g., '0:2:0')."},{"type":"number","description":"Legacy: Time in beats (deprecated)."}],"description":"Offset for when playback should start."},"globalLoop":{"type":"boolean","description":"Whether the entire project should loop."},"globalLoopEnd":{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format where the global loop should end (e.g., '8:0:0')."},"swing":{"type":"number","minimum":0,"maximum":1,"description":"Swing amount (0-1)."}},"additionalProperties":false},"metadata":{"type":"object","description":"Metadata for the composition, allowing arbitrary fields.","properties":{"name":{"type":"string","description":"Name of the composition."},"author":{"type":"string","description":"Author or composer."},"description":{"type":"string","description":"Description of the composition."}},"additionalProperties":true},"customPresets":{"type":"array","description":"Array of custom user-defined presets for synths or effects.","items":{"type":"object","required":["id","type","options"],"properties":{"id":{"type":"string","description":"Unique identifier for this preset."},"type":{"type":"string","description":"Type of preset (e.g., 'Synth', 'Effect', 'Sampler')."},"options":{"type":"object","description":"Preset options."}},"additionalProperties":false}},"audioGraph":{"type":"array","description":"Audio node graph for synthesis. If not provided, a default synth->master setup will be created automatically.","default":[{"id":"synth","type":"Synth","options":{}},{"id":"master","type":"Destination","options":{}}],"items":{"type":"object","required":["id","type","options"],"properties":{"id":{"type":"string","description":"Unique identifier for this node."},"type":{"type":"string","enum":["Synth","PolySynth","MonoSynth","AMSynth","FMSynth","DuoSynth","PluckSynth","NoiseSynth","Sampler","Filter","AutoFilter","Reverb","FeedbackDelay","PingPongDelay","Delay","Chorus","Phaser","Tremolo","Vibrato","AutoWah","Distortion","Chebyshev","BitCrusher","Compressor","Limiter","Gate","FrequencyShifter","PitchShift","JCReverb","Freeverb","StereoWidener","MidSideCompressor","Destination"],"description":"Type of audio node (Synth, Sampler, Effect, etc.)."},"options":{"type":"object","description":"Options for this node. Content varies by node type."},"target":{"type":"string","description":"Target node for audio routing."},"presetRef":{"type":"string","description":"Reference to a custom preset."}},"allOf":[{"if":{"properties":{"type":{"const":"Sampler"}}},"then":{"properties":{"options":{"type":"object","properties":{"urls":{"type":"object","description":"Sample URLs for Sampler nodes (note -> file path mapping)","patternProperties":{"^[A-G](#|b)?[0-8]$":{"type":"string","description":"File path to sample for this note"}}},"envelope":{"type":"object","description":"Automatic envelope for Samplers to smooth attack/release","properties":{"enabled":{"type":"boolean","default":true,"description":"Whether to apply automatic envelope"},"attack":{"type":"number","minimum":0,"maximum":2,"default":0.02,"description":"Attack time in seconds"},"decay":{"type":"number","minimum":0,"maximum":2,"default":0.1,"description":"Decay time in seconds"},"sustain":{"type":"number","minimum":0,"maximum":1,"default":0.8,"description":"Sustain level (0-1)"},"release":{"type":"number","minimum":0,"maximum":5,"default":0.3,"description":"Release time in seconds"}},"additionalProperties":false}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"enum":["Synth","PolySynth","MonoSynth","AMSynth","FMSynth","DuoSynth","PluckSynth","NoiseSynth"]}}},"then":{"properties":{"options":{"type":"object","properties":{"oscillator":{"type":"object","description":"Oscillator settings for synths"},"envelope":{"type":"object","description":"ADSR envelope settings for synths"},"filter":{"type":"object","description":"Filter settings for synths"}},"additionalProperties":true}}}},{"if":{"properties":{"type":{"enum":["Reverb","JCReverb","Freeverb"]}}},"then":{"properties":{"options":{"type":"object","properties":{"wet":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Wet/dry mix (0=dry, 1=wet)"},"roomSize":{"type":"number","minimum":0,"maximum":1,"default":0.7,"description":"Room size for reverb effects"},"dampening":{"type":"number","minimum":0,"maximum":1,"default":0.3,"description":"Dampening for reverb effects"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"enum":["Delay","FeedbackDelay","PingPongDelay"]}}},"then":{"properties":{"options":{"type":"object","properties":{"wet":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Wet/dry mix (0=dry, 1=wet)"},"delayTime":{"type":"string","default":"8n","description":"Delay time (note values like '8n' or seconds)"},"feedback":{"type":"number","minimum":0,"maximum":0.95,"default":0.4,"description":"Feedback amount for delay effects"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"enum":["Filter","AutoFilter"]}}},"then":{"properties":{"options":{"type":"object","properties":{"frequency":{"type":"number","minimum":20,"maximum":20000,"default":1000,"description":"Filter frequency"},"Q":{"type":"number","minimum":0.1,"maximum":50,"default":1,"description":"Filter Q/resonance"},"type":{"type":"string","enum":["lowpass","highpass","bandpass","notch"],"default":"lowpass","description":"Filter type"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"enum":["Chorus","Phaser"]}}},"then":{"properties":{"options":{"type":"object","properties":{"wet":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Wet/dry mix (0=dry, 1=wet)"},"depth":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Modulation depth"},"rate":{"type":"string","default":"4n","description":"Modulation rate (note values or Hz)"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"enum":["Compressor","Limiter","Gate"]}}},"then":{"properties":{"options":{"type":"object","properties":{"threshold":{"type":"number","minimum":-60,"maximum":0,"default":-24,"description":"Threshold in dB"},"ratio":{"type":"number","minimum":1,"maximum":20,"default":4,"description":"Compression ratio"},"attack":{"type":"number","minimum":0,"maximum":1,"default":0.003,"description":"Attack time for compressor/gate"},"release":{"type":"number","minimum":0,"maximum":1,"default":0.1,"description":"Release time for compressor/gate"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"enum":["Distortion","Chebyshev"]}}},"then":{"properties":{"options":{"type":"object","properties":{"wet":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Wet/dry mix (0=dry, 1=wet)"},"distortion":{"type":"number","minimum":0,"maximum":1,"default":0.4,"description":"Distortion amount"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"const":"BitCrusher"}}},"then":{"properties":{"options":{"type":"object","properties":{"wet":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Wet/dry mix (0=dry, 1=wet)"},"bits":{"type":"number","minimum":1,"maximum":16,"default":4,"description":"Bit depth for BitCrusher"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"const":"Tremolo"}}},"then":{"properties":{"options":{"type":"object","properties":{"wet":{"type":"number","minimum":0,"maximum":1,"default":1,"description":"Wet/dry mix (0=dry, 1=wet)"},"frequency":{"type":"number","minimum":0.1,"maximum":20,"default":4,"description":"Tremolo frequency in Hz"},"depth":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Tremolo depth"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"const":"Destination"}}},"then":{"properties":{"options":{"type":"object","properties":{},"additionalProperties":false}}}}],"additionalProperties":false}},"connections":{"type":"array","description":"Array of audio graph connections. Each is a two-element array [source, target]. If not provided, default connections will be created automatically.","default":[["synth","master"]],"items":{"type":"array","minItems":2,"maxItems":2,"items":{"type":"string"}}},"sequences":{"type":"array","description":"Musical sequences (tracks or parts).","items":{"type":"object","required":["label","notes"],"properties":{"label":{"type":"string","description":"Label for this sequence (e.g., 'lead', 'bass', etc.)."},"midiChannel":{"type":"integer","minimum":0,"maximum":15,"description":"Default MIDI channel for this sequence (0-15)."},"synth":{"type":"object","required":["type"],"properties":{"type":{"type":"string","enum":["Synth","PolySynth","MonoSynth","AMSynth","FMSynth","DuoSynth","PluckSynth","NoiseSynth","Sampler"],"description":"Type of synthesizer (Synth, Sampler, AMSynth, FMSynth, etc.)."},"options":{"type":"object","description":"Synthesizer options."},"presetRef":{"type":"string","description":"Reference to a custom preset."},"modulationTarget":{"type":"string","enum":["vibrato","tremolo","glissando","filter"],"description":"Target for modulation wheel (CC1) control. Determines how modulation wheel affects the synth."}},"additionalProperties":false,"description":"Synthesizer definition for this sequence."},"synthRef":{"type":"string","description":"Reference to an audioGraph node to use as the synth."},"notes":{"type":"array","description":"Array of note events.","items":{"type":"object","required":["pitch","time","duration"],"properties":{"pitch":{"oneOf":[{"type":"number","description":"MIDI note number (preferred)."},{"type":"string","description":"Note name (e.g., 'C4', 'G#3')."},{"type":"array","description":"Chord (array of MIDI numbers or note names).","items":{"oneOf":[{"type":"number"},{"type":"string"}]}}]},"time":{"oneOf":[{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format (e.g., '0:2:0', '1:3.5:240'). Preferred format for precise musical timing."},{"type":"string","pattern":"^(\\\\d+n|\\\\d+t)$","description":"Tone.js note values (e.g., '4n', '8t') for relative timing."},{"type":"number","description":"Legacy: Time in beats (deprecated, use bars:beats:ticks format instead)."}]},"duration":{"oneOf":[{"type":"string","pattern":"^(\\\\d+n|\\\\d+t|\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+)$","description":"Musical duration using Tone.js note values (e.g., '4n', '8n', '2t') or bars:beats:ticks format (e.g., '1:0:0')."},{"type":"number","description":"Legacy: Duration in seconds (deprecated, use note values instead)."}]},"velocity":{"type":"number","minimum":0,"maximum":1,"description":"Note velocity (0-1)."},"articulation":{"type":"string","enum":["staccato","accent","tenuto","legato","marcato"],"description":"Performance instruction that affects how a note is played (e.g., 'staccato', 'accent')."},"ornaments":{"type":"array","description":"Array of melodic ornaments to apply to this note","items":{"type":"object","required":["type"],"properties":{"type":{"type":"string","enum":["grace_note","trill","mordent","turn","arpeggio"],"description":"Type of ornament"},"parameters":{"type":"object","description":"Parameters specific to this ornament type","oneOf":[{"if":{"properties":{"type":{"const":"grace_note"}}},"then":{"properties":{"graceNoteType":{"type":"string","enum":["acciaccatura","appoggiatura"],"description":"Type of grace note"},"gracePitches":{"type":"array","items":{"oneOf":[{"type":"number","description":"MIDI note number"},{"type":"string","description":"Note name (e.g., 'C4')"}]},"description":"Optional specific pitches for the grace note(s)"}},"required":["graceNoteType"]}},{"if":{"properties":{"type":{"const":"trill"}}},"then":{"properties":{"by":{"type":"number","default":1,"description":"Interval for the trill (in scale steps)"},"trillRate":{"type":"number","default":0.125,"description":"Duration of each note in the trill"}}}},{"if":{"properties":{"type":{"const":"mordent"}}},"then":{"properties":{"by":{"type":"number","default":1,"description":"Interval for the mordent (in scale steps)"}}}},{"if":{"properties":{"type":{"const":"turn"}}},"then":{"properties":{"scale":{"type":"string","description":"Optional scale context for the turn"}}}},{"if":{"properties":{"type":{"const":"arpeggio"}}},"then":{"properties":{"arpeggioDegrees":{"type":"array","items":{"type":"number"},"description":"Scale degrees for the arpeggio"},"direction":{"type":"string","enum":["up","down","both"],"default":"up","description":"Direction of the arpeggio"}},"required":["arpeggioDegrees"]}}]}},"additionalProperties":false}},"microtuning":{"type":"number","description":"Microtuning adjustment in semitones."},"channel":{"type":"integer","minimum":0,"maximum":15,"description":"Override sequence MIDI channel for this note (0-15)."},"modulations":{"type":"array","description":"Per-note modulation events (CC, pitch bend, aftertouch).","items":{"type":"object","required":["type","value","time"],"properties":{"type":{"type":"string","enum":["cc","pitchBend","aftertouch"],"description":"Type of MIDI modulation event."},"controller":{"type":"integer","description":"MIDI CC number (required for type: 'cc')."},"value":{"type":"number","description":"Value for this modulation: 0-127 for CC, -8192 to +8192 for pitchBend (14-bit, maps to ±2 semitones), 0-127 for aftertouch."},"time":{"oneOf":[{"type":"string","pattern":"^(\\\\d+n|\\\\d+t|\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+)$","description":"Relative time using note values (e.g., '8n') or bars:beats:ticks (e.g., '0:0:240')."},{"type":"number","description":"Legacy: Relative time in seconds (deprecated)."}],"description":"When this modulation event happens (relative to note start)."}},"additionalProperties":false}}},"additionalProperties":false}},"loop":{"oneOf":[{"type":"boolean"},{"type":"string"}],"description":"Whether this sequence loops, or string for musical duration."},"loopEnd":{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format to end the loop (e.g., '4:0:0')."},"effects":{"type":"array","description":"Sequence-level effects.","items":{"type":"object","required":["type"],"properties":{"type":{"type":"string","description":"Type of effect (e.g., 'Reverb', 'Delay')."},"options":{"type":"object","description":"Options for this effect."},"presetRef":{"type":"string","description":"Reference to a custom preset."}},"additionalProperties":false}},"automation":{"type":"array","description":"Sequence-level automation channels affecting only this sequence.","items":{"$ref":"#/definitions/automationChannel"}}},"additionalProperties":false}},"automation":{"type":"object","description":"Multi-level automation system with interpolation support.","properties":{"enabled":{"type":"boolean","default":true,"description":"Whether automation is enabled globally."},"global":{"type":"array","description":"Global automation channels affecting the entire composition.","items":{"$ref":"#/definitions/automationChannel"}},"sequences":{"type":"object","description":"Sequence-level automation channels organized by sequence ID.","patternProperties":{".*":{"type":"array","description":"Automation channels for this sequence.","items":{"$ref":"#/definitions/automationChannel"}}},"additionalProperties":false},"events":{"type":"array","description":"Legacy automation events (deprecated, use channels instead).","items":{"type":"object","required":["target","time","value"],"properties":{"target":{"type":"string","description":"Parameter to automate, e.g., 'synth.frequency', 'effect.mix', 'midi.cc1'."},"time":{"oneOf":[{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format."},{"type":"number","description":"Legacy: Time in beats (deprecated)."}]},"value":{"type":"number","description":"Target value for the parameter."}},"additionalProperties":false}}},"additionalProperties":false},"annotations":{"type":"array","description":"Annotations (e.g., lyrics, rehearsal marks, comments) in the composition.","items":{"type":"object","required":["text","time"],"properties":{"text":{"type":"string","description":"Annotation text (e.g., lyric, instruction, label)."},"time":{"oneOf":[{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format (e.g., '1:2:0')."},{"type":"number","description":"Legacy: Time in beats (deprecated)."}]},"type":{"type":"string","description":"Type of annotation (e.g., 'lyric', 'marker', 'comment', 'rehearsal')."},"duration":{"oneOf":[{"type":"string","pattern":"^(\\\\d+n|\\\\d+t|\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+)$","description":"Musical duration using note values (e.g., '4n') or bars:beats:ticks (e.g., '1:0:0')."},{"type":"number","description":"Legacy: Duration in seconds (deprecated)."}],"description":"Optional duration for annotation (e.g., for lyrics or extended comments)."}},"additionalProperties":false}},"timeSignatureMap":{"type":"array","description":"Map of time signature changes over time.","items":{"type":"object","required":["time","timeSignature"],"properties":{"time":{"oneOf":[{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format (e.g., '8:0:0')."},{"type":"number","description":"Legacy: Time in beats (deprecated)."}],"description":"Time of the time signature change."},"timeSignature":{"type":"string","pattern":"^\\\\d+/\\\\d+$","description":"New time signature at this time."}},"additionalProperties":false}},"synthConfig":{"type":"object","description":"Global synthesizer configuration that applies to all sequences unless overridden.","properties":{"type":{"type":"string","enum":["Synth","PolySynth","MonoSynth","AMSynth","FMSynth","DuoSynth","PluckSynth","NoiseSynth","Sampler"],"description":"Default synthesizer type (Synth, Sampler, AMSynth, FMSynth, etc.)."},"modulationTarget":{"type":"string","enum":["vibrato","tremolo","glissando","filter"],"description":"Default target for modulation wheel (CC1) control across all sequences."},"options":{"type":"object","description":"Default synthesizer options applied globally.","properties":{"envelope":{"type":"object","description":"Automatic envelope settings for Samplers to avoid abrupt cuts","properties":{"enabled":{"type":"boolean","default":true,"description":"Whether to apply automatic envelope to Samplers"},"attack":{"type":"number","minimum":0,"maximum":2,"default":0.02,"description":"Attack time in seconds"},"decay":{"type":"number","minimum":0,"maximum":2,"default":0.1,"description":"Decay time in seconds"},"sustain":{"type":"number","minimum":0,"maximum":1,"default":0.8,"description":"Sustain level (0-1)"},"release":{"type":"number","minimum":0,"maximum":5,"default":0.3,"description":"Release time in seconds"}},"additionalProperties":false}}}},"additionalProperties":false},"converterHints":{"type":"object","description":"Optional hints to guide specific converters.","properties":{"tone":{"type":"object","description":"Hints for jmon-tone.js converter.","patternProperties":{"^cc[0-9]+$":{"type":"object","description":"Hint configuration for a MIDI CC controller mapping.","properties":{"target":{"type":"string","description":"Target for this CC mapping - can be legacy target (filter, vibrato, tremolo, glissando) or specific effect node ID from audioGraph."},"parameter":{"type":"string","description":"Parameter name to control on the target effect (e.g., 'frequency', 'depth', 'Q')."},"frequency":{"type":"number","description":"Modulation rate in Hz (for vibrato/tremolo)."},"depthRange":{"type":"array","description":"Min/max depth or frequency range for the parameter.","items":{"type":"number"},"minItems":2,"maxItems":2}},"required":["target"],"additionalProperties":false}},"additionalProperties":false},"midi":{"type":"object","description":"Hints for jmon-midi.js converter.","properties":{"channel":{"type":"integer","minimum":0,"maximum":15,"description":"Default MIDI channel for outgoing messages."},"port":{"type":"string","description":"MIDI port name or identifier."}},"additionalProperties":false}},"additionalProperties":false}}`),definitions:{automationChannel:{type:"object",description:"Automation channel with interpolation support and anchor points.",required:["id","target","anchorPoints"],properties:{id:{type:"string",description:"Unique identifier for this automation channel."},name:{type:"string",description:"Human-readable name for this automation channel."},target:{type:"string",description:"JMON target parameter (e.g., 'synth.frequency', 'midi.cc1', 'effect.mix')."},level:{type:"string",enum:["global","sequence","note"],default:"global",description:"Automation level: global (entire composition), sequence (per track), or note (per note velocity)."},sequenceId:{type:"string",description:"Target sequence ID for sequence-level automation."},range:{type:"array",items:{type:"number"},minItems:2,maxItems:2,default:[0,127],description:"Value range [min, max] for this automation parameter."},interpolation:{type:"string",enum:["linear","quadratic","cubic","daw"],default:"daw",description:"Interpolation type: linear, quadratic (curve), cubic (smoothstep), or daw (Hermite splines)."},enabled:{type:"boolean",default:!0,description:"Whether this automation channel is enabled."},anchorPoints:{type:"array",description:"Automation anchor points defining the curve.",items:{type:"object",required:["time","value"],properties:{time:{oneOf:[{type:"string",pattern:"^\\d+:\\d+(\\.\\d+)?:\\d+$",description:"Musical time in bars:beats:ticks format (e.g., '2:1:240')."},{type:"number",description:"Time in measures (e.g., 2.5 = 2 bars + 2 beats in 4/4)."}]},value:{type:"number",description:"Automation value at this time point."},tangent:{type:"number",description:"Optional tangent/slope for Hermite interpolation (DAW mode)."}},additionalProperties:!1}}},additionalProperties:!1}},additionalProperties:!1};class Bt{constructor(e=ji){this.ajv=new Ii({allErrors:!0,useDefaults:!0}),this.validate=this.ajv.compile(e)}validateAndNormalize(e){const t=JSON.parse(JSON.stringify(e)),r=this.validate(t);return{valid:r,errors:this.validate.errors||null,normalized:r?t:null}}getValidJmon(e){const{valid:t,normalized:r}=this.validateAndNormalize(e);return t?r:null}}class Oi{static fromValidatedJmon(e){const t=new Bt,{valid:r,normalized:n,errors:i}=t.validateAndNormalize(e);if(!r)throw console.warn("JMON non valide pour conversion ABC:",i),new Error("JMON non valide");return this.convertToAbc(n)}static parseTimeString(e,t){if(typeof e=="number")return e;if(typeof e!="string")return 0;try{if(jmonTone&&jmonTone._parseTimeString)return jmonTone._parseTimeString(e,t)}catch{}if(e.includes(":")){const r=e.split(":").map(parseFloat),n=r[0]||0,i=r[1]||0,s=r[2]||0,a=60/t,c=a*4,u=a/480;return n*c+i*a+s*u}if(e.match(/^\d+[nthq]$/)){const r=parseInt(e),n=e.slice(-1),i=60/t;switch(n){case"n":return i*(4/r);case"t":return i*(4/r)*(2/3);case"h":return i*2;case"q":return i;default:return i}}return parseFloat(e)||0}static convertToAbc(e){const t={...e};e.tracks&&!e.sequences&&(t.sequences=e.tracks.map(n=>({...n,notes:n.sequence||n.notes||[]})));let r="";if(r+=this.generateAbcHeader(t),t.sequences&&t.sequences.length>1){t.sequences.forEach((i,s)=>{r+=`V:${s+1} name="${i.label||`Voice ${s+1}`}"
`});const n="%%score "+t.sequences.map((i,s)=>`V:${s+1}`).join(" ");r+=n+`
`}return t.sequences&&t.sequences.length>0&&(t.sequences.length>1?r+=this.generateMultiVoiceAbc(t):r+=this.generateSingleVoiceAbc(t.sequences[0],t)),r}static generateAbcHeader(e){let t="";t+=`X:1
`;const r=e.metadata?.name||"Untitled";t+=`T:${r}
`,e.metadata?.author&&(t+=`C:${e.metadata.author}
`),e.metadata?.description&&(t+=`N:${e.metadata.description}
`),t+=`S:Generated from jmon format
`;const n=e.timeSignature||"4/4";t+=`M:${n}
`,t+=`L:1/4
`;const i=e.bpm||120;t+=`Q:1/4=${i}
`,e.tempoMap&&e.tempoMap.length>0&&(t+=`% Tempo changes:
`,e.tempoMap.forEach(a=>{t+=`% Time ${a.time}: ${a.bpm} BPM
`}));const s=e.keySignature||"C";return t+=`K:${this.convertKeySignature(s)}
`,e.keySignatureMap&&e.keySignatureMap.length>0&&(t+=`% Key changes:
`,e.keySignatureMap.forEach(a=>{t+=`% Time ${a.time}: ${this.convertKeySignature(a.keySignature)}
`})),t}static convertKeySignature(e){return{C:"C",G:"G",D:"D",A:"A",E:"E",B:"B","F#":"F#","C#":"C#",F:"F",Bb:"Bb",Eb:"Eb",Ab:"Ab",Db:"Db",Gb:"Gb",Cb:"Cb",Am:"Am",Em:"Em",Bm:"Bm","F#m":"F#m","C#m":"C#m","G#m":"G#m","D#m":"D#m","A#m":"A#m",Dm:"Dm",Gm:"Gm",Cm:"Cm",Fm:"Fm",Bbm:"Bbm",Ebm:"Ebm",Abm:"Abm"}[e]||"C"}static generateSingleVoiceAbc(e,t){let r="";return[...e.notes].sort((i,s)=>{const a=this.parseTimeString(i.time,t.bpm||120),c=this.parseTimeString(s.time,t.bpm||120);return a-c}).forEach((i,s)=>{s>0&&(r+=" "),r+=this.convertNoteToAbcSimple(i,t)}),r+=" |]",r}static convertSingleNoteToAbc(e){if(!e||typeof e!="string")return"C";const t=e.match(/^([A-Ga-g])([#b]?)(\d+)$/);if(!t)return"C";const[,r,n,i]=t,s=parseInt(i);let a=r.toUpperCase();if(n==="#"&&(a="^"+a),n==="b"&&(a="_"+a),s<=3){a=a.toUpperCase();for(let c=3;c>s;c--)a+=","}else if(s>=5){a=a.toLowerCase();for(let c=5;c<=s;c++)a+="'"}else s===4&&(a=a.toUpperCase());return a}static convertNoteToAbcSimple(e,t){let r="";if(e.articulation==="glissando"&&e.glissTarget!==void 0){const i=this.convertSingleNoteToAbc(e.pitch);let s=e.duration;return typeof e.duration=="string"&&(s=this.parseTimeString(e.duration,t.bpm||120)),r=`${i}!slide!${this.durationToAbcNotation(s,t.bpm||120)}`,r}Array.isArray(e.pitch)?(r+="[",e.pitch.forEach((i,s)=>{s>0&&(r+=""),r+=this.convertSingleNoteToAbc(i)}),r+="]"):r+=this.convertSingleNoteToAbc(e.pitch);let n=e.duration;if(typeof e.duration=="string"&&(n=this.parseTimeString(e.duration,t.bpm||120)),r+=this.durationToAbcNotation(n,t.bpm||120),e.articulation&&e.articulation!=="glissando")switch(e.articulation){case"staccato":r=`${r}!staccato!`;break;case"accent":r=`${r}!accent!`;break;case"tenuto":r=`${r}!tenuto!`;break}return r}static generateMultiVoiceAbc(e){let t="";return e.sequences.forEach((r,n)=>{t+=`V:${n+1} name="${r.label||`Voice ${n+1}`}"
`,t+=this.generateSingleVoiceAbc(r,e),t+=`
`}),t}static durationToAbcNotation(e,t){const r=e;if(Math.abs(r-4)<.1)return"4";if(Math.abs(r-2)<.1)return"2";if(Math.abs(r-1)<.1)return"";if(Math.abs(r-.5)<.1)return"/2";if(Math.abs(r-.25)<.1)return"/4";if(Math.abs(r-.125)<.1)return"/8";if(Math.abs(r-1.5)<.1)return"3/2";if(Math.abs(r-.75)<.1)return"3/4";if(Math.abs(r-3)<.1)return"3";if(Math.abs(r-2/3)<.1)return"2/3";if(Math.abs(r-1/3)<.1)return"/3";const n=Math.round(r*8);return n===8?"":`${n}/8`}static durationToAbcRest(e,t){return"z"+this.durationToAbcNotation(e,t)}static exportAbcAsFile(e,t="composition.abc"){const r=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(r),i=document.createElement("a");i.href=n,i.download=t,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n)}static convertAndDownload(e,t){try{const r=this.convertToAbc(e),n=t||`${e.metadata?.name||"composition"}.abc`;return this.exportAbcAsFile(r,n),console.log(`✅ ABC file "${n}" exported successfully`),r}catch(r){throw console.error("❌ Error converting to ABC:",r),r}}static analyzeForAbc(e){const t={voices:e.sequences?.length||0,totalNotes:0,chords:0,microtuning:0,modulations:0,tempoChanges:e.tempoMap?.length||0,keyChanges:e.keySignatureMap?.length||0,warnings:[],recommendations:[]};return e.sequences&&e.sequences.forEach((r,n)=>{t.totalNotes+=r.notes?.length||0,r.notes?.forEach(i=>{Array.isArray(i.note)&&t.chords++,i.microtuning&&t.microtuning++,i.modulations&&(t.modulations+=i.modulations.length)}),r.effects&&r.effects.length>0&&t.warnings.push(`Voice ${n+1} (${r.label}): Effects not supported in ABC notation`)}),t.microtuning>0&&t.recommendations.push("Consider using standard tuning for better ABC compatibility"),t.modulations>0&&t.recommendations.push("Modulations will be converted to ornaments - review output for accuracy"),e.audioGraph&&e.audioGraph.length>1&&t.warnings.push("Audio routing and synthesis parameters will be lost in ABC conversion"),t}static convertWithLyrics(e){const t=e;let r=this.convertToAbc(e);if(t.annotations&&Array.isArray(t.annotations)){const n=t.annotations.filter(s=>s.type==="lyric").sort((s,a)=>{const c=this.parseTimeString(s.time,t.bpm||120),u=this.parseTimeString(a.time,t.bpm||120);return c-u});n.length>0&&(r+=`
w: `,n.forEach((s,a)=>{a>0&&(r+=" "),r+=s.text}),r+=`
`);const i=t.annotations.filter(s=>s.type==="marker"||s.type==="rehearsal").sort((s,a)=>{const c=this.parseTimeString(s.time,t.bpm||120),u=this.parseTimeString(a.time,t.bpm||120);return c-u});i.length>0&&(r+=`
% Rehearsal marks and markers:
`,i.forEach(s=>{r+=`% Time ${s.time}: ${s.text}
`}))}return r}}function qi(o){return Oi.convertToAbc(o)}class Di{static VERSION="1.0";static FORMAT_IDENTIFIER="jmonTone";static async convertToAbc(e){return qi(e)}static createPlayer(e,t={}){if(console.warn("JmonTone.createPlayer is deprecated. Use createPlayer from main jmon-studio export instead."),typeof createPlayer<"u")return createPlayer(e,t);throw new Error("createPlayer not available. Import createPlayer directly from jmon-studio.")}static midiNoteToNoteName(e){if(typeof e!="number"||e<0||e>127)return console.warn(`Invalid MIDI note number: ${e}. Must be 0-127.`),"C4";const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],r=Math.floor(e/12)-1,n=e%12;return t[n]+r}static noteNameToMidiNote(e){try{const t=/^([A-Ga-g])([#b]?)(-?\d+)$/,r=e.match(t);if(!r)return console.warn(`Invalid note name: ${e}`),60;const[,n,i,s]=r,a=parseInt(s,10);let u={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[n.toUpperCase()];return i==="#"?u+=1:i==="b"&&(u-=1),Math.max(0,Math.min(127,(a+1)*12+u))}catch(t){return console.error(`Error converting note name ${e}:`,t),60}}static processPitchInput(e){return Array.isArray(e)?e.map(t=>this.processPitchInput(t)):typeof e=="number"?this.midiNoteToNoteName(e):e}static parseTimeString(e,t=120){if(typeof e=="number")return e;try{if(e.endsWith("n")){const n=parseInt(e.slice(0,-1)),i=60/t;return 4/n*i}if(e.endsWith("n.")){const n=parseInt(e.slice(0,-2)),i=60/t;return 4/n*i*1.5}if(e.endsWith("m")){const n=parseFloat(e.slice(0,-1)),i=60/t*4;return n*i}if(e.endsWith("s"))return parseFloat(e.slice(0,-1));const r=parseFloat(e);return isNaN(r)?(console.warn(`Cannot parse time string: ${e}`),0):r}catch(r){return console.error(`Error parsing time string ${e}:`,r),0}}static validateComposition(e){const t=[],r=[];return e?(e.format?e.format!==this.FORMAT_IDENTIFIER&&t.push({field:"format",message:`Invalid format: expected "${this.FORMAT_IDENTIFIER}", got "${e.format}"`,value:e.format}):t.push({field:"format",message:"Format field is required"}),e.version||r.push("Version field is recommended"),!e.tracks||!Array.isArray(e.tracks)?t.push({field:"tracks",message:"Tracks array is required"}):e.tracks.length===0?r.push("Composition has no tracks"):e.tracks.forEach((n,i)=>{(!n.sequence||!Array.isArray(n.sequence))&&t.push({field:`tracks[${i}].sequence`,message:"Track sequence array is required"})}),{valid:t.length===0,errors:t,warnings:r}):(t.push({field:"composition",message:"Composition object is required"}),{valid:!1,errors:t,warnings:r})}static createSynth(e,t={}){if(typeof window<"u"&&window.Tone){const r=window.Tone;try{switch(e){case"Synth":return new r.Synth(t);case"PolySynth":return new r.PolySynth(t);case"MonoSynth":return new r.MonoSynth(t);case"AMSynth":return new r.AMSynth(t);case"FMSynth":return new r.FMSynth(t);case"DuoSynth":return new r.DuoSynth(t);case"PluckSynth":return new r.PluckSynth(t);case"NoiseSynth":return new r.NoiseSynth(t);default:return console.warn(`Unknown synth type: ${e}, using Synth`),new r.Synth(t)}}catch(n){return console.error(`Error creating ${e}:`,n),new r.Synth}}else return console.warn("Tone.js not available. Cannot create synth."),null}static async playComposition(e,t={}){const r=this.validateComposition(e);if(!r.valid){console.error("Invalid composition:",r.errors);return}if(typeof window<"u"&&window.Tone){const n=window.Tone;n.context.state!=="running"&&await n.start(),e.tracks&&Array.isArray(e.tracks)&&e.tracks.forEach((i,s)=>{const a=this.createSynth(i.instrument?.type||"Synth",i.instrument);a&&(a.toDestination(),i.sequence?.forEach(c=>{const u=this.processPitchInput(c.pitch||"C4"),d=this.parseTimeString(c.time??0,e.bpm||120),m=this.parseTimeString(c.duration,e.bpm||120);Array.isArray(u)?u.forEach($=>{a.triggerAttackRelease($,m,`+${d}`)}):a.triggerAttackRelease(u,m,`+${d}`)}))})}else console.warn("Tone.js not available. Cannot play composition.")}}class se{static chromatic_scale=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];static flat_to_sharp={Bb:"A#",Db:"C#",Eb:"D#",Gb:"F#",Ab:"G#","B♭":"A#","D♭":"C#","E♭":"D#","G♭":"F#","A♭":"G#","B-":"A#","D-":"C#","E-":"D#","G-":"F#","A-":"G#"};static scale_intervals={major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],diminished:[0,2,3,5,6,8,9,11],"major pentatonic":[0,2,4,7,9],"minor pentatonic":[0,3,5,7,10],chromatic:[0,1,2,3,4,5,6,7,8,9,10,11],lydian:[0,2,4,6,7,9,11],mixolydian:[0,2,4,5,7,9,10],dorian:[0,2,3,5,7,9,10],phrygian:[0,1,3,5,7,8,10],locrian:[0,1,3,5,6,8,10],"harmonic minor":[0,2,3,5,7,8,11],"melodic minor ascending":[0,2,3,5,7,9,11],"melodic minor descending":[0,2,3,5,7,8,10]};static intervals={P1:0,m2:1,M2:2,m3:3,M3:4,P4:5,P5:7,m6:8,M6:9,m7:10,M7:11,P8:12};static convertFlatToSharp(e){return this.flat_to_sharp[e]||e}static noteNameToMidi(e){const t=e.match(/^([A-G][#b♭-]?)(-?\d+)$/);if(!t)throw new Error(`Invalid note name format: ${e}`);const[,r,n]=t,i=this.convertFlatToSharp(r),s=this.chromatic_scale.indexOf(i);if(s===-1)throw new Error(`Invalid note name: ${r}`);return s+(parseInt(n)+1)*12}static midiToNoteName(e,t=!1){const r=Math.floor(e/12)-1,n=e%12;return`${this.chromatic_scale[n]}${r}`}static scaleToTriad(e){return[e[0],e[2],e[4]]}}class _n{constructor(e,t="major"){const r=se.convertFlatToSharp(e);if(!se.chromatic_scale.includes(r))throw new Error(`'${e}' is not a valid tonic note. Select one among '${se.chromatic_scale.join(", ")}'.`);if(this.tonic=r,!Object.keys(se.scale_intervals).includes(t))throw new Error(`'${t}' is not a valid scale. Select one among '${Object.keys(se.scale_intervals).join(", ")}'.`);this.mode=t}generate(e={}){const t=se.scale_intervals[this.mode];if(!t)return console.warn(`Unknown scale mode: ${this.mode}`),[];typeof e.start=="string"&&(e.start=se.noteNameToMidi(e.start)),typeof e.end=="string"&&(e.end=se.noteNameToMidi(e.end));const r=e.start??60;if(se.chromatic_scale.indexOf(this.tonic)===-1)return console.warn(`Unknown tonic: ${this.tonic}`),[];const i=(a,c)=>{const u=c%t.length,d=Math.floor(c/t.length)*12,m=t[u];return a+m+d},s=[];if(e.end!==void 0)for(let a=0;;a++){const c=i(r,a);if(c>e.end)break;s.push(c)}else if(e.length)for(let a=0;a<e.length;a++)s.push(i(r,a));else return t.map(a=>r+a);return s}getNoteNames(){const e=se.scale_intervals[this.mode];if(!e)return[];const t=se.chromatic_scale.indexOf(this.tonic);return t===-1?[]:e.map(r=>{const n=(t+r)%12;return se.chromatic_scale[n]})}isInScale(e){const t=e%12;return this.generate().map(n=>n%12).includes(t)}}function Vi(o){if(typeof o=="object"&&!Array.isArray(o))return o;if(Array.isArray(o)){if(o.length===0)return{};if(o.every(t=>Array.isArray(t)&&t.length===3))return{"track 1":o};const e={};return o.forEach((t,r)=>{e[`track ${r+1}`]=t}),e}throw new Error("Input must be a list or dict of tracks.")}function Pn(o,e){return e.reduce((t,r)=>Math.abs(r-o)<Math.abs(t-o)?r:t)}function Sn(o){return Math.floor(o/12)-1}function Fi(o){return{"D-":"C#","E-":"D#","G-":"F#","A-":"G#","B-":"A#",Db:"C#",Eb:"D#",Gb:"F#",Ab:"G#",Bb:"A#"}[o]||o}function Ht(o,e,t){typeof o=="string"&&(o=qe(o)),typeof t=="string"&&(t=qe(t));const r=e.indexOf(t);if(e.includes(o))return e.indexOf(o)-r;{const n=Pn(o,e),i=e.indexOf(n),s=i>0?i-1:i,a=e[s],c=n-o,u=o-a,d=c+u;if(d===0)return i-r;const m=1-c/d,$=1-u/d,_=i-r,E=s-r;return _*m+E*$}}function zi(o,e,t){const r=e.indexOf(t),n=Math.round(r+o);if(n>=0&&n<e.length)return e[n];{const i=Math.max(0,Math.min(n,e.length-1)),s=Math.min(e.length-1,Math.max(n,0)),a=e[i],c=e[s],u=s-n,d=n-i,m=u+d;if(m===0)return(c+a)/2;const $=1-u/m,_=1-d/m;return c*$+a*_}}function En(o){o.length>0&&o[0].length===2&&(o=o.map(r=>[r[0],r[1],0]));const e=[];let t=0;for(const[r,n,i]of o)e.push([r,n,t]),t+=n;return e}function Tn(o,e=0){const t=[...o].sort((i,s)=>i[2]-s[2]);let r=0;const n=[];for(const i of t){const[s,a,c]=i,u=e+c;if(u>r){const m=[null,u-r,r-e];n.push(m)}n.push(i),r=Math.max(r,u+a)}return n}function Mn(o){o.sort((e,t)=>e[2]-t[2]);for(let e=0;e<o.length-1;e++){const t=o[e],r=o[e+1];if(t[2]+t[1]>r[2]){const i=r[2]-t[2];o[e]=[t[0],i,t[2]]}}return o}function Li(o){return Mn(Tn(o))}function qe(o){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],t={Db:"C#",Eb:"D#",Gb:"F#",Ab:"G#",Bb:"A#",Cb:"B"};let r=4,n=o;if(o.includes("b")){const a=o.slice(0,-1);t[a]&&(n=t[a]+o.slice(-1))}let i;return n.length>2||n.length===2&&!isNaN(n[1])?(i=n.slice(0,-1),r=parseInt(n.slice(-1))):i=n[0],12*(r+1)+e.indexOf(i)}function Ui(o){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],t=Math.floor(o/12)-1,r=o%12;return e[r]+t.toString()}function Gi(o,e="offsets"){const t=[];let r=0;for(const[n,i,s]of o)t.push([n,i,r]),r+=i;return t}function Ki(o){return o.every(e=>Array.isArray(e))?"list of tuples":o.every(e=>!Array.isArray(e))?"list":"unknown"}function Bi(o,e,t,r=null,n=null){const i=r!==null?r:Math.min(...o),s=n!==null?n:Math.max(...o);return i===s?new Array(o.length).fill((e+t)/2):o.map(a=>(a-i)*(t-e)/(s-i)+e)}function kn(o,e){return o.map(([t,r,n])=>[t,r,n+e])}function Hi(o,e,t){const r=[];for(const[n,i,s]of o){const a=Math.round(s/t)*t,c=(Math.floor(a/e)+1)*e;let u=Math.round(i/t)*t;u=Math.min(u,c-a),u>0&&r.push([n,u,a])}return r}function Wi(o,e){const r=o.filter(([a,,c])=>a!==null&&c!==null).sort((a,c)=>a[2]-c[2]),n=Math.max(...r.map(([,,a])=>a)),i=Math.floor(n/e)+1,s=[];for(let a=0;a<i;a++){const c=a*e;let u=null,d=1/0;for(const[m,,$]of r){const _=c-$;if(_>=0&&_<d&&(d=_,u=m),$>c)break}u!==null&&s.push(u)}return s}function Ji(o,e){return e.reduce((t,r)=>Math.abs(r-o)<Math.abs(t-o)?r:t)}function Yi(o,e){return 60/e*o}function*Xi(o=0,e=1,t=0,r=1){for(;;)yield t+r*o,[o,e]=[e,o+e]}function Qi(o,e,t){const r={};for(const[n,i]of Object.entries(o)){const s=[];for(let a=0;a<e;a++){const c=a*t,u=kn(i,c);s.push(...u)}r[n]=s}return r}const Zi=Object.freeze(Object.defineProperty({__proto__:null,adjustNoteDurationsToPreventOverlaps:Mn,cdeToMidi:qe,checkInput:Ki,fibonacci:Xi,fillGapsWithRests:Tn,findClosestPitchAtMeasureStart:Wi,getDegreeFromPitch:Ht,getOctave:Sn,getPitchFromDegree:zi,getSharp:Fi,instrumentMapping:{"Acoustic Grand Piano":0,"Bright Acoustic Piano":1,"Electric Grand Piano":2,"Honky-tonk Piano":3,"Electric Piano 1":4,"Electric Piano 2":5,Harpsichord:6,Clavinet:7,Gunshot:127},midiToCde:Ui,noOverlap:Gi,offsetTrack:kn,qlToSeconds:Yi,quantizeNotes:Hi,repairNotes:Li,repeatPolyloops:Qi,roundToList:Pn,scaleList:Bi,setOffsetsAccordingToDurations:En,tracksToDict:Vi,tune:Ji},Symbol.toStringTag,{value:"Module"}));class es extends se{constructor(e="C4",t="P5",r="chords",n=[3,3,1],i=null){if(super(),this.tonicMidi=qe(e),this.circleOf=t,this.type=r,this.radius=n,this.weights=i||n,!Object.keys(this.intervals).includes(this.circleOf))throw new Error(`Select a circleOf among ${Object.keys(this.intervals).join(", ")}.`);if(!["chords","pitches"].includes(this.type))throw new Error("Type must either be 'pitches' or 'chords'.")}computeCircle(){const e=this.intervals[this.circleOf],t=[this.tonicMidi];for(let r=0;r<Math.max(...this.radius);r++){const n=(t[t.length-1]+e)%12+Math.floor(t[t.length-1]/12)*12;t.push(n)}return{major:t.slice(0,this.radius[0]),minor:t.slice(0,this.radius[1]),diminished:t.slice(0,this.radius[2])}}generateChord(e,t){return({major:[0,4,7],minor:[0,3,7],diminished:[0,3,6]}[t]||[0,4,7]).map(s=>e+s).map(s=>s>127?s-12:s)}generate(e=4,t=null){t!==null&&(Math.seedrandom=t);const{major:r,minor:n,diminished:i}=this.computeCircle(),s=[r,n,i],a=["major","minor","diminished"],c=[];for(let u=0;u<e;u++){const d=this.weightedRandomChoice(this.weights);if(s[d].length>0){const m=s[d][Math.floor(Math.random()*s[d].length)],$=a[d],_=Array.isArray(m)?m[0]:m,E=this.generateChord(_,$);c.push(E)}}return c}weightedRandomChoice(e){const t=e.reduce((n,i)=>n+i,0);let r=Math.random()*t;for(let n=0;n<e.length;n++)if(r-=e[n],r<=0)return n;return e.length-1}}class ts extends se{constructor(e="major",t="C",r=[0,2,4]){super(),this.tonic=t,this.scale=new _n(t,e).generate(),this.degrees=r}pitchToChord(e){const t=Sn(e),r=this.tonic+t.toString(),n=qe(r),i=this.scale.map(c=>Ht(c,this.scale,n)),s=Math.round(Ht(e,this.scale,n)),a=[];for(const c of this.degrees){const u=s+c,d=i.indexOf(u);d!==-1&&a.push(this.scale[d])}return a}generate(e,t=null,r=!1){if(!Array.isArray(e)||e.length===0)return[];let n=e;if(typeof e[0]=="number"){t===null&&(t=[1]);let s=0,a=0;n=e.map(c=>{const u=t[s%t.length],d=[c,u,a];return a+=u,s++,d})}const i=n.map(([s,a,c])=>[this.pitchToChord(s),a,c]);if(r){const s=[];for(const[a,c,u]of i){const d=c/a.length;a.forEach((m,$)=>{s.push([m,d,u+$*d])})}return s}else return i}}const An={grace_note:{requiredParams:["graceNoteType"],optionalParams:["gracePitches"],conflicts:[],description:"Single note before the main note",defaultParams:{graceNoteType:"acciaccatura"},validate:(o,e)=>["acciaccatura","appoggiatura"].includes(e.graceNoteType)?e.gracePitches&&!Array.isArray(e.gracePitches)?{valid:!1,error:"gracePitches must be an array of pitches"}:{valid:!0}:{valid:!1,error:"graceNoteType must be either acciaccatura or appoggiatura"}},trill:{requiredParams:[],optionalParams:["by","trillRate"],conflicts:["mordent"],minDuration:"8n",description:"Rapid alternation between main note and auxiliary note",defaultParams:{by:1,trillRate:.125},validate:(o,e)=>e.by&&typeof e.by!="number"?{valid:!1,error:"trill step (by) must be a number"}:e.trillRate&&typeof e.trillRate!="number"?{valid:!1,error:"trillRate must be a number"}:{valid:!0}},mordent:{requiredParams:[],optionalParams:["by"],conflicts:["trill"],description:"Quick alternation with note above or below",defaultParams:{by:1},validate:(o,e)=>e.by&&typeof e.by!="number"?{valid:!1,error:"mordent step (by) must be a number"}:{valid:!0}},turn:{requiredParams:[],optionalParams:["scale"],conflicts:[],description:"Melodic turn around the main note",validate:(o,e)=>e.scale&&typeof e.scale!="string"?{valid:!1,error:"scale must be a string"}:{valid:!0}},arpeggio:{requiredParams:["arpeggioDegrees"],optionalParams:["direction"],conflicts:[],description:"Notes played in sequence",defaultParams:{direction:"up"},validate:(o,e)=>Array.isArray(e.arpeggioDegrees)?e.direction&&!["up","down","both"].includes(e.direction)?{valid:!1,error:"direction must be up, down, or both"}:{valid:!0}:{valid:!1,error:"arpeggioDegrees must be an array"}}};class Wt{static validateOrnament(e,t,r={}){const n={valid:!1,warnings:[],errors:[]},i=An[t];if(!i)return n.errors.push(`Unknown ornament type: ${t}`),n;if(i.requiredParams){for(const s of i.requiredParams)if(!(s in r))return n.errors.push(`Missing required parameter '${s}' for ${t}`),n}if(i.minDuration&&n.warnings.push(`Duration check not implemented for ${t}`),e.ornaments&&i.conflicts){const s=e.ornaments.filter(a=>i.conflicts.includes(a.type)).map(a=>a.type);if(s.length>0)return n.errors.push(`${t} conflicts with existing ornaments: ${s.join(", ")}`),n}if(i.validate){const s=i.validate(e,r);if(!s.valid)return n.errors.push(s.error),n}return n.valid=!0,n}constructor(e){const t=An[e.type];if(!t)throw new Error(`Unknown ornament type: ${e.type}`);this.type=e.type,this.params={...t.defaultParams,...e.parameters},e.tonic&&e.mode?(this.tonicIndex=se.chromatic_scale.indexOf(e.tonic),this.scale=this.generateScale(e.tonic,e.mode)):this.scale=null}generateScale(e,t){const r=se.scale_intervals[t],n=se.chromatic_scale.indexOf(e),i=r.map(a=>(n+a)%12),s=[];for(let a=-1;a<10;a++)for(const c of i){const u=12*a+c;u>=0&&u<=127&&s.push(u)}return s}apply(e,t=null){if(!Array.isArray(e)||e.length===0||(t===null&&(t=Math.floor(Math.random()*e.length)),t<0||t>=e.length))return e;const r=e[t],n=Wt.validateOrnament(r,this.type,this.params);if(!n.valid)return console.warn(`Ornament validation failed: ${n.errors.join(", ")}`),e;switch(this.type){case"grace_note":return this.addGraceNote(e,t);case"trill":return this.addTrill(e,t);case"mordent":return this.addMordent(e,t);case"turn":return this.addTurn(e,t);case"arpeggio":return this.addArpeggio(e,t);default:return e}}addGraceNote(e,t){const[r,n,i]=e[t],s=this.params.gracePitches?this.params.gracePitches[Math.floor(Math.random()*this.params.gracePitches.length)]:r+1;if(this.params.graceNoteType==="acciaccatura"){const a=n*.125,c=[r,n,i+a];return[...e.slice(0,t),[s,a,i],c,...e.slice(t+1)]}else{const a=n/2,c=[r,a,i+a];return[...e.slice(0,t),[s,a,i],c,...e.slice(t+1)]}}addTrill(e,t){const[r,n,i]=e[t],s=[];let a=i;const c=this.params.by||1,u=this.params.trillRate||.125;let d;if(this.scale&&this.scale.includes(r)){const $=(this.scale.indexOf(r)+Math.round(c))%this.scale.length;d=this.scale[$]}else d=r+c;for(;a<i+n;){const m=i+n-a,$=Math.min(u,m/2);if(m>=$*2)s.push([r,$,a]),s.push([d,$,a+$]),a+=2*$;else break}return[...e.slice(0,t),...s,...e.slice(t+1)]}addMordent(e,t){const[r,n,i]=e[t],s=this.params.by||1;let a;if(this.scale&&this.scale.includes(r)){const m=this.scale.indexOf(r)+Math.round(s);a=this.scale[m]||r+s}else a=r+s;const c=n/3,u=[[r,c,i],[a,c,i+c],[r,c,i+2*c]];return[...e.slice(0,t),...u,...e.slice(t+1)]}addTurn(e,t){const[r,n,i]=e[t],s=n/4;let a,c;if(this.scale&&this.scale.includes(r)){const d=this.scale.indexOf(r);a=this.scale[d+1]||r+2,c=this.scale[d-1]||r-2}else a=r+2,c=r-2;const u=[[r,s,i],[a,s,i+s],[r,s,i+2*s],[c,s,i+3*s]];return[...e.slice(0,t),...u,...e.slice(t+1)]}addArpeggio(e,t){const[r,n,i]=e[t],{arpeggioDegrees:s,direction:a="up"}=this.params;if(!s||!Array.isArray(s))return e;const c=[];if(this.scale&&this.scale.includes(r)){const m=this.scale.indexOf(r);c.push(...s.map($=>this.scale[m+$]||r+$))}else c.push(...s.map(m=>r+m));a==="down"&&c.reverse(),a==="both"&&c.push(...c.slice(0,-1).reverse());const u=n/c.length,d=c.map((m,$)=>[m,u,i+$*u]);return[...e.slice(0,t),...d,...e.slice(t+1)]}}const Jt={staccato:{complex:!1,description:"Shortens note duration to ~50%"},accent:{complex:!1,description:"Increases note velocity/emphasis"},tenuto:{complex:!1,description:"Holds note for full duration with emphasis"},legato:{complex:!1,description:"Smooth connection between notes"},marcato:{complex:!1,description:"Strong accent with slight separation"},glissando:{complex:!0,requiredParams:["target"],description:"Smooth slide from note to target pitch"},portamento:{complex:!0,requiredParams:["target"],optionalParams:["curve","speed"],description:"Expressive slide between pitches"},bend:{complex:!0,requiredParams:["amount"],optionalParams:["curve","returnToOriginal"],description:"Pitch bend up or down in cents"},vibrato:{complex:!0,optionalParams:["rate","depth","delay"],description:"Periodic pitch variation"},tremolo:{complex:!0,optionalParams:["rate","depth"],description:"Rapid volume variation"},crescendo:{complex:!0,requiredParams:["endVelocity"],optionalParams:["curve"],description:"Gradual volume increase"},diminuendo:{complex:!0,requiredParams:["endVelocity"],optionalParams:["curve"],description:"Gradual volume decrease"}};class Rt{static addArticulation(e,t,r,n={}){const i={success:!1,warnings:[],errors:[]};if(!Array.isArray(e))return i.errors.push("Sequence must be an array"),i;if(r<0||r>=e.length)return i.errors.push(`Note index ${r} out of bounds (sequence length: ${e.length})`),i;const s=Jt[t];if(!s)return i.errors.push(`Unknown articulation type: ${t}`),i;const a=e[r];return!a||typeof a!="object"?(i.errors.push(`Invalid note at index ${r}`),i):s.complex?this._addComplexArticulation(a,t,s,n,i):(a.articulation=t,i.success=!0,i)}static _addComplexArticulation(e,t,r,n,i){if(r.requiredParams){for(const s of r.requiredParams)if(!(s in n))return i.errors.push(`Missing required parameter '${s}' for ${t}`),i}switch(t){case"glissando":case"portamento":return this._applyGlissando(e,t,n,i);case"bend":return this._applyBend(e,n,i);case"vibrato":return this._applyVibrato(e,n,i);case"tremolo":return this._applyTremolo(e,n,i);case"crescendo":case"diminuendo":return this._applyDynamicChange(e,t,n,i);default:return i.errors.push(`Complex articulation ${t} not implemented`),i}}static _applyGlissando(e,t,r,n){e.articulation=t,e.glissTarget=r.target,e.modulations||(e.modulations=[]);const i={type:"pitch",subtype:t,target:r.target,curve:r.curve||"linear",timing:"note_duration"};return r.speed!==void 0&&(i.speed=r.speed),e.modulations=e.modulations.filter(s=>!(s.type==="pitch"&&s.subtype===t)),e.modulations.push(i),n.success=!0,n.warnings.push(`Added ${t} modulation synchronized with articulation`),n}static _applyBend(e,t,r){e.articulation="bend",e.modulations||(e.modulations=[]);const n={type:"pitch",subtype:"bend",amount:t.amount,curve:t.curve||"linear",timing:t.returnToOriginal?"note_duration":"sustain",returnToOriginal:t.returnToOriginal??!0};return e.modulations=e.modulations.filter(i=>!(i.type==="pitch"&&i.subtype==="bend")),e.modulations.push(n),r.success=!0,r.warnings.push("Added pitch bend modulation synchronized with articulation"),r}static _applyVibrato(e,t,r){e.articulation="vibrato",e.modulations||(e.modulations=[]);const n={type:"pitch",subtype:"vibrato",rate:t.rate||5,depth:t.depth||50,delay:t.delay||0,timing:"note_duration"};return e.modulations=e.modulations.filter(i=>!(i.type==="pitch"&&i.subtype==="vibrato")),e.modulations.push(n),r.success=!0,r.warnings.push("Added vibrato modulation synchronized with articulation"),r}static _applyTremolo(e,t,r){e.articulation="tremolo",e.modulations||(e.modulations=[]);const n={type:"amplitude",subtype:"tremolo",rate:t.rate||8,depth:t.depth||.3,timing:"note_duration"};return e.modulations=e.modulations.filter(i=>!(i.type==="amplitude"&&i.subtype==="tremolo")),e.modulations.push(n),r.success=!0,r.warnings.push("Added tremolo modulation synchronized with articulation"),r}static _applyDynamicChange(e,t,r,n){e.articulation=t,e.modulations||(e.modulations=[]);const i={type:"amplitude",subtype:t,startVelocity:e.velocity||.8,endVelocity:r.endVelocity,curve:r.curve||"linear",timing:"note_duration"};return e.modulations=e.modulations.filter(s=>!(s.type==="amplitude"&&(s.subtype==="crescendo"||s.subtype==="diminuendo"))),e.modulations.push(i),n.success=!0,n.warnings.push(`Added ${t} modulation synchronized with articulation`),n}static removeArticulation(e,t){if(!Array.isArray(e)||t<0||t>=e.length)return{success:!1,error:"Invalid sequence or note index"};const r=e[t];if(!r||typeof r!="object")return{success:!1,error:"Invalid note"};const n=r.articulation;if(delete r.articulation,delete r.glissTarget,r.modulations&&n){const i=Jt[n];i&&i.complex&&(r.modulations=r.modulations.filter(s=>s.subtype!==n),r.modulations.length===0&&delete r.modulations)}return{success:!0,removed:n,message:`Removed ${n} articulation and related modulations`}}static validateSequence(e){const t=[];return e.forEach((r,n)=>{if(r.articulation){const i=this.ARTICULATION_TYPES[r.articulation];if(!i){t.push({type:"unknown_articulation",noteIndex:n,articulation:r.articulation,message:`Unknown articulation type: ${r.articulation}`});return}r.articulation==="glissando"&&!r.glissTarget&&t.push({type:"missing_parameter",noteIndex:n,articulation:r.articulation,message:"Glissando missing glissTarget parameter"}),i.complex&&r.modulations&&(r.modulations.some(a=>a.subtype===r.articulation)||t.push({type:"modulation_sync",noteIndex:n,articulation:r.articulation,message:`Complex articulation ${r.articulation} should have corresponding modulation`}))}}),{valid:t.length===0,issues:t}}static getAvailableTypes(){return Object.entries(Jt).map(([e,t])=>({type:e,complex:t.complex,description:t.description,requiredParams:t.requiredParams||[],optionalParams:t.optionalParams||[]}))}}function Rn(o,e,t,r){return Rt.addArticulation(o,e,t,r)}function xn(o,e){return Rt.removeArticulation(o,e)}function rs(o){return Rt.validateSequence(o)}const ns={Scale:_n,Progression:es,Voice:ts,Ornament:Wt,Articulation:Rt,addArticulation:Rn,addOrnament:Rn,removeArticulation:xn,removeOrnament:xn,validateArticulations:rs};class is{constructor(e,t){this.measureLength=e,this.durations=t}random(e=null,t=0,r=100){e!==null&&(Math.seedrandom=e);const n=[];let i=0,s=0;for(;i<this.measureLength&&s<r;){const a=this.durations[Math.floor(Math.random()*this.durations.length)];if(i+a>this.measureLength){s++;continue}if(Math.random()<t){s++;continue}n.push([a,i]),i+=a,s++}return s>=r&&console.warn("Max iterations reached. The sum of the durations may not equal the measure length."),n}darwin(e=null,t=10,r=50,n=.1){return new ss(e,t,this.measureLength,r,n,this.durations).generate()}}class ss{constructor(e,t,r,n,i,s){e!==null&&(Math.seedrandom=e),this.populationSize=t,this.measureLength=r,this.maxGenerations=n,this.mutationRate=i,this.durations=s,this.population=this.initializePopulation()}initializePopulation(){const e=[];for(let t=0;t<this.populationSize;t++)e.push(this.createRandomRhythm());return e}createRandomRhythm(){const e=[];let t=0;for(;t<this.measureLength;){const r=this.measureLength-t,n=this.durations[Math.floor(Math.random()*this.durations.length)];if(n<=r)e.push([n,t]),t+=n;else break}return e}evaluateFitness(e){const t=e.reduce((r,n)=>r+n[0],0);return Math.abs(this.measureLength-t)}selectParent(){const e=this.population[Math.floor(Math.random()*this.population.length)],t=this.population[Math.floor(Math.random()*this.population.length)];return this.evaluateFitness(e)<this.evaluateFitness(t)?e:t}crossover(e,t){if(e.length===0||t.length===0)return e.length>0?[...e]:[...t];const r=Math.floor(Math.random()*(e.length-1))+1,n=[...e.slice(0,r),...t.slice(r)];return this.ensureMeasureLength(n)}ensureMeasureLength(e){return e.reduce((r,n)=>r+n[0],0)>this.measureLength&&e.length>0&&e.pop(),e}mutate(e){if(Math.random()<this.mutationRate&&e.length>1){const t=Math.floor(Math.random()*(e.length-1)),[r,n]=e[t],s=(t===e.length-1?this.measureLength:e[t+1][1])-n,a=this.durations.filter(c=>c<=s);if(a.length>0){const c=a[Math.floor(Math.random()*a.length)];e[t]=[c,n]}}return e}generate(){for(let t=0;t<this.maxGenerations;t++){const r=[];for(let n=0;n<this.populationSize;n++){const i=this.selectParent(),s=this.selectParent();let a=this.crossover(i,s);a=this.mutate(a),a.sort((c,u)=>c[1]-u[1]),r.push(a)}this.population=r}return this.population.reduce((t,r)=>this.evaluateFitness(r)<this.evaluateFitness(t)?r:t).sort((t,r)=>t[1]-r[1])}}function os(o,e){const t=o.map(a=>Array.isArray(a)||typeof a=="object"&&a.length?a[0]:a),r=as(t.length,e.length),n=[],i=[];for(let a=0;a<r;a++)n.push(t[a%t.length]),i.push(e[a%e.length]);const s=n.map((a,c)=>[a,i[c],1]);return En(s)}function as(o,e){const t=(r,n)=>n===0?r:t(n,r%n);return Math.abs(o*e)/t(o,e)}function cs(o,e){const t=[];let r=0,n=0;for(const i of o){const s=e[n%e.length];t.push([i,s,r]),r+=s,n++}return t}const ls={Rhythm:is,isorhythm:os,beatcycle:cs};class us{constructor(){}}class $e{data;constructor(e,t){if(typeof e=="number"){if(t===void 0)throw new Error("Columns parameter required when creating matrix from dimensions");this.rows=e,this.columns=t,this.data=Array(this.rows).fill(0).map(()=>Array(this.columns).fill(0))}else this.data=e.map(r=>[...r]),this.rows=this.data.length,this.columns=this.data[0]?.length||0}static zeros(e,t){return new $e(e,t)}static from2DArray(e){return new $e(e)}get(e,t){if(e<0||e>=this.rows||t<0||t>=this.columns)throw new Error(`Index out of bounds: (${e}, ${t})`);return this.data[e][t]}set(e,t,r){if(e<0||e>=this.rows||t<0||t>=this.columns)throw new Error(`Index out of bounds: (${e}, ${t})`);this.data[e][t]=r}getRow(e){if(e<0||e>=this.rows)throw new Error(`Row index out of bounds: ${e}`);return[...this.data[e]]}getColumn(e){if(e<0||e>=this.columns)throw new Error(`Column index out of bounds: ${e}`);return this.data.map(t=>t[e])}transpose(){const e=Array(this.columns).fill(0).map(()=>Array(this.rows).fill(0));for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)e[r][t]=this.data[t][r];return new $e(e)}clone(){return new $e(this.data)}toArray(){return this.data.map(e=>[...e])}}function Yt(o){return Array.isArray(o[0])?$e.from2DArray(o):$e.from2DArray([o])}function ds(o){if(o.rows!==o.columns)throw new Error("Matrix must be square for Cholesky decomposition");const e=o.rows,t=$e.zeros(e,e);for(let r=0;r<e;r++)for(let n=0;n<=r;n++)if(r===n){let i=0;for(let a=0;a<n;a++)i+=t.get(n,a)*t.get(n,a);const s=o.get(n,n)-i;if(s<=0)throw new Error(`Matrix is not positive definite at position (${n}, ${n})`);t.set(n,n,Math.sqrt(s))}else{let i=0;for(let s=0;s<n;s++)i+=t.get(r,s)*t.get(n,s);t.set(r,n,(o.get(r,n)-i)/t.get(n,n))}return t}class hs{kernel;alpha;XTrain;yTrain;L;alphaVector;constructor(e,t={}){this.kernel=e,this.alpha=t.alpha||1e-10}fit(e,t){this.XTrain=Yt(e),this.yTrain=[...t];const r=this.kernel.call(this.XTrain);for(let n=0;n<r.rows;n++)r.set(n,n,r.get(n,n)+this.alpha);try{this.L=ds(r)}catch(n){throw new Error(`Failed to compute Cholesky decomposition: ${n instanceof Error?n.message:"Unknown error"}`)}this.alphaVector=this.solveCholesky(this.L,this.yTrain)}predict(e,t=!1){if(!this.XTrain||!this.yTrain||!this.L||!this.alphaVector)throw new Error("Model must be fitted before prediction");const r=Yt(e),n=this.kernel.call(this.XTrain,r),i=new Array(r.rows);for(let a=0;a<r.rows;a++){i[a]=0;for(let c=0;c<this.XTrain.rows;c++)i[a]+=n.get(c,a)*this.alphaVector[c]}const s={mean:i};if(t){const a=this.computeStd(r,n);s.std=a}return s}sampleY(e,t=1){if(!this.XTrain||!this.yTrain||!this.L||!this.alphaVector)throw new Error("Model must be fitted before sampling");const r=Yt(e),n=this.predict(e,!0);if(!n.std)throw new Error("Standard deviation computation failed");const i=[];for(let s=0;s<t;s++){const a=new Array(r.rows);for(let c=0;c<r.rows;c++){const u=n.mean[c],d=n.std[c];a[c]=u+d*this.sampleStandardNormal()}i.push(a)}return i}logMarginalLikelihood(){if(!this.XTrain||!this.yTrain||!this.L||!this.alphaVector)throw new Error("Model must be fitted before computing log marginal likelihood");let e=0;for(let t=0;t<this.yTrain.length;t++)e-=.5*this.yTrain[t]*this.alphaVector[t];for(let t=0;t<this.L.rows;t++)e-=Math.log(this.L.get(t,t));return e-=.5*this.yTrain.length*Math.log(2*Math.PI),e}computeStd(e,t){if(!this.L)throw new Error("Cholesky decomposition not available");const r=new Array(e.rows);for(let n=0;n<e.rows;n++){const i=this.kernel.compute(e.getRow(n),e.getRow(n)),s=t.getColumn(n),a=this.forwardSubstitution(this.L,s);let c=0;for(let d=0;d<a.length;d++)c+=a[d]*a[d];const u=i-c;r[n]=Math.sqrt(Math.max(0,u))}return r}solveCholesky(e,t){const r=this.forwardSubstitution(e,t);return this.backSubstitution(e,r)}forwardSubstitution(e,t){const r=e.rows,n=new Array(r);for(let i=0;i<r;i++){n[i]=t[i];for(let s=0;s<i;s++)n[i]-=e.get(i,s)*n[s];n[i]/=e.get(i,i)}return n}backSubstitution(e,t){const r=e.rows,n=new Array(r);for(let i=r-1;i>=0;i--){n[i]=t[i];for(let s=i+1;s<r;s++)n[i]-=e.get(s,i)*n[s];n[i]/=e.get(i,i)}return n}sampleStandardNormal(){const e=Math.random(),t=Math.random();return Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*t)}}class fs{constructor(e={}){this.width=e.width||51,this.ruleNumber=e.ruleNumber||30,this.initialState=e.initialState||this.generateRandomInitialState(),this.state=[...this.initialState],this.rules=this.loadRules(this.ruleNumber),this.history=[]}generate(e){this.history=[],this.state=[...this.initialState],this.history.push([...this.state]);for(let t=0;t<e;t++)this.updateState(),this.history.push([...this.state]);return this.history}generate01(e){return this.generate(e).map(r=>r.map(n=>n>0?1:0))}loadRules(e){const t=e.toString(2).padStart(8,"0"),r={},n=["111","110","101","100","011","010","001","000"];for(let i=0;i<8;i++)r[n[i]]=parseInt(t[i],10);return r}updateState(){const e=new Array(this.width);for(let t=0;t<this.width;t++){const r=this.state[(t-1+this.width)%this.width],n=this.state[t],i=this.state[(t+1)%this.width],s=`${r}${n}${i}`;e[t]=this.rules[s]||0}this.state=e}validateStrips(e){if(!Array.isArray(e)||e.length===0)return!1;const t=e[0]?.length;return t?e.every(r=>Array.isArray(r)&&r.length===t&&r.every(n=>typeof n=="number"&&(n===0||n===1))):!1}validateValues(e){return Array.isArray(e)&&e.length===this.width&&e.every(t=>typeof t=="number"&&(t===0||t===1))}setInitialState(e){if(this.validateValues(e))this.initialState=[...e],this.state=[...e];else throw new Error("Invalid initial state")}setRuleNumber(e){if(e>=0&&e<=255)this.ruleNumber=e,this.rules=this.loadRules(e);else throw new Error("Rule number must be between 0 and 255")}getHistory(){return this.history.map(e=>[...e])}getCurrentState(){return[...this.state]}generateRandomInitialState(){const e=new Array(this.width).fill(0);return e[Math.floor(this.width/2)]=1,e}generateRandomState(){return Array.from({length:this.width},()=>Math.random()>.5?1:0)}plot(){return{data:this.getHistory(),width:this.width,height:this.history.length}}async plotEvolution(e){return(await Promise.resolve().then(()=>Qt)).CAVisualizer.plotEvolution(this.getHistory(),e)}async plotGeneration(e){return(await Promise.resolve().then(()=>Qt)).CAVisualizer.plotGeneration(this.getCurrentState(),e)}async plotDensity(e){return(await Promise.resolve().then(()=>Qt)).CAVisualizer.plotDensity(this.getHistory(),e)}}class Nn{static midiToNoteName(e){return`MIDI_${e}`}static timeToMusicalTime(e){return`${e}`}}class ps{config;currentTime=0;rotationAngles=new Map;constructor(e){this.config=e,this.config.layers.forEach(t=>{this.rotationAngles.set(t.label,0)})}static fromRhythm(e,t=[60],r={}){const{instrument:n="synth",color:i="steelblue",label:s="Polyloop",speed:a=1,radius:c=.8}=r,u=e.reduce(($,_)=>$+_,0),d=[];let m=0;return e.forEach(($,_)=>{const E=$/u*360;d.push({angle:m,radius:c,active:$>0,pitch:$>0?t[_%t.length]:void 0,velocity:.8,instrument:n}),m+=E}),{points:d,color:i,label:s,instrument:n,divisions:e.length,speed:a}}static euclidean(e,t,r=[60],n={}){const{instrument:i="synth",color:s="steelblue",label:a=`Euclidean ${t}/${e}`,speed:c=1,radius:u=.8}=n,d=this.generateEuclideanRhythm(e,t),m=[];return d.forEach(($,_)=>{const E=_/e*360;m.push({angle:E,radius:u,active:$,pitch:$?r[_%r.length]:void 0,velocity:.8,instrument:i})}),{points:m,color:s,label:a,instrument:i,divisions:e,speed:c}}static generateEuclideanRhythm(e,t){if(t>=e)return Array(e).fill(!0);const r=Array(e).fill(!1),n=e/t;for(let i=0;i<t;i++){const s=Math.round(i*n)%e;r[s]=!0}return r}static fromFunction(e,t=16,r=[60,72],n={}){const{instrument:i="synth",color:s="purple",label:a="Function Polyloop",speed:c=1,activeThreshold:u=.5}=n,d=[],[m,$]=r;for(let _=0;_<t;_++){const E=_/t*360,w=E*Math.PI/180,p=e(w),h=Math.abs(p)%1;d.push({angle:E,radius:.3+h*.5,active:h>u,pitch:Math.round(m+h*($-m)),velocity:.5+h*.5,instrument:i})}return{points:d,color:s,label:a,instrument:i,divisions:t,speed:c}}step(e){this.currentTime+=e;const t=[];return this.config.layers.forEach(r=>{const i=((this.rotationAngles.get(r.label)||0)+e*r.speed*360)%360;this.rotationAngles.set(r.label,i),r.points.forEach(s=>{if(!s.active)return;Math.abs(i-s.angle)<r.speed*360*e+1&&t.push({time:this.currentTime,layer:r.label,point:s,angle:i})})}),t}generateSequence(e,t=16){const r=1/t,n=Math.floor(e/r),i=[];this.currentTime=0,this.resetRotations();for(let s=0;s<n;s++){const a=this.step(r);i.push(...a)}return i}resetRotations(){this.config.layers.forEach(e=>{this.rotationAngles.set(e.label,0)}),this.currentTime=0}toJMonSequences(e=4){const t=this.generateSequence(e),r=new Map;t.forEach(i=>{r.has(i.layer)||r.set(i.layer,[]),r.get(i.layer).push(i)});const n=[];return r.forEach((i,s)=>{const a=i.map(c=>({pitch:Nn.midiToNoteName(c.point.pitch||60),time:Nn.timeToMusicalTime(c.time),duration:"8n",velocity:c.point.velocity||.8}));n.push({label:s,notes:a,synth:{type:"Synth",options:{oscillator:{type:"sine"},envelope:{attack:.01,decay:.1,sustain:.3,release:.5}}}})}),n}getVisualizationState(){return{layers:this.config.layers,rotationAngles:new Map(this.rotationAngles),currentTime:this.currentTime}}addLayer(e){this.config.layers.push(e),this.rotationAngles.set(e.label,0)}removeLayer(e){const t=this.config.layers.findIndex(r=>r.label===e);return t!==-1?(this.config.layers.splice(t,1),this.rotationAngles.delete(e),!0):!1}async plot(e){const{PolyloopVisualizer:t}=await Promise.resolve().then(()=>Zt);return t.plotPolyloop(this.config.layers,e)}async plotTimeline(e=8,t){const{PolyloopVisualizer:r}=await Promise.resolve().then(()=>Zt);return r.plotTimeline(this.config.layers,e,t)}async plotAnimated(e=12,t){const{PolyloopVisualizer:r}=await Promise.resolve().then(()=>Zt);return r.plotAnimated(this.config.layers,e,t)}}class Cn{static gini(e,t){if(e.length===0)return 0;const r=e.length,n=t||Array(r).fill(1),i=e.map((m,$)=>({value:m,weight:n[$]})).sort((m,$)=>m.value-$.value),s=i.map(m=>m.value),a=i.map(m=>m.weight),c=a.reduce((m,$)=>m+$,0);let u=0,d=0;for(let m=0;m<r;m++){const $=a.slice(0,m+1).reduce((_,E)=>_+E,0);u+=a[m]*(2*$-a[m]-c)*s[m],d+=a[m]*s[m]*c}return d===0?0:u/d}static balance(e,t){if(e.length===0)return 0;const r=t||Array(e.length).fill(1),n=e.reduce((s,a,c)=>s+a*r[c],0),i=r.reduce((s,a)=>s+a,0);return i===0?0:n/i}static autocorrelation(e,t){const r=e.length,n=t||Math.floor(r/2),i=[],s=e.reduce((c,u)=>c+u,0)/r,a=e.reduce((c,u)=>c+Math.pow(u-s,2),0)/r;for(let c=0;c<=n;c++){let u=0;for(let d=0;d<r-c;d++)u+=(e[d]-s)*(e[d+c]-s);u/=r-c,i.push(a===0?0:u/a)}return i}static motif(e,t=3){if(e.length<t*2)return 0;const r=new Map;for(let s=0;s<=e.length-t;s++){const a=e.slice(s,s+t).join(",");r.set(a,(r.get(a)||0)+1)}const n=Math.max(...r.values()),i=r.size;return i===0?0:n/i}static dissonance(e,t=[0,2,4,5,7,9,11]){if(e.length===0)return 0;let r=0;for(const n of e){const i=(n%12+12)%12;t.includes(i)&&r++}return 1-r/e.length}static rhythmic(e,t=16){if(e.length===0)return 0;let r=0;const n=.1;for(const i of e){const s=i*t,a=Math.round(s);Math.abs(s-a)<=n&&r++}return r/e.length}static fibonacciIndex(e){if(e.length<2)return 0;const t=(1+Math.sqrt(5))/2;let r=0;for(let n=1;n<e.length;n++)if(e[n-1]!==0){const i=e[n]/e[n-1],s=Math.abs(i-t);r+=1/(1+s)}return r/(e.length-1)}static syncopation(e,t=4){if(e.length===0)return 0;let r=0;for(const n of e){const i=n*t%1;i>.2&&i<.8&&Math.abs(i-.5)>.2&&r++}return r/e.length}static contourEntropy(e){if(e.length<2)return 0;const t=[];for(let s=1;s<e.length;s++){const a=e[s]-e[s-1];a>0?t.push(1):a<0?t.push(-1):t.push(0)}const r={up:0,down:0,same:0};for(const s of t)s>0?r.up++:s<0?r.down++:r.same++;const n=t.length;return-[r.up/n,r.down/n,r.same/n].filter(s=>s>0).reduce((s,a)=>s+a*Math.log2(a),0)}static intervalVariance(e){if(e.length<2)return 0;const t=[];for(let i=1;i<e.length;i++)t.push(Math.abs(e[i]-e[i-1]));const r=t.reduce((i,s)=>i+s,0)/t.length;return t.reduce((i,s)=>i+Math.pow(s-r,2),0)/t.length}static density(e,t=1){if(e.length===0)return 0;const r=e.map(a=>typeof a.time=="string"?parseFloat(a.time)||0:a.time||0),n=Math.min(...r),s=Math.max(...r)-n||1;return e.length/(s/t)}static gapVariance(e){if(e.length<2)return 0;const t=[];for(let i=1;i<e.length;i++)t.push(e[i]-e[i-1]);const r=t.reduce((i,s)=>i+s,0)/t.length;return t.reduce((i,s)=>i+Math.pow(s-r,2),0)/t.length}static analyze(e,t={}){const{scale:r=[0,2,4,5,7,9,11]}=t,n=e.map(s=>typeof s.note=="number"?s.note:typeof s.note=="string"?60:Array.isArray(s.note)?s.note[0]:60),i=e.map(s=>typeof s.time=="number"?s.time:parseFloat(s.time)||0);return{gini:this.gini(n),balance:this.balance(n),motif:this.motif(n),dissonance:this.dissonance(n,r),rhythmic:this.rhythmic(i),fibonacciIndex:this.fibonacciIndex(n),syncopation:this.syncopation(i),contourEntropy:this.contourEntropy(n),intervalVariance:this.intervalVariance(n),density:this.density(e),gapVariance:this.gapVariance(i)}}}class ms{constructor(e={}){this.options={populationSize:e.populationSize||50,generations:e.generations||100,mutationRate:e.mutationRate||.1,crossoverRate:e.crossoverRate||.8,elitismRate:e.elitismRate||.1,fitnessWeights:{gini:.2,balance:.15,motif:.25,dissonance:.2,rhythmic:.2,...e.fitnessWeights},scale:e.scale||[0,2,4,5,7,9,11],durations:e.durations||["4n","8n","2n","16n"],lengthRange:e.lengthRange||[8,16]},this.population=[],this.generation=0,this.bestFitness=-1/0,this.bestIndividual=null}initializePopulation(){this.population=[];for(let e=0;e<this.options.populationSize;e++){const t=this.createRandomIndividual();this.population.push(t)}this.evaluatePopulation()}evolve(){this.initializePopulation();for(let e=0;e<this.options.generations;e++){this.generation=e;const t=this.createNextGeneration();this.population=t,this.evaluatePopulation();const r=this.getBestIndividual();r.fitness>this.bestFitness&&(this.bestFitness=r.fitness,this.bestIndividual={...r})}return this.getBestIndividual()}createRandomIndividual(){const e=Math.floor(Math.random()*(this.options.lengthRange[1]-this.options.lengthRange[0]+1))+this.options.lengthRange[0],t=[];let r=0;for(let n=0;n<e;n++){const i=this.randomPitch(),s=this.randomDuration();t.push({note:i,time:`${Math.floor(r)}:${Math.floor(r%1*4)}:0`,duration:s,velocity:Math.random()*.5+.5}),r+=this.parseDuration(s)}return{genes:t,fitness:0,age:0}}randomPitch(){const e=Math.floor(Math.random()*3)+4,t=this.options.scale[Math.floor(Math.random()*this.options.scale.length)];return 12*e+t}randomDuration(){return this.options.durations[Math.floor(Math.random()*this.options.durations.length)]}parseDuration(e){return{"1n":4,"2n":2,"4n":1,"8n":.5,"16n":.25,"32n":.125}[e]||1}evaluatePopulation(){for(const e of this.population)e.fitness=this.calculateFitness(e.genes);this.population.sort((e,t)=>t.fitness-e.fitness)}calculateFitness(e){const t=Cn.analyze(e,{scale:this.options.scale});let r=0;const n=this.options.fitnessWeights;r+=(n.gini||0)*(1-t.gini),r+=(n.balance||0)*(1-Math.abs(t.balance-60)/60),r+=(n.motif||0)*t.motif,r+=(n.dissonance||0)*(1-t.dissonance),r+=(n.rhythmic||0)*t.rhythmic;const i=e.length;return(i<this.options.lengthRange[0]||i>this.options.lengthRange[1])&&(r*=.5),Math.max(0,r)}createNextGeneration(){const e=[],t=Math.floor(this.options.populationSize*this.options.elitismRate);for(let r=0;r<t;r++){const n={...this.population[r]};n.age++,e.push(n)}for(;e.length<this.options.populationSize;){const r=this.selectParent(),n=this.selectParent();let i,s;Math.random()<this.options.crossoverRate?[i,s]=this.crossover(r,n):(i={...r},s={...n}),Math.random()<this.options.mutationRate&&this.mutate(i),Math.random()<this.options.mutationRate&&this.mutate(s),i.age=0,s.age=0,e.push(i),e.length<this.options.populationSize&&e.push(s)}return e}selectParent(){const t=[];for(let r=0;r<3;r++){const n=Math.floor(Math.random()*this.population.length);t.push(this.population[n])}return t.sort((r,n)=>n.fitness-r.fitness),{...t[0]}}crossover(e,t){const r=Math.min(e.genes.length,t.genes.length),n=Math.floor(Math.random()*r),i={genes:[...e.genes.slice(0,n),...t.genes.slice(n)],fitness:0,age:0},s={genes:[...t.genes.slice(0,n),...e.genes.slice(n)],fitness:0,age:0};return[i,s]}mutate(e){const t=e.genes,r=Math.random();if(r<.3){const n=Math.floor(Math.random()*t.length);t[n].pitch=this.randomPitch()}else if(r<.6){const n=Math.floor(Math.random()*t.length);t[n].duration=this.randomDuration()}else if(r<.8){const n=Math.floor(Math.random()*t.length);t[n].velocity=Math.random()*.5+.5}else if(Math.random()<.5&&t.length<this.options.lengthRange[1]){const n=Math.floor(Math.random()*(t.length+1)),i={pitch:this.randomPitch(),time:"0:0:0",duration:this.randomDuration(),velocity:Math.random()*.5+.5};t.splice(n,0,i)}else if(t.length>this.options.lengthRange[0]){const n=Math.floor(Math.random()*t.length);t.splice(n,1)}this.recalculateTiming(e)}recalculateTiming(e){let t=0;for(const r of e.genes)r.time=`${Math.floor(t)}:${Math.floor(t%1*4)}:0`,t+=this.parseDuration(r.duration)}getBestIndividual(){return{...this.population[0]}}getStatistics(){const e=this.population.map(i=>i.fitness),t=e.reduce((i,s)=>i+s,0)/e.length,r=Math.max(...e),n=Math.min(...e);return{generation:this.generation,avgFitness:t,maxFitness:r,minFitness:n,bestAllTime:this.bestFitness,populationSize:this.population.length}}setCustomFitness(e){this.calculateFitness=e}}class ys{options;walkers;history;constructor(e={}){this.options={length:e.length||100,dimensions:e.dimensions||1,stepSize:e.stepSize||1,bounds:e.bounds||[-100,100],branchProbability:e.branchProbability||.05,mergeProbability:e.mergeProbability||.02,attractorStrength:e.attractorStrength||0,attractorPosition:e.attractorPosition||Array(e.dimensions||1).fill(0)},this.walkers=[],this.history=[]}generate(e){this.initialize(e),this.history=[];for(let t=0;t<this.options.length;t++)this.updateWalkers(),this.recordState(),this.handleBranching(),this.handleMerging();return this.history}initialize(e){const t=e||Array(this.options.dimensions).fill(0);this.walkers=[{position:[...t],velocity:Array(this.options.dimensions).fill(0),branches:[],age:0,active:!0}]}updateWalkers(){for(const e of this.walkers)if(e.active){for(let t=0;t<this.options.dimensions;t++){const r=(Math.random()-.5)*2*this.options.stepSize;let n=0;if(this.options.attractorStrength>0){const i=e.position[t]-this.options.attractorPosition[t];n=-this.options.attractorStrength*i}e.velocity[t]=e.velocity[t]*.9+r+n,e.position[t]+=e.velocity[t],e.position[t]<this.options.bounds[0]?(e.position[t]=this.options.bounds[0],e.velocity[t]*=-.5):e.position[t]>this.options.bounds[1]&&(e.position[t]=this.options.bounds[1],e.velocity[t]*=-.5)}e.age++}}recordState(){const e=this.walkers.filter(t=>t.active);if(e.length>0){const t=Array(this.options.dimensions).fill(0);for(const r of e)for(let n=0;n<this.options.dimensions;n++)t[n]+=r.position[n];for(let r=0;r<this.options.dimensions;r++)t[r]/=e.length;this.history.push([...t])}}handleBranching(){const e=[];for(const t of this.walkers)if(t.active&&Math.random()<this.options.branchProbability){const r={position:[...t.position],velocity:t.velocity.map(n=>n+(Math.random()-.5)*this.options.stepSize),branches:[],age:0,active:!0};e.push(r),t.branches.push(r)}this.walkers.push(...e)}handleMerging(){if(this.walkers.length<=1)return;const e=this.walkers.filter(r=>r.active),t=this.options.stepSize*2;for(let r=0;r<e.length;r++)for(let n=r+1;n<e.length;n++)if(Math.random()<this.options.mergeProbability&&this.calculateDistance(e[r].position,e[n].position)<t){for(let s=0;s<this.options.dimensions;s++)e[r].position[s]=(e[r].position[s]+e[n].position[s])/2,e[r].velocity[s]=(e[r].velocity[s]+e[n].velocity[s])/2;e[n].active=!1}this.walkers=this.walkers.filter(r=>r.active)}calculateDistance(e,t){let r=0;for(let n=0;n<e.length;n++)r+=Math.pow(e[n]-t[n],2);return Math.sqrt(r)}getProjection(e=0){return this.history.map(t=>t[e]||0)}mapToScale(e=0,t=[0,2,4,5,7,9,11],r=3){const n=this.getProjection(e);if(n.length===0)return[];const i=Math.min(...n),a=Math.max(...n)-i||1;return n.map(c=>{const u=(c-i)/a,d=Math.floor(u*t.length*r),m=Math.floor(d/t.length),$=d%t.length;return 60+m*12+t[$]})}mapToRhythm(e=0,t=[.25,.5,1,2]){const r=this.getProjection(e);if(r.length===0)return[];const n=Math.min(...r),s=Math.max(...r)-n||1;return r.map(a=>{const c=(a-n)/s,u=Math.floor(c*t.length),d=Math.max(0,Math.min(u,t.length-1));return t[d]})}mapToVelocity(e=0,t=.3,r=1){const n=this.getProjection(e);if(n.length===0)return[];const i=Math.min(...n),a=Math.max(...n)-i||1;return n.map(c=>{const u=(c-i)/a;return t+u*(r-t)})}generateCorrelated(e,t=.5,r=0){if(e.length===0)return[];const n=[];let i=0;for(let s=0;s<e.length;s++){const a=(Math.random()-.5)*2*this.options.stepSize,c=t*(e[s]-i);i+=a+c,i=Math.max(this.options.bounds[0],Math.min(this.options.bounds[1],i)),n.push(i)}return n}analyze(){if(this.history.length<2)return{meanDisplacement:0,meanSquaredDisplacement:0,totalDistance:0,fractalDimension:0};const e=this.getProjection(0),t=e[0],r=e[e.length-1],n=Math.abs(r-t),i=e.map(u=>Math.pow(u-t,2)),s=i.reduce((u,d)=>u+d,0)/i.length;let a=0;for(let u=1;u<e.length;u++)a+=Math.abs(e[u]-e[u-1]);const c=a>0?Math.log(a)/Math.log(e.length):0;return{meanDisplacement:n,meanSquaredDisplacement:s,totalDistance:a,fractalDimension:c}}getWalkerStates(){return this.walkers.map(e=>({...e}))}reset(){this.walkers=[],this.history=[]}}class gs{constructor(e={}){this.width=e.width||100,this.height=e.height||100,this.maxIterations=e.maxIterations||100,this.xMin=e.xMin||-2.5,this.xMax=e.xMax||1.5,this.yMin=e.yMin||-2,this.yMax=e.yMax||2}generate(){const e=[];for(let t=0;t<this.height;t++){const r=[];for(let n=0;n<this.width;n++){const i=this.xMin+n/this.width*(this.xMax-this.xMin),s=this.yMin+t/this.height*(this.yMax-this.yMin),a=this.mandelbrotIterations({real:i,imaginary:s});r.push(a)}e.push(r)}return e}extractSequence(e="diagonal",t=0){const r=this.generate();switch(e){case"diagonal":return this.extractDiagonal(r);case"border":return this.extractBorder(r);case"spiral":return this.extractSpiral(r);case"column":return this.extractColumn(r,t);case"row":return this.extractRow(r,t);default:return this.extractDiagonal(r)}}mandelbrotIterations(e){let t={real:0,imaginary:0};for(let r=0;r<this.maxIterations;r++){const n=t.real*t.real-t.imaginary*t.imaginary+e.real,i=2*t.real*t.imaginary+e.imaginary;if(t.real=n,t.imaginary=i,t.real*t.real+t.imaginary*t.imaginary>4)return r}return this.maxIterations}extractDiagonal(e){const t=[],r=Math.min(e.length,e[0]?.length||0);for(let n=0;n<r;n++)t.push(e[n][n]);return t}extractBorder(e){const t=[],r=e.length,n=e[0]?.length||0;if(r===0||n===0)return t;for(let i=0;i<n;i++)t.push(e[0][i]);for(let i=1;i<r;i++)t.push(e[i][n-1]);if(r>1)for(let i=n-2;i>=0;i--)t.push(e[r-1][i]);if(n>1)for(let i=r-2;i>0;i--)t.push(e[i][0]);return t}extractSpiral(e){const t=[],r=e.length,n=e[0]?.length||0;if(r===0||n===0)return t;let i=0,s=r-1,a=0,c=n-1;for(;i<=s&&a<=c;){for(let u=a;u<=c;u++)t.push(e[i][u]);i++;for(let u=i;u<=s;u++)t.push(e[u][c]);if(c--,i<=s){for(let u=c;u>=a;u--)t.push(e[s][u]);s--}if(a<=c){for(let u=s;u>=i;u--)t.push(e[u][a]);a++}}return t}extractColumn(e,t){const r=[],n=e[0]?.length||0,i=Math.max(0,Math.min(t,n-1));for(const s of e)s[i]!==void 0&&r.push(s[i]);return r}extractRow(e,t){const r=Math.max(0,Math.min(t,e.length-1));return e[r]?[...e[r]]:[]}mapToScale(e,t=[0,2,4,5,7,9,11],r=3){if(e.length===0)return[];const n=Math.min(...e),s=Math.max(...e)-n||1;return e.map(a=>{const c=(a-n)/s,u=Math.floor(c*t.length*r),d=Math.floor(u/t.length),m=u%t.length;return 60+d*12+t[m]})}mapToRhythm(e,t=[1,2,4,8,16]){if(e.length===0)return[];const r=Math.min(...e),i=Math.max(...e)-r||1;return e.map(s=>{const a=(s-r)/i,c=Math.floor(a*t.length),u=Math.max(0,Math.min(c,t.length-1));return 1/t[u]})}}class vs{constructor(e={}){this.r=e.r||3.8,this.x0=e.x0||.5,this.iterations=e.iterations||1e3,this.skipTransient=e.skipTransient||100}generate(){const e=[];let t=this.x0;for(let r=0;r<this.iterations+this.skipTransient;r++)t=this.r*t*(1-t),r>=this.skipTransient&&e.push(t);return e}bifurcationDiagram(e=2.5,t=4,r=1e3){const n=[],i=[],s=(t-e)/r;for(let a=0;a<r;a++){const c=e+a*s,u=this.r;this.r=c;const d=this.generate();this.r=u;const m=d.slice(-50);for(const $ of m)n.push(c),i.push($)}return{r:n,x:i}}mapToScale(e,t=[0,2,4,5,7,9,11],r=3){return e.length===0?[]:e.map(n=>{const i=Math.floor(n*t.length*r),s=Math.floor(i/t.length),a=i%t.length;return 60+s*12+t[a]})}mapToRhythm(e,t=[.25,.5,1,2]){return e.length===0?[]:e.map(r=>{const n=Math.floor(r*t.length),i=Math.max(0,Math.min(n,t.length-1));return t[i]})}mapToVelocity(e,t=.3,r=1){if(e.length===0)return[];const n=r-t;return e.map(i=>t+i*n)}detectCycles(e,t=.01){const r=[];for(let n=1;n<=Math.floor(e.length/2);n++){let i=!0;for(let s=n;s<Math.min(e.length,n*3);s++)if(Math.abs(e[s]-e[s-n])>t){i=!1;break}i&&r.push(n)}return r}lyapunovExponent(e=1e4){let t=this.x0,r=0;for(let n=0;n<e;n++){const i=this.r*(1-2*t);r+=Math.log(Math.abs(i)),t=this.r*t*(1-t)}return r/e}generateCoupled(e=2,t=.1){const r=Array(e).fill(null).map(()=>[]),n=Array(e).fill(this.x0);for(let i=0;i<this.iterations+this.skipTransient;i++){const s=[...n];for(let a=0;a<e;a++){let c=0;for(let u=0;u<e;u++)u!==a&&(c+=t*(n[u]-n[a]));s[a]=this.r*n[a]*(1-n[a])+c,s[a]=Math.max(0,Math.min(1,s[a]))}if(n.splice(0,e,...s),i>=this.skipTransient)for(let a=0;a<e;a++)r[a].push(n[a])}return r}setRegime(e,t){switch(e){case"periodic":this.r=3.2;break;case"chaotic":this.r=3.9;break;case"edge":this.r=3.57;break;case"custom":t!==void 0&&(this.r=Math.max(0,Math.min(4,t)));break}}getParameters(){return{r:this.r,x0:this.x0,iterations:this.iterations,skipTransient:this.skipTransient}}}class bs{operation;direction;repetition;sequence=[];constructor(e){const{operation:t,direction:r,repetition:n}=e;if(!["additive","subtractive"].includes(t))throw new Error("Invalid operation. Choose 'additive' or 'subtractive'.");if(!["forward","backward","inward","outward"].includes(r))throw new Error("Invalid direction. Choose 'forward', 'backward', 'inward' or 'outward'.");if(n<0||!Number.isInteger(n))throw new Error("Invalid repetition value. Must be an integer greater than or equal to 0.");this.operation=t,this.direction=r,this.repetition=n}generate(e){this.sequence=e;let t;if(this.operation==="additive"&&this.direction==="forward")t=this.additiveForward();else if(this.operation==="additive"&&this.direction==="backward")t=this.additiveBackward();else if(this.operation==="additive"&&this.direction==="inward")t=this.additiveInward();else if(this.operation==="additive"&&this.direction==="outward")t=this.additiveOutward();else if(this.operation==="subtractive"&&this.direction==="forward")t=this.subtractiveForward();else if(this.operation==="subtractive"&&this.direction==="backward")t=this.subtractiveBackward();else if(this.operation==="subtractive"&&this.direction==="inward")t=this.subtractiveInward();else if(this.operation==="subtractive"&&this.direction==="outward")t=this.subtractiveOutward();else throw new Error("Invalid operation/direction combination");return this.adjustOffsets(t)}additiveForward(){const e=[];for(let t=0;t<this.sequence.length;t++){const r=this.sequence.slice(0,t+1);for(let n=0;n<=this.repetition;n++)e.push(...r)}return e}additiveBackward(){const e=[];for(let t=this.sequence.length;t>0;t--){const r=this.sequence.slice(t-1);for(let n=0;n<=this.repetition;n++)e.push(...r)}return e}additiveInward(){const e=[],t=this.sequence.length;for(let r=0;r<Math.ceil(t/2);r++){let n;if(r<t-r-1){const i=this.sequence.slice(0,r+1),s=this.sequence.slice(t-r-1);n=[...i,...s]}else n=[...this.sequence];for(let i=0;i<=this.repetition;i++)e.push(...n)}return e}additiveOutward(){const e=[],t=this.sequence.length;if(t%2===0){const r=Math.floor(t/2)-1,n=Math.floor(t/2);for(let i=0;i<t/2;i++){const s=this.sequence.slice(r-i,n+i+1);for(let a=0;a<=this.repetition;a++)e.push(...s)}}else{const r=Math.floor(t/2);for(let n=0;n<=r;n++){const i=this.sequence.slice(r-n,r+n+1);for(let s=0;s<=this.repetition;s++)e.push(...i)}}return e}subtractiveForward(){const e=[];for(let t=0;t<this.sequence.length;t++){const r=this.sequence.slice(t);for(let n=0;n<=this.repetition;n++)e.push(...r)}return e}subtractiveBackward(){const e=[];for(let t=this.sequence.length;t>0;t--){const r=this.sequence.slice(0,t);for(let n=0;n<=this.repetition;n++)e.push(...r)}return e}subtractiveInward(){const e=[],t=this.sequence.length,r=Math.floor(t/2);for(let n=0;n<=this.repetition;n++)e.push(...this.sequence);for(let n=1;n<=r;n++){const i=this.sequence.slice(n,t-n);if(i.length>0)for(let s=0;s<=this.repetition;s++)e.push(...i)}return e}subtractiveOutward(){const e=[];let t=[...this.sequence];for(let r=0;r<=this.repetition;r++)e.push(...t);for(;t.length>2;){t=t.slice(1,-1);for(let r=0;r<=this.repetition;r++)e.push(...t)}return e}adjustOffsets(e){let t=0;return e.map(r=>{const n={...r,offset:t};return t+=r.duration,n})}}class ws{tChord;direction;rank;isAlternate;currentDirection;constructor(e,t="down",r=0){if(!["up","down","any","alternate"].includes(t))throw new Error("Invalid direction. Choose 'up', 'down', 'any' or 'alternate'.");if(this.tChord=e,this.isAlternate=t==="alternate",this.currentDirection=this.isAlternate?"up":t,this.direction=t,!Number.isInteger(r)||r<0)throw new Error("Rank must be a non-negative integer.");this.rank=Math.min(r,e.length-1),this.rank>=e.length&&console.warn("Rank exceeds the length of the t-chord. Using last note of the t-chord.")}generate(e){const t=[];for(const r of e){if(r.pitch===void 0){t.push({...r,pitch:void 0});continue}const n=r.pitch,s=this.tChord.map(u=>u-n).map((u,d)=>({index:d,value:u})).sort((u,d)=>Math.abs(u.value)-Math.abs(d.value));let a=this.rank,c;if(this.currentDirection==="up"||this.currentDirection==="down"){const u=s.filter(({value:d})=>this.currentDirection==="up"?d>=0:d<=0);if(u.length===0)c=this.currentDirection==="up"?Math.max(...this.tChord):Math.min(...this.tChord);else{a>=u.length&&(a=u.length-1);const d=u[a].index;c=this.tChord[d]}}else{a>=s.length&&(a=s.length-1);const u=s[a].index;c=this.tChord[u]}this.isAlternate&&(this.currentDirection=this.currentDirection==="up"?"down":"up"),t.push({...r,pitch:c})}return t}}const $s=Object.freeze(Object.defineProperty({__proto__:null,MusicalAnalysis:Cn},Symbol.toStringTag,{value:"Module"})),_s={harmony:ns,rhythm:ls,motifs:{MotifBank:us}},Ps={theory:se},Ss={gaussian:{Regressor:hs},automata:{Cellular:fs},loops:{Poly:ps},genetic:{Algorithm:ms},walks:{Random:ys},fractals:{Mandelbrot:gs,LogisticMap:vs},minimalism:{Process:bs,Tintinnabuli:ws}},Es={...$s},Ts={...Zi};class Ms{constructor(e={}){this.options={autoMultivoice:e.autoMultivoice??!0,maxVoices:e.maxVoices||4,showDebug:e.showDebug||!1,...e}}convert(e){if(!e||typeof e!="object")throw console.error("[CONVERTER] Invalid composition:",e),new Error("Composition must be a valid object");const t=e.tracks||e.sequences||[];if(!Array.isArray(t))throw console.error("[CONVERTER] Tracks must be an array, got:",typeof t,t),new Error(`Expected tracks to be an array, got ${typeof t}`);console.log("[CONVERTER] Processing",t.length,"tracks");const r=[];return t.forEach((n,i)=>{const s=n.sequence||n.notes||[],a=this.analyzeTrack(s),c=this.splitIntoVoices(s);c.forEach((u,d)=>{const m={originalTrackIndex:i,voiceIndex:d,totalVoices:c.length,trackInfo:{label:n.label||n.name||`Track ${i+1}`,originalTrack:n},notes:u,analysis:a,synthConfig:this.getSynthConfig(n,a,d),partEvents:this.createPartEvents(u)};r.push(m)})}),{tracks:r,metadata:{tempo:e.bpm||120,totalDuration:this.calculateTotalDuration(e),originalComposition:e}}}analyzeTrack(e){return{hasGlissando:e.some(t=>t.articulation==="glissando"),hasChords:e.some(t=>Array.isArray(t.pitch)),hasOverlaps:this.detectOverlaps(e),noteCount:e.length,timeRange:this.getTimeRange(e)}}detectOverlaps(e){if(e.length<2)return!1;const t=[...e].sort((r,n)=>(parseFloat(r.time)||0)-(parseFloat(n.time)||0));for(let r=1;r<t.length;r++){const n=t[r-1],i=t[r],a=(parseFloat(n.time)||0)+(parseFloat(n.duration)||.5);if((parseFloat(i.time)||0)<a)return!0}return!1}splitIntoVoices(e){if(!this.options.autoMultivoice||e.length===0)return[e];const t=this.options.maxVoices,r=Array(t).fill(null).map(()=>[]),n=Array(t).fill(0),i=[...e].sort((a,c)=>(parseFloat(a.time)||0)-(parseFloat(c.time)||0));for(const a of i){const c=parseFloat(a.time)||0,u=parseFloat(a.duration)||.5,d=c+u;let m=0;for(let $=0;$<t;$++)if(n[$]<=c){m=$;break}n[m]>c&&(m=n.indexOf(Math.min(...n)),this.options.showDebug&&console.warn(`[MULTIVOICE] Note overlap detected at time ${c}, assigning to voice ${m}`)),r[m].push(a),n[m]=d}const s=r.filter(a=>a.length>0);return s.length>1&&this.options.showDebug&&console.log(`[MULTIVOICE] Split track into ${s.length} voices to handle overlapping notes`),s.length>0?s:[e]}getSynthConfig(e,t,r){const n=e.instrument?.type||"PolySynth";return t.hasGlissando&&(n==="PolySynth"||n==="DuoSynth")?(r===0&&this.options.showDebug&&console.warn(`[MULTIVOICE] Using Synth instead of ${n} for glissando in ${e.label||"track"}`),{type:"Synth",reason:"glissando_compatibility",original:n}):{type:n,reason:"user_selected",original:n}}createPartEvents(e){return e.map(t=>{const r=parseFloat(t.time)||0,n=parseFloat(t.duration)||.5;return[r,{pitch:t.pitch,duration:n,articulation:t.articulation,velocity:t.velocity||.8,glissTarget:t.glissTarget,modulations:t.modulations,microtuning:t.microtuning}]})}calculateTotalDuration(e){const r=(e.tracks||e.sequences||[]).flatMap(a=>a.sequence||a.notes||[]);if(r.length===0)return 0;const n=Math.max(...r.map(a=>{const c=parseFloat(a.time)||0,u=parseFloat(a.duration)||.5;return c+u})),s=60/(e.bpm||120);return n*s}getTimeRange(e){if(e.length===0)return{start:0,end:0};const t=e.map(n=>parseFloat(n.time)||0),r=e.map(n=>(parseFloat(n.time)||0)+(parseFloat(n.duration)||.5));return{start:Math.min(...t),end:Math.max(...r)}}}function ks(o,e={}){return new Ms(e).convert(o)}function In(o,e={}){if(!o||typeof o!="object")throw console.error("[PLAYER] Invalid composition:",o),new Error("Composition must be a valid JMON object");if(!o.sequences&&!o.tracks)throw console.error("[PLAYER] No sequences or tracks found in composition:",o),new Error("Composition must have sequences or tracks");const t=o.tracks||o.sequences||[];if(!Array.isArray(t))throw console.error("[PLAYER] Tracks/sequences must be an array:",t),new Error("Tracks/sequences must be an array");console.log("[PLAYER] Processing composition with",t.length,"tracks");const{tempo:r=o.bpm||120,showDebug:n=!1,customInstruments:i={},autoMultivoice:s=!0,maxVoices:a=4}=e,u=ks(o,{autoMultivoice:s,maxVoices:a,showDebug:n}),{tracks:d,metadata:m}=u;let $=m.totalDuration;const _={background:"#FFFFFF",primary:"#333",secondary:"#F0F0F0",accent:"#333",text:"#000000",lightText:"#666666",border:"#CCCCCC"},E=document.createElement("div");E.style.cssText=`
        font-family: 'PT Sans', sans-serif;
        background-color: ${_.background};
        color: ${_.text};
        padding: 20px;
        border-radius: 12px;
        width: 400px;
        border: 1px solid ${_.border};
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
    `;const w=document.createElement("div");w.style.cssText=`
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    `;const p=document.createElement("div");p.style.cssText=`
        display: flex;
        flex-direction: column;
        width: 48%;
        justify-content: space-between;
    `;const h=document.createElement("div");h.style.cssText=`
        display: flex;
        flex-direction: column;
    `;const l=["PolySynth","Synth","AMSynth","DuoSynth","FMSynth","MembraneSynth","MetalSynth","MonoSynth","PluckSynth"],f=o.tracks||o.sequences||[],g=[];f.forEach((x,F)=>{const z=d.find(M=>M.originalTrackIndex===F)?.analysis;z?.hasGlissando&&console.warn(`Track ${x.label||x.name||F+1} contient un glissando : la polyphonie sera désactivée pour cette piste.`);const J=document.createElement("div");J.style.cssText=`
            margin-bottom: 8px;
        `;const H=document.createElement("label");H.textContent=x.name||x.label||`Track ${F+1}`,H.style.cssText=`
            font-size: 12px;
            color: ${_.text};
            display: block;
            margin-bottom: 2px;
        `;const T=document.createElement("select");T.style.cssText=`
            padding: 4px;
            border: 1px solid ${_.secondary};
            border-radius: 4px;
            background-color: ${_.background};
            color: ${_.text};
            font-size: 12px;
            width: 100%;
            height: 28px;
        `,l.forEach(M=>{const N=document.createElement("option");N.value=M,N.textContent=M,z?.hasGlissando&&(M==="PolySynth"||M==="DuoSynth")&&(N.disabled=!0,N.textContent+=" (mono only for glissando)"),T.appendChild(N)}),g.push(T),J.append(H,T),h.appendChild(J)}),p.appendChild(h);const b=document.createElement("div");b.style.cssText=`
        display: flex;
        flex-direction: column;
        width: 48%;
        justify-content: space-between;
    `;const v=document.createElement("div");v.style.cssText=`
        display: flex;
        flex-direction: column;
        width: 100%;
    `;const P=document.createElement("label");P.textContent="Tempo",P.style.cssText=`
        font-size: 14px;
        margin-bottom: 5px;
        color: ${_.text};
    `;const A=document.createElement("input");A.type="number",A.min=60,A.max=240,A.value=r,A.style.cssText=`
        padding: 8px;
        border: 1px solid ${_.secondary};
        border-radius: 6px;
        background-color: ${_.background};
        color: ${_.text};
        font-size: 14px;
        text-align: center;
        width: 100%;
        height: 36px;
    `,v.append(P,A),b.appendChild(v);const I=document.createElement("div");I.style.cssText=`
        position: relative;
        width: 100%;
        margin: 20px 0;
        display: flex;
        align-items: center;
    `;const q=document.createElement("input");q.type="range",q.min=0,q.max=100,q.value=0,q.style.cssText=`
        flex-grow: 1;
        -webkit-appearance: none;
        background: ${_.secondary};
        outline: none;
        border-radius: 15px;
        overflow: visible;
        height: 8px;
    `;const V=document.createElement("button");V.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>',V.style.cssText=`
        width: 40px;
        height: 40px;
        padding: 10px;
        border: none;
        border-radius: 50%;
        background-color: ${_.primary};
        color: ${_.background};
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0px 10px 0px 10px;
    `;const B=document.createElement("div");B.style.cssText=`
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: ${_.lightText};
        margin: 0px 0px 0px 10px;
    `;const U=document.createElement("span");U.textContent="0:00";const X=document.createElement("span");X.textContent="0:00",B.append(U," / ",X),I.append(q,V);const ne=document.createElement("div");ne.style.cssText=`
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    `;const ue=document.createElement("button");ue.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-keyboard-music" style="margin-right: 5px;"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="M6 8h4"/><path d="M14 8h.01"/><path d="M18 8h.01"/><path d="M2 12h20"/><path d="M6 12v4"/><path d="M10 12v4"/><path d="M14 12v4"/><path d="M18 12v4"/></svg><span>MIDI</span>',ue.style.cssText=`
        padding: 10px 20px;
        margin: 0 5px;
        border: none;
        border-radius: 6px;
        background-color: ${_.accent};
        color: ${_.background};
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    `;const he=document.createElement("button");he.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-audio-lines" style="margin-right: 5px;"><path d="M2 10v3"/><path d="M6 6v11"/><path d="M10 3v18"/><path d="M14 8v7"/><path d="M18 5v13"/><path d="M22 10v3"/></svg><span>WAV</span>',he.style.cssText=`
        padding: 10px 20px;
        margin: 0 5px;
        border: none;
        border-radius: 6px;
        background-color: ${_.accent};
        color: ${_.background};
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    `,ne.append(ue,he),w.append(p,b),E.append(w,I,B,ne);let D,ce=!1,j=[],k=[];const C=x=>`${Math.floor(x/60)}:${Math.floor(x%60).toString().padStart(2,"0")}`,R=async()=>{if(typeof window<"u"){if(!window.Tone)try{if(typeof require<"u")window.Tone=await require("https://unpkg.com/tone@14.8.49/build/Tone.js");else{const x=await import("https://unpkg.com/tone@14.8.49/build/Tone.js");window.Tone=x.default||x}}catch(x){return console.warn("Could not auto-load Tone.js:",x.message),console.log("To use the player, load Tone.js manually first:"),console.log('Tone = await require("https://unpkg.com/tone@14.8.49/build/Tone.js")'),!1}if(window.Tone)return D=window.Tone,D.context.state!=="running"&&(await D.start(),console.log("[PLAYER] Audio context started:",D.context.state)),!0}return console.warn("Tone.js not available"),!1},y=()=>{if(!D)return;console.log("[PLAYER] Cleaning up existing synths:",j.length,"parts:",k.length),j.forEach(z=>z.dispose()),k.forEach(z=>{z.stop(),z.dispose()}),j=[],k=[],d.forEach(z=>{const{originalTrackIndex:J,voiceIndex:H,totalVoices:T,trackInfo:M,synthConfig:N,partEvents:O}=z,L=g[J]?g[J].value:N.type;let K;try{const re=N.reason==="glissando_compatibility"?N.type:L;K=new D[re]().toDestination(),N.reason==="glissando_compatibility"&&H===0&&console.warn(`[MULTIVOICE] Using ${re} instead of ${N.original} for glissando in ${M.label}`)}catch(re){console.warn(`Failed to create ${L}, using PolySynth:`,re),K=new D.PolySynth().toDestination()}j.push(K),T>1&&console.log(`[MULTIVOICE] Track "${M.label}" voice ${H+1}: ${O.length} notes`),console.log("[PLAYER] Part events array:",O);const ie=new D.Part((re,G)=>{if(console.log("[PLAYER] Note event",{time:re,pitch:G.pitch,duration:G.duration,articulation:G.articulation,velocity:G.velocity,glissTarget:G.glissTarget}),Array.isArray(G.pitch))G.pitch.forEach(Q=>{let Z="C4";typeof Q=="number"?Z=D.Frequency(Q,"midi").toNote():typeof Q=="string"?Z=Q:Array.isArray(Q)&&typeof Q[0]=="string"&&(Z=Q[0]),console.log("[PLAYER] Chord note",{noteName:Z,duration:G.duration,time:re}),K.triggerAttackRelease(Z,G.duration,re)});else if(G.articulation==="glissando"&&G.glissTarget!==void 0){let Q=typeof G.pitch=="number"?D.Frequency(G.pitch,"midi").toNote():G.pitch,Z=typeof G.glissTarget=="number"?D.Frequency(G.glissTarget,"midi").toNote():G.glissTarget;console.log("[PLAYER] Glissando",{fromNote:Q,toNote:Z,duration:G.duration,time:re}),console.log("[PLAYER] Glissando effect starting from",Q,"to",Z),K.triggerAttack(Q,re,G.velocity||.8);const ae=D.Frequency(Q).toFrequency(),de=D.Frequency(Z).toFrequency(),Ne=1200*Math.log2(de/ae);if(K.detune&&K.detune.setValueAtTime&&K.detune.linearRampToValueAtTime)K.detune.setValueAtTime(0,re),K.detune.linearRampToValueAtTime(Ne,re+G.duration),console.log("[PLAYER] Applied detune glissando:",Ne,"cents over",G.duration,"beats");else{const De=D.Frequency(Q).toMidi(),Me=D.Frequency(Z).toMidi(),_e=Math.max(3,Math.abs(Me-De)),Ve=G.duration/_e;for(let ke=1;ke<_e;ke++){const er=ke/(_e-1),js=ae*Math.pow(de/ae,er),Os=D.Frequency(js).toNote(),qs=re+ke*Ve;K.triggerAttackRelease(Os,Ve*.8,qs,(G.velocity||.8)*.7)}console.log("[PLAYER] Applied chromatic glissando with",_e,"steps")}K.triggerRelease(re+G.duration)}else{let Q="C4";typeof G.pitch=="number"?Q=D.Frequency(G.pitch,"midi").toNote():typeof G.pitch=="string"?Q=G.pitch:Array.isArray(G.pitch)&&typeof G.pitch[0]=="string"&&(Q=G.pitch[0]);let Z=G.duration,ae=G.velocity||.8;G.articulation==="staccato"&&(Z=G.duration*.5),G.articulation==="accent"&&(ae=Math.min(ae*2,1)),G.articulation==="tenuto"&&(Z=G.duration*1.5,ae=Math.min(ae*1.3,1)),console.log("[PLAYER] Single note",{noteName:Q,noteDuration:Z,time:re,noteVelocity:ae}),K.triggerAttackRelease(Q,Z,re,ae)}},O);ie.start(0),console.log(`[PLAYER] Part created for voice ${H+1} with ${O.length} notes, started at time 0`),k.push(ie)}),console.log("[PLAYER] Total duration from converter:",$,"seconds"),D.Transport.bpm.value=m.tempo;const x=60/m.tempo,F=$/x;D.Transport.loopEnd=F,console.log("[PLAYER] Transport loop end set to",F,"beats"),D.Transport.loop=!0,D.Transport.stop(),D.Transport.position=0,console.log("[PLAYER] Transport fully reset - position:",D.Transport.position,"state:",D.Transport.state),X.textContent=C($)},S=()=>{if(D&&ce){const x=D.Transport.seconds/$*100;q.value=Math.min(x,100),U.textContent=C(D.Transport.seconds),D.Transport.state==="started"&&ce?requestAnimationFrame(S):D.Transport.state==="stopped"&&(D.Transport.seconds=0,q.value=0,U.textContent=C(0),ce=!1,V.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>')}};return V.addEventListener("click",async()=>{if(console.log("[PLAYER] Play button clicked, isPlaying:",ce,"Tone available:",!!D),!D)if(console.log("[PLAYER] Initializing Tone.js..."),await R())y();else{console.error("[PLAYER] Failed to initialize Tone.js");return}ce?(console.log("[PLAYER] Stopping transport..."),D.Transport.stop(),ce=!1,V.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>'):(console.log("[PLAYER] Starting transport..."),j.length===0&&(console.log("[PLAYER] No synths found, setting up audio..."),y()),D.Transport.stop(),D.Transport.position=0,console.log("[PLAYER] Transport state before start:",D.Transport.state),console.log("[PLAYER] Transport position reset to:",D.Transport.position),console.log("[PLAYER] Audio context state:",D.context.state),console.log("[PLAYER] Parts count:",k.length),console.log("[PLAYER] Synths count:",j.length),D.Transport.start(),ce=!0,V.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-pause"><circle cx="12" cy="12" r="10"/><line x1="10" x2="10" y1="15" y2="9"/><line x1="14" x2="14" y1="15" y2="9"/></svg>',S())}),q.addEventListener("input",()=>{if(D&&$>0){const x=q.value/100*$;D.Transport.seconds=x,U.textContent=C(x)}}),A.addEventListener("change",()=>{const x=parseInt(A.value);D&&x>=60&&x<=240?D.Transport.bpm.value=x:A.value=D?D.Transport.bpm.value:r}),g.forEach(x=>{x.addEventListener("change",()=>{D&&j.length>0&&y()})}),ue.addEventListener("click",()=>{console.log("MIDI download - requires MIDI converter implementation")}),he.addEventListener("click",()=>{console.log("WAV download - requires WAV generator implementation")}),typeof window<"u"&&window.Tone&&R().then(()=>y()),E}function As(o){return new Bt().validateAndNormalize(o)}function Xt(o){if(!o||typeof o!="object")throw console.error("[RENDER] Invalid JMON object:",o),new Error("render() requires a valid JMON object");return!o.sequences&&!o.tracks&&!o.format&&(console.warn("[RENDER] Object does not appear to be JMON format, attempting normalization"),o={format:"jmonTone",version:"1.0",bpm:o.bpm||120,sequences:o.sequences||o.tracks||[]}),In(o)}function Rs(o){const e=Xt(o);return setTimeout(()=>{const t=e.querySelector('button[aria-label="Play"]')||e.querySelector("button");t&&t.click()},100),e}function xs(o){return Xt(o)}const jn={render:Xt,play:Rs,score:xs,validate:As,Tone:Di,createPlayer:In,theory:_s,generative:Ss,analysis:Es,constants:Ps,utils:{...Ts,JmonValidator:Bt},VERSION:"1.0.0"};let xe=null,On=!1;async function Ns(){if(On)return xe;On=!0;try{if(typeof window<"u"&&window.Plotly)return xe=window.Plotly,xe;if(typeof window>"u"){const e=await import("plotly.js");return xe=e.default||e,xe}return null}catch{return console.warn("Plotly.js not available. Visualization methods will return placeholder data."),null}}class xt{static async line(e,t={},r="plot"){const n=await Ns();if(!n)return{data:e,options:t,type:"line",message:"Plotly.js not available"};const{title:i,width:s=640,height:a=400,color:c="steelblue",xTitle:u="X",yTitle:d="Y"}=t,m={x:e.x,y:e.y,type:"scatter",mode:"lines",line:{color:c,width:2},name:"Line"},$={title:i?{text:i}:void 0,width:s,height:a,xaxis:{title:{text:u}},yaxis:{title:{text:d}}};await n.newPlot(r,[m],$)}static async scatter(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,color:a="steelblue",xTitle:c="X",yTitle:u="Y"}=t,d={x:e.x,y:e.y,type:"scatter",mode:"markers",marker:{color:e.color||a,size:e.size||8},name:"Scatter"},m={title:n?{text:n}:void 0,width:i,height:s,xaxis:{title:{text:c}},yaxis:{title:{text:u}}};await plotly.newPlot(r,[d],m)}static async heatmap(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,colorScale:a="Viridis",xTitle:c="X",yTitle:u="Y"}=t,d={z:e,type:"heatmap",colorscale:a,showscale:!0},m={title:n?{text:n}:void 0,width:i,height:s,xaxis:{title:{text:c}},yaxis:{title:{text:u}}};await plotly.newPlot(r,[d],m)}static async bar(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,color:a="steelblue",xTitle:c="X",yTitle:u="Y"}=t,d={x:e.x.map($=>$.toString()),y:e.y,type:"bar",marker:{color:e.color||a},name:"Bar"},m={title:n?{text:n}:void 0,width:i,height:s,xaxis:{title:{text:c}},yaxis:{title:{text:u}}};await plotly.newPlot(r,[d],m)}static async radar(e,t={},r="plot"){const{title:n,width:i=400,height:s=400,color:a="steelblue"}=t,c=[...e.x,e.x[0]],d={r:[...e.y,e.y[0]],theta:c,type:"scatterpolar",mode:"lines+markers",fill:"toself",line:{color:a},marker:{color:a,size:8},name:"Radar"},m={title:n?{text:n}:void 0,width:i,height:s,polar:{radialaxis:{visible:!0,range:[0,Math.max(...e.y)*1.1]}}};await plotly.newPlot(r,[d],m)}static async timeSeries(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,xTitle:a="Time",yTitle:c="Value"}=t,u={x:e.x,y:e.y,type:"scatter",mode:"lines",line:{width:2},name:"Time Series"},d={title:n?{text:n}:void 0,width:i,height:s,xaxis:{title:{text:a}},yaxis:{title:{text:c}}};await plotly.newPlot(r,[u],d)}static async matrix(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,xTitle:a="Position",yTitle:c="Time Step"}=t,d={z:e.slice().reverse(),type:"heatmap",colorscale:[[0,"white"],[1,"black"]],showscale:!1,hoverinfo:"none"},m={title:n?{text:n}:void 0,width:i,height:s,xaxis:{title:{text:a},showticklabels:!1},yaxis:{title:{text:c},showticklabels:!1}};await plotly.newPlot(r,[d],m)}static async surface(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,colorScale:a="Viridis",xTitle:c="X",yTitle:u="Y",zTitle:d="Z"}=t,m={x:e.x,y:e.y,z:e.z,type:"surface",colorscale:a},$={title:n?{text:n}:void 0,width:i,height:s,scene:{xaxis:{title:{text:c}},yaxis:{title:{text:u}},zaxis:{title:{text:d}}}};await plotly.newPlot(r,[m],$)}static async multiLine(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,xTitle:a="X",yTitle:c="Y"}=t,u=e.map((m,$)=>({x:m.x,y:m.y,type:"scatter",mode:"lines",name:`Series ${$+1}`,line:{width:2}})),d={title:n?{text:n}:void 0,width:i,height:s,xaxis:{title:{text:a}},yaxis:{title:{text:c}}};await plotly.newPlot(r,u,d)}static async histogram(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,color:a="steelblue",xTitle:c="Value",yTitle:u="Frequency"}=t,d={x:e.x,type:"histogram",marker:{color:a},name:"Histogram"},m={title:n?{text:n}:void 0,width:i,height:s,xaxis:{title:{text:c}},yaxis:{title:{text:u}}};await plotly.newPlot(r,[d],m)}static async boxPlot(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,yTitle:a="Value"}=t,c=e.map((d,m)=>({y:d.y,type:"box",name:`Dataset ${m+1}`})),u={title:n?{text:n}:void 0,width:i,height:s,yaxis:{title:{text:a}}};await plotly.newPlot(r,c,u)}static async violin(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,yTitle:a="Value"}=t,c=e.map((d,m)=>({y:d.y,type:"violin",name:`Dataset ${m+1}`,box:{visible:!0},meanline:{visible:!0}})),u={title:n?{text:n}:void 0,width:i,height:s,yaxis:{title:{text:a}}};await plotly.newPlot(r,c,u)}static async contour(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,colorScale:a="Viridis",xTitle:c="X",yTitle:u="Y"}=t,d={x:e.x,y:e.y,z:e.z,type:"contour",colorscale:a,showscale:!0},m={title:n?{text:n}:void 0,width:i,height:s,xaxis:{title:{text:c}},yaxis:{title:{text:u}}};await plotly.newPlot(r,[d],m)}static async scatter3D(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,color:a="steelblue",xTitle:c="X",yTitle:u="Y",zTitle:d="Z"}=t,m={x:e.x,y:e.y,z:e.z,type:"scatter3d",mode:"markers",marker:{color:e.color||a,size:4,opacity:.8},name:"3D Scatter"},$={title:n?{text:n}:void 0,width:i,height:s,scene:{xaxis:{title:{text:c}},yaxis:{title:{text:u}},zaxis:{title:{text:d}}}};await plotly.newPlot(r,[m],$)}static async animate(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,duration:a=500,transition:c=100}=t,u=e[0]?.data||[],d={title:n?{text:n}:void 0,width:i,height:s,updatemenus:[{type:"buttons",showactive:!1,buttons:[{label:"Play",method:"animate",args:[null,{frame:{duration:a,redraw:!0},transition:{duration:c},fromcurrent:!0}]},{label:"Pause",method:"animate",args:[[null],{frame:{duration:0,redraw:!1},mode:"immediate",transition:{duration:0}}]}]}],...e[0]?.layout},m=e.map(($,_)=>({name:_.toString(),data:$.data,layout:$.layout}));await xe.newPlot(r,u,d),await plotly.addFrames(r,m)}static async candlestick(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,xTitle:a="Time",yTitle:c="Price"}=t,u={x:e.x,open:e.open,high:e.high,low:e.low,close:e.close,type:"candlestick",name:"OHLC"},d={title:n?{text:n}:void 0,width:i,height:s,xaxis:{title:{text:a}},yaxis:{title:{text:c}}};await plotly.newPlot(r,[u],d)}}class Cs{static plotEvolution(e,t={}){const{title:r="Cellular Automata Evolution",width:n=600,height:i=400,colorScheme:s="binary",showAxis:a=!1}=t,c=[];return e.forEach((u,d)=>{u.forEach((m,$)=>{c.push({x:$,y:e.length-1-d,value:m})})}),xt.matrix(e,{title:r,width:n,height:i,showAxis:a})}static plotGeneration(e,t={}){const{title:r="CA Generation",width:n=600,height:i=100}=t,s={x:e.map((a,c)=>c),y:e.map(()=>0),color:e.map(a=>a?"black":"white")};return xt.scatter(s,{title:r,width:n,height:i,showAxis:!1})}static compareRules(e,t={}){const{width:r=300,height:n=200,colorScheme:i="binary"}=t;return e.map(({ruleNumber:s,history:a})=>this.plotEvolution(a,{title:`Rule ${s}`,width:r,height:n,colorScheme:i,showAxis:!1}))}static createAnimationData(e){return e.map((t,r)=>({frame:r,data:t.map((n,i)=>({x:i,y:0,value:n}))}))}static extractPatterns(e){const t=[],r=[],n=[],i=e[0]?.length||0;for(let s=0;s<i;s++){const a=e.map(u=>u[s]),c=this.findPeriod(a.filter(u=>u!==void 0));c>1&&c<10&&t.push({position:s,period:c})}if(e.length>5){const s=e[e.length-1],a=e[e.length-2];if(s&&a)for(let c=0;c<i-3;c++)s.slice(c,c+3).every((d,m)=>d===a[c+m]&&d===1)&&n.push({position:c,width:3})}return{oscillators:t,gliders:r,stillLifes:n}}static findPeriod(e){if(e.length<4)return 1;for(let t=1;t<=Math.floor(e.length/2);t++){let r=!0;for(let n=t;n<e.length;n++)if(e[n]!==e[n-t]){r=!1;break}if(r)return t}return 1}static plotDensity(e,t={}){const{title:r="CA Density Over Time",width:n=600,height:i=300}=t,s=e.map((c,u)=>({time:u,density:c.reduce((d,m)=>d+m,0)/c.length})),a={x:s.map(c=>c.time),y:s.map(c=>c.density)};return xt.line(a,{title:r,width:n,height:i,color:"steelblue",showAxis:!0})}static plotSpacetime(e,t={}){const{title:r="Spacetime Diagram",width:n=600,height:i=400,showGrid:s=!1}=t,a=[];return e.forEach((c,u)=>{c.forEach((d,m)=>{a.push({x:m,y:e.length-1-u,value:d,border:s})})}),xt.matrix(e,{title:r,width:n,height:i,showAxis:!1})}}const Qt=Object.freeze(Object.defineProperty({__proto__:null,CAVisualizer:Cs},Symbol.toStringTag,{value:"Module"}));let qn=null;class Is{static plotPolyloop(e,t={}){const{pulse:r=1/4,colors:n,measureLength:i=4,container:s="polyloop-plot",title:a="Polyloop Visualization"}=t,c=n||this.generateColors(e.length),u=[],d=e.map(h=>h.label);e.forEach((h,l)=>{const f=h.points.filter(g=>g.active);if(f.length!==0&&(f.forEach(g=>{const b=g.angle,P=this.calculateDuration(g,h,i)*360/i,A=this.generateArcPoints(b,P,100),I=Array(100).fill(e.length-l-1);u.push({type:"scatterpolar",r:I,theta:A,mode:"lines",line:{color:"rgba(60, 60, 60, 0.65)",width:8},name:`${h.label} Duration`,showlegend:!1}),[b,(b+P)%360].forEach(q=>{u.push({type:"scatterpolar",r:[e.length-l-.9,e.length-l-1.1],theta:[q,q],mode:"lines",line:{color:"Black",width:3},name:`${h.label} Start/End`,showlegend:!1})})}),f.length>0)){const g=f.map(b=>b.angle);g.push(g[0]),u.push({type:"scatterpolar",r:Array(g.length).fill(e.length-l-1),theta:g,mode:"lines",line:{color:"rgba(0, 0, 0, 0.65)",width:1},fill:"toself",fillcolor:c[l%c.length],name:h.label,showlegend:!0})}});const m=[...u].reverse(),$=this.generateTickValues(i,r),_=this.generateTickLabels(i,r),E=Array.from({length:e.length},(h,l)=>l),w={title:{text:a},polar:{radialaxis:{visible:!0,range:[e.length,-.1],tickvals:E,ticktext:d},angularaxis:{tickvals:$,ticktext:_,direction:"clockwise",rotation:90}},template:"none",showlegend:!0,annotations:[{x:.5,y:.5,text:"�",showarrow:!1,font:{size:30,color:"White"},xref:"paper",yref:"paper"}]},p={responsive:!0,displayModeBar:!0};return qn.newPlot(s,m,w,p)}static generateColors(e){const t=[];for(let r=0;r<e;r++){const n=r/e,i=this.hsvToRgb(n,1,1);t.push(`rgba(${Math.round(i.r*255)}, ${Math.round(i.g*255)}, ${Math.round(i.b*255)}, 0.5)`)}return t}static hsvToRgb(e,t,r){let n,i,s;const a=Math.floor(e*6),c=e*6-a,u=r*(1-t),d=r*(1-c*t),m=r*(1-(1-c)*t);switch(a%6){case 0:n=r,i=m,s=u;break;case 1:n=d,i=r,s=u;break;case 2:n=u,i=r,s=m;break;case 3:n=u,i=d,s=r;break;case 4:n=m,i=u,s=r;break;case 5:n=r,i=u,s=d;break;default:n=i=s=0}return{r:n,g:i,b:s}}static generateArcPoints(e,t,r){const n=[];for(let i=0;i<r;i++){const s=e+i/(r-1)*t;n.push(s%360)}return n}static calculateDuration(e,t,r){return r/t.divisions}static generateTickValues(e,t){const r=[],n=Math.floor(e/t);for(let i=0;i<n;i++)r.push(i*360/n);return r}static generateTickLabels(e,t){const r=[],n=Math.floor(e/t);for(let i=0;i<n;i++){const s=i*t%e;r.push(s.toString())}return r}static plotTimeline(e,t=8,r={}){const{container:n="polyloop-timeline",title:i="Polyloop Timeline",colors:s}=r,a=s||this.generateColors(e.length),c=[];e.forEach((m,$)=>{const _=m.points.filter(p=>p.active),E=[],w=[];_.forEach(p=>{const h=p.angle/360*4;E.push(h),w.push(p.pitch||60)}),E.length>0&&c.push({type:"scatter",x:E,y:w,mode:"markers",marker:{color:a[$%a.length],size:10},name:m.label})});const u={title:{text:i},xaxis:{title:"Time (beats)",range:[0,t]},yaxis:{title:"Pitch (MIDI)",range:[20,120]},showlegend:!0},d={responsive:!0,displayModeBar:!0};return qn.newPlot(n,c,u,d)}static plotAnimated(e,t=12,r={}){const n=[];for(let i=0;i<t;i++){const s=i/t*360,a=e.map(u=>({...u,points:u.points.map(d=>({...d,angle:(d.angle+s*u.speed)%360}))})),c={...r,container:`${r.container||"polyloop-plot"}-frame-${i}`,title:`${r.title||"Polyloop"} - Frame ${i+1}`};n.push(this.plotPolyloop(a,c))}return Promise.all(n)}static convertToPolyloopData(e){const t={};return e.forEach(r=>{const n=r.points.map(i=>[i.active&&i.pitch||null,4/r.divisions,i.angle/360*4]);t[r.label]=n}),t}}const Zt=Object.freeze(Object.defineProperty({__proto__:null,PolyloopVisualizer:Is},Symbol.toStringTag,{value:"Module"}));Pe.default=jn,Pe.jm=jn,Object.defineProperties(Pe,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));

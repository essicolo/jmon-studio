(function(Pe,je){typeof exports=="object"&&typeof module<"u"?je(exports):typeof define=="function"&&define.amd?define(["exports"],je):(Pe=typeof globalThis<"u"?globalThis:Pe||self,je(Pe.JmonStudio={}))})(this,(function(Pe){"use strict";function je(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var Fe={exports:{}},jt={},ye={},Se={},Ot={},It={},Ct={},tr;function Le(){return tr||(tr=1,(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.regexpCode=o.getEsmExportName=o.getProperty=o.safeStringify=o.stringify=o.strConcat=o.addCodeArg=o.str=o._=o.nil=o._Code=o.Name=o.IDENTIFIER=o._CodeOrName=void 0;class e{}o._CodeOrName=e,o.IDENTIFIER=/^[a-z$_][a-z$_0-9]*$/i;class t extends e{constructor(c){if(super(),!o.IDENTIFIER.test(c))throw new Error("CodeGen: name must be a valid identifier");this.str=c}toString(){return this.str}emptyStr(){return!1}get names(){return{[this.str]:1}}}o.Name=t;class r extends e{constructor(c){super(),this._items=typeof c=="string"?[c]:c}toString(){return this.str}emptyStr(){if(this._items.length>1)return!1;const c=this._items[0];return c===""||c==='""'}get str(){var c;return(c=this._str)!==null&&c!==void 0?c:this._str=this._items.reduce((f,g)=>`${f}${g}`,"")}get names(){var c;return(c=this._names)!==null&&c!==void 0?c:this._names=this._items.reduce((f,g)=>(g instanceof t&&(f[g.str]=(f[g.str]||0)+1),f),{})}}o._Code=r,o.nil=new r("");function n(h,...c){const f=[h[0]];let g=0;for(;g<c.length;)a(f,c[g]),f.push(h[++g]);return new r(f)}o._=n;const i=new r("+");function s(h,...c){const f=[_(h[0])];let g=0;for(;g<c.length;)f.push(i),a(f,c[g]),f.push(i,_(h[++g]));return l(f),new r(f)}o.str=s;function a(h,c){c instanceof r?h.push(...c._items):c instanceof t?h.push(c):h.push(m(c))}o.addCodeArg=a;function l(h){let c=1;for(;c<h.length-1;){if(h[c]===i){const f=u(h[c-1],h[c+1]);if(f!==void 0){h.splice(c-1,3,f);continue}h[c++]="+"}c++}}function u(h,c){if(c==='""')return h;if(h==='""')return c;if(typeof h=="string")return c instanceof t||h[h.length-1]!=='"'?void 0:typeof c!="string"?`${h.slice(0,-1)}${c}"`:c[0]==='"'?h.slice(0,-1)+c.slice(1):void 0;if(typeof c=="string"&&c[0]==='"'&&!(h instanceof t))return`"${h}${c.slice(1)}`}function d(h,c){return c.emptyStr()?h:h.emptyStr()?c:s`${h}${c}`}o.strConcat=d;function m(h){return typeof h=="number"||typeof h=="boolean"||h===null?h:_(Array.isArray(h)?h.join(","):h)}function $(h){return new r(_(h))}o.stringify=$;function _(h){return JSON.stringify(h).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")}o.safeStringify=_;function E(h){return typeof h=="string"&&o.IDENTIFIER.test(h)?new r(`.${h}`):n`[${h}]`}o.getProperty=E;function w(h){if(typeof h=="string"&&o.IDENTIFIER.test(h))return new r(`${h}`);throw new Error(`CodeGen: invalid export name: ${h}, use explicit $id name mapping`)}o.getEsmExportName=w;function p(h){return new r(h.toString())}o.regexpCode=p})(Ct)),Ct}var qt={},rr;function nr(){return rr||(rr=1,(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.ValueScope=o.ValueScopeName=o.Scope=o.varKinds=o.UsedValueState=void 0;const e=Le();class t extends Error{constructor(u){super(`CodeGen: "code" for ${u} not defined`),this.value=u.value}}var r;(function(l){l[l.Started=0]="Started",l[l.Completed=1]="Completed"})(r||(o.UsedValueState=r={})),o.varKinds={const:new e.Name("const"),let:new e.Name("let"),var:new e.Name("var")};class n{constructor({prefixes:u,parent:d}={}){this._names={},this._prefixes=u,this._parent=d}toName(u){return u instanceof e.Name?u:this.name(u)}name(u){return new e.Name(this._newName(u))}_newName(u){const d=this._names[u]||this._nameGroup(u);return`${u}${d.index++}`}_nameGroup(u){var d,m;if(!((m=(d=this._parent)===null||d===void 0?void 0:d._prefixes)===null||m===void 0)&&m.has(u)||this._prefixes&&!this._prefixes.has(u))throw new Error(`CodeGen: prefix "${u}" is not allowed in this scope`);return this._names[u]={prefix:u,index:0}}}o.Scope=n;class i extends e.Name{constructor(u,d){super(d),this.prefix=u}setValue(u,{property:d,itemIndex:m}){this.value=u,this.scopePath=(0,e._)`.${new e.Name(d)}[${m}]`}}o.ValueScopeName=i;const s=(0,e._)`\n`;class a extends n{constructor(u){super(u),this._values={},this._scope=u.scope,this.opts={...u,_n:u.lines?s:e.nil}}get(){return this._scope}name(u){return new i(u,this._newName(u))}value(u,d){var m;if(d.ref===void 0)throw new Error("CodeGen: ref must be passed in value");const $=this.toName(u),{prefix:_}=$,E=(m=d.key)!==null&&m!==void 0?m:d.ref;let w=this._values[_];if(w){const c=w.get(E);if(c)return c}else w=this._values[_]=new Map;w.set(E,$);const p=this._scope[_]||(this._scope[_]=[]),h=p.length;return p[h]=d.ref,$.setValue(d,{property:_,itemIndex:h}),$}getValue(u,d){const m=this._values[u];if(m)return m.get(d)}scopeRefs(u,d=this._values){return this._reduceValues(d,m=>{if(m.scopePath===void 0)throw new Error(`CodeGen: name "${m}" has no value`);return(0,e._)`${u}${m.scopePath}`})}scopeCode(u=this._values,d,m){return this._reduceValues(u,$=>{if($.value===void 0)throw new Error(`CodeGen: name "${$}" has no value`);return $.value.code},d,m)}_reduceValues(u,d,m={},$){let _=e.nil;for(const E in u){const w=u[E];if(!w)continue;const p=m[E]=m[E]||new Map;w.forEach(h=>{if(p.has(h))return;p.set(h,r.Started);let c=d(h);if(c){const f=this.opts.es5?o.varKinds.var:o.varKinds.const;_=(0,e._)`${_}${f} ${h} = ${c};${this.opts._n}`}else if(c=$?.(h))_=(0,e._)`${_}${c}${this.opts._n}`;else throw new t(h);p.set(h,r.Completed)})}return _}}o.ValueScope=a})(qt)),qt}var ir;function Y(){return ir||(ir=1,(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.or=o.and=o.not=o.CodeGen=o.operators=o.varKinds=o.ValueScopeName=o.ValueScope=o.Scope=o.Name=o.regexpCode=o.stringify=o.getProperty=o.nil=o.strConcat=o.str=o._=void 0;const e=Le(),t=nr();var r=Le();Object.defineProperty(o,"_",{enumerable:!0,get:function(){return r._}}),Object.defineProperty(o,"str",{enumerable:!0,get:function(){return r.str}}),Object.defineProperty(o,"strConcat",{enumerable:!0,get:function(){return r.strConcat}}),Object.defineProperty(o,"nil",{enumerable:!0,get:function(){return r.nil}}),Object.defineProperty(o,"getProperty",{enumerable:!0,get:function(){return r.getProperty}}),Object.defineProperty(o,"stringify",{enumerable:!0,get:function(){return r.stringify}}),Object.defineProperty(o,"regexpCode",{enumerable:!0,get:function(){return r.regexpCode}}),Object.defineProperty(o,"Name",{enumerable:!0,get:function(){return r.Name}});var n=nr();Object.defineProperty(o,"Scope",{enumerable:!0,get:function(){return n.Scope}}),Object.defineProperty(o,"ValueScope",{enumerable:!0,get:function(){return n.ValueScope}}),Object.defineProperty(o,"ValueScopeName",{enumerable:!0,get:function(){return n.ValueScopeName}}),Object.defineProperty(o,"varKinds",{enumerable:!0,get:function(){return n.varKinds}}),o.operators={GT:new e._Code(">"),GTE:new e._Code(">="),LT:new e._Code("<"),LTE:new e._Code("<="),EQ:new e._Code("==="),NEQ:new e._Code("!=="),NOT:new e._Code("!"),OR:new e._Code("||"),AND:new e._Code("&&"),ADD:new e._Code("+")};class i{optimizeNodes(){return this}optimizeNames(y,S){return this}}class s extends i{constructor(y,S,A){super(),this.varKind=y,this.name=S,this.rhs=A}render({es5:y,_n:S}){const A=y?t.varKinds.var:this.varKind,z=this.rhs===void 0?"":` = ${this.rhs}`;return`${A} ${this.name}${z};`+S}optimizeNames(y,S){if(y[this.name.str])return this.rhs&&(this.rhs=X(this.rhs,y,S)),this}get names(){return this.rhs instanceof e._CodeOrName?this.rhs.names:{}}}class a extends i{constructor(y,S,A){super(),this.lhs=y,this.rhs=S,this.sideEffects=A}render({_n:y}){return`${this.lhs} = ${this.rhs};`+y}optimizeNames(y,S){if(!(this.lhs instanceof e.Name&&!y[this.lhs.str]&&!this.sideEffects))return this.rhs=X(this.rhs,y,S),this}get names(){const y=this.lhs instanceof e.Name?{}:{...this.lhs.names};return U(y,this.rhs)}}class l extends a{constructor(y,S,A,z){super(y,A,z),this.op=S}render({_n:y}){return`${this.lhs} ${this.op}= ${this.rhs};`+y}}class u extends i{constructor(y){super(),this.label=y,this.names={}}render({_n:y}){return`${this.label}:`+y}}class d extends i{constructor(y){super(),this.label=y,this.names={}}render({_n:y}){return`break${this.label?` ${this.label}`:""};`+y}}class m extends i{constructor(y){super(),this.error=y}render({_n:y}){return`throw ${this.error};`+y}get names(){return this.error.names}}class $ extends i{constructor(y){super(),this.code=y}render({_n:y}){return`${this.code};`+y}optimizeNodes(){return`${this.code}`?this:void 0}optimizeNames(y,S){return this.code=X(this.code,y,S),this}get names(){return this.code instanceof e._CodeOrName?this.code.names:{}}}class _ extends i{constructor(y=[]){super(),this.nodes=y}render(y){return this.nodes.reduce((S,A)=>S+A.render(y),"")}optimizeNodes(){const{nodes:y}=this;let S=y.length;for(;S--;){const A=y[S].optimizeNodes();Array.isArray(A)?y.splice(S,1,...A):A?y[S]=A:y.splice(S,1)}return y.length>0?this:void 0}optimizeNames(y,S){const{nodes:A}=this;let z=A.length;for(;z--;){const F=A[z];F.optimizeNames(y,S)||(ne(y,F.names),A.splice(z,1))}return A.length>0?this:void 0}get names(){return this.nodes.reduce((y,S)=>H(y,S.names),{})}}class E extends _{render(y){return"{"+y._n+super.render(y)+"}"+y._n}}class w extends _{}class p extends E{}p.kind="else";class h extends E{constructor(y,S){super(S),this.condition=y}render(y){let S=`if(${this.condition})`+super.render(y);return this.else&&(S+="else "+this.else.render(y)),S}optimizeNodes(){super.optimizeNodes();const y=this.condition;if(y===!0)return this.nodes;let S=this.else;if(S){const A=S.optimizeNodes();S=this.else=Array.isArray(A)?new p(A):A}if(S)return y===!1?S instanceof h?S:S.nodes:this.nodes.length?this:new h(ue(y),S instanceof h?[S]:S.nodes);if(!(y===!1||!this.nodes.length))return this}optimizeNames(y,S){var A;if(this.else=(A=this.else)===null||A===void 0?void 0:A.optimizeNames(y,S),!!(super.optimizeNames(y,S)||this.else))return this.condition=X(this.condition,y,S),this}get names(){const y=super.names;return U(y,this.condition),this.else&&H(y,this.else.names),y}}h.kind="if";class c extends E{}c.kind="for";class f extends c{constructor(y){super(),this.iteration=y}render(y){return`for(${this.iteration})`+super.render(y)}optimizeNames(y,S){if(super.optimizeNames(y,S))return this.iteration=X(this.iteration,y,S),this}get names(){return H(super.names,this.iteration.names)}}class g extends c{constructor(y,S,A,z){super(),this.varKind=y,this.name=S,this.from=A,this.to=z}render(y){const S=y.es5?t.varKinds.var:this.varKind,{name:A,from:z,to:F}=this;return`for(${S} ${A}=${z}; ${A}<${F}; ${A}++)`+super.render(y)}get names(){const y=U(super.names,this.from);return U(y,this.to)}}class b extends c{constructor(y,S,A,z){super(),this.loop=y,this.varKind=S,this.name=A,this.iterable=z}render(y){return`for(${this.varKind} ${this.name} ${this.loop} ${this.iterable})`+super.render(y)}optimizeNames(y,S){if(super.optimizeNames(y,S))return this.iterable=X(this.iterable,y,S),this}get names(){return H(super.names,this.iterable.names)}}class v extends E{constructor(y,S,A){super(),this.name=y,this.args=S,this.async=A}render(y){return`${this.async?"async ":""}function ${this.name}(${this.args})`+super.render(y)}}v.kind="func";class P extends _{render(y){return"return "+super.render(y)}}P.kind="return";class R extends E{render(y){let S="try"+super.render(y);return this.catch&&(S+=this.catch.render(y)),this.finally&&(S+=this.finally.render(y)),S}optimizeNodes(){var y,S;return super.optimizeNodes(),(y=this.catch)===null||y===void 0||y.optimizeNodes(),(S=this.finally)===null||S===void 0||S.optimizeNodes(),this}optimizeNames(y,S){var A,z;return super.optimizeNames(y,S),(A=this.catch)===null||A===void 0||A.optimizeNames(y,S),(z=this.finally)===null||z===void 0||z.optimizeNames(y,S),this}get names(){const y=super.names;return this.catch&&H(y,this.catch.names),this.finally&&H(y,this.finally.names),y}}class O extends E{constructor(y){super(),this.error=y}render(y){return`catch(${this.error})`+super.render(y)}}O.kind="catch";class q extends E{render(y){return"finally"+super.render(y)}}q.kind="finally";class V{constructor(y,S={}){this._values={},this._blockStarts=[],this._constants={},this.opts={...S,_n:S.lines?`
`:""},this._extScope=y,this._scope=new t.Scope({parent:y}),this._nodes=[new w]}toString(){return this._root.render(this.opts)}name(y){return this._scope.name(y)}scopeName(y){return this._extScope.name(y)}scopeValue(y,S){const A=this._extScope.value(y,S);return(this._values[A.prefix]||(this._values[A.prefix]=new Set)).add(A),A}getScopeValue(y,S){return this._extScope.getValue(y,S)}scopeRefs(y){return this._extScope.scopeRefs(y,this._values)}scopeCode(){return this._extScope.scopeCode(this._values)}_def(y,S,A,z){const F=this._scope.toName(S);return A!==void 0&&z&&(this._constants[F.str]=A),this._leafNode(new s(y,F,A)),F}const(y,S,A){return this._def(t.varKinds.const,y,S,A)}let(y,S,A){return this._def(t.varKinds.let,y,S,A)}var(y,S,A){return this._def(t.varKinds.var,y,S,A)}assign(y,S,A){return this._leafNode(new a(y,S,A))}add(y,S){return this._leafNode(new l(y,o.operators.ADD,S))}code(y){return typeof y=="function"?y():y!==e.nil&&this._leafNode(new $(y)),this}object(...y){const S=["{"];for(const[A,z]of y)S.length>1&&S.push(","),S.push(A),(A!==z||this.opts.es5)&&(S.push(":"),(0,e.addCodeArg)(S,z));return S.push("}"),new e._Code(S)}if(y,S,A){if(this._blockNode(new h(y)),S&&A)this.code(S).else().code(A).endIf();else if(S)this.code(S).endIf();else if(A)throw new Error('CodeGen: "else" body without "then" body');return this}elseIf(y){return this._elseNode(new h(y))}else(){return this._elseNode(new p)}endIf(){return this._endBlockNode(h,p)}_for(y,S){return this._blockNode(y),S&&this.code(S).endFor(),this}for(y,S){return this._for(new f(y),S)}forRange(y,S,A,z,F=this.opts.es5?t.varKinds.var:t.varKinds.let){const J=this._scope.toName(y);return this._for(new g(F,J,S,A),()=>z(J))}forOf(y,S,A,z=t.varKinds.const){const F=this._scope.toName(y);if(this.opts.es5){const J=S instanceof e.Name?S:this.var("_arr",S);return this.forRange("_i",0,(0,e._)`${J}.length`,B=>{this.var(F,(0,e._)`${J}[${B}]`),A(F)})}return this._for(new b("of",z,F,S),()=>A(F))}forIn(y,S,A,z=this.opts.es5?t.varKinds.var:t.varKinds.const){if(this.opts.ownProperties)return this.forOf(y,(0,e._)`Object.keys(${S})`,A);const F=this._scope.toName(y);return this._for(new b("in",z,F,S),()=>A(F))}endFor(){return this._endBlockNode(c)}label(y){return this._leafNode(new u(y))}break(y){return this._leafNode(new d(y))}return(y){const S=new P;if(this._blockNode(S),this.code(y),S.nodes.length!==1)throw new Error('CodeGen: "return" should have one node');return this._endBlockNode(P)}try(y,S,A){if(!S&&!A)throw new Error('CodeGen: "try" without "catch" and "finally"');const z=new R;if(this._blockNode(z),this.code(y),S){const F=this.name("e");this._currNode=z.catch=new O(F),S(F)}return A&&(this._currNode=z.finally=new q,this.code(A)),this._endBlockNode(O,q)}throw(y){return this._leafNode(new m(y))}block(y,S){return this._blockStarts.push(this._nodes.length),y&&this.code(y).endBlock(S),this}endBlock(y){const S=this._blockStarts.pop();if(S===void 0)throw new Error("CodeGen: not in self-balancing block");const A=this._nodes.length-S;if(A<0||y!==void 0&&A!==y)throw new Error(`CodeGen: wrong number of nodes: ${A} vs ${y} expected`);return this._nodes.length=S,this}func(y,S=e.nil,A,z){return this._blockNode(new v(y,S,A)),z&&this.code(z).endFunc(),this}endFunc(){return this._endBlockNode(v)}optimize(y=1){for(;y-- >0;)this._root.optimizeNodes(),this._root.optimizeNames(this._root.names,this._constants)}_leafNode(y){return this._currNode.nodes.push(y),this}_blockNode(y){this._currNode.nodes.push(y),this._nodes.push(y)}_endBlockNode(y,S){const A=this._currNode;if(A instanceof y||S&&A instanceof S)return this._nodes.pop(),this;throw new Error(`CodeGen: not in block "${S?`${y.kind}/${S.kind}`:y.kind}"`)}_elseNode(y){const S=this._currNode;if(!(S instanceof h))throw new Error('CodeGen: "else" without "if"');return this._currNode=S.else=y,this}get _root(){return this._nodes[0]}get _currNode(){const y=this._nodes;return y[y.length-1]}set _currNode(y){const S=this._nodes;S[S.length-1]=y}}o.CodeGen=V;function H(x,y){for(const S in y)x[S]=(x[S]||0)+(y[S]||0);return x}function U(x,y){return y instanceof e._CodeOrName?H(x,y.names):x}function X(x,y,S){if(x instanceof e.Name)return A(x);if(!z(x))return x;return new e._Code(x._items.reduce((F,J)=>(J instanceof e.Name&&(J=A(J)),J instanceof e._Code?F.push(...J._items):F.push(J),F),[]));function A(F){const J=S[F.str];return J===void 0||y[F.str]!==1?F:(delete y[F.str],J)}function z(F){return F instanceof e._Code&&F._items.some(J=>J instanceof e.Name&&y[J.str]===1&&S[J.str]!==void 0)}}function ne(x,y){for(const S in y)x[S]=(x[S]||0)-(y[S]||0)}function ue(x){return typeof x=="boolean"||typeof x=="number"||x===null?!x:(0,e._)`!${j(x)}`}o.not=ue;const he=k(o.operators.AND);function D(...x){return x.reduce(he)}o.and=D;const ce=k(o.operators.OR);function I(...x){return x.reduce(ce)}o.or=I;function k(x){return(y,S)=>y===e.nil?S:S===e.nil?y:(0,e._)`${j(y)} ${x} ${j(S)}`}function j(x){return x instanceof e.Name?x:(0,e._)`(${x})`}})(It)),It}var W={},or;function ee(){if(or)return W;or=1,Object.defineProperty(W,"__esModule",{value:!0}),W.checkStrictMode=W.getErrorPath=W.Type=W.useFunc=W.setEvaluated=W.evaluatedPropsToName=W.mergeEvaluated=W.eachItem=W.unescapeJsonPointer=W.escapeJsonPointer=W.escapeFragment=W.unescapeFragment=W.schemaRefOrVal=W.schemaHasRulesButRef=W.schemaHasRules=W.checkUnknownRules=W.alwaysValidSchema=W.toHash=void 0;const o=Y(),e=Le();function t(b){const v={};for(const P of b)v[P]=!0;return v}W.toHash=t;function r(b,v){return typeof v=="boolean"?v:Object.keys(v).length===0?!0:(n(b,v),!i(v,b.self.RULES.all))}W.alwaysValidSchema=r;function n(b,v=b.schema){const{opts:P,self:R}=b;if(!P.strictSchema||typeof v=="boolean")return;const O=R.RULES.keywords;for(const q in v)O[q]||g(b,`unknown keyword: "${q}"`)}W.checkUnknownRules=n;function i(b,v){if(typeof b=="boolean")return!b;for(const P in b)if(v[P])return!0;return!1}W.schemaHasRules=i;function s(b,v){if(typeof b=="boolean")return!b;for(const P in b)if(P!=="$ref"&&v.all[P])return!0;return!1}W.schemaHasRulesButRef=s;function a({topSchemaRef:b,schemaPath:v},P,R,O){if(!O){if(typeof P=="number"||typeof P=="boolean")return P;if(typeof P=="string")return(0,o._)`${P}`}return(0,o._)`${b}${v}${(0,o.getProperty)(R)}`}W.schemaRefOrVal=a;function l(b){return m(decodeURIComponent(b))}W.unescapeFragment=l;function u(b){return encodeURIComponent(d(b))}W.escapeFragment=u;function d(b){return typeof b=="number"?`${b}`:b.replace(/~/g,"~0").replace(/\//g,"~1")}W.escapeJsonPointer=d;function m(b){return b.replace(/~1/g,"/").replace(/~0/g,"~")}W.unescapeJsonPointer=m;function $(b,v){if(Array.isArray(b))for(const P of b)v(P);else v(b)}W.eachItem=$;function _({mergeNames:b,mergeToName:v,mergeValues:P,resultToName:R}){return(O,q,V,H)=>{const U=V===void 0?q:V instanceof o.Name?(q instanceof o.Name?b(O,q,V):v(O,q,V),V):q instanceof o.Name?(v(O,V,q),q):P(q,V);return H===o.Name&&!(U instanceof o.Name)?R(O,U):U}}W.mergeEvaluated={props:_({mergeNames:(b,v,P)=>b.if((0,o._)`${P} !== true && ${v} !== undefined`,()=>{b.if((0,o._)`${v} === true`,()=>b.assign(P,!0),()=>b.assign(P,(0,o._)`${P} || {}`).code((0,o._)`Object.assign(${P}, ${v})`))}),mergeToName:(b,v,P)=>b.if((0,o._)`${P} !== true`,()=>{v===!0?b.assign(P,!0):(b.assign(P,(0,o._)`${P} || {}`),w(b,P,v))}),mergeValues:(b,v)=>b===!0?!0:{...b,...v},resultToName:E}),items:_({mergeNames:(b,v,P)=>b.if((0,o._)`${P} !== true && ${v} !== undefined`,()=>b.assign(P,(0,o._)`${v} === true ? true : ${P} > ${v} ? ${P} : ${v}`)),mergeToName:(b,v,P)=>b.if((0,o._)`${P} !== true`,()=>b.assign(P,v===!0?!0:(0,o._)`${P} > ${v} ? ${P} : ${v}`)),mergeValues:(b,v)=>b===!0?!0:Math.max(b,v),resultToName:(b,v)=>b.var("items",v)})};function E(b,v){if(v===!0)return b.var("props",!0);const P=b.var("props",(0,o._)`{}`);return v!==void 0&&w(b,P,v),P}W.evaluatedPropsToName=E;function w(b,v,P){Object.keys(P).forEach(R=>b.assign((0,o._)`${v}${(0,o.getProperty)(R)}`,!0))}W.setEvaluated=w;const p={};function h(b,v){return b.scopeValue("func",{ref:v,code:p[v.code]||(p[v.code]=new e._Code(v.code))})}W.useFunc=h;var c;(function(b){b[b.Num=0]="Num",b[b.Str=1]="Str"})(c||(W.Type=c={}));function f(b,v,P){if(b instanceof o.Name){const R=v===c.Num;return P?R?(0,o._)`"[" + ${b} + "]"`:(0,o._)`"['" + ${b} + "']"`:R?(0,o._)`"/" + ${b}`:(0,o._)`"/" + ${b}.replace(/~/g, "~0").replace(/\\//g, "~1")`}return P?(0,o.getProperty)(b).toString():"/"+d(b)}W.getErrorPath=f;function g(b,v,P=b.opts.strictSchema){if(P){if(v=`strict mode: ${v}`,P===!0)throw new Error(v);b.self.logger.warn(v)}}return W.checkStrictMode=g,W}var Ue={},sr;function be(){if(sr)return Ue;sr=1,Object.defineProperty(Ue,"__esModule",{value:!0});const o=Y(),e={data:new o.Name("data"),valCxt:new o.Name("valCxt"),instancePath:new o.Name("instancePath"),parentData:new o.Name("parentData"),parentDataProperty:new o.Name("parentDataProperty"),rootData:new o.Name("rootData"),dynamicAnchors:new o.Name("dynamicAnchors"),vErrors:new o.Name("vErrors"),errors:new o.Name("errors"),this:new o.Name("this"),self:new o.Name("self"),scope:new o.Name("scope"),json:new o.Name("json"),jsonPos:new o.Name("jsonPos"),jsonLen:new o.Name("jsonLen"),jsonPart:new o.Name("jsonPart")};return Ue.default=e,Ue}var ar;function Ge(){return ar||(ar=1,(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.extendErrors=o.resetErrorsCount=o.reportExtraError=o.reportError=o.keyword$DataError=o.keywordError=void 0;const e=Y(),t=ee(),r=be();o.keywordError={message:({keyword:p})=>(0,e.str)`must pass "${p}" keyword validation`},o.keyword$DataError={message:({keyword:p,schemaType:h})=>h?(0,e.str)`"${p}" keyword must be ${h} ($data)`:(0,e.str)`"${p}" keyword is invalid ($data)`};function n(p,h=o.keywordError,c,f){const{it:g}=p,{gen:b,compositeRule:v,allErrors:P}=g,R=m(p,h,c);f??(v||P)?l(b,R):u(g,(0,e._)`[${R}]`)}o.reportError=n;function i(p,h=o.keywordError,c){const{it:f}=p,{gen:g,compositeRule:b,allErrors:v}=f,P=m(p,h,c);l(g,P),b||v||u(f,r.default.vErrors)}o.reportExtraError=i;function s(p,h){p.assign(r.default.errors,h),p.if((0,e._)`${r.default.vErrors} !== null`,()=>p.if(h,()=>p.assign((0,e._)`${r.default.vErrors}.length`,h),()=>p.assign(r.default.vErrors,null)))}o.resetErrorsCount=s;function a({gen:p,keyword:h,schemaValue:c,data:f,errsCount:g,it:b}){if(g===void 0)throw new Error("ajv implementation error");const v=p.name("err");p.forRange("i",g,r.default.errors,P=>{p.const(v,(0,e._)`${r.default.vErrors}[${P}]`),p.if((0,e._)`${v}.instancePath === undefined`,()=>p.assign((0,e._)`${v}.instancePath`,(0,e.strConcat)(r.default.instancePath,b.errorPath))),p.assign((0,e._)`${v}.schemaPath`,(0,e.str)`${b.errSchemaPath}/${h}`),b.opts.verbose&&(p.assign((0,e._)`${v}.schema`,c),p.assign((0,e._)`${v}.data`,f))})}o.extendErrors=a;function l(p,h){const c=p.const("err",h);p.if((0,e._)`${r.default.vErrors} === null`,()=>p.assign(r.default.vErrors,(0,e._)`[${c}]`),(0,e._)`${r.default.vErrors}.push(${c})`),p.code((0,e._)`${r.default.errors}++`)}function u(p,h){const{gen:c,validateName:f,schemaEnv:g}=p;g.$async?c.throw((0,e._)`new ${p.ValidationError}(${h})`):(c.assign((0,e._)`${f}.errors`,h),c.return(!1))}const d={keyword:new e.Name("keyword"),schemaPath:new e.Name("schemaPath"),params:new e.Name("params"),propertyName:new e.Name("propertyName"),message:new e.Name("message"),schema:new e.Name("schema"),parentSchema:new e.Name("parentSchema")};function m(p,h,c){const{createErrors:f}=p.it;return f===!1?(0,e._)`{}`:$(p,h,c)}function $(p,h,c={}){const{gen:f,it:g}=p,b=[_(g,c),E(p,c)];return w(p,h,b),f.object(...b)}function _({errorPath:p},{instancePath:h}){const c=h?(0,e.str)`${p}${(0,t.getErrorPath)(h,t.Type.Str)}`:p;return[r.default.instancePath,(0,e.strConcat)(r.default.instancePath,c)]}function E({keyword:p,it:{errSchemaPath:h}},{schemaPath:c,parentSchema:f}){let g=f?h:(0,e.str)`${h}/${p}`;return c&&(g=(0,e.str)`${g}${(0,t.getErrorPath)(c,t.Type.Str)}`),[d.schemaPath,g]}function w(p,{params:h,message:c},f){const{keyword:g,data:b,schemaValue:v,it:P}=p,{opts:R,propertyName:O,topSchemaRef:q,schemaPath:V}=P;f.push([d.keyword,g],[d.params,typeof h=="function"?h(p):h||(0,e._)`{}`]),R.messages&&f.push([d.message,typeof c=="function"?c(p):c]),R.verbose&&f.push([d.schema,v],[d.parentSchema,(0,e._)`${q}${V}`],[r.default.data,b]),O&&f.push([d.propertyName,O])}})(Ot)),Ot}var cr;function Dn(){if(cr)return Se;cr=1,Object.defineProperty(Se,"__esModule",{value:!0}),Se.boolOrEmptySchema=Se.topBoolOrEmptySchema=void 0;const o=Ge(),e=Y(),t=be(),r={message:"boolean schema is false"};function n(a){const{gen:l,schema:u,validateName:d}=a;u===!1?s(a,!1):typeof u=="object"&&u.$async===!0?l.return(t.default.data):(l.assign((0,e._)`${d}.errors`,null),l.return(!0))}Se.topBoolOrEmptySchema=n;function i(a,l){const{gen:u,schema:d}=a;d===!1?(u.var(l,!1),s(a)):u.var(l,!0)}Se.boolOrEmptySchema=i;function s(a,l){const{gen:u,data:d}=a,m={gen:u,keyword:"false schema",data:d,schema:!1,schemaCode:!1,schemaValue:!1,params:{},it:a};(0,o.reportError)(m,r,void 0,l)}return Se}var se={},Ee={},lr;function ur(){if(lr)return Ee;lr=1,Object.defineProperty(Ee,"__esModule",{value:!0}),Ee.getRules=Ee.isJSONType=void 0;const o=["string","number","integer","boolean","null","object","array"],e=new Set(o);function t(n){return typeof n=="string"&&e.has(n)}Ee.isJSONType=t;function r(){const n={number:{type:"number",rules:[]},string:{type:"string",rules:[]},array:{type:"array",rules:[]},object:{type:"object",rules:[]}};return{types:{...n,integer:!0,boolean:!0,null:!0},rules:[{rules:[]},n.number,n.string,n.array,n.object],post:{rules:[]},all:{},keywords:{}}}return Ee.getRules=r,Ee}var ge={},dr;function hr(){if(dr)return ge;dr=1,Object.defineProperty(ge,"__esModule",{value:!0}),ge.shouldUseRule=ge.shouldUseGroup=ge.schemaHasRulesForType=void 0;function o({schema:r,self:n},i){const s=n.RULES.types[i];return s&&s!==!0&&e(r,s)}ge.schemaHasRulesForType=o;function e(r,n){return n.rules.some(i=>t(r,i))}ge.shouldUseGroup=e;function t(r,n){var i;return r[n.keyword]!==void 0||((i=n.definition.implements)===null||i===void 0?void 0:i.some(s=>r[s]!==void 0))}return ge.shouldUseRule=t,ge}var fr;function Ke(){if(fr)return se;fr=1,Object.defineProperty(se,"__esModule",{value:!0}),se.reportTypeError=se.checkDataTypes=se.checkDataType=se.coerceAndCheckDataType=se.getJSONTypes=se.getSchemaTypes=se.DataType=void 0;const o=ur(),e=hr(),t=Ge(),r=Y(),n=ee();var i;(function(c){c[c.Correct=0]="Correct",c[c.Wrong=1]="Wrong"})(i||(se.DataType=i={}));function s(c){const f=a(c.type);if(f.includes("null")){if(c.nullable===!1)throw new Error("type: null contradicts nullable: false")}else{if(!f.length&&c.nullable!==void 0)throw new Error('"nullable" cannot be used without "type"');c.nullable===!0&&f.push("null")}return f}se.getSchemaTypes=s;function a(c){const f=Array.isArray(c)?c:c?[c]:[];if(f.every(o.isJSONType))return f;throw new Error("type must be JSONType or JSONType[]: "+f.join(","))}se.getJSONTypes=a;function l(c,f){const{gen:g,data:b,opts:v}=c,P=d(f,v.coerceTypes),R=f.length>0&&!(P.length===0&&f.length===1&&(0,e.schemaHasRulesForType)(c,f[0]));if(R){const O=E(f,b,v.strictNumbers,i.Wrong);g.if(O,()=>{P.length?m(c,f,P):p(c)})}return R}se.coerceAndCheckDataType=l;const u=new Set(["string","number","integer","boolean","null"]);function d(c,f){return f?c.filter(g=>u.has(g)||f==="array"&&g==="array"):[]}function m(c,f,g){const{gen:b,data:v,opts:P}=c,R=b.let("dataType",(0,r._)`typeof ${v}`),O=b.let("coerced",(0,r._)`undefined`);P.coerceTypes==="array"&&b.if((0,r._)`${R} == 'object' && Array.isArray(${v}) && ${v}.length == 1`,()=>b.assign(v,(0,r._)`${v}[0]`).assign(R,(0,r._)`typeof ${v}`).if(E(f,v,P.strictNumbers),()=>b.assign(O,v))),b.if((0,r._)`${O} !== undefined`);for(const V of g)(u.has(V)||V==="array"&&P.coerceTypes==="array")&&q(V);b.else(),p(c),b.endIf(),b.if((0,r._)`${O} !== undefined`,()=>{b.assign(v,O),$(c,O)});function q(V){switch(V){case"string":b.elseIf((0,r._)`${R} == "number" || ${R} == "boolean"`).assign(O,(0,r._)`"" + ${v}`).elseIf((0,r._)`${v} === null`).assign(O,(0,r._)`""`);return;case"number":b.elseIf((0,r._)`${R} == "boolean" || ${v} === null
              || (${R} == "string" && ${v} && ${v} == +${v})`).assign(O,(0,r._)`+${v}`);return;case"integer":b.elseIf((0,r._)`${R} === "boolean" || ${v} === null
              || (${R} === "string" && ${v} && ${v} == +${v} && !(${v} % 1))`).assign(O,(0,r._)`+${v}`);return;case"boolean":b.elseIf((0,r._)`${v} === "false" || ${v} === 0 || ${v} === null`).assign(O,!1).elseIf((0,r._)`${v} === "true" || ${v} === 1`).assign(O,!0);return;case"null":b.elseIf((0,r._)`${v} === "" || ${v} === 0 || ${v} === false`),b.assign(O,null);return;case"array":b.elseIf((0,r._)`${R} === "string" || ${R} === "number"
              || ${R} === "boolean" || ${v} === null`).assign(O,(0,r._)`[${v}]`)}}}function $({gen:c,parentData:f,parentDataProperty:g},b){c.if((0,r._)`${f} !== undefined`,()=>c.assign((0,r._)`${f}[${g}]`,b))}function _(c,f,g,b=i.Correct){const v=b===i.Correct?r.operators.EQ:r.operators.NEQ;let P;switch(c){case"null":return(0,r._)`${f} ${v} null`;case"array":P=(0,r._)`Array.isArray(${f})`;break;case"object":P=(0,r._)`${f} && typeof ${f} == "object" && !Array.isArray(${f})`;break;case"integer":P=R((0,r._)`!(${f} % 1) && !isNaN(${f})`);break;case"number":P=R();break;default:return(0,r._)`typeof ${f} ${v} ${c}`}return b===i.Correct?P:(0,r.not)(P);function R(O=r.nil){return(0,r.and)((0,r._)`typeof ${f} == "number"`,O,g?(0,r._)`isFinite(${f})`:r.nil)}}se.checkDataType=_;function E(c,f,g,b){if(c.length===1)return _(c[0],f,g,b);let v;const P=(0,n.toHash)(c);if(P.array&&P.object){const R=(0,r._)`typeof ${f} != "object"`;v=P.null?R:(0,r._)`!${f} || ${R}`,delete P.null,delete P.array,delete P.object}else v=r.nil;P.number&&delete P.integer;for(const R in P)v=(0,r.and)(v,_(R,f,g,b));return v}se.checkDataTypes=E;const w={message:({schema:c})=>`must be ${c}`,params:({schema:c,schemaValue:f})=>typeof c=="string"?(0,r._)`{type: ${c}}`:(0,r._)`{type: ${f}}`};function p(c){const f=h(c);(0,t.reportError)(f,w)}se.reportTypeError=p;function h(c){const{gen:f,data:g,schema:b}=c,v=(0,n.schemaRefOrVal)(c,b,"type");return{gen:f,keyword:"type",data:g,schema:b.type,schemaCode:v,schemaValue:v,parentSchema:b,params:{},it:c}}return se}var Oe={},pr;function Vn(){if(pr)return Oe;pr=1,Object.defineProperty(Oe,"__esModule",{value:!0}),Oe.assignDefaults=void 0;const o=Y(),e=ee();function t(n,i){const{properties:s,items:a}=n.schema;if(i==="object"&&s)for(const l in s)r(n,l,s[l].default);else i==="array"&&Array.isArray(a)&&a.forEach((l,u)=>r(n,u,l.default))}Oe.assignDefaults=t;function r(n,i,s){const{gen:a,compositeRule:l,data:u,opts:d}=n;if(s===void 0)return;const m=(0,o._)`${u}${(0,o.getProperty)(i)}`;if(l){(0,e.checkStrictMode)(n,`default is ignored for: ${m}`);return}let $=(0,o._)`${m} === undefined`;d.useDefaults==="empty"&&($=(0,o._)`${$} || ${m} === null || ${m} === ""`),a.if($,(0,o._)`${m} = ${(0,o.stringify)(s)}`)}return Oe}var pe={},te={},mr;function me(){if(mr)return te;mr=1,Object.defineProperty(te,"__esModule",{value:!0}),te.validateUnion=te.validateArray=te.usePattern=te.callValidateCode=te.schemaProperties=te.allSchemaProperties=te.noPropertyInData=te.propertyInData=te.isOwnProperty=te.hasPropFunc=te.reportMissingProp=te.checkMissingProp=te.checkReportMissingProp=void 0;const o=Y(),e=ee(),t=be(),r=ee();function n(c,f){const{gen:g,data:b,it:v}=c;g.if(d(g,b,f,v.opts.ownProperties),()=>{c.setParams({missingProperty:(0,o._)`${f}`},!0),c.error()})}te.checkReportMissingProp=n;function i({gen:c,data:f,it:{opts:g}},b,v){return(0,o.or)(...b.map(P=>(0,o.and)(d(c,f,P,g.ownProperties),(0,o._)`${v} = ${P}`)))}te.checkMissingProp=i;function s(c,f){c.setParams({missingProperty:f},!0),c.error()}te.reportMissingProp=s;function a(c){return c.scopeValue("func",{ref:Object.prototype.hasOwnProperty,code:(0,o._)`Object.prototype.hasOwnProperty`})}te.hasPropFunc=a;function l(c,f,g){return(0,o._)`${a(c)}.call(${f}, ${g})`}te.isOwnProperty=l;function u(c,f,g,b){const v=(0,o._)`${f}${(0,o.getProperty)(g)} !== undefined`;return b?(0,o._)`${v} && ${l(c,f,g)}`:v}te.propertyInData=u;function d(c,f,g,b){const v=(0,o._)`${f}${(0,o.getProperty)(g)} === undefined`;return b?(0,o.or)(v,(0,o.not)(l(c,f,g))):v}te.noPropertyInData=d;function m(c){return c?Object.keys(c).filter(f=>f!=="__proto__"):[]}te.allSchemaProperties=m;function $(c,f){return m(f).filter(g=>!(0,e.alwaysValidSchema)(c,f[g]))}te.schemaProperties=$;function _({schemaCode:c,data:f,it:{gen:g,topSchemaRef:b,schemaPath:v,errorPath:P},it:R},O,q,V){const H=V?(0,o._)`${c}, ${f}, ${b}${v}`:f,U=[[t.default.instancePath,(0,o.strConcat)(t.default.instancePath,P)],[t.default.parentData,R.parentData],[t.default.parentDataProperty,R.parentDataProperty],[t.default.rootData,t.default.rootData]];R.opts.dynamicRef&&U.push([t.default.dynamicAnchors,t.default.dynamicAnchors]);const X=(0,o._)`${H}, ${g.object(...U)}`;return q!==o.nil?(0,o._)`${O}.call(${q}, ${X})`:(0,o._)`${O}(${X})`}te.callValidateCode=_;const E=(0,o._)`new RegExp`;function w({gen:c,it:{opts:f}},g){const b=f.unicodeRegExp?"u":"",{regExp:v}=f.code,P=v(g,b);return c.scopeValue("pattern",{key:P.toString(),ref:P,code:(0,o._)`${v.code==="new RegExp"?E:(0,r.useFunc)(c,v)}(${g}, ${b})`})}te.usePattern=w;function p(c){const{gen:f,data:g,keyword:b,it:v}=c,P=f.name("valid");if(v.allErrors){const O=f.let("valid",!0);return R(()=>f.assign(O,!1)),O}return f.var(P,!0),R(()=>f.break()),P;function R(O){const q=f.const("len",(0,o._)`${g}.length`);f.forRange("i",0,q,V=>{c.subschema({keyword:b,dataProp:V,dataPropType:e.Type.Num},P),f.if((0,o.not)(P),O)})}}te.validateArray=p;function h(c){const{gen:f,schema:g,keyword:b,it:v}=c;if(!Array.isArray(g))throw new Error("ajv implementation error");if(g.some(q=>(0,e.alwaysValidSchema)(v,q))&&!v.opts.unevaluated)return;const R=f.let("valid",!1),O=f.name("_valid");f.block(()=>g.forEach((q,V)=>{const H=c.subschema({keyword:b,schemaProp:V,compositeRule:!0},O);f.assign(R,(0,o._)`${R} || ${O}`),c.mergeValidEvaluated(H,O)||f.if((0,o.not)(R))})),c.result(R,()=>c.reset(),()=>c.error(!0))}return te.validateUnion=h,te}var yr;function zn(){if(yr)return pe;yr=1,Object.defineProperty(pe,"__esModule",{value:!0}),pe.validateKeywordUsage=pe.validSchemaType=pe.funcKeywordCode=pe.macroKeywordCode=void 0;const o=Y(),e=be(),t=me(),r=Ge();function n($,_){const{gen:E,keyword:w,schema:p,parentSchema:h,it:c}=$,f=_.macro.call(c.self,p,h,c),g=u(E,w,f);c.opts.validateSchema!==!1&&c.self.validateSchema(f,!0);const b=E.name("valid");$.subschema({schema:f,schemaPath:o.nil,errSchemaPath:`${c.errSchemaPath}/${w}`,topSchemaRef:g,compositeRule:!0},b),$.pass(b,()=>$.error(!0))}pe.macroKeywordCode=n;function i($,_){var E;const{gen:w,keyword:p,schema:h,parentSchema:c,$data:f,it:g}=$;l(g,_);const b=!f&&_.compile?_.compile.call(g.self,h,c,g):_.validate,v=u(w,p,b),P=w.let("valid");$.block$data(P,R),$.ok((E=_.valid)!==null&&E!==void 0?E:P);function R(){if(_.errors===!1)V(),_.modifying&&s($),H(()=>$.error());else{const U=_.async?O():q();_.modifying&&s($),H(()=>a($,U))}}function O(){const U=w.let("ruleErrs",null);return w.try(()=>V((0,o._)`await `),X=>w.assign(P,!1).if((0,o._)`${X} instanceof ${g.ValidationError}`,()=>w.assign(U,(0,o._)`${X}.errors`),()=>w.throw(X))),U}function q(){const U=(0,o._)`${v}.errors`;return w.assign(U,null),V(o.nil),U}function V(U=_.async?(0,o._)`await `:o.nil){const X=g.opts.passContext?e.default.this:e.default.self,ne=!("compile"in _&&!f||_.schema===!1);w.assign(P,(0,o._)`${U}${(0,t.callValidateCode)($,v,X,ne)}`,_.modifying)}function H(U){var X;w.if((0,o.not)((X=_.valid)!==null&&X!==void 0?X:P),U)}}pe.funcKeywordCode=i;function s($){const{gen:_,data:E,it:w}=$;_.if(w.parentData,()=>_.assign(E,(0,o._)`${w.parentData}[${w.parentDataProperty}]`))}function a($,_){const{gen:E}=$;E.if((0,o._)`Array.isArray(${_})`,()=>{E.assign(e.default.vErrors,(0,o._)`${e.default.vErrors} === null ? ${_} : ${e.default.vErrors}.concat(${_})`).assign(e.default.errors,(0,o._)`${e.default.vErrors}.length`),(0,r.extendErrors)($)},()=>$.error())}function l({schemaEnv:$},_){if(_.async&&!$.$async)throw new Error("async keyword in sync schema")}function u($,_,E){if(E===void 0)throw new Error(`keyword "${_}" failed to compile`);return $.scopeValue("keyword",typeof E=="function"?{ref:E}:{ref:E,code:(0,o.stringify)(E)})}function d($,_,E=!1){return!_.length||_.some(w=>w==="array"?Array.isArray($):w==="object"?$&&typeof $=="object"&&!Array.isArray($):typeof $==w||E&&typeof $>"u")}pe.validSchemaType=d;function m({schema:$,opts:_,self:E,errSchemaPath:w},p,h){if(Array.isArray(p.keyword)?!p.keyword.includes(h):p.keyword!==h)throw new Error("ajv implementation error");const c=p.dependencies;if(c?.some(f=>!Object.prototype.hasOwnProperty.call($,f)))throw new Error(`parent schema must have dependencies of ${h}: ${c.join(",")}`);if(p.validateSchema&&!p.validateSchema($[h])){const g=`keyword "${h}" value is invalid at path "${w}": `+E.errorsText(p.validateSchema.errors);if(_.validateSchema==="log")E.logger.error(g);else throw new Error(g)}}return pe.validateKeywordUsage=m,pe}var ve={},gr;function Fn(){if(gr)return ve;gr=1,Object.defineProperty(ve,"__esModule",{value:!0}),ve.extendSubschemaMode=ve.extendSubschemaData=ve.getSubschema=void 0;const o=Y(),e=ee();function t(i,{keyword:s,schemaProp:a,schema:l,schemaPath:u,errSchemaPath:d,topSchemaRef:m}){if(s!==void 0&&l!==void 0)throw new Error('both "keyword" and "schema" passed, only one allowed');if(s!==void 0){const $=i.schema[s];return a===void 0?{schema:$,schemaPath:(0,o._)`${i.schemaPath}${(0,o.getProperty)(s)}`,errSchemaPath:`${i.errSchemaPath}/${s}`}:{schema:$[a],schemaPath:(0,o._)`${i.schemaPath}${(0,o.getProperty)(s)}${(0,o.getProperty)(a)}`,errSchemaPath:`${i.errSchemaPath}/${s}/${(0,e.escapeFragment)(a)}`}}if(l!==void 0){if(u===void 0||d===void 0||m===void 0)throw new Error('"schemaPath", "errSchemaPath" and "topSchemaRef" are required with "schema"');return{schema:l,schemaPath:u,topSchemaRef:m,errSchemaPath:d}}throw new Error('either "keyword" or "schema" must be passed')}ve.getSubschema=t;function r(i,s,{dataProp:a,dataPropType:l,data:u,dataTypes:d,propertyName:m}){if(u!==void 0&&a!==void 0)throw new Error('both "data" and "dataProp" passed, only one allowed');const{gen:$}=s;if(a!==void 0){const{errorPath:E,dataPathArr:w,opts:p}=s,h=$.let("data",(0,o._)`${s.data}${(0,o.getProperty)(a)}`,!0);_(h),i.errorPath=(0,o.str)`${E}${(0,e.getErrorPath)(a,l,p.jsPropertySyntax)}`,i.parentDataProperty=(0,o._)`${a}`,i.dataPathArr=[...w,i.parentDataProperty]}if(u!==void 0){const E=u instanceof o.Name?u:$.let("data",u,!0);_(E),m!==void 0&&(i.propertyName=m)}d&&(i.dataTypes=d);function _(E){i.data=E,i.dataLevel=s.dataLevel+1,i.dataTypes=[],s.definedProperties=new Set,i.parentData=s.data,i.dataNames=[...s.dataNames,E]}}ve.extendSubschemaData=r;function n(i,{jtdDiscriminator:s,jtdMetadata:a,compositeRule:l,createErrors:u,allErrors:d}){l!==void 0&&(i.compositeRule=l),u!==void 0&&(i.createErrors=u),d!==void 0&&(i.allErrors=d),i.jtdDiscriminator=s,i.jtdMetadata=a}return ve.extendSubschemaMode=n,ve}var le={},Dt,vr;function br(){return vr||(vr=1,Dt=function o(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var r,n,i;if(Array.isArray(e)){if(r=e.length,r!=t.length)return!1;for(n=r;n--!==0;)if(!o(e[n],t[n]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();if(i=Object.keys(e),r=i.length,r!==Object.keys(t).length)return!1;for(n=r;n--!==0;)if(!Object.prototype.hasOwnProperty.call(t,i[n]))return!1;for(n=r;n--!==0;){var s=i[n];if(!o(e[s],t[s]))return!1}return!0}return e!==e&&t!==t}),Dt}var Vt={exports:{}},wr;function Ln(){if(wr)return Vt.exports;wr=1;var o=Vt.exports=function(r,n,i){typeof n=="function"&&(i=n,n={}),i=n.cb||i;var s=typeof i=="function"?i:i.pre||function(){},a=i.post||function(){};e(n,s,a,r,"",r)};o.keywords={additionalItems:!0,items:!0,contains:!0,additionalProperties:!0,propertyNames:!0,not:!0,if:!0,then:!0,else:!0},o.arrayKeywords={items:!0,allOf:!0,anyOf:!0,oneOf:!0},o.propsKeywords={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependencies:!0},o.skipKeywords={default:!0,enum:!0,const:!0,required:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};function e(r,n,i,s,a,l,u,d,m,$){if(s&&typeof s=="object"&&!Array.isArray(s)){n(s,a,l,u,d,m,$);for(var _ in s){var E=s[_];if(Array.isArray(E)){if(_ in o.arrayKeywords)for(var w=0;w<E.length;w++)e(r,n,i,E[w],a+"/"+_+"/"+w,l,a,_,s,w)}else if(_ in o.propsKeywords){if(E&&typeof E=="object")for(var p in E)e(r,n,i,E[p],a+"/"+_+"/"+t(p),l,a,_,s,p)}else(_ in o.keywords||r.allKeys&&!(_ in o.skipKeywords))&&e(r,n,i,E,a+"/"+_,l,a,_,s)}i(s,a,l,u,d,m,$)}}function t(r){return r.replace(/~/g,"~0").replace(/\//g,"~1")}return Vt.exports}var $r;function He(){if($r)return le;$r=1,Object.defineProperty(le,"__esModule",{value:!0}),le.getSchemaRefs=le.resolveUrl=le.normalizeId=le._getFullPath=le.getFullPath=le.inlineRef=void 0;const o=ee(),e=br(),t=Ln(),r=new Set(["type","format","pattern","maxLength","minLength","maxProperties","minProperties","maxItems","minItems","maximum","minimum","uniqueItems","multipleOf","required","enum","const"]);function n(w,p=!0){return typeof w=="boolean"?!0:p===!0?!s(w):p?a(w)<=p:!1}le.inlineRef=n;const i=new Set(["$ref","$recursiveRef","$recursiveAnchor","$dynamicRef","$dynamicAnchor"]);function s(w){for(const p in w){if(i.has(p))return!0;const h=w[p];if(Array.isArray(h)&&h.some(s)||typeof h=="object"&&s(h))return!0}return!1}function a(w){let p=0;for(const h in w){if(h==="$ref")return 1/0;if(p++,!r.has(h)&&(typeof w[h]=="object"&&(0,o.eachItem)(w[h],c=>p+=a(c)),p===1/0))return 1/0}return p}function l(w,p="",h){h!==!1&&(p=m(p));const c=w.parse(p);return u(w,c)}le.getFullPath=l;function u(w,p){return w.serialize(p).split("#")[0]+"#"}le._getFullPath=u;const d=/#\/?$/;function m(w){return w?w.replace(d,""):""}le.normalizeId=m;function $(w,p,h){return h=m(h),w.resolve(p,h)}le.resolveUrl=$;const _=/^[a-z_][-a-z0-9._]*$/i;function E(w,p){if(typeof w=="boolean")return{};const{schemaId:h,uriResolver:c}=this.opts,f=m(w[h]||p),g={"":f},b=l(c,f,!1),v={},P=new Set;return t(w,{allKeys:!0},(q,V,H,U)=>{if(U===void 0)return;const X=b+V;let ne=g[U];typeof q[h]=="string"&&(ne=ue.call(this,q[h])),he.call(this,q.$anchor),he.call(this,q.$dynamicAnchor),g[V]=ne;function ue(D){const ce=this.opts.uriResolver.resolve;if(D=m(ne?ce(ne,D):D),P.has(D))throw O(D);P.add(D);let I=this.refs[D];return typeof I=="string"&&(I=this.refs[I]),typeof I=="object"?R(q,I.schema,D):D!==m(X)&&(D[0]==="#"?(R(q,v[D],D),v[D]=q):this.refs[D]=X),D}function he(D){if(typeof D=="string"){if(!_.test(D))throw new Error(`invalid anchor "${D}"`);ue.call(this,`#${D}`)}}}),v;function R(q,V,H){if(V!==void 0&&!e(q,V))throw O(H)}function O(q){return new Error(`reference "${q}" resolves to more than one schema`)}}return le.getSchemaRefs=E,le}var _r;function Be(){if(_r)return ye;_r=1,Object.defineProperty(ye,"__esModule",{value:!0}),ye.getData=ye.KeywordCxt=ye.validateFunctionCode=void 0;const o=Dn(),e=Ke(),t=hr(),r=Ke(),n=Vn(),i=zn(),s=Fn(),a=Y(),l=be(),u=He(),d=ee(),m=Ge();function $(M){if(b(M)&&(P(M),g(M))){p(M);return}_(M,()=>(0,o.topBoolOrEmptySchema)(M))}ye.validateFunctionCode=$;function _({gen:M,validateName:T,schema:N,schemaEnv:C,opts:L},K){L.code.es5?M.func(T,(0,a._)`${l.default.data}, ${l.default.valCxt}`,C.$async,()=>{M.code((0,a._)`"use strict"; ${c(N,L)}`),w(M,L),M.code(K)}):M.func(T,(0,a._)`${l.default.data}, ${E(L)}`,C.$async,()=>M.code(c(N,L)).code(K))}function E(M){return(0,a._)`{${l.default.instancePath}="", ${l.default.parentData}, ${l.default.parentDataProperty}, ${l.default.rootData}=${l.default.data}${M.dynamicRef?(0,a._)`, ${l.default.dynamicAnchors}={}`:a.nil}}={}`}function w(M,T){M.if(l.default.valCxt,()=>{M.var(l.default.instancePath,(0,a._)`${l.default.valCxt}.${l.default.instancePath}`),M.var(l.default.parentData,(0,a._)`${l.default.valCxt}.${l.default.parentData}`),M.var(l.default.parentDataProperty,(0,a._)`${l.default.valCxt}.${l.default.parentDataProperty}`),M.var(l.default.rootData,(0,a._)`${l.default.valCxt}.${l.default.rootData}`),T.dynamicRef&&M.var(l.default.dynamicAnchors,(0,a._)`${l.default.valCxt}.${l.default.dynamicAnchors}`)},()=>{M.var(l.default.instancePath,(0,a._)`""`),M.var(l.default.parentData,(0,a._)`undefined`),M.var(l.default.parentDataProperty,(0,a._)`undefined`),M.var(l.default.rootData,l.default.data),T.dynamicRef&&M.var(l.default.dynamicAnchors,(0,a._)`{}`)})}function p(M){const{schema:T,opts:N,gen:C}=M;_(M,()=>{N.$comment&&T.$comment&&U(M),q(M),C.let(l.default.vErrors,null),C.let(l.default.errors,0),N.unevaluated&&h(M),R(M),X(M)})}function h(M){const{gen:T,validateName:N}=M;M.evaluated=T.const("evaluated",(0,a._)`${N}.evaluated`),T.if((0,a._)`${M.evaluated}.dynamicProps`,()=>T.assign((0,a._)`${M.evaluated}.props`,(0,a._)`undefined`)),T.if((0,a._)`${M.evaluated}.dynamicItems`,()=>T.assign((0,a._)`${M.evaluated}.items`,(0,a._)`undefined`))}function c(M,T){const N=typeof M=="object"&&M[T.schemaId];return N&&(T.code.source||T.code.process)?(0,a._)`/*# sourceURL=${N} */`:a.nil}function f(M,T){if(b(M)&&(P(M),g(M))){v(M,T);return}(0,o.boolOrEmptySchema)(M,T)}function g({schema:M,self:T}){if(typeof M=="boolean")return!M;for(const N in M)if(T.RULES.all[N])return!0;return!1}function b(M){return typeof M.schema!="boolean"}function v(M,T){const{schema:N,gen:C,opts:L}=M;L.$comment&&N.$comment&&U(M),V(M),H(M);const K=C.const("_errs",l.default.errors);R(M,K),C.var(T,(0,a._)`${K} === ${l.default.errors}`)}function P(M){(0,d.checkUnknownRules)(M),O(M)}function R(M,T){if(M.opts.jtd)return ue(M,[],!1,T);const N=(0,e.getSchemaTypes)(M.schema),C=(0,e.coerceAndCheckDataType)(M,N);ue(M,N,!C,T)}function O(M){const{schema:T,errSchemaPath:N,opts:C,self:L}=M;T.$ref&&C.ignoreKeywordsWithRef&&(0,d.schemaHasRulesButRef)(T,L.RULES)&&L.logger.warn(`$ref: keywords ignored in schema at path "${N}"`)}function q(M){const{schema:T,opts:N}=M;T.default!==void 0&&N.useDefaults&&N.strictSchema&&(0,d.checkStrictMode)(M,"default is ignored in the schema root")}function V(M){const T=M.schema[M.opts.schemaId];T&&(M.baseId=(0,u.resolveUrl)(M.opts.uriResolver,M.baseId,T))}function H(M){if(M.schema.$async&&!M.schemaEnv.$async)throw new Error("async schema in sync schema")}function U({gen:M,schemaEnv:T,schema:N,errSchemaPath:C,opts:L}){const K=N.$comment;if(L.$comment===!0)M.code((0,a._)`${l.default.self}.logger.log(${K})`);else if(typeof L.$comment=="function"){const ie=(0,a.str)`${C}/$comment`,re=M.scopeValue("root",{ref:T.root});M.code((0,a._)`${l.default.self}.opts.$comment(${K}, ${ie}, ${re}.schema)`)}}function X(M){const{gen:T,schemaEnv:N,validateName:C,ValidationError:L,opts:K}=M;N.$async?T.if((0,a._)`${l.default.errors} === 0`,()=>T.return(l.default.data),()=>T.throw((0,a._)`new ${L}(${l.default.vErrors})`)):(T.assign((0,a._)`${C}.errors`,l.default.vErrors),K.unevaluated&&ne(M),T.return((0,a._)`${l.default.errors} === 0`))}function ne({gen:M,evaluated:T,props:N,items:C}){N instanceof a.Name&&M.assign((0,a._)`${T}.props`,N),C instanceof a.Name&&M.assign((0,a._)`${T}.items`,C)}function ue(M,T,N,C){const{gen:L,schema:K,data:ie,allErrors:re,opts:G,self:Q}=M,{RULES:Z}=Q;if(K.$ref&&(G.ignoreKeywordsWithRef||!(0,d.schemaHasRulesButRef)(K,Z))){L.block(()=>z(M,"$ref",Z.all.$ref.definition));return}G.jtd||D(M,T),L.block(()=>{for(const de of Z.rules)ae(de);ae(Z.post)});function ae(de){(0,t.shouldUseGroup)(K,de)&&(de.type?(L.if((0,r.checkDataType)(de.type,ie,G.strictNumbers)),he(M,de),T.length===1&&T[0]===de.type&&N&&(L.else(),(0,r.reportTypeError)(M)),L.endIf()):he(M,de),re||L.if((0,a._)`${l.default.errors} === ${C||0}`))}}function he(M,T){const{gen:N,schema:C,opts:{useDefaults:L}}=M;L&&(0,n.assignDefaults)(M,T.type),N.block(()=>{for(const K of T.rules)(0,t.shouldUseRule)(C,K)&&z(M,K.keyword,K.definition,T.type)})}function D(M,T){M.schemaEnv.meta||!M.opts.strictTypes||(ce(M,T),M.opts.allowUnionTypes||I(M,T),k(M,M.dataTypes))}function ce(M,T){if(T.length){if(!M.dataTypes.length){M.dataTypes=T;return}T.forEach(N=>{x(M.dataTypes,N)||S(M,`type "${N}" not allowed by context "${M.dataTypes.join(",")}"`)}),y(M,T)}}function I(M,T){T.length>1&&!(T.length===2&&T.includes("null"))&&S(M,"use allowUnionTypes to allow union type keyword")}function k(M,T){const N=M.self.RULES.all;for(const C in N){const L=N[C];if(typeof L=="object"&&(0,t.shouldUseRule)(M.schema,L)){const{type:K}=L.definition;K.length&&!K.some(ie=>j(T,ie))&&S(M,`missing type "${K.join(",")}" for keyword "${C}"`)}}}function j(M,T){return M.includes(T)||T==="number"&&M.includes("integer")}function x(M,T){return M.includes(T)||T==="integer"&&M.includes("number")}function y(M,T){const N=[];for(const C of M.dataTypes)x(T,C)?N.push(C):T.includes("integer")&&C==="number"&&N.push("integer");M.dataTypes=N}function S(M,T){const N=M.schemaEnv.baseId+M.errSchemaPath;T+=` at "${N}" (strictTypes)`,(0,d.checkStrictMode)(M,T,M.opts.strictTypes)}class A{constructor(T,N,C){if((0,i.validateKeywordUsage)(T,N,C),this.gen=T.gen,this.allErrors=T.allErrors,this.keyword=C,this.data=T.data,this.schema=T.schema[C],this.$data=N.$data&&T.opts.$data&&this.schema&&this.schema.$data,this.schemaValue=(0,d.schemaRefOrVal)(T,this.schema,C,this.$data),this.schemaType=N.schemaType,this.parentSchema=T.schema,this.params={},this.it=T,this.def=N,this.$data)this.schemaCode=T.gen.const("vSchema",B(this.$data,T));else if(this.schemaCode=this.schemaValue,!(0,i.validSchemaType)(this.schema,N.schemaType,N.allowUndefined))throw new Error(`${C} value must be ${JSON.stringify(N.schemaType)}`);("code"in N?N.trackErrors:N.errors!==!1)&&(this.errsCount=T.gen.const("_errs",l.default.errors))}result(T,N,C){this.failResult((0,a.not)(T),N,C)}failResult(T,N,C){this.gen.if(T),C?C():this.error(),N?(this.gen.else(),N(),this.allErrors&&this.gen.endIf()):this.allErrors?this.gen.endIf():this.gen.else()}pass(T,N){this.failResult((0,a.not)(T),void 0,N)}fail(T){if(T===void 0){this.error(),this.allErrors||this.gen.if(!1);return}this.gen.if(T),this.error(),this.allErrors?this.gen.endIf():this.gen.else()}fail$data(T){if(!this.$data)return this.fail(T);const{schemaCode:N}=this;this.fail((0,a._)`${N} !== undefined && (${(0,a.or)(this.invalid$data(),T)})`)}error(T,N,C){if(N){this.setParams(N),this._error(T,C),this.setParams({});return}this._error(T,C)}_error(T,N){(T?m.reportExtraError:m.reportError)(this,this.def.error,N)}$dataError(){(0,m.reportError)(this,this.def.$dataError||m.keyword$DataError)}reset(){if(this.errsCount===void 0)throw new Error('add "trackErrors" to keyword definition');(0,m.resetErrorsCount)(this.gen,this.errsCount)}ok(T){this.allErrors||this.gen.if(T)}setParams(T,N){N?Object.assign(this.params,T):this.params=T}block$data(T,N,C=a.nil){this.gen.block(()=>{this.check$data(T,C),N()})}check$data(T=a.nil,N=a.nil){if(!this.$data)return;const{gen:C,schemaCode:L,schemaType:K,def:ie}=this;C.if((0,a.or)((0,a._)`${L} === undefined`,N)),T!==a.nil&&C.assign(T,!0),(K.length||ie.validateSchema)&&(C.elseIf(this.invalid$data()),this.$dataError(),T!==a.nil&&C.assign(T,!1)),C.else()}invalid$data(){const{gen:T,schemaCode:N,schemaType:C,def:L,it:K}=this;return(0,a.or)(ie(),re());function ie(){if(C.length){if(!(N instanceof a.Name))throw new Error("ajv implementation error");const G=Array.isArray(C)?C:[C];return(0,a._)`${(0,r.checkDataTypes)(G,N,K.opts.strictNumbers,r.DataType.Wrong)}`}return a.nil}function re(){if(L.validateSchema){const G=T.scopeValue("validate$data",{ref:L.validateSchema});return(0,a._)`!${G}(${N})`}return a.nil}}subschema(T,N){const C=(0,s.getSubschema)(this.it,T);(0,s.extendSubschemaData)(C,this.it,T),(0,s.extendSubschemaMode)(C,T);const L={...this.it,...C,items:void 0,props:void 0};return f(L,N),L}mergeEvaluated(T,N){const{it:C,gen:L}=this;C.opts.unevaluated&&(C.props!==!0&&T.props!==void 0&&(C.props=d.mergeEvaluated.props(L,T.props,C.props,N)),C.items!==!0&&T.items!==void 0&&(C.items=d.mergeEvaluated.items(L,T.items,C.items,N)))}mergeValidEvaluated(T,N){const{it:C,gen:L}=this;if(C.opts.unevaluated&&(C.props!==!0||C.items!==!0))return L.if(N,()=>this.mergeEvaluated(T,a.Name)),!0}}ye.KeywordCxt=A;function z(M,T,N,C){const L=new A(M,N,T);"code"in N?N.code(L,C):L.$data&&N.validate?(0,i.funcKeywordCode)(L,N):"macro"in N?(0,i.macroKeywordCode)(L,N):(N.compile||N.validate)&&(0,i.funcKeywordCode)(L,N)}const F=/^\/(?:[^~]|~0|~1)*$/,J=/^([0-9]+)(#|\/(?:[^~]|~0|~1)*)?$/;function B(M,{dataLevel:T,dataNames:N,dataPathArr:C}){let L,K;if(M==="")return l.default.rootData;if(M[0]==="/"){if(!F.test(M))throw new Error(`Invalid JSON-pointer: ${M}`);L=M,K=l.default.rootData}else{const Q=J.exec(M);if(!Q)throw new Error(`Invalid JSON-pointer: ${M}`);const Z=+Q[1];if(L=Q[2],L==="#"){if(Z>=T)throw new Error(G("property/index",Z));return C[T-Z]}if(Z>T)throw new Error(G("data",Z));if(K=N[T-Z],!L)return K}let ie=K;const re=L.split("/");for(const Q of re)Q&&(K=(0,a._)`${K}${(0,a.getProperty)((0,d.unescapeJsonPointer)(Q))}`,ie=(0,a._)`${ie} && ${K}`);return ie;function G(Q,Z){return`Cannot access ${Q} ${Z} levels up, current level is ${T}`}}return ye.getData=B,ye}var We={},Pr;function zt(){if(Pr)return We;Pr=1,Object.defineProperty(We,"__esModule",{value:!0});class o extends Error{constructor(t){super("validation failed"),this.errors=t,this.ajv=this.validation=!0}}return We.default=o,We}var Je={},Sr;function Ye(){if(Sr)return Je;Sr=1,Object.defineProperty(Je,"__esModule",{value:!0});const o=He();class e extends Error{constructor(r,n,i,s){super(s||`can't resolve reference ${i} from id ${n}`),this.missingRef=(0,o.resolveUrl)(r,n,i),this.missingSchema=(0,o.normalizeId)((0,o.getFullPath)(r,this.missingRef))}}return Je.default=e,Je}var fe={},Er;function Ft(){if(Er)return fe;Er=1,Object.defineProperty(fe,"__esModule",{value:!0}),fe.resolveSchema=fe.getCompilingSchema=fe.resolveRef=fe.compileSchema=fe.SchemaEnv=void 0;const o=Y(),e=zt(),t=be(),r=He(),n=ee(),i=Be();class s{constructor(h){var c;this.refs={},this.dynamicAnchors={};let f;typeof h.schema=="object"&&(f=h.schema),this.schema=h.schema,this.schemaId=h.schemaId,this.root=h.root||this,this.baseId=(c=h.baseId)!==null&&c!==void 0?c:(0,r.normalizeId)(f?.[h.schemaId||"$id"]),this.schemaPath=h.schemaPath,this.localRefs=h.localRefs,this.meta=h.meta,this.$async=f?.$async,this.refs={}}}fe.SchemaEnv=s;function a(p){const h=d.call(this,p);if(h)return h;const c=(0,r.getFullPath)(this.opts.uriResolver,p.root.baseId),{es5:f,lines:g}=this.opts.code,{ownProperties:b}=this.opts,v=new o.CodeGen(this.scope,{es5:f,lines:g,ownProperties:b});let P;p.$async&&(P=v.scopeValue("Error",{ref:e.default,code:(0,o._)`require("ajv/dist/runtime/validation_error").default`}));const R=v.scopeName("validate");p.validateName=R;const O={gen:v,allErrors:this.opts.allErrors,data:t.default.data,parentData:t.default.parentData,parentDataProperty:t.default.parentDataProperty,dataNames:[t.default.data],dataPathArr:[o.nil],dataLevel:0,dataTypes:[],definedProperties:new Set,topSchemaRef:v.scopeValue("schema",this.opts.code.source===!0?{ref:p.schema,code:(0,o.stringify)(p.schema)}:{ref:p.schema}),validateName:R,ValidationError:P,schema:p.schema,schemaEnv:p,rootId:c,baseId:p.baseId||c,schemaPath:o.nil,errSchemaPath:p.schemaPath||(this.opts.jtd?"":"#"),errorPath:(0,o._)`""`,opts:this.opts,self:this};let q;try{this._compilations.add(p),(0,i.validateFunctionCode)(O),v.optimize(this.opts.code.optimize);const V=v.toString();q=`${v.scopeRefs(t.default.scope)}return ${V}`,this.opts.code.process&&(q=this.opts.code.process(q,p));const U=new Function(`${t.default.self}`,`${t.default.scope}`,q)(this,this.scope.get());if(this.scope.value(R,{ref:U}),U.errors=null,U.schema=p.schema,U.schemaEnv=p,p.$async&&(U.$async=!0),this.opts.code.source===!0&&(U.source={validateName:R,validateCode:V,scopeValues:v._values}),this.opts.unevaluated){const{props:X,items:ne}=O;U.evaluated={props:X instanceof o.Name?void 0:X,items:ne instanceof o.Name?void 0:ne,dynamicProps:X instanceof o.Name,dynamicItems:ne instanceof o.Name},U.source&&(U.source.evaluated=(0,o.stringify)(U.evaluated))}return p.validate=U,p}catch(V){throw delete p.validate,delete p.validateName,q&&this.logger.error("Error compiling schema, function code:",q),V}finally{this._compilations.delete(p)}}fe.compileSchema=a;function l(p,h,c){var f;c=(0,r.resolveUrl)(this.opts.uriResolver,h,c);const g=p.refs[c];if(g)return g;let b=$.call(this,p,c);if(b===void 0){const v=(f=p.localRefs)===null||f===void 0?void 0:f[c],{schemaId:P}=this.opts;v&&(b=new s({schema:v,schemaId:P,root:p,baseId:h}))}if(b!==void 0)return p.refs[c]=u.call(this,b)}fe.resolveRef=l;function u(p){return(0,r.inlineRef)(p.schema,this.opts.inlineRefs)?p.schema:p.validate?p:a.call(this,p)}function d(p){for(const h of this._compilations)if(m(h,p))return h}fe.getCompilingSchema=d;function m(p,h){return p.schema===h.schema&&p.root===h.root&&p.baseId===h.baseId}function $(p,h){let c;for(;typeof(c=this.refs[h])=="string";)h=c;return c||this.schemas[h]||_.call(this,p,h)}function _(p,h){const c=this.opts.uriResolver.parse(h),f=(0,r._getFullPath)(this.opts.uriResolver,c);let g=(0,r.getFullPath)(this.opts.uriResolver,p.baseId,void 0);if(Object.keys(p.schema).length>0&&f===g)return w.call(this,c,p);const b=(0,r.normalizeId)(f),v=this.refs[b]||this.schemas[b];if(typeof v=="string"){const P=_.call(this,p,v);return typeof P?.schema!="object"?void 0:w.call(this,c,P)}if(typeof v?.schema=="object"){if(v.validate||a.call(this,v),b===(0,r.normalizeId)(h)){const{schema:P}=v,{schemaId:R}=this.opts,O=P[R];return O&&(g=(0,r.resolveUrl)(this.opts.uriResolver,g,O)),new s({schema:P,schemaId:R,root:p,baseId:g})}return w.call(this,c,v)}}fe.resolveSchema=_;const E=new Set(["properties","patternProperties","enum","dependencies","definitions"]);function w(p,{baseId:h,schema:c,root:f}){var g;if(((g=p.fragment)===null||g===void 0?void 0:g[0])!=="/")return;for(const P of p.fragment.slice(1).split("/")){if(typeof c=="boolean")return;const R=c[(0,n.unescapeFragment)(P)];if(R===void 0)return;c=R;const O=typeof c=="object"&&c[this.opts.schemaId];!E.has(P)&&O&&(h=(0,r.resolveUrl)(this.opts.uriResolver,h,O))}let b;if(typeof c!="boolean"&&c.$ref&&!(0,n.schemaHasRulesButRef)(c,this.RULES)){const P=(0,r.resolveUrl)(this.opts.uriResolver,h,c.$ref);b=_.call(this,f,P)}const{schemaId:v}=this.opts;if(b=b||new s({schema:c,schemaId:v,root:f,baseId:h}),b.schema!==b.root.schema)return b}return fe}const Un={$id:"https://raw.githubusercontent.com/ajv-validator/ajv/master/lib/refs/data.json#",description:"Meta-schema for $data reference (JSON AnySchema extension proposal)",type:"object",required:["$data"],properties:{$data:{type:"string",anyOf:[{format:"relative-json-pointer"},{format:"json-pointer"}]}},additionalProperties:!1};var Xe={},Ie={exports:{}},Lt,Mr;function Gn(){return Mr||(Mr=1,Lt={HEX:{0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,a:10,A:10,b:11,B:11,c:12,C:12,d:13,D:13,e:14,E:14,f:15,F:15}}),Lt}var Ut,Tr;function Kn(){if(Tr)return Ut;Tr=1;const{HEX:o}=Gn(),e=/^(?:(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]\d|\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]\d|\d)$/u;function t(w){if(a(w,".")<3)return{host:w,isIPV4:!1};const p=w.match(e)||[],[h]=p;return h?{host:s(h,"."),isIPV4:!0}:{host:w,isIPV4:!1}}function r(w,p=!1){let h="",c=!0;for(const f of w){if(o[f]===void 0)return;f!=="0"&&c===!0&&(c=!1),c||(h+=f)}return p&&h.length===0&&(h="0"),h}function n(w){let p=0;const h={error:!1,address:"",zone:""},c=[],f=[];let g=!1,b=!1,v=!1;function P(){if(f.length){if(g===!1){const R=r(f);if(R!==void 0)c.push(R);else return h.error=!0,!1}f.length=0}return!0}for(let R=0;R<w.length;R++){const O=w[R];if(!(O==="["||O==="]"))if(O===":"){if(b===!0&&(v=!0),!P())break;if(p++,c.push(":"),p>7){h.error=!0;break}R-1>=0&&w[R-1]===":"&&(b=!0);continue}else if(O==="%"){if(!P())break;g=!0}else{f.push(O);continue}}return f.length&&(g?h.zone=f.join(""):v?c.push(f.join("")):c.push(r(f))),h.address=c.join(""),h}function i(w){if(a(w,":")<2)return{host:w,isIPV6:!1};const p=n(w);if(p.error)return{host:w,isIPV6:!1};{let h=p.address,c=p.address;return p.zone&&(h+="%"+p.zone,c+="%25"+p.zone),{host:h,escapedHost:c,isIPV6:!0}}}function s(w,p){let h="",c=!0;const f=w.length;for(let g=0;g<f;g++){const b=w[g];b==="0"&&c?(g+1<=f&&w[g+1]===p||g+1===f)&&(h+=b,c=!1):(b===p?c=!0:c=!1,h+=b)}return h}function a(w,p){let h=0;for(let c=0;c<w.length;c++)w[c]===p&&h++;return h}const l=/^\.\.?\//u,u=/^\/\.(?:\/|$)/u,d=/^\/\.\.(?:\/|$)/u,m=/^\/?(?:.|\n)*?(?=\/|$)/u;function $(w){const p=[];for(;w.length;)if(w.match(l))w=w.replace(l,"");else if(w.match(u))w=w.replace(u,"/");else if(w.match(d))w=w.replace(d,"/"),p.pop();else if(w==="."||w==="..")w="";else{const h=w.match(m);if(h){const c=h[0];w=w.slice(c.length),p.push(c)}else throw new Error("Unexpected dot segment condition")}return p.join("")}function _(w,p){const h=p!==!0?escape:unescape;return w.scheme!==void 0&&(w.scheme=h(w.scheme)),w.userinfo!==void 0&&(w.userinfo=h(w.userinfo)),w.host!==void 0&&(w.host=h(w.host)),w.path!==void 0&&(w.path=h(w.path)),w.query!==void 0&&(w.query=h(w.query)),w.fragment!==void 0&&(w.fragment=h(w.fragment)),w}function E(w){const p=[];if(w.userinfo!==void 0&&(p.push(w.userinfo),p.push("@")),w.host!==void 0){let h=unescape(w.host);const c=t(h);if(c.isIPV4)h=c.host;else{const f=i(c.host);f.isIPV6===!0?h=`[${f.escapedHost}]`:h=w.host}p.push(h)}return(typeof w.port=="number"||typeof w.port=="string")&&(p.push(":"),p.push(String(w.port))),p.length?p.join(""):void 0}return Ut={recomposeAuthority:E,normalizeComponentEncoding:_,removeDotSegments:$,normalizeIPv4:t,normalizeIPv6:i,stringArrayToHexStripped:r},Ut}var Gt,kr;function Hn(){if(kr)return Gt;kr=1;const o=/^[\da-f]{8}-[\da-f]{4}-[\da-f]{4}-[\da-f]{4}-[\da-f]{12}$/iu,e=/([\da-z][\d\-a-z]{0,31}):((?:[\w!$'()*+,\-.:;=@]|%[\da-f]{2})+)/iu;function t(c){return typeof c.secure=="boolean"?c.secure:String(c.scheme).toLowerCase()==="wss"}function r(c){return c.host||(c.error=c.error||"HTTP URIs must have a host."),c}function n(c){const f=String(c.scheme).toLowerCase()==="https";return(c.port===(f?443:80)||c.port==="")&&(c.port=void 0),c.path||(c.path="/"),c}function i(c){return c.secure=t(c),c.resourceName=(c.path||"/")+(c.query?"?"+c.query:""),c.path=void 0,c.query=void 0,c}function s(c){if((c.port===(t(c)?443:80)||c.port==="")&&(c.port=void 0),typeof c.secure=="boolean"&&(c.scheme=c.secure?"wss":"ws",c.secure=void 0),c.resourceName){const[f,g]=c.resourceName.split("?");c.path=f&&f!=="/"?f:void 0,c.query=g,c.resourceName=void 0}return c.fragment=void 0,c}function a(c,f){if(!c.path)return c.error="URN can not be parsed",c;const g=c.path.match(e);if(g){const b=f.scheme||c.scheme||"urn";c.nid=g[1].toLowerCase(),c.nss=g[2];const v=`${b}:${f.nid||c.nid}`,P=h[v];c.path=void 0,P&&(c=P.parse(c,f))}else c.error=c.error||"URN can not be parsed.";return c}function l(c,f){const g=f.scheme||c.scheme||"urn",b=c.nid.toLowerCase(),v=`${g}:${f.nid||b}`,P=h[v];P&&(c=P.serialize(c,f));const R=c,O=c.nss;return R.path=`${b||f.nid}:${O}`,f.skipEscape=!0,R}function u(c,f){const g=c;return g.uuid=g.nss,g.nss=void 0,!f.tolerant&&(!g.uuid||!o.test(g.uuid))&&(g.error=g.error||"UUID is not valid."),g}function d(c){const f=c;return f.nss=(c.uuid||"").toLowerCase(),f}const m={scheme:"http",domainHost:!0,parse:r,serialize:n},$={scheme:"https",domainHost:m.domainHost,parse:r,serialize:n},_={scheme:"ws",domainHost:!0,parse:i,serialize:s},E={scheme:"wss",domainHost:_.domainHost,parse:_.parse,serialize:_.serialize},h={http:m,https:$,ws:_,wss:E,urn:{scheme:"urn",parse:a,serialize:l,skipNormalize:!0},"urn:uuid":{scheme:"urn:uuid",parse:u,serialize:d,skipNormalize:!0}};return Gt=h,Gt}var Rr;function Bn(){if(Rr)return Ie.exports;Rr=1;const{normalizeIPv6:o,normalizeIPv4:e,removeDotSegments:t,recomposeAuthority:r,normalizeComponentEncoding:n}=Kn(),i=Hn();function s(p,h){return typeof p=="string"?p=d(E(p,h),h):typeof p=="object"&&(p=E(d(p,h),h)),p}function a(p,h,c){const f=Object.assign({scheme:"null"},c),g=l(E(p,f),E(h,f),f,!0);return d(g,{...f,skipEscape:!0})}function l(p,h,c,f){const g={};return f||(p=E(d(p,c),c),h=E(d(h,c),c)),c=c||{},!c.tolerant&&h.scheme?(g.scheme=h.scheme,g.userinfo=h.userinfo,g.host=h.host,g.port=h.port,g.path=t(h.path||""),g.query=h.query):(h.userinfo!==void 0||h.host!==void 0||h.port!==void 0?(g.userinfo=h.userinfo,g.host=h.host,g.port=h.port,g.path=t(h.path||""),g.query=h.query):(h.path?(h.path.charAt(0)==="/"?g.path=t(h.path):((p.userinfo!==void 0||p.host!==void 0||p.port!==void 0)&&!p.path?g.path="/"+h.path:p.path?g.path=p.path.slice(0,p.path.lastIndexOf("/")+1)+h.path:g.path=h.path,g.path=t(g.path)),g.query=h.query):(g.path=p.path,h.query!==void 0?g.query=h.query:g.query=p.query),g.userinfo=p.userinfo,g.host=p.host,g.port=p.port),g.scheme=p.scheme),g.fragment=h.fragment,g}function u(p,h,c){return typeof p=="string"?(p=unescape(p),p=d(n(E(p,c),!0),{...c,skipEscape:!0})):typeof p=="object"&&(p=d(n(p,!0),{...c,skipEscape:!0})),typeof h=="string"?(h=unescape(h),h=d(n(E(h,c),!0),{...c,skipEscape:!0})):typeof h=="object"&&(h=d(n(h,!0),{...c,skipEscape:!0})),p.toLowerCase()===h.toLowerCase()}function d(p,h){const c={host:p.host,scheme:p.scheme,userinfo:p.userinfo,port:p.port,path:p.path,query:p.query,nid:p.nid,nss:p.nss,uuid:p.uuid,fragment:p.fragment,reference:p.reference,resourceName:p.resourceName,secure:p.secure,error:""},f=Object.assign({},h),g=[],b=i[(f.scheme||c.scheme||"").toLowerCase()];b&&b.serialize&&b.serialize(c,f),c.path!==void 0&&(f.skipEscape?c.path=unescape(c.path):(c.path=escape(c.path),c.scheme!==void 0&&(c.path=c.path.split("%3A").join(":")))),f.reference!=="suffix"&&c.scheme&&g.push(c.scheme,":");const v=r(c);if(v!==void 0&&(f.reference!=="suffix"&&g.push("//"),g.push(v),c.path&&c.path.charAt(0)!=="/"&&g.push("/")),c.path!==void 0){let P=c.path;!f.absolutePath&&(!b||!b.absolutePath)&&(P=t(P)),v===void 0&&(P=P.replace(/^\/\//u,"/%2F")),g.push(P)}return c.query!==void 0&&g.push("?",c.query),c.fragment!==void 0&&g.push("#",c.fragment),g.join("")}const m=Array.from({length:127},(p,h)=>/[^!"$&'()*+,\-.;=_`a-z{}~]/u.test(String.fromCharCode(h)));function $(p){let h=0;for(let c=0,f=p.length;c<f;++c)if(h=p.charCodeAt(c),h>126||m[h])return!0;return!1}const _=/^(?:([^#/:?]+):)?(?:\/\/((?:([^#/?@]*)@)?(\[[^#/?\]]+\]|[^#/:?]*)(?::(\d*))?))?([^#?]*)(?:\?([^#]*))?(?:#((?:.|[\n\r])*))?/u;function E(p,h){const c=Object.assign({},h),f={scheme:void 0,userinfo:void 0,host:"",port:void 0,path:"",query:void 0,fragment:void 0},g=p.indexOf("%")!==-1;let b=!1;c.reference==="suffix"&&(p=(c.scheme?c.scheme+":":"")+"//"+p);const v=p.match(_);if(v){if(f.scheme=v[1],f.userinfo=v[3],f.host=v[4],f.port=parseInt(v[5],10),f.path=v[6]||"",f.query=v[7],f.fragment=v[8],isNaN(f.port)&&(f.port=v[5]),f.host){const R=e(f.host);if(R.isIPV4===!1){const O=o(R.host);f.host=O.host.toLowerCase(),b=O.isIPV6}else f.host=R.host,b=!0}f.scheme===void 0&&f.userinfo===void 0&&f.host===void 0&&f.port===void 0&&f.query===void 0&&!f.path?f.reference="same-document":f.scheme===void 0?f.reference="relative":f.fragment===void 0?f.reference="absolute":f.reference="uri",c.reference&&c.reference!=="suffix"&&c.reference!==f.reference&&(f.error=f.error||"URI is not a "+c.reference+" reference.");const P=i[(c.scheme||f.scheme||"").toLowerCase()];if(!c.unicodeSupport&&(!P||!P.unicodeSupport)&&f.host&&(c.domainHost||P&&P.domainHost)&&b===!1&&$(f.host))try{f.host=URL.domainToASCII(f.host.toLowerCase())}catch(R){f.error=f.error||"Host's domain name can not be converted to ASCII: "+R}(!P||P&&!P.skipNormalize)&&(g&&f.scheme!==void 0&&(f.scheme=unescape(f.scheme)),g&&f.host!==void 0&&(f.host=unescape(f.host)),f.path&&(f.path=escape(unescape(f.path))),f.fragment&&(f.fragment=encodeURI(decodeURIComponent(f.fragment)))),P&&P.parse&&P.parse(f,c)}else f.error=f.error||"URI can not be parsed.";return f}const w={SCHEMES:i,normalize:s,resolve:a,resolveComponents:l,equal:u,serialize:d,parse:E};return Ie.exports=w,Ie.exports.default=w,Ie.exports.fastUri=w,Ie.exports}var xr;function Wn(){if(xr)return Xe;xr=1,Object.defineProperty(Xe,"__esModule",{value:!0});const o=Bn();return o.code='require("ajv/dist/runtime/uri").default',Xe.default=o,Xe}var Ar;function Jn(){return Ar||(Ar=1,(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.CodeGen=o.Name=o.nil=o.stringify=o.str=o._=o.KeywordCxt=void 0;var e=Be();Object.defineProperty(o,"KeywordCxt",{enumerable:!0,get:function(){return e.KeywordCxt}});var t=Y();Object.defineProperty(o,"_",{enumerable:!0,get:function(){return t._}}),Object.defineProperty(o,"str",{enumerable:!0,get:function(){return t.str}}),Object.defineProperty(o,"stringify",{enumerable:!0,get:function(){return t.stringify}}),Object.defineProperty(o,"nil",{enumerable:!0,get:function(){return t.nil}}),Object.defineProperty(o,"Name",{enumerable:!0,get:function(){return t.Name}}),Object.defineProperty(o,"CodeGen",{enumerable:!0,get:function(){return t.CodeGen}});const r=zt(),n=Ye(),i=ur(),s=Ft(),a=Y(),l=He(),u=Ke(),d=ee(),m=Un,$=Wn(),_=(I,k)=>new RegExp(I,k);_.code="new RegExp";const E=["removeAdditional","useDefaults","coerceTypes"],w=new Set(["validate","serialize","parse","wrapper","root","schema","keyword","pattern","formats","validate$data","func","obj","Error"]),p={errorDataPath:"",format:"`validateFormats: false` can be used instead.",nullable:'"nullable" keyword is supported by default.',jsonPointers:"Deprecated jsPropertySyntax can be used instead.",extendRefs:"Deprecated ignoreKeywordsWithRef can be used instead.",missingRefs:"Pass empty schema with $id that should be ignored to ajv.addSchema.",processCode:"Use option `code: {process: (code, schemaEnv: object) => string}`",sourceCode:"Use option `code: {source: true}`",strictDefaults:"It is default now, see option `strict`.",strictKeywords:"It is default now, see option `strict`.",uniqueItems:'"uniqueItems" keyword is always validated.',unknownFormats:"Disable strict mode or pass `true` to `ajv.addFormat` (or `formats` option).",cache:"Map is used as cache, schema object as key.",serialize:"Map is used as cache, schema object as key.",ajvErrors:"It is default now."},h={ignoreKeywordsWithRef:"",jsPropertySyntax:"",unicode:'"minLength"/"maxLength" account for unicode characters by default.'},c=200;function f(I){var k,j,x,y,S,A,z,F,J,B,M,T,N,C,L,K,ie,re,G,Q,Z,ae,de,Ne,Ve;const Te=I.strict,_e=(k=I.code)===null||k===void 0?void 0:k.optimize,ze=_e===!0||_e===void 0?1:_e||0,ke=(x=(j=I.code)===null||j===void 0?void 0:j.regExp)!==null&&x!==void 0?x:_,er=(y=I.uriResolver)!==null&&y!==void 0?y:$.default;return{strictSchema:(A=(S=I.strictSchema)!==null&&S!==void 0?S:Te)!==null&&A!==void 0?A:!0,strictNumbers:(F=(z=I.strictNumbers)!==null&&z!==void 0?z:Te)!==null&&F!==void 0?F:!0,strictTypes:(B=(J=I.strictTypes)!==null&&J!==void 0?J:Te)!==null&&B!==void 0?B:"log",strictTuples:(T=(M=I.strictTuples)!==null&&M!==void 0?M:Te)!==null&&T!==void 0?T:"log",strictRequired:(C=(N=I.strictRequired)!==null&&N!==void 0?N:Te)!==null&&C!==void 0?C:!1,code:I.code?{...I.code,optimize:ze,regExp:ke}:{optimize:ze,regExp:ke},loopRequired:(L=I.loopRequired)!==null&&L!==void 0?L:c,loopEnum:(K=I.loopEnum)!==null&&K!==void 0?K:c,meta:(ie=I.meta)!==null&&ie!==void 0?ie:!0,messages:(re=I.messages)!==null&&re!==void 0?re:!0,inlineRefs:(G=I.inlineRefs)!==null&&G!==void 0?G:!0,schemaId:(Q=I.schemaId)!==null&&Q!==void 0?Q:"$id",addUsedSchema:(Z=I.addUsedSchema)!==null&&Z!==void 0?Z:!0,validateSchema:(ae=I.validateSchema)!==null&&ae!==void 0?ae:!0,validateFormats:(de=I.validateFormats)!==null&&de!==void 0?de:!0,unicodeRegExp:(Ne=I.unicodeRegExp)!==null&&Ne!==void 0?Ne:!0,int32range:(Ve=I.int32range)!==null&&Ve!==void 0?Ve:!0,uriResolver:er}}class g{constructor(k={}){this.schemas={},this.refs={},this.formats={},this._compilations=new Set,this._loading={},this._cache=new Map,k=this.opts={...k,...f(k)};const{es5:j,lines:x}=this.opts.code;this.scope=new a.ValueScope({scope:{},prefixes:w,es5:j,lines:x}),this.logger=H(k.logger);const y=k.validateFormats;k.validateFormats=!1,this.RULES=(0,i.getRules)(),b.call(this,p,k,"NOT SUPPORTED"),b.call(this,h,k,"DEPRECATED","warn"),this._metaOpts=q.call(this),k.formats&&R.call(this),this._addVocabularies(),this._addDefaultMetaSchema(),k.keywords&&O.call(this,k.keywords),typeof k.meta=="object"&&this.addMetaSchema(k.meta),P.call(this),k.validateFormats=y}_addVocabularies(){this.addKeyword("$async")}_addDefaultMetaSchema(){const{$data:k,meta:j,schemaId:x}=this.opts;let y=m;x==="id"&&(y={...m},y.id=y.$id,delete y.$id),j&&k&&this.addMetaSchema(y,y[x],!1)}defaultMeta(){const{meta:k,schemaId:j}=this.opts;return this.opts.defaultMeta=typeof k=="object"?k[j]||k:void 0}validate(k,j){let x;if(typeof k=="string"){if(x=this.getSchema(k),!x)throw new Error(`no schema with key or ref "${k}"`)}else x=this.compile(k);const y=x(j);return"$async"in x||(this.errors=x.errors),y}compile(k,j){const x=this._addSchema(k,j);return x.validate||this._compileSchemaEnv(x)}compileAsync(k,j){if(typeof this.opts.loadSchema!="function")throw new Error("options.loadSchema should be a function");const{loadSchema:x}=this.opts;return y.call(this,k,j);async function y(B,M){await S.call(this,B.$schema);const T=this._addSchema(B,M);return T.validate||A.call(this,T)}async function S(B){B&&!this.getSchema(B)&&await y.call(this,{$ref:B},!0)}async function A(B){try{return this._compileSchemaEnv(B)}catch(M){if(!(M instanceof n.default))throw M;return z.call(this,M),await F.call(this,M.missingSchema),A.call(this,B)}}function z({missingSchema:B,missingRef:M}){if(this.refs[B])throw new Error(`AnySchema ${B} is loaded but ${M} cannot be resolved`)}async function F(B){const M=await J.call(this,B);this.refs[B]||await S.call(this,M.$schema),this.refs[B]||this.addSchema(M,B,j)}async function J(B){const M=this._loading[B];if(M)return M;try{return await(this._loading[B]=x(B))}finally{delete this._loading[B]}}}addSchema(k,j,x,y=this.opts.validateSchema){if(Array.isArray(k)){for(const A of k)this.addSchema(A,void 0,x,y);return this}let S;if(typeof k=="object"){const{schemaId:A}=this.opts;if(S=k[A],S!==void 0&&typeof S!="string")throw new Error(`schema ${A} must be string`)}return j=(0,l.normalizeId)(j||S),this._checkUnique(j),this.schemas[j]=this._addSchema(k,x,j,y,!0),this}addMetaSchema(k,j,x=this.opts.validateSchema){return this.addSchema(k,j,!0,x),this}validateSchema(k,j){if(typeof k=="boolean")return!0;let x;if(x=k.$schema,x!==void 0&&typeof x!="string")throw new Error("$schema must be a string");if(x=x||this.opts.defaultMeta||this.defaultMeta(),!x)return this.logger.warn("meta-schema not available"),this.errors=null,!0;const y=this.validate(x,k);if(!y&&j){const S="schema is invalid: "+this.errorsText();if(this.opts.validateSchema==="log")this.logger.error(S);else throw new Error(S)}return y}getSchema(k){let j;for(;typeof(j=v.call(this,k))=="string";)k=j;if(j===void 0){const{schemaId:x}=this.opts,y=new s.SchemaEnv({schema:{},schemaId:x});if(j=s.resolveSchema.call(this,y,k),!j)return;this.refs[k]=j}return j.validate||this._compileSchemaEnv(j)}removeSchema(k){if(k instanceof RegExp)return this._removeAllSchemas(this.schemas,k),this._removeAllSchemas(this.refs,k),this;switch(typeof k){case"undefined":return this._removeAllSchemas(this.schemas),this._removeAllSchemas(this.refs),this._cache.clear(),this;case"string":{const j=v.call(this,k);return typeof j=="object"&&this._cache.delete(j.schema),delete this.schemas[k],delete this.refs[k],this}case"object":{const j=k;this._cache.delete(j);let x=k[this.opts.schemaId];return x&&(x=(0,l.normalizeId)(x),delete this.schemas[x],delete this.refs[x]),this}default:throw new Error("ajv.removeSchema: invalid parameter")}}addVocabulary(k){for(const j of k)this.addKeyword(j);return this}addKeyword(k,j){let x;if(typeof k=="string")x=k,typeof j=="object"&&(this.logger.warn("these parameters are deprecated, see docs for addKeyword"),j.keyword=x);else if(typeof k=="object"&&j===void 0){if(j=k,x=j.keyword,Array.isArray(x)&&!x.length)throw new Error("addKeywords: keyword must be string or non-empty array")}else throw new Error("invalid addKeywords parameters");if(X.call(this,x,j),!j)return(0,d.eachItem)(x,S=>ne.call(this,S)),this;he.call(this,j);const y={...j,type:(0,u.getJSONTypes)(j.type),schemaType:(0,u.getJSONTypes)(j.schemaType)};return(0,d.eachItem)(x,y.type.length===0?S=>ne.call(this,S,y):S=>y.type.forEach(A=>ne.call(this,S,y,A))),this}getKeyword(k){const j=this.RULES.all[k];return typeof j=="object"?j.definition:!!j}removeKeyword(k){const{RULES:j}=this;delete j.keywords[k],delete j.all[k];for(const x of j.rules){const y=x.rules.findIndex(S=>S.keyword===k);y>=0&&x.rules.splice(y,1)}return this}addFormat(k,j){return typeof j=="string"&&(j=new RegExp(j)),this.formats[k]=j,this}errorsText(k=this.errors,{separator:j=", ",dataVar:x="data"}={}){return!k||k.length===0?"No errors":k.map(y=>`${x}${y.instancePath} ${y.message}`).reduce((y,S)=>y+j+S)}$dataMetaSchema(k,j){const x=this.RULES.all;k=JSON.parse(JSON.stringify(k));for(const y of j){const S=y.split("/").slice(1);let A=k;for(const z of S)A=A[z];for(const z in x){const F=x[z];if(typeof F!="object")continue;const{$data:J}=F.definition,B=A[z];J&&B&&(A[z]=ce(B))}}return k}_removeAllSchemas(k,j){for(const x in k){const y=k[x];(!j||j.test(x))&&(typeof y=="string"?delete k[x]:y&&!y.meta&&(this._cache.delete(y.schema),delete k[x]))}}_addSchema(k,j,x,y=this.opts.validateSchema,S=this.opts.addUsedSchema){let A;const{schemaId:z}=this.opts;if(typeof k=="object")A=k[z];else{if(this.opts.jtd)throw new Error("schema must be object");if(typeof k!="boolean")throw new Error("schema must be object or boolean")}let F=this._cache.get(k);if(F!==void 0)return F;x=(0,l.normalizeId)(A||x);const J=l.getSchemaRefs.call(this,k,x);return F=new s.SchemaEnv({schema:k,schemaId:z,meta:j,baseId:x,localRefs:J}),this._cache.set(F.schema,F),S&&!x.startsWith("#")&&(x&&this._checkUnique(x),this.refs[x]=F),y&&this.validateSchema(k,!0),F}_checkUnique(k){if(this.schemas[k]||this.refs[k])throw new Error(`schema with key or id "${k}" already exists`)}_compileSchemaEnv(k){if(k.meta?this._compileMetaSchema(k):s.compileSchema.call(this,k),!k.validate)throw new Error("ajv implementation error");return k.validate}_compileMetaSchema(k){const j=this.opts;this.opts=this._metaOpts;try{s.compileSchema.call(this,k)}finally{this.opts=j}}}g.ValidationError=r.default,g.MissingRefError=n.default,o.default=g;function b(I,k,j,x="error"){for(const y in I){const S=y;S in k&&this.logger[x](`${j}: option ${y}. ${I[S]}`)}}function v(I){return I=(0,l.normalizeId)(I),this.schemas[I]||this.refs[I]}function P(){const I=this.opts.schemas;if(I)if(Array.isArray(I))this.addSchema(I);else for(const k in I)this.addSchema(I[k],k)}function R(){for(const I in this.opts.formats){const k=this.opts.formats[I];k&&this.addFormat(I,k)}}function O(I){if(Array.isArray(I)){this.addVocabulary(I);return}this.logger.warn("keywords option as map is deprecated, pass array");for(const k in I){const j=I[k];j.keyword||(j.keyword=k),this.addKeyword(j)}}function q(){const I={...this.opts};for(const k of E)delete I[k];return I}const V={log(){},warn(){},error(){}};function H(I){if(I===!1)return V;if(I===void 0)return console;if(I.log&&I.warn&&I.error)return I;throw new Error("logger must implement log, warn and error methods")}const U=/^[a-z_$][a-z0-9_$:-]*$/i;function X(I,k){const{RULES:j}=this;if((0,d.eachItem)(I,x=>{if(j.keywords[x])throw new Error(`Keyword ${x} is already defined`);if(!U.test(x))throw new Error(`Keyword ${x} has invalid name`)}),!!k&&k.$data&&!("code"in k||"validate"in k))throw new Error('$data keyword must have "code" or "validate" function')}function ne(I,k,j){var x;const y=k?.post;if(j&&y)throw new Error('keyword with "post" flag cannot have "type"');const{RULES:S}=this;let A=y?S.post:S.rules.find(({type:F})=>F===j);if(A||(A={type:j,rules:[]},S.rules.push(A)),S.keywords[I]=!0,!k)return;const z={keyword:I,definition:{...k,type:(0,u.getJSONTypes)(k.type),schemaType:(0,u.getJSONTypes)(k.schemaType)}};k.before?ue.call(this,A,z,k.before):A.rules.push(z),S.all[I]=z,(x=k.implements)===null||x===void 0||x.forEach(F=>this.addKeyword(F))}function ue(I,k,j){const x=I.rules.findIndex(y=>y.keyword===j);x>=0?I.rules.splice(x,0,k):(I.rules.push(k),this.logger.warn(`rule ${j} is not defined`))}function he(I){let{metaSchema:k}=I;k!==void 0&&(I.$data&&this.opts.$data&&(k=ce(k)),I.validateSchema=this.compile(k,!0))}const D={$ref:"https://raw.githubusercontent.com/ajv-validator/ajv/master/lib/refs/data.json#"};function ce(I){return{anyOf:[I,D]}}})(jt)),jt}var Qe={},Ze={},et={},Nr;function Yn(){if(Nr)return et;Nr=1,Object.defineProperty(et,"__esModule",{value:!0});const o={keyword:"id",code(){throw new Error('NOT SUPPORTED: keyword "id", use "$id" for schema ID')}};return et.default=o,et}var we={},jr;function Xn(){if(jr)return we;jr=1,Object.defineProperty(we,"__esModule",{value:!0}),we.callRef=we.getValidate=void 0;const o=Ye(),e=me(),t=Y(),r=be(),n=Ft(),i=ee(),s={keyword:"$ref",schemaType:"string",code(u){const{gen:d,schema:m,it:$}=u,{baseId:_,schemaEnv:E,validateName:w,opts:p,self:h}=$,{root:c}=E;if((m==="#"||m==="#/")&&_===c.baseId)return g();const f=n.resolveRef.call(h,c,_,m);if(f===void 0)throw new o.default($.opts.uriResolver,_,m);if(f instanceof n.SchemaEnv)return b(f);return v(f);function g(){if(E===c)return l(u,w,E,E.$async);const P=d.scopeValue("root",{ref:c});return l(u,(0,t._)`${P}.validate`,c,c.$async)}function b(P){const R=a(u,P);l(u,R,P,P.$async)}function v(P){const R=d.scopeValue("schema",p.code.source===!0?{ref:P,code:(0,t.stringify)(P)}:{ref:P}),O=d.name("valid"),q=u.subschema({schema:P,dataTypes:[],schemaPath:t.nil,topSchemaRef:R,errSchemaPath:m},O);u.mergeEvaluated(q),u.ok(O)}}};function a(u,d){const{gen:m}=u;return d.validate?m.scopeValue("validate",{ref:d.validate}):(0,t._)`${m.scopeValue("wrapper",{ref:d})}.validate`}we.getValidate=a;function l(u,d,m,$){const{gen:_,it:E}=u,{allErrors:w,schemaEnv:p,opts:h}=E,c=h.passContext?r.default.this:t.nil;$?f():g();function f(){if(!p.$async)throw new Error("async schema referenced by sync schema");const P=_.let("valid");_.try(()=>{_.code((0,t._)`await ${(0,e.callValidateCode)(u,d,c)}`),v(d),w||_.assign(P,!0)},R=>{_.if((0,t._)`!(${R} instanceof ${E.ValidationError})`,()=>_.throw(R)),b(R),w||_.assign(P,!1)}),u.ok(P)}function g(){u.result((0,e.callValidateCode)(u,d,c),()=>v(d),()=>b(d))}function b(P){const R=(0,t._)`${P}.errors`;_.assign(r.default.vErrors,(0,t._)`${r.default.vErrors} === null ? ${R} : ${r.default.vErrors}.concat(${R})`),_.assign(r.default.errors,(0,t._)`${r.default.vErrors}.length`)}function v(P){var R;if(!E.opts.unevaluated)return;const O=(R=m?.validate)===null||R===void 0?void 0:R.evaluated;if(E.props!==!0)if(O&&!O.dynamicProps)O.props!==void 0&&(E.props=i.mergeEvaluated.props(_,O.props,E.props));else{const q=_.var("props",(0,t._)`${P}.evaluated.props`);E.props=i.mergeEvaluated.props(_,q,E.props,t.Name)}if(E.items!==!0)if(O&&!O.dynamicItems)O.items!==void 0&&(E.items=i.mergeEvaluated.items(_,O.items,E.items));else{const q=_.var("items",(0,t._)`${P}.evaluated.items`);E.items=i.mergeEvaluated.items(_,q,E.items,t.Name)}}}return we.callRef=l,we.default=s,we}var Or;function Qn(){if(Or)return Ze;Or=1,Object.defineProperty(Ze,"__esModule",{value:!0});const o=Yn(),e=Xn(),t=["$schema","$id","$defs","$vocabulary",{keyword:"$comment"},"definitions",o.default,e.default];return Ze.default=t,Ze}var tt={},rt={},Ir;function Zn(){if(Ir)return rt;Ir=1,Object.defineProperty(rt,"__esModule",{value:!0});const o=Y(),e=o.operators,t={maximum:{okStr:"<=",ok:e.LTE,fail:e.GT},minimum:{okStr:">=",ok:e.GTE,fail:e.LT},exclusiveMaximum:{okStr:"<",ok:e.LT,fail:e.GTE},exclusiveMinimum:{okStr:">",ok:e.GT,fail:e.LTE}},r={message:({keyword:i,schemaCode:s})=>(0,o.str)`must be ${t[i].okStr} ${s}`,params:({keyword:i,schemaCode:s})=>(0,o._)`{comparison: ${t[i].okStr}, limit: ${s}}`},n={keyword:Object.keys(t),type:"number",schemaType:"number",$data:!0,error:r,code(i){const{keyword:s,data:a,schemaCode:l}=i;i.fail$data((0,o._)`${a} ${t[s].fail} ${l} || isNaN(${a})`)}};return rt.default=n,rt}var nt={},Cr;function ei(){if(Cr)return nt;Cr=1,Object.defineProperty(nt,"__esModule",{value:!0});const o=Y(),t={keyword:"multipleOf",type:"number",schemaType:"number",$data:!0,error:{message:({schemaCode:r})=>(0,o.str)`must be multiple of ${r}`,params:({schemaCode:r})=>(0,o._)`{multipleOf: ${r}}`},code(r){const{gen:n,data:i,schemaCode:s,it:a}=r,l=a.opts.multipleOfPrecision,u=n.let("res"),d=l?(0,o._)`Math.abs(Math.round(${u}) - ${u}) > 1e-${l}`:(0,o._)`${u} !== parseInt(${u})`;r.fail$data((0,o._)`(${s} === 0 || (${u} = ${i}/${s}, ${d}))`)}};return nt.default=t,nt}var it={},ot={},qr;function ti(){if(qr)return ot;qr=1,Object.defineProperty(ot,"__esModule",{value:!0});function o(e){const t=e.length;let r=0,n=0,i;for(;n<t;)r++,i=e.charCodeAt(n++),i>=55296&&i<=56319&&n<t&&(i=e.charCodeAt(n),(i&64512)===56320&&n++);return r}return ot.default=o,o.code='require("ajv/dist/runtime/ucs2length").default',ot}var Dr;function ri(){if(Dr)return it;Dr=1,Object.defineProperty(it,"__esModule",{value:!0});const o=Y(),e=ee(),t=ti(),n={keyword:["maxLength","minLength"],type:"string",schemaType:"number",$data:!0,error:{message({keyword:i,schemaCode:s}){const a=i==="maxLength"?"more":"fewer";return(0,o.str)`must NOT have ${a} than ${s} characters`},params:({schemaCode:i})=>(0,o._)`{limit: ${i}}`},code(i){const{keyword:s,data:a,schemaCode:l,it:u}=i,d=s==="maxLength"?o.operators.GT:o.operators.LT,m=u.opts.unicode===!1?(0,o._)`${a}.length`:(0,o._)`${(0,e.useFunc)(i.gen,t.default)}(${a})`;i.fail$data((0,o._)`${m} ${d} ${l}`)}};return it.default=n,it}var st={},Vr;function ni(){if(Vr)return st;Vr=1,Object.defineProperty(st,"__esModule",{value:!0});const o=me(),e=Y(),r={keyword:"pattern",type:"string",schemaType:"string",$data:!0,error:{message:({schemaCode:n})=>(0,e.str)`must match pattern "${n}"`,params:({schemaCode:n})=>(0,e._)`{pattern: ${n}}`},code(n){const{data:i,$data:s,schema:a,schemaCode:l,it:u}=n,d=u.opts.unicodeRegExp?"u":"",m=s?(0,e._)`(new RegExp(${l}, ${d}))`:(0,o.usePattern)(n,a);n.fail$data((0,e._)`!${m}.test(${i})`)}};return st.default=r,st}var at={},zr;function ii(){if(zr)return at;zr=1,Object.defineProperty(at,"__esModule",{value:!0});const o=Y(),t={keyword:["maxProperties","minProperties"],type:"object",schemaType:"number",$data:!0,error:{message({keyword:r,schemaCode:n}){const i=r==="maxProperties"?"more":"fewer";return(0,o.str)`must NOT have ${i} than ${n} properties`},params:({schemaCode:r})=>(0,o._)`{limit: ${r}}`},code(r){const{keyword:n,data:i,schemaCode:s}=r,a=n==="maxProperties"?o.operators.GT:o.operators.LT;r.fail$data((0,o._)`Object.keys(${i}).length ${a} ${s}`)}};return at.default=t,at}var ct={},Fr;function oi(){if(Fr)return ct;Fr=1,Object.defineProperty(ct,"__esModule",{value:!0});const o=me(),e=Y(),t=ee(),n={keyword:"required",type:"object",schemaType:"array",$data:!0,error:{message:({params:{missingProperty:i}})=>(0,e.str)`must have required property '${i}'`,params:({params:{missingProperty:i}})=>(0,e._)`{missingProperty: ${i}}`},code(i){const{gen:s,schema:a,schemaCode:l,data:u,$data:d,it:m}=i,{opts:$}=m;if(!d&&a.length===0)return;const _=a.length>=$.loopRequired;if(m.allErrors?E():w(),$.strictRequired){const c=i.parentSchema.properties,{definedProperties:f}=i.it;for(const g of a)if(c?.[g]===void 0&&!f.has(g)){const b=m.schemaEnv.baseId+m.errSchemaPath,v=`required property "${g}" is not defined at "${b}" (strictRequired)`;(0,t.checkStrictMode)(m,v,m.opts.strictRequired)}}function E(){if(_||d)i.block$data(e.nil,p);else for(const c of a)(0,o.checkReportMissingProp)(i,c)}function w(){const c=s.let("missing");if(_||d){const f=s.let("valid",!0);i.block$data(f,()=>h(c,f)),i.ok(f)}else s.if((0,o.checkMissingProp)(i,a,c)),(0,o.reportMissingProp)(i,c),s.else()}function p(){s.forOf("prop",l,c=>{i.setParams({missingProperty:c}),s.if((0,o.noPropertyInData)(s,u,c,$.ownProperties),()=>i.error())})}function h(c,f){i.setParams({missingProperty:c}),s.forOf(c,l,()=>{s.assign(f,(0,o.propertyInData)(s,u,c,$.ownProperties)),s.if((0,e.not)(f),()=>{i.error(),s.break()})},e.nil)}}};return ct.default=n,ct}var lt={},Lr;function si(){if(Lr)return lt;Lr=1,Object.defineProperty(lt,"__esModule",{value:!0});const o=Y(),t={keyword:["maxItems","minItems"],type:"array",schemaType:"number",$data:!0,error:{message({keyword:r,schemaCode:n}){const i=r==="maxItems"?"more":"fewer";return(0,o.str)`must NOT have ${i} than ${n} items`},params:({schemaCode:r})=>(0,o._)`{limit: ${r}}`},code(r){const{keyword:n,data:i,schemaCode:s}=r,a=n==="maxItems"?o.operators.GT:o.operators.LT;r.fail$data((0,o._)`${i}.length ${a} ${s}`)}};return lt.default=t,lt}var ut={},dt={},Ur;function Kt(){if(Ur)return dt;Ur=1,Object.defineProperty(dt,"__esModule",{value:!0});const o=br();return o.code='require("ajv/dist/runtime/equal").default',dt.default=o,dt}var Gr;function ai(){if(Gr)return ut;Gr=1,Object.defineProperty(ut,"__esModule",{value:!0});const o=Ke(),e=Y(),t=ee(),r=Kt(),i={keyword:"uniqueItems",type:"array",schemaType:"boolean",$data:!0,error:{message:({params:{i:s,j:a}})=>(0,e.str)`must NOT have duplicate items (items ## ${a} and ${s} are identical)`,params:({params:{i:s,j:a}})=>(0,e._)`{i: ${s}, j: ${a}}`},code(s){const{gen:a,data:l,$data:u,schema:d,parentSchema:m,schemaCode:$,it:_}=s;if(!u&&!d)return;const E=a.let("valid"),w=m.items?(0,o.getSchemaTypes)(m.items):[];s.block$data(E,p,(0,e._)`${$} === false`),s.ok(E);function p(){const g=a.let("i",(0,e._)`${l}.length`),b=a.let("j");s.setParams({i:g,j:b}),a.assign(E,!0),a.if((0,e._)`${g} > 1`,()=>(h()?c:f)(g,b))}function h(){return w.length>0&&!w.some(g=>g==="object"||g==="array")}function c(g,b){const v=a.name("item"),P=(0,o.checkDataTypes)(w,v,_.opts.strictNumbers,o.DataType.Wrong),R=a.const("indices",(0,e._)`{}`);a.for((0,e._)`;${g}--;`,()=>{a.let(v,(0,e._)`${l}[${g}]`),a.if(P,(0,e._)`continue`),w.length>1&&a.if((0,e._)`typeof ${v} == "string"`,(0,e._)`${v} += "_"`),a.if((0,e._)`typeof ${R}[${v}] == "number"`,()=>{a.assign(b,(0,e._)`${R}[${v}]`),s.error(),a.assign(E,!1).break()}).code((0,e._)`${R}[${v}] = ${g}`)})}function f(g,b){const v=(0,t.useFunc)(a,r.default),P=a.name("outer");a.label(P).for((0,e._)`;${g}--;`,()=>a.for((0,e._)`${b} = ${g}; ${b}--;`,()=>a.if((0,e._)`${v}(${l}[${g}], ${l}[${b}])`,()=>{s.error(),a.assign(E,!1).break(P)})))}}};return ut.default=i,ut}var ht={},Kr;function ci(){if(Kr)return ht;Kr=1,Object.defineProperty(ht,"__esModule",{value:!0});const o=Y(),e=ee(),t=Kt(),n={keyword:"const",$data:!0,error:{message:"must be equal to constant",params:({schemaCode:i})=>(0,o._)`{allowedValue: ${i}}`},code(i){const{gen:s,data:a,$data:l,schemaCode:u,schema:d}=i;l||d&&typeof d=="object"?i.fail$data((0,o._)`!${(0,e.useFunc)(s,t.default)}(${a}, ${u})`):i.fail((0,o._)`${d} !== ${a}`)}};return ht.default=n,ht}var ft={},Hr;function li(){if(Hr)return ft;Hr=1,Object.defineProperty(ft,"__esModule",{value:!0});const o=Y(),e=ee(),t=Kt(),n={keyword:"enum",schemaType:"array",$data:!0,error:{message:"must be equal to one of the allowed values",params:({schemaCode:i})=>(0,o._)`{allowedValues: ${i}}`},code(i){const{gen:s,data:a,$data:l,schema:u,schemaCode:d,it:m}=i;if(!l&&u.length===0)throw new Error("enum must have non-empty array");const $=u.length>=m.opts.loopEnum;let _;const E=()=>_??(_=(0,e.useFunc)(s,t.default));let w;if($||l)w=s.let("valid"),i.block$data(w,p);else{if(!Array.isArray(u))throw new Error("ajv implementation error");const c=s.const("vSchema",d);w=(0,o.or)(...u.map((f,g)=>h(c,g)))}i.pass(w);function p(){s.assign(w,!1),s.forOf("v",d,c=>s.if((0,o._)`${E()}(${a}, ${c})`,()=>s.assign(w,!0).break()))}function h(c,f){const g=u[f];return typeof g=="object"&&g!==null?(0,o._)`${E()}(${a}, ${c}[${f}])`:(0,o._)`${a} === ${g}`}}};return ft.default=n,ft}var Br;function ui(){if(Br)return tt;Br=1,Object.defineProperty(tt,"__esModule",{value:!0});const o=Zn(),e=ei(),t=ri(),r=ni(),n=ii(),i=oi(),s=si(),a=ai(),l=ci(),u=li(),d=[o.default,e.default,t.default,r.default,n.default,i.default,s.default,a.default,{keyword:"type",schemaType:["string","array"]},{keyword:"nullable",schemaType:"boolean"},l.default,u.default];return tt.default=d,tt}var pt={},Re={},Wr;function Jr(){if(Wr)return Re;Wr=1,Object.defineProperty(Re,"__esModule",{value:!0}),Re.validateAdditionalItems=void 0;const o=Y(),e=ee(),r={keyword:"additionalItems",type:"array",schemaType:["boolean","object"],before:"uniqueItems",error:{message:({params:{len:i}})=>(0,o.str)`must NOT have more than ${i} items`,params:({params:{len:i}})=>(0,o._)`{limit: ${i}}`},code(i){const{parentSchema:s,it:a}=i,{items:l}=s;if(!Array.isArray(l)){(0,e.checkStrictMode)(a,'"additionalItems" is ignored when "items" is not an array of schemas');return}n(i,l)}};function n(i,s){const{gen:a,schema:l,data:u,keyword:d,it:m}=i;m.items=!0;const $=a.const("len",(0,o._)`${u}.length`);if(l===!1)i.setParams({len:s.length}),i.pass((0,o._)`${$} <= ${s.length}`);else if(typeof l=="object"&&!(0,e.alwaysValidSchema)(m,l)){const E=a.var("valid",(0,o._)`${$} <= ${s.length}`);a.if((0,o.not)(E),()=>_(E)),i.ok(E)}function _(E){a.forRange("i",s.length,$,w=>{i.subschema({keyword:d,dataProp:w,dataPropType:e.Type.Num},E),m.allErrors||a.if((0,o.not)(E),()=>a.break())})}}return Re.validateAdditionalItems=n,Re.default=r,Re}var mt={},xe={},Yr;function Xr(){if(Yr)return xe;Yr=1,Object.defineProperty(xe,"__esModule",{value:!0}),xe.validateTuple=void 0;const o=Y(),e=ee(),t=me(),r={keyword:"items",type:"array",schemaType:["object","array","boolean"],before:"uniqueItems",code(i){const{schema:s,it:a}=i;if(Array.isArray(s))return n(i,"additionalItems",s);a.items=!0,!(0,e.alwaysValidSchema)(a,s)&&i.ok((0,t.validateArray)(i))}};function n(i,s,a=i.schema){const{gen:l,parentSchema:u,data:d,keyword:m,it:$}=i;w(u),$.opts.unevaluated&&a.length&&$.items!==!0&&($.items=e.mergeEvaluated.items(l,a.length,$.items));const _=l.name("valid"),E=l.const("len",(0,o._)`${d}.length`);a.forEach((p,h)=>{(0,e.alwaysValidSchema)($,p)||(l.if((0,o._)`${E} > ${h}`,()=>i.subschema({keyword:m,schemaProp:h,dataProp:h},_)),i.ok(_))});function w(p){const{opts:h,errSchemaPath:c}=$,f=a.length,g=f===p.minItems&&(f===p.maxItems||p[s]===!1);if(h.strictTuples&&!g){const b=`"${m}" is ${f}-tuple, but minItems or maxItems/${s} are not specified or different at path "${c}"`;(0,e.checkStrictMode)($,b,h.strictTuples)}}}return xe.validateTuple=n,xe.default=r,xe}var Qr;function di(){if(Qr)return mt;Qr=1,Object.defineProperty(mt,"__esModule",{value:!0});const o=Xr(),e={keyword:"prefixItems",type:"array",schemaType:["array"],before:"uniqueItems",code:t=>(0,o.validateTuple)(t,"items")};return mt.default=e,mt}var yt={},Zr;function hi(){if(Zr)return yt;Zr=1,Object.defineProperty(yt,"__esModule",{value:!0});const o=Y(),e=ee(),t=me(),r=Jr(),i={keyword:"items",type:"array",schemaType:["object","boolean"],before:"uniqueItems",error:{message:({params:{len:s}})=>(0,o.str)`must NOT have more than ${s} items`,params:({params:{len:s}})=>(0,o._)`{limit: ${s}}`},code(s){const{schema:a,parentSchema:l,it:u}=s,{prefixItems:d}=l;u.items=!0,!(0,e.alwaysValidSchema)(u,a)&&(d?(0,r.validateAdditionalItems)(s,d):s.ok((0,t.validateArray)(s)))}};return yt.default=i,yt}var gt={},en;function fi(){if(en)return gt;en=1,Object.defineProperty(gt,"__esModule",{value:!0});const o=Y(),e=ee(),r={keyword:"contains",type:"array",schemaType:["object","boolean"],before:"uniqueItems",trackErrors:!0,error:{message:({params:{min:n,max:i}})=>i===void 0?(0,o.str)`must contain at least ${n} valid item(s)`:(0,o.str)`must contain at least ${n} and no more than ${i} valid item(s)`,params:({params:{min:n,max:i}})=>i===void 0?(0,o._)`{minContains: ${n}}`:(0,o._)`{minContains: ${n}, maxContains: ${i}}`},code(n){const{gen:i,schema:s,parentSchema:a,data:l,it:u}=n;let d,m;const{minContains:$,maxContains:_}=a;u.opts.next?(d=$===void 0?1:$,m=_):d=1;const E=i.const("len",(0,o._)`${l}.length`);if(n.setParams({min:d,max:m}),m===void 0&&d===0){(0,e.checkStrictMode)(u,'"minContains" == 0 without "maxContains": "contains" keyword ignored');return}if(m!==void 0&&d>m){(0,e.checkStrictMode)(u,'"minContains" > "maxContains" is always invalid'),n.fail();return}if((0,e.alwaysValidSchema)(u,s)){let f=(0,o._)`${E} >= ${d}`;m!==void 0&&(f=(0,o._)`${f} && ${E} <= ${m}`),n.pass(f);return}u.items=!0;const w=i.name("valid");m===void 0&&d===1?h(w,()=>i.if(w,()=>i.break())):d===0?(i.let(w,!0),m!==void 0&&i.if((0,o._)`${l}.length > 0`,p)):(i.let(w,!1),p()),n.result(w,()=>n.reset());function p(){const f=i.name("_valid"),g=i.let("count",0);h(f,()=>i.if(f,()=>c(g)))}function h(f,g){i.forRange("i",0,E,b=>{n.subschema({keyword:"contains",dataProp:b,dataPropType:e.Type.Num,compositeRule:!0},f),g()})}function c(f){i.code((0,o._)`${f}++`),m===void 0?i.if((0,o._)`${f} >= ${d}`,()=>i.assign(w,!0).break()):(i.if((0,o._)`${f} > ${m}`,()=>i.assign(w,!1).break()),d===1?i.assign(w,!0):i.if((0,o._)`${f} >= ${d}`,()=>i.assign(w,!0)))}}};return gt.default=r,gt}var Ht={},tn;function pi(){return tn||(tn=1,(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.validateSchemaDeps=o.validatePropertyDeps=o.error=void 0;const e=Y(),t=ee(),r=me();o.error={message:({params:{property:l,depsCount:u,deps:d}})=>{const m=u===1?"property":"properties";return(0,e.str)`must have ${m} ${d} when property ${l} is present`},params:({params:{property:l,depsCount:u,deps:d,missingProperty:m}})=>(0,e._)`{property: ${l},
    missingProperty: ${m},
    depsCount: ${u},
    deps: ${d}}`};const n={keyword:"dependencies",type:"object",schemaType:"object",error:o.error,code(l){const[u,d]=i(l);s(l,u),a(l,d)}};function i({schema:l}){const u={},d={};for(const m in l){if(m==="__proto__")continue;const $=Array.isArray(l[m])?u:d;$[m]=l[m]}return[u,d]}function s(l,u=l.schema){const{gen:d,data:m,it:$}=l;if(Object.keys(u).length===0)return;const _=d.let("missing");for(const E in u){const w=u[E];if(w.length===0)continue;const p=(0,r.propertyInData)(d,m,E,$.opts.ownProperties);l.setParams({property:E,depsCount:w.length,deps:w.join(", ")}),$.allErrors?d.if(p,()=>{for(const h of w)(0,r.checkReportMissingProp)(l,h)}):(d.if((0,e._)`${p} && (${(0,r.checkMissingProp)(l,w,_)})`),(0,r.reportMissingProp)(l,_),d.else())}}o.validatePropertyDeps=s;function a(l,u=l.schema){const{gen:d,data:m,keyword:$,it:_}=l,E=d.name("valid");for(const w in u)(0,t.alwaysValidSchema)(_,u[w])||(d.if((0,r.propertyInData)(d,m,w,_.opts.ownProperties),()=>{const p=l.subschema({keyword:$,schemaProp:w},E);l.mergeValidEvaluated(p,E)},()=>d.var(E,!0)),l.ok(E))}o.validateSchemaDeps=a,o.default=n})(Ht)),Ht}var vt={},rn;function mi(){if(rn)return vt;rn=1,Object.defineProperty(vt,"__esModule",{value:!0});const o=Y(),e=ee(),r={keyword:"propertyNames",type:"object",schemaType:["object","boolean"],error:{message:"property name must be valid",params:({params:n})=>(0,o._)`{propertyName: ${n.propertyName}}`},code(n){const{gen:i,schema:s,data:a,it:l}=n;if((0,e.alwaysValidSchema)(l,s))return;const u=i.name("valid");i.forIn("key",a,d=>{n.setParams({propertyName:d}),n.subschema({keyword:"propertyNames",data:d,dataTypes:["string"],propertyName:d,compositeRule:!0},u),i.if((0,o.not)(u),()=>{n.error(!0),l.allErrors||i.break()})}),n.ok(u)}};return vt.default=r,vt}var bt={},nn;function on(){if(nn)return bt;nn=1,Object.defineProperty(bt,"__esModule",{value:!0});const o=me(),e=Y(),t=be(),r=ee(),i={keyword:"additionalProperties",type:["object"],schemaType:["boolean","object"],allowUndefined:!0,trackErrors:!0,error:{message:"must NOT have additional properties",params:({params:s})=>(0,e._)`{additionalProperty: ${s.additionalProperty}}`},code(s){const{gen:a,schema:l,parentSchema:u,data:d,errsCount:m,it:$}=s;if(!m)throw new Error("ajv implementation error");const{allErrors:_,opts:E}=$;if($.props=!0,E.removeAdditional!=="all"&&(0,r.alwaysValidSchema)($,l))return;const w=(0,o.allSchemaProperties)(u.properties),p=(0,o.allSchemaProperties)(u.patternProperties);h(),s.ok((0,e._)`${m} === ${t.default.errors}`);function h(){a.forIn("key",d,v=>{!w.length&&!p.length?g(v):a.if(c(v),()=>g(v))})}function c(v){let P;if(w.length>8){const R=(0,r.schemaRefOrVal)($,u.properties,"properties");P=(0,o.isOwnProperty)(a,R,v)}else w.length?P=(0,e.or)(...w.map(R=>(0,e._)`${v} === ${R}`)):P=e.nil;return p.length&&(P=(0,e.or)(P,...p.map(R=>(0,e._)`${(0,o.usePattern)(s,R)}.test(${v})`))),(0,e.not)(P)}function f(v){a.code((0,e._)`delete ${d}[${v}]`)}function g(v){if(E.removeAdditional==="all"||E.removeAdditional&&l===!1){f(v);return}if(l===!1){s.setParams({additionalProperty:v}),s.error(),_||a.break();return}if(typeof l=="object"&&!(0,r.alwaysValidSchema)($,l)){const P=a.name("valid");E.removeAdditional==="failing"?(b(v,P,!1),a.if((0,e.not)(P),()=>{s.reset(),f(v)})):(b(v,P),_||a.if((0,e.not)(P),()=>a.break()))}}function b(v,P,R){const O={keyword:"additionalProperties",dataProp:v,dataPropType:r.Type.Str};R===!1&&Object.assign(O,{compositeRule:!0,createErrors:!1,allErrors:!1}),s.subschema(O,P)}}};return bt.default=i,bt}var wt={},sn;function yi(){if(sn)return wt;sn=1,Object.defineProperty(wt,"__esModule",{value:!0});const o=Be(),e=me(),t=ee(),r=on(),n={keyword:"properties",type:"object",schemaType:"object",code(i){const{gen:s,schema:a,parentSchema:l,data:u,it:d}=i;d.opts.removeAdditional==="all"&&l.additionalProperties===void 0&&r.default.code(new o.KeywordCxt(d,r.default,"additionalProperties"));const m=(0,e.allSchemaProperties)(a);for(const p of m)d.definedProperties.add(p);d.opts.unevaluated&&m.length&&d.props!==!0&&(d.props=t.mergeEvaluated.props(s,(0,t.toHash)(m),d.props));const $=m.filter(p=>!(0,t.alwaysValidSchema)(d,a[p]));if($.length===0)return;const _=s.name("valid");for(const p of $)E(p)?w(p):(s.if((0,e.propertyInData)(s,u,p,d.opts.ownProperties)),w(p),d.allErrors||s.else().var(_,!0),s.endIf()),i.it.definedProperties.add(p),i.ok(_);function E(p){return d.opts.useDefaults&&!d.compositeRule&&a[p].default!==void 0}function w(p){i.subschema({keyword:"properties",schemaProp:p,dataProp:p},_)}}};return wt.default=n,wt}var $t={},an;function gi(){if(an)return $t;an=1,Object.defineProperty($t,"__esModule",{value:!0});const o=me(),e=Y(),t=ee(),r=ee(),n={keyword:"patternProperties",type:"object",schemaType:"object",code(i){const{gen:s,schema:a,data:l,parentSchema:u,it:d}=i,{opts:m}=d,$=(0,o.allSchemaProperties)(a),_=$.filter(g=>(0,t.alwaysValidSchema)(d,a[g]));if($.length===0||_.length===$.length&&(!d.opts.unevaluated||d.props===!0))return;const E=m.strictSchema&&!m.allowMatchingProperties&&u.properties,w=s.name("valid");d.props!==!0&&!(d.props instanceof e.Name)&&(d.props=(0,r.evaluatedPropsToName)(s,d.props));const{props:p}=d;h();function h(){for(const g of $)E&&c(g),d.allErrors?f(g):(s.var(w,!0),f(g),s.if(w))}function c(g){for(const b in E)new RegExp(g).test(b)&&(0,t.checkStrictMode)(d,`property ${b} matches pattern ${g} (use allowMatchingProperties)`)}function f(g){s.forIn("key",l,b=>{s.if((0,e._)`${(0,o.usePattern)(i,g)}.test(${b})`,()=>{const v=_.includes(g);v||i.subschema({keyword:"patternProperties",schemaProp:g,dataProp:b,dataPropType:r.Type.Str},w),d.opts.unevaluated&&p!==!0?s.assign((0,e._)`${p}[${b}]`,!0):!v&&!d.allErrors&&s.if((0,e.not)(w),()=>s.break())})})}}};return $t.default=n,$t}var _t={},cn;function vi(){if(cn)return _t;cn=1,Object.defineProperty(_t,"__esModule",{value:!0});const o=ee(),e={keyword:"not",schemaType:["object","boolean"],trackErrors:!0,code(t){const{gen:r,schema:n,it:i}=t;if((0,o.alwaysValidSchema)(i,n)){t.fail();return}const s=r.name("valid");t.subschema({keyword:"not",compositeRule:!0,createErrors:!1,allErrors:!1},s),t.failResult(s,()=>t.reset(),()=>t.error())},error:{message:"must NOT be valid"}};return _t.default=e,_t}var Pt={},ln;function bi(){if(ln)return Pt;ln=1,Object.defineProperty(Pt,"__esModule",{value:!0});const e={keyword:"anyOf",schemaType:"array",trackErrors:!0,code:me().validateUnion,error:{message:"must match a schema in anyOf"}};return Pt.default=e,Pt}var St={},un;function wi(){if(un)return St;un=1,Object.defineProperty(St,"__esModule",{value:!0});const o=Y(),e=ee(),r={keyword:"oneOf",schemaType:"array",trackErrors:!0,error:{message:"must match exactly one schema in oneOf",params:({params:n})=>(0,o._)`{passingSchemas: ${n.passing}}`},code(n){const{gen:i,schema:s,parentSchema:a,it:l}=n;if(!Array.isArray(s))throw new Error("ajv implementation error");if(l.opts.discriminator&&a.discriminator)return;const u=s,d=i.let("valid",!1),m=i.let("passing",null),$=i.name("_valid");n.setParams({passing:m}),i.block(_),n.result(d,()=>n.reset(),()=>n.error(!0));function _(){u.forEach((E,w)=>{let p;(0,e.alwaysValidSchema)(l,E)?i.var($,!0):p=n.subschema({keyword:"oneOf",schemaProp:w,compositeRule:!0},$),w>0&&i.if((0,o._)`${$} && ${d}`).assign(d,!1).assign(m,(0,o._)`[${m}, ${w}]`).else(),i.if($,()=>{i.assign(d,!0),i.assign(m,w),p&&n.mergeEvaluated(p,o.Name)})})}}};return St.default=r,St}var Et={},dn;function $i(){if(dn)return Et;dn=1,Object.defineProperty(Et,"__esModule",{value:!0});const o=ee(),e={keyword:"allOf",schemaType:"array",code(t){const{gen:r,schema:n,it:i}=t;if(!Array.isArray(n))throw new Error("ajv implementation error");const s=r.name("valid");n.forEach((a,l)=>{if((0,o.alwaysValidSchema)(i,a))return;const u=t.subschema({keyword:"allOf",schemaProp:l},s);t.ok(s),t.mergeEvaluated(u)})}};return Et.default=e,Et}var Mt={},hn;function _i(){if(hn)return Mt;hn=1,Object.defineProperty(Mt,"__esModule",{value:!0});const o=Y(),e=ee(),r={keyword:"if",schemaType:["object","boolean"],trackErrors:!0,error:{message:({params:i})=>(0,o.str)`must match "${i.ifClause}" schema`,params:({params:i})=>(0,o._)`{failingKeyword: ${i.ifClause}}`},code(i){const{gen:s,parentSchema:a,it:l}=i;a.then===void 0&&a.else===void 0&&(0,e.checkStrictMode)(l,'"if" without "then" and "else" is ignored');const u=n(l,"then"),d=n(l,"else");if(!u&&!d)return;const m=s.let("valid",!0),$=s.name("_valid");if(_(),i.reset(),u&&d){const w=s.let("ifClause");i.setParams({ifClause:w}),s.if($,E("then",w),E("else",w))}else u?s.if($,E("then")):s.if((0,o.not)($),E("else"));i.pass(m,()=>i.error(!0));function _(){const w=i.subschema({keyword:"if",compositeRule:!0,createErrors:!1,allErrors:!1},$);i.mergeEvaluated(w)}function E(w,p){return()=>{const h=i.subschema({keyword:w},$);s.assign(m,$),i.mergeValidEvaluated(h,m),p?s.assign(p,(0,o._)`${w}`):i.setParams({ifClause:w})}}}};function n(i,s){const a=i.schema[s];return a!==void 0&&!(0,e.alwaysValidSchema)(i,a)}return Mt.default=r,Mt}var Tt={},fn;function Pi(){if(fn)return Tt;fn=1,Object.defineProperty(Tt,"__esModule",{value:!0});const o=ee(),e={keyword:["then","else"],schemaType:["object","boolean"],code({keyword:t,parentSchema:r,it:n}){r.if===void 0&&(0,o.checkStrictMode)(n,`"${t}" without "if" is ignored`)}};return Tt.default=e,Tt}var pn;function Si(){if(pn)return pt;pn=1,Object.defineProperty(pt,"__esModule",{value:!0});const o=Jr(),e=di(),t=Xr(),r=hi(),n=fi(),i=pi(),s=mi(),a=on(),l=yi(),u=gi(),d=vi(),m=bi(),$=wi(),_=$i(),E=_i(),w=Pi();function p(h=!1){const c=[d.default,m.default,$.default,_.default,E.default,w.default,s.default,a.default,i.default,l.default,u.default];return h?c.push(e.default,r.default):c.push(o.default,t.default),c.push(n.default),c}return pt.default=p,pt}var kt={},Rt={},mn;function Ei(){if(mn)return Rt;mn=1,Object.defineProperty(Rt,"__esModule",{value:!0});const o=Y(),t={keyword:"format",type:["number","string"],schemaType:"string",$data:!0,error:{message:({schemaCode:r})=>(0,o.str)`must match format "${r}"`,params:({schemaCode:r})=>(0,o._)`{format: ${r}}`},code(r,n){const{gen:i,data:s,$data:a,schema:l,schemaCode:u,it:d}=r,{opts:m,errSchemaPath:$,schemaEnv:_,self:E}=d;if(!m.validateFormats)return;a?w():p();function w(){const h=i.scopeValue("formats",{ref:E.formats,code:m.code.formats}),c=i.const("fDef",(0,o._)`${h}[${u}]`),f=i.let("fType"),g=i.let("format");i.if((0,o._)`typeof ${c} == "object" && !(${c} instanceof RegExp)`,()=>i.assign(f,(0,o._)`${c}.type || "string"`).assign(g,(0,o._)`${c}.validate`),()=>i.assign(f,(0,o._)`"string"`).assign(g,c)),r.fail$data((0,o.or)(b(),v()));function b(){return m.strictSchema===!1?o.nil:(0,o._)`${u} && !${g}`}function v(){const P=_.$async?(0,o._)`(${c}.async ? await ${g}(${s}) : ${g}(${s}))`:(0,o._)`${g}(${s})`,R=(0,o._)`(typeof ${g} == "function" ? ${P} : ${g}.test(${s}))`;return(0,o._)`${g} && ${g} !== true && ${f} === ${n} && !${R}`}}function p(){const h=E.formats[l];if(!h){b();return}if(h===!0)return;const[c,f,g]=v(h);c===n&&r.pass(P());function b(){if(m.strictSchema===!1){E.logger.warn(R());return}throw new Error(R());function R(){return`unknown format "${l}" ignored in schema at path "${$}"`}}function v(R){const O=R instanceof RegExp?(0,o.regexpCode)(R):m.code.formats?(0,o._)`${m.code.formats}${(0,o.getProperty)(l)}`:void 0,q=i.scopeValue("formats",{key:l,ref:R,code:O});return typeof R=="object"&&!(R instanceof RegExp)?[R.type||"string",R.validate,(0,o._)`${q}.validate`]:["string",R,q]}function P(){if(typeof h=="object"&&!(h instanceof RegExp)&&h.async){if(!_.$async)throw new Error("async format in sync schema");return(0,o._)`await ${g}(${s})`}return typeof f=="function"?(0,o._)`${g}(${s})`:(0,o._)`${g}.test(${s})`}}}};return Rt.default=t,Rt}var yn;function Mi(){if(yn)return kt;yn=1,Object.defineProperty(kt,"__esModule",{value:!0});const e=[Ei().default];return kt.default=e,kt}var Me={},gn;function Ti(){return gn||(gn=1,Object.defineProperty(Me,"__esModule",{value:!0}),Me.contentVocabulary=Me.metadataVocabulary=void 0,Me.metadataVocabulary=["title","description","default","deprecated","readOnly","writeOnly","examples"],Me.contentVocabulary=["contentMediaType","contentEncoding","contentSchema"]),Me}var vn;function ki(){if(vn)return Qe;vn=1,Object.defineProperty(Qe,"__esModule",{value:!0});const o=Qn(),e=ui(),t=Si(),r=Mi(),n=Ti(),i=[o.default,e.default,(0,t.default)(),r.default,n.metadataVocabulary,n.contentVocabulary];return Qe.default=i,Qe}var xt={},Ce={},bn;function Ri(){if(bn)return Ce;bn=1,Object.defineProperty(Ce,"__esModule",{value:!0}),Ce.DiscrError=void 0;var o;return(function(e){e.Tag="tag",e.Mapping="mapping"})(o||(Ce.DiscrError=o={})),Ce}var wn;function xi(){if(wn)return xt;wn=1,Object.defineProperty(xt,"__esModule",{value:!0});const o=Y(),e=Ri(),t=Ft(),r=Ye(),n=ee(),s={keyword:"discriminator",type:"object",schemaType:"object",error:{message:({params:{discrError:a,tagName:l}})=>a===e.DiscrError.Tag?`tag "${l}" must be string`:`value of tag "${l}" must be in oneOf`,params:({params:{discrError:a,tag:l,tagName:u}})=>(0,o._)`{error: ${a}, tag: ${u}, tagValue: ${l}}`},code(a){const{gen:l,data:u,schema:d,parentSchema:m,it:$}=a,{oneOf:_}=m;if(!$.opts.discriminator)throw new Error("discriminator: requires discriminator option");const E=d.propertyName;if(typeof E!="string")throw new Error("discriminator: requires propertyName");if(d.mapping)throw new Error("discriminator: mapping is not supported");if(!_)throw new Error("discriminator: requires oneOf keyword");const w=l.let("valid",!1),p=l.const("tag",(0,o._)`${u}${(0,o.getProperty)(E)}`);l.if((0,o._)`typeof ${p} == "string"`,()=>h(),()=>a.error(!1,{discrError:e.DiscrError.Tag,tag:p,tagName:E})),a.ok(w);function h(){const g=f();l.if(!1);for(const b in g)l.elseIf((0,o._)`${p} === ${b}`),l.assign(w,c(g[b]));l.else(),a.error(!1,{discrError:e.DiscrError.Mapping,tag:p,tagName:E}),l.endIf()}function c(g){const b=l.name("valid"),v=a.subschema({keyword:"oneOf",schemaProp:g},b);return a.mergeEvaluated(v,o.Name),b}function f(){var g;const b={},v=R(m);let P=!0;for(let V=0;V<_.length;V++){let H=_[V];if(H?.$ref&&!(0,n.schemaHasRulesButRef)(H,$.self.RULES)){const X=H.$ref;if(H=t.resolveRef.call($.self,$.schemaEnv.root,$.baseId,X),H instanceof t.SchemaEnv&&(H=H.schema),H===void 0)throw new r.default($.opts.uriResolver,$.baseId,X)}const U=(g=H?.properties)===null||g===void 0?void 0:g[E];if(typeof U!="object")throw new Error(`discriminator: oneOf subschemas (or referenced schemas) must have "properties/${E}"`);P=P&&(v||R(H)),O(U,V)}if(!P)throw new Error(`discriminator: "${E}" must be required`);return b;function R({required:V}){return Array.isArray(V)&&V.includes(E)}function O(V,H){if(V.const)q(V.const,H);else if(V.enum)for(const U of V.enum)q(U,H);else throw new Error(`discriminator: "properties/${E}" must have "const" or "enum"`)}function q(V,H){if(typeof V!="string"||V in b)throw new Error(`discriminator: "${E}" values must be unique strings`);b[V]=H}}}};return xt.default=s,xt}const Ai={$schema:"http://json-schema.org/draft-07/schema#",$id:"http://json-schema.org/draft-07/schema#",title:"Core schema meta-schema",definitions:{schemaArray:{type:"array",minItems:1,items:{$ref:"#"}},nonNegativeInteger:{type:"integer",minimum:0},nonNegativeIntegerDefault0:{allOf:[{$ref:"#/definitions/nonNegativeInteger"},{default:0}]},simpleTypes:{enum:["array","boolean","integer","null","number","object","string"]},stringArray:{type:"array",items:{type:"string"},uniqueItems:!0,default:[]}},type:["object","boolean"],properties:{$id:{type:"string",format:"uri-reference"},$schema:{type:"string",format:"uri"},$ref:{type:"string",format:"uri-reference"},$comment:{type:"string"},title:{type:"string"},description:{type:"string"},default:!0,readOnly:{type:"boolean",default:!1},examples:{type:"array",items:!0},multipleOf:{type:"number",exclusiveMinimum:0},maximum:{type:"number"},exclusiveMaximum:{type:"number"},minimum:{type:"number"},exclusiveMinimum:{type:"number"},maxLength:{$ref:"#/definitions/nonNegativeInteger"},minLength:{$ref:"#/definitions/nonNegativeIntegerDefault0"},pattern:{type:"string",format:"regex"},additionalItems:{$ref:"#"},items:{anyOf:[{$ref:"#"},{$ref:"#/definitions/schemaArray"}],default:!0},maxItems:{$ref:"#/definitions/nonNegativeInteger"},minItems:{$ref:"#/definitions/nonNegativeIntegerDefault0"},uniqueItems:{type:"boolean",default:!1},contains:{$ref:"#"},maxProperties:{$ref:"#/definitions/nonNegativeInteger"},minProperties:{$ref:"#/definitions/nonNegativeIntegerDefault0"},required:{$ref:"#/definitions/stringArray"},additionalProperties:{$ref:"#"},definitions:{type:"object",additionalProperties:{$ref:"#"},default:{}},properties:{type:"object",additionalProperties:{$ref:"#"},default:{}},patternProperties:{type:"object",additionalProperties:{$ref:"#"},propertyNames:{format:"regex"},default:{}},dependencies:{type:"object",additionalProperties:{anyOf:[{$ref:"#"},{$ref:"#/definitions/stringArray"}]}},propertyNames:{$ref:"#"},const:!0,enum:{type:"array",items:!0,minItems:1,uniqueItems:!0},type:{anyOf:[{$ref:"#/definitions/simpleTypes"},{type:"array",items:{$ref:"#/definitions/simpleTypes"},minItems:1,uniqueItems:!0}]},format:{type:"string"},contentMediaType:{type:"string"},contentEncoding:{type:"string"},if:{$ref:"#"},then:{$ref:"#"},else:{$ref:"#"},allOf:{$ref:"#/definitions/schemaArray"},anyOf:{$ref:"#/definitions/schemaArray"},oneOf:{$ref:"#/definitions/schemaArray"},not:{$ref:"#"}},default:!0};var $n;function Ni(){return $n||($n=1,(function(o,e){Object.defineProperty(e,"__esModule",{value:!0}),e.MissingRefError=e.ValidationError=e.CodeGen=e.Name=e.nil=e.stringify=e.str=e._=e.KeywordCxt=e.Ajv=void 0;const t=Jn(),r=ki(),n=xi(),i=Ai,s=["/properties"],a="http://json-schema.org/draft-07/schema";class l extends t.default{_addVocabularies(){super._addVocabularies(),r.default.forEach(E=>this.addVocabulary(E)),this.opts.discriminator&&this.addKeyword(n.default)}_addDefaultMetaSchema(){if(super._addDefaultMetaSchema(),!this.opts.meta)return;const E=this.opts.$data?this.$dataMetaSchema(i,s):i;this.addMetaSchema(E,a,!1),this.refs["http://json-schema.org/schema"]=a}defaultMeta(){return this.opts.defaultMeta=super.defaultMeta()||(this.getSchema(a)?a:void 0)}}e.Ajv=l,o.exports=e=l,o.exports.Ajv=l,Object.defineProperty(e,"__esModule",{value:!0}),e.default=l;var u=Be();Object.defineProperty(e,"KeywordCxt",{enumerable:!0,get:function(){return u.KeywordCxt}});var d=Y();Object.defineProperty(e,"_",{enumerable:!0,get:function(){return d._}}),Object.defineProperty(e,"str",{enumerable:!0,get:function(){return d.str}}),Object.defineProperty(e,"stringify",{enumerable:!0,get:function(){return d.stringify}}),Object.defineProperty(e,"nil",{enumerable:!0,get:function(){return d.nil}}),Object.defineProperty(e,"Name",{enumerable:!0,get:function(){return d.Name}}),Object.defineProperty(e,"CodeGen",{enumerable:!0,get:function(){return d.CodeGen}});var m=zt();Object.defineProperty(e,"ValidationError",{enumerable:!0,get:function(){return m.default}});var $=Ye();Object.defineProperty(e,"MissingRefError",{enumerable:!0,get:function(){return $.default}})})(Fe,Fe.exports)),Fe.exports}var ji=Ni();const Oi=je(ji),Ii={$schema:"http://json-schema.org/draft-07/schema#",title:"JMON Composition (Multi-Track, Extended)",description:"A declarative music format supporting synthesis, MIDI, score notation, key changes, arbitrary metadata, annotations, and custom presets. Time values should use the bars:beats:ticks format (e.g., '2:1:240') for precise musical timing. This format is independent of BPM and follows professional DAW standards.",type:"object",required:["format","version","bpm","tracks"],properties:JSON.parse(`{"format":{"type":"string","const":"jmon","description":"The format identifier for the JMON schema."},"version":{"type":"string","description":"JMON schema version."},"bpm":{"type":"number","minimum":20,"maximum":400,"description":"Tempo in beats per minute."},"keySignature":{"type":"string","pattern":"^[A-G](#|b)?m?$","description":"Key signature (e.g., 'C', 'Am', 'F#')."},"keySignatureMap":{"type":"array","description":"Map of key signature changes over time.","items":{"type":"object","required":["time","keySignature"],"properties":{"time":{"oneOf":[{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format (e.g., '2:0:0')."},{"type":"number","description":"Legacy: Time in beats (deprecated)."}],"description":"Time of the key signature change."},"keySignature":{"type":"string","pattern":"^[A-G](#|b)?m?$","description":"New key signature at this time."}},"additionalProperties":false}},"timeSignature":{"type":"string","pattern":"^\\\\d+/\\\\d+$","description":"Time signature for the composition (e.g., '4/4')."},"tempoMap":{"type":"array","description":"Map of tempo changes over time.","items":{"type":"object","required":["time","bpm"],"properties":{"time":{"oneOf":[{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format (e.g., '4:0:0')."},{"type":"number","description":"Legacy: Time in beats (deprecated)."}],"description":"The time point for the tempo change."},"bpm":{"type":"number","minimum":20,"maximum":400,"description":"Tempo in beats per minute at this time point."}},"additionalProperties":false}},"transport":{"type":"object","description":"Settings controlling global playback and looping.","properties":{"startOffset":{"oneOf":[{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format (e.g., '0:2:0')."},{"type":"number","description":"Legacy: Time in beats (deprecated)."}],"description":"Offset for when playback should start."},"globalLoop":{"type":"boolean","description":"Whether the entire project should loop."},"globalLoopEnd":{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format where the global loop should end (e.g., '8:0:0')."},"swing":{"type":"number","minimum":0,"maximum":1,"description":"Swing amount (0-1)."}},"additionalProperties":false},"metadata":{"type":"object","description":"Metadata for the composition, allowing arbitrary fields.","properties":{"name":{"type":"string","description":"Name of the composition."},"author":{"type":"string","description":"Author or composer."},"description":{"type":"string","description":"Description of the composition."}},"additionalProperties":true},"customPresets":{"type":"array","description":"Array of custom user-defined presets for synths or effects.","items":{"type":"object","required":["id","type","options"],"properties":{"id":{"type":"string","description":"Unique identifier for this preset."},"type":{"type":"string","description":"Type of preset (e.g., 'Synth', 'Effect', 'Sampler')."},"options":{"type":"object","description":"Preset options."}},"additionalProperties":false}},"audioGraph":{"type":"array","description":"Audio node graph for synthesis. If not provided, a default synth->master setup will be created automatically.","default":[{"id":"synth","type":"Synth","options":{}},{"id":"master","type":"Destination","options":{}}],"items":{"type":"object","required":["id","type","options"],"properties":{"id":{"type":"string","description":"Unique identifier for this node."},"type":{"type":"string","enum":["Synth","PolySynth","MonoSynth","AMSynth","FMSynth","DuoSynth","PluckSynth","NoiseSynth","Sampler","Filter","AutoFilter","Reverb","FeedbackDelay","PingPongDelay","Delay","Chorus","Phaser","Tremolo","Vibrato","AutoWah","Distortion","Chebyshev","BitCrusher","Compressor","Limiter","Gate","FrequencyShifter","PitchShift","JCReverb","Freeverb","StereoWidener","MidSideCompressor","Destination"],"description":"Type of audio node (Synth, Sampler, Effect, etc.)."},"options":{"type":"object","description":"Options for this node. Content varies by node type."},"target":{"type":"string","description":"Target node for audio routing."},"presetRef":{"type":"string","description":"Reference to a custom preset."}},"allOf":[{"if":{"properties":{"type":{"const":"Sampler"}}},"then":{"properties":{"options":{"type":"object","properties":{"urls":{"type":"object","description":"Sample URLs for Sampler nodes (note -> file path mapping)","patternProperties":{"^[A-G](#|b)?[0-8]$":{"type":"string","description":"File path to sample for this note"}}},"envelope":{"type":"object","description":"Automatic envelope for Samplers to smooth attack/release","properties":{"enabled":{"type":"boolean","default":true,"description":"Whether to apply automatic envelope"},"attack":{"type":"number","minimum":0,"maximum":2,"default":0.02,"description":"Attack time in seconds"},"decay":{"type":"number","minimum":0,"maximum":2,"default":0.1,"description":"Decay time in seconds"},"sustain":{"type":"number","minimum":0,"maximum":1,"default":0.8,"description":"Sustain level (0-1)"},"release":{"type":"number","minimum":0,"maximum":5,"default":0.3,"description":"Release time in seconds"}},"additionalProperties":false}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"enum":["Synth","PolySynth","MonoSynth","AMSynth","FMSynth","DuoSynth","PluckSynth","NoiseSynth"]}}},"then":{"properties":{"options":{"type":"object","properties":{"oscillator":{"type":"object","description":"Oscillator settings for synths"},"envelope":{"type":"object","description":"ADSR envelope settings for synths"},"filter":{"type":"object","description":"Filter settings for synths"}},"additionalProperties":true}}}},{"if":{"properties":{"type":{"enum":["Reverb","JCReverb","Freeverb"]}}},"then":{"properties":{"options":{"type":"object","properties":{"wet":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Wet/dry mix (0=dry, 1=wet)"},"roomSize":{"type":"number","minimum":0,"maximum":1,"default":0.7,"description":"Room size for reverb effects"},"dampening":{"type":"number","minimum":0,"maximum":1,"default":0.3,"description":"Dampening for reverb effects"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"enum":["Delay","FeedbackDelay","PingPongDelay"]}}},"then":{"properties":{"options":{"type":"object","properties":{"wet":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Wet/dry mix (0=dry, 1=wet)"},"delayTime":{"type":"string","default":"8n","description":"Delay time (note values like '8n' or seconds)"},"feedback":{"type":"number","minimum":0,"maximum":0.95,"default":0.4,"description":"Feedback amount for delay effects"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"enum":["Filter","AutoFilter"]}}},"then":{"properties":{"options":{"type":"object","properties":{"frequency":{"type":"number","minimum":20,"maximum":20000,"default":1000,"description":"Filter frequency"},"Q":{"type":"number","minimum":0.1,"maximum":50,"default":1,"description":"Filter Q/resonance"},"type":{"type":"string","enum":["lowpass","highpass","bandpass","notch"],"default":"lowpass","description":"Filter type"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"enum":["Chorus","Phaser"]}}},"then":{"properties":{"options":{"type":"object","properties":{"wet":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Wet/dry mix (0=dry, 1=wet)"},"depth":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Modulation depth"},"rate":{"type":"string","default":"4n","description":"Modulation rate (note values or Hz)"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"enum":["Compressor","Limiter","Gate"]}}},"then":{"properties":{"options":{"type":"object","properties":{"threshold":{"type":"number","minimum":-60,"maximum":0,"default":-24,"description":"Threshold in dB"},"ratio":{"type":"number","minimum":1,"maximum":20,"default":4,"description":"Compression ratio"},"attack":{"type":"number","minimum":0,"maximum":1,"default":0.003,"description":"Attack time for compressor/gate"},"release":{"type":"number","minimum":0,"maximum":1,"default":0.1,"description":"Release time for compressor/gate"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"enum":["Distortion","Chebyshev"]}}},"then":{"properties":{"options":{"type":"object","properties":{"wet":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Wet/dry mix (0=dry, 1=wet)"},"distortion":{"type":"number","minimum":0,"maximum":1,"default":0.4,"description":"Distortion amount"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"const":"BitCrusher"}}},"then":{"properties":{"options":{"type":"object","properties":{"wet":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Wet/dry mix (0=dry, 1=wet)"},"bits":{"type":"number","minimum":1,"maximum":16,"default":4,"description":"Bit depth for BitCrusher"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"const":"Tremolo"}}},"then":{"properties":{"options":{"type":"object","properties":{"wet":{"type":"number","minimum":0,"maximum":1,"default":1,"description":"Wet/dry mix (0=dry, 1=wet)"},"frequency":{"type":"number","minimum":0.1,"maximum":20,"default":4,"description":"Tremolo frequency in Hz"},"depth":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Tremolo depth"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"const":"Destination"}}},"then":{"properties":{"options":{"type":"object","properties":{},"additionalProperties":false}}}}],"additionalProperties":false}},"connections":{"type":"array","description":"Array of audio graph connections. Each is a two-element array [source, target]. If not provided, default connections will be created automatically.","default":[["synth","master"]],"items":{"type":"array","minItems":2,"maxItems":2,"items":{"type":"string"}}},"tracks":{"type":"array","description":"Musical tracks (sequences or parts).","items":{"type":"object","required":["label","notes"],"properties":{"label":{"type":"string","description":"Label for this sequence (e.g., 'lead', 'bass', etc.)."},"midiChannel":{"type":"integer","minimum":0,"maximum":15,"description":"Default MIDI channel for this sequence (0-15)."},"synth":{"type":"object","required":["type"],"properties":{"type":{"type":"string","enum":["Synth","PolySynth","MonoSynth","AMSynth","FMSynth","DuoSynth","PluckSynth","NoiseSynth","Sampler"],"description":"Type of synthesizer (Synth, Sampler, AMSynth, FMSynth, etc.)."},"options":{"type":"object","description":"Synthesizer options."},"presetRef":{"type":"string","description":"Reference to a custom preset."},"modulationTarget":{"type":"string","enum":["vibrato","tremolo","glissando","filter"],"description":"Target for modulation wheel (CC1) control. Determines how modulation wheel affects the synth."}},"additionalProperties":false,"description":"Synthesizer definition for this sequence."},"synthRef":{"type":"string","description":"Reference to an audioGraph node to use as the synth."},"notes":{"type":"array","description":"Array of note events.","items":{"type":"object","required":["pitch","time","duration"],"properties":{"pitch":{"oneOf":[{"type":"number","description":"MIDI note number (preferred)."},{"type":"string","description":"Note name (e.g., 'C4', 'G#3')."},{"type":"array","description":"Chord (array of MIDI numbers or note names).","items":{"oneOf":[{"type":"number"},{"type":"string"}]}}]},"time":{"oneOf":[{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format (e.g., '0:2:0', '1:3.5:240'). Preferred format for precise musical timing."},{"type":"string","pattern":"^(\\\\d+n|\\\\d+t)$","description":"Tone.js note values (e.g., '4n', '8t') for relative timing."},{"type":"number","description":"Legacy: Time in beats (deprecated, use bars:beats:ticks format instead)."}]},"duration":{"oneOf":[{"type":"string","pattern":"^(\\\\d+n|\\\\d+t|\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+)$","description":"Musical duration using Tone.js note values (e.g., '4n', '8n', '2t') or bars:beats:ticks format (e.g., '1:0:0')."},{"type":"number","description":"Legacy: Duration in seconds (deprecated, use note values instead)."}]},"velocity":{"type":"number","minimum":0,"maximum":1,"description":"Note velocity (0-1)."},"articulation":{"type":"string","enum":["staccato","accent","tenuto","legato","marcato"],"description":"Performance instruction that affects how a note is played (e.g., 'staccato', 'accent')."},"ornaments":{"type":"array","description":"Array of melodic ornaments to apply to this note","items":{"type":"object","required":["type"],"properties":{"type":{"type":"string","enum":["grace_note","trill","mordent","turn","arpeggio"],"description":"Type of ornament"},"parameters":{"type":"object","description":"Parameters specific to this ornament type","oneOf":[{"if":{"properties":{"type":{"const":"grace_note"}}},"then":{"properties":{"graceNoteType":{"type":"string","enum":["acciaccatura","appoggiatura"],"description":"Type of grace note"},"gracePitches":{"type":"array","items":{"oneOf":[{"type":"number","description":"MIDI note number"},{"type":"string","description":"Note name (e.g., 'C4')"}]},"description":"Optional specific pitches for the grace note(s)"}},"required":["graceNoteType"]}},{"if":{"properties":{"type":{"const":"trill"}}},"then":{"properties":{"by":{"type":"number","default":1,"description":"Interval for the trill (in scale steps)"},"trillRate":{"type":"number","default":0.125,"description":"Duration of each note in the trill"}}}},{"if":{"properties":{"type":{"const":"mordent"}}},"then":{"properties":{"by":{"type":"number","default":1,"description":"Interval for the mordent (in scale steps)"}}}},{"if":{"properties":{"type":{"const":"turn"}}},"then":{"properties":{"scale":{"type":"string","description":"Optional scale context for the turn"}}}},{"if":{"properties":{"type":{"const":"arpeggio"}}},"then":{"properties":{"arpeggioDegrees":{"type":"array","items":{"type":"number"},"description":"Scale degrees for the arpeggio"},"direction":{"type":"string","enum":["up","down","both"],"default":"up","description":"Direction of the arpeggio"}},"required":["arpeggioDegrees"]}}]}},"additionalProperties":false}},"microtuning":{"type":"number","description":"Microtuning adjustment in semitones."},"channel":{"type":"integer","minimum":0,"maximum":15,"description":"Override sequence MIDI channel for this note (0-15)."},"modulations":{"type":"array","description":"Per-note modulation events (CC, pitch bend, aftertouch).","items":{"type":"object","required":["type","value","time"],"properties":{"type":{"type":"string","enum":["cc","pitchBend","aftertouch"],"description":"Type of MIDI modulation event."},"controller":{"type":"integer","description":"MIDI CC number (required for type: 'cc')."},"value":{"type":"number","description":"Value for this modulation: 0-127 for CC, -8192 to +8192 for pitchBend (14-bit, maps to ±2 semitones), 0-127 for aftertouch."},"time":{"oneOf":[{"type":"string","pattern":"^(\\\\d+n|\\\\d+t|\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+)$","description":"Relative time using note values (e.g., '8n') or bars:beats:ticks (e.g., '0:0:240')."},{"type":"number","description":"Legacy: Relative time in seconds (deprecated)."}],"description":"When this modulation event happens (relative to note start)."}},"additionalProperties":false}}},"additionalProperties":false}},"loop":{"oneOf":[{"type":"boolean"},{"type":"string"}],"description":"Whether this sequence loops, or string for musical duration."},"loopEnd":{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format to end the loop (e.g., '4:0:0')."},"effects":{"type":"array","description":"Sequence-level effects.","items":{"type":"object","required":["type"],"properties":{"type":{"type":"string","description":"Type of effect (e.g., 'Reverb', 'Delay')."},"options":{"type":"object","description":"Options for this effect."},"presetRef":{"type":"string","description":"Reference to a custom preset."}},"additionalProperties":false}},"automation":{"type":"array","description":"Sequence-level automation channels affecting only this sequence.","items":{"$ref":"#/definitions/automationChannel"}}},"additionalProperties":false}},"automation":{"type":"object","description":"Multi-level automation system with interpolation support.","properties":{"enabled":{"type":"boolean","default":true,"description":"Whether automation is enabled globally."},"global":{"type":"array","description":"Global automation channels affecting the entire composition.","items":{"$ref":"#/definitions/automationChannel"}},"tracks":{"type":"object","description":"Sequence-level automation channels organized by sequence ID.","patternProperties":{".*":{"type":"array","description":"Automation channels for this sequence.","items":{"$ref":"#/definitions/automationChannel"}}},"additionalProperties":false},"events":{"type":"array","description":"Legacy automation events (deprecated, use channels instead).","items":{"type":"object","required":["target","time","value"],"properties":{"target":{"type":"string","description":"Parameter to automate, e.g., 'synth.frequency', 'effect.mix', 'midi.cc1'."},"time":{"oneOf":[{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format."},{"type":"number","description":"Legacy: Time in beats (deprecated)."}]},"value":{"type":"number","description":"Target value for the parameter."}},"additionalProperties":false}}},"additionalProperties":false},"annotations":{"type":"array","description":"Annotations (e.g., lyrics, rehearsal marks, comments) in the composition.","items":{"type":"object","required":["text","time"],"properties":{"text":{"type":"string","description":"Annotation text (e.g., lyric, instruction, label)."},"time":{"oneOf":[{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format (e.g., '1:2:0')."},{"type":"number","description":"Legacy: Time in beats (deprecated)."}]},"type":{"type":"string","description":"Type of annotation (e.g., 'lyric', 'marker', 'comment', 'rehearsal')."},"duration":{"oneOf":[{"type":"string","pattern":"^(\\\\d+n|\\\\d+t|\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+)$","description":"Musical duration using note values (e.g., '4n') or bars:beats:ticks (e.g., '1:0:0')."},{"type":"number","description":"Legacy: Duration in seconds (deprecated)."}],"description":"Optional duration for annotation (e.g., for lyrics or extended comments)."}},"additionalProperties":false}},"timeSignatureMap":{"type":"array","description":"Map of time signature changes over time.","items":{"type":"object","required":["time","timeSignature"],"properties":{"time":{"oneOf":[{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format (e.g., '8:0:0')."},{"type":"number","description":"Legacy: Time in beats (deprecated)."}],"description":"Time of the time signature change."},"timeSignature":{"type":"string","pattern":"^\\\\d+/\\\\d+$","description":"New time signature at this time."}},"additionalProperties":false}},"synthConfig":{"type":"object","description":"Global synthesizer configuration that applies to all tracks unless overridden.","properties":{"type":{"type":"string","enum":["Synth","PolySynth","MonoSynth","AMSynth","FMSynth","DuoSynth","PluckSynth","NoiseSynth","Sampler"],"description":"Default synthesizer type (Synth, Sampler, AMSynth, FMSynth, etc.)."},"modulationTarget":{"type":"string","enum":["vibrato","tremolo","glissando","filter"],"description":"Default target for modulation wheel (CC1) control across all tracks."},"options":{"type":"object","description":"Default synthesizer options applied globally.","properties":{"envelope":{"type":"object","description":"Automatic envelope settings for Samplers to avoid abrupt cuts","properties":{"enabled":{"type":"boolean","default":true,"description":"Whether to apply automatic envelope to Samplers"},"attack":{"type":"number","minimum":0,"maximum":2,"default":0.02,"description":"Attack time in seconds"},"decay":{"type":"number","minimum":0,"maximum":2,"default":0.1,"description":"Decay time in seconds"},"sustain":{"type":"number","minimum":0,"maximum":1,"default":0.8,"description":"Sustain level (0-1)"},"release":{"type":"number","minimum":0,"maximum":5,"default":0.3,"description":"Release time in seconds"}},"additionalProperties":false}}}},"additionalProperties":false},"converterHints":{"type":"object","description":"Optional hints to guide specific converters.","properties":{"tone":{"type":"object","description":"Hints for jmon-tone.js converter.","patternProperties":{"^cc[0-9]+$":{"type":"object","description":"Hint configuration for a MIDI CC controller mapping.","properties":{"target":{"type":"string","description":"Target for this CC mapping - can be legacy target (filter, vibrato, tremolo, glissando) or specific effect node ID from audioGraph."},"parameter":{"type":"string","description":"Parameter name to control on the target effect (e.g., 'frequency', 'depth', 'Q')."},"frequency":{"type":"number","description":"Modulation rate in Hz (for vibrato/tremolo)."},"depthRange":{"type":"array","description":"Min/max depth or frequency range for the parameter.","items":{"type":"number"},"minItems":2,"maxItems":2}},"required":["target"],"additionalProperties":false}},"additionalProperties":false},"midi":{"type":"object","description":"Hints for jmon-midi.js converter.","properties":{"channel":{"type":"integer","minimum":0,"maximum":15,"description":"Default MIDI channel for outgoing messages."},"port":{"type":"string","description":"MIDI port name or identifier."}},"additionalProperties":false}},"additionalProperties":false}}`),definitions:{automationChannel:{type:"object",description:"Automation channel with interpolation support and anchor points.",required:["id","target","anchorPoints"],properties:{id:{type:"string",description:"Unique identifier for this automation channel."},name:{type:"string",description:"Human-readable name for this automation channel."},target:{type:"string",description:"JMON target parameter (e.g., 'synth.frequency', 'midi.cc1', 'effect.mix')."},level:{type:"string",enum:["global","sequence","note"],default:"global",description:"Automation level: global (entire composition), sequence (per track), or note (per note velocity)."},sequenceId:{type:"string",description:"Target sequence ID for sequence-level automation."},range:{type:"array",items:{type:"number"},minItems:2,maxItems:2,default:[0,127],description:"Value range [min, max] for this automation parameter."},interpolation:{type:"string",enum:["linear","quadratic","cubic","daw"],default:"daw",description:"Interpolation type: linear, quadratic (curve), cubic (smoothstep), or daw (Hermite splines)."},enabled:{type:"boolean",default:!0,description:"Whether this automation channel is enabled."},anchorPoints:{type:"array",description:"Automation anchor points defining the curve.",items:{type:"object",required:["time","value"],properties:{time:{oneOf:[{type:"string",pattern:"^\\d+:\\d+(\\.\\d+)?:\\d+$",description:"Musical time in bars:beats:ticks format (e.g., '2:1:240')."},{type:"number",description:"Time in measures (e.g., 2.5 = 2 bars + 2 beats in 4/4)."}]},value:{type:"number",description:"Automation value at this time point."},tangent:{type:"number",description:"Optional tangent/slope for Hermite interpolation (DAW mode)."}},additionalProperties:!1}}},additionalProperties:!1}},additionalProperties:!1};class _n{constructor(e=Ii){this.ajv=new Oi({allErrors:!0,useDefaults:!0}),this.validate=this.ajv.compile(e)}validateAndNormalize(e){const t=JSON.parse(JSON.stringify(e)),r=this.validate(t);return{valid:r,errors:this.validate.errors||null,normalized:r?t:null}}getValidJmon(e){const{valid:t,normalized:r}=this.validateAndNormalize(e);return t?r:null}}class oe{static chromatic_scale=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];static flat_to_sharp={Bb:"A#",Db:"C#",Eb:"D#",Gb:"F#",Ab:"G#","B♭":"A#","D♭":"C#","E♭":"D#","G♭":"F#","A♭":"G#","B-":"A#","D-":"C#","E-":"D#","G-":"F#","A-":"G#"};static scale_intervals={major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],diminished:[0,2,3,5,6,8,9,11],"major pentatonic":[0,2,4,7,9],"minor pentatonic":[0,3,5,7,10],chromatic:[0,1,2,3,4,5,6,7,8,9,10,11],lydian:[0,2,4,6,7,9,11],mixolydian:[0,2,4,5,7,9,10],dorian:[0,2,3,5,7,9,10],phrygian:[0,1,3,5,7,8,10],locrian:[0,1,3,5,6,8,10],"harmonic minor":[0,2,3,5,7,8,11],"melodic minor ascending":[0,2,3,5,7,9,11],"melodic minor descending":[0,2,3,5,7,8,10]};static intervals={P1:0,m2:1,M2:2,m3:3,M3:4,P4:5,P5:7,m6:8,M6:9,m7:10,M7:11,P8:12};static convertFlatToSharp(e){return this.flat_to_sharp[e]||e}static noteNameToMidi(e){const t=e.match(/^([A-G][#b♭-]?)(-?\d+)$/);if(!t)throw new Error(`Invalid note name format: ${e}`);const[,r,n]=t,i=this.convertFlatToSharp(r),s=this.chromatic_scale.indexOf(i);if(s===-1)throw new Error(`Invalid note name: ${r}`);return s+(parseInt(n)+1)*12}static midiToNoteName(e,t=!1){const r=Math.floor(e/12)-1,n=e%12;return`${this.chromatic_scale[n]}${r}`}static scaleToTriad(e){return[e[0],e[2],e[4]]}}class Pn{constructor(e,t="major"){const r=oe.convertFlatToSharp(e);if(!oe.chromatic_scale.includes(r))throw new Error(`'${e}' is not a valid tonic note. Select one among '${oe.chromatic_scale.join(", ")}'.`);if(this.tonic=r,!Object.keys(oe.scale_intervals).includes(t))throw new Error(`'${t}' is not a valid scale. Select one among '${Object.keys(oe.scale_intervals).join(", ")}'.`);this.mode=t}generate(e={}){const t=oe.scale_intervals[this.mode];if(!t)return console.warn(`Unknown scale mode: ${this.mode}`),[];typeof e.start=="string"&&(e.start=oe.noteNameToMidi(e.start)),typeof e.end=="string"&&(e.end=oe.noteNameToMidi(e.end));const r=e.start??60;if(oe.chromatic_scale.indexOf(this.tonic)===-1)return console.warn(`Unknown tonic: ${this.tonic}`),[];const i=(a,l)=>{const u=l%t.length,d=Math.floor(l/t.length)*12,m=t[u];return a+m+d},s=[];if(e.end!==void 0)for(let a=0;;a++){const l=i(r,a);if(l>e.end)break;s.push(l)}else if(e.length)for(let a=0;a<e.length;a++)s.push(i(r,a));else return t.map(a=>r+a);return s}getNoteNames(){const e=oe.scale_intervals[this.mode];if(!e)return[];const t=oe.chromatic_scale.indexOf(this.tonic);return t===-1?[]:e.map(r=>{const n=(t+r)%12;return oe.chromatic_scale[n]})}isInScale(e){const t=e%12;return this.generate().map(n=>n%12).includes(t)}}function Ci(o){if(typeof o=="object"&&!Array.isArray(o))return o;if(Array.isArray(o)){if(o.length===0)return{};if(o.every(t=>Array.isArray(t)&&t.length===3))return{"track 1":o};const e={};return o.forEach((t,r)=>{e[`track ${r+1}`]=t}),e}throw new Error("Input must be a list or dict of tracks.")}function Sn(o,e){return e.reduce((t,r)=>Math.abs(r-o)<Math.abs(t-o)?r:t)}function En(o){return Math.floor(o/12)-1}function qi(o){return{"D-":"C#","E-":"D#","G-":"F#","A-":"G#","B-":"A#",Db:"C#",Eb:"D#",Gb:"F#",Ab:"G#",Bb:"A#"}[o]||o}function Bt(o,e,t){typeof o=="string"&&(o=qe(o)),typeof t=="string"&&(t=qe(t));const r=e.indexOf(t);if(e.includes(o))return e.indexOf(o)-r;{const n=Sn(o,e),i=e.indexOf(n),s=i>0?i-1:i,a=e[s],l=n-o,u=o-a,d=l+u;if(d===0)return i-r;const m=1-l/d,$=1-u/d,_=i-r,E=s-r;return _*m+E*$}}function Di(o,e,t){const r=e.indexOf(t),n=Math.round(r+o);if(n>=0&&n<e.length)return e[n];{const i=Math.max(0,Math.min(n,e.length-1)),s=Math.min(e.length-1,Math.max(n,0)),a=e[i],l=e[s],u=s-n,d=n-i,m=u+d;if(m===0)return(l+a)/2;const $=1-u/m,_=1-d/m;return l*$+a*_}}function Mn(o){o.length>0&&o[0].length===2&&(o=o.map(r=>[r[0],r[1],0]));const e=[];let t=0;for(const[r,n,i]of o)e.push([r,n,t]),t+=n;return e}function Tn(o,e=0){const t=[...o].sort((i,s)=>i[2]-s[2]);let r=0;const n=[];for(const i of t){const[s,a,l]=i,u=e+l;if(u>r){const m=[null,u-r,r-e];n.push(m)}n.push(i),r=Math.max(r,u+a)}return n}function kn(o){o.sort((e,t)=>e[2]-t[2]);for(let e=0;e<o.length-1;e++){const t=o[e],r=o[e+1];if(t[2]+t[1]>r[2]){const i=r[2]-t[2];o[e]=[t[0],i,t[2]]}}return o}function Vi(o){return kn(Tn(o))}function qe(o){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],t={Db:"C#",Eb:"D#",Gb:"F#",Ab:"G#",Bb:"A#",Cb:"B"};let r=4,n=o;if(o.includes("b")){const a=o.slice(0,-1);t[a]&&(n=t[a]+o.slice(-1))}let i;return n.length>2||n.length===2&&!isNaN(n[1])?(i=n.slice(0,-1),r=parseInt(n.slice(-1))):i=n[0],12*(r+1)+e.indexOf(i)}function zi(o){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],t=Math.floor(o/12)-1,r=o%12;return e[r]+t.toString()}function Fi(o,e="offsets"){const t=[];let r=0;for(const[n,i,s]of o)t.push([n,i,r]),r+=i;return t}function Li(o){return o.every(e=>Array.isArray(e))?"list of tuples":o.every(e=>!Array.isArray(e))?"list":"unknown"}function Ui(o,e,t,r=null,n=null){const i=r!==null?r:Math.min(...o),s=n!==null?n:Math.max(...o);return i===s?new Array(o.length).fill((e+t)/2):o.map(a=>(a-i)*(t-e)/(s-i)+e)}function Rn(o,e){return o.map(([t,r,n])=>[t,r,n+e])}function Gi(o,e,t){const r=[];for(const[n,i,s]of o){const a=Math.round(s/t)*t,l=(Math.floor(a/e)+1)*e;let u=Math.round(i/t)*t;u=Math.min(u,l-a),u>0&&r.push([n,u,a])}return r}function Ki(o,e){const r=o.filter(([a,,l])=>a!==null&&l!==null).sort((a,l)=>a[2]-l[2]),n=Math.max(...r.map(([,,a])=>a)),i=Math.floor(n/e)+1,s=[];for(let a=0;a<i;a++){const l=a*e;let u=null,d=1/0;for(const[m,,$]of r){const _=l-$;if(_>=0&&_<d&&(d=_,u=m),$>l)break}u!==null&&s.push(u)}return s}function Hi(o,e){return e.reduce((t,r)=>Math.abs(r-o)<Math.abs(t-o)?r:t)}function Bi(o,e){return 60/e*o}function*Wi(o=0,e=1,t=0,r=1){for(;;)yield t+r*o,[o,e]=[e,o+e]}function Ji(o,e,t){const r={};for(const[n,i]of Object.entries(o)){const s=[];for(let a=0;a<e;a++){const l=a*t,u=Rn(i,l);s.push(...u)}r[n]=s}return r}const Yi=Object.freeze(Object.defineProperty({__proto__:null,adjustNoteDurationsToPreventOverlaps:kn,cdeToMidi:qe,checkInput:Li,fibonacci:Wi,fillGapsWithRests:Tn,findClosestPitchAtMeasureStart:Ki,getDegreeFromPitch:Bt,getOctave:En,getPitchFromDegree:Di,getSharp:qi,instrumentMapping:{"Acoustic Grand Piano":0,"Bright Acoustic Piano":1,"Electric Grand Piano":2,"Honky-tonk Piano":3,"Electric Piano 1":4,"Electric Piano 2":5,Harpsichord:6,Clavinet:7,Gunshot:127},midiToCde:zi,noOverlap:Fi,offsetTrack:Rn,qlToSeconds:Bi,quantizeNotes:Gi,repairNotes:Vi,repeatPolyloops:Ji,roundToList:Sn,scaleList:Ui,setOffsetsAccordingToDurations:Mn,tracksToDict:Ci,tune:Hi},Symbol.toStringTag,{value:"Module"}));class Xi extends oe{constructor(e="C4",t="P5",r="chords",n=[3,3,1],i=null){if(super(),this.tonicMidi=qe(e),this.circleOf=t,this.type=r,this.radius=n,this.weights=i||n,!Object.keys(this.intervals).includes(this.circleOf))throw new Error(`Select a circleOf among ${Object.keys(this.intervals).join(", ")}.`);if(!["chords","pitches"].includes(this.type))throw new Error("Type must either be 'pitches' or 'chords'.")}computeCircle(){const e=this.intervals[this.circleOf],t=[this.tonicMidi];for(let r=0;r<Math.max(...this.radius);r++){const n=(t[t.length-1]+e)%12+Math.floor(t[t.length-1]/12)*12;t.push(n)}return{major:t.slice(0,this.radius[0]),minor:t.slice(0,this.radius[1]),diminished:t.slice(0,this.radius[2])}}generateChord(e,t){return({major:[0,4,7],minor:[0,3,7],diminished:[0,3,6]}[t]||[0,4,7]).map(s=>e+s).map(s=>s>127?s-12:s)}generate(e=4,t=null){t!==null&&(Math.seedrandom=t);const{major:r,minor:n,diminished:i}=this.computeCircle(),s=[r,n,i],a=["major","minor","diminished"],l=[];for(let u=0;u<e;u++){const d=this.weightedRandomChoice(this.weights);if(s[d].length>0){const m=s[d][Math.floor(Math.random()*s[d].length)],$=a[d],_=Array.isArray(m)?m[0]:m,E=this.generateChord(_,$);l.push(E)}}return l}weightedRandomChoice(e){const t=e.reduce((n,i)=>n+i,0);let r=Math.random()*t;for(let n=0;n<e.length;n++)if(r-=e[n],r<=0)return n;return e.length-1}}class Qi extends oe{constructor(e="major",t="C",r=[0,2,4]){super(),this.tonic=t,this.scale=new Pn(t,e).generate(),this.degrees=r}pitchToChord(e){const t=En(e),r=this.tonic+t.toString(),n=qe(r),i=this.scale.map(l=>Bt(l,this.scale,n)),s=Math.round(Bt(e,this.scale,n)),a=[];for(const l of this.degrees){const u=s+l,d=i.indexOf(u);d!==-1&&a.push(this.scale[d])}return a}generate(e,t=null,r=!1){if(!Array.isArray(e)||e.length===0)return[];let n=e;if(typeof e[0]=="number"){t===null&&(t=[1]);let s=0,a=0;n=e.map(l=>{const u=t[s%t.length],d=[l,u,a];return a+=u,s++,d})}const i=n.map(([s,a,l])=>[this.pitchToChord(s),a,l]);if(r){const s=[];for(const[a,l,u]of i){const d=l/a.length;a.forEach((m,$)=>{s.push([m,d,u+$*d])})}return s}else return i}}const xn={grace_note:{requiredParams:["graceNoteType"],optionalParams:["gracePitches"],conflicts:[],description:"Single note before the main note",defaultParams:{graceNoteType:"acciaccatura"},validate:(o,e)=>["acciaccatura","appoggiatura"].includes(e.graceNoteType)?e.gracePitches&&!Array.isArray(e.gracePitches)?{valid:!1,error:"gracePitches must be an array of pitches"}:{valid:!0}:{valid:!1,error:"graceNoteType must be either acciaccatura or appoggiatura"}},trill:{requiredParams:[],optionalParams:["by","trillRate"],conflicts:["mordent"],minDuration:"8n",description:"Rapid alternation between main note and auxiliary note",defaultParams:{by:1,trillRate:.125},validate:(o,e)=>e.by&&typeof e.by!="number"?{valid:!1,error:"trill step (by) must be a number"}:e.trillRate&&typeof e.trillRate!="number"?{valid:!1,error:"trillRate must be a number"}:{valid:!0}},mordent:{requiredParams:[],optionalParams:["by"],conflicts:["trill"],description:"Quick alternation with note above or below",defaultParams:{by:1},validate:(o,e)=>e.by&&typeof e.by!="number"?{valid:!1,error:"mordent step (by) must be a number"}:{valid:!0}},turn:{requiredParams:[],optionalParams:["scale"],conflicts:[],description:"Melodic turn around the main note",validate:(o,e)=>e.scale&&typeof e.scale!="string"?{valid:!1,error:"scale must be a string"}:{valid:!0}},arpeggio:{requiredParams:["arpeggioDegrees"],optionalParams:["direction"],conflicts:[],description:"Notes played in sequence",defaultParams:{direction:"up"},validate:(o,e)=>Array.isArray(e.arpeggioDegrees)?e.direction&&!["up","down","both"].includes(e.direction)?{valid:!1,error:"direction must be up, down, or both"}:{valid:!0}:{valid:!1,error:"arpeggioDegrees must be an array"}}};class Wt{static validateOrnament(e,t,r={}){const n={valid:!1,warnings:[],errors:[]},i=xn[t];if(!i)return n.errors.push(`Unknown ornament type: ${t}`),n;if(i.requiredParams){for(const s of i.requiredParams)if(!(s in r))return n.errors.push(`Missing required parameter '${s}' for ${t}`),n}if(i.minDuration&&n.warnings.push(`Duration check not implemented for ${t}`),e.ornaments&&i.conflicts){const s=e.ornaments.filter(a=>i.conflicts.includes(a.type)).map(a=>a.type);if(s.length>0)return n.errors.push(`${t} conflicts with existing ornaments: ${s.join(", ")}`),n}if(i.validate){const s=i.validate(e,r);if(!s.valid)return n.errors.push(s.error),n}return n.valid=!0,n}constructor(e){const t=xn[e.type];if(!t)throw new Error(`Unknown ornament type: ${e.type}`);this.type=e.type,this.params={...t.defaultParams,...e.parameters},e.tonic&&e.mode?(this.tonicIndex=oe.chromatic_scale.indexOf(e.tonic),this.scale=this.generateScale(e.tonic,e.mode)):this.scale=null}generateScale(e,t){const r=oe.scale_intervals[t],n=oe.chromatic_scale.indexOf(e),i=r.map(a=>(n+a)%12),s=[];for(let a=-1;a<10;a++)for(const l of i){const u=12*a+l;u>=0&&u<=127&&s.push(u)}return s}apply(e,t=null){if(!Array.isArray(e)||e.length===0||(t===null&&(t=Math.floor(Math.random()*e.length)),t<0||t>=e.length))return e;const r=e[t],n=Wt.validateOrnament(r,this.type,this.params);if(!n.valid)return console.warn(`Ornament validation failed: ${n.errors.join(", ")}`),e;switch(this.type){case"grace_note":return this.addGraceNote(e,t);case"trill":return this.addTrill(e,t);case"mordent":return this.addMordent(e,t);case"turn":return this.addTurn(e,t);case"arpeggio":return this.addArpeggio(e,t);default:return e}}addGraceNote(e,t){const[r,n,i]=e[t],s=this.params.gracePitches?this.params.gracePitches[Math.floor(Math.random()*this.params.gracePitches.length)]:r+1;if(this.params.graceNoteType==="acciaccatura"){const a=n*.125,l=[r,n,i+a];return[...e.slice(0,t),[s,a,i],l,...e.slice(t+1)]}else{const a=n/2,l=[r,a,i+a];return[...e.slice(0,t),[s,a,i],l,...e.slice(t+1)]}}addTrill(e,t){const[r,n,i]=e[t],s=[];let a=i;const l=this.params.by||1,u=this.params.trillRate||.125;let d;if(this.scale&&this.scale.includes(r)){const $=(this.scale.indexOf(r)+Math.round(l))%this.scale.length;d=this.scale[$]}else d=r+l;for(;a<i+n;){const m=i+n-a,$=Math.min(u,m/2);if(m>=$*2)s.push([r,$,a]),s.push([d,$,a+$]),a+=2*$;else break}return[...e.slice(0,t),...s,...e.slice(t+1)]}addMordent(e,t){const[r,n,i]=e[t],s=this.params.by||1;let a;if(this.scale&&this.scale.includes(r)){const m=this.scale.indexOf(r)+Math.round(s);a=this.scale[m]||r+s}else a=r+s;const l=n/3,u=[[r,l,i],[a,l,i+l],[r,l,i+2*l]];return[...e.slice(0,t),...u,...e.slice(t+1)]}addTurn(e,t){const[r,n,i]=e[t],s=n/4;let a,l;if(this.scale&&this.scale.includes(r)){const d=this.scale.indexOf(r);a=this.scale[d+1]||r+2,l=this.scale[d-1]||r-2}else a=r+2,l=r-2;const u=[[r,s,i],[a,s,i+s],[r,s,i+2*s],[l,s,i+3*s]];return[...e.slice(0,t),...u,...e.slice(t+1)]}addArpeggio(e,t){const[r,n,i]=e[t],{arpeggioDegrees:s,direction:a="up"}=this.params;if(!s||!Array.isArray(s))return e;const l=[];if(this.scale&&this.scale.includes(r)){const m=this.scale.indexOf(r);l.push(...s.map($=>this.scale[m+$]||r+$))}else l.push(...s.map(m=>r+m));a==="down"&&l.reverse(),a==="both"&&l.push(...l.slice(0,-1).reverse());const u=n/l.length,d=l.map((m,$)=>[m,u,i+$*u]);return[...e.slice(0,t),...d,...e.slice(t+1)]}}const Jt={staccato:{complex:!1,description:"Shortens note duration to ~50%"},accent:{complex:!1,description:"Increases note velocity/emphasis"},tenuto:{complex:!1,description:"Holds note for full duration with emphasis"},legato:{complex:!1,description:"Smooth connection between notes"},marcato:{complex:!1,description:"Strong accent with slight separation"},glissando:{complex:!0,requiredParams:["target"],description:"Smooth slide from note to target pitch"},portamento:{complex:!0,requiredParams:["target"],optionalParams:["curve","speed"],description:"Expressive slide between pitches"},bend:{complex:!0,requiredParams:["amount"],optionalParams:["curve","returnToOriginal"],description:"Pitch bend up or down in cents"},vibrato:{complex:!0,optionalParams:["rate","depth","delay"],description:"Periodic pitch variation"},tremolo:{complex:!0,optionalParams:["rate","depth"],description:"Rapid volume variation"},crescendo:{complex:!0,requiredParams:["endVelocity"],optionalParams:["curve"],description:"Gradual volume increase"},diminuendo:{complex:!0,requiredParams:["endVelocity"],optionalParams:["curve"],description:"Gradual volume decrease"}};class At{static addArticulation(e,t,r,n={}){const i={success:!1,warnings:[],errors:[]};if(!Array.isArray(e))return i.errors.push("Sequence must be an array"),i;if(r<0||r>=e.length)return i.errors.push(`Note index ${r} out of bounds (sequence length: ${e.length})`),i;const s=Jt[t];if(!s)return i.errors.push(`Unknown articulation type: ${t}`),i;const a=e[r];return!a||typeof a!="object"?(i.errors.push(`Invalid note at index ${r}`),i):s.complex?this._addComplexArticulation(a,t,s,n,i):(a.articulation=t,i.success=!0,i)}static _addComplexArticulation(e,t,r,n,i){if(r.requiredParams){for(const s of r.requiredParams)if(!(s in n))return i.errors.push(`Missing required parameter '${s}' for ${t}`),i}switch(t){case"glissando":case"portamento":return this._applyGlissando(e,t,n,i);case"bend":return this._applyBend(e,n,i);case"vibrato":return this._applyVibrato(e,n,i);case"tremolo":return this._applyTremolo(e,n,i);case"crescendo":case"diminuendo":return this._applyDynamicChange(e,t,n,i);default:return i.errors.push(`Complex articulation ${t} not implemented`),i}}static _applyGlissando(e,t,r,n){e.articulation=t,e.glissTarget=r.target,e.modulations||(e.modulations=[]);const i={type:"pitch",subtype:t,target:r.target,curve:r.curve||"linear",timing:"note_duration"};return r.speed!==void 0&&(i.speed=r.speed),e.modulations=e.modulations.filter(s=>!(s.type==="pitch"&&s.subtype===t)),e.modulations.push(i),n.success=!0,n.warnings.push(`Added ${t} modulation synchronized with articulation`),n}static _applyBend(e,t,r){e.articulation="bend",e.modulations||(e.modulations=[]);const n={type:"pitch",subtype:"bend",amount:t.amount,curve:t.curve||"linear",timing:t.returnToOriginal?"note_duration":"sustain",returnToOriginal:t.returnToOriginal??!0};return e.modulations=e.modulations.filter(i=>!(i.type==="pitch"&&i.subtype==="bend")),e.modulations.push(n),r.success=!0,r.warnings.push("Added pitch bend modulation synchronized with articulation"),r}static _applyVibrato(e,t,r){e.articulation="vibrato",e.modulations||(e.modulations=[]);const n={type:"pitch",subtype:"vibrato",rate:t.rate||5,depth:t.depth||50,delay:t.delay||0,timing:"note_duration"};return e.modulations=e.modulations.filter(i=>!(i.type==="pitch"&&i.subtype==="vibrato")),e.modulations.push(n),r.success=!0,r.warnings.push("Added vibrato modulation synchronized with articulation"),r}static _applyTremolo(e,t,r){e.articulation="tremolo",e.modulations||(e.modulations=[]);const n={type:"amplitude",subtype:"tremolo",rate:t.rate||8,depth:t.depth||.3,timing:"note_duration"};return e.modulations=e.modulations.filter(i=>!(i.type==="amplitude"&&i.subtype==="tremolo")),e.modulations.push(n),r.success=!0,r.warnings.push("Added tremolo modulation synchronized with articulation"),r}static _applyDynamicChange(e,t,r,n){e.articulation=t,e.modulations||(e.modulations=[]);const i={type:"amplitude",subtype:t,startVelocity:e.velocity||.8,endVelocity:r.endVelocity,curve:r.curve||"linear",timing:"note_duration"};return e.modulations=e.modulations.filter(s=>!(s.type==="amplitude"&&(s.subtype==="crescendo"||s.subtype==="diminuendo"))),e.modulations.push(i),n.success=!0,n.warnings.push(`Added ${t} modulation synchronized with articulation`),n}static removeArticulation(e,t){if(!Array.isArray(e)||t<0||t>=e.length)return{success:!1,error:"Invalid sequence or note index"};const r=e[t];if(!r||typeof r!="object")return{success:!1,error:"Invalid note"};const n=r.articulation;if(delete r.articulation,delete r.glissTarget,r.modulations&&n){const i=Jt[n];i&&i.complex&&(r.modulations=r.modulations.filter(s=>s.subtype!==n),r.modulations.length===0&&delete r.modulations)}return{success:!0,removed:n,message:`Removed ${n} articulation and related modulations`}}static validateSequence(e){const t=[];return e.forEach((r,n)=>{if(r.articulation){const i=this.ARTICULATION_TYPES[r.articulation];if(!i){t.push({type:"unknown_articulation",noteIndex:n,articulation:r.articulation,message:`Unknown articulation type: ${r.articulation}`});return}r.articulation==="glissando"&&!r.glissTarget&&t.push({type:"missing_parameter",noteIndex:n,articulation:r.articulation,message:"Glissando missing glissTarget parameter"}),i.complex&&r.modulations&&(r.modulations.some(a=>a.subtype===r.articulation)||t.push({type:"modulation_sync",noteIndex:n,articulation:r.articulation,message:`Complex articulation ${r.articulation} should have corresponding modulation`}))}}),{valid:t.length===0,issues:t}}static getAvailableTypes(){return Object.entries(Jt).map(([e,t])=>({type:e,complex:t.complex,description:t.description,requiredParams:t.requiredParams||[],optionalParams:t.optionalParams||[]}))}}function An(o,e,t,r){return At.addArticulation(o,e,t,r)}function Nn(o,e){return At.removeArticulation(o,e)}function Zi(o){return At.validateSequence(o)}const eo={Scale:Pn,Progression:Xi,Voice:Qi,Ornament:Wt,Articulation:At,addArticulation:An,addOrnament:An,removeArticulation:Nn,removeOrnament:Nn,validateArticulations:Zi};class to{constructor(e,t){this.measureLength=e,this.durations=t}random(e=null,t=0,r=100){e!==null&&(Math.seedrandom=e);const n=[];let i=0,s=0;for(;i<this.measureLength&&s<r;){const a=this.durations[Math.floor(Math.random()*this.durations.length)];if(i+a>this.measureLength){s++;continue}if(Math.random()<t){s++;continue}n.push([a,i]),i+=a,s++}return s>=r&&console.warn("Max iterations reached. The sum of the durations may not equal the measure length."),n}darwin(e=null,t=10,r=50,n=.1){return new ro(e,t,this.measureLength,r,n,this.durations).generate()}}class ro{constructor(e,t,r,n,i,s){e!==null&&(Math.seedrandom=e),this.populationSize=t,this.measureLength=r,this.maxGenerations=n,this.mutationRate=i,this.durations=s,this.population=this.initializePopulation()}initializePopulation(){const e=[];for(let t=0;t<this.populationSize;t++)e.push(this.createRandomRhythm());return e}createRandomRhythm(){const e=[];let t=0;for(;t<this.measureLength;){const r=this.measureLength-t,n=this.durations[Math.floor(Math.random()*this.durations.length)];if(n<=r)e.push([n,t]),t+=n;else break}return e}evaluateFitness(e){const t=e.reduce((r,n)=>r+n[0],0);return Math.abs(this.measureLength-t)}selectParent(){const e=this.population[Math.floor(Math.random()*this.population.length)],t=this.population[Math.floor(Math.random()*this.population.length)];return this.evaluateFitness(e)<this.evaluateFitness(t)?e:t}crossover(e,t){if(e.length===0||t.length===0)return e.length>0?[...e]:[...t];const r=Math.floor(Math.random()*(e.length-1))+1,n=[...e.slice(0,r),...t.slice(r)];return this.ensureMeasureLength(n)}ensureMeasureLength(e){return e.reduce((r,n)=>r+n[0],0)>this.measureLength&&e.length>0&&e.pop(),e}mutate(e){if(Math.random()<this.mutationRate&&e.length>1){const t=Math.floor(Math.random()*(e.length-1)),[r,n]=e[t],s=(t===e.length-1?this.measureLength:e[t+1][1])-n,a=this.durations.filter(l=>l<=s);if(a.length>0){const l=a[Math.floor(Math.random()*a.length)];e[t]=[l,n]}}return e}generate(){for(let t=0;t<this.maxGenerations;t++){const r=[];for(let n=0;n<this.populationSize;n++){const i=this.selectParent(),s=this.selectParent();let a=this.crossover(i,s);a=this.mutate(a),a.sort((l,u)=>l[1]-u[1]),r.push(a)}this.population=r}return this.population.reduce((t,r)=>this.evaluateFitness(r)<this.evaluateFitness(t)?r:t).sort((t,r)=>t[1]-r[1])}}function no(o,e){const t=o.map(a=>Array.isArray(a)||typeof a=="object"&&a.length?a[0]:a),r=io(t.length,e.length),n=[],i=[];for(let a=0;a<r;a++)n.push(t[a%t.length]),i.push(e[a%e.length]);const s=n.map((a,l)=>[a,i[l],1]);return Mn(s)}function io(o,e){const t=(r,n)=>n===0?r:t(n,r%n);return Math.abs(o*e)/t(o,e)}function oo(o,e){const t=[];let r=0,n=0;for(const i of o){const s=e[n%e.length];t.push([i,s,r]),r+=s,n++}return t}const so={Rhythm:to,isorhythm:no,beatcycle:oo};class ao{constructor(){}}class $e{data;constructor(e,t){if(typeof e=="number"){if(t===void 0)throw new Error("Columns parameter required when creating matrix from dimensions");this.rows=e,this.columns=t,this.data=Array(this.rows).fill(0).map(()=>Array(this.columns).fill(0))}else this.data=e.map(r=>[...r]),this.rows=this.data.length,this.columns=this.data[0]?.length||0}static zeros(e,t){return new $e(e,t)}static from2DArray(e){return new $e(e)}get(e,t){if(e<0||e>=this.rows||t<0||t>=this.columns)throw new Error(`Index out of bounds: (${e}, ${t})`);return this.data[e][t]}set(e,t,r){if(e<0||e>=this.rows||t<0||t>=this.columns)throw new Error(`Index out of bounds: (${e}, ${t})`);this.data[e][t]=r}getRow(e){if(e<0||e>=this.rows)throw new Error(`Row index out of bounds: ${e}`);return[...this.data[e]]}getColumn(e){if(e<0||e>=this.columns)throw new Error(`Column index out of bounds: ${e}`);return this.data.map(t=>t[e])}transpose(){const e=Array(this.columns).fill(0).map(()=>Array(this.rows).fill(0));for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)e[r][t]=this.data[t][r];return new $e(e)}clone(){return new $e(this.data)}toArray(){return this.data.map(e=>[...e])}}function Yt(o){return Array.isArray(o[0])?$e.from2DArray(o):$e.from2DArray([o])}function co(o){if(o.rows!==o.columns)throw new Error("Matrix must be square for Cholesky decomposition");const e=o.rows,t=$e.zeros(e,e);for(let r=0;r<e;r++)for(let n=0;n<=r;n++)if(r===n){let i=0;for(let a=0;a<n;a++)i+=t.get(n,a)*t.get(n,a);const s=o.get(n,n)-i;if(s<=0)throw new Error(`Matrix is not positive definite at position (${n}, ${n})`);t.set(n,n,Math.sqrt(s))}else{let i=0;for(let s=0;s<n;s++)i+=t.get(r,s)*t.get(n,s);t.set(r,n,(o.get(r,n)-i)/t.get(n,n))}return t}class lo{kernel;alpha;XTrain;yTrain;L;alphaVector;constructor(e,t={}){this.kernel=e,this.alpha=t.alpha||1e-10}fit(e,t){this.XTrain=Yt(e),this.yTrain=[...t];const r=this.kernel.call(this.XTrain);for(let n=0;n<r.rows;n++)r.set(n,n,r.get(n,n)+this.alpha);try{this.L=co(r)}catch(n){throw new Error(`Failed to compute Cholesky decomposition: ${n instanceof Error?n.message:"Unknown error"}`)}this.alphaVector=this.solveCholesky(this.L,this.yTrain)}predict(e,t=!1){if(!this.XTrain||!this.yTrain||!this.L||!this.alphaVector)throw new Error("Model must be fitted before prediction");const r=Yt(e),n=this.kernel.call(this.XTrain,r),i=new Array(r.rows);for(let a=0;a<r.rows;a++){i[a]=0;for(let l=0;l<this.XTrain.rows;l++)i[a]+=n.get(l,a)*this.alphaVector[l]}const s={mean:i};if(t){const a=this.computeStd(r,n);s.std=a}return s}sampleY(e,t=1){if(!this.XTrain||!this.yTrain||!this.L||!this.alphaVector)throw new Error("Model must be fitted before sampling");const r=Yt(e),n=this.predict(e,!0);if(!n.std)throw new Error("Standard deviation computation failed");const i=[];for(let s=0;s<t;s++){const a=new Array(r.rows);for(let l=0;l<r.rows;l++){const u=n.mean[l],d=n.std[l];a[l]=u+d*this.sampleStandardNormal()}i.push(a)}return i}logMarginalLikelihood(){if(!this.XTrain||!this.yTrain||!this.L||!this.alphaVector)throw new Error("Model must be fitted before computing log marginal likelihood");let e=0;for(let t=0;t<this.yTrain.length;t++)e-=.5*this.yTrain[t]*this.alphaVector[t];for(let t=0;t<this.L.rows;t++)e-=Math.log(this.L.get(t,t));return e-=.5*this.yTrain.length*Math.log(2*Math.PI),e}computeStd(e,t){if(!this.L)throw new Error("Cholesky decomposition not available");const r=new Array(e.rows);for(let n=0;n<e.rows;n++){const i=this.kernel.compute(e.getRow(n),e.getRow(n)),s=t.getColumn(n),a=this.forwardSubstitution(this.L,s);let l=0;for(let d=0;d<a.length;d++)l+=a[d]*a[d];const u=i-l;r[n]=Math.sqrt(Math.max(0,u))}return r}solveCholesky(e,t){const r=this.forwardSubstitution(e,t);return this.backSubstitution(e,r)}forwardSubstitution(e,t){const r=e.rows,n=new Array(r);for(let i=0;i<r;i++){n[i]=t[i];for(let s=0;s<i;s++)n[i]-=e.get(i,s)*n[s];n[i]/=e.get(i,i)}return n}backSubstitution(e,t){const r=e.rows,n=new Array(r);for(let i=r-1;i>=0;i--){n[i]=t[i];for(let s=i+1;s<r;s++)n[i]-=e.get(s,i)*n[s];n[i]/=e.get(i,i)}return n}sampleStandardNormal(){const e=Math.random(),t=Math.random();return Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*t)}}class uo{constructor(e={}){this.width=e.width||51,this.ruleNumber=e.ruleNumber||30,this.initialState=e.initialState||this.generateRandomInitialState(),this.state=[...this.initialState],this.rules=this.loadRules(this.ruleNumber),this.history=[]}generate(e){this.history=[],this.state=[...this.initialState],this.history.push([...this.state]);for(let t=0;t<e;t++)this.updateState(),this.history.push([...this.state]);return this.history}generate01(e){return this.generate(e).map(r=>r.map(n=>n>0?1:0))}loadRules(e){const t=e.toString(2).padStart(8,"0"),r={},n=["111","110","101","100","011","010","001","000"];for(let i=0;i<8;i++)r[n[i]]=parseInt(t[i],10);return r}updateState(){const e=new Array(this.width);for(let t=0;t<this.width;t++){const r=this.state[(t-1+this.width)%this.width],n=this.state[t],i=this.state[(t+1)%this.width],s=`${r}${n}${i}`;e[t]=this.rules[s]||0}this.state=e}validateStrips(e){if(!Array.isArray(e)||e.length===0)return!1;const t=e[0]?.length;return t?e.every(r=>Array.isArray(r)&&r.length===t&&r.every(n=>typeof n=="number"&&(n===0||n===1))):!1}validateValues(e){return Array.isArray(e)&&e.length===this.width&&e.every(t=>typeof t=="number"&&(t===0||t===1))}setInitialState(e){if(this.validateValues(e))this.initialState=[...e],this.state=[...e];else throw new Error("Invalid initial state")}setRuleNumber(e){if(e>=0&&e<=255)this.ruleNumber=e,this.rules=this.loadRules(e);else throw new Error("Rule number must be between 0 and 255")}getHistory(){return this.history.map(e=>[...e])}getCurrentState(){return[...this.state]}generateRandomInitialState(){const e=new Array(this.width).fill(0);return e[Math.floor(this.width/2)]=1,e}generateRandomState(){return Array.from({length:this.width},()=>Math.random()>.5?1:0)}plot(){return{data:this.getHistory(),width:this.width,height:this.history.length}}async plotEvolution(e){return(await Promise.resolve().then(()=>Qt)).CAVisualizer.plotEvolution(this.getHistory(),e)}async plotGeneration(e){return(await Promise.resolve().then(()=>Qt)).CAVisualizer.plotGeneration(this.getCurrentState(),e)}async plotDensity(e){return(await Promise.resolve().then(()=>Qt)).CAVisualizer.plotDensity(this.getHistory(),e)}}class ho{config;currentTime=0;rotationAngles=new Map;constructor(e){this.config=e,this.config.layers.forEach(t=>{this.rotationAngles.set(t.label,0)})}static fromRhythm(e,t=[60],r={}){const{instrument:n="synth",color:i="steelblue",label:s="Polyloop",speed:a=1,radius:l=.8}=r,u=e.reduce(($,_)=>$+_,0),d=[];let m=0;return e.forEach(($,_)=>{const E=$/u*360;d.push({angle:m,radius:l,active:$>0,pitch:$>0?t[_%t.length]:void 0,velocity:.8,instrument:n}),m+=E}),{points:d,color:i,label:s,instrument:n,divisions:e.length,speed:a}}static euclidean(e,t,r=[60],n={}){const{instrument:i="synth",color:s="steelblue",label:a=`Euclidean ${t}/${e}`,speed:l=1,radius:u=.8}=n,d=this.generateEuclideanRhythm(e,t),m=[];return d.forEach(($,_)=>{const E=_/e*360;m.push({angle:E,radius:u,active:$,pitch:$?r[_%r.length]:void 0,velocity:.8,instrument:i})}),{points:m,color:s,label:a,instrument:i,divisions:e,speed:l}}static generateEuclideanRhythm(e,t){if(t>=e)return Array(e).fill(!0);const r=Array(e).fill(!1),n=e/t;for(let i=0;i<t;i++){const s=Math.round(i*n)%e;r[s]=!0}return r}static fromFunction(e,t=16,r=[60,72],n={}){const{instrument:i="synth",color:s="purple",label:a="Function Polyloop",speed:l=1,activeThreshold:u=.5}=n,d=[],[m,$]=r;for(let _=0;_<t;_++){const E=_/t*360,w=E*Math.PI/180,p=e(w),h=Math.abs(p)%1;d.push({angle:E,radius:.3+h*.5,active:h>u,pitch:Math.round(m+h*($-m)),velocity:.5+h*.5,instrument:i})}return{points:d,color:s,label:a,instrument:i,divisions:t,speed:l}}step(e){this.currentTime+=e;const t=[];return this.config.layers.forEach(r=>{const i=((this.rotationAngles.get(r.label)||0)+e*r.speed*360)%360;this.rotationAngles.set(r.label,i),r.points.forEach(s=>{if(!s.active)return;Math.abs(i-s.angle)<r.speed*360*e+1&&t.push({time:this.currentTime,layer:r.label,point:s,angle:i})})}),t}generateSequence(e,t=16){const r=1/t,n=Math.floor(e/r),i=[];this.currentTime=0,this.resetRotations();for(let s=0;s<n;s++){const a=this.step(r);i.push(...a)}return i}resetRotations(){this.config.layers.forEach(e=>{this.rotationAngles.set(e.label,0)}),this.currentTime=0}toJMonSequences(e=4){const t=this.generateSequence(e),r=new Map;t.forEach(i=>{r.has(i.layer)||r.set(i.layer,[]),r.get(i.layer).push(i)});const n=[];return r.forEach((i,s)=>{const a=i.map(l=>({pitch:typeof l.point.pitch=="number"?l.point.pitch:60,time:l.time,duration:"8n",velocity:l.point.velocity||.8}));n.push({label:s,notes:a,synth:{type:"Synth",options:{oscillator:{type:"sine"},envelope:{attack:.01,decay:.1,sustain:.3,release:.5}}}})}),n}getVisualizationState(){return{layers:this.config.layers,rotationAngles:new Map(this.rotationAngles),currentTime:this.currentTime}}addLayer(e){this.config.layers.push(e),this.rotationAngles.set(e.label,0)}removeLayer(e){const t=this.config.layers.findIndex(r=>r.label===e);return t!==-1?(this.config.layers.splice(t,1),this.rotationAngles.delete(e),!0):!1}async plot(e){const{PolyloopVisualizer:t}=await Promise.resolve().then(()=>Zt);return t.plotPolyloop(this.config.layers,e)}async plotTimeline(e=8,t){const{PolyloopVisualizer:r}=await Promise.resolve().then(()=>Zt);return r.plotTimeline(this.config.layers,e,t)}async plotAnimated(e=12,t){const{PolyloopVisualizer:r}=await Promise.resolve().then(()=>Zt);return r.plotAnimated(this.config.layers,e,t)}}class jn{static gini(e,t){if(e.length===0)return 0;const r=e.length,n=t||Array(r).fill(1),i=e.map((m,$)=>({value:m,weight:n[$]})).sort((m,$)=>m.value-$.value),s=i.map(m=>m.value),a=i.map(m=>m.weight),l=a.reduce((m,$)=>m+$,0);let u=0,d=0;for(let m=0;m<r;m++){const $=a.slice(0,m+1).reduce((_,E)=>_+E,0);u+=a[m]*(2*$-a[m]-l)*s[m],d+=a[m]*s[m]*l}return d===0?0:u/d}static balance(e,t){if(e.length===0)return 0;const r=t||Array(e.length).fill(1),n=e.reduce((s,a,l)=>s+a*r[l],0),i=r.reduce((s,a)=>s+a,0);return i===0?0:n/i}static autocorrelation(e,t){const r=e.length,n=t||Math.floor(r/2),i=[],s=e.reduce((l,u)=>l+u,0)/r,a=e.reduce((l,u)=>l+Math.pow(u-s,2),0)/r;for(let l=0;l<=n;l++){let u=0;for(let d=0;d<r-l;d++)u+=(e[d]-s)*(e[d+l]-s);u/=r-l,i.push(a===0?0:u/a)}return i}static motif(e,t=3){if(e.length<t*2)return 0;const r=new Map;for(let s=0;s<=e.length-t;s++){const a=e.slice(s,s+t).join(",");r.set(a,(r.get(a)||0)+1)}const n=Math.max(...r.values()),i=r.size;return i===0?0:n/i}static dissonance(e,t=[0,2,4,5,7,9,11]){if(e.length===0)return 0;let r=0;for(const n of e){const i=(n%12+12)%12;t.includes(i)&&r++}return 1-r/e.length}static rhythmic(e,t=16){if(e.length===0)return 0;let r=0;const n=.1;for(const i of e){const s=i*t,a=Math.round(s);Math.abs(s-a)<=n&&r++}return r/e.length}static fibonacciIndex(e){if(e.length<2)return 0;const t=(1+Math.sqrt(5))/2;let r=0;for(let n=1;n<e.length;n++)if(e[n-1]!==0){const i=e[n]/e[n-1],s=Math.abs(i-t);r+=1/(1+s)}return r/(e.length-1)}static syncopation(e,t=4){if(e.length===0)return 0;let r=0;for(const n of e){const i=n*t%1;i>.2&&i<.8&&Math.abs(i-.5)>.2&&r++}return r/e.length}static contourEntropy(e){if(e.length<2)return 0;const t=[];for(let s=1;s<e.length;s++){const a=e[s]-e[s-1];a>0?t.push(1):a<0?t.push(-1):t.push(0)}const r={up:0,down:0,same:0};for(const s of t)s>0?r.up++:s<0?r.down++:r.same++;const n=t.length;return-[r.up/n,r.down/n,r.same/n].filter(s=>s>0).reduce((s,a)=>s+a*Math.log2(a),0)}static intervalVariance(e){if(e.length<2)return 0;const t=[];for(let i=1;i<e.length;i++)t.push(Math.abs(e[i]-e[i-1]));const r=t.reduce((i,s)=>i+s,0)/t.length;return t.reduce((i,s)=>i+Math.pow(s-r,2),0)/t.length}static density(e,t=1){if(e.length===0)return 0;const r=e.map(a=>typeof a.time=="string"?parseFloat(a.time)||0:a.time||0),n=Math.min(...r),s=Math.max(...r)-n||1;return e.length/(s/t)}static gapVariance(e){if(e.length<2)return 0;const t=[];for(let i=1;i<e.length;i++)t.push(e[i]-e[i-1]);const r=t.reduce((i,s)=>i+s,0)/t.length;return t.reduce((i,s)=>i+Math.pow(s-r,2),0)/t.length}static analyze(e,t={}){const{scale:r=[0,2,4,5,7,9,11]}=t,n=e.map(s=>typeof s.note=="number"?s.note:typeof s.note=="string"?60:Array.isArray(s.note)?s.note[0]:60),i=e.map(s=>typeof s.time=="number"?s.time:parseFloat(s.time)||0);return{gini:this.gini(n),balance:this.balance(n),motif:this.motif(n),dissonance:this.dissonance(n,r),rhythmic:this.rhythmic(i),fibonacciIndex:this.fibonacciIndex(n),syncopation:this.syncopation(i),contourEntropy:this.contourEntropy(n),intervalVariance:this.intervalVariance(n),density:this.density(e),gapVariance:this.gapVariance(i)}}}class fo{constructor(e={}){this.options={populationSize:e.populationSize||50,generations:e.generations||100,mutationRate:e.mutationRate||.1,crossoverRate:e.crossoverRate||.8,elitismRate:e.elitismRate||.1,fitnessWeights:{gini:.2,balance:.15,motif:.25,dissonance:.2,rhythmic:.2,...e.fitnessWeights},scale:e.scale||[0,2,4,5,7,9,11],durations:e.durations||["4n","8n","2n","16n"],lengthRange:e.lengthRange||[8,16]},this.population=[],this.generation=0,this.bestFitness=-1/0,this.bestIndividual=null}initializePopulation(){this.population=[];for(let e=0;e<this.options.populationSize;e++){const t=this.createRandomIndividual();this.population.push(t)}this.evaluatePopulation()}evolve(){this.initializePopulation();for(let e=0;e<this.options.generations;e++){this.generation=e;const t=this.createNextGeneration();this.population=t,this.evaluatePopulation();const r=this.getBestIndividual();r.fitness>this.bestFitness&&(this.bestFitness=r.fitness,this.bestIndividual={...r})}return this.getBestIndividual()}createRandomIndividual(){const e=Math.floor(Math.random()*(this.options.lengthRange[1]-this.options.lengthRange[0]+1))+this.options.lengthRange[0],t=[];let r=0;for(let n=0;n<e;n++){const i=this.randomPitch(),s=this.randomDuration();t.push({note:i,time:`${Math.floor(r)}:${Math.floor(r%1*4)}:0`,duration:s,velocity:Math.random()*.5+.5}),r+=this.parseDuration(s)}return{genes:t,fitness:0,age:0}}randomPitch(){const e=Math.floor(Math.random()*3)+4,t=this.options.scale[Math.floor(Math.random()*this.options.scale.length)];return 12*e+t}randomDuration(){return this.options.durations[Math.floor(Math.random()*this.options.durations.length)]}parseDuration(e){return{"1n":4,"2n":2,"4n":1,"8n":.5,"16n":.25,"32n":.125}[e]||1}evaluatePopulation(){for(const e of this.population)e.fitness=this.calculateFitness(e.genes);this.population.sort((e,t)=>t.fitness-e.fitness)}calculateFitness(e){const t=jn.analyze(e,{scale:this.options.scale});let r=0;const n=this.options.fitnessWeights;r+=(n.gini||0)*(1-t.gini),r+=(n.balance||0)*(1-Math.abs(t.balance-60)/60),r+=(n.motif||0)*t.motif,r+=(n.dissonance||0)*(1-t.dissonance),r+=(n.rhythmic||0)*t.rhythmic;const i=e.length;return(i<this.options.lengthRange[0]||i>this.options.lengthRange[1])&&(r*=.5),Math.max(0,r)}createNextGeneration(){const e=[],t=Math.floor(this.options.populationSize*this.options.elitismRate);for(let r=0;r<t;r++){const n={...this.population[r]};n.age++,e.push(n)}for(;e.length<this.options.populationSize;){const r=this.selectParent(),n=this.selectParent();let i,s;Math.random()<this.options.crossoverRate?[i,s]=this.crossover(r,n):(i={...r},s={...n}),Math.random()<this.options.mutationRate&&this.mutate(i),Math.random()<this.options.mutationRate&&this.mutate(s),i.age=0,s.age=0,e.push(i),e.length<this.options.populationSize&&e.push(s)}return e}selectParent(){const t=[];for(let r=0;r<3;r++){const n=Math.floor(Math.random()*this.population.length);t.push(this.population[n])}return t.sort((r,n)=>n.fitness-r.fitness),{...t[0]}}crossover(e,t){const r=Math.min(e.genes.length,t.genes.length),n=Math.floor(Math.random()*r),i={genes:[...e.genes.slice(0,n),...t.genes.slice(n)],fitness:0,age:0},s={genes:[...t.genes.slice(0,n),...e.genes.slice(n)],fitness:0,age:0};return[i,s]}mutate(e){const t=e.genes,r=Math.random();if(r<.3){const n=Math.floor(Math.random()*t.length);t[n].pitch=this.randomPitch()}else if(r<.6){const n=Math.floor(Math.random()*t.length);t[n].duration=this.randomDuration()}else if(r<.8){const n=Math.floor(Math.random()*t.length);t[n].velocity=Math.random()*.5+.5}else if(Math.random()<.5&&t.length<this.options.lengthRange[1]){const n=Math.floor(Math.random()*(t.length+1)),i={pitch:this.randomPitch(),time:"0:0:0",duration:this.randomDuration(),velocity:Math.random()*.5+.5};t.splice(n,0,i)}else if(t.length>this.options.lengthRange[0]){const n=Math.floor(Math.random()*t.length);t.splice(n,1)}this.recalculateTiming(e)}recalculateTiming(e){let t=0;for(const r of e.genes)r.time=`${Math.floor(t)}:${Math.floor(t%1*4)}:0`,t+=this.parseDuration(r.duration)}getBestIndividual(){return{...this.population[0]}}getStatistics(){const e=this.population.map(i=>i.fitness),t=e.reduce((i,s)=>i+s,0)/e.length,r=Math.max(...e),n=Math.min(...e);return{generation:this.generation,avgFitness:t,maxFitness:r,minFitness:n,bestAllTime:this.bestFitness,populationSize:this.population.length}}setCustomFitness(e){this.calculateFitness=e}}class po{options;walkers;history;constructor(e={}){this.options={length:e.length||100,dimensions:e.dimensions||1,stepSize:e.stepSize||1,bounds:e.bounds||[-100,100],branchProbability:e.branchProbability||.05,mergeProbability:e.mergeProbability||.02,attractorStrength:e.attractorStrength||0,attractorPosition:e.attractorPosition||Array(e.dimensions||1).fill(0)},this.walkers=[],this.history=[]}generate(e){this.initialize(e),this.history=[];for(let t=0;t<this.options.length;t++)this.updateWalkers(),this.recordState(),this.handleBranching(),this.handleMerging();return this.history}initialize(e){const t=e||Array(this.options.dimensions).fill(0);this.walkers=[{position:[...t],velocity:Array(this.options.dimensions).fill(0),branches:[],age:0,active:!0}]}updateWalkers(){for(const e of this.walkers)if(e.active){for(let t=0;t<this.options.dimensions;t++){const r=(Math.random()-.5)*2*this.options.stepSize;let n=0;if(this.options.attractorStrength>0){const i=e.position[t]-this.options.attractorPosition[t];n=-this.options.attractorStrength*i}e.velocity[t]=e.velocity[t]*.9+r+n,e.position[t]+=e.velocity[t],e.position[t]<this.options.bounds[0]?(e.position[t]=this.options.bounds[0],e.velocity[t]*=-.5):e.position[t]>this.options.bounds[1]&&(e.position[t]=this.options.bounds[1],e.velocity[t]*=-.5)}e.age++}}recordState(){const e=this.walkers.filter(t=>t.active);if(e.length>0){const t=Array(this.options.dimensions).fill(0);for(const r of e)for(let n=0;n<this.options.dimensions;n++)t[n]+=r.position[n];for(let r=0;r<this.options.dimensions;r++)t[r]/=e.length;this.history.push([...t])}}handleBranching(){const e=[];for(const t of this.walkers)if(t.active&&Math.random()<this.options.branchProbability){const r={position:[...t.position],velocity:t.velocity.map(n=>n+(Math.random()-.5)*this.options.stepSize),branches:[],age:0,active:!0};e.push(r),t.branches.push(r)}this.walkers.push(...e)}handleMerging(){if(this.walkers.length<=1)return;const e=this.walkers.filter(r=>r.active),t=this.options.stepSize*2;for(let r=0;r<e.length;r++)for(let n=r+1;n<e.length;n++)if(Math.random()<this.options.mergeProbability&&this.calculateDistance(e[r].position,e[n].position)<t){for(let s=0;s<this.options.dimensions;s++)e[r].position[s]=(e[r].position[s]+e[n].position[s])/2,e[r].velocity[s]=(e[r].velocity[s]+e[n].velocity[s])/2;e[n].active=!1}this.walkers=this.walkers.filter(r=>r.active)}calculateDistance(e,t){let r=0;for(let n=0;n<e.length;n++)r+=Math.pow(e[n]-t[n],2);return Math.sqrt(r)}getProjection(e=0){return this.history.map(t=>t[e]||0)}mapToScale(e=0,t=[0,2,4,5,7,9,11],r=3){const n=this.getProjection(e);if(n.length===0)return[];const i=Math.min(...n),a=Math.max(...n)-i||1;return n.map(l=>{const u=(l-i)/a,d=Math.floor(u*t.length*r),m=Math.floor(d/t.length),$=d%t.length;return 60+m*12+t[$]})}mapToRhythm(e=0,t=[.25,.5,1,2]){const r=this.getProjection(e);if(r.length===0)return[];const n=Math.min(...r),s=Math.max(...r)-n||1;return r.map(a=>{const l=(a-n)/s,u=Math.floor(l*t.length),d=Math.max(0,Math.min(u,t.length-1));return t[d]})}mapToVelocity(e=0,t=.3,r=1){const n=this.getProjection(e);if(n.length===0)return[];const i=Math.min(...n),a=Math.max(...n)-i||1;return n.map(l=>{const u=(l-i)/a;return t+u*(r-t)})}generateCorrelated(e,t=.5,r=0){if(e.length===0)return[];const n=[];let i=0;for(let s=0;s<e.length;s++){const a=(Math.random()-.5)*2*this.options.stepSize,l=t*(e[s]-i);i+=a+l,i=Math.max(this.options.bounds[0],Math.min(this.options.bounds[1],i)),n.push(i)}return n}analyze(){if(this.history.length<2)return{meanDisplacement:0,meanSquaredDisplacement:0,totalDistance:0,fractalDimension:0};const e=this.getProjection(0),t=e[0],r=e[e.length-1],n=Math.abs(r-t),i=e.map(u=>Math.pow(u-t,2)),s=i.reduce((u,d)=>u+d,0)/i.length;let a=0;for(let u=1;u<e.length;u++)a+=Math.abs(e[u]-e[u-1]);const l=a>0?Math.log(a)/Math.log(e.length):0;return{meanDisplacement:n,meanSquaredDisplacement:s,totalDistance:a,fractalDimension:l}}getWalkerStates(){return this.walkers.map(e=>({...e}))}reset(){this.walkers=[],this.history=[]}}class mo{constructor(e={}){this.width=e.width||100,this.height=e.height||100,this.maxIterations=e.maxIterations||100,this.xMin=e.xMin||-2.5,this.xMax=e.xMax||1.5,this.yMin=e.yMin||-2,this.yMax=e.yMax||2}generate(){const e=[];for(let t=0;t<this.height;t++){const r=[];for(let n=0;n<this.width;n++){const i=this.xMin+n/this.width*(this.xMax-this.xMin),s=this.yMin+t/this.height*(this.yMax-this.yMin),a=this.mandelbrotIterations({real:i,imaginary:s});r.push(a)}e.push(r)}return e}extractSequence(e="diagonal",t=0){const r=this.generate();switch(e){case"diagonal":return this.extractDiagonal(r);case"border":return this.extractBorder(r);case"spiral":return this.extractSpiral(r);case"column":return this.extractColumn(r,t);case"row":return this.extractRow(r,t);default:return this.extractDiagonal(r)}}mandelbrotIterations(e){let t={real:0,imaginary:0};for(let r=0;r<this.maxIterations;r++){const n=t.real*t.real-t.imaginary*t.imaginary+e.real,i=2*t.real*t.imaginary+e.imaginary;if(t.real=n,t.imaginary=i,t.real*t.real+t.imaginary*t.imaginary>4)return r}return this.maxIterations}extractDiagonal(e){const t=[],r=Math.min(e.length,e[0]?.length||0);for(let n=0;n<r;n++)t.push(e[n][n]);return t}extractBorder(e){const t=[],r=e.length,n=e[0]?.length||0;if(r===0||n===0)return t;for(let i=0;i<n;i++)t.push(e[0][i]);for(let i=1;i<r;i++)t.push(e[i][n-1]);if(r>1)for(let i=n-2;i>=0;i--)t.push(e[r-1][i]);if(n>1)for(let i=r-2;i>0;i--)t.push(e[i][0]);return t}extractSpiral(e){const t=[],r=e.length,n=e[0]?.length||0;if(r===0||n===0)return t;let i=0,s=r-1,a=0,l=n-1;for(;i<=s&&a<=l;){for(let u=a;u<=l;u++)t.push(e[i][u]);i++;for(let u=i;u<=s;u++)t.push(e[u][l]);if(l--,i<=s){for(let u=l;u>=a;u--)t.push(e[s][u]);s--}if(a<=l){for(let u=s;u>=i;u--)t.push(e[u][a]);a++}}return t}extractColumn(e,t){const r=[],n=e[0]?.length||0,i=Math.max(0,Math.min(t,n-1));for(const s of e)s[i]!==void 0&&r.push(s[i]);return r}extractRow(e,t){const r=Math.max(0,Math.min(t,e.length-1));return e[r]?[...e[r]]:[]}mapToScale(e,t=[0,2,4,5,7,9,11],r=3){if(e.length===0)return[];const n=Math.min(...e),s=Math.max(...e)-n||1;return e.map(a=>{const l=(a-n)/s,u=Math.floor(l*t.length*r),d=Math.floor(u/t.length),m=u%t.length;return 60+d*12+t[m]})}mapToRhythm(e,t=[1,2,4,8,16]){if(e.length===0)return[];const r=Math.min(...e),i=Math.max(...e)-r||1;return e.map(s=>{const a=(s-r)/i,l=Math.floor(a*t.length),u=Math.max(0,Math.min(l,t.length-1));return 1/t[u]})}}class yo{constructor(e={}){this.r=e.r||3.8,this.x0=e.x0||.5,this.iterations=e.iterations||1e3,this.skipTransient=e.skipTransient||100}generate(){const e=[];let t=this.x0;for(let r=0;r<this.iterations+this.skipTransient;r++)t=this.r*t*(1-t),r>=this.skipTransient&&e.push(t);return e}bifurcationDiagram(e=2.5,t=4,r=1e3){const n=[],i=[],s=(t-e)/r;for(let a=0;a<r;a++){const l=e+a*s,u=this.r;this.r=l;const d=this.generate();this.r=u;const m=d.slice(-50);for(const $ of m)n.push(l),i.push($)}return{r:n,x:i}}mapToScale(e,t=[0,2,4,5,7,9,11],r=3){return e.length===0?[]:e.map(n=>{const i=Math.floor(n*t.length*r),s=Math.floor(i/t.length),a=i%t.length;return 60+s*12+t[a]})}mapToRhythm(e,t=[.25,.5,1,2]){return e.length===0?[]:e.map(r=>{const n=Math.floor(r*t.length),i=Math.max(0,Math.min(n,t.length-1));return t[i]})}mapToVelocity(e,t=.3,r=1){if(e.length===0)return[];const n=r-t;return e.map(i=>t+i*n)}detectCycles(e,t=.01){const r=[];for(let n=1;n<=Math.floor(e.length/2);n++){let i=!0;for(let s=n;s<Math.min(e.length,n*3);s++)if(Math.abs(e[s]-e[s-n])>t){i=!1;break}i&&r.push(n)}return r}lyapunovExponent(e=1e4){let t=this.x0,r=0;for(let n=0;n<e;n++){const i=this.r*(1-2*t);r+=Math.log(Math.abs(i)),t=this.r*t*(1-t)}return r/e}generateCoupled(e=2,t=.1){const r=Array(e).fill(null).map(()=>[]),n=Array(e).fill(this.x0);for(let i=0;i<this.iterations+this.skipTransient;i++){const s=[...n];for(let a=0;a<e;a++){let l=0;for(let u=0;u<e;u++)u!==a&&(l+=t*(n[u]-n[a]));s[a]=this.r*n[a]*(1-n[a])+l,s[a]=Math.max(0,Math.min(1,s[a]))}if(n.splice(0,e,...s),i>=this.skipTransient)for(let a=0;a<e;a++)r[a].push(n[a])}return r}setRegime(e,t){switch(e){case"periodic":this.r=3.2;break;case"chaotic":this.r=3.9;break;case"edge":this.r=3.57;break;case"custom":t!==void 0&&(this.r=Math.max(0,Math.min(4,t)));break}}getParameters(){return{r:this.r,x0:this.x0,iterations:this.iterations,skipTransient:this.skipTransient}}}class go{operation;direction;repetition;sequence=[];constructor(e){const{operation:t,direction:r,repetition:n}=e;if(!["additive","subtractive"].includes(t))throw new Error("Invalid operation. Choose 'additive' or 'subtractive'.");if(!["forward","backward","inward","outward"].includes(r))throw new Error("Invalid direction. Choose 'forward', 'backward', 'inward' or 'outward'.");if(n<0||!Number.isInteger(n))throw new Error("Invalid repetition value. Must be an integer greater than or equal to 0.");this.operation=t,this.direction=r,this.repetition=n}generate(e){this.sequence=e;let t;if(this.operation==="additive"&&this.direction==="forward")t=this.additiveForward();else if(this.operation==="additive"&&this.direction==="backward")t=this.additiveBackward();else if(this.operation==="additive"&&this.direction==="inward")t=this.additiveInward();else if(this.operation==="additive"&&this.direction==="outward")t=this.additiveOutward();else if(this.operation==="subtractive"&&this.direction==="forward")t=this.subtractiveForward();else if(this.operation==="subtractive"&&this.direction==="backward")t=this.subtractiveBackward();else if(this.operation==="subtractive"&&this.direction==="inward")t=this.subtractiveInward();else if(this.operation==="subtractive"&&this.direction==="outward")t=this.subtractiveOutward();else throw new Error("Invalid operation/direction combination");return this.adjustOffsets(t)}additiveForward(){const e=[];for(let t=0;t<this.sequence.length;t++){const r=this.sequence.slice(0,t+1);for(let n=0;n<=this.repetition;n++)e.push(...r)}return e}additiveBackward(){const e=[];for(let t=this.sequence.length;t>0;t--){const r=this.sequence.slice(t-1);for(let n=0;n<=this.repetition;n++)e.push(...r)}return e}additiveInward(){const e=[],t=this.sequence.length;for(let r=0;r<Math.ceil(t/2);r++){let n;if(r<t-r-1){const i=this.sequence.slice(0,r+1),s=this.sequence.slice(t-r-1);n=[...i,...s]}else n=[...this.sequence];for(let i=0;i<=this.repetition;i++)e.push(...n)}return e}additiveOutward(){const e=[],t=this.sequence.length;if(t%2===0){const r=Math.floor(t/2)-1,n=Math.floor(t/2);for(let i=0;i<t/2;i++){const s=this.sequence.slice(r-i,n+i+1);for(let a=0;a<=this.repetition;a++)e.push(...s)}}else{const r=Math.floor(t/2);for(let n=0;n<=r;n++){const i=this.sequence.slice(r-n,r+n+1);for(let s=0;s<=this.repetition;s++)e.push(...i)}}return e}subtractiveForward(){const e=[];for(let t=0;t<this.sequence.length;t++){const r=this.sequence.slice(t);for(let n=0;n<=this.repetition;n++)e.push(...r)}return e}subtractiveBackward(){const e=[];for(let t=this.sequence.length;t>0;t--){const r=this.sequence.slice(0,t);for(let n=0;n<=this.repetition;n++)e.push(...r)}return e}subtractiveInward(){const e=[],t=this.sequence.length,r=Math.floor(t/2);for(let n=0;n<=this.repetition;n++)e.push(...this.sequence);for(let n=1;n<=r;n++){const i=this.sequence.slice(n,t-n);if(i.length>0)for(let s=0;s<=this.repetition;s++)e.push(...i)}return e}subtractiveOutward(){const e=[];let t=[...this.sequence];for(let r=0;r<=this.repetition;r++)e.push(...t);for(;t.length>2;){t=t.slice(1,-1);for(let r=0;r<=this.repetition;r++)e.push(...t)}return e}adjustOffsets(e){let t=0;return e.map(r=>{const n={...r,offset:t};return t+=r.duration,n})}}class vo{tChord;direction;rank;isAlternate;currentDirection;constructor(e,t="down",r=0){if(!["up","down","any","alternate"].includes(t))throw new Error("Invalid direction. Choose 'up', 'down', 'any' or 'alternate'.");if(this.tChord=e,this.isAlternate=t==="alternate",this.currentDirection=this.isAlternate?"up":t,this.direction=t,!Number.isInteger(r)||r<0)throw new Error("Rank must be a non-negative integer.");this.rank=Math.min(r,e.length-1),this.rank>=e.length&&console.warn("Rank exceeds the length of the t-chord. Using last note of the t-chord.")}generate(e){const t=[];for(const r of e){if(r.pitch===void 0){t.push({...r,pitch:void 0});continue}const n=r.pitch,s=this.tChord.map(u=>u-n).map((u,d)=>({index:d,value:u})).sort((u,d)=>Math.abs(u.value)-Math.abs(d.value));let a=this.rank,l;if(this.currentDirection==="up"||this.currentDirection==="down"){const u=s.filter(({value:d})=>this.currentDirection==="up"?d>=0:d<=0);if(u.length===0)l=this.currentDirection==="up"?Math.max(...this.tChord):Math.min(...this.tChord);else{a>=u.length&&(a=u.length-1);const d=u[a].index;l=this.tChord[d]}}else{a>=s.length&&(a=s.length-1);const u=s[a].index;l=this.tChord[u]}this.isAlternate&&(this.currentDirection=this.currentDirection==="up"?"down":"up"),t.push({...r,pitch:l})}return t}}const bo=Object.freeze(Object.defineProperty({__proto__:null,MusicalAnalysis:jn},Symbol.toStringTag,{value:"Module"})),wo={harmony:eo,rhythm:so,motifs:{MotifBank:ao}},$o={theory:oe},_o={gaussian:{Regressor:lo},automata:{Cellular:uo},loops:{Poly:ho},genetic:{Algorithm:fo},walks:{Random:po},fractals:{Mandelbrot:mo,LogisticMap:yo},minimalism:{Process:go,Tintinnabuli:vo}},Po={...bo},So={...Yi},De={theory:wo,constants:$o,generative:_o,analysis:Po,utils:So};class Eo{constructor(e={}){this.options=e}convert(e){return(e.tracks||[]).map(r=>({label:r.label,part:r.notes.map(n=>({time:n.time,note:n.pitch,duration:n.duration,velocity:n.velocity||.8}))}))}}function Mo(o,e={}){return new Eo(e).convert(o)}function On(o,e={}){if(!o||typeof o!="object")throw console.error("[PLAYER] Invalid composition:",o),new Error("Composition must be a valid JMON object");if(!o.sequences&&!o.tracks)throw console.error("[PLAYER] No sequences or tracks found in composition:",o),new Error("Composition must have sequences or tracks");const t=o.tracks||o.sequences||[];if(!Array.isArray(t))throw console.error("[PLAYER] Tracks/sequences must be an array:",t),new Error("Tracks/sequences must be an array");console.log("[PLAYER] Processing composition with",t.length,"tracks");const{tempo:r=o.bpm||120,showDebug:n=!1,customInstruments:i={},autoMultivoice:s=!0,maxVoices:a=4}=e,u=Mo(o,{autoMultivoice:s,maxVoices:a,showDebug:n}),{tracks:d,metadata:m}=u;let $=m.totalDuration;const _={background:"#FFFFFF",primary:"#333",secondary:"#F0F0F0",accent:"#333",text:"#000000",lightText:"#666666",border:"#CCCCCC"},E=document.createElement("div");E.style.cssText=`
        font-family: 'PT Sans', sans-serif;
        background-color: ${_.background};
        color: ${_.text};
        padding: 20px;
        border-radius: 12px;
        width: 400px;
        border: 1px solid ${_.border};
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
    `;const w=document.createElement("div");w.style.cssText=`
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    `;const p=document.createElement("div");p.style.cssText=`
        display: flex;
        flex-direction: column;
        width: 48%;
        justify-content: space-between;
    `;const h=document.createElement("div");h.style.cssText=`
        display: flex;
        flex-direction: column;
    `;const c=["PolySynth","Synth","AMSynth","DuoSynth","FMSynth","MembraneSynth","MetalSynth","MonoSynth","PluckSynth"],f=o.tracks||o.sequences||[],g=[];f.forEach((A,z)=>{const F=d.find(T=>T.originalTrackIndex===z)?.analysis;F?.hasGlissando&&console.warn(`Track ${A.label||A.name||z+1} contient un glissando : la polyphonie sera désactivée pour cette piste.`);const J=document.createElement("div");J.style.cssText=`
            margin-bottom: 8px;
        `;const B=document.createElement("label");B.textContent=A.name||A.label||`Track ${z+1}`,B.style.cssText=`
            font-size: 12px;
            color: ${_.text};
            display: block;
            margin-bottom: 2px;
        `;const M=document.createElement("select");M.style.cssText=`
            padding: 4px;
            border: 1px solid ${_.secondary};
            border-radius: 4px;
            background-color: ${_.background};
            color: ${_.text};
            font-size: 12px;
            width: 100%;
            height: 28px;
        `,c.forEach(T=>{const N=document.createElement("option");N.value=T,N.textContent=T,F?.hasGlissando&&(T==="PolySynth"||T==="DuoSynth")&&(N.disabled=!0,N.textContent+=" (mono only for glissando)"),M.appendChild(N)}),g.push(M),J.append(B,M),h.appendChild(J)}),p.appendChild(h);const b=document.createElement("div");b.style.cssText=`
        display: flex;
        flex-direction: column;
        width: 48%;
        justify-content: space-between;
    `;const v=document.createElement("div");v.style.cssText=`
        display: flex;
        flex-direction: column;
        width: 100%;
    `;const P=document.createElement("label");P.textContent="Tempo",P.style.cssText=`
        font-size: 14px;
        margin-bottom: 5px;
        color: ${_.text};
    `;const R=document.createElement("input");R.type="number",R.min=60,R.max=240,R.value=r,R.style.cssText=`
        padding: 8px;
        border: 1px solid ${_.secondary};
        border-radius: 6px;
        background-color: ${_.background};
        color: ${_.text};
        font-size: 14px;
        text-align: center;
        width: 100%;
        height: 36px;
    `,v.append(P,R),b.appendChild(v);const O=document.createElement("div");O.style.cssText=`
        position: relative;
        width: 100%;
        margin: 20px 0;
        display: flex;
        align-items: center;
    `;const q=document.createElement("input");q.type="range",q.min=0,q.max=100,q.value=0,q.style.cssText=`
        flex-grow: 1;
        -webkit-appearance: none;
        background: ${_.secondary};
        outline: none;
        border-radius: 15px;
        overflow: visible;
        height: 8px;
    `;const V=document.createElement("button");V.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>',V.style.cssText=`
        width: 40px;
        height: 40px;
        padding: 10px;
        border: none;
        border-radius: 50%;
        background-color: ${_.primary};
        color: ${_.background};
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0px 10px 0px 10px;
    `;const H=document.createElement("div");H.style.cssText=`
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: ${_.lightText};
        margin: 0px 0px 0px 10px;
    `;const U=document.createElement("span");U.textContent="0:00";const X=document.createElement("span");X.textContent="0:00",H.append(U," / ",X),O.append(q,V);const ne=document.createElement("div");ne.style.cssText=`
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    `;const ue=document.createElement("button");ue.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-keyboard-music" style="margin-right: 5px;"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="M6 8h4"/><path d="M14 8h.01"/><path d="M18 8h.01"/><path d="M2 12h20"/><path d="M6 12v4"/><path d="M10 12v4"/><path d="M14 12v4"/><path d="M18 12v4"/></svg><span>MIDI</span>',ue.style.cssText=`
        padding: 10px 20px;
        margin: 0 5px;
        border: none;
        border-radius: 6px;
        background-color: ${_.accent};
        color: ${_.background};
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    `;const he=document.createElement("button");he.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-audio-lines" style="margin-right: 5px;"><path d="M2 10v3"/><path d="M6 6v11"/><path d="M10 3v18"/><path d="M14 8v7"/><path d="M18 5v13"/><path d="M22 10v3"/></svg><span>WAV</span>',he.style.cssText=`
        padding: 10px 20px;
        margin: 0 5px;
        border: none;
        border-radius: 6px;
        background-color: ${_.accent};
        color: ${_.background};
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    `,ne.append(ue,he),w.append(p,b),E.append(w,O,H,ne);let D,ce=!1,I=[],k=[];const j=A=>`${Math.floor(A/60)}:${Math.floor(A%60).toString().padStart(2,"0")}`,x=async()=>{if(typeof window<"u"){if(!window.Tone)try{if(typeof require<"u")window.Tone=await require("https://unpkg.com/tone@14.8.49/build/Tone.js");else{const A=await import("https://unpkg.com/tone@14.8.49/build/Tone.js");window.Tone=A.default||A}}catch(A){return console.warn("Could not auto-load Tone.js:",A.message),console.log("To use the player, load Tone.js manually first:"),console.log('Tone = await require("https://unpkg.com/tone@14.8.49/build/Tone.js")'),!1}if(window.Tone)return D=window.Tone,D.context.state!=="running"&&(await D.start(),console.log("[PLAYER] Audio context started:",D.context.state)),!0}return console.warn("Tone.js not available"),!1},y=()=>{if(!D)return;console.log("[PLAYER] Cleaning up existing synths:",I.length,"parts:",k.length),I.forEach(F=>F.dispose()),k.forEach(F=>{F.stop(),F.dispose()}),I=[],k=[],d.forEach(F=>{const{originalTrackIndex:J,voiceIndex:B,totalVoices:M,trackInfo:T,synthConfig:N,partEvents:C}=F,L=g[J]?g[J].value:N.type;let K;try{const re=N.reason==="glissando_compatibility"?N.type:L;K=new D[re]().toDestination(),N.reason==="glissando_compatibility"&&B===0&&console.warn(`[MULTIVOICE] Using ${re} instead of ${N.original} for glissando in ${T.label}`)}catch(re){console.warn(`Failed to create ${L}, using PolySynth:`,re),K=new D.PolySynth().toDestination()}I.push(K),M>1&&console.log(`[MULTIVOICE] Track "${T.label}" voice ${B+1}: ${C.length} notes`),console.log("[PLAYER] Part events array:",C);const ie=new D.Part((re,G)=>{if(console.log("[PLAYER] Note event",{time:re,pitch:G.pitch,duration:G.duration,articulation:G.articulation,velocity:G.velocity,glissTarget:G.glissTarget}),Array.isArray(G.pitch))G.pitch.forEach(Q=>{let Z="C4";typeof Q=="number"?Z=D.Frequency(Q,"midi").toNote():typeof Q=="string"?Z=Q:Array.isArray(Q)&&typeof Q[0]=="string"&&(Z=Q[0]),console.log("[PLAYER] Chord note",{noteName:Z,duration:G.duration,time:re}),K.triggerAttackRelease(Z,G.duration,re)});else if(G.articulation==="glissando"&&G.glissTarget!==void 0){let Q=typeof G.pitch=="number"?D.Frequency(G.pitch,"midi").toNote():G.pitch,Z=typeof G.glissTarget=="number"?D.Frequency(G.glissTarget,"midi").toNote():G.glissTarget;console.log("[PLAYER] Glissando",{fromNote:Q,toNote:Z,duration:G.duration,time:re}),console.log("[PLAYER] Glissando effect starting from",Q,"to",Z),K.triggerAttack(Q,re,G.velocity||.8);const ae=D.Frequency(Q).toFrequency(),de=D.Frequency(Z).toFrequency(),Ne=1200*Math.log2(de/ae);if(K.detune&&K.detune.setValueAtTime&&K.detune.linearRampToValueAtTime)K.detune.setValueAtTime(0,re),K.detune.linearRampToValueAtTime(Ne,re+G.duration),console.log("[PLAYER] Applied detune glissando:",Ne,"cents over",G.duration,"beats");else{const Ve=D.Frequency(Q).toMidi(),Te=D.Frequency(Z).toMidi(),_e=Math.max(3,Math.abs(Te-Ve)),ze=G.duration/_e;for(let ke=1;ke<_e;ke++){const er=ke/(_e-1),jo=ae*Math.pow(de/ae,er),Oo=D.Frequency(jo).toNote(),Io=re+ke*ze;K.triggerAttackRelease(Oo,ze*.8,Io,(G.velocity||.8)*.7)}console.log("[PLAYER] Applied chromatic glissando with",_e,"steps")}K.triggerRelease(re+G.duration)}else{let Q="C4";typeof G.pitch=="number"?Q=D.Frequency(G.pitch,"midi").toNote():typeof G.pitch=="string"?Q=G.pitch:Array.isArray(G.pitch)&&typeof G.pitch[0]=="string"&&(Q=G.pitch[0]);let Z=G.duration,ae=G.velocity||.8;G.articulation==="staccato"&&(Z=G.duration*.5),G.articulation==="accent"&&(ae=Math.min(ae*2,1)),G.articulation==="tenuto"&&(Z=G.duration*1.5,ae=Math.min(ae*1.3,1)),console.log("[PLAYER] Single note",{noteName:Q,noteDuration:Z,time:re,noteVelocity:ae}),K.triggerAttackRelease(Q,Z,re,ae)}},C);ie.start(0),console.log(`[PLAYER] Part created for voice ${B+1} with ${C.length} notes, started at time 0`),k.push(ie)}),console.log("[PLAYER] Total duration from converter:",$,"seconds"),D.Transport.bpm.value=m.tempo;const A=60/m.tempo,z=$/A;D.Transport.loopEnd=z,console.log("[PLAYER] Transport loop end set to",z,"beats"),D.Transport.loop=!0,D.Transport.stop(),D.Transport.position=0,console.log("[PLAYER] Transport fully reset - position:",D.Transport.position,"state:",D.Transport.state),X.textContent=j($)},S=()=>{if(D&&ce){const A=D.Transport.seconds/$*100;q.value=Math.min(A,100),U.textContent=j(D.Transport.seconds),D.Transport.state==="started"&&ce?requestAnimationFrame(S):D.Transport.state==="stopped"&&(D.Transport.seconds=0,q.value=0,U.textContent=j(0),ce=!1,V.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>')}};return V.addEventListener("click",async()=>{if(console.log("[PLAYER] Play button clicked, isPlaying:",ce,"Tone available:",!!D),!D)if(console.log("[PLAYER] Initializing Tone.js..."),await x())y();else{console.error("[PLAYER] Failed to initialize Tone.js");return}ce?(console.log("[PLAYER] Stopping transport..."),D.Transport.stop(),ce=!1,V.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>'):(console.log("[PLAYER] Starting transport..."),I.length===0&&(console.log("[PLAYER] No synths found, setting up audio..."),y()),D.Transport.stop(),D.Transport.position=0,console.log("[PLAYER] Transport state before start:",D.Transport.state),console.log("[PLAYER] Transport position reset to:",D.Transport.position),console.log("[PLAYER] Audio context state:",D.context.state),console.log("[PLAYER] Parts count:",k.length),console.log("[PLAYER] Synths count:",I.length),D.Transport.start(),ce=!0,V.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-pause"><circle cx="12" cy="12" r="10"/><line x1="10" x2="10" y1="15" y2="9"/><line x1="14" x2="14" y1="15" y2="9"/></svg>',S())}),q.addEventListener("input",()=>{if(D&&$>0){const A=q.value/100*$;D.Transport.seconds=A,U.textContent=j(A)}}),R.addEventListener("change",()=>{const A=parseInt(R.value);D&&A>=60&&A<=240?D.Transport.bpm.value=A:R.value=D?D.Transport.bpm.value:r}),g.forEach(A=>{A.addEventListener("change",()=>{D&&I.length>0&&y()})}),ue.addEventListener("click",()=>{console.log("MIDI download - requires MIDI converter implementation")}),he.addEventListener("click",()=>{console.log("WAV download - requires WAV generator implementation")}),typeof window<"u"&&window.Tone&&x().then(()=>y()),E}function To(o){return new _n().validateAndNormalize(o)}function Xt(o){if(!o||typeof o!="object")throw console.error("[RENDER] Invalid JMON object:",o),new Error("render() requires a valid JMON object");return!o.sequences&&!o.tracks&&!o.format&&console.warn("[RENDER] Object does not appear to be JMON format, attempting normalization"),On(o)}function ko(o){const e=Xt(o);return setTimeout(()=>{const t=e.querySelector('button[aria-label="Play"]')||e.querySelector("button");t&&t.click()},100),e}function Ro(o){return Xt(o)}const In={render:Xt,play:ko,score:Ro,validate:To,createPlayer:On,theory:De.theory,generative:De.generative,analysis:De.analysis,constants:De.constants,utils:{...De.utils,JmonValidator:_n},VERSION:"1.0.0"};let Ae=null,Cn=!1;async function xo(){if(Cn)return Ae;Cn=!0;try{if(typeof window<"u"&&window.Plotly)return Ae=window.Plotly,Ae;if(typeof window>"u"){const e=await import("plotly.js");return Ae=e.default||e,Ae}return null}catch{return console.warn("Plotly.js not available. Visualization methods will return placeholder data."),null}}class Nt{static async line(e,t={},r="plot"){const n=await xo();if(!n)return{data:e,options:t,type:"line",message:"Plotly.js not available"};const{title:i,width:s=640,height:a=400,color:l="steelblue",xTitle:u="X",yTitle:d="Y"}=t,m={x:e.x,y:e.y,type:"scatter",mode:"lines",line:{color:l,width:2},name:"Line"},$={title:i?{text:i}:void 0,width:s,height:a,xaxis:{title:{text:u}},yaxis:{title:{text:d}}};await n.newPlot(r,[m],$)}static async scatter(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,color:a="steelblue",xTitle:l="X",yTitle:u="Y"}=t,d={x:e.x,y:e.y,type:"scatter",mode:"markers",marker:{color:e.color||a,size:e.size||8},name:"Scatter"},m={title:n?{text:n}:void 0,width:i,height:s,xaxis:{title:{text:l}},yaxis:{title:{text:u}}};await plotly.newPlot(r,[d],m)}static async heatmap(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,colorScale:a="Viridis",xTitle:l="X",yTitle:u="Y"}=t,d={z:e,type:"heatmap",colorscale:a,showscale:!0},m={title:n?{text:n}:void 0,width:i,height:s,xaxis:{title:{text:l}},yaxis:{title:{text:u}}};await plotly.newPlot(r,[d],m)}static async bar(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,color:a="steelblue",xTitle:l="X",yTitle:u="Y"}=t,d={x:e.x.map($=>$.toString()),y:e.y,type:"bar",marker:{color:e.color||a},name:"Bar"},m={title:n?{text:n}:void 0,width:i,height:s,xaxis:{title:{text:l}},yaxis:{title:{text:u}}};await plotly.newPlot(r,[d],m)}static async radar(e,t={},r="plot"){const{title:n,width:i=400,height:s=400,color:a="steelblue"}=t,l=[...e.x,e.x[0]],d={r:[...e.y,e.y[0]],theta:l,type:"scatterpolar",mode:"lines+markers",fill:"toself",line:{color:a},marker:{color:a,size:8},name:"Radar"},m={title:n?{text:n}:void 0,width:i,height:s,polar:{radialaxis:{visible:!0,range:[0,Math.max(...e.y)*1.1]}}};await plotly.newPlot(r,[d],m)}static async timeSeries(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,xTitle:a="Time",yTitle:l="Value"}=t,u={x:e.x,y:e.y,type:"scatter",mode:"lines",line:{width:2},name:"Time Series"},d={title:n?{text:n}:void 0,width:i,height:s,xaxis:{title:{text:a}},yaxis:{title:{text:l}}};await plotly.newPlot(r,[u],d)}static async matrix(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,xTitle:a="Position",yTitle:l="Time Step"}=t,d={z:e.slice().reverse(),type:"heatmap",colorscale:[[0,"white"],[1,"black"]],showscale:!1,hoverinfo:"none"},m={title:n?{text:n}:void 0,width:i,height:s,xaxis:{title:{text:a},showticklabels:!1},yaxis:{title:{text:l},showticklabels:!1}};await plotly.newPlot(r,[d],m)}static async surface(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,colorScale:a="Viridis",xTitle:l="X",yTitle:u="Y",zTitle:d="Z"}=t,m={x:e.x,y:e.y,z:e.z,type:"surface",colorscale:a},$={title:n?{text:n}:void 0,width:i,height:s,scene:{xaxis:{title:{text:l}},yaxis:{title:{text:u}},zaxis:{title:{text:d}}}};await plotly.newPlot(r,[m],$)}static async multiLine(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,xTitle:a="X",yTitle:l="Y"}=t,u=e.map((m,$)=>({x:m.x,y:m.y,type:"scatter",mode:"lines",name:`Series ${$+1}`,line:{width:2}})),d={title:n?{text:n}:void 0,width:i,height:s,xaxis:{title:{text:a}},yaxis:{title:{text:l}}};await plotly.newPlot(r,u,d)}static async histogram(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,color:a="steelblue",xTitle:l="Value",yTitle:u="Frequency"}=t,d={x:e.x,type:"histogram",marker:{color:a},name:"Histogram"},m={title:n?{text:n}:void 0,width:i,height:s,xaxis:{title:{text:l}},yaxis:{title:{text:u}}};await plotly.newPlot(r,[d],m)}static async boxPlot(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,yTitle:a="Value"}=t,l=e.map((d,m)=>({y:d.y,type:"box",name:`Dataset ${m+1}`})),u={title:n?{text:n}:void 0,width:i,height:s,yaxis:{title:{text:a}}};await plotly.newPlot(r,l,u)}static async violin(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,yTitle:a="Value"}=t,l=e.map((d,m)=>({y:d.y,type:"violin",name:`Dataset ${m+1}`,box:{visible:!0},meanline:{visible:!0}})),u={title:n?{text:n}:void 0,width:i,height:s,yaxis:{title:{text:a}}};await plotly.newPlot(r,l,u)}static async contour(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,colorScale:a="Viridis",xTitle:l="X",yTitle:u="Y"}=t,d={x:e.x,y:e.y,z:e.z,type:"contour",colorscale:a,showscale:!0},m={title:n?{text:n}:void 0,width:i,height:s,xaxis:{title:{text:l}},yaxis:{title:{text:u}}};await plotly.newPlot(r,[d],m)}static async scatter3D(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,color:a="steelblue",xTitle:l="X",yTitle:u="Y",zTitle:d="Z"}=t,m={x:e.x,y:e.y,z:e.z,type:"scatter3d",mode:"markers",marker:{color:e.color||a,size:4,opacity:.8},name:"3D Scatter"},$={title:n?{text:n}:void 0,width:i,height:s,scene:{xaxis:{title:{text:l}},yaxis:{title:{text:u}},zaxis:{title:{text:d}}}};await plotly.newPlot(r,[m],$)}static async animate(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,duration:a=500,transition:l=100}=t,u=e[0]?.data||[],d={title:n?{text:n}:void 0,width:i,height:s,updatemenus:[{type:"buttons",showactive:!1,buttons:[{label:"Play",method:"animate",args:[null,{frame:{duration:a,redraw:!0},transition:{duration:l},fromcurrent:!0}]},{label:"Pause",method:"animate",args:[[null],{frame:{duration:0,redraw:!1},mode:"immediate",transition:{duration:0}}]}]}],...e[0]?.layout},m=e.map(($,_)=>({name:_.toString(),data:$.data,layout:$.layout}));await Ae.newPlot(r,u,d),await plotly.addFrames(r,m)}static async candlestick(e,t={},r="plot"){const{title:n,width:i=640,height:s=400,xTitle:a="Time",yTitle:l="Price"}=t,u={x:e.x,open:e.open,high:e.high,low:e.low,close:e.close,type:"candlestick",name:"OHLC"},d={title:n?{text:n}:void 0,width:i,height:s,xaxis:{title:{text:a}},yaxis:{title:{text:l}}};await plotly.newPlot(r,[u],d)}}class Ao{static plotEvolution(e,t={}){const{title:r="Cellular Automata Evolution",width:n=600,height:i=400,colorScheme:s="binary",showAxis:a=!1}=t,l=[];return e.forEach((u,d)=>{u.forEach((m,$)=>{l.push({x:$,y:e.length-1-d,value:m})})}),Nt.matrix(e,{title:r,width:n,height:i,showAxis:a})}static plotGeneration(e,t={}){const{title:r="CA Generation",width:n=600,height:i=100}=t,s={x:e.map((a,l)=>l),y:e.map(()=>0),color:e.map(a=>a?"black":"white")};return Nt.scatter(s,{title:r,width:n,height:i,showAxis:!1})}static compareRules(e,t={}){const{width:r=300,height:n=200,colorScheme:i="binary"}=t;return e.map(({ruleNumber:s,history:a})=>this.plotEvolution(a,{title:`Rule ${s}`,width:r,height:n,colorScheme:i,showAxis:!1}))}static createAnimationData(e){return e.map((t,r)=>({frame:r,data:t.map((n,i)=>({x:i,y:0,value:n}))}))}static extractPatterns(e){const t=[],r=[],n=[],i=e[0]?.length||0;for(let s=0;s<i;s++){const a=e.map(u=>u[s]),l=this.findPeriod(a.filter(u=>u!==void 0));l>1&&l<10&&t.push({position:s,period:l})}if(e.length>5){const s=e[e.length-1],a=e[e.length-2];if(s&&a)for(let l=0;l<i-3;l++)s.slice(l,l+3).every((d,m)=>d===a[l+m]&&d===1)&&n.push({position:l,width:3})}return{oscillators:t,gliders:r,stillLifes:n}}static findPeriod(e){if(e.length<4)return 1;for(let t=1;t<=Math.floor(e.length/2);t++){let r=!0;for(let n=t;n<e.length;n++)if(e[n]!==e[n-t]){r=!1;break}if(r)return t}return 1}static plotDensity(e,t={}){const{title:r="CA Density Over Time",width:n=600,height:i=300}=t,s=e.map((l,u)=>({time:u,density:l.reduce((d,m)=>d+m,0)/l.length})),a={x:s.map(l=>l.time),y:s.map(l=>l.density)};return Nt.line(a,{title:r,width:n,height:i,color:"steelblue",showAxis:!0})}static plotSpacetime(e,t={}){const{title:r="Spacetime Diagram",width:n=600,height:i=400,showGrid:s=!1}=t,a=[];return e.forEach((l,u)=>{l.forEach((d,m)=>{a.push({x:m,y:e.length-1-u,value:d,border:s})})}),Nt.matrix(e,{title:r,width:n,height:i,showAxis:!1})}}const Qt=Object.freeze(Object.defineProperty({__proto__:null,CAVisualizer:Ao},Symbol.toStringTag,{value:"Module"}));let qn=null;class No{static plotPolyloop(e,t={}){const{pulse:r=1/4,colors:n,measureLength:i=4,container:s="polyloop-plot",title:a="Polyloop Visualization"}=t,l=n||this.generateColors(e.length),u=[],d=e.map(h=>h.label);e.forEach((h,c)=>{const f=h.points.filter(g=>g.active);if(f.length!==0&&(f.forEach(g=>{const b=g.angle,P=this.calculateDuration(g,h,i)*360/i,R=this.generateArcPoints(b,P,100),O=Array(100).fill(e.length-c-1);u.push({type:"scatterpolar",r:O,theta:R,mode:"lines",line:{color:"rgba(60, 60, 60, 0.65)",width:8},name:`${h.label} Duration`,showlegend:!1}),[b,(b+P)%360].forEach(q=>{u.push({type:"scatterpolar",r:[e.length-c-.9,e.length-c-1.1],theta:[q,q],mode:"lines",line:{color:"Black",width:3},name:`${h.label} Start/End`,showlegend:!1})})}),f.length>0)){const g=f.map(b=>b.angle);g.push(g[0]),u.push({type:"scatterpolar",r:Array(g.length).fill(e.length-c-1),theta:g,mode:"lines",line:{color:"rgba(0, 0, 0, 0.65)",width:1},fill:"toself",fillcolor:l[c%l.length],name:h.label,showlegend:!0})}});const m=[...u].reverse(),$=this.generateTickValues(i,r),_=this.generateTickLabels(i,r),E=Array.from({length:e.length},(h,c)=>c),w={title:{text:a},polar:{radialaxis:{visible:!0,range:[e.length,-.1],tickvals:E,ticktext:d},angularaxis:{tickvals:$,ticktext:_,direction:"clockwise",rotation:90}},template:"none",showlegend:!0,annotations:[{x:.5,y:.5,text:"�",showarrow:!1,font:{size:30,color:"White"},xref:"paper",yref:"paper"}]},p={responsive:!0,displayModeBar:!0};return qn.newPlot(s,m,w,p)}static generateColors(e){const t=[];for(let r=0;r<e;r++){const n=r/e,i=this.hsvToRgb(n,1,1);t.push(`rgba(${Math.round(i.r*255)}, ${Math.round(i.g*255)}, ${Math.round(i.b*255)}, 0.5)`)}return t}static hsvToRgb(e,t,r){let n,i,s;const a=Math.floor(e*6),l=e*6-a,u=r*(1-t),d=r*(1-l*t),m=r*(1-(1-l)*t);switch(a%6){case 0:n=r,i=m,s=u;break;case 1:n=d,i=r,s=u;break;case 2:n=u,i=r,s=m;break;case 3:n=u,i=d,s=r;break;case 4:n=m,i=u,s=r;break;case 5:n=r,i=u,s=d;break;default:n=i=s=0}return{r:n,g:i,b:s}}static generateArcPoints(e,t,r){const n=[];for(let i=0;i<r;i++){const s=e+i/(r-1)*t;n.push(s%360)}return n}static calculateDuration(e,t,r){return r/t.divisions}static generateTickValues(e,t){const r=[],n=Math.floor(e/t);for(let i=0;i<n;i++)r.push(i*360/n);return r}static generateTickLabels(e,t){const r=[],n=Math.floor(e/t);for(let i=0;i<n;i++){const s=i*t%e;r.push(s.toString())}return r}static plotTimeline(e,t=8,r={}){const{container:n="polyloop-timeline",title:i="Polyloop Timeline",colors:s}=r,a=s||this.generateColors(e.length),l=[];e.forEach((m,$)=>{const _=m.points.filter(p=>p.active),E=[],w=[];_.forEach(p=>{const h=p.angle/360*4;E.push(h),w.push(p.pitch||60)}),E.length>0&&l.push({type:"scatter",x:E,y:w,mode:"markers",marker:{color:a[$%a.length],size:10},name:m.label})});const u={title:{text:i},xaxis:{title:"Time (beats)",range:[0,t]},yaxis:{title:"Pitch (MIDI)",range:[20,120]},showlegend:!0},d={responsive:!0,displayModeBar:!0};return qn.newPlot(n,l,u,d)}static plotAnimated(e,t=12,r={}){const n=[];for(let i=0;i<t;i++){const s=i/t*360,a=e.map(u=>({...u,points:u.points.map(d=>({...d,angle:(d.angle+s*u.speed)%360}))})),l={...r,container:`${r.container||"polyloop-plot"}-frame-${i}`,title:`${r.title||"Polyloop"} - Frame ${i+1}`};n.push(this.plotPolyloop(a,l))}return Promise.all(n)}static convertToPolyloopData(e){const t={};return e.forEach(r=>{const n=r.points.map(i=>[i.active&&i.pitch||null,4/r.divisions,i.angle/360*4]);t[r.label]=n}),t}}const Zt=Object.freeze(Object.defineProperty({__proto__:null,PolyloopVisualizer:No},Symbol.toStringTag,{value:"Module"}));Pe.default=In,Pe.jm=In,Object.defineProperties(Pe,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));

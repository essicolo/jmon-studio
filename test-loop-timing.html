<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JMON Loop Timing Test</title>
    <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
    <script src="./dist/jmon.esm.js" type="module"></script>
</head>
<body>
    <h1>JMON Loop Timing Test</h1>
    <p>This test demonstrates the improved loop timing that eliminates silence at the end of loops.</p>
    
    <div id="player-container"></div>
    
    <script type="module">
        import jm from './dist/jmon.esm.js';
        
        // Departure (Lullaby) by Max Richter - test composition
        // Left hand arpeggio
        const pitches = [
            60, 63, 67, 63, 60, 63, 67, 63, 60, 63, 68, 63, 60, 63, 68, 63, 
            58, 63, 67, 63, 58, 63, 67, 63, 59, 62, 67, 62, 59, 62, 67, 62
        ];
        const durations = new Array(pitches.length).fill(1);
        const time = durations.map((duration, i) =>
            durations.slice(0, i + 1).reduce((sum, d) => sum + d, 0) - durations[0]
        );
        const left_hand = pitches.map((pitch, i) => ({
            pitch: pitch,
            duration: durations[i],
            time: time[i]
        }));

        const right_hand = [
            { pitch: 72, duration: 2, time: 0 },
            { pitch: 75, duration: 2, time: 14 },
            { pitch: 74, duration: 2, time: 16 },
            { pitch: 74, duration: 2, time: 30 }
        ];

        const testComposition = {
            format: "jmon",
            metadata: { title: "Departure (Lullaby)", composer: "Max Richter" },
            tracks: [
                {
                    name: "left hand",
                    notes: left_hand,
                    synthRef: "left_hand_synth"
                },
                {
                    name: "right hand",
                    notes: right_hand,
                    synthRef: "right_hand_synth"
                }
            ],
            tempo: 160,
            audioGraph: {
                nodes: [
                    {
                        id: "left_hand_synth",
                        type: "Synth",
                        options: {
                            oscillator: { type: "triangle" },
                            envelope: { attack: 0.1, decay: 0.1, sustain: 0.3, release: 0.8 }
                        },
                        target: "destination"
                    },
                    {
                        id: "right_hand_synth",
                        type: "Synth",
                        options: {
                            oscillator: { type: "triangle" },
                            envelope: { attack: 0.1, decay: 0.1, sustain: 0.3, release: 0.8 }
                        },
                        target: "destination"
                    }
                ],
                connections: []
            }
        };
        
        console.log('Test composition:', testComposition);
        
        // Create the player
        const player = jm.play(testComposition, { Tone });
        document.getElementById('player-container').appendChild(player);
        
        console.log('Player created with Departure (Lullaby) test!');
        console.log('Expected behavior:');
        console.log('- Left hand: 32 notes, each 1 beat, ending at time 31+1 = 32 beats');
        console.log('- Right hand: Last note at time 30 with duration 2, ending at time 32 beats');
        console.log('- Loop should restart exactly at beat 32 when all notes finish');
        console.log('- No silence gaps in the loop!');
        console.log('- Check console for duration calculation...');
        
        // Display the actual calculated times for debugging
        console.log('Left hand end time:', Math.max(...left_hand.map(n => n.time + n.duration)));
        console.log('Right hand end time:', Math.max(...right_hand.map(n => n.time + n.duration)));
    </script>
</body>
</html>

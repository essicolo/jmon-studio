<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JMON Timing Test - AudioGraph vs Regular Synths</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
            line-height: 1.5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        .test-section.passed {
            border-color: #28a745;
            background: #d4edda;
        }
        .test-section.failed {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .test-section.running {
            border-color: #ffc107;
            background: #fff3cd;
        }
        h2 {
            color: #495057;
            margin-top: 0;
        }
        .expected {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .results {
            background: #f3e5f5;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .player-container {
            margin: 15px 0;
            display: flex;
            justify-content: center;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 3px;
            display: inline-block;
            margin: 5px 0;
        }
        .status.pass { background: #d4edda; color: #155724; }
        .status.fail { background: #f8d7da; color: #721c24; }
        .status.running { background: #fff3cd; color: #856404; }
        .timing-data {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .test-log {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .summary {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #0066cc;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ JMON Timing Test Suite</h1>
        <p><strong>Purpose:</strong> Test if timing is consistent between audioGraph and regular synths at various tempos.</p>

        <div class="summary">
            <h3>üéØ Test Objectives</h3>
            <ul>
                <li>Verify 32-beat compositions play for correct duration at 180 BPM (~10.67 seconds)</li>
                <li>Compare audioGraph vs regular synth timing accuracy</li>
                <li>Test multiple tempos to ensure consistency</li>
                <li>Validate that displayed duration matches actual playback time</li>
            </ul>
        </div>

        <!-- Test 1: 180 BPM without audioGraph -->
        <div class="test-section" id="test1">
            <h2>üß™ Test 1: Regular Synths at 180 BPM</h2>
            <div class="expected">
                <strong>Expected:</strong> 32 beats at 180 BPM = 10.67 seconds<br>
                <em>Formula: (32 beats √∑ 180 BPM) √ó 60 = 10.67 seconds</em>
            </div>
            <div class="player-container" id="player1"></div>
            <button onclick="runTest1()">üéÆ Run Test 1</button>
            <button onclick="startTimingTest('test1')">‚è±Ô∏è Start Timing Test</button>
            <div class="results" id="results1">
                <div class="status" id="status1">‚è≥ Ready to test</div>
                <div class="timing-data" id="timing1">No timing data yet</div>
            </div>
            <div class="test-log" id="log1"></div>
        </div>

        <!-- Test 2: 180 BPM with audioGraph -->
        <div class="test-section" id="test2">
            <h2>üß™ Test 2: AudioGraph Synths at 180 BPM</h2>
            <div class="expected">
                <strong>Expected:</strong> 32 beats at 180 BPM = 10.67 seconds (same as Test 1)<br>
                <em>This should match Test 1 timing exactly</em>
            </div>
            <div class="player-container" id="player2"></div>
            <button onclick="runTest2()">üéÆ Run Test 2</button>
            <button onclick="startTimingTest('test2')">‚è±Ô∏è Start Timing Test</button>
            <div class="results" id="results2">
                <div class="status" id="status2">‚è≥ Ready to test</div>
                <div class="timing-data" id="timing2">No timing data yet</div>
            </div>
            <div class="test-log" id="log2"></div>
        </div>

        <!-- Test 3: Multiple Tempos -->
        <div class="test-section" id="test3">
            <h2>üß™ Test 3: Multiple Tempo Verification</h2>
            <div class="expected">
                <strong>Expected ratios for 32 beats:</strong><br>
                ‚Ä¢ 120 BPM = 16.00 seconds<br>
                ‚Ä¢ 180 BPM = 10.67 seconds<br>
                ‚Ä¢ 240 BPM = 8.00 seconds
            </div>
            <div id="tempo-tests">
                <div class="comparison">
                    <div>
                        <h4>Regular Synths</h4>
                        <div id="regular-tempo-players"></div>
                    </div>
                    <div>
                        <h4>AudioGraph Synths</h4>
                        <div id="audiograph-tempo-players"></div>
                    </div>
                </div>
            </div>
            <button onclick="runTempoTests()">üéÆ Run All Tempo Tests</button>
            <div class="results" id="results3">
                <div class="status" id="status3">‚è≥ Ready to test</div>
                <div class="timing-data" id="timing3">No timing data yet</div>
            </div>
        </div>

        <!-- Test Results Summary -->
        <div class="test-section" id="summary">
            <h2>üìä Test Results Summary</h2>
            <div id="summary-results">
                <p>Run tests above to see results</p>
            </div>
            <button onclick="generateReport()">üìÑ Generate Full Report</button>
        </div>
    </div>

    <script type="module">
        // Import JMON library
        import { jm } from '../dist/jmon.esm.js';
        
        // Import Tone.js
        const Tone = await import('https://esm.sh/tone@14.8.49');
        window.Tone = Tone.default || Tone;
        
        // Make jm and functions globally available
        window.jm = jm;
        
        console.log('üéµ JMON Timing Test Suite loaded');
        console.log('Tone.js version:', window.Tone.version || 'unknown');

        // Test data storage
        window.testResults = {
            test1: null,
            test2: null,
            tempoTests: {}
        };

        // Create base 32-beat composition
        function createTestComposition(tempo, useAudioGraph = false) {
            const baseComposition = {
                format: "jmon",
                version: "1.0.0",
                tempo: tempo,
                timeSignature: "4/4",
                keySignature: "C",
                metadata: {
                    title: `Timing Test - ${tempo} BPM ${useAudioGraph ? '(AudioGraph)' : '(Regular)'}`,
                    composer: "JMON Test Suite"
                },
                tracks: [
                    {
                        label: "Test Track",
                        notes: [
                            // Create notes spanning exactly 32 beats
                            { time: 0, pitch: 60, duration: 2 },    // C4, 2 beats
                            { time: 4, pitch: 62, duration: 2 },    // D4, 2 beats 
                            { time: 8, pitch: 64, duration: 2 },    // E4, 2 beats
                            { time: 12, pitch: 65, duration: 2 },   // F4, 2 beats
                            { time: 16, pitch: 67, duration: 2 },   // G4, 2 beats
                            { time: 20, pitch: 69, duration: 2 },   // A4, 2 beats
                            { time: 24, pitch: 71, duration: 2 },   // B4, 2 beats
                            { time: 28, pitch: 72, duration: 4 }    // C5, 4 beats (ends at beat 32)
                        ]
                    }
                ]
            };

            if (useAudioGraph) {
                // Add synthRef to track
                baseComposition.tracks[0].synthRef = "test_synth";
                
                // Add audioGraph
                baseComposition.audioGraph = [
                    {
                        id: "test_synth",
                        type: "Synth",
                        options: {
                            oscillator: { type: "triangle" },
                            envelope: { attack: 0.1, decay: 0.1, sustain: 0.3, release: 0.5 }
                        },
                        target: "master"
                    },
                    {
                        id: "master",
                        type: "Destination",
                        options: {}
                    }
                ];
            }

            return baseComposition;
        }

        // Log function
        function log(testId, message) {
            const logElement = document.getElementById(`log${testId.slice(-1)}`);
            if (logElement) {
                const timestamp = new Date().toLocaleTimeString();
                logElement.innerHTML += `[${timestamp}] ${message}<br>`;
                logElement.scrollTop = logElement.scrollHeight;
            }
            console.log(`[${testId}] ${message}`);
        }

        // Test 1: Regular synths at 180 BPM
        window.runTest1 = function() {
            const composition = createTestComposition(180, false);
            const playerElement = jm.createMusicPlayer(composition, { Tone: window.Tone });
            
            document.getElementById('player1').innerHTML = '';
            document.getElementById('player1').appendChild(playerElement);
            
            log('test1', 'Created regular synth player at 180 BPM');
            log('test1', `Expected duration: ${(32 * 60 / 180).toFixed(2)} seconds`);
            
            document.getElementById('status1').className = 'status running';
            document.getElementById('status1').textContent = 'üéÆ Player ready - click play and time it';
        };

        // Test 2: AudioGraph synths at 180 BPM
        window.runTest2 = function() {
            const composition = createTestComposition(180, true);
            const playerElement = jm.createMusicPlayer(composition, { Tone: window.Tone });
            
            document.getElementById('player2').innerHTML = '';
            document.getElementById('player2').appendChild(playerElement);
            
            log('test2', 'Created audioGraph synth player at 180 BPM');
            log('test2', 'AudioGraph: test_synth (Synth) -> master (Destination)');
            log('test2', `Expected duration: ${(32 * 60 / 180).toFixed(2)} seconds`);
            
            document.getElementById('status2').className = 'status running';
            document.getElementById('status2').textContent = 'üéÆ Player ready - click play and time it';
        };

        // Timing test function
        window.startTimingTest = function(testId) {
            const testNumber = testId.slice(-1);
            const statusEl = document.getElementById(`status${testNumber}`);
            const timingEl = document.getElementById(`timing${testNumber}`);
            
            statusEl.className = 'status running';
            statusEl.textContent = '‚è±Ô∏è Click play now! Timing...';
            
            log(testId, 'Manual timing test started - click play in the player');
            log(testId, 'Time how long the composition actually plays');
            log(testId, 'Compare with expected 10.67 seconds at 180 BPM');
            
            // Give instructions
            setTimeout(() => {
                statusEl.textContent = '‚è±Ô∏è Playing... use stopwatch to measure actual duration';
            }, 1000);
            
            // After reasonable time, ask for results
            setTimeout(() => {
                const actualTime = prompt(`How many seconds did Test ${testNumber} actually play? (Expected: 10.67s)`);
                if (actualTime) {
                    const expected = 32 * 60 / 180; // 10.67 seconds
                    const actual = parseFloat(actualTime);
                    const difference = Math.abs(actual - expected);
                    const percentError = (difference / expected) * 100;
                    
                    window.testResults[testId] = {
                        expected: expected.toFixed(2),
                        actual: actual.toFixed(2),
                        difference: difference.toFixed(2),
                        percentError: percentError.toFixed(1),
                        passed: percentError < 5 // Less than 5% error is acceptable
                    };
                    
                    // Update UI
                    timingEl.innerHTML = `
                        Expected: ${expected.toFixed(2)}s<br>
                        Actual: ${actual.toFixed(2)}s<br>
                        Difference: ${difference.toFixed(2)}s<br>
                        Error: ${percentError.toFixed(1)}%
                    `;
                    
                    if (percentError < 5) {
                        statusEl.className = 'status pass';
                        statusEl.textContent = '‚úÖ PASS - Timing accurate';
                        document.getElementById(testId).className = 'test-section passed';
                        log(testId, `‚úÖ PASSED: ${percentError.toFixed(1)}% error (acceptable)`);
                    } else {
                        statusEl.className = 'status fail';
                        statusEl.textContent = '‚ùå FAIL - Timing inaccurate';
                        document.getElementById(testId).className = 'test-section failed';
                        log(testId, `‚ùå FAILED: ${percentError.toFixed(1)}% error (too high)`);
                    }
                }
            }, 15000); // Wait 15 seconds for user to test
        };

        // Multiple tempo tests
        window.runTempoTests = function() {
            const tempos = [120, 180, 240];
            const regularContainer = document.getElementById('regular-tempo-players');
            const audiographContainer = document.getElementById('audiograph-tempo-players');
            
            regularContainer.innerHTML = '';
            audiographContainer.innerHTML = '';
            
            tempos.forEach(tempo => {
                const expected = (32 * 60 / tempo).toFixed(2);
                
                // Regular synth
                const regularComp = createTestComposition(tempo, false);
                const regularPlayer = jm.createMusicPlayer(regularComp, { Tone: window.Tone });
                const regularDiv = document.createElement('div');
                regularDiv.innerHTML = `<p><strong>${tempo} BPM</strong> (Expected: ${expected}s)</p>`;
                regularDiv.appendChild(regularPlayer);
                regularContainer.appendChild(regularDiv);
                
                // AudioGraph synth
                const audiographComp = createTestComposition(tempo, true);
                const audiographPlayer = jm.createMusicPlayer(audiographComp, { Tone: window.Tone });
                const audiographDiv = document.createElement('div');
                audiographDiv.innerHTML = `<p><strong>${tempo} BPM</strong> (Expected: ${expected}s)</p>`;
                audiographDiv.appendChild(audiographPlayer);
                audiographContainer.appendChild(audiographDiv);
                
                log('test3', `Created players for ${tempo} BPM - expected duration: ${expected}s`);
            });
            
            document.getElementById('status3').className = 'status running';
            document.getElementById('status3').textContent = 'üéÆ Multiple tempo players ready';
            
            log('test3', 'All tempo test players created - manually test each one');
        };

        // Generate report
        window.generateReport = function() {
            const summaryEl = document.getElementById('summary-results');
            let report = '<h3>üîç Test Results Analysis</h3>';
            
            // Test 1 & 2 comparison
            const test1 = window.testResults.test1;
            const test2 = window.testResults.test2;
            
            if (test1 && test2) {
                report += `
                    <h4>Main Tests Comparison (180 BPM, 32 beats)</h4>
                    <div class="timing-data">
                        <strong>Test 1 (Regular Synths):</strong><br>
                        Expected: ${test1.expected}s | Actual: ${test1.actual}s | Error: ${test1.percentError}%<br>
                        <strong>Test 2 (AudioGraph):</strong><br>
                        Expected: ${test2.expected}s | Actual: ${test2.actual}s | Error: ${test2.percentError}%<br>
                        <strong>Difference between methods:</strong> ${Math.abs(parseFloat(test1.actual) - parseFloat(test2.actual)).toFixed(2)}s
                    </div>
                `;
                
                if (test1.passed && test2.passed) {
                    report += '<p class="status pass">‚úÖ Both timing methods are accurate!</p>';
                } else if (!test1.passed && !test2.passed) {
                    report += '<p class="status fail">‚ùå Both timing methods have issues</p>';
                } else if (test1.passed && !test2.passed) {
                    report += '<p class="status fail">‚ùå AudioGraph timing is inaccurate compared to regular synths</p>';
                } else {
                    report += '<p class="status fail">‚ùå Regular synth timing is inaccurate compared to audioGraph</p>';
                }
            } else {
                report += '<p>Complete Test 1 and Test 2 to see comparison</p>';
            }
            
            report += `
                <h4>üí° What This Test Proves</h4>
                <ul>
                    <li><strong>Timing Consistency:</strong> AudioGraph and regular synths should have identical timing</li>
                    <li><strong>BPM Accuracy:</strong> Transport BPM setting affects all instrument types equally</li>
                    <li><strong>Duration Calculation:</strong> Displayed time matches actual playback time</li>
                    <li><strong>Fix Verification:</strong> The BPM initialization order fix works correctly</li>
                </ul>
            `;
            
            summaryEl.innerHTML = report;
            log('summary', 'Test report generated');
        };

        // Auto-log important events
        setTimeout(() => {
            log('system', 'Test suite fully loaded and ready');
            log('system', 'Use the buttons above to run each test');
            log('system', 'Manual timing with stopwatch is required for accuracy verification');
        }, 1000);
    </script>
</body>
</html>

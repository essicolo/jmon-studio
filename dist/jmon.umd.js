(function(Ge,rt){typeof exports=="object"&&typeof module<"u"?rt(exports):typeof define=="function"&&define.amd?define(["exports"],rt):(Ge=typeof globalThis<"u"?globalThis:Ge||self,rt(Ge.JmonStudio={}))})(this,(function(Ge){"use strict";function rt(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var dt={exports:{}},cr={},Ie={},Be={},lr={},ur={},dr={},Lr;function ht(){return Lr||(Lr=1,(function(s){Object.defineProperty(s,"__esModule",{value:!0}),s.regexpCode=s.getEsmExportName=s.getProperty=s.safeStringify=s.stringify=s.strConcat=s.addCodeArg=s.str=s._=s.nil=s._Code=s.Name=s.IDENTIFIER=s._CodeOrName=void 0;class e{}s._CodeOrName=e,s.IDENTIFIER=/^[a-z$_][a-z$_0-9]*$/i;class t extends e{constructor(u){if(super(),!s.IDENTIFIER.test(u))throw new Error("CodeGen: name must be a valid identifier");this.str=u}toString(){return this.str}emptyStr(){return!1}get names(){return{[this.str]:1}}}s.Name=t;class r extends e{constructor(u){super(),this._items=typeof u=="string"?[u]:u}toString(){return this.str}emptyStr(){if(this._items.length>1)return!1;const u=this._items[0];return u===""||u==='""'}get str(){var u;return(u=this._str)!==null&&u!==void 0?u:this._str=this._items.reduce((f,y)=>`${f}${y}`,"")}get names(){var u;return(u=this._names)!==null&&u!==void 0?u:this._names=this._items.reduce((f,y)=>(y instanceof t&&(f[y.str]=(f[y.str]||0)+1),f),{})}}s._Code=r,s.nil=new r("");function n(p,...u){const f=[p[0]];let y=0;for(;y<u.length;)a(f,u[y]),f.push(p[++y]);return new r(f)}s._=n;const i=new r("+");function o(p,...u){const f=[w(p[0])];let y=0;for(;y<u.length;)f.push(i),a(f,u[y]),f.push(i,w(p[++y]));return c(f),new r(f)}s.str=o;function a(p,u){u instanceof r?p.push(...u._items):u instanceof t?p.push(u):p.push(m(u))}s.addCodeArg=a;function c(p){let u=1;for(;u<p.length-1;){if(p[u]===i){const f=l(p[u-1],p[u+1]);if(f!==void 0){p.splice(u-1,3,f);continue}p[u++]="+"}u++}}function l(p,u){if(u==='""')return p;if(p==='""')return u;if(typeof p=="string")return u instanceof t||p[p.length-1]!=='"'?void 0:typeof u!="string"?`${p.slice(0,-1)}${u}"`:u[0]==='"'?p.slice(0,-1)+u.slice(1):void 0;if(typeof u=="string"&&u[0]==='"'&&!(p instanceof t))return`"${p}${u.slice(1)}`}function d(p,u){return u.emptyStr()?p:p.emptyStr()?u:o`${p}${u}`}s.strConcat=d;function m(p){return typeof p=="number"||typeof p=="boolean"||p===null?p:w(Array.isArray(p)?p.join(","):p)}function v(p){return new r(w(p))}s.stringify=v;function w(p){return JSON.stringify(p).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")}s.safeStringify=w;function P(p){return typeof p=="string"&&s.IDENTIFIER.test(p)?new r(`.${p}`):n`[${p}]`}s.getProperty=P;function g(p){if(typeof p=="string"&&s.IDENTIFIER.test(p))return new r(`${p}`);throw new Error(`CodeGen: invalid export name: ${p}, use explicit $id name mapping`)}s.getEsmExportName=g;function h(p){return new r(p.toString())}s.regexpCode=h})(dr)),dr}var hr={},Vr;function Fr(){return Vr||(Vr=1,(function(s){Object.defineProperty(s,"__esModule",{value:!0}),s.ValueScope=s.ValueScopeName=s.Scope=s.varKinds=s.UsedValueState=void 0;const e=ht();class t extends Error{constructor(l){super(`CodeGen: "code" for ${l} not defined`),this.value=l.value}}var r;(function(c){c[c.Started=0]="Started",c[c.Completed=1]="Completed"})(r||(s.UsedValueState=r={})),s.varKinds={const:new e.Name("const"),let:new e.Name("let"),var:new e.Name("var")};class n{constructor({prefixes:l,parent:d}={}){this._names={},this._prefixes=l,this._parent=d}toName(l){return l instanceof e.Name?l:this.name(l)}name(l){return new e.Name(this._newName(l))}_newName(l){const d=this._names[l]||this._nameGroup(l);return`${l}${d.index++}`}_nameGroup(l){var d,m;if(!((m=(d=this._parent)===null||d===void 0?void 0:d._prefixes)===null||m===void 0)&&m.has(l)||this._prefixes&&!this._prefixes.has(l))throw new Error(`CodeGen: prefix "${l}" is not allowed in this scope`);return this._names[l]={prefix:l,index:0}}}s.Scope=n;class i extends e.Name{constructor(l,d){super(d),this.prefix=l}setValue(l,{property:d,itemIndex:m}){this.value=l,this.scopePath=(0,e._)`.${new e.Name(d)}[${m}]`}}s.ValueScopeName=i;const o=(0,e._)`\n`;class a extends n{constructor(l){super(l),this._values={},this._scope=l.scope,this.opts={...l,_n:l.lines?o:e.nil}}get(){return this._scope}name(l){return new i(l,this._newName(l))}value(l,d){var m;if(d.ref===void 0)throw new Error("CodeGen: ref must be passed in value");const v=this.toName(l),{prefix:w}=v,P=(m=d.key)!==null&&m!==void 0?m:d.ref;let g=this._values[w];if(g){const u=g.get(P);if(u)return u}else g=this._values[w]=new Map;g.set(P,v);const h=this._scope[w]||(this._scope[w]=[]),p=h.length;return h[p]=d.ref,v.setValue(d,{property:w,itemIndex:p}),v}getValue(l,d){const m=this._values[l];if(m)return m.get(d)}scopeRefs(l,d=this._values){return this._reduceValues(d,m=>{if(m.scopePath===void 0)throw new Error(`CodeGen: name "${m}" has no value`);return(0,e._)`${l}${m.scopePath}`})}scopeCode(l=this._values,d,m){return this._reduceValues(l,v=>{if(v.value===void 0)throw new Error(`CodeGen: name "${v}" has no value`);return v.value.code},d,m)}_reduceValues(l,d,m={},v){let w=e.nil;for(const P in l){const g=l[P];if(!g)continue;const h=m[P]=m[P]||new Map;g.forEach(p=>{if(h.has(p))return;h.set(p,r.Started);let u=d(p);if(u){const f=this.opts.es5?s.varKinds.var:s.varKinds.const;w=(0,e._)`${w}${f} ${p} = ${u};${this.opts._n}`}else if(u=v?.(p))w=(0,e._)`${w}${u}${this.opts._n}`;else throw new t(p);h.set(p,r.Completed)})}return w}}s.ValueScope=a})(hr)),hr}var Gr;function te(){return Gr||(Gr=1,(function(s){Object.defineProperty(s,"__esModule",{value:!0}),s.or=s.and=s.not=s.CodeGen=s.operators=s.varKinds=s.ValueScopeName=s.ValueScope=s.Scope=s.Name=s.regexpCode=s.stringify=s.getProperty=s.nil=s.strConcat=s.str=s._=void 0;const e=ht(),t=Fr();var r=ht();Object.defineProperty(s,"_",{enumerable:!0,get:function(){return r._}}),Object.defineProperty(s,"str",{enumerable:!0,get:function(){return r.str}}),Object.defineProperty(s,"strConcat",{enumerable:!0,get:function(){return r.strConcat}}),Object.defineProperty(s,"nil",{enumerable:!0,get:function(){return r.nil}}),Object.defineProperty(s,"getProperty",{enumerable:!0,get:function(){return r.getProperty}}),Object.defineProperty(s,"stringify",{enumerable:!0,get:function(){return r.stringify}}),Object.defineProperty(s,"regexpCode",{enumerable:!0,get:function(){return r.regexpCode}}),Object.defineProperty(s,"Name",{enumerable:!0,get:function(){return r.Name}});var n=Fr();Object.defineProperty(s,"Scope",{enumerable:!0,get:function(){return n.Scope}}),Object.defineProperty(s,"ValueScope",{enumerable:!0,get:function(){return n.ValueScope}}),Object.defineProperty(s,"ValueScopeName",{enumerable:!0,get:function(){return n.ValueScopeName}}),Object.defineProperty(s,"varKinds",{enumerable:!0,get:function(){return n.varKinds}}),s.operators={GT:new e._Code(">"),GTE:new e._Code(">="),LT:new e._Code("<"),LTE:new e._Code("<="),EQ:new e._Code("==="),NEQ:new e._Code("!=="),NOT:new e._Code("!"),OR:new e._Code("||"),AND:new e._Code("&&"),ADD:new e._Code("+")};class i{optimizeNodes(){return this}optimizeNames(_,E){return this}}class o extends i{constructor(_,E,C){super(),this.varKind=_,this.name=E,this.rhs=C}render({es5:_,_n:E}){const C=_?t.varKinds.var:this.varKind,V=this.rhs===void 0?"":` = ${this.rhs}`;return`${C} ${this.name}${V};`+E}optimizeNames(_,E){if(_[this.name.str])return this.rhs&&(this.rhs=X(this.rhs,_,E)),this}get names(){return this.rhs instanceof e._CodeOrName?this.rhs.names:{}}}class a extends i{constructor(_,E,C){super(),this.lhs=_,this.rhs=E,this.sideEffects=C}render({_n:_}){return`${this.lhs} = ${this.rhs};`+_}optimizeNames(_,E){if(!(this.lhs instanceof e.Name&&!_[this.lhs.str]&&!this.sideEffects))return this.rhs=X(this.rhs,_,E),this}get names(){const _=this.lhs instanceof e.Name?{}:{...this.lhs.names};return F(_,this.rhs)}}class c extends a{constructor(_,E,C,V){super(_,C,V),this.op=E}render({_n:_}){return`${this.lhs} ${this.op}= ${this.rhs};`+_}}class l extends i{constructor(_){super(),this.label=_,this.names={}}render({_n:_}){return`${this.label}:`+_}}class d extends i{constructor(_){super(),this.label=_,this.names={}}render({_n:_}){return`break${this.label?` ${this.label}`:""};`+_}}class m extends i{constructor(_){super(),this.error=_}render({_n:_}){return`throw ${this.error};`+_}get names(){return this.error.names}}class v extends i{constructor(_){super(),this.code=_}render({_n:_}){return`${this.code};`+_}optimizeNodes(){return`${this.code}`?this:void 0}optimizeNames(_,E){return this.code=X(this.code,_,E),this}get names(){return this.code instanceof e._CodeOrName?this.code.names:{}}}class w extends i{constructor(_=[]){super(),this.nodes=_}render(_){return this.nodes.reduce((E,C)=>E+C.render(_),"")}optimizeNodes(){const{nodes:_}=this;let E=_.length;for(;E--;){const C=_[E].optimizeNodes();Array.isArray(C)?_.splice(E,1,...C):C?_[E]=C:_.splice(E,1)}return _.length>0?this:void 0}optimizeNames(_,E){const{nodes:C}=this;let V=C.length;for(;V--;){const M=C[V];M.optimizeNames(_,E)||(oe(_,M.names),C.splice(V,1))}return C.length>0?this:void 0}get names(){return this.nodes.reduce((_,E)=>L(_,E.names),{})}}class P extends w{render(_){return"{"+_._n+super.render(_)+"}"+_._n}}class g extends w{}class h extends P{}h.kind="else";class p extends P{constructor(_,E){super(E),this.condition=_}render(_){let E=`if(${this.condition})`+super.render(_);return this.else&&(E+="else "+this.else.render(_)),E}optimizeNodes(){super.optimizeNodes();const _=this.condition;if(_===!0)return this.nodes;let E=this.else;if(E){const C=E.optimizeNodes();E=this.else=Array.isArray(C)?new h(C):C}if(E)return _===!1?E instanceof p?E:E.nodes:this.nodes.length?this:new p(Se(_),E instanceof p?[E]:E.nodes);if(!(_===!1||!this.nodes.length))return this}optimizeNames(_,E){var C;if(this.else=(C=this.else)===null||C===void 0?void 0:C.optimizeNames(_,E),!!(super.optimizeNames(_,E)||this.else))return this.condition=X(this.condition,_,E),this}get names(){const _=super.names;return F(_,this.condition),this.else&&L(_,this.else.names),_}}p.kind="if";class u extends P{}u.kind="for";class f extends u{constructor(_){super(),this.iteration=_}render(_){return`for(${this.iteration})`+super.render(_)}optimizeNames(_,E){if(super.optimizeNames(_,E))return this.iteration=X(this.iteration,_,E),this}get names(){return L(super.names,this.iteration.names)}}class y extends u{constructor(_,E,C,V){super(),this.varKind=_,this.name=E,this.from=C,this.to=V}render(_){const E=_.es5?t.varKinds.var:this.varKind,{name:C,from:V,to:M}=this;return`for(${E} ${C}=${V}; ${C}<${M}; ${C}++)`+super.render(_)}get names(){const _=F(super.names,this.from);return F(_,this.to)}}class $ extends u{constructor(_,E,C,V){super(),this.loop=_,this.varKind=E,this.name=C,this.iterable=V}render(_){return`for(${this.varKind} ${this.name} ${this.loop} ${this.iterable})`+super.render(_)}optimizeNames(_,E){if(super.optimizeNames(_,E))return this.iterable=X(this.iterable,_,E),this}get names(){return L(super.names,this.iterable.names)}}class b extends P{constructor(_,E,C){super(),this.name=_,this.args=E,this.async=C}render(_){return`${this.async?"async ":""}function ${this.name}(${this.args})`+super.render(_)}}b.kind="func";class S extends w{render(_){return"return "+super.render(_)}}S.kind="return";class x extends P{render(_){let E="try"+super.render(_);return this.catch&&(E+=this.catch.render(_)),this.finally&&(E+=this.finally.render(_)),E}optimizeNodes(){var _,E;return super.optimizeNodes(),(_=this.catch)===null||_===void 0||_.optimizeNodes(),(E=this.finally)===null||E===void 0||E.optimizeNodes(),this}optimizeNames(_,E){var C,V;return super.optimizeNames(_,E),(C=this.catch)===null||C===void 0||C.optimizeNames(_,E),(V=this.finally)===null||V===void 0||V.optimizeNames(_,E),this}get names(){const _=super.names;return this.catch&&L(_,this.catch.names),this.finally&&L(_,this.finally.names),_}}class N extends P{constructor(_){super(),this.error=_}render(_){return`catch(${this.error})`+super.render(_)}}N.kind="catch";class z extends P{render(_){return"finally"+super.render(_)}}z.kind="finally";class q{constructor(_,E={}){this._values={},this._blockStarts=[],this._constants={},this.opts={...E,_n:E.lines?`
`:""},this._extScope=_,this._scope=new t.Scope({parent:_}),this._nodes=[new g]}toString(){return this._root.render(this.opts)}name(_){return this._scope.name(_)}scopeName(_){return this._extScope.name(_)}scopeValue(_,E){const C=this._extScope.value(_,E);return(this._values[C.prefix]||(this._values[C.prefix]=new Set)).add(C),C}getScopeValue(_,E){return this._extScope.getValue(_,E)}scopeRefs(_){return this._extScope.scopeRefs(_,this._values)}scopeCode(){return this._extScope.scopeCode(this._values)}_def(_,E,C,V){const M=this._scope.toName(E);return C!==void 0&&V&&(this._constants[M.str]=C),this._leafNode(new o(_,M,C)),M}const(_,E,C){return this._def(t.varKinds.const,_,E,C)}let(_,E,C){return this._def(t.varKinds.let,_,E,C)}var(_,E,C){return this._def(t.varKinds.var,_,E,C)}assign(_,E,C){return this._leafNode(new a(_,E,C))}add(_,E){return this._leafNode(new c(_,s.operators.ADD,E))}code(_){return typeof _=="function"?_():_!==e.nil&&this._leafNode(new v(_)),this}object(..._){const E=["{"];for(const[C,V]of _)E.length>1&&E.push(","),E.push(C),(C!==V||this.opts.es5)&&(E.push(":"),(0,e.addCodeArg)(E,V));return E.push("}"),new e._Code(E)}if(_,E,C){if(this._blockNode(new p(_)),E&&C)this.code(E).else().code(C).endIf();else if(E)this.code(E).endIf();else if(C)throw new Error('CodeGen: "else" body without "then" body');return this}elseIf(_){return this._elseNode(new p(_))}else(){return this._elseNode(new h)}endIf(){return this._endBlockNode(p,h)}_for(_,E){return this._blockNode(_),E&&this.code(E).endFor(),this}for(_,E){return this._for(new f(_),E)}forRange(_,E,C,V,M=this.opts.es5?t.varKinds.var:t.varKinds.let){const J=this._scope.toName(_);return this._for(new y(M,J,E,C),()=>V(J))}forOf(_,E,C,V=t.varKinds.const){const M=this._scope.toName(_);if(this.opts.es5){const J=E instanceof e.Name?E:this.var("_arr",E);return this.forRange("_i",0,(0,e._)`${J}.length`,W=>{this.var(M,(0,e._)`${J}[${W}]`),C(M)})}return this._for(new $("of",V,M,E),()=>C(M))}forIn(_,E,C,V=this.opts.es5?t.varKinds.var:t.varKinds.const){if(this.opts.ownProperties)return this.forOf(_,(0,e._)`Object.keys(${E})`,C);const M=this._scope.toName(_);return this._for(new $("in",V,M,E),()=>C(M))}endFor(){return this._endBlockNode(u)}label(_){return this._leafNode(new l(_))}break(_){return this._leafNode(new d(_))}return(_){const E=new S;if(this._blockNode(E),this.code(_),E.nodes.length!==1)throw new Error('CodeGen: "return" should have one node');return this._endBlockNode(S)}try(_,E,C){if(!E&&!C)throw new Error('CodeGen: "try" without "catch" and "finally"');const V=new x;if(this._blockNode(V),this.code(_),E){const M=this.name("e");this._currNode=V.catch=new N(M),E(M)}return C&&(this._currNode=V.finally=new z,this.code(C)),this._endBlockNode(N,z)}throw(_){return this._leafNode(new m(_))}block(_,E){return this._blockStarts.push(this._nodes.length),_&&this.code(_).endBlock(E),this}endBlock(_){const E=this._blockStarts.pop();if(E===void 0)throw new Error("CodeGen: not in self-balancing block");const C=this._nodes.length-E;if(C<0||_!==void 0&&C!==_)throw new Error(`CodeGen: wrong number of nodes: ${C} vs ${_} expected`);return this._nodes.length=E,this}func(_,E=e.nil,C,V){return this._blockNode(new b(_,E,C)),V&&this.code(V).endFunc(),this}endFunc(){return this._endBlockNode(b)}optimize(_=1){for(;_-- >0;)this._root.optimizeNodes(),this._root.optimizeNames(this._root.names,this._constants)}_leafNode(_){return this._currNode.nodes.push(_),this}_blockNode(_){this._currNode.nodes.push(_),this._nodes.push(_)}_endBlockNode(_,E){const C=this._currNode;if(C instanceof _||E&&C instanceof E)return this._nodes.pop(),this;throw new Error(`CodeGen: not in block "${E?`${_.kind}/${E.kind}`:_.kind}"`)}_elseNode(_){const E=this._currNode;if(!(E instanceof p))throw new Error('CodeGen: "else" without "if"');return this._currNode=E.else=_,this}get _root(){return this._nodes[0]}get _currNode(){const _=this._nodes;return _[_.length-1]}set _currNode(_){const E=this._nodes;E[E.length-1]=_}}s.CodeGen=q;function L(R,_){for(const E in _)R[E]=(R[E]||0)+(_[E]||0);return R}function F(R,_){return _ instanceof e._CodeOrName?L(R,_.names):R}function X(R,_,E){if(R instanceof e.Name)return C(R);if(!V(R))return R;return new e._Code(R._items.reduce((M,J)=>(J instanceof e.Name&&(J=C(J)),J instanceof e._Code?M.push(...J._items):M.push(J),M),[]));function C(M){const J=E[M.str];return J===void 0||_[M.str]!==1?M:(delete _[M.str],J)}function V(M){return M instanceof e._Code&&M._items.some(J=>J instanceof e.Name&&_[J.str]===1&&E[J.str]!==void 0)}}function oe(R,_){for(const E in _)R[E]=(R[E]||0)-(_[E]||0)}function Se(R){return typeof R=="boolean"||typeof R=="number"||R===null?!R:(0,e._)`!${O(R)}`}s.not=Se;const ye=k(s.operators.AND);function ne(...R){return R.reduce(ye)}s.and=ne;const de=k(s.operators.OR);function I(...R){return R.reduce(de)}s.or=I;function k(R){return(_,E)=>_===e.nil?E:E===e.nil?_:(0,e._)`${O(_)} ${R} ${O(E)}`}function O(R){return R instanceof e.Name?R:(0,e._)`(${R})`}})(ur)),ur}var Z={},Br;function ie(){if(Br)return Z;Br=1,Object.defineProperty(Z,"__esModule",{value:!0}),Z.checkStrictMode=Z.getErrorPath=Z.Type=Z.useFunc=Z.setEvaluated=Z.evaluatedPropsToName=Z.mergeEvaluated=Z.eachItem=Z.unescapeJsonPointer=Z.escapeJsonPointer=Z.escapeFragment=Z.unescapeFragment=Z.schemaRefOrVal=Z.schemaHasRulesButRef=Z.schemaHasRules=Z.checkUnknownRules=Z.alwaysValidSchema=Z.toHash=void 0;const s=te(),e=ht();function t($){const b={};for(const S of $)b[S]=!0;return b}Z.toHash=t;function r($,b){return typeof b=="boolean"?b:Object.keys(b).length===0?!0:(n($,b),!i(b,$.self.RULES.all))}Z.alwaysValidSchema=r;function n($,b=$.schema){const{opts:S,self:x}=$;if(!S.strictSchema||typeof b=="boolean")return;const N=x.RULES.keywords;for(const z in b)N[z]||y($,`unknown keyword: "${z}"`)}Z.checkUnknownRules=n;function i($,b){if(typeof $=="boolean")return!$;for(const S in $)if(b[S])return!0;return!1}Z.schemaHasRules=i;function o($,b){if(typeof $=="boolean")return!$;for(const S in $)if(S!=="$ref"&&b.all[S])return!0;return!1}Z.schemaHasRulesButRef=o;function a({topSchemaRef:$,schemaPath:b},S,x,N){if(!N){if(typeof S=="number"||typeof S=="boolean")return S;if(typeof S=="string")return(0,s._)`${S}`}return(0,s._)`${$}${b}${(0,s.getProperty)(x)}`}Z.schemaRefOrVal=a;function c($){return m(decodeURIComponent($))}Z.unescapeFragment=c;function l($){return encodeURIComponent(d($))}Z.escapeFragment=l;function d($){return typeof $=="number"?`${$}`:$.replace(/~/g,"~0").replace(/\//g,"~1")}Z.escapeJsonPointer=d;function m($){return $.replace(/~1/g,"/").replace(/~0/g,"~")}Z.unescapeJsonPointer=m;function v($,b){if(Array.isArray($))for(const S of $)b(S);else b($)}Z.eachItem=v;function w({mergeNames:$,mergeToName:b,mergeValues:S,resultToName:x}){return(N,z,q,L)=>{const F=q===void 0?z:q instanceof s.Name?(z instanceof s.Name?$(N,z,q):b(N,z,q),q):z instanceof s.Name?(b(N,q,z),z):S(z,q);return L===s.Name&&!(F instanceof s.Name)?x(N,F):F}}Z.mergeEvaluated={props:w({mergeNames:($,b,S)=>$.if((0,s._)`${S} !== true && ${b} !== undefined`,()=>{$.if((0,s._)`${b} === true`,()=>$.assign(S,!0),()=>$.assign(S,(0,s._)`${S} || {}`).code((0,s._)`Object.assign(${S}, ${b})`))}),mergeToName:($,b,S)=>$.if((0,s._)`${S} !== true`,()=>{b===!0?$.assign(S,!0):($.assign(S,(0,s._)`${S} || {}`),g($,S,b))}),mergeValues:($,b)=>$===!0?!0:{...$,...b},resultToName:P}),items:w({mergeNames:($,b,S)=>$.if((0,s._)`${S} !== true && ${b} !== undefined`,()=>$.assign(S,(0,s._)`${b} === true ? true : ${S} > ${b} ? ${S} : ${b}`)),mergeToName:($,b,S)=>$.if((0,s._)`${S} !== true`,()=>$.assign(S,b===!0?!0:(0,s._)`${S} > ${b} ? ${S} : ${b}`)),mergeValues:($,b)=>$===!0?!0:Math.max($,b),resultToName:($,b)=>$.var("items",b)})};function P($,b){if(b===!0)return $.var("props",!0);const S=$.var("props",(0,s._)`{}`);return b!==void 0&&g($,S,b),S}Z.evaluatedPropsToName=P;function g($,b,S){Object.keys(S).forEach(x=>$.assign((0,s._)`${b}${(0,s.getProperty)(x)}`,!0))}Z.setEvaluated=g;const h={};function p($,b){return $.scopeValue("func",{ref:b,code:h[b.code]||(h[b.code]=new e._Code(b.code))})}Z.useFunc=p;var u;(function($){$[$.Num=0]="Num",$[$.Str=1]="Str"})(u||(Z.Type=u={}));function f($,b,S){if($ instanceof s.Name){const x=b===u.Num;return S?x?(0,s._)`"[" + ${$} + "]"`:(0,s._)`"['" + ${$} + "']"`:x?(0,s._)`"/" + ${$}`:(0,s._)`"/" + ${$}.replace(/~/g, "~0").replace(/\\//g, "~1")`}return S?(0,s.getProperty)($).toString():"/"+d($)}Z.getErrorPath=f;function y($,b,S=$.opts.strictSchema){if(S){if(b=`strict mode: ${b}`,S===!0)throw new Error(b);$.self.logger.warn(b)}}return Z.checkStrictMode=y,Z}var ft={},Ur;function Ve(){if(Ur)return ft;Ur=1,Object.defineProperty(ft,"__esModule",{value:!0});const s=te(),e={data:new s.Name("data"),valCxt:new s.Name("valCxt"),instancePath:new s.Name("instancePath"),parentData:new s.Name("parentData"),parentDataProperty:new s.Name("parentDataProperty"),rootData:new s.Name("rootData"),dynamicAnchors:new s.Name("dynamicAnchors"),vErrors:new s.Name("vErrors"),errors:new s.Name("errors"),this:new s.Name("this"),self:new s.Name("self"),scope:new s.Name("scope"),json:new s.Name("json"),jsonPos:new s.Name("jsonPos"),jsonLen:new s.Name("jsonLen"),jsonPart:new s.Name("jsonPart")};return ft.default=e,ft}var Kr;function pt(){return Kr||(Kr=1,(function(s){Object.defineProperty(s,"__esModule",{value:!0}),s.extendErrors=s.resetErrorsCount=s.reportExtraError=s.reportError=s.keyword$DataError=s.keywordError=void 0;const e=te(),t=ie(),r=Ve();s.keywordError={message:({keyword:h})=>(0,e.str)`must pass "${h}" keyword validation`},s.keyword$DataError={message:({keyword:h,schemaType:p})=>p?(0,e.str)`"${h}" keyword must be ${p} ($data)`:(0,e.str)`"${h}" keyword is invalid ($data)`};function n(h,p=s.keywordError,u,f){const{it:y}=h,{gen:$,compositeRule:b,allErrors:S}=y,x=m(h,p,u);f??(b||S)?c($,x):l(y,(0,e._)`[${x}]`)}s.reportError=n;function i(h,p=s.keywordError,u){const{it:f}=h,{gen:y,compositeRule:$,allErrors:b}=f,S=m(h,p,u);c(y,S),$||b||l(f,r.default.vErrors)}s.reportExtraError=i;function o(h,p){h.assign(r.default.errors,p),h.if((0,e._)`${r.default.vErrors} !== null`,()=>h.if(p,()=>h.assign((0,e._)`${r.default.vErrors}.length`,p),()=>h.assign(r.default.vErrors,null)))}s.resetErrorsCount=o;function a({gen:h,keyword:p,schemaValue:u,data:f,errsCount:y,it:$}){if(y===void 0)throw new Error("ajv implementation error");const b=h.name("err");h.forRange("i",y,r.default.errors,S=>{h.const(b,(0,e._)`${r.default.vErrors}[${S}]`),h.if((0,e._)`${b}.instancePath === undefined`,()=>h.assign((0,e._)`${b}.instancePath`,(0,e.strConcat)(r.default.instancePath,$.errorPath))),h.assign((0,e._)`${b}.schemaPath`,(0,e.str)`${$.errSchemaPath}/${p}`),$.opts.verbose&&(h.assign((0,e._)`${b}.schema`,u),h.assign((0,e._)`${b}.data`,f))})}s.extendErrors=a;function c(h,p){const u=h.const("err",p);h.if((0,e._)`${r.default.vErrors} === null`,()=>h.assign(r.default.vErrors,(0,e._)`[${u}]`),(0,e._)`${r.default.vErrors}.push(${u})`),h.code((0,e._)`${r.default.errors}++`)}function l(h,p){const{gen:u,validateName:f,schemaEnv:y}=h;y.$async?u.throw((0,e._)`new ${h.ValidationError}(${p})`):(u.assign((0,e._)`${f}.errors`,p),u.return(!1))}const d={keyword:new e.Name("keyword"),schemaPath:new e.Name("schemaPath"),params:new e.Name("params"),propertyName:new e.Name("propertyName"),message:new e.Name("message"),schema:new e.Name("schema"),parentSchema:new e.Name("parentSchema")};function m(h,p,u){const{createErrors:f}=h.it;return f===!1?(0,e._)`{}`:v(h,p,u)}function v(h,p,u={}){const{gen:f,it:y}=h,$=[w(y,u),P(h,u)];return g(h,p,$),f.object(...$)}function w({errorPath:h},{instancePath:p}){const u=p?(0,e.str)`${h}${(0,t.getErrorPath)(p,t.Type.Str)}`:h;return[r.default.instancePath,(0,e.strConcat)(r.default.instancePath,u)]}function P({keyword:h,it:{errSchemaPath:p}},{schemaPath:u,parentSchema:f}){let y=f?p:(0,e.str)`${p}/${h}`;return u&&(y=(0,e.str)`${y}${(0,t.getErrorPath)(u,t.Type.Str)}`),[d.schemaPath,y]}function g(h,{params:p,message:u},f){const{keyword:y,data:$,schemaValue:b,it:S}=h,{opts:x,propertyName:N,topSchemaRef:z,schemaPath:q}=S;f.push([d.keyword,y],[d.params,typeof p=="function"?p(h):p||(0,e._)`{}`]),x.messages&&f.push([d.message,typeof u=="function"?u(h):u]),x.verbose&&f.push([d.schema,b],[d.parentSchema,(0,e._)`${z}${q}`],[r.default.data,$]),N&&f.push([d.propertyName,N])}})(lr)),lr}var Yr;function qi(){if(Yr)return Be;Yr=1,Object.defineProperty(Be,"__esModule",{value:!0}),Be.boolOrEmptySchema=Be.topBoolOrEmptySchema=void 0;const s=pt(),e=te(),t=Ve(),r={message:"boolean schema is false"};function n(a){const{gen:c,schema:l,validateName:d}=a;l===!1?o(a,!1):typeof l=="object"&&l.$async===!0?c.return(t.default.data):(c.assign((0,e._)`${d}.errors`,null),c.return(!0))}Be.topBoolOrEmptySchema=n;function i(a,c){const{gen:l,schema:d}=a;d===!1?(l.var(c,!1),o(a)):l.var(c,!0)}Be.boolOrEmptySchema=i;function o(a,c){const{gen:l,data:d}=a,m={gen:l,keyword:"false schema",data:d,schema:!1,schemaCode:!1,schemaValue:!1,params:{},it:a};(0,s.reportError)(m,r,void 0,c)}return Be}var ve={},Ue={},Hr;function Jr(){if(Hr)return Ue;Hr=1,Object.defineProperty(Ue,"__esModule",{value:!0}),Ue.getRules=Ue.isJSONType=void 0;const s=["string","number","integer","boolean","null","object","array"],e=new Set(s);function t(n){return typeof n=="string"&&e.has(n)}Ue.isJSONType=t;function r(){const n={number:{type:"number",rules:[]},string:{type:"string",rules:[]},array:{type:"array",rules:[]},object:{type:"object",rules:[]}};return{types:{...n,integer:!0,boolean:!0,null:!0},rules:[{rules:[]},n.number,n.string,n.array,n.object],post:{rules:[]},all:{},keywords:{}}}return Ue.getRules=r,Ue}var qe={},Wr;function Xr(){if(Wr)return qe;Wr=1,Object.defineProperty(qe,"__esModule",{value:!0}),qe.shouldUseRule=qe.shouldUseGroup=qe.schemaHasRulesForType=void 0;function s({schema:r,self:n},i){const o=n.RULES.types[i];return o&&o!==!0&&e(r,o)}qe.schemaHasRulesForType=s;function e(r,n){return n.rules.some(i=>t(r,i))}qe.shouldUseGroup=e;function t(r,n){var i;return r[n.keyword]!==void 0||((i=n.definition.implements)===null||i===void 0?void 0:i.some(o=>r[o]!==void 0))}return qe.shouldUseRule=t,qe}var Qr;function mt(){if(Qr)return ve;Qr=1,Object.defineProperty(ve,"__esModule",{value:!0}),ve.reportTypeError=ve.checkDataTypes=ve.checkDataType=ve.coerceAndCheckDataType=ve.getJSONTypes=ve.getSchemaTypes=ve.DataType=void 0;const s=Jr(),e=Xr(),t=pt(),r=te(),n=ie();var i;(function(u){u[u.Correct=0]="Correct",u[u.Wrong=1]="Wrong"})(i||(ve.DataType=i={}));function o(u){const f=a(u.type);if(f.includes("null")){if(u.nullable===!1)throw new Error("type: null contradicts nullable: false")}else{if(!f.length&&u.nullable!==void 0)throw new Error('"nullable" cannot be used without "type"');u.nullable===!0&&f.push("null")}return f}ve.getSchemaTypes=o;function a(u){const f=Array.isArray(u)?u:u?[u]:[];if(f.every(s.isJSONType))return f;throw new Error("type must be JSONType or JSONType[]: "+f.join(","))}ve.getJSONTypes=a;function c(u,f){const{gen:y,data:$,opts:b}=u,S=d(f,b.coerceTypes),x=f.length>0&&!(S.length===0&&f.length===1&&(0,e.schemaHasRulesForType)(u,f[0]));if(x){const N=P(f,$,b.strictNumbers,i.Wrong);y.if(N,()=>{S.length?m(u,f,S):h(u)})}return x}ve.coerceAndCheckDataType=c;const l=new Set(["string","number","integer","boolean","null"]);function d(u,f){return f?u.filter(y=>l.has(y)||f==="array"&&y==="array"):[]}function m(u,f,y){const{gen:$,data:b,opts:S}=u,x=$.let("dataType",(0,r._)`typeof ${b}`),N=$.let("coerced",(0,r._)`undefined`);S.coerceTypes==="array"&&$.if((0,r._)`${x} == 'object' && Array.isArray(${b}) && ${b}.length == 1`,()=>$.assign(b,(0,r._)`${b}[0]`).assign(x,(0,r._)`typeof ${b}`).if(P(f,b,S.strictNumbers),()=>$.assign(N,b))),$.if((0,r._)`${N} !== undefined`);for(const q of y)(l.has(q)||q==="array"&&S.coerceTypes==="array")&&z(q);$.else(),h(u),$.endIf(),$.if((0,r._)`${N} !== undefined`,()=>{$.assign(b,N),v(u,N)});function z(q){switch(q){case"string":$.elseIf((0,r._)`${x} == "number" || ${x} == "boolean"`).assign(N,(0,r._)`"" + ${b}`).elseIf((0,r._)`${b} === null`).assign(N,(0,r._)`""`);return;case"number":$.elseIf((0,r._)`${x} == "boolean" || ${b} === null
              || (${x} == "string" && ${b} && ${b} == +${b})`).assign(N,(0,r._)`+${b}`);return;case"integer":$.elseIf((0,r._)`${x} === "boolean" || ${b} === null
              || (${x} === "string" && ${b} && ${b} == +${b} && !(${b} % 1))`).assign(N,(0,r._)`+${b}`);return;case"boolean":$.elseIf((0,r._)`${b} === "false" || ${b} === 0 || ${b} === null`).assign(N,!1).elseIf((0,r._)`${b} === "true" || ${b} === 1`).assign(N,!0);return;case"null":$.elseIf((0,r._)`${b} === "" || ${b} === 0 || ${b} === false`),$.assign(N,null);return;case"array":$.elseIf((0,r._)`${x} === "string" || ${x} === "number"
              || ${x} === "boolean" || ${b} === null`).assign(N,(0,r._)`[${b}]`)}}}function v({gen:u,parentData:f,parentDataProperty:y},$){u.if((0,r._)`${f} !== undefined`,()=>u.assign((0,r._)`${f}[${y}]`,$))}function w(u,f,y,$=i.Correct){const b=$===i.Correct?r.operators.EQ:r.operators.NEQ;let S;switch(u){case"null":return(0,r._)`${f} ${b} null`;case"array":S=(0,r._)`Array.isArray(${f})`;break;case"object":S=(0,r._)`${f} && typeof ${f} == "object" && !Array.isArray(${f})`;break;case"integer":S=x((0,r._)`!(${f} % 1) && !isNaN(${f})`);break;case"number":S=x();break;default:return(0,r._)`typeof ${f} ${b} ${u}`}return $===i.Correct?S:(0,r.not)(S);function x(N=r.nil){return(0,r.and)((0,r._)`typeof ${f} == "number"`,N,y?(0,r._)`isFinite(${f})`:r.nil)}}ve.checkDataType=w;function P(u,f,y,$){if(u.length===1)return w(u[0],f,y,$);let b;const S=(0,n.toHash)(u);if(S.array&&S.object){const x=(0,r._)`typeof ${f} != "object"`;b=S.null?x:(0,r._)`!${f} || ${x}`,delete S.null,delete S.array,delete S.object}else b=r.nil;S.number&&delete S.integer;for(const x in S)b=(0,r.and)(b,w(x,f,y,$));return b}ve.checkDataTypes=P;const g={message:({schema:u})=>`must be ${u}`,params:({schema:u,schemaValue:f})=>typeof u=="string"?(0,r._)`{type: ${u}}`:(0,r._)`{type: ${f}}`};function h(u){const f=p(u);(0,t.reportError)(f,g)}ve.reportTypeError=h;function p(u){const{gen:f,data:y,schema:$}=u,b=(0,n.schemaRefOrVal)(u,$,"type");return{gen:f,keyword:"type",data:y,schema:$.type,schemaCode:b,schemaValue:b,parentSchema:$,params:{},it:u}}return ve}var nt={},Zr;function Di(){if(Zr)return nt;Zr=1,Object.defineProperty(nt,"__esModule",{value:!0}),nt.assignDefaults=void 0;const s=te(),e=ie();function t(n,i){const{properties:o,items:a}=n.schema;if(i==="object"&&o)for(const c in o)r(n,c,o[c].default);else i==="array"&&Array.isArray(a)&&a.forEach((c,l)=>r(n,l,c.default))}nt.assignDefaults=t;function r(n,i,o){const{gen:a,compositeRule:c,data:l,opts:d}=n;if(o===void 0)return;const m=(0,s._)`${l}${(0,s.getProperty)(i)}`;if(c){(0,e.checkStrictMode)(n,`default is ignored for: ${m}`);return}let v=(0,s._)`${m} === undefined`;d.useDefaults==="empty"&&(v=(0,s._)`${v} || ${m} === null || ${m} === ""`),a.if(v,(0,s._)`${m} = ${(0,s.stringify)(o)}`)}return nt}var Me={},ae={},en;function Ae(){if(en)return ae;en=1,Object.defineProperty(ae,"__esModule",{value:!0}),ae.validateUnion=ae.validateArray=ae.usePattern=ae.callValidateCode=ae.schemaProperties=ae.allSchemaProperties=ae.noPropertyInData=ae.propertyInData=ae.isOwnProperty=ae.hasPropFunc=ae.reportMissingProp=ae.checkMissingProp=ae.checkReportMissingProp=void 0;const s=te(),e=ie(),t=Ve(),r=ie();function n(u,f){const{gen:y,data:$,it:b}=u;y.if(d(y,$,f,b.opts.ownProperties),()=>{u.setParams({missingProperty:(0,s._)`${f}`},!0),u.error()})}ae.checkReportMissingProp=n;function i({gen:u,data:f,it:{opts:y}},$,b){return(0,s.or)(...$.map(S=>(0,s.and)(d(u,f,S,y.ownProperties),(0,s._)`${b} = ${S}`)))}ae.checkMissingProp=i;function o(u,f){u.setParams({missingProperty:f},!0),u.error()}ae.reportMissingProp=o;function a(u){return u.scopeValue("func",{ref:Object.prototype.hasOwnProperty,code:(0,s._)`Object.prototype.hasOwnProperty`})}ae.hasPropFunc=a;function c(u,f,y){return(0,s._)`${a(u)}.call(${f}, ${y})`}ae.isOwnProperty=c;function l(u,f,y,$){const b=(0,s._)`${f}${(0,s.getProperty)(y)} !== undefined`;return $?(0,s._)`${b} && ${c(u,f,y)}`:b}ae.propertyInData=l;function d(u,f,y,$){const b=(0,s._)`${f}${(0,s.getProperty)(y)} === undefined`;return $?(0,s.or)(b,(0,s.not)(c(u,f,y))):b}ae.noPropertyInData=d;function m(u){return u?Object.keys(u).filter(f=>f!=="__proto__"):[]}ae.allSchemaProperties=m;function v(u,f){return m(f).filter(y=>!(0,e.alwaysValidSchema)(u,f[y]))}ae.schemaProperties=v;function w({schemaCode:u,data:f,it:{gen:y,topSchemaRef:$,schemaPath:b,errorPath:S},it:x},N,z,q){const L=q?(0,s._)`${u}, ${f}, ${$}${b}`:f,F=[[t.default.instancePath,(0,s.strConcat)(t.default.instancePath,S)],[t.default.parentData,x.parentData],[t.default.parentDataProperty,x.parentDataProperty],[t.default.rootData,t.default.rootData]];x.opts.dynamicRef&&F.push([t.default.dynamicAnchors,t.default.dynamicAnchors]);const X=(0,s._)`${L}, ${y.object(...F)}`;return z!==s.nil?(0,s._)`${N}.call(${z}, ${X})`:(0,s._)`${N}(${X})`}ae.callValidateCode=w;const P=(0,s._)`new RegExp`;function g({gen:u,it:{opts:f}},y){const $=f.unicodeRegExp?"u":"",{regExp:b}=f.code,S=b(y,$);return u.scopeValue("pattern",{key:S.toString(),ref:S,code:(0,s._)`${b.code==="new RegExp"?P:(0,r.useFunc)(u,b)}(${y}, ${$})`})}ae.usePattern=g;function h(u){const{gen:f,data:y,keyword:$,it:b}=u,S=f.name("valid");if(b.allErrors){const N=f.let("valid",!0);return x(()=>f.assign(N,!1)),N}return f.var(S,!0),x(()=>f.break()),S;function x(N){const z=f.const("len",(0,s._)`${y}.length`);f.forRange("i",0,z,q=>{u.subschema({keyword:$,dataProp:q,dataPropType:e.Type.Num},S),f.if((0,s.not)(S),N)})}}ae.validateArray=h;function p(u){const{gen:f,schema:y,keyword:$,it:b}=u;if(!Array.isArray(y))throw new Error("ajv implementation error");if(y.some(z=>(0,e.alwaysValidSchema)(b,z))&&!b.opts.unevaluated)return;const x=f.let("valid",!1),N=f.name("_valid");f.block(()=>y.forEach((z,q)=>{const L=u.subschema({keyword:$,schemaProp:q,compositeRule:!0},N);f.assign(x,(0,s._)`${x} || ${N}`),u.mergeValidEvaluated(L,N)||f.if((0,s.not)(x))})),u.result(x,()=>u.reset(),()=>u.error(!0))}return ae.validateUnion=p,ae}var tn;function zi(){if(tn)return Me;tn=1,Object.defineProperty(Me,"__esModule",{value:!0}),Me.validateKeywordUsage=Me.validSchemaType=Me.funcKeywordCode=Me.macroKeywordCode=void 0;const s=te(),e=Ve(),t=Ae(),r=pt();function n(v,w){const{gen:P,keyword:g,schema:h,parentSchema:p,it:u}=v,f=w.macro.call(u.self,h,p,u),y=l(P,g,f);u.opts.validateSchema!==!1&&u.self.validateSchema(f,!0);const $=P.name("valid");v.subschema({schema:f,schemaPath:s.nil,errSchemaPath:`${u.errSchemaPath}/${g}`,topSchemaRef:y,compositeRule:!0},$),v.pass($,()=>v.error(!0))}Me.macroKeywordCode=n;function i(v,w){var P;const{gen:g,keyword:h,schema:p,parentSchema:u,$data:f,it:y}=v;c(y,w);const $=!f&&w.compile?w.compile.call(y.self,p,u,y):w.validate,b=l(g,h,$),S=g.let("valid");v.block$data(S,x),v.ok((P=w.valid)!==null&&P!==void 0?P:S);function x(){if(w.errors===!1)q(),w.modifying&&o(v),L(()=>v.error());else{const F=w.async?N():z();w.modifying&&o(v),L(()=>a(v,F))}}function N(){const F=g.let("ruleErrs",null);return g.try(()=>q((0,s._)`await `),X=>g.assign(S,!1).if((0,s._)`${X} instanceof ${y.ValidationError}`,()=>g.assign(F,(0,s._)`${X}.errors`),()=>g.throw(X))),F}function z(){const F=(0,s._)`${b}.errors`;return g.assign(F,null),q(s.nil),F}function q(F=w.async?(0,s._)`await `:s.nil){const X=y.opts.passContext?e.default.this:e.default.self,oe=!("compile"in w&&!f||w.schema===!1);g.assign(S,(0,s._)`${F}${(0,t.callValidateCode)(v,b,X,oe)}`,w.modifying)}function L(F){var X;g.if((0,s.not)((X=w.valid)!==null&&X!==void 0?X:S),F)}}Me.funcKeywordCode=i;function o(v){const{gen:w,data:P,it:g}=v;w.if(g.parentData,()=>w.assign(P,(0,s._)`${g.parentData}[${g.parentDataProperty}]`))}function a(v,w){const{gen:P}=v;P.if((0,s._)`Array.isArray(${w})`,()=>{P.assign(e.default.vErrors,(0,s._)`${e.default.vErrors} === null ? ${w} : ${e.default.vErrors}.concat(${w})`).assign(e.default.errors,(0,s._)`${e.default.vErrors}.length`),(0,r.extendErrors)(v)},()=>v.error())}function c({schemaEnv:v},w){if(w.async&&!v.$async)throw new Error("async keyword in sync schema")}function l(v,w,P){if(P===void 0)throw new Error(`keyword "${w}" failed to compile`);return v.scopeValue("keyword",typeof P=="function"?{ref:P}:{ref:P,code:(0,s.stringify)(P)})}function d(v,w,P=!1){return!w.length||w.some(g=>g==="array"?Array.isArray(v):g==="object"?v&&typeof v=="object"&&!Array.isArray(v):typeof v==g||P&&typeof v>"u")}Me.validSchemaType=d;function m({schema:v,opts:w,self:P,errSchemaPath:g},h,p){if(Array.isArray(h.keyword)?!h.keyword.includes(p):h.keyword!==p)throw new Error("ajv implementation error");const u=h.dependencies;if(u?.some(f=>!Object.prototype.hasOwnProperty.call(v,f)))throw new Error(`parent schema must have dependencies of ${p}: ${u.join(",")}`);if(h.validateSchema&&!h.validateSchema(v[p])){const y=`keyword "${p}" value is invalid at path "${g}": `+P.errorsText(h.validateSchema.errors);if(w.validateSchema==="log")P.logger.error(y);else throw new Error(y)}}return Me.validateKeywordUsage=m,Me}var De={},rn;function Li(){if(rn)return De;rn=1,Object.defineProperty(De,"__esModule",{value:!0}),De.extendSubschemaMode=De.extendSubschemaData=De.getSubschema=void 0;const s=te(),e=ie();function t(i,{keyword:o,schemaProp:a,schema:c,schemaPath:l,errSchemaPath:d,topSchemaRef:m}){if(o!==void 0&&c!==void 0)throw new Error('both "keyword" and "schema" passed, only one allowed');if(o!==void 0){const v=i.schema[o];return a===void 0?{schema:v,schemaPath:(0,s._)`${i.schemaPath}${(0,s.getProperty)(o)}`,errSchemaPath:`${i.errSchemaPath}/${o}`}:{schema:v[a],schemaPath:(0,s._)`${i.schemaPath}${(0,s.getProperty)(o)}${(0,s.getProperty)(a)}`,errSchemaPath:`${i.errSchemaPath}/${o}/${(0,e.escapeFragment)(a)}`}}if(c!==void 0){if(l===void 0||d===void 0||m===void 0)throw new Error('"schemaPath", "errSchemaPath" and "topSchemaRef" are required with "schema"');return{schema:c,schemaPath:l,topSchemaRef:m,errSchemaPath:d}}throw new Error('either "keyword" or "schema" must be passed')}De.getSubschema=t;function r(i,o,{dataProp:a,dataPropType:c,data:l,dataTypes:d,propertyName:m}){if(l!==void 0&&a!==void 0)throw new Error('both "data" and "dataProp" passed, only one allowed');const{gen:v}=o;if(a!==void 0){const{errorPath:P,dataPathArr:g,opts:h}=o,p=v.let("data",(0,s._)`${o.data}${(0,s.getProperty)(a)}`,!0);w(p),i.errorPath=(0,s.str)`${P}${(0,e.getErrorPath)(a,c,h.jsPropertySyntax)}`,i.parentDataProperty=(0,s._)`${a}`,i.dataPathArr=[...g,i.parentDataProperty]}if(l!==void 0){const P=l instanceof s.Name?l:v.let("data",l,!0);w(P),m!==void 0&&(i.propertyName=m)}d&&(i.dataTypes=d);function w(P){i.data=P,i.dataLevel=o.dataLevel+1,i.dataTypes=[],o.definedProperties=new Set,i.parentData=o.data,i.dataNames=[...o.dataNames,P]}}De.extendSubschemaData=r;function n(i,{jtdDiscriminator:o,jtdMetadata:a,compositeRule:c,createErrors:l,allErrors:d}){c!==void 0&&(i.compositeRule=c),l!==void 0&&(i.createErrors=l),d!==void 0&&(i.allErrors=d),i.jtdDiscriminator=o,i.jtdMetadata=a}return De.extendSubschemaMode=n,De}var Pe={},fr,nn;function on(){return nn||(nn=1,fr=function s(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var r,n,i;if(Array.isArray(e)){if(r=e.length,r!=t.length)return!1;for(n=r;n--!==0;)if(!s(e[n],t[n]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();if(i=Object.keys(e),r=i.length,r!==Object.keys(t).length)return!1;for(n=r;n--!==0;)if(!Object.prototype.hasOwnProperty.call(t,i[n]))return!1;for(n=r;n--!==0;){var o=i[n];if(!s(e[o],t[o]))return!1}return!0}return e!==e&&t!==t}),fr}var pr={exports:{}},sn;function Vi(){if(sn)return pr.exports;sn=1;var s=pr.exports=function(r,n,i){typeof n=="function"&&(i=n,n={}),i=n.cb||i;var o=typeof i=="function"?i:i.pre||function(){},a=i.post||function(){};e(n,o,a,r,"",r)};s.keywords={additionalItems:!0,items:!0,contains:!0,additionalProperties:!0,propertyNames:!0,not:!0,if:!0,then:!0,else:!0},s.arrayKeywords={items:!0,allOf:!0,anyOf:!0,oneOf:!0},s.propsKeywords={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependencies:!0},s.skipKeywords={default:!0,enum:!0,const:!0,required:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};function e(r,n,i,o,a,c,l,d,m,v){if(o&&typeof o=="object"&&!Array.isArray(o)){n(o,a,c,l,d,m,v);for(var w in o){var P=o[w];if(Array.isArray(P)){if(w in s.arrayKeywords)for(var g=0;g<P.length;g++)e(r,n,i,P[g],a+"/"+w+"/"+g,c,a,w,o,g)}else if(w in s.propsKeywords){if(P&&typeof P=="object")for(var h in P)e(r,n,i,P[h],a+"/"+w+"/"+t(h),c,a,w,o,h)}else(w in s.keywords||r.allKeys&&!(w in s.skipKeywords))&&e(r,n,i,P,a+"/"+w,c,a,w,o)}i(o,a,c,l,d,m,v)}}function t(r){return r.replace(/~/g,"~0").replace(/\//g,"~1")}return pr.exports}var an;function gt(){if(an)return Pe;an=1,Object.defineProperty(Pe,"__esModule",{value:!0}),Pe.getSchemaRefs=Pe.resolveUrl=Pe.normalizeId=Pe._getFullPath=Pe.getFullPath=Pe.inlineRef=void 0;const s=ie(),e=on(),t=Vi(),r=new Set(["type","format","pattern","maxLength","minLength","maxProperties","minProperties","maxItems","minItems","maximum","minimum","uniqueItems","multipleOf","required","enum","const"]);function n(g,h=!0){return typeof g=="boolean"?!0:h===!0?!o(g):h?a(g)<=h:!1}Pe.inlineRef=n;const i=new Set(["$ref","$recursiveRef","$recursiveAnchor","$dynamicRef","$dynamicAnchor"]);function o(g){for(const h in g){if(i.has(h))return!0;const p=g[h];if(Array.isArray(p)&&p.some(o)||typeof p=="object"&&o(p))return!0}return!1}function a(g){let h=0;for(const p in g){if(p==="$ref")return 1/0;if(h++,!r.has(p)&&(typeof g[p]=="object"&&(0,s.eachItem)(g[p],u=>h+=a(u)),h===1/0))return 1/0}return h}function c(g,h="",p){p!==!1&&(h=m(h));const u=g.parse(h);return l(g,u)}Pe.getFullPath=c;function l(g,h){return g.serialize(h).split("#")[0]+"#"}Pe._getFullPath=l;const d=/#\/?$/;function m(g){return g?g.replace(d,""):""}Pe.normalizeId=m;function v(g,h,p){return p=m(p),g.resolve(h,p)}Pe.resolveUrl=v;const w=/^[a-z_][-a-z0-9._]*$/i;function P(g,h){if(typeof g=="boolean")return{};const{schemaId:p,uriResolver:u}=this.opts,f=m(g[p]||h),y={"":f},$=c(u,f,!1),b={},S=new Set;return t(g,{allKeys:!0},(z,q,L,F)=>{if(F===void 0)return;const X=$+q;let oe=y[F];typeof z[p]=="string"&&(oe=Se.call(this,z[p])),ye.call(this,z.$anchor),ye.call(this,z.$dynamicAnchor),y[q]=oe;function Se(ne){const de=this.opts.uriResolver.resolve;if(ne=m(oe?de(oe,ne):ne),S.has(ne))throw N(ne);S.add(ne);let I=this.refs[ne];return typeof I=="string"&&(I=this.refs[I]),typeof I=="object"?x(z,I.schema,ne):ne!==m(X)&&(ne[0]==="#"?(x(z,b[ne],ne),b[ne]=z):this.refs[ne]=X),ne}function ye(ne){if(typeof ne=="string"){if(!w.test(ne))throw new Error(`invalid anchor "${ne}"`);Se.call(this,`#${ne}`)}}}),b;function x(z,q,L){if(q!==void 0&&!e(z,q))throw N(L)}function N(z){return new Error(`reference "${z}" resolves to more than one schema`)}}return Pe.getSchemaRefs=P,Pe}var cn;function yt(){if(cn)return Ie;cn=1,Object.defineProperty(Ie,"__esModule",{value:!0}),Ie.getData=Ie.KeywordCxt=Ie.validateFunctionCode=void 0;const s=qi(),e=mt(),t=Xr(),r=mt(),n=Di(),i=zi(),o=Li(),a=te(),c=Ve(),l=gt(),d=ie(),m=pt();function v(T){if($(T)&&(S(T),y(T))){h(T);return}w(T,()=>(0,s.topBoolOrEmptySchema)(T))}Ie.validateFunctionCode=v;function w({gen:T,validateName:A,schema:j,schemaEnv:D,opts:B},Q){B.code.es5?T.func(A,(0,a._)`${c.default.data}, ${c.default.valCxt}`,D.$async,()=>{T.code((0,a._)`"use strict"; ${u(j,B)}`),g(T,B),T.code(Q)}):T.func(A,(0,a._)`${c.default.data}, ${P(B)}`,D.$async,()=>T.code(u(j,B)).code(Q))}function P(T){return(0,a._)`{${c.default.instancePath}="", ${c.default.parentData}, ${c.default.parentDataProperty}, ${c.default.rootData}=${c.default.data}${T.dynamicRef?(0,a._)`, ${c.default.dynamicAnchors}={}`:a.nil}}={}`}function g(T,A){T.if(c.default.valCxt,()=>{T.var(c.default.instancePath,(0,a._)`${c.default.valCxt}.${c.default.instancePath}`),T.var(c.default.parentData,(0,a._)`${c.default.valCxt}.${c.default.parentData}`),T.var(c.default.parentDataProperty,(0,a._)`${c.default.valCxt}.${c.default.parentDataProperty}`),T.var(c.default.rootData,(0,a._)`${c.default.valCxt}.${c.default.rootData}`),A.dynamicRef&&T.var(c.default.dynamicAnchors,(0,a._)`${c.default.valCxt}.${c.default.dynamicAnchors}`)},()=>{T.var(c.default.instancePath,(0,a._)`""`),T.var(c.default.parentData,(0,a._)`undefined`),T.var(c.default.parentDataProperty,(0,a._)`undefined`),T.var(c.default.rootData,c.default.data),A.dynamicRef&&T.var(c.default.dynamicAnchors,(0,a._)`{}`)})}function h(T){const{schema:A,opts:j,gen:D}=T;w(T,()=>{j.$comment&&A.$comment&&F(T),z(T),D.let(c.default.vErrors,null),D.let(c.default.errors,0),j.unevaluated&&p(T),x(T),X(T)})}function p(T){const{gen:A,validateName:j}=T;T.evaluated=A.const("evaluated",(0,a._)`${j}.evaluated`),A.if((0,a._)`${T.evaluated}.dynamicProps`,()=>A.assign((0,a._)`${T.evaluated}.props`,(0,a._)`undefined`)),A.if((0,a._)`${T.evaluated}.dynamicItems`,()=>A.assign((0,a._)`${T.evaluated}.items`,(0,a._)`undefined`))}function u(T,A){const j=typeof T=="object"&&T[A.schemaId];return j&&(A.code.source||A.code.process)?(0,a._)`/*# sourceURL=${j} */`:a.nil}function f(T,A){if($(T)&&(S(T),y(T))){b(T,A);return}(0,s.boolOrEmptySchema)(T,A)}function y({schema:T,self:A}){if(typeof T=="boolean")return!T;for(const j in T)if(A.RULES.all[j])return!0;return!1}function $(T){return typeof T.schema!="boolean"}function b(T,A){const{schema:j,gen:D,opts:B}=T;B.$comment&&j.$comment&&F(T),q(T),L(T);const Q=D.const("_errs",c.default.errors);x(T,Q),D.var(A,(0,a._)`${Q} === ${c.default.errors}`)}function S(T){(0,d.checkUnknownRules)(T),N(T)}function x(T,A){if(T.opts.jtd)return Se(T,[],!1,A);const j=(0,e.getSchemaTypes)(T.schema),D=(0,e.coerceAndCheckDataType)(T,j);Se(T,j,!D,A)}function N(T){const{schema:A,errSchemaPath:j,opts:D,self:B}=T;A.$ref&&D.ignoreKeywordsWithRef&&(0,d.schemaHasRulesButRef)(A,B.RULES)&&B.logger.warn(`$ref: keywords ignored in schema at path "${j}"`)}function z(T){const{schema:A,opts:j}=T;A.default!==void 0&&j.useDefaults&&j.strictSchema&&(0,d.checkStrictMode)(T,"default is ignored in the schema root")}function q(T){const A=T.schema[T.opts.schemaId];A&&(T.baseId=(0,l.resolveUrl)(T.opts.uriResolver,T.baseId,A))}function L(T){if(T.schema.$async&&!T.schemaEnv.$async)throw new Error("async schema in sync schema")}function F({gen:T,schemaEnv:A,schema:j,errSchemaPath:D,opts:B}){const Q=j.$comment;if(B.$comment===!0)T.code((0,a._)`${c.default.self}.logger.log(${Q})`);else if(typeof B.$comment=="function"){const le=(0,a.str)`${D}/$comment`,Te=T.scopeValue("root",{ref:A.root});T.code((0,a._)`${c.default.self}.opts.$comment(${Q}, ${le}, ${Te}.schema)`)}}function X(T){const{gen:A,schemaEnv:j,validateName:D,ValidationError:B,opts:Q}=T;j.$async?A.if((0,a._)`${c.default.errors} === 0`,()=>A.return(c.default.data),()=>A.throw((0,a._)`new ${B}(${c.default.vErrors})`)):(A.assign((0,a._)`${D}.errors`,c.default.vErrors),Q.unevaluated&&oe(T),A.return((0,a._)`${c.default.errors} === 0`))}function oe({gen:T,evaluated:A,props:j,items:D}){j instanceof a.Name&&T.assign((0,a._)`${A}.props`,j),D instanceof a.Name&&T.assign((0,a._)`${A}.items`,D)}function Se(T,A,j,D){const{gen:B,schema:Q,data:le,allErrors:Te,opts:fe,self:be}=T,{RULES:pe}=be;if(Q.$ref&&(fe.ignoreKeywordsWithRef||!(0,d.schemaHasRulesButRef)(Q,pe))){B.block(()=>V(T,"$ref",pe.all.$ref.definition));return}fe.jtd||ne(T,A),B.block(()=>{for(const Ee of pe.rules)ze(Ee);ze(pe.post)});function ze(Ee){(0,t.shouldUseGroup)(Q,Ee)&&(Ee.type?(B.if((0,r.checkDataType)(Ee.type,le,fe.strictNumbers)),ye(T,Ee),A.length===1&&A[0]===Ee.type&&j&&(B.else(),(0,r.reportTypeError)(T)),B.endIf()):ye(T,Ee),Te||B.if((0,a._)`${c.default.errors} === ${D||0}`))}}function ye(T,A){const{gen:j,schema:D,opts:{useDefaults:B}}=T;B&&(0,n.assignDefaults)(T,A.type),j.block(()=>{for(const Q of A.rules)(0,t.shouldUseRule)(D,Q)&&V(T,Q.keyword,Q.definition,A.type)})}function ne(T,A){T.schemaEnv.meta||!T.opts.strictTypes||(de(T,A),T.opts.allowUnionTypes||I(T,A),k(T,T.dataTypes))}function de(T,A){if(A.length){if(!T.dataTypes.length){T.dataTypes=A;return}A.forEach(j=>{R(T.dataTypes,j)||E(T,`type "${j}" not allowed by context "${T.dataTypes.join(",")}"`)}),_(T,A)}}function I(T,A){A.length>1&&!(A.length===2&&A.includes("null"))&&E(T,"use allowUnionTypes to allow union type keyword")}function k(T,A){const j=T.self.RULES.all;for(const D in j){const B=j[D];if(typeof B=="object"&&(0,t.shouldUseRule)(T.schema,B)){const{type:Q}=B.definition;Q.length&&!Q.some(le=>O(A,le))&&E(T,`missing type "${Q.join(",")}" for keyword "${D}"`)}}}function O(T,A){return T.includes(A)||A==="number"&&T.includes("integer")}function R(T,A){return T.includes(A)||A==="integer"&&T.includes("number")}function _(T,A){const j=[];for(const D of T.dataTypes)R(A,D)?j.push(D):A.includes("integer")&&D==="number"&&j.push("integer");T.dataTypes=j}function E(T,A){const j=T.schemaEnv.baseId+T.errSchemaPath;A+=` at "${j}" (strictTypes)`,(0,d.checkStrictMode)(T,A,T.opts.strictTypes)}class C{constructor(A,j,D){if((0,i.validateKeywordUsage)(A,j,D),this.gen=A.gen,this.allErrors=A.allErrors,this.keyword=D,this.data=A.data,this.schema=A.schema[D],this.$data=j.$data&&A.opts.$data&&this.schema&&this.schema.$data,this.schemaValue=(0,d.schemaRefOrVal)(A,this.schema,D,this.$data),this.schemaType=j.schemaType,this.parentSchema=A.schema,this.params={},this.it=A,this.def=j,this.$data)this.schemaCode=A.gen.const("vSchema",W(this.$data,A));else if(this.schemaCode=this.schemaValue,!(0,i.validSchemaType)(this.schema,j.schemaType,j.allowUndefined))throw new Error(`${D} value must be ${JSON.stringify(j.schemaType)}`);("code"in j?j.trackErrors:j.errors!==!1)&&(this.errsCount=A.gen.const("_errs",c.default.errors))}result(A,j,D){this.failResult((0,a.not)(A),j,D)}failResult(A,j,D){this.gen.if(A),D?D():this.error(),j?(this.gen.else(),j(),this.allErrors&&this.gen.endIf()):this.allErrors?this.gen.endIf():this.gen.else()}pass(A,j){this.failResult((0,a.not)(A),void 0,j)}fail(A){if(A===void 0){this.error(),this.allErrors||this.gen.if(!1);return}this.gen.if(A),this.error(),this.allErrors?this.gen.endIf():this.gen.else()}fail$data(A){if(!this.$data)return this.fail(A);const{schemaCode:j}=this;this.fail((0,a._)`${j} !== undefined && (${(0,a.or)(this.invalid$data(),A)})`)}error(A,j,D){if(j){this.setParams(j),this._error(A,D),this.setParams({});return}this._error(A,D)}_error(A,j){(A?m.reportExtraError:m.reportError)(this,this.def.error,j)}$dataError(){(0,m.reportError)(this,this.def.$dataError||m.keyword$DataError)}reset(){if(this.errsCount===void 0)throw new Error('add "trackErrors" to keyword definition');(0,m.resetErrorsCount)(this.gen,this.errsCount)}ok(A){this.allErrors||this.gen.if(A)}setParams(A,j){j?Object.assign(this.params,A):this.params=A}block$data(A,j,D=a.nil){this.gen.block(()=>{this.check$data(A,D),j()})}check$data(A=a.nil,j=a.nil){if(!this.$data)return;const{gen:D,schemaCode:B,schemaType:Q,def:le}=this;D.if((0,a.or)((0,a._)`${B} === undefined`,j)),A!==a.nil&&D.assign(A,!0),(Q.length||le.validateSchema)&&(D.elseIf(this.invalid$data()),this.$dataError(),A!==a.nil&&D.assign(A,!1)),D.else()}invalid$data(){const{gen:A,schemaCode:j,schemaType:D,def:B,it:Q}=this;return(0,a.or)(le(),Te());function le(){if(D.length){if(!(j instanceof a.Name))throw new Error("ajv implementation error");const fe=Array.isArray(D)?D:[D];return(0,a._)`${(0,r.checkDataTypes)(fe,j,Q.opts.strictNumbers,r.DataType.Wrong)}`}return a.nil}function Te(){if(B.validateSchema){const fe=A.scopeValue("validate$data",{ref:B.validateSchema});return(0,a._)`!${fe}(${j})`}return a.nil}}subschema(A,j){const D=(0,o.getSubschema)(this.it,A);(0,o.extendSubschemaData)(D,this.it,A),(0,o.extendSubschemaMode)(D,A);const B={...this.it,...D,items:void 0,props:void 0};return f(B,j),B}mergeEvaluated(A,j){const{it:D,gen:B}=this;D.opts.unevaluated&&(D.props!==!0&&A.props!==void 0&&(D.props=d.mergeEvaluated.props(B,A.props,D.props,j)),D.items!==!0&&A.items!==void 0&&(D.items=d.mergeEvaluated.items(B,A.items,D.items,j)))}mergeValidEvaluated(A,j){const{it:D,gen:B}=this;if(D.opts.unevaluated&&(D.props!==!0||D.items!==!0))return B.if(j,()=>this.mergeEvaluated(A,a.Name)),!0}}Ie.KeywordCxt=C;function V(T,A,j,D){const B=new C(T,j,A);"code"in j?j.code(B,D):B.$data&&j.validate?(0,i.funcKeywordCode)(B,j):"macro"in j?(0,i.macroKeywordCode)(B,j):(j.compile||j.validate)&&(0,i.funcKeywordCode)(B,j)}const M=/^\/(?:[^~]|~0|~1)*$/,J=/^([0-9]+)(#|\/(?:[^~]|~0|~1)*)?$/;function W(T,{dataLevel:A,dataNames:j,dataPathArr:D}){let B,Q;if(T==="")return c.default.rootData;if(T[0]==="/"){if(!M.test(T))throw new Error(`Invalid JSON-pointer: ${T}`);B=T,Q=c.default.rootData}else{const be=J.exec(T);if(!be)throw new Error(`Invalid JSON-pointer: ${T}`);const pe=+be[1];if(B=be[2],B==="#"){if(pe>=A)throw new Error(fe("property/index",pe));return D[A-pe]}if(pe>A)throw new Error(fe("data",pe));if(Q=j[A-pe],!B)return Q}let le=Q;const Te=B.split("/");for(const be of Te)be&&(Q=(0,a._)`${Q}${(0,a.getProperty)((0,d.unescapeJsonPointer)(be))}`,le=(0,a._)`${le} && ${Q}`);return le;function fe(be,pe){return`Cannot access ${be} ${pe} levels up, current level is ${A}`}}return Ie.getData=W,Ie}var bt={},ln;function mr(){if(ln)return bt;ln=1,Object.defineProperty(bt,"__esModule",{value:!0});class s extends Error{constructor(t){super("validation failed"),this.errors=t,this.ajv=this.validation=!0}}return bt.default=s,bt}var vt={},un;function wt(){if(un)return vt;un=1,Object.defineProperty(vt,"__esModule",{value:!0});const s=gt();class e extends Error{constructor(r,n,i,o){super(o||`can't resolve reference ${i} from id ${n}`),this.missingRef=(0,s.resolveUrl)(r,n,i),this.missingSchema=(0,s.normalizeId)((0,s.getFullPath)(r,this.missingRef))}}return vt.default=e,vt}var xe={},dn;function gr(){if(dn)return xe;dn=1,Object.defineProperty(xe,"__esModule",{value:!0}),xe.resolveSchema=xe.getCompilingSchema=xe.resolveRef=xe.compileSchema=xe.SchemaEnv=void 0;const s=te(),e=mr(),t=Ve(),r=gt(),n=ie(),i=yt();class o{constructor(p){var u;this.refs={},this.dynamicAnchors={};let f;typeof p.schema=="object"&&(f=p.schema),this.schema=p.schema,this.schemaId=p.schemaId,this.root=p.root||this,this.baseId=(u=p.baseId)!==null&&u!==void 0?u:(0,r.normalizeId)(f?.[p.schemaId||"$id"]),this.schemaPath=p.schemaPath,this.localRefs=p.localRefs,this.meta=p.meta,this.$async=f?.$async,this.refs={}}}xe.SchemaEnv=o;function a(h){const p=d.call(this,h);if(p)return p;const u=(0,r.getFullPath)(this.opts.uriResolver,h.root.baseId),{es5:f,lines:y}=this.opts.code,{ownProperties:$}=this.opts,b=new s.CodeGen(this.scope,{es5:f,lines:y,ownProperties:$});let S;h.$async&&(S=b.scopeValue("Error",{ref:e.default,code:(0,s._)`require("ajv/dist/runtime/validation_error").default`}));const x=b.scopeName("validate");h.validateName=x;const N={gen:b,allErrors:this.opts.allErrors,data:t.default.data,parentData:t.default.parentData,parentDataProperty:t.default.parentDataProperty,dataNames:[t.default.data],dataPathArr:[s.nil],dataLevel:0,dataTypes:[],definedProperties:new Set,topSchemaRef:b.scopeValue("schema",this.opts.code.source===!0?{ref:h.schema,code:(0,s.stringify)(h.schema)}:{ref:h.schema}),validateName:x,ValidationError:S,schema:h.schema,schemaEnv:h,rootId:u,baseId:h.baseId||u,schemaPath:s.nil,errSchemaPath:h.schemaPath||(this.opts.jtd?"":"#"),errorPath:(0,s._)`""`,opts:this.opts,self:this};let z;try{this._compilations.add(h),(0,i.validateFunctionCode)(N),b.optimize(this.opts.code.optimize);const q=b.toString();z=`${b.scopeRefs(t.default.scope)}return ${q}`,this.opts.code.process&&(z=this.opts.code.process(z,h));const F=new Function(`${t.default.self}`,`${t.default.scope}`,z)(this,this.scope.get());if(this.scope.value(x,{ref:F}),F.errors=null,F.schema=h.schema,F.schemaEnv=h,h.$async&&(F.$async=!0),this.opts.code.source===!0&&(F.source={validateName:x,validateCode:q,scopeValues:b._values}),this.opts.unevaluated){const{props:X,items:oe}=N;F.evaluated={props:X instanceof s.Name?void 0:X,items:oe instanceof s.Name?void 0:oe,dynamicProps:X instanceof s.Name,dynamicItems:oe instanceof s.Name},F.source&&(F.source.evaluated=(0,s.stringify)(F.evaluated))}return h.validate=F,h}catch(q){throw delete h.validate,delete h.validateName,z&&this.logger.error("Error compiling schema, function code:",z),q}finally{this._compilations.delete(h)}}xe.compileSchema=a;function c(h,p,u){var f;u=(0,r.resolveUrl)(this.opts.uriResolver,p,u);const y=h.refs[u];if(y)return y;let $=v.call(this,h,u);if($===void 0){const b=(f=h.localRefs)===null||f===void 0?void 0:f[u],{schemaId:S}=this.opts;b&&($=new o({schema:b,schemaId:S,root:h,baseId:p}))}if($!==void 0)return h.refs[u]=l.call(this,$)}xe.resolveRef=c;function l(h){return(0,r.inlineRef)(h.schema,this.opts.inlineRefs)?h.schema:h.validate?h:a.call(this,h)}function d(h){for(const p of this._compilations)if(m(p,h))return p}xe.getCompilingSchema=d;function m(h,p){return h.schema===p.schema&&h.root===p.root&&h.baseId===p.baseId}function v(h,p){let u;for(;typeof(u=this.refs[p])=="string";)p=u;return u||this.schemas[p]||w.call(this,h,p)}function w(h,p){const u=this.opts.uriResolver.parse(p),f=(0,r._getFullPath)(this.opts.uriResolver,u);let y=(0,r.getFullPath)(this.opts.uriResolver,h.baseId,void 0);if(Object.keys(h.schema).length>0&&f===y)return g.call(this,u,h);const $=(0,r.normalizeId)(f),b=this.refs[$]||this.schemas[$];if(typeof b=="string"){const S=w.call(this,h,b);return typeof S?.schema!="object"?void 0:g.call(this,u,S)}if(typeof b?.schema=="object"){if(b.validate||a.call(this,b),$===(0,r.normalizeId)(p)){const{schema:S}=b,{schemaId:x}=this.opts,N=S[x];return N&&(y=(0,r.resolveUrl)(this.opts.uriResolver,y,N)),new o({schema:S,schemaId:x,root:h,baseId:y})}return g.call(this,u,b)}}xe.resolveSchema=w;const P=new Set(["properties","patternProperties","enum","dependencies","definitions"]);function g(h,{baseId:p,schema:u,root:f}){var y;if(((y=h.fragment)===null||y===void 0?void 0:y[0])!=="/")return;for(const S of h.fragment.slice(1).split("/")){if(typeof u=="boolean")return;const x=u[(0,n.unescapeFragment)(S)];if(x===void 0)return;u=x;const N=typeof u=="object"&&u[this.opts.schemaId];!P.has(S)&&N&&(p=(0,r.resolveUrl)(this.opts.uriResolver,p,N))}let $;if(typeof u!="boolean"&&u.$ref&&!(0,n.schemaHasRulesButRef)(u,this.RULES)){const S=(0,r.resolveUrl)(this.opts.uriResolver,p,u.$ref);$=w.call(this,f,S)}const{schemaId:b}=this.opts;if($=$||new o({schema:u,schemaId:b,root:f,baseId:p}),$.schema!==$.root.schema)return $}return xe}const Fi={$id:"https://raw.githubusercontent.com/ajv-validator/ajv/master/lib/refs/data.json#",description:"Meta-schema for $data reference (JSON AnySchema extension proposal)",type:"object",required:["$data"],properties:{$data:{type:"string",anyOf:[{format:"relative-json-pointer"},{format:"json-pointer"}]}},additionalProperties:!1};var _t={},it={exports:{}},yr,hn;function Gi(){return hn||(hn=1,yr={HEX:{0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,a:10,A:10,b:11,B:11,c:12,C:12,d:13,D:13,e:14,E:14,f:15,F:15}}),yr}var br,fn;function Bi(){if(fn)return br;fn=1;const{HEX:s}=Gi(),e=/^(?:(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]\d|\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]\d|\d)$/u;function t(g){if(a(g,".")<3)return{host:g,isIPV4:!1};const h=g.match(e)||[],[p]=h;return p?{host:o(p,"."),isIPV4:!0}:{host:g,isIPV4:!1}}function r(g,h=!1){let p="",u=!0;for(const f of g){if(s[f]===void 0)return;f!=="0"&&u===!0&&(u=!1),u||(p+=f)}return h&&p.length===0&&(p="0"),p}function n(g){let h=0;const p={error:!1,address:"",zone:""},u=[],f=[];let y=!1,$=!1,b=!1;function S(){if(f.length){if(y===!1){const x=r(f);if(x!==void 0)u.push(x);else return p.error=!0,!1}f.length=0}return!0}for(let x=0;x<g.length;x++){const N=g[x];if(!(N==="["||N==="]"))if(N===":"){if($===!0&&(b=!0),!S())break;if(h++,u.push(":"),h>7){p.error=!0;break}x-1>=0&&g[x-1]===":"&&($=!0);continue}else if(N==="%"){if(!S())break;y=!0}else{f.push(N);continue}}return f.length&&(y?p.zone=f.join(""):b?u.push(f.join("")):u.push(r(f))),p.address=u.join(""),p}function i(g){if(a(g,":")<2)return{host:g,isIPV6:!1};const h=n(g);if(h.error)return{host:g,isIPV6:!1};{let p=h.address,u=h.address;return h.zone&&(p+="%"+h.zone,u+="%25"+h.zone),{host:p,escapedHost:u,isIPV6:!0}}}function o(g,h){let p="",u=!0;const f=g.length;for(let y=0;y<f;y++){const $=g[y];$==="0"&&u?(y+1<=f&&g[y+1]===h||y+1===f)&&(p+=$,u=!1):($===h?u=!0:u=!1,p+=$)}return p}function a(g,h){let p=0;for(let u=0;u<g.length;u++)g[u]===h&&p++;return p}const c=/^\.\.?\//u,l=/^\/\.(?:\/|$)/u,d=/^\/\.\.(?:\/|$)/u,m=/^\/?(?:.|\n)*?(?=\/|$)/u;function v(g){const h=[];for(;g.length;)if(g.match(c))g=g.replace(c,"");else if(g.match(l))g=g.replace(l,"/");else if(g.match(d))g=g.replace(d,"/"),h.pop();else if(g==="."||g==="..")g="";else{const p=g.match(m);if(p){const u=p[0];g=g.slice(u.length),h.push(u)}else throw new Error("Unexpected dot segment condition")}return h.join("")}function w(g,h){const p=h!==!0?escape:unescape;return g.scheme!==void 0&&(g.scheme=p(g.scheme)),g.userinfo!==void 0&&(g.userinfo=p(g.userinfo)),g.host!==void 0&&(g.host=p(g.host)),g.path!==void 0&&(g.path=p(g.path)),g.query!==void 0&&(g.query=p(g.query)),g.fragment!==void 0&&(g.fragment=p(g.fragment)),g}function P(g){const h=[];if(g.userinfo!==void 0&&(h.push(g.userinfo),h.push("@")),g.host!==void 0){let p=unescape(g.host);const u=t(p);if(u.isIPV4)p=u.host;else{const f=i(u.host);f.isIPV6===!0?p=`[${f.escapedHost}]`:p=g.host}h.push(p)}return(typeof g.port=="number"||typeof g.port=="string")&&(h.push(":"),h.push(String(g.port))),h.length?h.join(""):void 0}return br={recomposeAuthority:P,normalizeComponentEncoding:w,removeDotSegments:v,normalizeIPv4:t,normalizeIPv6:i,stringArrayToHexStripped:r},br}var vr,pn;function Ui(){if(pn)return vr;pn=1;const s=/^[\da-f]{8}-[\da-f]{4}-[\da-f]{4}-[\da-f]{4}-[\da-f]{12}$/iu,e=/([\da-z][\d\-a-z]{0,31}):((?:[\w!$'()*+,\-.:;=@]|%[\da-f]{2})+)/iu;function t(u){return typeof u.secure=="boolean"?u.secure:String(u.scheme).toLowerCase()==="wss"}function r(u){return u.host||(u.error=u.error||"HTTP URIs must have a host."),u}function n(u){const f=String(u.scheme).toLowerCase()==="https";return(u.port===(f?443:80)||u.port==="")&&(u.port=void 0),u.path||(u.path="/"),u}function i(u){return u.secure=t(u),u.resourceName=(u.path||"/")+(u.query?"?"+u.query:""),u.path=void 0,u.query=void 0,u}function o(u){if((u.port===(t(u)?443:80)||u.port==="")&&(u.port=void 0),typeof u.secure=="boolean"&&(u.scheme=u.secure?"wss":"ws",u.secure=void 0),u.resourceName){const[f,y]=u.resourceName.split("?");u.path=f&&f!=="/"?f:void 0,u.query=y,u.resourceName=void 0}return u.fragment=void 0,u}function a(u,f){if(!u.path)return u.error="URN can not be parsed",u;const y=u.path.match(e);if(y){const $=f.scheme||u.scheme||"urn";u.nid=y[1].toLowerCase(),u.nss=y[2];const b=`${$}:${f.nid||u.nid}`,S=p[b];u.path=void 0,S&&(u=S.parse(u,f))}else u.error=u.error||"URN can not be parsed.";return u}function c(u,f){const y=f.scheme||u.scheme||"urn",$=u.nid.toLowerCase(),b=`${y}:${f.nid||$}`,S=p[b];S&&(u=S.serialize(u,f));const x=u,N=u.nss;return x.path=`${$||f.nid}:${N}`,f.skipEscape=!0,x}function l(u,f){const y=u;return y.uuid=y.nss,y.nss=void 0,!f.tolerant&&(!y.uuid||!s.test(y.uuid))&&(y.error=y.error||"UUID is not valid."),y}function d(u){const f=u;return f.nss=(u.uuid||"").toLowerCase(),f}const m={scheme:"http",domainHost:!0,parse:r,serialize:n},v={scheme:"https",domainHost:m.domainHost,parse:r,serialize:n},w={scheme:"ws",domainHost:!0,parse:i,serialize:o},P={scheme:"wss",domainHost:w.domainHost,parse:w.parse,serialize:w.serialize},p={http:m,https:v,ws:w,wss:P,urn:{scheme:"urn",parse:a,serialize:c,skipNormalize:!0},"urn:uuid":{scheme:"urn:uuid",parse:l,serialize:d,skipNormalize:!0}};return vr=p,vr}var mn;function Ki(){if(mn)return it.exports;mn=1;const{normalizeIPv6:s,normalizeIPv4:e,removeDotSegments:t,recomposeAuthority:r,normalizeComponentEncoding:n}=Bi(),i=Ui();function o(h,p){return typeof h=="string"?h=d(P(h,p),p):typeof h=="object"&&(h=P(d(h,p),p)),h}function a(h,p,u){const f=Object.assign({scheme:"null"},u),y=c(P(h,f),P(p,f),f,!0);return d(y,{...f,skipEscape:!0})}function c(h,p,u,f){const y={};return f||(h=P(d(h,u),u),p=P(d(p,u),u)),u=u||{},!u.tolerant&&p.scheme?(y.scheme=p.scheme,y.userinfo=p.userinfo,y.host=p.host,y.port=p.port,y.path=t(p.path||""),y.query=p.query):(p.userinfo!==void 0||p.host!==void 0||p.port!==void 0?(y.userinfo=p.userinfo,y.host=p.host,y.port=p.port,y.path=t(p.path||""),y.query=p.query):(p.path?(p.path.charAt(0)==="/"?y.path=t(p.path):((h.userinfo!==void 0||h.host!==void 0||h.port!==void 0)&&!h.path?y.path="/"+p.path:h.path?y.path=h.path.slice(0,h.path.lastIndexOf("/")+1)+p.path:y.path=p.path,y.path=t(y.path)),y.query=p.query):(y.path=h.path,p.query!==void 0?y.query=p.query:y.query=h.query),y.userinfo=h.userinfo,y.host=h.host,y.port=h.port),y.scheme=h.scheme),y.fragment=p.fragment,y}function l(h,p,u){return typeof h=="string"?(h=unescape(h),h=d(n(P(h,u),!0),{...u,skipEscape:!0})):typeof h=="object"&&(h=d(n(h,!0),{...u,skipEscape:!0})),typeof p=="string"?(p=unescape(p),p=d(n(P(p,u),!0),{...u,skipEscape:!0})):typeof p=="object"&&(p=d(n(p,!0),{...u,skipEscape:!0})),h.toLowerCase()===p.toLowerCase()}function d(h,p){const u={host:h.host,scheme:h.scheme,userinfo:h.userinfo,port:h.port,path:h.path,query:h.query,nid:h.nid,nss:h.nss,uuid:h.uuid,fragment:h.fragment,reference:h.reference,resourceName:h.resourceName,secure:h.secure,error:""},f=Object.assign({},p),y=[],$=i[(f.scheme||u.scheme||"").toLowerCase()];$&&$.serialize&&$.serialize(u,f),u.path!==void 0&&(f.skipEscape?u.path=unescape(u.path):(u.path=escape(u.path),u.scheme!==void 0&&(u.path=u.path.split("%3A").join(":")))),f.reference!=="suffix"&&u.scheme&&y.push(u.scheme,":");const b=r(u);if(b!==void 0&&(f.reference!=="suffix"&&y.push("//"),y.push(b),u.path&&u.path.charAt(0)!=="/"&&y.push("/")),u.path!==void 0){let S=u.path;!f.absolutePath&&(!$||!$.absolutePath)&&(S=t(S)),b===void 0&&(S=S.replace(/^\/\//u,"/%2F")),y.push(S)}return u.query!==void 0&&y.push("?",u.query),u.fragment!==void 0&&y.push("#",u.fragment),y.join("")}const m=Array.from({length:127},(h,p)=>/[^!"$&'()*+,\-.;=_`a-z{}~]/u.test(String.fromCharCode(p)));function v(h){let p=0;for(let u=0,f=h.length;u<f;++u)if(p=h.charCodeAt(u),p>126||m[p])return!0;return!1}const w=/^(?:([^#/:?]+):)?(?:\/\/((?:([^#/?@]*)@)?(\[[^#/?\]]+\]|[^#/:?]*)(?::(\d*))?))?([^#?]*)(?:\?([^#]*))?(?:#((?:.|[\n\r])*))?/u;function P(h,p){const u=Object.assign({},p),f={scheme:void 0,userinfo:void 0,host:"",port:void 0,path:"",query:void 0,fragment:void 0},y=h.indexOf("%")!==-1;let $=!1;u.reference==="suffix"&&(h=(u.scheme?u.scheme+":":"")+"//"+h);const b=h.match(w);if(b){if(f.scheme=b[1],f.userinfo=b[3],f.host=b[4],f.port=parseInt(b[5],10),f.path=b[6]||"",f.query=b[7],f.fragment=b[8],isNaN(f.port)&&(f.port=b[5]),f.host){const x=e(f.host);if(x.isIPV4===!1){const N=s(x.host);f.host=N.host.toLowerCase(),$=N.isIPV6}else f.host=x.host,$=!0}f.scheme===void 0&&f.userinfo===void 0&&f.host===void 0&&f.port===void 0&&f.query===void 0&&!f.path?f.reference="same-document":f.scheme===void 0?f.reference="relative":f.fragment===void 0?f.reference="absolute":f.reference="uri",u.reference&&u.reference!=="suffix"&&u.reference!==f.reference&&(f.error=f.error||"URI is not a "+u.reference+" reference.");const S=i[(u.scheme||f.scheme||"").toLowerCase()];if(!u.unicodeSupport&&(!S||!S.unicodeSupport)&&f.host&&(u.domainHost||S&&S.domainHost)&&$===!1&&v(f.host))try{f.host=URL.domainToASCII(f.host.toLowerCase())}catch(x){f.error=f.error||"Host's domain name can not be converted to ASCII: "+x}(!S||S&&!S.skipNormalize)&&(y&&f.scheme!==void 0&&(f.scheme=unescape(f.scheme)),y&&f.host!==void 0&&(f.host=unescape(f.host)),f.path&&(f.path=escape(unescape(f.path))),f.fragment&&(f.fragment=encodeURI(decodeURIComponent(f.fragment)))),S&&S.parse&&S.parse(f,u)}else f.error=f.error||"URI can not be parsed.";return f}const g={SCHEMES:i,normalize:o,resolve:a,resolveComponents:c,equal:l,serialize:d,parse:P};return it.exports=g,it.exports.default=g,it.exports.fastUri=g,it.exports}var gn;function Yi(){if(gn)return _t;gn=1,Object.defineProperty(_t,"__esModule",{value:!0});const s=Ki();return s.code='require("ajv/dist/runtime/uri").default',_t.default=s,_t}var yn;function Hi(){return yn||(yn=1,(function(s){Object.defineProperty(s,"__esModule",{value:!0}),s.CodeGen=s.Name=s.nil=s.stringify=s.str=s._=s.KeywordCxt=void 0;var e=yt();Object.defineProperty(s,"KeywordCxt",{enumerable:!0,get:function(){return e.KeywordCxt}});var t=te();Object.defineProperty(s,"_",{enumerable:!0,get:function(){return t._}}),Object.defineProperty(s,"str",{enumerable:!0,get:function(){return t.str}}),Object.defineProperty(s,"stringify",{enumerable:!0,get:function(){return t.stringify}}),Object.defineProperty(s,"nil",{enumerable:!0,get:function(){return t.nil}}),Object.defineProperty(s,"Name",{enumerable:!0,get:function(){return t.Name}}),Object.defineProperty(s,"CodeGen",{enumerable:!0,get:function(){return t.CodeGen}});const r=mr(),n=wt(),i=Jr(),o=gr(),a=te(),c=gt(),l=mt(),d=ie(),m=Fi,v=Yi(),w=(I,k)=>new RegExp(I,k);w.code="new RegExp";const P=["removeAdditional","useDefaults","coerceTypes"],g=new Set(["validate","serialize","parse","wrapper","root","schema","keyword","pattern","formats","validate$data","func","obj","Error"]),h={errorDataPath:"",format:"`validateFormats: false` can be used instead.",nullable:'"nullable" keyword is supported by default.',jsonPointers:"Deprecated jsPropertySyntax can be used instead.",extendRefs:"Deprecated ignoreKeywordsWithRef can be used instead.",missingRefs:"Pass empty schema with $id that should be ignored to ajv.addSchema.",processCode:"Use option `code: {process: (code, schemaEnv: object) => string}`",sourceCode:"Use option `code: {source: true}`",strictDefaults:"It is default now, see option `strict`.",strictKeywords:"It is default now, see option `strict`.",uniqueItems:'"uniqueItems" keyword is always validated.',unknownFormats:"Disable strict mode or pass `true` to `ajv.addFormat` (or `formats` option).",cache:"Map is used as cache, schema object as key.",serialize:"Map is used as cache, schema object as key.",ajvErrors:"It is default now."},p={ignoreKeywordsWithRef:"",jsPropertySyntax:"",unicode:'"minLength"/"maxLength" account for unicode characters by default.'},u=200;function f(I){var k,O,R,_,E,C,V,M,J,W,T,A,j,D,B,Q,le,Te,fe,be,pe,ze,Ee,et,tt;const G=I.strict,U=(k=I.code)===null||k===void 0?void 0:k.optimize,K=U===!0||U===void 0?1:U||0,H=(R=(O=I.code)===null||O===void 0?void 0:O.regExp)!==null&&R!==void 0?R:w,re=(_=I.uriResolver)!==null&&_!==void 0?_:v.default;return{strictSchema:(C=(E=I.strictSchema)!==null&&E!==void 0?E:G)!==null&&C!==void 0?C:!0,strictNumbers:(M=(V=I.strictNumbers)!==null&&V!==void 0?V:G)!==null&&M!==void 0?M:!0,strictTypes:(W=(J=I.strictTypes)!==null&&J!==void 0?J:G)!==null&&W!==void 0?W:"log",strictTuples:(A=(T=I.strictTuples)!==null&&T!==void 0?T:G)!==null&&A!==void 0?A:"log",strictRequired:(D=(j=I.strictRequired)!==null&&j!==void 0?j:G)!==null&&D!==void 0?D:!1,code:I.code?{...I.code,optimize:K,regExp:H}:{optimize:K,regExp:H},loopRequired:(B=I.loopRequired)!==null&&B!==void 0?B:u,loopEnum:(Q=I.loopEnum)!==null&&Q!==void 0?Q:u,meta:(le=I.meta)!==null&&le!==void 0?le:!0,messages:(Te=I.messages)!==null&&Te!==void 0?Te:!0,inlineRefs:(fe=I.inlineRefs)!==null&&fe!==void 0?fe:!0,schemaId:(be=I.schemaId)!==null&&be!==void 0?be:"$id",addUsedSchema:(pe=I.addUsedSchema)!==null&&pe!==void 0?pe:!0,validateSchema:(ze=I.validateSchema)!==null&&ze!==void 0?ze:!0,validateFormats:(Ee=I.validateFormats)!==null&&Ee!==void 0?Ee:!0,unicodeRegExp:(et=I.unicodeRegExp)!==null&&et!==void 0?et:!0,int32range:(tt=I.int32range)!==null&&tt!==void 0?tt:!0,uriResolver:re}}class y{constructor(k={}){this.schemas={},this.refs={},this.formats={},this._compilations=new Set,this._loading={},this._cache=new Map,k=this.opts={...k,...f(k)};const{es5:O,lines:R}=this.opts.code;this.scope=new a.ValueScope({scope:{},prefixes:g,es5:O,lines:R}),this.logger=L(k.logger);const _=k.validateFormats;k.validateFormats=!1,this.RULES=(0,i.getRules)(),$.call(this,h,k,"NOT SUPPORTED"),$.call(this,p,k,"DEPRECATED","warn"),this._metaOpts=z.call(this),k.formats&&x.call(this),this._addVocabularies(),this._addDefaultMetaSchema(),k.keywords&&N.call(this,k.keywords),typeof k.meta=="object"&&this.addMetaSchema(k.meta),S.call(this),k.validateFormats=_}_addVocabularies(){this.addKeyword("$async")}_addDefaultMetaSchema(){const{$data:k,meta:O,schemaId:R}=this.opts;let _=m;R==="id"&&(_={...m},_.id=_.$id,delete _.$id),O&&k&&this.addMetaSchema(_,_[R],!1)}defaultMeta(){const{meta:k,schemaId:O}=this.opts;return this.opts.defaultMeta=typeof k=="object"?k[O]||k:void 0}validate(k,O){let R;if(typeof k=="string"){if(R=this.getSchema(k),!R)throw new Error(`no schema with key or ref "${k}"`)}else R=this.compile(k);const _=R(O);return"$async"in R||(this.errors=R.errors),_}compile(k,O){const R=this._addSchema(k,O);return R.validate||this._compileSchemaEnv(R)}compileAsync(k,O){if(typeof this.opts.loadSchema!="function")throw new Error("options.loadSchema should be a function");const{loadSchema:R}=this.opts;return _.call(this,k,O);async function _(W,T){await E.call(this,W.$schema);const A=this._addSchema(W,T);return A.validate||C.call(this,A)}async function E(W){W&&!this.getSchema(W)&&await _.call(this,{$ref:W},!0)}async function C(W){try{return this._compileSchemaEnv(W)}catch(T){if(!(T instanceof n.default))throw T;return V.call(this,T),await M.call(this,T.missingSchema),C.call(this,W)}}function V({missingSchema:W,missingRef:T}){if(this.refs[W])throw new Error(`AnySchema ${W} is loaded but ${T} cannot be resolved`)}async function M(W){const T=await J.call(this,W);this.refs[W]||await E.call(this,T.$schema),this.refs[W]||this.addSchema(T,W,O)}async function J(W){const T=this._loading[W];if(T)return T;try{return await(this._loading[W]=R(W))}finally{delete this._loading[W]}}}addSchema(k,O,R,_=this.opts.validateSchema){if(Array.isArray(k)){for(const C of k)this.addSchema(C,void 0,R,_);return this}let E;if(typeof k=="object"){const{schemaId:C}=this.opts;if(E=k[C],E!==void 0&&typeof E!="string")throw new Error(`schema ${C} must be string`)}return O=(0,c.normalizeId)(O||E),this._checkUnique(O),this.schemas[O]=this._addSchema(k,R,O,_,!0),this}addMetaSchema(k,O,R=this.opts.validateSchema){return this.addSchema(k,O,!0,R),this}validateSchema(k,O){if(typeof k=="boolean")return!0;let R;if(R=k.$schema,R!==void 0&&typeof R!="string")throw new Error("$schema must be a string");if(R=R||this.opts.defaultMeta||this.defaultMeta(),!R)return this.logger.warn("meta-schema not available"),this.errors=null,!0;const _=this.validate(R,k);if(!_&&O){const E="schema is invalid: "+this.errorsText();if(this.opts.validateSchema==="log")this.logger.error(E);else throw new Error(E)}return _}getSchema(k){let O;for(;typeof(O=b.call(this,k))=="string";)k=O;if(O===void 0){const{schemaId:R}=this.opts,_=new o.SchemaEnv({schema:{},schemaId:R});if(O=o.resolveSchema.call(this,_,k),!O)return;this.refs[k]=O}return O.validate||this._compileSchemaEnv(O)}removeSchema(k){if(k instanceof RegExp)return this._removeAllSchemas(this.schemas,k),this._removeAllSchemas(this.refs,k),this;switch(typeof k){case"undefined":return this._removeAllSchemas(this.schemas),this._removeAllSchemas(this.refs),this._cache.clear(),this;case"string":{const O=b.call(this,k);return typeof O=="object"&&this._cache.delete(O.schema),delete this.schemas[k],delete this.refs[k],this}case"object":{const O=k;this._cache.delete(O);let R=k[this.opts.schemaId];return R&&(R=(0,c.normalizeId)(R),delete this.schemas[R],delete this.refs[R]),this}default:throw new Error("ajv.removeSchema: invalid parameter")}}addVocabulary(k){for(const O of k)this.addKeyword(O);return this}addKeyword(k,O){let R;if(typeof k=="string")R=k,typeof O=="object"&&(this.logger.warn("these parameters are deprecated, see docs for addKeyword"),O.keyword=R);else if(typeof k=="object"&&O===void 0){if(O=k,R=O.keyword,Array.isArray(R)&&!R.length)throw new Error("addKeywords: keyword must be string or non-empty array")}else throw new Error("invalid addKeywords parameters");if(X.call(this,R,O),!O)return(0,d.eachItem)(R,E=>oe.call(this,E)),this;ye.call(this,O);const _={...O,type:(0,l.getJSONTypes)(O.type),schemaType:(0,l.getJSONTypes)(O.schemaType)};return(0,d.eachItem)(R,_.type.length===0?E=>oe.call(this,E,_):E=>_.type.forEach(C=>oe.call(this,E,_,C))),this}getKeyword(k){const O=this.RULES.all[k];return typeof O=="object"?O.definition:!!O}removeKeyword(k){const{RULES:O}=this;delete O.keywords[k],delete O.all[k];for(const R of O.rules){const _=R.rules.findIndex(E=>E.keyword===k);_>=0&&R.rules.splice(_,1)}return this}addFormat(k,O){return typeof O=="string"&&(O=new RegExp(O)),this.formats[k]=O,this}errorsText(k=this.errors,{separator:O=", ",dataVar:R="data"}={}){return!k||k.length===0?"No errors":k.map(_=>`${R}${_.instancePath} ${_.message}`).reduce((_,E)=>_+O+E)}$dataMetaSchema(k,O){const R=this.RULES.all;k=JSON.parse(JSON.stringify(k));for(const _ of O){const E=_.split("/").slice(1);let C=k;for(const V of E)C=C[V];for(const V in R){const M=R[V];if(typeof M!="object")continue;const{$data:J}=M.definition,W=C[V];J&&W&&(C[V]=de(W))}}return k}_removeAllSchemas(k,O){for(const R in k){const _=k[R];(!O||O.test(R))&&(typeof _=="string"?delete k[R]:_&&!_.meta&&(this._cache.delete(_.schema),delete k[R]))}}_addSchema(k,O,R,_=this.opts.validateSchema,E=this.opts.addUsedSchema){let C;const{schemaId:V}=this.opts;if(typeof k=="object")C=k[V];else{if(this.opts.jtd)throw new Error("schema must be object");if(typeof k!="boolean")throw new Error("schema must be object or boolean")}let M=this._cache.get(k);if(M!==void 0)return M;R=(0,c.normalizeId)(C||R);const J=c.getSchemaRefs.call(this,k,R);return M=new o.SchemaEnv({schema:k,schemaId:V,meta:O,baseId:R,localRefs:J}),this._cache.set(M.schema,M),E&&!R.startsWith("#")&&(R&&this._checkUnique(R),this.refs[R]=M),_&&this.validateSchema(k,!0),M}_checkUnique(k){if(this.schemas[k]||this.refs[k])throw new Error(`schema with key or id "${k}" already exists`)}_compileSchemaEnv(k){if(k.meta?this._compileMetaSchema(k):o.compileSchema.call(this,k),!k.validate)throw new Error("ajv implementation error");return k.validate}_compileMetaSchema(k){const O=this.opts;this.opts=this._metaOpts;try{o.compileSchema.call(this,k)}finally{this.opts=O}}}y.ValidationError=r.default,y.MissingRefError=n.default,s.default=y;function $(I,k,O,R="error"){for(const _ in I){const E=_;E in k&&this.logger[R](`${O}: option ${_}. ${I[E]}`)}}function b(I){return I=(0,c.normalizeId)(I),this.schemas[I]||this.refs[I]}function S(){const I=this.opts.schemas;if(I)if(Array.isArray(I))this.addSchema(I);else for(const k in I)this.addSchema(I[k],k)}function x(){for(const I in this.opts.formats){const k=this.opts.formats[I];k&&this.addFormat(I,k)}}function N(I){if(Array.isArray(I)){this.addVocabulary(I);return}this.logger.warn("keywords option as map is deprecated, pass array");for(const k in I){const O=I[k];O.keyword||(O.keyword=k),this.addKeyword(O)}}function z(){const I={...this.opts};for(const k of P)delete I[k];return I}const q={log(){},warn(){},error(){}};function L(I){if(I===!1)return q;if(I===void 0)return console;if(I.log&&I.warn&&I.error)return I;throw new Error("logger must implement log, warn and error methods")}const F=/^[a-z_$][a-z0-9_$:-]*$/i;function X(I,k){const{RULES:O}=this;if((0,d.eachItem)(I,R=>{if(O.keywords[R])throw new Error(`Keyword ${R} is already defined`);if(!F.test(R))throw new Error(`Keyword ${R} has invalid name`)}),!!k&&k.$data&&!("code"in k||"validate"in k))throw new Error('$data keyword must have "code" or "validate" function')}function oe(I,k,O){var R;const _=k?.post;if(O&&_)throw new Error('keyword with "post" flag cannot have "type"');const{RULES:E}=this;let C=_?E.post:E.rules.find(({type:M})=>M===O);if(C||(C={type:O,rules:[]},E.rules.push(C)),E.keywords[I]=!0,!k)return;const V={keyword:I,definition:{...k,type:(0,l.getJSONTypes)(k.type),schemaType:(0,l.getJSONTypes)(k.schemaType)}};k.before?Se.call(this,C,V,k.before):C.rules.push(V),E.all[I]=V,(R=k.implements)===null||R===void 0||R.forEach(M=>this.addKeyword(M))}function Se(I,k,O){const R=I.rules.findIndex(_=>_.keyword===O);R>=0?I.rules.splice(R,0,k):(I.rules.push(k),this.logger.warn(`rule ${O} is not defined`))}function ye(I){let{metaSchema:k}=I;k!==void 0&&(I.$data&&this.opts.$data&&(k=de(k)),I.validateSchema=this.compile(k,!0))}const ne={$ref:"https://raw.githubusercontent.com/ajv-validator/ajv/master/lib/refs/data.json#"};function de(I){return{anyOf:[I,ne]}}})(cr)),cr}var $t={},Pt={},St={},bn;function Ji(){if(bn)return St;bn=1,Object.defineProperty(St,"__esModule",{value:!0});const s={keyword:"id",code(){throw new Error('NOT SUPPORTED: keyword "id", use "$id" for schema ID')}};return St.default=s,St}var Fe={},vn;function Wi(){if(vn)return Fe;vn=1,Object.defineProperty(Fe,"__esModule",{value:!0}),Fe.callRef=Fe.getValidate=void 0;const s=wt(),e=Ae(),t=te(),r=Ve(),n=gr(),i=ie(),o={keyword:"$ref",schemaType:"string",code(l){const{gen:d,schema:m,it:v}=l,{baseId:w,schemaEnv:P,validateName:g,opts:h,self:p}=v,{root:u}=P;if((m==="#"||m==="#/")&&w===u.baseId)return y();const f=n.resolveRef.call(p,u,w,m);if(f===void 0)throw new s.default(v.opts.uriResolver,w,m);if(f instanceof n.SchemaEnv)return $(f);return b(f);function y(){if(P===u)return c(l,g,P,P.$async);const S=d.scopeValue("root",{ref:u});return c(l,(0,t._)`${S}.validate`,u,u.$async)}function $(S){const x=a(l,S);c(l,x,S,S.$async)}function b(S){const x=d.scopeValue("schema",h.code.source===!0?{ref:S,code:(0,t.stringify)(S)}:{ref:S}),N=d.name("valid"),z=l.subschema({schema:S,dataTypes:[],schemaPath:t.nil,topSchemaRef:x,errSchemaPath:m},N);l.mergeEvaluated(z),l.ok(N)}}};function a(l,d){const{gen:m}=l;return d.validate?m.scopeValue("validate",{ref:d.validate}):(0,t._)`${m.scopeValue("wrapper",{ref:d})}.validate`}Fe.getValidate=a;function c(l,d,m,v){const{gen:w,it:P}=l,{allErrors:g,schemaEnv:h,opts:p}=P,u=p.passContext?r.default.this:t.nil;v?f():y();function f(){if(!h.$async)throw new Error("async schema referenced by sync schema");const S=w.let("valid");w.try(()=>{w.code((0,t._)`await ${(0,e.callValidateCode)(l,d,u)}`),b(d),g||w.assign(S,!0)},x=>{w.if((0,t._)`!(${x} instanceof ${P.ValidationError})`,()=>w.throw(x)),$(x),g||w.assign(S,!1)}),l.ok(S)}function y(){l.result((0,e.callValidateCode)(l,d,u),()=>b(d),()=>$(d))}function $(S){const x=(0,t._)`${S}.errors`;w.assign(r.default.vErrors,(0,t._)`${r.default.vErrors} === null ? ${x} : ${r.default.vErrors}.concat(${x})`),w.assign(r.default.errors,(0,t._)`${r.default.vErrors}.length`)}function b(S){var x;if(!P.opts.unevaluated)return;const N=(x=m?.validate)===null||x===void 0?void 0:x.evaluated;if(P.props!==!0)if(N&&!N.dynamicProps)N.props!==void 0&&(P.props=i.mergeEvaluated.props(w,N.props,P.props));else{const z=w.var("props",(0,t._)`${S}.evaluated.props`);P.props=i.mergeEvaluated.props(w,z,P.props,t.Name)}if(P.items!==!0)if(N&&!N.dynamicItems)N.items!==void 0&&(P.items=i.mergeEvaluated.items(w,N.items,P.items));else{const z=w.var("items",(0,t._)`${S}.evaluated.items`);P.items=i.mergeEvaluated.items(w,z,P.items,t.Name)}}}return Fe.callRef=c,Fe.default=o,Fe}var wn;function Xi(){if(wn)return Pt;wn=1,Object.defineProperty(Pt,"__esModule",{value:!0});const s=Ji(),e=Wi(),t=["$schema","$id","$defs","$vocabulary",{keyword:"$comment"},"definitions",s.default,e.default];return Pt.default=t,Pt}var Et={},Tt={},_n;function Qi(){if(_n)return Tt;_n=1,Object.defineProperty(Tt,"__esModule",{value:!0});const s=te(),e=s.operators,t={maximum:{okStr:"<=",ok:e.LTE,fail:e.GT},minimum:{okStr:">=",ok:e.GTE,fail:e.LT},exclusiveMaximum:{okStr:"<",ok:e.LT,fail:e.GTE},exclusiveMinimum:{okStr:">",ok:e.GT,fail:e.LTE}},r={message:({keyword:i,schemaCode:o})=>(0,s.str)`must be ${t[i].okStr} ${o}`,params:({keyword:i,schemaCode:o})=>(0,s._)`{comparison: ${t[i].okStr}, limit: ${o}}`},n={keyword:Object.keys(t),type:"number",schemaType:"number",$data:!0,error:r,code(i){const{keyword:o,data:a,schemaCode:c}=i;i.fail$data((0,s._)`${a} ${t[o].fail} ${c} || isNaN(${a})`)}};return Tt.default=n,Tt}var xt={},$n;function Zi(){if($n)return xt;$n=1,Object.defineProperty(xt,"__esModule",{value:!0});const s=te(),t={keyword:"multipleOf",type:"number",schemaType:"number",$data:!0,error:{message:({schemaCode:r})=>(0,s.str)`must be multiple of ${r}`,params:({schemaCode:r})=>(0,s._)`{multipleOf: ${r}}`},code(r){const{gen:n,data:i,schemaCode:o,it:a}=r,c=a.opts.multipleOfPrecision,l=n.let("res"),d=c?(0,s._)`Math.abs(Math.round(${l}) - ${l}) > 1e-${c}`:(0,s._)`${l} !== parseInt(${l})`;r.fail$data((0,s._)`(${o} === 0 || (${l} = ${i}/${o}, ${d}))`)}};return xt.default=t,xt}var kt={},Mt={},Pn;function eo(){if(Pn)return Mt;Pn=1,Object.defineProperty(Mt,"__esModule",{value:!0});function s(e){const t=e.length;let r=0,n=0,i;for(;n<t;)r++,i=e.charCodeAt(n++),i>=55296&&i<=56319&&n<t&&(i=e.charCodeAt(n),(i&64512)===56320&&n++);return r}return Mt.default=s,s.code='require("ajv/dist/runtime/ucs2length").default',Mt}var Sn;function to(){if(Sn)return kt;Sn=1,Object.defineProperty(kt,"__esModule",{value:!0});const s=te(),e=ie(),t=eo(),n={keyword:["maxLength","minLength"],type:"string",schemaType:"number",$data:!0,error:{message({keyword:i,schemaCode:o}){const a=i==="maxLength"?"more":"fewer";return(0,s.str)`must NOT have ${a} than ${o} characters`},params:({schemaCode:i})=>(0,s._)`{limit: ${i}}`},code(i){const{keyword:o,data:a,schemaCode:c,it:l}=i,d=o==="maxLength"?s.operators.GT:s.operators.LT,m=l.opts.unicode===!1?(0,s._)`${a}.length`:(0,s._)`${(0,e.useFunc)(i.gen,t.default)}(${a})`;i.fail$data((0,s._)`${m} ${d} ${c}`)}};return kt.default=n,kt}var At={},En;function ro(){if(En)return At;En=1,Object.defineProperty(At,"__esModule",{value:!0});const s=Ae(),e=te(),r={keyword:"pattern",type:"string",schemaType:"string",$data:!0,error:{message:({schemaCode:n})=>(0,e.str)`must match pattern "${n}"`,params:({schemaCode:n})=>(0,e._)`{pattern: ${n}}`},code(n){const{data:i,$data:o,schema:a,schemaCode:c,it:l}=n,d=l.opts.unicodeRegExp?"u":"",m=o?(0,e._)`(new RegExp(${c}, ${d}))`:(0,s.usePattern)(n,a);n.fail$data((0,e._)`!${m}.test(${i})`)}};return At.default=r,At}var Rt={},Tn;function no(){if(Tn)return Rt;Tn=1,Object.defineProperty(Rt,"__esModule",{value:!0});const s=te(),t={keyword:["maxProperties","minProperties"],type:"object",schemaType:"number",$data:!0,error:{message({keyword:r,schemaCode:n}){const i=r==="maxProperties"?"more":"fewer";return(0,s.str)`must NOT have ${i} than ${n} properties`},params:({schemaCode:r})=>(0,s._)`{limit: ${r}}`},code(r){const{keyword:n,data:i,schemaCode:o}=r,a=n==="maxProperties"?s.operators.GT:s.operators.LT;r.fail$data((0,s._)`Object.keys(${i}).length ${a} ${o}`)}};return Rt.default=t,Rt}var Ct={},xn;function io(){if(xn)return Ct;xn=1,Object.defineProperty(Ct,"__esModule",{value:!0});const s=Ae(),e=te(),t=ie(),n={keyword:"required",type:"object",schemaType:"array",$data:!0,error:{message:({params:{missingProperty:i}})=>(0,e.str)`must have required property '${i}'`,params:({params:{missingProperty:i}})=>(0,e._)`{missingProperty: ${i}}`},code(i){const{gen:o,schema:a,schemaCode:c,data:l,$data:d,it:m}=i,{opts:v}=m;if(!d&&a.length===0)return;const w=a.length>=v.loopRequired;if(m.allErrors?P():g(),v.strictRequired){const u=i.parentSchema.properties,{definedProperties:f}=i.it;for(const y of a)if(u?.[y]===void 0&&!f.has(y)){const $=m.schemaEnv.baseId+m.errSchemaPath,b=`required property "${y}" is not defined at "${$}" (strictRequired)`;(0,t.checkStrictMode)(m,b,m.opts.strictRequired)}}function P(){if(w||d)i.block$data(e.nil,h);else for(const u of a)(0,s.checkReportMissingProp)(i,u)}function g(){const u=o.let("missing");if(w||d){const f=o.let("valid",!0);i.block$data(f,()=>p(u,f)),i.ok(f)}else o.if((0,s.checkMissingProp)(i,a,u)),(0,s.reportMissingProp)(i,u),o.else()}function h(){o.forOf("prop",c,u=>{i.setParams({missingProperty:u}),o.if((0,s.noPropertyInData)(o,l,u,v.ownProperties),()=>i.error())})}function p(u,f){i.setParams({missingProperty:u}),o.forOf(u,c,()=>{o.assign(f,(0,s.propertyInData)(o,l,u,v.ownProperties)),o.if((0,e.not)(f),()=>{i.error(),o.break()})},e.nil)}}};return Ct.default=n,Ct}var Nt={},kn;function oo(){if(kn)return Nt;kn=1,Object.defineProperty(Nt,"__esModule",{value:!0});const s=te(),t={keyword:["maxItems","minItems"],type:"array",schemaType:"number",$data:!0,error:{message({keyword:r,schemaCode:n}){const i=r==="maxItems"?"more":"fewer";return(0,s.str)`must NOT have ${i} than ${n} items`},params:({schemaCode:r})=>(0,s._)`{limit: ${r}}`},code(r){const{keyword:n,data:i,schemaCode:o}=r,a=n==="maxItems"?s.operators.GT:s.operators.LT;r.fail$data((0,s._)`${i}.length ${a} ${o}`)}};return Nt.default=t,Nt}var jt={},Ot={},Mn;function wr(){if(Mn)return Ot;Mn=1,Object.defineProperty(Ot,"__esModule",{value:!0});const s=on();return s.code='require("ajv/dist/runtime/equal").default',Ot.default=s,Ot}var An;function so(){if(An)return jt;An=1,Object.defineProperty(jt,"__esModule",{value:!0});const s=mt(),e=te(),t=ie(),r=wr(),i={keyword:"uniqueItems",type:"array",schemaType:"boolean",$data:!0,error:{message:({params:{i:o,j:a}})=>(0,e.str)`must NOT have duplicate items (items ## ${a} and ${o} are identical)`,params:({params:{i:o,j:a}})=>(0,e._)`{i: ${o}, j: ${a}}`},code(o){const{gen:a,data:c,$data:l,schema:d,parentSchema:m,schemaCode:v,it:w}=o;if(!l&&!d)return;const P=a.let("valid"),g=m.items?(0,s.getSchemaTypes)(m.items):[];o.block$data(P,h,(0,e._)`${v} === false`),o.ok(P);function h(){const y=a.let("i",(0,e._)`${c}.length`),$=a.let("j");o.setParams({i:y,j:$}),a.assign(P,!0),a.if((0,e._)`${y} > 1`,()=>(p()?u:f)(y,$))}function p(){return g.length>0&&!g.some(y=>y==="object"||y==="array")}function u(y,$){const b=a.name("item"),S=(0,s.checkDataTypes)(g,b,w.opts.strictNumbers,s.DataType.Wrong),x=a.const("indices",(0,e._)`{}`);a.for((0,e._)`;${y}--;`,()=>{a.let(b,(0,e._)`${c}[${y}]`),a.if(S,(0,e._)`continue`),g.length>1&&a.if((0,e._)`typeof ${b} == "string"`,(0,e._)`${b} += "_"`),a.if((0,e._)`typeof ${x}[${b}] == "number"`,()=>{a.assign($,(0,e._)`${x}[${b}]`),o.error(),a.assign(P,!1).break()}).code((0,e._)`${x}[${b}] = ${y}`)})}function f(y,$){const b=(0,t.useFunc)(a,r.default),S=a.name("outer");a.label(S).for((0,e._)`;${y}--;`,()=>a.for((0,e._)`${$} = ${y}; ${$}--;`,()=>a.if((0,e._)`${b}(${c}[${y}], ${c}[${$}])`,()=>{o.error(),a.assign(P,!1).break(S)})))}}};return jt.default=i,jt}var It={},Rn;function ao(){if(Rn)return It;Rn=1,Object.defineProperty(It,"__esModule",{value:!0});const s=te(),e=ie(),t=wr(),n={keyword:"const",$data:!0,error:{message:"must be equal to constant",params:({schemaCode:i})=>(0,s._)`{allowedValue: ${i}}`},code(i){const{gen:o,data:a,$data:c,schemaCode:l,schema:d}=i;c||d&&typeof d=="object"?i.fail$data((0,s._)`!${(0,e.useFunc)(o,t.default)}(${a}, ${l})`):i.fail((0,s._)`${d} !== ${a}`)}};return It.default=n,It}var qt={},Cn;function co(){if(Cn)return qt;Cn=1,Object.defineProperty(qt,"__esModule",{value:!0});const s=te(),e=ie(),t=wr(),n={keyword:"enum",schemaType:"array",$data:!0,error:{message:"must be equal to one of the allowed values",params:({schemaCode:i})=>(0,s._)`{allowedValues: ${i}}`},code(i){const{gen:o,data:a,$data:c,schema:l,schemaCode:d,it:m}=i;if(!c&&l.length===0)throw new Error("enum must have non-empty array");const v=l.length>=m.opts.loopEnum;let w;const P=()=>w??(w=(0,e.useFunc)(o,t.default));let g;if(v||c)g=o.let("valid"),i.block$data(g,h);else{if(!Array.isArray(l))throw new Error("ajv implementation error");const u=o.const("vSchema",d);g=(0,s.or)(...l.map((f,y)=>p(u,y)))}i.pass(g);function h(){o.assign(g,!1),o.forOf("v",d,u=>o.if((0,s._)`${P()}(${a}, ${u})`,()=>o.assign(g,!0).break()))}function p(u,f){const y=l[f];return typeof y=="object"&&y!==null?(0,s._)`${P()}(${a}, ${u}[${f}])`:(0,s._)`${a} === ${y}`}}};return qt.default=n,qt}var Nn;function lo(){if(Nn)return Et;Nn=1,Object.defineProperty(Et,"__esModule",{value:!0});const s=Qi(),e=Zi(),t=to(),r=ro(),n=no(),i=io(),o=oo(),a=so(),c=ao(),l=co(),d=[s.default,e.default,t.default,r.default,n.default,i.default,o.default,a.default,{keyword:"type",schemaType:["string","array"]},{keyword:"nullable",schemaType:"boolean"},c.default,l.default];return Et.default=d,Et}var Dt={},Ye={},jn;function On(){if(jn)return Ye;jn=1,Object.defineProperty(Ye,"__esModule",{value:!0}),Ye.validateAdditionalItems=void 0;const s=te(),e=ie(),r={keyword:"additionalItems",type:"array",schemaType:["boolean","object"],before:"uniqueItems",error:{message:({params:{len:i}})=>(0,s.str)`must NOT have more than ${i} items`,params:({params:{len:i}})=>(0,s._)`{limit: ${i}}`},code(i){const{parentSchema:o,it:a}=i,{items:c}=o;if(!Array.isArray(c)){(0,e.checkStrictMode)(a,'"additionalItems" is ignored when "items" is not an array of schemas');return}n(i,c)}};function n(i,o){const{gen:a,schema:c,data:l,keyword:d,it:m}=i;m.items=!0;const v=a.const("len",(0,s._)`${l}.length`);if(c===!1)i.setParams({len:o.length}),i.pass((0,s._)`${v} <= ${o.length}`);else if(typeof c=="object"&&!(0,e.alwaysValidSchema)(m,c)){const P=a.var("valid",(0,s._)`${v} <= ${o.length}`);a.if((0,s.not)(P),()=>w(P)),i.ok(P)}function w(P){a.forRange("i",o.length,v,g=>{i.subschema({keyword:d,dataProp:g,dataPropType:e.Type.Num},P),m.allErrors||a.if((0,s.not)(P),()=>a.break())})}}return Ye.validateAdditionalItems=n,Ye.default=r,Ye}var zt={},He={},In;function qn(){if(In)return He;In=1,Object.defineProperty(He,"__esModule",{value:!0}),He.validateTuple=void 0;const s=te(),e=ie(),t=Ae(),r={keyword:"items",type:"array",schemaType:["object","array","boolean"],before:"uniqueItems",code(i){const{schema:o,it:a}=i;if(Array.isArray(o))return n(i,"additionalItems",o);a.items=!0,!(0,e.alwaysValidSchema)(a,o)&&i.ok((0,t.validateArray)(i))}};function n(i,o,a=i.schema){const{gen:c,parentSchema:l,data:d,keyword:m,it:v}=i;g(l),v.opts.unevaluated&&a.length&&v.items!==!0&&(v.items=e.mergeEvaluated.items(c,a.length,v.items));const w=c.name("valid"),P=c.const("len",(0,s._)`${d}.length`);a.forEach((h,p)=>{(0,e.alwaysValidSchema)(v,h)||(c.if((0,s._)`${P} > ${p}`,()=>i.subschema({keyword:m,schemaProp:p,dataProp:p},w)),i.ok(w))});function g(h){const{opts:p,errSchemaPath:u}=v,f=a.length,y=f===h.minItems&&(f===h.maxItems||h[o]===!1);if(p.strictTuples&&!y){const $=`"${m}" is ${f}-tuple, but minItems or maxItems/${o} are not specified or different at path "${u}"`;(0,e.checkStrictMode)(v,$,p.strictTuples)}}}return He.validateTuple=n,He.default=r,He}var Dn;function uo(){if(Dn)return zt;Dn=1,Object.defineProperty(zt,"__esModule",{value:!0});const s=qn(),e={keyword:"prefixItems",type:"array",schemaType:["array"],before:"uniqueItems",code:t=>(0,s.validateTuple)(t,"items")};return zt.default=e,zt}var Lt={},zn;function ho(){if(zn)return Lt;zn=1,Object.defineProperty(Lt,"__esModule",{value:!0});const s=te(),e=ie(),t=Ae(),r=On(),i={keyword:"items",type:"array",schemaType:["object","boolean"],before:"uniqueItems",error:{message:({params:{len:o}})=>(0,s.str)`must NOT have more than ${o} items`,params:({params:{len:o}})=>(0,s._)`{limit: ${o}}`},code(o){const{schema:a,parentSchema:c,it:l}=o,{prefixItems:d}=c;l.items=!0,!(0,e.alwaysValidSchema)(l,a)&&(d?(0,r.validateAdditionalItems)(o,d):o.ok((0,t.validateArray)(o)))}};return Lt.default=i,Lt}var Vt={},Ln;function fo(){if(Ln)return Vt;Ln=1,Object.defineProperty(Vt,"__esModule",{value:!0});const s=te(),e=ie(),r={keyword:"contains",type:"array",schemaType:["object","boolean"],before:"uniqueItems",trackErrors:!0,error:{message:({params:{min:n,max:i}})=>i===void 0?(0,s.str)`must contain at least ${n} valid item(s)`:(0,s.str)`must contain at least ${n} and no more than ${i} valid item(s)`,params:({params:{min:n,max:i}})=>i===void 0?(0,s._)`{minContains: ${n}}`:(0,s._)`{minContains: ${n}, maxContains: ${i}}`},code(n){const{gen:i,schema:o,parentSchema:a,data:c,it:l}=n;let d,m;const{minContains:v,maxContains:w}=a;l.opts.next?(d=v===void 0?1:v,m=w):d=1;const P=i.const("len",(0,s._)`${c}.length`);if(n.setParams({min:d,max:m}),m===void 0&&d===0){(0,e.checkStrictMode)(l,'"minContains" == 0 without "maxContains": "contains" keyword ignored');return}if(m!==void 0&&d>m){(0,e.checkStrictMode)(l,'"minContains" > "maxContains" is always invalid'),n.fail();return}if((0,e.alwaysValidSchema)(l,o)){let f=(0,s._)`${P} >= ${d}`;m!==void 0&&(f=(0,s._)`${f} && ${P} <= ${m}`),n.pass(f);return}l.items=!0;const g=i.name("valid");m===void 0&&d===1?p(g,()=>i.if(g,()=>i.break())):d===0?(i.let(g,!0),m!==void 0&&i.if((0,s._)`${c}.length > 0`,h)):(i.let(g,!1),h()),n.result(g,()=>n.reset());function h(){const f=i.name("_valid"),y=i.let("count",0);p(f,()=>i.if(f,()=>u(y)))}function p(f,y){i.forRange("i",0,P,$=>{n.subschema({keyword:"contains",dataProp:$,dataPropType:e.Type.Num,compositeRule:!0},f),y()})}function u(f){i.code((0,s._)`${f}++`),m===void 0?i.if((0,s._)`${f} >= ${d}`,()=>i.assign(g,!0).break()):(i.if((0,s._)`${f} > ${m}`,()=>i.assign(g,!1).break()),d===1?i.assign(g,!0):i.if((0,s._)`${f} >= ${d}`,()=>i.assign(g,!0)))}}};return Vt.default=r,Vt}var _r={},Vn;function po(){return Vn||(Vn=1,(function(s){Object.defineProperty(s,"__esModule",{value:!0}),s.validateSchemaDeps=s.validatePropertyDeps=s.error=void 0;const e=te(),t=ie(),r=Ae();s.error={message:({params:{property:c,depsCount:l,deps:d}})=>{const m=l===1?"property":"properties";return(0,e.str)`must have ${m} ${d} when property ${c} is present`},params:({params:{property:c,depsCount:l,deps:d,missingProperty:m}})=>(0,e._)`{property: ${c},
    missingProperty: ${m},
    depsCount: ${l},
    deps: ${d}}`};const n={keyword:"dependencies",type:"object",schemaType:"object",error:s.error,code(c){const[l,d]=i(c);o(c,l),a(c,d)}};function i({schema:c}){const l={},d={};for(const m in c){if(m==="__proto__")continue;const v=Array.isArray(c[m])?l:d;v[m]=c[m]}return[l,d]}function o(c,l=c.schema){const{gen:d,data:m,it:v}=c;if(Object.keys(l).length===0)return;const w=d.let("missing");for(const P in l){const g=l[P];if(g.length===0)continue;const h=(0,r.propertyInData)(d,m,P,v.opts.ownProperties);c.setParams({property:P,depsCount:g.length,deps:g.join(", ")}),v.allErrors?d.if(h,()=>{for(const p of g)(0,r.checkReportMissingProp)(c,p)}):(d.if((0,e._)`${h} && (${(0,r.checkMissingProp)(c,g,w)})`),(0,r.reportMissingProp)(c,w),d.else())}}s.validatePropertyDeps=o;function a(c,l=c.schema){const{gen:d,data:m,keyword:v,it:w}=c,P=d.name("valid");for(const g in l)(0,t.alwaysValidSchema)(w,l[g])||(d.if((0,r.propertyInData)(d,m,g,w.opts.ownProperties),()=>{const h=c.subschema({keyword:v,schemaProp:g},P);c.mergeValidEvaluated(h,P)},()=>d.var(P,!0)),c.ok(P))}s.validateSchemaDeps=a,s.default=n})(_r)),_r}var Ft={},Fn;function mo(){if(Fn)return Ft;Fn=1,Object.defineProperty(Ft,"__esModule",{value:!0});const s=te(),e=ie(),r={keyword:"propertyNames",type:"object",schemaType:["object","boolean"],error:{message:"property name must be valid",params:({params:n})=>(0,s._)`{propertyName: ${n.propertyName}}`},code(n){const{gen:i,schema:o,data:a,it:c}=n;if((0,e.alwaysValidSchema)(c,o))return;const l=i.name("valid");i.forIn("key",a,d=>{n.setParams({propertyName:d}),n.subschema({keyword:"propertyNames",data:d,dataTypes:["string"],propertyName:d,compositeRule:!0},l),i.if((0,s.not)(l),()=>{n.error(!0),c.allErrors||i.break()})}),n.ok(l)}};return Ft.default=r,Ft}var Gt={},Gn;function Bn(){if(Gn)return Gt;Gn=1,Object.defineProperty(Gt,"__esModule",{value:!0});const s=Ae(),e=te(),t=Ve(),r=ie(),i={keyword:"additionalProperties",type:["object"],schemaType:["boolean","object"],allowUndefined:!0,trackErrors:!0,error:{message:"must NOT have additional properties",params:({params:o})=>(0,e._)`{additionalProperty: ${o.additionalProperty}}`},code(o){const{gen:a,schema:c,parentSchema:l,data:d,errsCount:m,it:v}=o;if(!m)throw new Error("ajv implementation error");const{allErrors:w,opts:P}=v;if(v.props=!0,P.removeAdditional!=="all"&&(0,r.alwaysValidSchema)(v,c))return;const g=(0,s.allSchemaProperties)(l.properties),h=(0,s.allSchemaProperties)(l.patternProperties);p(),o.ok((0,e._)`${m} === ${t.default.errors}`);function p(){a.forIn("key",d,b=>{!g.length&&!h.length?y(b):a.if(u(b),()=>y(b))})}function u(b){let S;if(g.length>8){const x=(0,r.schemaRefOrVal)(v,l.properties,"properties");S=(0,s.isOwnProperty)(a,x,b)}else g.length?S=(0,e.or)(...g.map(x=>(0,e._)`${b} === ${x}`)):S=e.nil;return h.length&&(S=(0,e.or)(S,...h.map(x=>(0,e._)`${(0,s.usePattern)(o,x)}.test(${b})`))),(0,e.not)(S)}function f(b){a.code((0,e._)`delete ${d}[${b}]`)}function y(b){if(P.removeAdditional==="all"||P.removeAdditional&&c===!1){f(b);return}if(c===!1){o.setParams({additionalProperty:b}),o.error(),w||a.break();return}if(typeof c=="object"&&!(0,r.alwaysValidSchema)(v,c)){const S=a.name("valid");P.removeAdditional==="failing"?($(b,S,!1),a.if((0,e.not)(S),()=>{o.reset(),f(b)})):($(b,S),w||a.if((0,e.not)(S),()=>a.break()))}}function $(b,S,x){const N={keyword:"additionalProperties",dataProp:b,dataPropType:r.Type.Str};x===!1&&Object.assign(N,{compositeRule:!0,createErrors:!1,allErrors:!1}),o.subschema(N,S)}}};return Gt.default=i,Gt}var Bt={},Un;function go(){if(Un)return Bt;Un=1,Object.defineProperty(Bt,"__esModule",{value:!0});const s=yt(),e=Ae(),t=ie(),r=Bn(),n={keyword:"properties",type:"object",schemaType:"object",code(i){const{gen:o,schema:a,parentSchema:c,data:l,it:d}=i;d.opts.removeAdditional==="all"&&c.additionalProperties===void 0&&r.default.code(new s.KeywordCxt(d,r.default,"additionalProperties"));const m=(0,e.allSchemaProperties)(a);for(const h of m)d.definedProperties.add(h);d.opts.unevaluated&&m.length&&d.props!==!0&&(d.props=t.mergeEvaluated.props(o,(0,t.toHash)(m),d.props));const v=m.filter(h=>!(0,t.alwaysValidSchema)(d,a[h]));if(v.length===0)return;const w=o.name("valid");for(const h of v)P(h)?g(h):(o.if((0,e.propertyInData)(o,l,h,d.opts.ownProperties)),g(h),d.allErrors||o.else().var(w,!0),o.endIf()),i.it.definedProperties.add(h),i.ok(w);function P(h){return d.opts.useDefaults&&!d.compositeRule&&a[h].default!==void 0}function g(h){i.subschema({keyword:"properties",schemaProp:h,dataProp:h},w)}}};return Bt.default=n,Bt}var Ut={},Kn;function yo(){if(Kn)return Ut;Kn=1,Object.defineProperty(Ut,"__esModule",{value:!0});const s=Ae(),e=te(),t=ie(),r=ie(),n={keyword:"patternProperties",type:"object",schemaType:"object",code(i){const{gen:o,schema:a,data:c,parentSchema:l,it:d}=i,{opts:m}=d,v=(0,s.allSchemaProperties)(a),w=v.filter(y=>(0,t.alwaysValidSchema)(d,a[y]));if(v.length===0||w.length===v.length&&(!d.opts.unevaluated||d.props===!0))return;const P=m.strictSchema&&!m.allowMatchingProperties&&l.properties,g=o.name("valid");d.props!==!0&&!(d.props instanceof e.Name)&&(d.props=(0,r.evaluatedPropsToName)(o,d.props));const{props:h}=d;p();function p(){for(const y of v)P&&u(y),d.allErrors?f(y):(o.var(g,!0),f(y),o.if(g))}function u(y){for(const $ in P)new RegExp(y).test($)&&(0,t.checkStrictMode)(d,`property ${$} matches pattern ${y} (use allowMatchingProperties)`)}function f(y){o.forIn("key",c,$=>{o.if((0,e._)`${(0,s.usePattern)(i,y)}.test(${$})`,()=>{const b=w.includes(y);b||i.subschema({keyword:"patternProperties",schemaProp:y,dataProp:$,dataPropType:r.Type.Str},g),d.opts.unevaluated&&h!==!0?o.assign((0,e._)`${h}[${$}]`,!0):!b&&!d.allErrors&&o.if((0,e.not)(g),()=>o.break())})})}}};return Ut.default=n,Ut}var Kt={},Yn;function bo(){if(Yn)return Kt;Yn=1,Object.defineProperty(Kt,"__esModule",{value:!0});const s=ie(),e={keyword:"not",schemaType:["object","boolean"],trackErrors:!0,code(t){const{gen:r,schema:n,it:i}=t;if((0,s.alwaysValidSchema)(i,n)){t.fail();return}const o=r.name("valid");t.subschema({keyword:"not",compositeRule:!0,createErrors:!1,allErrors:!1},o),t.failResult(o,()=>t.reset(),()=>t.error())},error:{message:"must NOT be valid"}};return Kt.default=e,Kt}var Yt={},Hn;function vo(){if(Hn)return Yt;Hn=1,Object.defineProperty(Yt,"__esModule",{value:!0});const e={keyword:"anyOf",schemaType:"array",trackErrors:!0,code:Ae().validateUnion,error:{message:"must match a schema in anyOf"}};return Yt.default=e,Yt}var Ht={},Jn;function wo(){if(Jn)return Ht;Jn=1,Object.defineProperty(Ht,"__esModule",{value:!0});const s=te(),e=ie(),r={keyword:"oneOf",schemaType:"array",trackErrors:!0,error:{message:"must match exactly one schema in oneOf",params:({params:n})=>(0,s._)`{passingSchemas: ${n.passing}}`},code(n){const{gen:i,schema:o,parentSchema:a,it:c}=n;if(!Array.isArray(o))throw new Error("ajv implementation error");if(c.opts.discriminator&&a.discriminator)return;const l=o,d=i.let("valid",!1),m=i.let("passing",null),v=i.name("_valid");n.setParams({passing:m}),i.block(w),n.result(d,()=>n.reset(),()=>n.error(!0));function w(){l.forEach((P,g)=>{let h;(0,e.alwaysValidSchema)(c,P)?i.var(v,!0):h=n.subschema({keyword:"oneOf",schemaProp:g,compositeRule:!0},v),g>0&&i.if((0,s._)`${v} && ${d}`).assign(d,!1).assign(m,(0,s._)`[${m}, ${g}]`).else(),i.if(v,()=>{i.assign(d,!0),i.assign(m,g),h&&n.mergeEvaluated(h,s.Name)})})}}};return Ht.default=r,Ht}var Jt={},Wn;function _o(){if(Wn)return Jt;Wn=1,Object.defineProperty(Jt,"__esModule",{value:!0});const s=ie(),e={keyword:"allOf",schemaType:"array",code(t){const{gen:r,schema:n,it:i}=t;if(!Array.isArray(n))throw new Error("ajv implementation error");const o=r.name("valid");n.forEach((a,c)=>{if((0,s.alwaysValidSchema)(i,a))return;const l=t.subschema({keyword:"allOf",schemaProp:c},o);t.ok(o),t.mergeEvaluated(l)})}};return Jt.default=e,Jt}var Wt={},Xn;function $o(){if(Xn)return Wt;Xn=1,Object.defineProperty(Wt,"__esModule",{value:!0});const s=te(),e=ie(),r={keyword:"if",schemaType:["object","boolean"],trackErrors:!0,error:{message:({params:i})=>(0,s.str)`must match "${i.ifClause}" schema`,params:({params:i})=>(0,s._)`{failingKeyword: ${i.ifClause}}`},code(i){const{gen:o,parentSchema:a,it:c}=i;a.then===void 0&&a.else===void 0&&(0,e.checkStrictMode)(c,'"if" without "then" and "else" is ignored');const l=n(c,"then"),d=n(c,"else");if(!l&&!d)return;const m=o.let("valid",!0),v=o.name("_valid");if(w(),i.reset(),l&&d){const g=o.let("ifClause");i.setParams({ifClause:g}),o.if(v,P("then",g),P("else",g))}else l?o.if(v,P("then")):o.if((0,s.not)(v),P("else"));i.pass(m,()=>i.error(!0));function w(){const g=i.subschema({keyword:"if",compositeRule:!0,createErrors:!1,allErrors:!1},v);i.mergeEvaluated(g)}function P(g,h){return()=>{const p=i.subschema({keyword:g},v);o.assign(m,v),i.mergeValidEvaluated(p,m),h?o.assign(h,(0,s._)`${g}`):i.setParams({ifClause:g})}}}};function n(i,o){const a=i.schema[o];return a!==void 0&&!(0,e.alwaysValidSchema)(i,a)}return Wt.default=r,Wt}var Xt={},Qn;function Po(){if(Qn)return Xt;Qn=1,Object.defineProperty(Xt,"__esModule",{value:!0});const s=ie(),e={keyword:["then","else"],schemaType:["object","boolean"],code({keyword:t,parentSchema:r,it:n}){r.if===void 0&&(0,s.checkStrictMode)(n,`"${t}" without "if" is ignored`)}};return Xt.default=e,Xt}var Zn;function So(){if(Zn)return Dt;Zn=1,Object.defineProperty(Dt,"__esModule",{value:!0});const s=On(),e=uo(),t=qn(),r=ho(),n=fo(),i=po(),o=mo(),a=Bn(),c=go(),l=yo(),d=bo(),m=vo(),v=wo(),w=_o(),P=$o(),g=Po();function h(p=!1){const u=[d.default,m.default,v.default,w.default,P.default,g.default,o.default,a.default,i.default,c.default,l.default];return p?u.push(e.default,r.default):u.push(s.default,t.default),u.push(n.default),u}return Dt.default=h,Dt}var Qt={},Zt={},ei;function Eo(){if(ei)return Zt;ei=1,Object.defineProperty(Zt,"__esModule",{value:!0});const s=te(),t={keyword:"format",type:["number","string"],schemaType:"string",$data:!0,error:{message:({schemaCode:r})=>(0,s.str)`must match format "${r}"`,params:({schemaCode:r})=>(0,s._)`{format: ${r}}`},code(r,n){const{gen:i,data:o,$data:a,schema:c,schemaCode:l,it:d}=r,{opts:m,errSchemaPath:v,schemaEnv:w,self:P}=d;if(!m.validateFormats)return;a?g():h();function g(){const p=i.scopeValue("formats",{ref:P.formats,code:m.code.formats}),u=i.const("fDef",(0,s._)`${p}[${l}]`),f=i.let("fType"),y=i.let("format");i.if((0,s._)`typeof ${u} == "object" && !(${u} instanceof RegExp)`,()=>i.assign(f,(0,s._)`${u}.type || "string"`).assign(y,(0,s._)`${u}.validate`),()=>i.assign(f,(0,s._)`"string"`).assign(y,u)),r.fail$data((0,s.or)($(),b()));function $(){return m.strictSchema===!1?s.nil:(0,s._)`${l} && !${y}`}function b(){const S=w.$async?(0,s._)`(${u}.async ? await ${y}(${o}) : ${y}(${o}))`:(0,s._)`${y}(${o})`,x=(0,s._)`(typeof ${y} == "function" ? ${S} : ${y}.test(${o}))`;return(0,s._)`${y} && ${y} !== true && ${f} === ${n} && !${x}`}}function h(){const p=P.formats[c];if(!p){$();return}if(p===!0)return;const[u,f,y]=b(p);u===n&&r.pass(S());function $(){if(m.strictSchema===!1){P.logger.warn(x());return}throw new Error(x());function x(){return`unknown format "${c}" ignored in schema at path "${v}"`}}function b(x){const N=x instanceof RegExp?(0,s.regexpCode)(x):m.code.formats?(0,s._)`${m.code.formats}${(0,s.getProperty)(c)}`:void 0,z=i.scopeValue("formats",{key:c,ref:x,code:N});return typeof x=="object"&&!(x instanceof RegExp)?[x.type||"string",x.validate,(0,s._)`${z}.validate`]:["string",x,z]}function S(){if(typeof p=="object"&&!(p instanceof RegExp)&&p.async){if(!w.$async)throw new Error("async format in sync schema");return(0,s._)`await ${y}(${o})`}return typeof f=="function"?(0,s._)`${y}(${o})`:(0,s._)`${y}.test(${o})`}}}};return Zt.default=t,Zt}var ti;function To(){if(ti)return Qt;ti=1,Object.defineProperty(Qt,"__esModule",{value:!0});const e=[Eo().default];return Qt.default=e,Qt}var Ke={},ri;function xo(){return ri||(ri=1,Object.defineProperty(Ke,"__esModule",{value:!0}),Ke.contentVocabulary=Ke.metadataVocabulary=void 0,Ke.metadataVocabulary=["title","description","default","deprecated","readOnly","writeOnly","examples"],Ke.contentVocabulary=["contentMediaType","contentEncoding","contentSchema"]),Ke}var ni;function ko(){if(ni)return $t;ni=1,Object.defineProperty($t,"__esModule",{value:!0});const s=Xi(),e=lo(),t=So(),r=To(),n=xo(),i=[s.default,e.default,(0,t.default)(),r.default,n.metadataVocabulary,n.contentVocabulary];return $t.default=i,$t}var er={},ot={},ii;function Mo(){if(ii)return ot;ii=1,Object.defineProperty(ot,"__esModule",{value:!0}),ot.DiscrError=void 0;var s;return(function(e){e.Tag="tag",e.Mapping="mapping"})(s||(ot.DiscrError=s={})),ot}var oi;function Ao(){if(oi)return er;oi=1,Object.defineProperty(er,"__esModule",{value:!0});const s=te(),e=Mo(),t=gr(),r=wt(),n=ie(),o={keyword:"discriminator",type:"object",schemaType:"object",error:{message:({params:{discrError:a,tagName:c}})=>a===e.DiscrError.Tag?`tag "${c}" must be string`:`value of tag "${c}" must be in oneOf`,params:({params:{discrError:a,tag:c,tagName:l}})=>(0,s._)`{error: ${a}, tag: ${l}, tagValue: ${c}}`},code(a){const{gen:c,data:l,schema:d,parentSchema:m,it:v}=a,{oneOf:w}=m;if(!v.opts.discriminator)throw new Error("discriminator: requires discriminator option");const P=d.propertyName;if(typeof P!="string")throw new Error("discriminator: requires propertyName");if(d.mapping)throw new Error("discriminator: mapping is not supported");if(!w)throw new Error("discriminator: requires oneOf keyword");const g=c.let("valid",!1),h=c.const("tag",(0,s._)`${l}${(0,s.getProperty)(P)}`);c.if((0,s._)`typeof ${h} == "string"`,()=>p(),()=>a.error(!1,{discrError:e.DiscrError.Tag,tag:h,tagName:P})),a.ok(g);function p(){const y=f();c.if(!1);for(const $ in y)c.elseIf((0,s._)`${h} === ${$}`),c.assign(g,u(y[$]));c.else(),a.error(!1,{discrError:e.DiscrError.Mapping,tag:h,tagName:P}),c.endIf()}function u(y){const $=c.name("valid"),b=a.subschema({keyword:"oneOf",schemaProp:y},$);return a.mergeEvaluated(b,s.Name),$}function f(){var y;const $={},b=x(m);let S=!0;for(let q=0;q<w.length;q++){let L=w[q];if(L?.$ref&&!(0,n.schemaHasRulesButRef)(L,v.self.RULES)){const X=L.$ref;if(L=t.resolveRef.call(v.self,v.schemaEnv.root,v.baseId,X),L instanceof t.SchemaEnv&&(L=L.schema),L===void 0)throw new r.default(v.opts.uriResolver,v.baseId,X)}const F=(y=L?.properties)===null||y===void 0?void 0:y[P];if(typeof F!="object")throw new Error(`discriminator: oneOf subschemas (or referenced schemas) must have "properties/${P}"`);S=S&&(b||x(L)),N(F,q)}if(!S)throw new Error(`discriminator: "${P}" must be required`);return $;function x({required:q}){return Array.isArray(q)&&q.includes(P)}function N(q,L){if(q.const)z(q.const,L);else if(q.enum)for(const F of q.enum)z(F,L);else throw new Error(`discriminator: "properties/${P}" must have "const" or "enum"`)}function z(q,L){if(typeof q!="string"||q in $)throw new Error(`discriminator: "${P}" values must be unique strings`);$[q]=L}}}};return er.default=o,er}const Ro={$schema:"http://json-schema.org/draft-07/schema#",$id:"http://json-schema.org/draft-07/schema#",title:"Core schema meta-schema",definitions:{schemaArray:{type:"array",minItems:1,items:{$ref:"#"}},nonNegativeInteger:{type:"integer",minimum:0},nonNegativeIntegerDefault0:{allOf:[{$ref:"#/definitions/nonNegativeInteger"},{default:0}]},simpleTypes:{enum:["array","boolean","integer","null","number","object","string"]},stringArray:{type:"array",items:{type:"string"},uniqueItems:!0,default:[]}},type:["object","boolean"],properties:{$id:{type:"string",format:"uri-reference"},$schema:{type:"string",format:"uri"},$ref:{type:"string",format:"uri-reference"},$comment:{type:"string"},title:{type:"string"},description:{type:"string"},default:!0,readOnly:{type:"boolean",default:!1},examples:{type:"array",items:!0},multipleOf:{type:"number",exclusiveMinimum:0},maximum:{type:"number"},exclusiveMaximum:{type:"number"},minimum:{type:"number"},exclusiveMinimum:{type:"number"},maxLength:{$ref:"#/definitions/nonNegativeInteger"},minLength:{$ref:"#/definitions/nonNegativeIntegerDefault0"},pattern:{type:"string",format:"regex"},additionalItems:{$ref:"#"},items:{anyOf:[{$ref:"#"},{$ref:"#/definitions/schemaArray"}],default:!0},maxItems:{$ref:"#/definitions/nonNegativeInteger"},minItems:{$ref:"#/definitions/nonNegativeIntegerDefault0"},uniqueItems:{type:"boolean",default:!1},contains:{$ref:"#"},maxProperties:{$ref:"#/definitions/nonNegativeInteger"},minProperties:{$ref:"#/definitions/nonNegativeIntegerDefault0"},required:{$ref:"#/definitions/stringArray"},additionalProperties:{$ref:"#"},definitions:{type:"object",additionalProperties:{$ref:"#"},default:{}},properties:{type:"object",additionalProperties:{$ref:"#"},default:{}},patternProperties:{type:"object",additionalProperties:{$ref:"#"},propertyNames:{format:"regex"},default:{}},dependencies:{type:"object",additionalProperties:{anyOf:[{$ref:"#"},{$ref:"#/definitions/stringArray"}]}},propertyNames:{$ref:"#"},const:!0,enum:{type:"array",items:!0,minItems:1,uniqueItems:!0},type:{anyOf:[{$ref:"#/definitions/simpleTypes"},{type:"array",items:{$ref:"#/definitions/simpleTypes"},minItems:1,uniqueItems:!0}]},format:{type:"string"},contentMediaType:{type:"string"},contentEncoding:{type:"string"},if:{$ref:"#"},then:{$ref:"#"},else:{$ref:"#"},allOf:{$ref:"#/definitions/schemaArray"},anyOf:{$ref:"#/definitions/schemaArray"},oneOf:{$ref:"#/definitions/schemaArray"},not:{$ref:"#"}},default:!0};var si;function Co(){return si||(si=1,(function(s,e){Object.defineProperty(e,"__esModule",{value:!0}),e.MissingRefError=e.ValidationError=e.CodeGen=e.Name=e.nil=e.stringify=e.str=e._=e.KeywordCxt=e.Ajv=void 0;const t=Hi(),r=ko(),n=Ao(),i=Ro,o=["/properties"],a="http://json-schema.org/draft-07/schema";class c extends t.default{_addVocabularies(){super._addVocabularies(),r.default.forEach(P=>this.addVocabulary(P)),this.opts.discriminator&&this.addKeyword(n.default)}_addDefaultMetaSchema(){if(super._addDefaultMetaSchema(),!this.opts.meta)return;const P=this.opts.$data?this.$dataMetaSchema(i,o):i;this.addMetaSchema(P,a,!1),this.refs["http://json-schema.org/schema"]=a}defaultMeta(){return this.opts.defaultMeta=super.defaultMeta()||(this.getSchema(a)?a:void 0)}}e.Ajv=c,s.exports=e=c,s.exports.Ajv=c,Object.defineProperty(e,"__esModule",{value:!0}),e.default=c;var l=yt();Object.defineProperty(e,"KeywordCxt",{enumerable:!0,get:function(){return l.KeywordCxt}});var d=te();Object.defineProperty(e,"_",{enumerable:!0,get:function(){return d._}}),Object.defineProperty(e,"str",{enumerable:!0,get:function(){return d.str}}),Object.defineProperty(e,"stringify",{enumerable:!0,get:function(){return d.stringify}}),Object.defineProperty(e,"nil",{enumerable:!0,get:function(){return d.nil}}),Object.defineProperty(e,"Name",{enumerable:!0,get:function(){return d.Name}}),Object.defineProperty(e,"CodeGen",{enumerable:!0,get:function(){return d.CodeGen}});var m=mr();Object.defineProperty(e,"ValidationError",{enumerable:!0,get:function(){return m.default}});var v=wt();Object.defineProperty(e,"MissingRefError",{enumerable:!0,get:function(){return v.default}})})(dt,dt.exports)),dt.exports}var No=Co();const jo=rt(No),Oo={$schema:"http://json-schema.org/draft-07/schema#",title:"JMON Composition (Multi-Track, Extended)",description:"A declarative music format supporting synthesis, MIDI, score notation, key changes, arbitrary metadata, annotations, and custom presets. Time values use numeric format in quarter notes (e.g., 4.5) for MIDI compatibility and algorithmic processing. The bars:beats:ticks format is available for display and conversion purposes only.",type:"object",required:["format","version","tempo","tracks"],properties:JSON.parse(`{"format":{"type":"string","const":"jmon","description":"The format identifier for the JMON schema."},"version":{"type":"string","description":"JMON schema version."},"tempo":{"type":"number","minimum":20,"maximum":400,"description":"Tempo in beats per minute (BPM)."},"keySignature":{"type":"string","pattern":"^[A-G](#|b)?m?$","description":"Key signature (e.g., 'C', 'Am', 'F#')."},"keySignatureMap":{"type":"array","description":"Map of key signature changes over time.","items":{"type":"object","required":["time","keySignature"],"properties":{"time":{"oneOf":[{"type":"number","description":"Time in quarter notes (e.g., 8.0 for beat 1 of bar 3 in 4/4 time)."},{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Optional: Musical time in bars:beats:ticks format for display (e.g., '2:0:0')."}],"description":"Time of the key signature change."},"keySignature":{"type":"string","pattern":"^[A-G](#|b)?m?$","description":"New key signature at this time."}},"additionalProperties":false}},"timeSignature":{"type":"string","pattern":"^\\\\d+/\\\\d+$","description":"Time signature for the composition (e.g., '4/4')."},"tempoMap":{"type":"array","description":"Map of tempo changes over time.","items":{"type":"object","required":["time","tempo"],"properties":{"time":{"oneOf":[{"type":"number","description":"Time in quarter notes (e.g., 16.0 for beat 1 of bar 5 in 4/4 time)."},{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Optional: Musical time in bars:beats:ticks format for display (e.g., '4:0:0')."}],"description":"The time point for the tempo change."},"tempo":{"type":"number","minimum":20,"maximum":400,"description":"Tempo in beats per minute at this time point."}},"additionalProperties":false}},"transport":{"type":"object","description":"Settings controlling global playback and looping.","properties":{"startOffset":{"oneOf":[{"type":"number","description":"Offset in quarter notes for when playback should start (e.g., 2.0 for beat 3)."},{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Optional: Musical time in bars:beats:ticks format for display (e.g., '0:2:0')."}],"description":"Offset for when playback should start."},"globalLoop":{"type":"boolean","description":"Whether the entire project should loop."},"globalLoopEnd":{"oneOf":[{"type":"number","description":"End time in quarter notes where the global loop should end (e.g., 32.0 for bar 9 in 4/4)."},{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Optional: Musical time in bars:beats:ticks format for display (e.g., '8:0:0')."}],"description":"Where the global loop should end."},"swing":{"type":"number","minimum":0,"maximum":1,"description":"Swing amount (0-1)."}},"additionalProperties":false},"metadata":{"type":"object","description":"Metadata for the composition, allowing arbitrary fields.","properties":{"title":{"type":"string","description":"Title of the composition."},"composer":{"type":"string","description":"Composer of the music."},"description":{"type":"string","description":"Description of the composition."}},"additionalProperties":true},"customPresets":{"type":"array","description":"Array of custom user-defined presets for synths or effects.","items":{"type":"object","required":["id","type","options"],"properties":{"id":{"type":"string","description":"Unique identifier for this preset."},"type":{"type":"string","description":"Type of preset (e.g., 'Synth', 'Effect', 'Sampler')."},"options":{"type":"object","description":"Preset options."}},"additionalProperties":false}},"audioGraph":{"type":"array","description":"Audio node graph for synthesis. If not provided, a default synth->master setup will be created automatically.","default":[{"id":"synth","type":"Synth","options":{}},{"id":"master","type":"Destination","options":{}}],"items":{"type":"object","required":["id","type","options"],"properties":{"id":{"type":"string","description":"Unique identifier for this node."},"type":{"type":"string","enum":["Synth","PolySynth","MonoSynth","AMSynth","FMSynth","DuoSynth","PluckSynth","NoiseSynth","Sampler","Filter","AutoFilter","Reverb","FeedbackDelay","PingPongDelay","Delay","Chorus","Phaser","Tremolo","Vibrato","AutoWah","Distortion","Chebyshev","BitCrusher","Compressor","Limiter","Gate","FrequencyShifter","PitchShift","JCReverb","Freeverb","StereoWidener","MidSideCompressor","Destination"],"description":"Type of audio node (Synth, Sampler, Effect, etc.)."},"options":{"type":"object","description":"Options for this node. Content varies by node type."},"target":{"type":"string","description":"Target node for audio routing."},"presetRef":{"type":"string","description":"Reference to a custom preset."}},"allOf":[{"if":{"properties":{"type":{"const":"Sampler"}}},"then":{"properties":{"options":{"type":"object","properties":{"urls":{"type":"object","description":"Sample URLs for Sampler nodes (note -> file path mapping)","patternProperties":{"^[A-G](#|b)?[0-8]$":{"type":"string","description":"File path to sample for this note"}}},"envelope":{"type":"object","description":"Automatic envelope for Samplers to smooth attack/release","properties":{"enabled":{"type":"boolean","default":true,"description":"Whether to apply automatic envelope"},"attack":{"type":"number","minimum":0,"maximum":2,"default":0.02,"description":"Attack time in seconds"},"decay":{"type":"number","minimum":0,"maximum":2,"default":0.1,"description":"Decay time in seconds"},"sustain":{"type":"number","minimum":0,"maximum":1,"default":0.8,"description":"Sustain level (0-1)"},"release":{"type":"number","minimum":0,"maximum":5,"default":0.3,"description":"Release time in seconds"}},"additionalProperties":false}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"enum":["Synth","PolySynth","MonoSynth","AMSynth","FMSynth","DuoSynth","PluckSynth","NoiseSynth"]}}},"then":{"properties":{"options":{"type":"object","properties":{"oscillator":{"type":"object","description":"Oscillator settings for synths"},"envelope":{"type":"object","description":"ADSR envelope settings for synths"},"filter":{"type":"object","description":"Filter settings for synths"}},"additionalProperties":true}}}},{"if":{"properties":{"type":{"enum":["Reverb","JCReverb","Freeverb"]}}},"then":{"properties":{"options":{"type":"object","properties":{"wet":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Wet/dry mix (0=dry, 1=wet)"},"roomSize":{"type":"number","minimum":0,"maximum":1,"default":0.7,"description":"Room size for reverb effects"},"dampening":{"type":"number","minimum":0,"maximum":1,"default":0.3,"description":"Dampening for reverb effects"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"enum":["Delay","FeedbackDelay","PingPongDelay"]}}},"then":{"properties":{"options":{"type":"object","properties":{"wet":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Wet/dry mix (0=dry, 1=wet)"},"delayTime":{"type":"string","default":"8n","description":"Delay time (note values like '8n' or seconds)"},"feedback":{"type":"number","minimum":0,"maximum":0.95,"default":0.4,"description":"Feedback amount for delay effects"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"enum":["Filter","AutoFilter"]}}},"then":{"properties":{"options":{"type":"object","properties":{"frequency":{"type":"number","minimum":20,"maximum":20000,"default":1000,"description":"Filter frequency"},"Q":{"type":"number","minimum":0.1,"maximum":50,"default":1,"description":"Filter Q/resonance"},"type":{"type":"string","enum":["lowpass","highpass","bandpass","notch"],"default":"lowpass","description":"Filter type"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"enum":["Chorus","Phaser"]}}},"then":{"properties":{"options":{"type":"object","properties":{"wet":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Wet/dry mix (0=dry, 1=wet)"},"depth":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Modulation depth"},"rate":{"type":"string","default":"4n","description":"Modulation rate (note values or Hz)"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"enum":["Compressor","Limiter","Gate"]}}},"then":{"properties":{"options":{"type":"object","properties":{"threshold":{"type":"number","minimum":-60,"maximum":0,"default":-24,"description":"Threshold in dB"},"ratio":{"type":"number","minimum":1,"maximum":20,"default":4,"description":"Compression ratio"},"attack":{"type":"number","minimum":0,"maximum":1,"default":0.003,"description":"Attack time for compressor/gate"},"release":{"type":"number","minimum":0,"maximum":1,"default":0.1,"description":"Release time for compressor/gate"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"enum":["Distortion","Chebyshev"]}}},"then":{"properties":{"options":{"type":"object","properties":{"wet":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Wet/dry mix (0=dry, 1=wet)"},"distortion":{"type":"number","minimum":0,"maximum":1,"default":0.4,"description":"Distortion amount"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"const":"BitCrusher"}}},"then":{"properties":{"options":{"type":"object","properties":{"wet":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Wet/dry mix (0=dry, 1=wet)"},"bits":{"type":"number","minimum":1,"maximum":16,"default":4,"description":"Bit depth for BitCrusher"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"const":"Tremolo"}}},"then":{"properties":{"options":{"type":"object","properties":{"wet":{"type":"number","minimum":0,"maximum":1,"default":1,"description":"Wet/dry mix (0=dry, 1=wet)"},"frequency":{"type":"number","minimum":0.1,"maximum":20,"default":4,"description":"Tremolo frequency in Hz"},"depth":{"type":"number","minimum":0,"maximum":1,"default":0.5,"description":"Tremolo depth"}},"additionalProperties":false}}}},{"if":{"properties":{"type":{"const":"Destination"}}},"then":{"properties":{"options":{"type":"object","properties":{},"additionalProperties":false}}}}],"additionalProperties":false}},"connections":{"type":"array","description":"Array of audio graph connections. Each is a two-element array [source, target]. If not provided, default connections will be created automatically.","default":[["synth","master"]],"items":{"type":"array","minItems":2,"maxItems":2,"items":{"type":"string"}}},"tracks":{"type":"array","description":"Musical tracks (sequences or parts).","items":{"type":"object","required":["label","notes"],"properties":{"label":{"type":"string","description":"Label for this sequence (e.g., 'lead', 'bass', etc.)."},"midiChannel":{"type":"integer","minimum":0,"maximum":15,"description":"Default MIDI channel for this sequence (0-15)."},"synth":{"type":"object","required":["type"],"properties":{"type":{"type":"string","enum":["Synth","PolySynth","MonoSynth","AMSynth","FMSynth","DuoSynth","PluckSynth","NoiseSynth","Sampler"],"description":"Type of synthesizer (Synth, Sampler, AMSynth, FMSynth, etc.)."},"options":{"type":"object","description":"Synthesizer options."},"presetRef":{"type":"string","description":"Reference to a custom preset."},"modulationTarget":{"type":"string","enum":["vibrato","tremolo","glissando","filter"],"description":"Target for modulation wheel (CC1) control. Determines how modulation wheel affects the synth."}},"additionalProperties":false,"description":"Synthesizer definition for this sequence."},"synthRef":{"type":"string","description":"Reference to an audioGraph node to use as the synth."},"notes":{"type":"array","description":"Array of note events.","items":{"type":"object","required":["pitch","time","duration"],"properties":{"pitch":{"oneOf":[{"type":"number","description":"MIDI note number (preferred)."},{"type":"string","description":"Note name (e.g., 'C4', 'G#3')."},{"type":"array","description":"Chord (array of MIDI numbers or note names).","items":{"oneOf":[{"type":"number"},{"type":"string"}]}}]},"time":{"oneOf":[{"type":"number","description":"Time in quarter notes (e.g., 4.5 for beat 1.5 of bar 2 in 4/4). Primary format for MIDI compatibility."},{"type":"string","pattern":"^(\\\\d+n|\\\\d+t)$","description":"Tone.js note values (e.g., '4n', '8t') for relative timing."},{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Optional: Musical time in bars:beats:ticks format for display (e.g., '0:2:0', '1:3.5:240')."}]},"duration":{"oneOf":[{"type":"string","pattern":"^(\\\\d+n|\\\\d+t|\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+)$","description":"Musical duration using Tone.js note values (e.g., '4n', '8n', '2t') or bars:beats:ticks format (e.g., '1:0:0')."},{"type":"number","description":"Legacy: Duration in seconds (deprecated, use note values instead)."}]},"velocity":{"type":"number","minimum":0,"maximum":1,"description":"Note velocity (0-1)."},"articulation":{"type":"string","enum":["staccato","accent","tenuto","legato","marcato"],"description":"Performance instruction that affects how a note is played (e.g., 'staccato', 'accent')."},"ornaments":{"type":"array","description":"Array of melodic ornaments to apply to this note","items":{"type":"object","required":["type"],"properties":{"type":{"type":"string","enum":["grace_note","trill","mordent","turn","arpeggio"],"description":"Type of ornament"},"parameters":{"type":"object","description":"Parameters specific to this ornament type","oneOf":[{"if":{"properties":{"type":{"const":"grace_note"}}},"then":{"properties":{"graceNoteType":{"type":"string","enum":["acciaccatura","appoggiatura"],"description":"Type of grace note"},"gracePitches":{"type":"array","items":{"oneOf":[{"type":"number","description":"MIDI note number"},{"type":"string","description":"Note name (e.g., 'C4')"}]},"description":"Optional specific pitches for the grace note(s)"}},"required":["graceNoteType"]}},{"if":{"properties":{"type":{"const":"trill"}}},"then":{"properties":{"by":{"type":"number","default":1,"description":"Interval for the trill (in scale steps)"},"trillRate":{"type":"number","default":0.125,"description":"Duration of each note in the trill"}}}},{"if":{"properties":{"type":{"const":"mordent"}}},"then":{"properties":{"by":{"type":"number","default":1,"description":"Interval for the mordent (in scale steps)"}}}},{"if":{"properties":{"type":{"const":"turn"}}},"then":{"properties":{"scale":{"type":"string","description":"Optional scale context for the turn"}}}},{"if":{"properties":{"type":{"const":"arpeggio"}}},"then":{"properties":{"arpeggioDegrees":{"type":"array","items":{"type":"number"},"description":"Scale degrees for the arpeggio"},"direction":{"type":"string","enum":["up","down","both"],"default":"up","description":"Direction of the arpeggio"}},"required":["arpeggioDegrees"]}}]}},"additionalProperties":false}},"microtuning":{"type":"number","description":"Microtuning adjustment in semitones."},"channel":{"type":"integer","minimum":0,"maximum":15,"description":"Override sequence MIDI channel for this note (0-15)."},"modulations":{"type":"array","description":"Per-note modulation events (CC, pitch bend, aftertouch).","items":{"type":"object","required":["type","value","time"],"properties":{"type":{"type":"string","enum":["cc","pitchBend","aftertouch"],"description":"Type of MIDI modulation event."},"controller":{"type":"integer","description":"MIDI CC number (required for type: 'cc')."},"value":{"type":"number","description":"Value for this modulation: 0-127 for CC, -8192 to +8192 for pitchBend (14-bit, maps to 2 semitones), 0-127 for aftertouch."},"time":{"oneOf":[{"type":"string","pattern":"^(\\\\d+n|\\\\d+t|\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+)$","description":"Relative time using note values (e.g., '8n') or bars:beats:ticks (e.g., '0:0:240')."},{"type":"number","description":"Legacy: Relative time in seconds (deprecated)."}],"description":"When this modulation event happens (relative to note start)."}},"additionalProperties":false}}},"additionalProperties":false}},"loop":{"oneOf":[{"type":"boolean"},{"type":"string"}],"description":"Whether this sequence loops, or string for musical duration."},"loopEnd":{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format to end the loop (e.g., '4:0:0')."},"effects":{"type":"array","description":"Sequence-level effects.","items":{"type":"object","required":["type"],"properties":{"type":{"type":"string","description":"Type of effect (e.g., 'Reverb', 'Delay')."},"options":{"type":"object","description":"Options for this effect."},"presetRef":{"type":"string","description":"Reference to a custom preset."}},"additionalProperties":false}},"automation":{"type":"array","description":"Sequence-level automation channels affecting only this sequence.","items":{"$ref":"#/definitions/automationChannel"}}},"additionalProperties":false}},"automation":{"type":"object","description":"Multi-level automation system with interpolation support.","properties":{"enabled":{"type":"boolean","default":true,"description":"Whether automation is enabled globally."},"global":{"type":"array","description":"Global automation channels affecting the entire composition.","items":{"$ref":"#/definitions/automationChannel"}},"tracks":{"type":"object","description":"Sequence-level automation channels organized by sequence ID.","patternProperties":{".*":{"type":"array","description":"Automation channels for this sequence.","items":{"$ref":"#/definitions/automationChannel"}}},"additionalProperties":false},"events":{"type":"array","description":"Legacy automation events (deprecated, use channels instead).","items":{"type":"object","required":["target","time","value"],"properties":{"target":{"type":"string","description":"Parameter to automate, e.g., 'synth.frequency', 'effect.mix', 'midi.cc1'."},"time":{"oneOf":[{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format."},{"type":"number","description":"Legacy: Time in beats (deprecated)."}]},"value":{"type":"number","description":"Target value for the parameter."}},"additionalProperties":false}}},"additionalProperties":false},"annotations":{"type":"array","description":"Annotations (e.g., lyrics, rehearsal marks, comments) in the composition.","items":{"type":"object","required":["text","time"],"properties":{"text":{"type":"string","description":"Annotation text (e.g., lyric, instruction, label)."},"time":{"oneOf":[{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format (e.g., '1:2:0')."},{"type":"number","description":"Legacy: Time in beats (deprecated)."}]},"type":{"type":"string","description":"Type of annotation (e.g., 'lyric', 'marker', 'comment', 'rehearsal')."},"duration":{"oneOf":[{"type":"string","pattern":"^(\\\\d+n|\\\\d+t|\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+)$","description":"Musical duration using note values (e.g., '4n') or bars:beats:ticks (e.g., '1:0:0')."},{"type":"number","description":"Legacy: Duration in seconds (deprecated)."}],"description":"Optional duration for annotation (e.g., for lyrics or extended comments)."}},"additionalProperties":false}},"timeSignatureMap":{"type":"array","description":"Map of time signature changes over time.","items":{"type":"object","required":["time","timeSignature"],"properties":{"time":{"oneOf":[{"type":"string","pattern":"^\\\\d+:\\\\d+(\\\\.\\\\d+)?:\\\\d+$","description":"Musical time in bars:beats:ticks format (e.g., '8:0:0')."},{"type":"number","description":"Legacy: Time in beats (deprecated)."}],"description":"Time of the time signature change."},"timeSignature":{"type":"string","pattern":"^\\\\d+/\\\\d+$","description":"New time signature at this time."}},"additionalProperties":false}},"synthConfig":{"type":"object","description":"Global synthesizer configuration that applies to all tracks unless overridden.","properties":{"type":{"type":"string","enum":["Synth","PolySynth","MonoSynth","AMSynth","FMSynth","DuoSynth","PluckSynth","NoiseSynth","Sampler"],"description":"Default synthesizer type (Synth, Sampler, AMSynth, FMSynth, etc.)."},"modulationTarget":{"type":"string","enum":["vibrato","tremolo","glissando","filter"],"description":"Default target for modulation wheel (CC1) control across all tracks."},"options":{"type":"object","description":"Default synthesizer options applied globally.","properties":{"envelope":{"type":"object","description":"Automatic envelope settings for Samplers to avoid abrupt cuts","properties":{"enabled":{"type":"boolean","default":true,"description":"Whether to apply automatic envelope to Samplers"},"attack":{"type":"number","minimum":0,"maximum":2,"default":0.02,"description":"Attack time in seconds"},"decay":{"type":"number","minimum":0,"maximum":2,"default":0.1,"description":"Decay time in seconds"},"sustain":{"type":"number","minimum":0,"maximum":1,"default":0.8,"description":"Sustain level (0-1)"},"release":{"type":"number","minimum":0,"maximum":5,"default":0.3,"description":"Release time in seconds"}},"additionalProperties":false}}}},"additionalProperties":false},"converterHints":{"type":"object","description":"Optional hints to guide specific converters.","properties":{"tone":{"type":"object","description":"Hints for jmon-tone.js converter.","patternProperties":{"^cc[0-9]+$":{"type":"object","description":"Hint configuration for a MIDI CC controller mapping.","properties":{"target":{"type":"string","description":"Target for this CC mapping - can be legacy target (filter, vibrato, tremolo, glissando) or specific effect node ID from audioGraph."},"parameter":{"type":"string","description":"Parameter name to control on the target effect (e.g., 'frequency', 'depth', 'Q')."},"frequency":{"type":"number","description":"Modulation rate in Hz (for vibrato/tremolo)."},"depthRange":{"type":"array","description":"Min/max depth or frequency range for the parameter.","items":{"type":"number"},"minItems":2,"maxItems":2}},"required":["target"],"additionalProperties":false}},"additionalProperties":false},"midi":{"type":"object","description":"Hints for jmon-midi.js converter.","properties":{"channel":{"type":"integer","minimum":0,"maximum":15,"description":"Default MIDI channel for outgoing messages."},"port":{"type":"string","description":"MIDI port name or identifier."}},"additionalProperties":false}},"additionalProperties":false}}`),definitions:{automationChannel:{type:"object",description:"Automation channel with interpolation support and anchor points.",required:["id","target","anchorPoints"],properties:{id:{type:"string",description:"Unique identifier for this automation channel."},name:{type:"string",description:"Human-readable name for this automation channel."},target:{type:"string",description:"JMON target parameter (e.g., 'synth.frequency', 'midi.cc1', 'effect.mix')."},level:{type:"string",enum:["global","sequence","note"],default:"global",description:"Automation level: global (entire composition), sequence (per track), or note (per note velocity)."},sequenceId:{type:"string",description:"Target sequence ID for sequence-level automation."},range:{type:"array",items:{type:"number"},minItems:2,maxItems:2,default:[0,127],description:"Value range [min, max] for this automation parameter."},interpolation:{type:"string",enum:["linear","quadratic","cubic","daw"],default:"daw",description:"Interpolation type: linear, quadratic (curve), cubic (smoothstep), or daw (Hermite splines)."},enabled:{type:"boolean",default:!0,description:"Whether this automation channel is enabled."},anchorPoints:{type:"array",description:"Automation anchor points defining the curve.",items:{type:"object",required:["time","value"],properties:{time:{oneOf:[{type:"string",pattern:"^\\d+:\\d+(\\.\\d+)?:\\d+$",description:"Musical time in bars:beats:ticks format (e.g., '2:1:240')."},{type:"number",description:"Time in measures (e.g., 2.5 = 2 bars + 2 beats in 4/4)."}]},value:{type:"number",description:"Automation value at this time point."},tangent:{type:"number",description:"Optional tangent/slope for Hermite interpolation (DAW mode)."}},additionalProperties:!1}}},additionalProperties:!1}},additionalProperties:!1};function Io(s){const e=typeof s=="string"?parseInt(s,10):s;if(!Number.isFinite(e))return String(s);const r=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][(e%12+12)%12],n=Math.floor(e/12)-1;return`${r}${n}`}function ai(s){return!s||!Array.isArray(s.audioGraph)||s.audioGraph.forEach(e=>{try{if(!e||e.type!=="Sampler")return;const t=e.options||{},r=t.urls;if(!r||typeof r!="object")return;const n={};Object.keys(r).forEach(i=>{const o=String(i);let a=o;/^\d+$/.test(o)&&(a=Io(parseInt(o,10))),n[a]=r[i]}),e.options={...t,urls:n}}catch{}}),s}class $r{constructor(e=Oo){this.ajv=new jo({allErrors:!0,useDefaults:!0}),this.validate=this.ajv.compile(e)}validateAndNormalize(e){const t=JSON.parse(JSON.stringify(e));ai(t);const r=this.validate(t);return{valid:r,errors:this.validate.errors||null,normalized:r?t:null}}getValidJmon(e){const{valid:t,normalized:r}=this.validateAndNormalize(e);return t?r:null}}class ge{static chromatic_scale=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];static flat_to_sharp={Bb:"A#",Db:"C#",Eb:"D#",Gb:"F#",Ab:"G#","B":"A#","D":"C#","E":"D#","G":"F#","A":"G#","B-":"A#","D-":"C#","E-":"D#","G-":"F#","A-":"G#"};static scale_intervals={major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],diminished:[0,2,3,5,6,8,9,11],"major pentatonic":[0,2,4,7,9],"minor pentatonic":[0,3,5,7,10],chromatic:[0,1,2,3,4,5,6,7,8,9,10,11],lydian:[0,2,4,6,7,9,11],mixolydian:[0,2,4,5,7,9,10],dorian:[0,2,3,5,7,9,10],phrygian:[0,1,3,5,7,8,10],locrian:[0,1,3,5,6,8,10],"harmonic minor":[0,2,3,5,7,8,11],"melodic minor ascending":[0,2,3,5,7,9,11],"melodic minor descending":[0,2,3,5,7,8,10]};static intervals={P1:0,m2:1,M2:2,m3:3,M3:4,P4:5,P5:7,m6:8,M6:9,m7:10,M7:11,P8:12};static convertFlatToSharp(e){return this.flat_to_sharp[e]||e}static noteNameToMidi(e){const t=e.match(/^([A-G][#b-]?)(-?\d+)$/);if(!t)throw new Error(`Invalid note name format: ${e}`);const[,r,n]=t,i=this.convertFlatToSharp(r),o=this.chromatic_scale.indexOf(i);if(o===-1)throw new Error(`Invalid note name: ${r}`);return o+(parseInt(n)+1)*12}static midiToNoteName(e,t=!1){const r=Math.floor(e/12)-1,n=e%12;return`${this.chromatic_scale[n]}${r}`}static scaleToTriad(e){return[e[0],e[2],e[4]]}}class ci{constructor(e,t="major"){const r=ge.convertFlatToSharp(e);if(!ge.chromatic_scale.includes(r))throw new Error(`'${e}' is not a valid tonic note. Select one among '${ge.chromatic_scale.join(", ")}'.`);if(this.tonic=r,!Object.keys(ge.scale_intervals).includes(t))throw new Error(`'${t}' is not a valid scale. Select one among '${Object.keys(ge.scale_intervals).join(", ")}'.`);this.mode=t}generate(e={}){const t=ge.scale_intervals[this.mode];if(!t)return console.warn(`Unknown scale mode: ${this.mode}`),[];typeof e.start=="string"&&(e.start=ge.noteNameToMidi(e.start)),typeof e.end=="string"&&(e.end=ge.noteNameToMidi(e.end));const r=e.start??60;if(ge.chromatic_scale.indexOf(this.tonic)===-1)return console.warn(`Unknown tonic: ${this.tonic}`),[];const i=(a,c)=>{const l=c%t.length,d=Math.floor(c/t.length)*12,m=t[l];return a+m+d},o=[];if(e.end!==void 0)for(let a=0;;a++){const c=i(r,a);if(c>e.end)break;o.push(c)}else if(e.length)for(let a=0;a<e.length;a++)o.push(i(r,a));else return t.map(a=>r+a);return o}getNoteNames(){const e=ge.scale_intervals[this.mode];if(!e)return[];const t=ge.chromatic_scale.indexOf(this.tonic);return t===-1?[]:e.map(r=>{const n=(t+r)%12;return ge.chromatic_scale[n]})}isInScale(e){const t=e%12;return this.generate().map(n=>n%12).includes(t)}}function qo(s){if(typeof s=="object"&&!Array.isArray(s))return s;if(Array.isArray(s)){if(s.length===0)return{};if(s.every(t=>Array.isArray(t)&&t.length===3))return{"track 1":s};const e={};return s.forEach((t,r)=>{e[`track ${r+1}`]=t}),e}throw new Error("Input must be a list or dict of tracks.")}function li(s,e){return e.reduce((t,r)=>Math.abs(r-s)<Math.abs(t-s)?r:t)}function ui(s){return Math.floor(s/12)-1}function Do(s){return{"D-":"C#","E-":"D#","G-":"F#","A-":"G#","B-":"A#",Db:"C#",Eb:"D#",Gb:"F#",Ab:"G#",Bb:"A#"}[s]||s}function Pr(s,e,t){typeof s=="string"&&(s=st(s)),typeof t=="string"&&(t=st(t));const r=e.indexOf(t);if(e.includes(s))return e.indexOf(s)-r;{const n=li(s,e),i=e.indexOf(n),o=i>0?i-1:i,a=e[o],c=n-s,l=s-a,d=c+l;if(d===0)return i-r;const m=1-c/d,v=1-l/d,w=i-r,P=o-r;return w*m+P*v}}function zo(s,e,t){const r=e.indexOf(t),n=Math.round(r+s);if(n>=0&&n<e.length)return e[n];{const i=Math.max(0,Math.min(n,e.length-1)),o=Math.min(e.length-1,Math.max(n,0)),a=e[i],c=e[o],l=o-n,d=n-i,m=l+d;if(m===0)return(c+a)/2;const v=1-l/m,w=1-d/m;return c*v+a*w}}function di(s){s.length>0&&s[0].length===2&&(s=s.map(r=>[r[0],r[1],0]));const e=[];let t=0;for(const[r,n,i]of s)e.push([r,n,t]),t+=n;return e}function hi(s,e=0){const t=[...s].sort((i,o)=>i[2]-o[2]);let r=0;const n=[];for(const i of t){const[o,a,c]=i,l=e+c;if(l>r){const m=[null,l-r,r-e];n.push(m)}n.push(i),r=Math.max(r,l+a)}return n}function fi(s){s.sort((e,t)=>e[2]-t[2]);for(let e=0;e<s.length-1;e++){const t=s[e],r=s[e+1];if(t[2]+t[1]>r[2]){const i=r[2]-t[2];s[e]=[t[0],i,t[2]]}}return s}function Lo(s){return fi(hi(s))}function st(s){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],t={Db:"C#",Eb:"D#",Gb:"F#",Ab:"G#",Bb:"A#",Cb:"B"};let r=4,n=s;if(s.includes("b")){const a=s.slice(0,-1);t[a]&&(n=t[a]+s.slice(-1))}let i;return n.length>2||n.length===2&&!isNaN(n[1])?(i=n.slice(0,-1),r=parseInt(n.slice(-1))):i=n[0],12*(r+1)+e.indexOf(i)}function Vo(s){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],t=Math.floor(s/12)-1,r=s%12;return e[r]+t.toString()}function Fo(s,e="offsets"){const t=[];let r=0;for(const[n,i,o]of s)t.push([n,i,r]),r+=i;return t}function Go(s){return s.every(e=>Array.isArray(e))?"list of tuples":s.every(e=>!Array.isArray(e))?"list":"unknown"}function Bo(s,e,t,r=null,n=null){const i=r!==null?r:Math.min(...s),o=n!==null?n:Math.max(...s);return i===o?new Array(s.length).fill((e+t)/2):s.map(a=>(a-i)*(t-e)/(o-i)+e)}function pi(s,e){return s.map(([t,r,n])=>[t,r,n+e])}function Uo(s,e,t){const r=[];for(const[n,i,o]of s){const a=Math.round(o/t)*t,c=(Math.floor(a/e)+1)*e;let l=Math.round(i/t)*t;l=Math.min(l,c-a),l>0&&r.push([n,l,a])}return r}function Ko(s,e){const r=s.filter(([a,,c])=>a!==null&&c!==null).sort((a,c)=>a[2]-c[2]),n=Math.max(...r.map(([,,a])=>a)),i=Math.floor(n/e)+1,o=[];for(let a=0;a<i;a++){const c=a*e;let l=null,d=1/0;for(const[m,,v]of r){const w=c-v;if(w>=0&&w<d&&(d=w,l=m),v>c)break}l!==null&&o.push(l)}return o}function Yo(s,e){return e.reduce((t,r)=>Math.abs(r-s)<Math.abs(t-s)?r:t)}function Ho(s,e){return 60/e*s}function*Jo(s=0,e=1,t=0,r=1){for(;;)yield t+r*s,[s,e]=[e,s+e]}function Wo(s,e,t){const r={};for(const[n,i]of Object.entries(s)){const o=[];for(let a=0;a<e;a++){const c=a*t,l=pi(i,c);o.push(...l)}r[n]=o}return r}const Xo=Object.freeze(Object.defineProperty({__proto__:null,adjustNoteDurationsToPreventOverlaps:fi,cdeToMidi:st,checkInput:Go,fibonacci:Jo,fillGapsWithRests:hi,findClosestPitchAtMeasureStart:Ko,getDegreeFromPitch:Pr,getOctave:ui,getPitchFromDegree:zo,getSharp:Do,instrumentMapping:{"Acoustic Grand Piano":0,"Bright Acoustic Piano":1,"Electric Grand Piano":2,"Honky-tonk Piano":3,"Electric Piano 1":4,"Electric Piano 2":5,Harpsichord:6,Clavinet:7,Gunshot:127},midiToCde:Vo,noOverlap:Fo,offsetTrack:pi,qlToSeconds:Ho,quantizeNotes:Uo,repairNotes:Lo,repeatPolyloops:Wo,roundToList:li,scaleList:Bo,setOffsetsAccordingToDurations:di,tracksToDict:qo,tune:Yo},Symbol.toStringTag,{value:"Module"}));class Qo extends ge{constructor(e="C4",t="P5",r="chords",n=[3,3,1],i=null){if(super(),this.tonicMidi=st(e),this.circleOf=t,this.type=r,this.radius=n,this.weights=i||n,!Object.keys(this.intervals).includes(this.circleOf))throw new Error(`Select a circleOf among ${Object.keys(this.intervals).join(", ")}.`);if(!["chords","pitches"].includes(this.type))throw new Error("Type must either be 'pitches' or 'chords'.")}computeCircle(){const e=this.intervals[this.circleOf],t=[this.tonicMidi];for(let r=0;r<Math.max(...this.radius);r++){const n=(t[t.length-1]+e)%12+Math.floor(t[t.length-1]/12)*12;t.push(n)}return{major:t.slice(0,this.radius[0]),minor:t.slice(0,this.radius[1]),diminished:t.slice(0,this.radius[2])}}generateChord(e,t){return({major:[0,4,7],minor:[0,3,7],diminished:[0,3,6]}[t]||[0,4,7]).map(o=>e+o).map(o=>o>127?o-12:o)}generate(e=4,t=null){t!==null&&(Math.seedrandom=t);const{major:r,minor:n,diminished:i}=this.computeCircle(),o=[r,n,i],a=["major","minor","diminished"],c=[];for(let l=0;l<e;l++){const d=this.weightedRandomChoice(this.weights);if(o[d].length>0){const m=o[d][Math.floor(Math.random()*o[d].length)],v=a[d],w=Array.isArray(m)?m[0]:m,P=this.generateChord(w,v);c.push(P)}}return c}weightedRandomChoice(e){const t=e.reduce((n,i)=>n+i,0);let r=Math.random()*t;for(let n=0;n<e.length;n++)if(r-=e[n],r<=0)return n;return e.length-1}}class Zo extends ge{constructor(e="major",t="C",r=[0,2,4]){super(),this.tonic=t,this.scale=new ci(t,e).generate(),this.degrees=r}pitchToChord(e){const t=ui(e),r=this.tonic+t.toString(),n=st(r),i=this.scale.map(c=>Pr(c,this.scale,n)),o=Math.round(Pr(e,this.scale,n)),a=[];for(const c of this.degrees){const l=o+c,d=i.indexOf(l);d!==-1&&a.push(this.scale[d])}return a}generate(e,t=null,r=!1){if(!Array.isArray(e)||e.length===0)return[];let n=e;if(typeof e[0]=="number"){t===null&&(t=[1]);let o=0,a=0;n=e.map(c=>{const l=t[o%t.length],d=[c,l,a];return a+=l,o++,d})}const i=n.map(([o,a,c])=>[this.pitchToChord(o),a,c]);if(r){const o=[];for(const[a,c,l]of i){const d=c/a.length;a.forEach((m,v)=>{o.push([m,d,l+v*d])})}return o}else return i}}const mi={grace_note:{requiredParams:["graceNoteType"],optionalParams:["gracePitches"],conflicts:[],description:"Single note before the main note",defaultParams:{graceNoteType:"acciaccatura"},validate:(s,e)=>["acciaccatura","appoggiatura"].includes(e.graceNoteType)?e.gracePitches&&!Array.isArray(e.gracePitches)?{valid:!1,error:"gracePitches must be an array of pitches"}:{valid:!0}:{valid:!1,error:"graceNoteType must be either acciaccatura or appoggiatura"}},trill:{requiredParams:[],optionalParams:["by","trillRate"],conflicts:["mordent"],minDuration:"8n",description:"Rapid alternation between main note and auxiliary note",defaultParams:{by:1,trillRate:.125},validate:(s,e)=>e.by&&typeof e.by!="number"?{valid:!1,error:"trill step (by) must be a number"}:e.trillRate&&typeof e.trillRate!="number"?{valid:!1,error:"trillRate must be a number"}:{valid:!0}},mordent:{requiredParams:[],optionalParams:["by"],conflicts:["trill"],description:"Quick alternation with note above or below",defaultParams:{by:1},validate:(s,e)=>e.by&&typeof e.by!="number"?{valid:!1,error:"mordent step (by) must be a number"}:{valid:!0}},turn:{requiredParams:[],optionalParams:["scale"],conflicts:[],description:"Melodic turn around the main note",validate:(s,e)=>e.scale&&typeof e.scale!="string"?{valid:!1,error:"scale must be a string"}:{valid:!0}},arpeggio:{requiredParams:["arpeggioDegrees"],optionalParams:["direction"],conflicts:[],description:"Notes played in sequence",defaultParams:{direction:"up"},validate:(s,e)=>Array.isArray(e.arpeggioDegrees)?e.direction&&!["up","down","both"].includes(e.direction)?{valid:!1,error:"direction must be up, down, or both"}:{valid:!0}:{valid:!1,error:"arpeggioDegrees must be an array"}}};class Sr{static validateOrnament(e,t,r={}){const n={valid:!1,warnings:[],errors:[]},i=mi[t];if(!i)return n.errors.push(`Unknown ornament type: ${t}`),n;if(i.requiredParams){for(const o of i.requiredParams)if(!(o in r))return n.errors.push(`Missing required parameter '${o}' for ${t}`),n}if(i.minDuration&&n.warnings.push(`Duration check not implemented for ${t}`),e.ornaments&&i.conflicts){const o=e.ornaments.filter(a=>i.conflicts.includes(a.type)).map(a=>a.type);if(o.length>0)return n.errors.push(`${t} conflicts with existing ornaments: ${o.join(", ")}`),n}if(i.validate){const o=i.validate(e,r);if(!o.valid)return n.errors.push(o.error),n}return n.valid=!0,n}constructor(e){const t=mi[e.type];if(!t)throw new Error(`Unknown ornament type: ${e.type}`);this.type=e.type,this.params={...t.defaultParams,...e.parameters},e.tonic&&e.mode?(this.tonicIndex=ge.chromatic_scale.indexOf(e.tonic),this.scale=this.generateScale(e.tonic,e.mode)):this.scale=null}generateScale(e,t){const r=ge.scale_intervals[t],n=ge.chromatic_scale.indexOf(e),i=r.map(a=>(n+a)%12),o=[];for(let a=-1;a<10;a++)for(const c of i){const l=12*a+c;l>=0&&l<=127&&o.push(l)}return o}apply(e,t=null){if(!Array.isArray(e)||e.length===0||(t===null&&(t=Math.floor(Math.random()*e.length)),t<0||t>=e.length))return e;const r=e[t],n=Sr.validateOrnament(r,this.type,this.params);if(!n.valid)return console.warn(`Ornament validation failed: ${n.errors.join(", ")}`),e;switch(this.type){case"grace_note":return this.addGraceNote(e,t);case"trill":return this.addTrill(e,t);case"mordent":return this.addMordent(e,t);case"turn":return this.addTurn(e,t);case"arpeggio":return this.addArpeggio(e,t);default:return e}}addGraceNote(e,t){const r=e[t],n=r.pitch,i=r.duration,o=r.time,a=this.params.gracePitches?this.params.gracePitches[Math.floor(Math.random()*this.params.gracePitches.length)]:n+1;if(this.params.graceNoteType==="acciaccatura"){const c=i*.125,l={pitch:n,duration:i,time:o+c};return[...e.slice(0,t),{pitch:a,duration:c,time:o},l,...e.slice(t+1)]}else{const c=i/2,l={pitch:n,duration:c,time:o+c};return[...e.slice(0,t),{pitch:a,duration:c,time:o},l,...e.slice(t+1)]}}addTrill(e,t){const r=e[t],n=r.pitch,i=r.duration,o=r.time,a=[];let c=o;const l=this.params.by||1,d=this.params.trillRate||.125;let m;if(this.scale&&this.scale.includes(n)){const w=(this.scale.indexOf(n)+Math.round(l))%this.scale.length;m=this.scale[w]}else m=n+l;for(;c<o+i;){const v=o+i-c,w=Math.min(d,v/2);if(v>=w*2)a.push({pitch:n,duration:w,time:c}),a.push({pitch:m,duration:w,time:c+w}),c+=2*w;else break}return[...e.slice(0,t),...a,...e.slice(t+1)]}addMordent(e,t){const r=e[t],n=r.pitch,i=r.duration,o=r.time,a=this.params.by||1;let c;if(this.scale&&this.scale.includes(n)){const v=this.scale.indexOf(n)+Math.round(a);c=this.scale[v]||n+a}else c=n+a;const l=i/3,d=[{pitch:n,duration:l,time:o},{pitch:c,duration:l,time:o+l},{pitch:n,duration:l,time:o+2*l}];return[...e.slice(0,t),...d,...e.slice(t+1)]}addTurn(e,t){const r=e[t],n=r.pitch,i=r.duration,o=r.time,a=i/4;let c,l;if(this.scale&&this.scale.includes(n)){const m=this.scale.indexOf(n);c=this.scale[m+1]||n+2,l=this.scale[m-1]||n-2}else c=n+2,l=n-2;const d=[{pitch:n,duration:a,time:o},{pitch:c,duration:a,time:o+a},{pitch:n,duration:a,time:o+2*a},{pitch:l,duration:a,time:o+3*a}];return[...e.slice(0,t),...d,...e.slice(t+1)]}addArpeggio(e,t){const r=e[t],n=r.pitch,i=r.duration,o=r.time,{arpeggioDegrees:a,direction:c="up"}=this.params;if(!a||!Array.isArray(a))return e;const l=[];if(this.scale&&this.scale.includes(n)){const v=this.scale.indexOf(n);l.push(...a.map(w=>this.scale[v+w]||n+w))}else l.push(...a.map(v=>n+v));c==="down"&&l.reverse(),c==="both"&&l.push(...l.slice(0,-1).reverse());const d=i/l.length,m=l.map((v,w)=>({pitch:v,duration:d,time:o+w*d}));return[...e.slice(0,t),...m,...e.slice(t+1)]}}const Er={staccato:{complex:!1,description:"Shortens note duration to ~50%"},accent:{complex:!1,description:"Increases note velocity/emphasis"},tenuto:{complex:!1,description:"Holds note for full duration with emphasis"},legato:{complex:!1,description:"Smooth connection between notes"},marcato:{complex:!1,description:"Strong accent with slight separation"},glissando:{complex:!0,requiredParams:["target"],description:"Smooth slide from note to target pitch"},portamento:{complex:!0,requiredParams:["target"],optionalParams:["curve","speed"],description:"Expressive slide between pitches"},bend:{complex:!0,requiredParams:["amount"],optionalParams:["curve","returnToOriginal"],description:"Pitch bend up or down in cents"},vibrato:{complex:!0,optionalParams:["rate","depth","delay"],description:"Periodic pitch variation"},tremolo:{complex:!0,optionalParams:["rate","depth"],description:"Rapid volume variation"},crescendo:{complex:!0,requiredParams:["endVelocity"],optionalParams:["curve"],description:"Gradual volume increase"},diminuendo:{complex:!0,requiredParams:["endVelocity"],optionalParams:["curve"],description:"Gradual volume decrease"}};class tr{static addArticulation(e,t,r,n={}){const i={success:!1,warnings:[],errors:[]};if(!Array.isArray(e))return i.errors.push("Sequence must be an array"),i;if(r<0||r>=e.length)return i.errors.push(`Note index ${r} out of bounds (sequence length: ${e.length})`),i;const o=Er[t];if(!o)return i.errors.push(`Unknown articulation type: ${t}`),i;const a=e[r];return!a||typeof a!="object"?(i.errors.push(`Invalid note at index ${r}`),i):o.complex?this._addComplexArticulation(a,t,o,n,i):(a.articulation=t,i.success=!0,i)}static _addComplexArticulation(e,t,r,n,i){if(r.requiredParams){for(const o of r.requiredParams)if(!(o in n))return i.errors.push(`Missing required parameter '${o}' for ${t}`),i}switch(t){case"glissando":case"portamento":return this._applyGlissando(e,t,n,i);case"bend":return this._applyBend(e,n,i);case"vibrato":return this._applyVibrato(e,n,i);case"tremolo":return this._applyTremolo(e,n,i);case"crescendo":case"diminuendo":return this._applyDynamicChange(e,t,n,i);default:return i.errors.push(`Complex articulation ${t} not implemented`),i}}static _applyGlissando(e,t,r,n){e.articulation=t,e.glissTarget=r.target,e.modulations||(e.modulations=[]);const i={type:"pitch",subtype:t,target:r.target,curve:r.curve||"linear",timing:"note_duration"};return r.speed!==void 0&&(i.speed=r.speed),e.modulations=e.modulations.filter(o=>!(o.type==="pitch"&&o.subtype===t)),e.modulations.push(i),n.success=!0,n.warnings.push(`Added ${t} modulation synchronized with articulation`),n}static _applyBend(e,t,r){e.articulation="bend",e.modulations||(e.modulations=[]);const n={type:"pitch",subtype:"bend",amount:t.amount,curve:t.curve||"linear",timing:t.returnToOriginal?"note_duration":"sustain",returnToOriginal:t.returnToOriginal??!0};return e.modulations=e.modulations.filter(i=>!(i.type==="pitch"&&i.subtype==="bend")),e.modulations.push(n),r.success=!0,r.warnings.push("Added pitch bend modulation synchronized with articulation"),r}static _applyVibrato(e,t,r){e.articulation="vibrato",e.modulations||(e.modulations=[]);const n={type:"pitch",subtype:"vibrato",rate:t.rate||5,depth:t.depth||50,delay:t.delay||0,timing:"note_duration"};return e.modulations=e.modulations.filter(i=>!(i.type==="pitch"&&i.subtype==="vibrato")),e.modulations.push(n),r.success=!0,r.warnings.push("Added vibrato modulation synchronized with articulation"),r}static _applyTremolo(e,t,r){e.articulation="tremolo",e.modulations||(e.modulations=[]);const n={type:"amplitude",subtype:"tremolo",rate:t.rate||8,depth:t.depth||.3,timing:"note_duration"};return e.modulations=e.modulations.filter(i=>!(i.type==="amplitude"&&i.subtype==="tremolo")),e.modulations.push(n),r.success=!0,r.warnings.push("Added tremolo modulation synchronized with articulation"),r}static _applyDynamicChange(e,t,r,n){e.articulation=t,e.modulations||(e.modulations=[]);const i={type:"amplitude",subtype:t,startVelocity:e.velocity||.8,endVelocity:r.endVelocity,curve:r.curve||"linear",timing:"note_duration"};return e.modulations=e.modulations.filter(o=>!(o.type==="amplitude"&&(o.subtype==="crescendo"||o.subtype==="diminuendo"))),e.modulations.push(i),n.success=!0,n.warnings.push(`Added ${t} modulation synchronized with articulation`),n}static removeArticulation(e,t){if(!Array.isArray(e)||t<0||t>=e.length)return{success:!1,error:"Invalid sequence or note index"};const r=e[t];if(!r||typeof r!="object")return{success:!1,error:"Invalid note"};const n=r.articulation;if(delete r.articulation,delete r.glissTarget,r.modulations&&n){const i=Er[n];i&&i.complex&&(r.modulations=r.modulations.filter(o=>o.subtype!==n),r.modulations.length===0&&delete r.modulations)}return{success:!0,removed:n,message:`Removed ${n} articulation and related modulations`}}static validateSequence(e){const t=[];return e.forEach((r,n)=>{if(r.articulation){const i=this.ARTICULATION_TYPES[r.articulation];if(!i){t.push({type:"unknown_articulation",noteIndex:n,articulation:r.articulation,message:`Unknown articulation type: ${r.articulation}`});return}r.articulation==="glissando"&&!r.glissTarget&&t.push({type:"missing_parameter",noteIndex:n,articulation:r.articulation,message:"Glissando missing glissTarget parameter"}),i.complex&&r.modulations&&(r.modulations.some(a=>a.subtype===r.articulation)||t.push({type:"modulation_sync",noteIndex:n,articulation:r.articulation,message:`Complex articulation ${r.articulation} should have corresponding modulation`}))}}),{valid:t.length===0,issues:t}}static getAvailableTypes(){return Object.entries(Er).map(([e,t])=>({type:e,complex:t.complex,description:t.description,requiredParams:t.requiredParams||[],optionalParams:t.optionalParams||[]}))}}function gi(s,e,t,r){return tr.addArticulation(s,e,t,r)}function yi(s,e){return tr.removeArticulation(s,e)}function es(s){return tr.validateSequence(s)}const ts={Scale:ci,Progression:Qo,Voice:Zo,Ornament:Sr,Articulation:tr,addArticulation:gi,addOrnament:gi,removeArticulation:yi,removeOrnament:yi,validateArticulations:es};class rs{constructor(e,t){this.measureLength=e,this.durations=t}random(e=null,t=0,r=100){e!==null&&(Math.seedrandom=e);const n=[];let i=0,o=0;for(;i<this.measureLength&&o<r;){const a=this.durations[Math.floor(Math.random()*this.durations.length)];if(i+a>this.measureLength){o++;continue}if(Math.random()<t){o++;continue}n.push([a,i]),i+=a,o++}return o>=r&&console.warn("Max iterations reached. The sum of the durations may not equal the measure length."),n}darwin(e=null,t=10,r=50,n=.1){return new ns(e,t,this.measureLength,r,n,this.durations).generate()}}class ns{constructor(e,t,r,n,i,o){e!==null&&(Math.seedrandom=e),this.populationSize=t,this.measureLength=r,this.maxGenerations=n,this.mutationRate=i,this.durations=o,this.population=this.initializePopulation()}initializePopulation(){const e=[];for(let t=0;t<this.populationSize;t++)e.push(this.createRandomRhythm());return e}createRandomRhythm(){const e=[];let t=0;for(;t<this.measureLength;){const r=this.measureLength-t,n=this.durations[Math.floor(Math.random()*this.durations.length)];if(n<=r)e.push([n,t]),t+=n;else break}return e}evaluateFitness(e){const t=e.reduce((r,n)=>r+n[0],0);return Math.abs(this.measureLength-t)}selectParent(){const e=this.population[Math.floor(Math.random()*this.population.length)],t=this.population[Math.floor(Math.random()*this.population.length)];return this.evaluateFitness(e)<this.evaluateFitness(t)?e:t}crossover(e,t){if(e.length===0||t.length===0)return e.length>0?[...e]:[...t];const r=Math.floor(Math.random()*(e.length-1))+1,n=[...e.slice(0,r),...t.slice(r)];return this.ensureMeasureLength(n)}ensureMeasureLength(e){return e.reduce((r,n)=>r+n[0],0)>this.measureLength&&e.length>0&&e.pop(),e}mutate(e){if(Math.random()<this.mutationRate&&e.length>1){const t=Math.floor(Math.random()*(e.length-1)),[r,n]=e[t],o=(t===e.length-1?this.measureLength:e[t+1][1])-n,a=this.durations.filter(c=>c<=o);if(a.length>0){const c=a[Math.floor(Math.random()*a.length)];e[t]=[c,n]}}return e}generate(){for(let t=0;t<this.maxGenerations;t++){const r=[];for(let n=0;n<this.populationSize;n++){const i=this.selectParent(),o=this.selectParent();let a=this.crossover(i,o);a=this.mutate(a),a.sort((c,l)=>c[1]-l[1]),r.push(a)}this.population=r}return this.population.reduce((t,r)=>this.evaluateFitness(r)<this.evaluateFitness(t)?r:t).sort((t,r)=>t[1]-r[1])}}function Ne(s,e=4,t=480){const r=Math.floor(s/e),n=s-r*e,i=Math.floor(n),o=n-i,a=Math.round(o*t);return`${r}:${i}:${a}`}function Je(s,e=4,t=480){if(typeof s=="number")return s;if(typeof s!="string")return 0;const r=s.split(":").map(a=>parseFloat(a||"0")),[n=0,i=0,o=0]=r;return n*e+i+o/t}function bi(s,e="Untitled Part",t={}){const r=Tr(s);return{name:e,notes:r,...t}}function is(s,e={}){const t=s.map((n,i)=>Array.isArray(n)?bi(n,`Track ${i+1}`):n.name&&n.notes?{...n,notes:Tr(n.notes)}:n),r={format:"jmon",version:"1.0",bpm:e.bpm||120,keySignature:e.keySignature||"C",timeSignature:e.timeSignature||"4/4",tracks:t,...e};return delete r.metadata?.bpm,delete r.metadata?.keySignature,delete r.metadata?.timeSignature,r}function Tr(s){return Array.isArray(s)?s.map((e,t)=>{if(Array.isArray(e)){const[r,n,i=0]=e;return{pitch:r,duration:n,time:Ne(i)}}if(typeof e=="object"&&e!==null){const{pitch:r,duration:n}=e;let i="0:0:0";return typeof e.time=="string"?i=e.time:typeof e.time=="number"?i=Ne(e.time):typeof e.offset=="number"&&(i=Ne(e.offset)),{pitch:r,duration:n,time:i,...Object.fromEntries(Object.entries(e).filter(([o])=>!["time","offset"].includes(o)))}}return console.warn(`Unexpected note format at index ${t}:`,e),{pitch:60,duration:1,time:"0:0:0"}}):[]}function os(s){return s.map(([e,t,r=0])=>({pitch:e,duration:t,time:Ne(r)}))}function ss(s){return s.map(e=>[e.pitch,e.duration,Je(e.time)])}function as(s,e=1,t=0){let r=t;return s.map(n=>{const i={pitch:n,duration:e,time:Ne(r)};return r+=e,i})}function vi(s,e){return s.map(t=>({...t,time:Ne(Je(t.time)+e)}))}function cs(s){if(s.length===0)return[];const e=[];let t=0;for(const r of s){const n=vi(r,t);e.push(...n);const i=n.map(o=>Je(o.time)+o.duration);t=Math.max(...i,t)}return e}function ls(s){return s.flat()}function us(s){if(s.length===0)return{start:0,end:0,duration:0};const e=s.map(i=>Je(i.time)),t=s.map(i=>Je(i.time)+i.duration),r=Math.min(...e),n=Math.max(...t);return{start:r,end:n,duration:n-r,startTime:Ne(r),endTime:Ne(n)}}const ds=Object.freeze(Object.defineProperty({__proto__:null,beatsToTime:Ne,combineSequences:ls,concatenateSequences:cs,createComposition:is,createPart:bi,createScale:as,getTimingInfo:us,jmonToTuples:ss,normalizeNotes:Tr,offsetNotes:vi,timeToBeats:Je,tuplesToJmon:os},Symbol.toStringTag,{value:"Module"}));function hs(s,e,t={}){const r=s.map(l=>Array.isArray(l)||typeof l=="object"&&l.length?l[0]:l),n=fs(r.length,e.length),i=[],o=[];for(let l=0;l<n;l++)i.push(r[l%r.length]),o.push(e[l%e.length]);const a=i.map((l,d)=>[l,o[d],1]),c=di(a);return t.legacy?c:c.map(([l,d,m])=>({pitch:l,duration:d,time:t.useStringTime?Ne(m):m}))}function fs(s,e){const t=(r,n)=>n===0?r:t(n,r%n);return Math.abs(s*e)/t(s,e)}function ps(s,e){const t=[];let r=0,n=0;for(const i of s){const o=e[n%e.length];t.push([i,o,r]),r+=o,n++}return t}const ms={Rhythm:rs,isorhythm:hs,beatcycle:ps};class gs{constructor(){}}class je{data;constructor(e,t){if(typeof e=="number"){if(t===void 0)throw new Error("Columns parameter required when creating matrix from dimensions");this.rows=e,this.columns=t,this.data=Array(this.rows).fill(0).map(()=>Array(this.columns).fill(0))}else this.data=e.map(r=>[...r]),this.rows=this.data.length,this.columns=this.data[0]?.length||0}static zeros(e,t){return new je(e,t)}static from2DArray(e){return new je(e)}get(e,t){if(e<0||e>=this.rows||t<0||t>=this.columns)throw new Error(`Index out of bounds: (${e}, ${t})`);return this.data[e][t]}set(e,t,r){if(e<0||e>=this.rows||t<0||t>=this.columns)throw new Error(`Index out of bounds: (${e}, ${t})`);this.data[e][t]=r}getRow(e){if(e<0||e>=this.rows)throw new Error(`Row index out of bounds: ${e}`);return[...this.data[e]]}getColumn(e){if(e<0||e>=this.columns)throw new Error(`Column index out of bounds: ${e}`);return this.data.map(t=>t[e])}transpose(){const e=Array(this.columns).fill(0).map(()=>Array(this.rows).fill(0));for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)e[r][t]=this.data[t][r];return new je(e)}clone(){return new je(this.data)}toArray(){return this.data.map(e=>[...e])}}function xr(s){return Array.isArray(s[0])?je.from2DArray(s):je.from2DArray([s])}function wi(s){if(s.rows!==s.columns)throw new Error("Matrix must be square for Cholesky decomposition");const e=s.rows,t=je.zeros(e,e);for(let r=0;r<e;r++)for(let n=0;n<=r;n++)if(r===n){let i=0;for(let a=0;a<n;a++)i+=t.get(n,a)*t.get(n,a);const o=s.get(n,n)-i;if(o<=0)throw new Error(`Matrix is not positive definite at position (${n}, ${n})`);t.set(n,n,Math.sqrt(o))}else{let i=0;for(let o=0;o<n;o++)i+=t.get(r,o)*t.get(n,o);t.set(r,n,(s.get(r,n)-i)/t.get(n,n))}return t}class ys{constructor(e={}){this.params={...e}}call(e,t){const r=t||e,n=je.zeros(e.rows,r.rows);for(let i=0;i<e.rows;i++)for(let o=0;o<r.rows;o++)n.set(i,o,this.compute(e.getRow(i),r.getRow(o)));return n}getParams(){return{...this.params}}setParams(e){Object.assign(this.params,e)}euclideanDistance(e,t){let r=0;for(let n=0;n<e.length;n++)r+=Math.pow(e[n]-t[n],2);return Math.sqrt(r)}squaredEuclideanDistance(e,t){let r=0;for(let n=0;n<e.length;n++)r+=Math.pow(e[n]-t[n],2);return r}}class _i{kernel;alpha;XTrain;yTrain;L;alphaVector;constructor(e,t={}){this.kernel=e,this.alpha=t.alpha||1e-10}fit(e,t){this.XTrain=xr(e),this.yTrain=[...t];const r=this.kernel.call(this.XTrain);for(let n=0;n<r.rows;n++)r.set(n,n,r.get(n,n)+this.alpha);try{this.L=wi(r)}catch(n){throw new Error(`Failed to compute Cholesky decomposition: ${n instanceof Error?n.message:"Unknown error"}`)}this.alphaVector=this.solveCholesky(this.L,this.yTrain)}predict(e,t=!1){if(!this.XTrain||!this.yTrain||!this.L||!this.alphaVector)throw new Error("Model must be fitted before prediction");const r=xr(e),n=this.kernel.call(this.XTrain,r),i=new Array(r.rows);for(let a=0;a<r.rows;a++){i[a]=0;for(let c=0;c<this.XTrain.rows;c++)i[a]+=n.get(c,a)*this.alphaVector[c]}const o={mean:i};if(t){const a=this.computeStd(r,n);o.std=a}return o}sampleY(e,t=1){if(!this.XTrain||!this.yTrain||!this.L||!this.alphaVector)throw new Error("Model must be fitted before sampling");const r=xr(e),n=this.predict(e,!0);if(!n.std)throw new Error("Standard deviation computation failed");const i=[];for(let o=0;o<t;o++){const a=new Array(r.rows);for(let c=0;c<r.rows;c++){const l=n.mean[c],d=n.std[c];a[c]=l+d*this.sampleStandardNormal()}i.push(a)}return i}logMarginalLikelihood(){if(!this.XTrain||!this.yTrain||!this.L||!this.alphaVector)throw new Error("Model must be fitted before computing log marginal likelihood");let e=0;for(let t=0;t<this.yTrain.length;t++)e-=.5*this.yTrain[t]*this.alphaVector[t];for(let t=0;t<this.L.rows;t++)e-=Math.log(this.L.get(t,t));return e-=.5*this.yTrain.length*Math.log(2*Math.PI),e}computeStd(e,t){if(!this.L)throw new Error("Cholesky decomposition not available");const r=new Array(e.rows);for(let n=0;n<e.rows;n++){const i=this.kernel.compute(e.getRow(n),e.getRow(n)),o=t.getColumn(n),a=this.forwardSubstitution(this.L,o);let c=0;for(let d=0;d<a.length;d++)c+=a[d]*a[d];const l=i-c;r[n]=Math.sqrt(Math.max(0,l))}return r}solveCholesky(e,t){const r=this.forwardSubstitution(e,t);return this.backSubstitution(e,r)}forwardSubstitution(e,t){const r=e.rows,n=new Array(r);for(let i=0;i<r;i++){n[i]=t[i];for(let o=0;o<i;o++)n[i]-=e.get(i,o)*n[o];n[i]/=e.get(i,i)}return n}backSubstitution(e,t){const r=e.rows,n=new Array(r);for(let i=r-1;i>=0;i--){n[i]=t[i];for(let o=i+1;o<r;o++)n[i]-=e.get(o,i)*n[o];n[i]/=e.get(i,i)}return n}sampleStandardNormal(){const e=Math.random(),t=Math.random();return Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*t)}}class $i extends ys{constructor(e=1,t=1){super({length_scale:e,variance:t}),this.lengthScale=e,this.variance=t}compute(e,t){const r=this.euclideanDistance(e,t);return this.variance*Math.exp(-.5*Math.pow(r/this.lengthScale,2))}getParams(){return{length_scale:this.lengthScale,variance:this.variance}}}function bs(s=0,e=1){const t=Math.random(),r=Math.random(),n=Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*r);return s+e*n}function vs(s,e){const t=s.length,r=wi(e),n=Array.from({length:t},()=>bs()),i=new Array(t);for(let o=0;o<t;o++){i[o]=s[o];for(let a=0;a<=o;a++)i[o]+=r.get(o,a)*n[a]}return i}const Oe={timeSignature:[4,4],ticksPerQuarterNote:480,beatsPerBar:4};function We(s,e=Oe){const{timeSignature:t,ticksPerQuarterNote:r}=e,[n,i]=t,o=n*4/i,a=Math.floor(s/o),c=s%o,l=Math.floor(c),d=c-l,m=Math.round(d*r);return`${a}:${l}:${m}`}function kr(s,e=Oe){const{timeSignature:t,ticksPerQuarterNote:r}=e,[n,i]=t,o=s.split(":");if(o.length!==3)throw new Error(`Invalid bars:beats:ticks format: ${s}`);const a=parseInt(o[0],10),c=parseFloat(o[1]),l=parseInt(o[2],10);if(isNaN(a)||isNaN(c)||isNaN(l))throw new Error(`Invalid numeric values in bars:beats:ticks: ${s}`);const d=n*4/i;return a*d+c+l/r}function ws(s,e=Oe,t=!0){return s.map(r=>{const n={...r};if(r.offset!==void 0&&(n.time=r.offset,delete n.offset),typeof r.time=="string"&&r.time.includes(":")&&(n.time=kr(r.time,e)),typeof r.duration=="number"&&!t){const i=r.duration;i===1?n.duration="4n":i===.5?n.duration="8n":i===.25?n.duration="16n":i===2?n.duration="2n":i===4&&(n.duration="1n")}return n})}function at(s,e={}){const{label:t="track",midiChannel:r=0,synth:n={type:"Synth"},timingConfig:i=Oe,keepNumericDuration:o=!0}=e,a=ws(s,i,o);return{label:t,midiChannel:r,synth:n,notes:a}}class _s{data;lengthScale;amplitude;noiseLevel;walkAround;timingConfig;isFitted;gpr;constructor(e=[],t=1,r=1,n=.1,i=!1,o=Oe){this.data=[...e],this.lengthScale=t,this.amplitude=r,this.noiseLevel=n,this.walkAround=i,this.timingConfig=o,this.isFitted=!1,this.gpr=null}generate(e={}){e.length,e.nsamples;const t=e.seed;return e.useStringTime,t!==void 0&&(Math.seedrandom=this.seededRandom(t)),this.data.length>0&&Array.isArray(this.data[0])?this.generateFitted(e):this.generateUnfitted(e)}generateUnfitted(e={}){const t=e.length||100,r=e.nsamples||1,n=e.lengthScale||this.lengthScale,i=e.amplitude||this.amplitude,o=e.noiseLevel||this.noiseLevel;e.useStringTime;const a=[];for(let c=0;c<r;c++){const l=Array.from({length:t},(g,h)=>[h]),d=new je(l),v=new $i(n,i).call(d);for(let g=0;g<v.rows;g++)v.set(g,g,v.get(g,g)+o);let w=new Array(t).fill(this.walkAround||0);this.walkAround&&typeof this.walkAround=="number"&&(w=new Array(t).fill(this.walkAround));const P=vs(w,v);a.push(P)}return r===1?a[0]:a}generateFitted(e={}){const t=e.length||100,r=e.nsamples||1,n=e.lengthScale||this.lengthScale,i=e.amplitude||this.amplitude,o=this.data.map(g=>[g[0]]),a=this.data.map(g=>g[1]),c=new $i(n,i);this.gpr=new _i(c);try{this.gpr.fit(o,a),this.isFitted=!0}catch(g){throw new Error(`Failed to fit Gaussian Process: ${g.message}`)}const l=Math.min(...this.data.map(g=>g[0])),m=(Math.max(...this.data.map(g=>g[0]))-l)/(t-1),v=Array.from({length:t},(g,h)=>[l+h*m]),w=this.gpr.sampleY(v,r),P=v.map(g=>g[0]);return r===1?[P,w[0]]:[P,w]}rbfKernel(e,t){let r=0;for(let n=0;n<e.length;n++)r+=Math.pow(e[n]-t[n],2);return this.amplitude*Math.exp(-r/(2*Math.pow(this.lengthScale,2)))}setData(e){this.data=[...e]}getData(){return[...this.data]}setLengthScale(e){this.lengthScale=e}setAmplitude(e){this.amplitude=e}setNoiseLevel(e){this.noiseLevel=e}toJmonNotes(e,t=[1],r=null,n={}){const{useStringTime:i=!1,mapToScale:o=null,scaleRange:a=[60,72],quantize:c=!1}=n,l=[];let d=0;const m=Array.isArray(e[0])?e:[e],v=r||Array.from({length:m[0].length},(w,P)=>P);for(let w=0;w<m[0].length;w++){const P=t[w%t.length],g=r?v[w]:d,h=m.map(u=>{let f=u[w];if(o){const y=Math.min(...u),b=Math.max(...u)-y||1,S=(f-y)/b,x=Math.floor(S*o.length),N=Math.max(0,Math.min(x,o.length-1));f=o[N]}else{const y=Math.min(...u),b=Math.max(...u)-y||1,S=(f-y)/b;f=a[0]+S*(a[1]-a[0])}return c&&(f=Math.round(f)),f}),p=h.length===1?h[0]:h;l.push({pitch:p,duration:P,time:i?We(g,this.timingConfig):g}),r||(d+=P)}return l}generateTrack(e={},t={}){const r=this.generate(e),n=e.durations||[1];let i;if(this.isFitted||this.data.length>0&&Array.isArray(this.data[0])){const[o,a]=r;i=this.toJmonNotes(a,n,o,e)}else i=this.toJmonNotes(r,n,null,e);return at(i,{label:"gaussian-process",midiChannel:0,synth:{type:"Synth"},...t})}seededRandom(e){return function(){return e=(e*9301+49297)%233280,e/233280}}}class $s{constructor(e={}){this.width=e.width||51,this.ruleNumber=e.ruleNumber||30,this.initialState=e.initialState||this.generateRandomInitialState(),this.state=[...this.initialState],this.rules=this.loadRules(this.ruleNumber),this.history=[]}generate(e){this.history=[],this.state=[...this.initialState],this.history.push([...this.state]);for(let t=0;t<e;t++)this.updateState(),this.history.push([...this.state]);return this.history}generate01(e){return this.generate(e).map(r=>r.map(n=>n>0?1:0))}loadRules(e){const t=e.toString(2).padStart(8,"0"),r={},n=["111","110","101","100","011","010","001","000"];for(let i=0;i<8;i++)r[n[i]]=parseInt(t[i],10);return r}updateState(){const e=new Array(this.width);for(let t=0;t<this.width;t++){const r=this.state[(t-1+this.width)%this.width],n=this.state[t],i=this.state[(t+1)%this.width],o=`${r}${n}${i}`;e[t]=this.rules[o]||0}this.state=e}validateStrips(e){if(!Array.isArray(e)||e.length===0)return!1;const t=e[0]?.length;return t?e.every(r=>Array.isArray(r)&&r.length===t&&r.every(n=>typeof n=="number"&&(n===0||n===1))):!1}validateValues(e){return Array.isArray(e)&&e.length===this.width&&e.every(t=>typeof t=="number"&&(t===0||t===1))}setInitialState(e){if(this.validateValues(e))this.initialState=[...e],this.state=[...e];else throw new Error("Invalid initial state")}setRuleNumber(e){if(e>=0&&e<=255)this.ruleNumber=e,this.rules=this.loadRules(e);else throw new Error("Rule number must be between 0 and 255")}getHistory(){return this.history.map(e=>[...e])}getCurrentState(){return[...this.state]}generateRandomInitialState(){const e=new Array(this.width).fill(0);return e[Math.floor(this.width/2)]=1,e}generateRandomState(){return Array.from({length:this.width},()=>Math.random()>.5?1:0)}plot(){return{data:this.getHistory(),width:this.width,height:this.history.length}}async plotEvolution(e){return(await Promise.resolve().then(()=>zr)).CAVisualizer.plotEvolution(this.getHistory(),e)}async plotGeneration(e){return(await Promise.resolve().then(()=>zr)).CAVisualizer.plotGeneration(this.getCurrentState(),e)}async plotDensity(e){return(await Promise.resolve().then(()=>zr)).CAVisualizer.plotDensity(this.getHistory(),e)}}class rr{constructor(e,t=4,r=!0){if(!e)throw new Error("Loops parameter is required");if(typeof t!="number"||t<=0)throw new Error("measureLength must be a positive number");if(typeof r!="boolean")throw new Error("insertRests must be a boolean");if(this.measureLength=t,Array.isArray(e)){if(e.length===0)throw new Error("Loops array cannot be empty");const n={};e.forEach((i,o)=>{const a=i?.label||`Loop ${o+1}`;n[a]=i}),e=n}if(typeof e!="object"||Object.keys(e).length===0)throw new Error("Loops must be a non-empty object or array");this.loops={};for(const[n,i]of Object.entries(e)){if(!i)throw new Error(`Loop data for "${n}" is null or undefined`);const o=Array.isArray(i)?i:i.notes||[];if(!Array.isArray(o))throw new Error(`Notes for loop "${n}" must be an array`);const a=o.map((c,l)=>{if(!c||typeof c!="object")throw new Error(`Note ${l} in loop "${n}" must be an object`);if(c.pitch!==null&&(typeof c.pitch!="number"||c.pitch<0||c.pitch>127))throw new Error(`Note ${l} in loop "${n}" has invalid pitch: ${c.pitch}`);if(typeof c.time!="number"||c.time<0)throw new Error(`Note ${l} in loop "${n}" has invalid time: ${c.time}`);if(typeof c.duration!="number"||c.duration<=0)throw new Error(`Note ${l} in loop "${n}" has invalid duration: ${c.duration}`);return{pitch:c.pitch,time:c.time,duration:c.duration,velocity:typeof c.velocity=="number"?Math.max(0,Math.min(1,c.velocity)):.8}});this.loops[n]={label:i.label||n,notes:r?this.fillGapsWithRests(a):a,synth:i.synth||{type:"Synth",options:{oscillator:{type:"sine"},envelope:{attack:.01,decay:.1,sustain:.3,release:.5}}}}}}fillGapsWithRests(e){if(e.length===0)return e;const t=[];let r=0;const n=[...e].sort((i,o)=>i.time-o.time);for(const i of n)i.time>r&&t.push({pitch:null,duration:i.time-r,time:r,velocity:0}),t.push({pitch:i.pitch,duration:i.duration,time:i.time,velocity:i.velocity||.8}),r=i.time+i.duration;return t}static fromTrack(e,t=4){if((e.notes||[]).length===0)throw new Error("Track must have notes to create loop");return new rr({[e.label||"Track"]:e},t)}static euclidean(e,t,r=[60],n=null){if(typeof e!="number"||e<=0||!Number.isInteger(e))throw new Error("beats must be a positive integer");if(typeof t!="number"||t<0||!Number.isInteger(t))throw new Error("pulses must be a non-negative integer");if(t>e)throw new Error("pulses cannot be greater than beats");if(!Array.isArray(r)||r.length===0)throw new Error("pitches must be a non-empty array");const i=this.generateEuclideanRhythm(e,t),o=[],a=1;i.forEach((l,d)=>{if(l){const m=d*a,v=r[d%r.length];o.push({pitch:v,duration:a*.8,time:m,velocity:.8})}});const c={label:n||`Euclidean ${t}/${e}`,notes:o,synth:{type:"Synth",options:{oscillator:{type:"sine"},envelope:{attack:.01,decay:.1,sustain:.3,release:.5}}}};return new rr({[c.label]:c},e)}static generateEuclideanRhythm(e,t){if(t===0)return Array(e).fill(!1);if(t>=e)return Array(e).fill(!0);let r=[{pattern:[1],count:t},{pattern:[0],count:e-t}];for(;r.length>1;){const[o,a]=r;if(o.count<=a.count){const c=o.count,l=a.count-o.count;r=[{pattern:[...a.pattern,...o.pattern],count:c}],l>0&&r.push({pattern:a.pattern,count:l})}else{const c=a.count,l=o.count-a.count;r=[{pattern:[...o.pattern,...a.pattern],count:c}],l>0&&r.push({pattern:o.pattern,count:l})}}const n=r[0],i=[];for(let o=0;o<n.count;o++)i.push(...n.pattern);return i.map(o=>o===1)}toJMonSequences(){return Object.values(this.loops)}async plot(e=1/4,t=null,r={}){const{LoopVisualizer:n}=await Promise.resolve().then(()=>Ni);return n.plotLoops(this.loops,this.measureLength,e,t,r)}}class nr{constructor(e){this.sequence=e.filter(t=>t!=null),this.originalSequence=e}gini(){if(this.sequence.length===0)return 0;const e=[...this.sequence].sort((i,o)=>i-o),t=e.length;let r=0;for(let i=0;i<t;i++)r+=(2*(i+1)-t-1)*e[i];const n=e.reduce((i,o)=>i+o,0);return n===0?0:r/(t*n)}balance(){if(this.sequence.length===0)return 0;const e=this.sequence.reduce((r,n)=>r+n,0)/this.sequence.length,t=this.sequence.reduce((r,n)=>r+Math.pow(n-e,2),0)/this.sequence.length;return e===0?0:Math.sqrt(t)/Math.abs(e)}motif(e=4){if(this.sequence.length<2)return 0;const t=new Map;let r=0;for(let i=2;i<=Math.min(e,this.sequence.length);i++)for(let o=0;o<=this.sequence.length-i;o++){const a=this.sequence.slice(o,o+i).join(",");t.set(a,(t.get(a)||0)+1),r++}let n=0;for(const i of t.values())i>1&&(n+=i*i);return r===0?0:n/r}dissonance(e){if(!e||e.length===0||this.sequence.length===0)return 0;const t=new Set(e.map(n=>n%12));let r=0;for(const n of this.sequence)if(n!=null){const i=n%12;t.has(i)||r++}return r/this.sequence.length}rhythmic(e=4){if(this.sequence.length===0)return 0;let t=0,r=0;const n=this.sequence.reduce((i,o)=>i+o,0);for(const i of this.sequence){const o=t+i,a=Math.floor(t/e),c=Math.floor(o/e);if(a!==c){const l=e-t%e;l<i&&l>0&&(r+=Math.min(l,i-l))}t=o}return n===0?0:1-r/n}restProportion(){return this.originalSequence.length===0?0:this.originalSequence.filter(t=>t==null).length/this.originalSequence.length}calculateAll(e=null,t=4){return{gini:this.gini(),balance:this.balance(),motif:this.motif(),dissonance:e?this.dissonance(e):0,rhythmic:this.rhythmic(t),rest:this.restProportion()}}getStats(){if(this.sequence.length===0)return{mean:0,std:0,min:0,max:0,range:0};const e=this.sequence.reduce((o,a)=>o+a,0)/this.sequence.length,t=this.sequence.reduce((o,a)=>o+Math.pow(a-e,2),0)/this.sequence.length,r=Math.sqrt(t),n=Math.min(...this.sequence),i=Math.max(...this.sequence);return{mean:e,std:r,min:n,max:i,range:i-n}}similarity(e,t=null,r=4){const n=this.calculateAll(t,r),i=e.calculateAll(t,r);let o=0,a=0;for(const[c,l]of Object.entries(n)){const d=i[c];if(typeof l=="number"&&typeof d=="number"){const m=Math.max(Math.abs(l),Math.abs(d),1),v=1-Math.abs(l-d)/m;o+=v,a++}}return a===0?0:o/a}}class Ps{constructor(e={}){const{initialPhrases:t=[],mutationRate:r=.05,populationSize:n=50,mutationProbabilities:i=null,scale:o=null,measureLength:a=4,timeResolution:c=[.125,4],weights:l=null,targets:d=null,seed:m=null}=e;this.initialPhrases=t,this.mutationRate=r,this.populationSize=n,this.scale=o,this.measureLength=a,this.timeResolution=c,m!==null?(this.seed=m,this.randomState=this.createSeededRandom(m)):this.randomState=Math;const v=[.125,.25,.5,1,2,3,4,8];this.possibleDurations=v.filter(w=>w>=c[0]&&w<=Math.min(c[1],a)),this.mutationProbabilities=i||{pitch:()=>Math.max(0,Math.min(127,Math.floor(this.gaussianRandom(60,5)))),duration:()=>{const w=this.possibleDurations.map((P,g)=>Math.pow(2,-g));return this.weightedChoice(this.possibleDurations,w)},rest:()=>this.randomState.random()<.02?null:1},this.weights=l||{gini:[1,1,0],balance:[1,1,0],motif:[10,1,0],dissonance:[1,0,0],rhythmic:[0,10,0],rest:[1,0,0]},this.targets=d||{gini:[.05,.5,0],balance:[.1,.1,0],motif:[1,1,0],dissonance:[0,0,0],rhythmic:[0,1,0],rest:[0,0,0]},this.population=this.initializePopulation(),this.bestIndividuals=[],this.bestScores=[],this.generationCount=0}createSeededRandom(e){let t=e;const r=()=>(t=(t*9301+49297)%233280,t/233280);return{random:r,choice:n=>n[Math.floor(r()*n.length)],sample:(n,i)=>[...n].sort(()=>r()-.5).slice(0,i)}}gaussianRandom(e=0,t=1){if(this.gaussianSpare!==void 0){const o=this.gaussianSpare;return this.gaussianSpare=void 0,e+t*o}const r=this.randomState.random(),n=this.randomState.random(),i=t*Math.sqrt(-2*Math.log(r));return this.gaussianSpare=i*Math.cos(2*Math.PI*n),e+i*Math.sin(2*Math.PI*n)}weightedChoice(e,t){const r=t.reduce((i,o)=>i+o,0);let n=this.randomState.random()*r;for(let i=0;i<e.length;i++)if(n-=t[i],n<=0)return e[i];return e[e.length-1]}initializePopulation(){const e=[],t=Math.floor(this.populationSize/this.initialPhrases.length);for(const r of this.initialPhrases)for(let n=0;n<t;n++)e.push(this.mutate(r,0));for(;e.length<this.populationSize;){const r=this.randomState.choice(this.initialPhrases);e.push(this.mutate(r,0))}return e}calculateFitnessComponents(e){if(e.length===0)return{};const t=e.map(a=>a[0]),r=e.map(a=>a[1]),n=e.map(a=>a[2]),i={};if(t.length>0){const a=new nr(t);i.gini_pitch=a.gini(),i.balance_pitch=a.balance(),i.motif_pitch=a.motif(),this.scale&&(i.dissonance_pitch=a.dissonance(this.scale))}if(r.length>0){const a=new nr(r);i.gini_duration=a.gini(),i.balance_duration=a.balance(),i.motif_duration=a.motif(),i.rhythmic=a.rhythmic(this.measureLength)}if(n.length>0){const a=new nr(n);i.gini_offset=a.gini(),i.balance_offset=a.balance(),i.motif_offset=a.motif()}const o=t.filter(a=>a==null).length/t.length;return i.rest=o,i}fitness(e){const t=this.calculateFitnessComponents(e);let r=0;for(const[n,i]of Object.entries(this.targets)){const o=this.weights[n];for(let a=0;a<3;a++){const c=a===0?`${n}_pitch`:a===1?`${n}_duration`:`${n}_offset`,l=t[c]||0,d=i[a],m=o[a];if(m>0&&d!==void 0){const v=Math.max(Math.abs(d),1),w=1-Math.abs(l-d)/v;r+=Math.max(0,w)*m}}}if(this.weights.rest[0]>0){const n=t.rest||0,i=this.targets.rest[0],o=1-Math.abs(n-i)/Math.max(i,1);r+=Math.max(0,o)*this.weights.rest[0]}return r}mutate(e,t=null){t===null&&(t=this.mutationRate);const r=[];let n=0;for(const i of e){let[o,a,c]=i;this.randomState.random()<t&&(o=this.mutationProbabilities.pitch()),this.randomState.random()<t&&(a=this.mutationProbabilities.duration()),this.randomState.random()<t&&this.mutationProbabilities.rest()===null&&(o=null);const l=n;n+=a,r.push([o,a,l])}return r}select(e=25){const t=this.population.map(r=>({phrase:r,fitness:this.fitness(r)}));return t.sort((r,n)=>n.fitness-r.fitness),t.slice(0,e).map(r=>r.phrase)}crossover(e,t){if(e.length===0||t.length===0)return e.length>0?[...e]:[...t];const r=Math.min(e.length,t.length),n=Math.floor(this.randomState.random()*r),i=Math.floor(this.randomState.random()*r),[o,a]=[Math.min(n,i),Math.max(n,i)],c=[];for(let d=0;d<o;d++)d<e.length&&c.push([...e[d]]);for(let d=o;d<a;d++)d<t.length&&c.push([...t[d]]);for(let d=a;d<Math.max(e.length,t.length);d++)d<e.length?c.push([...e[d]]):d<t.length&&c.push([...t[d]]);let l=0;for(let d=0;d<c.length;d++)c[d][2]=l,l+=c[d][1];return c}evolve(e=25){const t=this.select(e),r=this.fitness(t[0]);this.bestIndividuals.push([...t[0]]),this.bestScores.push(r);const n=[];for(;n.length<this.populationSize;){const i=this.randomState.choice(t),o=this.randomState.choice(t),a=this.crossover([...i],[...o]),c=this.mutate(a);n.push(c)}return this.population=n,this.generationCount++,{generation:this.generationCount,bestFitness:r,averageFitness:t.reduce((i,o)=>i+this.fitness(o),0)/t.length,populationSize:this.populationSize}}evolveGenerations(e,t=25,r=null){const n=[];for(let i=0;i<e;i++){const o=this.evolve(t);n.push(o),r&&r(o,i,e)}return n}getBestIndividual(){return this.bestIndividuals.length>0?[...this.bestIndividuals[this.bestIndividuals.length-1]]:null}getEvolutionHistory(){return{individuals:this.bestIndividuals.map(e=>[...e]),scores:[...this.bestScores],generations:this.generationCount}}reset(){this.population=this.initializePopulation(),this.bestIndividuals=[],this.bestScores=[],this.generationCount=0}getPopulationStats(){const e=this.population.map(n=>this.fitness(n)),t=e.reduce((n,i)=>n+i,0)/e.length,r=e.reduce((n,i)=>n+Math.pow(i-t,2),0)/e.length;return{populationSize:this.population.length,meanFitness:t,standardDeviation:Math.sqrt(r),minFitness:Math.min(...e),maxFitness:Math.max(...e),generation:this.generationCount}}}class Ss{options;walkers;history;constructor(e={}){this.options={length:e.length||100,dimensions:e.dimensions||1,stepSize:e.stepSize||1,bounds:e.bounds||[-100,100],branchProbability:e.branchProbability||.05,mergeProbability:e.mergeProbability||.02,attractorStrength:e.attractorStrength||0,attractorPosition:e.attractorPosition||Array(e.dimensions||1).fill(0)},this.walkers=[],this.history=[]}generate(e){this.initialize(e),this.history=[];for(let t=0;t<this.options.length;t++)this.updateWalkers(),this.recordState(),this.handleBranching(),this.handleMerging();return this.history}initialize(e){const t=e||Array(this.options.dimensions).fill(0);this.walkers=[{position:[...t],velocity:Array(this.options.dimensions).fill(0),branches:[],age:0,active:!0}]}updateWalkers(){for(const e of this.walkers)if(e.active){for(let t=0;t<this.options.dimensions;t++){const r=(Math.random()-.5)*2*this.options.stepSize;let n=0;if(this.options.attractorStrength>0){const i=e.position[t]-this.options.attractorPosition[t];n=-this.options.attractorStrength*i}e.velocity[t]=e.velocity[t]*.9+r+n,e.position[t]+=e.velocity[t],e.position[t]<this.options.bounds[0]?(e.position[t]=this.options.bounds[0],e.velocity[t]*=-.5):e.position[t]>this.options.bounds[1]&&(e.position[t]=this.options.bounds[1],e.velocity[t]*=-.5)}e.age++}}recordState(){const e=this.walkers.filter(t=>t.active);if(e.length>0){const t=Array(this.options.dimensions).fill(0);for(const r of e)for(let n=0;n<this.options.dimensions;n++)t[n]+=r.position[n];for(let r=0;r<this.options.dimensions;r++)t[r]/=e.length;this.history.push([...t])}}handleBranching(){const e=[];for(const t of this.walkers)if(t.active&&Math.random()<this.options.branchProbability){const r={position:[...t.position],velocity:t.velocity.map(n=>n+(Math.random()-.5)*this.options.stepSize),branches:[],age:0,active:!0};e.push(r),t.branches.push(r)}this.walkers.push(...e)}handleMerging(){if(this.walkers.length<=1)return;const e=this.walkers.filter(r=>r.active),t=this.options.stepSize*2;for(let r=0;r<e.length;r++)for(let n=r+1;n<e.length;n++)if(Math.random()<this.options.mergeProbability&&this.calculateDistance(e[r].position,e[n].position)<t){for(let o=0;o<this.options.dimensions;o++)e[r].position[o]=(e[r].position[o]+e[n].position[o])/2,e[r].velocity[o]=(e[r].velocity[o]+e[n].velocity[o])/2;e[n].active=!1}this.walkers=this.walkers.filter(r=>r.active)}calculateDistance(e,t){let r=0;for(let n=0;n<e.length;n++)r+=Math.pow(e[n]-t[n],2);return Math.sqrt(r)}getProjection(e=0){return this.history.map(t=>t[e]||0)}mapToScale(e=0,t=[0,2,4,5,7,9,11],r=3){const n=this.getProjection(e);if(n.length===0)return[];const i=Math.min(...n),a=Math.max(...n)-i||1;return n.map(c=>{const l=(c-i)/a,d=Math.floor(l*t.length*r),m=Math.floor(d/t.length),v=d%t.length;return 60+m*12+t[v]})}mapToRhythm(e=0,t=[.25,.5,1,2]){const r=this.getProjection(e);if(r.length===0)return[];const n=Math.min(...r),o=Math.max(...r)-n||1;return r.map(a=>{const c=(a-n)/o,l=Math.floor(c*t.length),d=Math.max(0,Math.min(l,t.length-1));return t[d]})}mapToVelocity(e=0,t=.3,r=1){const n=this.getProjection(e);if(n.length===0)return[];const i=Math.min(...n),a=Math.max(...n)-i||1;return n.map(c=>{const l=(c-i)/a;return t+l*(r-t)})}generateCorrelated(e,t=.5,r=0){if(e.length===0)return[];const n=[];let i=0;for(let o=0;o<e.length;o++){const a=(Math.random()-.5)*2*this.options.stepSize,c=t*(e[o]-i);i+=a+c,i=Math.max(this.options.bounds[0],Math.min(this.options.bounds[1],i)),n.push(i)}return n}analyze(){if(this.history.length<2)return{meanDisplacement:0,meanSquaredDisplacement:0,totalDistance:0,fractalDimension:0};const e=this.getProjection(0),t=e[0],r=e[e.length-1],n=Math.abs(r-t),i=e.map(l=>Math.pow(l-t,2)),o=i.reduce((l,d)=>l+d,0)/i.length;let a=0;for(let l=1;l<e.length;l++)a+=Math.abs(e[l]-e[l-1]);const c=a>0?Math.log(a)/Math.log(e.length):0;return{meanDisplacement:n,meanSquaredDisplacement:o,totalDistance:a,fractalDimension:c}}getWalkerStates(){return this.walkers.map(e=>({...e}))}reset(){this.walkers=[],this.history=[]}toJmonNotes(e=[1],t={}){const{useStringTime:r=!1,timingConfig:n=Oe,dimension:i=0,mapToScale:o=null,scaleRange:a=[60,72]}=t,c=this.getProjection(i),l=[];let d=0;for(let m=0;m<c.length;m++){const v=e[m%e.length];let w=c[m];if(o){const P=Math.min(...c),h=Math.max(...c)-P||1,p=(w-P)/h,u=Math.floor(p*o.length),f=Math.max(0,Math.min(u,o.length-1));w=o[f]}else w=this.mapToScale([c],o||[60,62,64,65,67,69,71])[0][m];l.push({pitch:w,duration:v,time:r?We(d,n):d}),d+=v}return l}generateTrack(e,t=[1],r={},n={}){this.generate(e);const i=this.toJmonNotes(t,r);return at(i,{label:"random-walk",midiChannel:0,synth:{type:"Synth"},...n})}}class Es{walkRange;walkStart;walkProbability;roundTo;branchingProbability;mergingProbability;timingConfig;constructor(e={}){this.walkRange=e.walkRange||null,this.walkStart=e.walkStart!==void 0?e.walkStart:this.walkRange?Math.floor((this.walkRange[1]-this.walkRange[0])/2)+this.walkRange[0]:0,this.walkProbability=e.walkProbability||[-1,0,1],this.roundTo=e.roundTo!==void 0?e.roundTo:null,this.branchingProbability=e.branchingProbability||0,this.mergingProbability=e.mergingProbability||0,this.timingConfig=e.timingConfig||Oe}generate(e,t){let r=Math.random;t!==void 0&&(r=this.createSeededRandom(t));const n=[this.initializeWalk(e)];let i=[this.walkStart];for(let o=1;o<e;o++){const a=[...i],c=[];for(let l=0;l<i.length;l++){const d=n[l],m=i[l];if(m===null){d&&(d[o]=null);continue}const v=this.generateStep(r);let w=m+v;if(isNaN(w)&&(w=m),this.walkRange!==null&&(w<this.walkRange[0]?w=this.walkRange[0]:w>this.walkRange[1]&&(w=this.walkRange[1])),isNaN(w)&&(w=this.walkStart),d&&(d[o]=w),a[l]=w,r()<this.branchingProbability){const P=this.createBranch(n[l],o),g=this.generateStep(r);let h=m+g;isNaN(h)&&(h=m),this.walkRange!==null&&(h<this.walkRange[0]?h=this.walkRange[0]:h>this.walkRange[1]&&(h=this.walkRange[1])),isNaN(h)&&(h=this.walkStart),P[o]=h,c.push(P),a.push(h)}}n.push(...c),i=a,i=this.handleMerging(n,i,o,r)}return n}generateStep(e=Math.random){if(Array.isArray(this.walkProbability))return this.walkProbability[Math.floor(e()*this.walkProbability.length)];if(typeof this.walkProbability=="object"&&this.walkProbability.mean!==void 0&&this.walkProbability.std!==void 0){let t=this.generateNormal(this.walkProbability.mean,this.walkProbability.std,e);return this.roundTo!==null&&(t=parseFloat(t.toFixed(this.roundTo))),t}return[-1,0,1][Math.floor(e()*3)]}generateNormal(e,t,r=Math.random){let n,i;do n=r();while(n===0);i=r();const o=Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*i),a=e+t*o;return isNaN(a)?e:a}initializeWalk(e){const t=new Array(e);t[0]=this.walkStart;for(let r=1;r<e;r++)t[r]=null;return t}createBranch(e,t){const r=new Array(e.length);for(let n=0;n<t;n++)r[n]=null;for(let n=t;n<r.length;n++)r[n]=null;return r}handleMerging(e,t,r,n=Math.random){const i=[...t];for(let o=0;o<t.length;o++)if(t[o]!==null)for(let a=o+1;a<t.length;a++){if(t[a]===null)continue;const c=this.roundTo!==null?this.roundTo:.001;if(Math.abs(t[o]-t[a])<=c&&n()<this.mergingProbability&&(i[a]=null,e[a]))for(let l=r;l<e[a].length;l++)e[a][l]=null}return i}toJmonNotes(e,t=[1],r={}){const n=r.useStringTime||!1,i=[];let o=0,a=0;const c=Math.max(...e.map(l=>l.length));for(let l=0;l<c;l++){const d=e.map(m=>m[l]).filter(m=>m!==null);if(d.length>0){const m=t[a%t.length],v=d.length===1?d[0]:d;i.push({pitch:v,duration:m,time:n?We(o,this.timingConfig):o}),o+=m,a++}}return i}generateTrack(e,t=[1],r={}){const n=this.generate(e,r.seed),i=this.toJmonNotes(n,t,r);return at(i,{label:"random-walk",midiChannel:0,synth:{type:"Synth"},...r})}mapToScale(e,t=[60,62,64,65,67,69,71]){return e.map(r=>r.map(n=>{if(n===null)return null;const i=this.walkRange[0],a=this.walkRange[1]-i,c=(n-i)/a,l=Math.floor(c*t.length),d=Math.max(0,Math.min(l,t.length-1));return t[d]}))}createSeededRandom(e){let t=Math.abs(e)||1;return function(){t=(t*9301+49297)%233280;const r=t/233280;return Math.max(1e-7,Math.min(.9999999,r))}}}class Xe{distance;frequency;phase;subPhasors;center;constructor(e=1,t=1,r=0,n=[]){this.distance=e,this.frequency=t,this.phase=r,this.subPhasors=n||[],this.center={x:0,y:0}}addSubPhasor(e){this.subPhasors.push(e)}getPosition(e){const t=this.frequency*e+this.phase,r=this.center.x+this.distance*Math.cos(t),n=this.center.y+this.distance*Math.sin(t);return{x:r,y:n,angle:t,distance:this.distance}}getDistanceFromOrigin(e){const t=this.getPosition(e);return Math.sqrt(t.x*t.x+t.y*t.y)}getAngleFromOrigin(e){const t=this.getPosition(e);let r=Math.atan2(t.y,t.x)*180/Math.PI;return r<0&&(r+=360),r}simulate(e,t={x:0,y:0}){this.center=t;const r=[];for(const n of e){const i=this.getPosition(n),o=this.getDistanceFromOrigin(n),a=this.getAngleFromOrigin(n);r.push({time:n,position:i,distance:o,angle:a,phasor:this});for(const c of this.subPhasors){c.center=i;const l=c.simulate([n],i);r.push(...l)}}return r}}class Mr{phasors;timingConfig;constructor(e=Oe){this.phasors=[],this.timingConfig=e}addPhasor(e){this.phasors.push(e)}simulate(e){const t=[];for(const r of this.phasors){const n=r.simulate(e);t.push(n)}return t}getAllPhasors(){const e=[];for(const t of this.phasors)e.push(t),this.collectSubPhasors(t,e);return e}collectSubPhasors(e,t){for(const r of e.subPhasors)t.push(r),this.collectSubPhasors(r,t)}mapToMusic(e,t={}){const r=this.simulate(e),n=[];for(let i=0;i<r.length;i++){const o=r[i],a=this.createMusicalTrack(o,i,t);n.push(a)}return n}createMusicalTrack(e,t,r={}){const{pitchRange:n=[40,80],durationRange:i=[.25,2],useDistance:o=!0,useAngle:a=!1,quantizeToScale:c=null,timingConfig:l=this.timingConfig,useStringTime:d=!1}=r,m=[];for(const v of e){let w,P;if(o){const g=Math.max(0,Math.min(1,v.distance/10));w=n[0]+g*(n[1]-n[0])}else w=n[0]+v.angle/360*(n[1]-n[0]);if(a)P=i[0]+v.angle/360*(i[1]-i[0]);else{const g=Math.max(0,Math.min(1,v.distance/10));P=i[1]-g*(i[1]-i[0])}if(c){const g=Math.floor((w-n[0])/(n[1]-n[0])*c.length),h=Math.max(0,Math.min(g,c.length-1));w=c[h]}else w=Math.round(w);m.push({pitch:w,duration:P,time:d?We(v.time,l):v.time,phasorData:{distance:v.distance,angle:v.angle,position:v.position}})}return m}generateTracks(e,t={},r={}){const n=this.mapToMusic(e,t),i=[];return n.forEach((o,a)=>{const c=at(o,{label:`phasor-${a+1}`,midiChannel:a%16,synth:{type:"Synth"},...r});i.push(c)}),i}static createComplexSystem(){const e=new Mr,t=new Xe(.2,5,0),r=new Xe(.3,3,Math.PI/2),n=new Xe(.1,8,Math.PI);t.addSubPhasor(n);const i=new Xe(2,1,0,[t,r]),o=new Xe(3.5,.6,Math.PI/3);return e.addPhasor(i),e.addPhasor(o),e}static generateTimeArray(e=0,t=10,r=100){const n=[],i=(t-e)/(r-1);for(let o=0;o<r;o++)n.push(e+o*i);return n}}class Ts{constructor(e={}){this.width=e.width||100,this.height=e.height||100,this.maxIterations=e.maxIterations||100,this.xMin=e.xMin||-2.5,this.xMax=e.xMax||1.5,this.yMin=e.yMin||-2,this.yMax=e.yMax||2}generate(){const e=[];for(let t=0;t<this.height;t++){const r=[];for(let n=0;n<this.width;n++){const i=this.xMin+n/this.width*(this.xMax-this.xMin),o=this.yMin+t/this.height*(this.yMax-this.yMin),a=this.mandelbrotIterations({real:i,imaginary:o});r.push(a)}e.push(r)}return e}extractSequence(e="diagonal",t=0){const r=this.generate();switch(e){case"diagonal":return this.extractDiagonal(r);case"border":return this.extractBorder(r);case"spiral":return this.extractSpiral(r);case"column":return this.extractColumn(r,t);case"row":return this.extractRow(r,t);default:return this.extractDiagonal(r)}}mandelbrotIterations(e){let t={real:0,imaginary:0};for(let r=0;r<this.maxIterations;r++){const n=t.real*t.real-t.imaginary*t.imaginary+e.real,i=2*t.real*t.imaginary+e.imaginary;if(t.real=n,t.imaginary=i,t.real*t.real+t.imaginary*t.imaginary>4)return r}return this.maxIterations}extractDiagonal(e){const t=[],r=Math.min(e.length,e[0]?.length||0);for(let n=0;n<r;n++)t.push(e[n][n]);return t}extractBorder(e){const t=[],r=e.length,n=e[0]?.length||0;if(r===0||n===0)return t;for(let i=0;i<n;i++)t.push(e[0][i]);for(let i=1;i<r;i++)t.push(e[i][n-1]);if(r>1)for(let i=n-2;i>=0;i--)t.push(e[r-1][i]);if(n>1)for(let i=r-2;i>0;i--)t.push(e[i][0]);return t}extractSpiral(e){const t=[],r=e.length,n=e[0]?.length||0;if(r===0||n===0)return t;let i=0,o=r-1,a=0,c=n-1;for(;i<=o&&a<=c;){for(let l=a;l<=c;l++)t.push(e[i][l]);i++;for(let l=i;l<=o;l++)t.push(e[l][c]);if(c--,i<=o){for(let l=c;l>=a;l--)t.push(e[o][l]);o--}if(a<=c){for(let l=o;l>=i;l--)t.push(e[l][a]);a++}}return t}extractColumn(e,t){const r=[],n=e[0]?.length||0,i=Math.max(0,Math.min(t,n-1));for(const o of e)o[i]!==void 0&&r.push(o[i]);return r}extractRow(e,t){const r=Math.max(0,Math.min(t,e.length-1));return e[r]?[...e[r]]:[]}mapToScale(e,t=[0,2,4,5,7,9,11],r=3){if(e.length===0)return[];const n=Math.min(...e),o=Math.max(...e)-n||1;return e.map(a=>{const c=(a-n)/o,l=Math.floor(c*t.length*r),d=Math.floor(l/t.length),m=l%t.length;return 60+d*12+t[m]})}mapToRhythm(e,t=[1,2,4,8,16]){if(e.length===0)return[];const r=Math.min(...e),i=Math.max(...e)-r||1;return e.map(o=>{const a=(o-r)/i,c=Math.floor(a*t.length),l=Math.max(0,Math.min(c,t.length-1));return 1/t[l]})}}class xs{constructor(e={}){this.r=e.r||3.8,this.x0=e.x0||.5,this.iterations=e.iterations||1e3,this.skipTransient=e.skipTransient||100}generate(){const e=[];let t=this.x0;for(let r=0;r<this.iterations+this.skipTransient;r++)t=this.r*t*(1-t),r>=this.skipTransient&&e.push(t);return e}bifurcationDiagram(e=2.5,t=4,r=1e3){const n=[],i=[],o=(t-e)/r;for(let a=0;a<r;a++){const c=e+a*o,l=this.r;this.r=c;const d=this.generate();this.r=l;const m=d.slice(-50);for(const v of m)n.push(c),i.push(v)}return{r:n,x:i}}mapToScale(e,t=[0,2,4,5,7,9,11],r=3){return e.length===0?[]:e.map(n=>{const i=Math.floor(n*t.length*r),o=Math.floor(i/t.length),a=i%t.length;return 60+o*12+t[a]})}mapToRhythm(e,t=[.25,.5,1,2]){return e.length===0?[]:e.map(r=>{const n=Math.floor(r*t.length),i=Math.max(0,Math.min(n,t.length-1));return t[i]})}mapToVelocity(e,t=.3,r=1){if(e.length===0)return[];const n=r-t;return e.map(i=>t+i*n)}detectCycles(e,t=.01){const r=[];for(let n=1;n<=Math.floor(e.length/2);n++){let i=!0;for(let o=n;o<Math.min(e.length,n*3);o++)if(Math.abs(e[o]-e[o-n])>t){i=!1;break}i&&r.push(n)}return r}lyapunovExponent(e=1e4){let t=this.x0,r=0;for(let n=0;n<e;n++){const i=this.r*(1-2*t);r+=Math.log(Math.abs(i)),t=this.r*t*(1-t)}return r/e}generateCoupled(e=2,t=.1){const r=Array(e).fill(null).map(()=>[]),n=Array(e).fill(this.x0);for(let i=0;i<this.iterations+this.skipTransient;i++){const o=[...n];for(let a=0;a<e;a++){let c=0;for(let l=0;l<e;l++)l!==a&&(c+=t*(n[l]-n[a]));o[a]=this.r*n[a]*(1-n[a])+c,o[a]=Math.max(0,Math.min(1,o[a]))}if(n.splice(0,e,...o),i>=this.skipTransient)for(let a=0;a<e;a++)r[a].push(n[a])}return r}setRegime(e,t){switch(e){case"periodic":this.r=3.2;break;case"chaotic":this.r=3.9;break;case"edge":this.r=3.57;break;case"custom":t!==void 0&&(this.r=Math.max(0,Math.min(4,t)));break}}getParameters(){return{r:this.r,x0:this.x0,iterations:this.iterations,skipTransient:this.skipTransient}}}class ks{operation;direction;repetition;timingConfig;sequence=[];constructor(e){const{operation:t,direction:r,repetition:n,timingConfig:i=Oe}=e;if(!["additive","subtractive"].includes(t))throw new Error("Invalid operation. Choose 'additive' or 'subtractive'.");if(!["forward","backward","inward","outward"].includes(r))throw new Error("Invalid direction. Choose 'forward', 'backward', 'inward' or 'outward'.");if(n<0||!Number.isInteger(n))throw new Error("Invalid repetition value. Must be an integer greater than or equal to 0.");this.operation=t,this.direction=r,this.repetition=n,this.timingConfig=i}generate(e){this.sequence=this.normalizeInput(e);let t;if(this.operation==="additive"&&this.direction==="forward")t=this.additiveForward();else if(this.operation==="additive"&&this.direction==="backward")t=this.additiveBackward();else if(this.operation==="additive"&&this.direction==="inward")t=this.additiveInward();else if(this.operation==="additive"&&this.direction==="outward")t=this.additiveOutward();else if(this.operation==="subtractive"&&this.direction==="forward")t=this.subtractiveForward();else if(this.operation==="subtractive"&&this.direction==="backward")t=this.subtractiveBackward();else if(this.operation==="subtractive"&&this.direction==="inward")t=this.subtractiveInward();else if(this.operation==="subtractive"&&this.direction==="outward")t=this.subtractiveOutward();else throw new Error("Invalid operation/direction combination");const r=this.adjustOffsets(t);return this.toJmonNotes(r,!1)}additiveForward(){const e=[];for(let t=0;t<this.sequence.length;t++){const r=this.sequence.slice(0,t+1);for(let n=0;n<=this.repetition;n++)e.push(...r)}return e}additiveBackward(){const e=[];for(let t=this.sequence.length;t>0;t--){const r=this.sequence.slice(t-1);for(let n=0;n<=this.repetition;n++)e.push(...r)}return e}additiveInward(){const e=[],t=this.sequence.length;for(let r=0;r<Math.ceil(t/2);r++){let n;if(r<t-r-1){const i=this.sequence.slice(0,r+1),o=this.sequence.slice(t-r-1);n=[...i,...o]}else n=[...this.sequence];for(let i=0;i<=this.repetition;i++)e.push(...n)}return e}additiveOutward(){const e=[],t=this.sequence.length;if(t%2===0){const r=Math.floor(t/2)-1,n=Math.floor(t/2);for(let i=0;i<t/2;i++){const o=this.sequence.slice(r-i,n+i+1);for(let a=0;a<=this.repetition;a++)e.push(...o)}}else{const r=Math.floor(t/2);for(let n=0;n<=r;n++){const i=this.sequence.slice(r-n,r+n+1);for(let o=0;o<=this.repetition;o++)e.push(...i)}}return e}subtractiveForward(){const e=[];for(let t=0;t<this.sequence.length;t++){const r=this.sequence.slice(t);for(let n=0;n<=this.repetition;n++)e.push(...r)}return e}subtractiveBackward(){const e=[];for(let t=this.sequence.length;t>0;t--){const r=this.sequence.slice(0,t);for(let n=0;n<=this.repetition;n++)e.push(...r)}return e}subtractiveInward(){const e=[],t=this.sequence.length,r=Math.floor(t/2);for(let n=0;n<=this.repetition;n++)e.push(...this.sequence);for(let n=1;n<=r;n++){const i=this.sequence.slice(n,t-n);if(i.length>0)for(let o=0;o<=this.repetition;o++)e.push(...i)}return e}subtractiveOutward(){const e=[];let t=[...this.sequence];for(let r=0;r<=this.repetition;r++)e.push(...t);for(;t.length>2;){t=t.slice(1,-1);for(let r=0;r<=this.repetition;r++)e.push(...t)}return e}normalizeInput(e){return Array.isArray(e)?Array.isArray(e[0])?e.map(([t,r,n=0])=>({pitch:t,duration:r,offset:n})):e.map(t=>{const r=t.pitch,n=t.duration;let i=0;return typeof t.offset=="number"?i=t.offset:typeof t.time=="number"?i=t.time:typeof t.time=="string"&&(i=this.timeToBeats(t.time)),{...t,pitch:r,duration:n,offset:i}}):[]}beatsToTime(e){return We(e,this.timingConfig)}timeToBeats(e){return typeof e!="string"?Number(e)||0:kr(e,this.timingConfig)}adjustOffsets(e){let t=0;return e.map(r=>{const n={...r,offset:t};return t+=r.duration,n})}toJmonNotes(e,t=!1){return e.map(({pitch:r,duration:n,offset:i,...o})=>{const{time:a,...c}=o;return{pitch:r,duration:n,time:t?this.beatsToTime(i):i,...c}})}generateTrack(e,t={}){const r=this.generate(e);return at(r,{timingConfig:this.timingConfig,...t})}}class Ms{tChord;direction;rank;isAlternate;currentDirection;timingConfig;constructor(e,t="down",r=0,n=Oe){if(!["up","down","any","alternate"].includes(t))throw new Error("Invalid direction. Choose 'up', 'down', 'any' or 'alternate'.");if(this.tChord=e,this.isAlternate=t==="alternate",this.currentDirection=this.isAlternate?"up":t,this.direction=t,this.timingConfig=n,!Number.isInteger(r)||r<0)throw new Error("Rank must be a non-negative integer.");this.rank=Math.min(r,e.length-1),this.rank>=e.length&&console.warn("Rank exceeds the length of the t-chord. Using last note of the t-chord.")}generate(e,t=!1){const r=this.normalizeInput(e),n=[];for(const i of r){if(i.pitch===void 0){const{offset:P,time:g,...h}=i;n.push({...h,pitch:void 0,time:t?this.beatsToTime(P):P});continue}const o=i.pitch,c=this.tChord.map(P=>P-o).map((P,g)=>({index:g,value:P})).sort((P,g)=>Math.abs(P.value)-Math.abs(g.value));let l=this.rank,d;if(this.currentDirection==="up"||this.currentDirection==="down"){const P=c.filter(({value:g})=>this.currentDirection==="up"?g>=0:g<=0);if(P.length===0)d=this.currentDirection==="up"?Math.max(...this.tChord):Math.min(...this.tChord);else{l>=P.length&&(l=P.length-1);const g=P[l].index;d=this.tChord[g]}}else{l>=c.length&&(l=c.length-1);const P=c[l].index;d=this.tChord[P]}this.isAlternate&&(this.currentDirection=this.currentDirection==="up"?"down":"up");const{offset:m,time:v,...w}=i;n.push({...w,pitch:d,time:t?this.beatsToTime(m):m})}return n}normalizeInput(e){return Array.isArray(e)?Array.isArray(e[0])?e.map(([t,r,n=0])=>({pitch:t,duration:r,offset:n})):e.map(t=>{const r=t.pitch,n=t.duration;let i=0;return typeof t.offset=="number"?i=t.offset:typeof t.time=="number"?i=t.time:typeof t.time=="string"&&(i=this.timeToBeats(t.time)),{...t,pitch:r,duration:n,offset:i}}):[]}beatsToTime(e){return We(e,this.timingConfig)}timeToBeats(e){return typeof e!="string"?Number(e)||0:kr(e,this.timingConfig)}}class As{static gini(e,t){if(e.length===0)return 0;const r=e.length,n=t||Array(r).fill(1),i=e.map((m,v)=>({value:m,weight:n[v]})).sort((m,v)=>m.value-v.value),o=i.map(m=>m.value),a=i.map(m=>m.weight),c=a.reduce((m,v)=>m+v,0);let l=0,d=0;for(let m=0;m<r;m++){const v=a.slice(0,m+1).reduce((w,P)=>w+P,0);l+=a[m]*(2*v-a[m]-c)*o[m],d+=a[m]*o[m]*c}return d===0?0:l/d}static balance(e,t){if(e.length===0)return 0;const r=t||Array(e.length).fill(1),n=e.reduce((o,a,c)=>o+a*r[c],0),i=r.reduce((o,a)=>o+a,0);return i===0?0:n/i}static autocorrelation(e,t){const r=e.length,n=t||Math.floor(r/2),i=[],o=e.reduce((c,l)=>c+l,0)/r,a=e.reduce((c,l)=>c+Math.pow(l-o,2),0)/r;for(let c=0;c<=n;c++){let l=0;for(let d=0;d<r-c;d++)l+=(e[d]-o)*(e[d+c]-o);l/=r-c,i.push(a===0?0:l/a)}return i}static motif(e,t=3){if(e.length<t*2)return 0;const r=new Map;for(let o=0;o<=e.length-t;o++){const a=e.slice(o,o+t).join(",");r.set(a,(r.get(a)||0)+1)}const n=Math.max(...r.values()),i=r.size;return i===0?0:n/i}static dissonance(e,t=[0,2,4,5,7,9,11]){if(e.length===0)return 0;let r=0;for(const n of e){const i=(n%12+12)%12;t.includes(i)&&r++}return 1-r/e.length}static rhythmic(e,t=16){if(e.length===0)return 0;let r=0;const n=.1;for(const i of e){const o=i*t,a=Math.round(o);Math.abs(o-a)<=n&&r++}return r/e.length}static fibonacciIndex(e){if(e.length<2)return 0;const t=(1+Math.sqrt(5))/2;let r=0;for(let n=1;n<e.length;n++)if(e[n-1]!==0){const i=e[n]/e[n-1],o=Math.abs(i-t);r+=1/(1+o)}return r/(e.length-1)}static syncopation(e,t=4){if(e.length===0)return 0;let r=0;for(const n of e){const i=n*t%1;i>.2&&i<.8&&Math.abs(i-.5)>.2&&r++}return r/e.length}static contourEntropy(e){if(e.length<2)return 0;const t=[];for(let o=1;o<e.length;o++){const a=e[o]-e[o-1];a>0?t.push(1):a<0?t.push(-1):t.push(0)}const r={up:0,down:0,same:0};for(const o of t)o>0?r.up++:o<0?r.down++:r.same++;const n=t.length;return-[r.up/n,r.down/n,r.same/n].filter(o=>o>0).reduce((o,a)=>o+a*Math.log2(a),0)}static intervalVariance(e){if(e.length<2)return 0;const t=[];for(let i=1;i<e.length;i++)t.push(Math.abs(e[i]-e[i-1]));const r=t.reduce((i,o)=>i+o,0)/t.length;return t.reduce((i,o)=>i+Math.pow(o-r,2),0)/t.length}static density(e,t=1){if(e.length===0)return 0;const r=e.map(a=>typeof a.time=="string"?parseFloat(a.time)||0:a.time||0),n=Math.min(...r),o=Math.max(...r)-n||1;return e.length/(o/t)}static gapVariance(e){if(e.length<2)return 0;const t=[];for(let i=1;i<e.length;i++)t.push(e[i]-e[i-1]);const r=t.reduce((i,o)=>i+o,0)/t.length;return t.reduce((i,o)=>i+Math.pow(o-r,2),0)/t.length}static analyze(e,t={}){const{scale:r=[0,2,4,5,7,9,11]}=t,n=e.map(o=>typeof o.note=="number"?o.note:typeof o.note=="string"?60:Array.isArray(o.note)?o.note[0]:60),i=e.map(o=>typeof o.time=="number"?o.time:parseFloat(o.time)||0);return{gini:this.gini(n),balance:this.balance(n),motif:this.motif(n),dissonance:this.dissonance(n,r),rhythmic:this.rhythmic(i),fibonacciIndex:this.fibonacciIndex(n),syncopation:this.syncopation(i),contourEntropy:this.contourEntropy(n),intervalVariance:this.intervalVariance(n),density:this.density(e),gapVariance:this.gapVariance(i)}}}const Rs=Object.freeze(Object.defineProperty({__proto__:null,MusicalAnalysis:As,MusicalIndex:nr},Symbol.toStringTag,{value:"Module"})),Cs={harmony:ts,rhythm:ms,motifs:{MotifBank:gs}},Ns={theory:ge},js={gaussian:{Regressor:_i,Kernel:_s},automata:{Cellular:$s},loops:rr,genetic:{Darwin:Ps},walks:{Random:Ss,Chain:Es,Phasor:{Vector:Xe,System:Mr}},fractals:{Mandelbrot:Ts,LogisticMap:xs},minimalism:{Process:ks,Tintinnabuli:Ms}},Os={...Rs},Is={...Xo},ct={theory:Cs,constants:Ns,generative:js,analysis:Os,utils:Is};class Ar{constructor(e={}){this.options=e}static parseBBTToBeats(e,t=4,r=480){if(typeof e=="number")return e;if(typeof e!="string")return 0;const n=e.match(/^(\d+):(\d+(?:\.\d+)?):(\d+)$/);if(!n)return 0;const i=parseInt(n[1],10),o=parseFloat(n[2]),a=parseInt(n[3],10);return i*t+o+a/r}static parseDurationToBeats(e,t=4,r=480){if(typeof e=="number")return e;if(typeof e!="string")return 0;if(/^\d+:\d+(?:\.\d+)?:\d+$/.test(e))return this.parseBBTToBeats(e,t,r);const n=e.match(/^(\d+)(n|t)$/);if(n){const i=parseInt(n[1],10),o=n[2];if(o==="n")return 4/i;if(o==="t")return 4/i*(2/3)}return 0}convert(e){return(e.tracks||[]).map(r=>({label:r.label,type:"PolySynth",part:(r.notes||[]).map(n=>({time:n.time,pitch:n.pitch,duration:n.duration,velocity:n.velocity||.8}))}))}}function Pi(s,e={}){try{ai(s)}catch{}const n=new Ar(e).convert(s).map((v,w)=>({originalTrackIndex:w,voiceIndex:0,totalVoices:1,trackInfo:{label:v.label},synthConfig:{type:v.type||"PolySynth"},partEvents:v.part||[]})),i=s.tempo||s.metadata?.tempo||s.bpm||120,[o,a]=(s.timeSignature||"4/4").split("/").map(v=>parseInt(v,10)),c=isFinite(o)?o:4;let l=0;n.forEach(v=>{v.partEvents&&v.partEvents.length>0&&v.partEvents.forEach(w=>{const P=Ar.parseBBTToBeats(w.time,c),g=Ar.parseDurationToBeats(w.duration,c),h=P+g;h>l&&(l=h)})});const d=60/i,m=l*d;return console.log(`[TONEJS] Duration calc: totalBeats=${l.toFixed(2)} beats = ${m.toFixed(2)}s - loop ends exactly when last note finishes`),{tracks:n,metadata:{totalDuration:m,tempo:i}}}const Qe={0:{name:"Acoustic Grand Piano",folder:"acoustic_grand_piano-mp3"},1:{name:"Bright Acoustic Piano",folder:"bright_acoustic_piano-mp3"},2:{name:"Electric Grand Piano",folder:"electric_grand_piano-mp3"},3:{name:"Honky-tonk Piano",folder:"honkytonk_piano-mp3"},4:{name:"Electric Piano 1",folder:"electric_piano_1-mp3"},5:{name:"Electric Piano 2",folder:"electric_piano_2-mp3"},6:{name:"Harpsichord",folder:"harpsichord-mp3"},7:{name:"Clavinet",folder:"clavinet-mp3"},8:{name:"Celesta",folder:"celesta-mp3"},9:{name:"Glockenspiel",folder:"glockenspiel-mp3"},10:{name:"Music Box",folder:"music_box-mp3"},11:{name:"Vibraphone",folder:"vibraphone-mp3"},12:{name:"Marimba",folder:"marimba-mp3"},13:{name:"Xylophone",folder:"xylophone-mp3"},14:{name:"Tubular Bells",folder:"tubular_bells-mp3"},15:{name:"Dulcimer",folder:"dulcimer-mp3"},16:{name:"Drawbar Organ",folder:"drawbar_organ-mp3"},17:{name:"Percussive Organ",folder:"percussive_organ-mp3"},18:{name:"Rock Organ",folder:"rock_organ-mp3"},19:{name:"Church Organ",folder:"church_organ-mp3"},20:{name:"Reed Organ",folder:"reed_organ-mp3"},21:{name:"Accordion",folder:"accordion-mp3"},22:{name:"Harmonica",folder:"harmonica-mp3"},23:{name:"Tango Accordion",folder:"tango_accordion-mp3"},24:{name:"Acoustic Guitar (nylon)",folder:"acoustic_guitar_nylon-mp3"},25:{name:"Acoustic Guitar (steel)",folder:"acoustic_guitar_steel-mp3"},26:{name:"Electric Guitar (jazz)",folder:"electric_guitar_jazz-mp3"},27:{name:"Electric Guitar (clean)",folder:"electric_guitar_clean-mp3"},28:{name:"Electric Guitar (muted)",folder:"electric_guitar_muted-mp3"},29:{name:"Overdriven Guitar",folder:"overdriven_guitar-mp3"},30:{name:"Distortion Guitar",folder:"distortion_guitar-mp3"},31:{name:"Guitar Harmonics",folder:"guitar_harmonics-mp3"},32:{name:"Acoustic Bass",folder:"acoustic_bass-mp3"},33:{name:"Electric Bass (finger)",folder:"electric_bass_finger-mp3"},34:{name:"Electric Bass (pick)",folder:"electric_bass_pick-mp3"},35:{name:"Fretless Bass",folder:"fretless_bass-mp3"},36:{name:"Slap Bass 1",folder:"slap_bass_1-mp3"},37:{name:"Slap Bass 2",folder:"slap_bass_2-mp3"},38:{name:"Synth Bass 1",folder:"synth_bass_1-mp3"},39:{name:"Synth Bass 2",folder:"synth_bass_2-mp3"},40:{name:"Violin",folder:"violin-mp3"},41:{name:"Viola",folder:"viola-mp3"},42:{name:"Cello",folder:"cello-mp3"},43:{name:"Contrabass",folder:"contrabass-mp3"},44:{name:"Tremolo Strings",folder:"tremolo_strings-mp3"},45:{name:"Pizzicato Strings",folder:"pizzicato_strings-mp3"},46:{name:"Orchestral Harp",folder:"orchestral_harp-mp3"},47:{name:"Timpani",folder:"timpani-mp3"},48:{name:"String Ensemble 1",folder:"string_ensemble_1-mp3"},49:{name:"String Ensemble 2",folder:"string_ensemble_2-mp3"},56:{name:"Trumpet",folder:"trumpet-mp3"},57:{name:"Trombone",folder:"trombone-mp3"},58:{name:"Tuba",folder:"tuba-mp3"},64:{name:"Soprano Sax",folder:"soprano_sax-mp3"},65:{name:"Alto Sax",folder:"alto_sax-mp3"},66:{name:"Tenor Sax",folder:"tenor_sax-mp3"},67:{name:"Baritone Sax",folder:"baritone_sax-mp3"},68:{name:"Oboe",folder:"oboe-mp3"},69:{name:"English Horn",folder:"english_horn-mp3"},70:{name:"Bassoon",folder:"bassoon-mp3"},71:{name:"Clarinet",folder:"clarinet-mp3"},72:{name:"Piccolo",folder:"piccolo-mp3"},73:{name:"Flute",folder:"flute-mp3"},74:{name:"Recorder",folder:"recorder-mp3"}},Rr=["https://raw.githubusercontent.com/jmonlabs/midi-js-soundfonts/gh-pages/FluidR3_GM","https://cdn.jsdelivr.net/gh/gleitz/midi-js-soundfonts@gh-pages/FluidR3_GM"];function lt(s,e=Rr[0],t=[21,108],r="complete"){const n=Qe[s];if(!n)return console.warn(`GM program ${s} not found, using Acoustic Grand Piano`),lt(0,e,t);const i={},[o,a]=t;let c=[];switch(r){case"minimal":for(let l=o;l<=a;l+=12)c.push(l);c.push(60);break;case"balanced":for(let l=o;l<=a;l+=4)c.push(l);[60,64,67].forEach(l=>{l>=o&&l<=a&&!c.includes(l)&&c.push(l)});break;case"quality":for(let l=o;l<=a;l+=3)c.push(l);break;case"complete":for(let l=o;l<=a;l++)c.push(l);break;default:return console.warn(`Unknown sampling strategy '${r}', using 'balanced'`),lt(s,e,t,"balanced")}c=[...new Set(c)].sort((l,d)=>l-d);for(const l of c){const d=Ds(l);i[d]=qs(n.folder,d,e)}return console.log(`[GM INSTRUMENT] Generated ${Object.keys(i).length} sample URLs for ${n.name} (${r} strategy)`),i}function qs(s,e,t){return`${t}/${s}/${e}.mp3`}function Ds(s){const e=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],t=Math.floor(s/12)-1,r=s%12;return`${e[r]}${t}`}function Si(s){const e=s.toLowerCase().trim();for(const[t,r]of Object.entries(Qe))if(r.name.toLowerCase()===e)return parseInt(t,10);for(const[t,r]of Object.entries(Qe)){const n=r.name.toLowerCase();if(n.includes(e)||e.includes(n.split(" ")[0]))return parseInt(t,10)}return null}function zs(s,e,t={},r="destination"){let n;if(typeof e=="string"){if(n=Si(e),n===null){console.warn(`GM instrument "${e}" not found. Available instruments:`);const d=Object.values(Qe).map(m=>m.name).slice(0,10);console.warn(`Examples: ${d.join(", ")}...`),console.warn("Using Acoustic Grand Piano as fallback"),n=0}}else n=e;if(!Qe[n])return null;const{baseUrl:o=Rr[0],noteRange:a=[21,108],envelope:c={attack:.1,release:1},strategy:l="complete"}=t;return{id:s,type:"Sampler",options:{urls:lt(n,o,a,l),baseUrl:"",envelope:{enabled:!0,attack:c.attack,release:c.release}},target:r}}function Ei(){return[{program:0,name:"Acoustic Grand Piano",category:"Piano"},{program:1,name:"Bright Acoustic Piano",category:"Piano"},{program:4,name:"Electric Piano 1",category:"Piano"},{program:6,name:"Harpsichord",category:"Piano"},{program:40,name:"Violin",category:"Strings"},{program:42,name:"Cello",category:"Strings"},{program:48,name:"String Ensemble 1",category:"Strings"},{program:56,name:"Trumpet",category:"Brass"},{program:57,name:"Trombone",category:"Brass"},{program:65,name:"Alto Sax",category:"Woodwinds"},{program:71,name:"Clarinet",category:"Woodwinds"},{program:73,name:"Flute",category:"Woodwinds"},{program:24,name:"Acoustic Guitar (nylon)",category:"Guitar"},{program:25,name:"Acoustic Guitar (steel)",category:"Guitar"},{program:33,name:"Electric Bass (finger)",category:"Bass"},{program:16,name:"Drawbar Organ",category:"Organ"},{program:21,name:"Accordion",category:"Organ"}]}const Ls=["Reverb","JCReverb","Freeverb"],Vs=["Delay","FeedbackDelay","PingPongDelay"],Fs=["Chorus","Phaser","Tremolo","Vibrato","AutoWah"],Gs=["Distortion","Chebyshev","BitCrusher"],Bs=["Compressor","Limiter","Gate","MidSideCompressor"],Us=["Filter","AutoFilter"],Ks=["FrequencyShifter","PitchShift","StereoWidener"],Ys=[...Ls,...Vs,...Fs,...Gs,...Bs,...Us,...Ks],Hs=["Synth","PolySynth","MonoSynth","AMSynth","FMSynth","DuoSynth","PluckSynth","NoiseSynth"],Ti={MAX_WIDTH:800,MIN_WIDTH:0},Cr={MARGIN:"8px 0",GAP:12,UPDATE_INTERVAL:100},Js={},Ws={DEFAULT_TEMPO:120},Nr={INVALID_COMPOSITION:"Composition must be a valid JMON object",NO_SEQUENCES_OR_TRACKS:"Composition must have sequences or tracks",TRACKS_MUST_BE_ARRAY:"Tracks/sequences must be an array"},jr={PLAYER:"[PLAYER]"};function Or(s,e={}){if(!s||typeof s!="object")throw console.error(`${jr.PLAYER} Invalid composition:`,s),new Error(Nr.INVALID_COMPOSITION);const{autoplay:t=!1,showDebug:r=!1,customInstruments:n={},autoMultivoice:i=!0,maxVoices:o=4,Tone:a=null}=e;if(!s.sequences&&!s.tracks)throw console.error(`${jr.PLAYER} No sequences or tracks found in composition:`,s),new Error(Nr.NO_SEQUENCES_OR_TRACKS);const c=s.tracks||s.sequences||[];if(!Array.isArray(c))throw console.error(`${jr.PLAYER} Tracks/sequences must be an array:`,c),new Error(Nr.TRACKS_MUST_BE_ARRAY);const l=s.tempo||s.bpm||Ws.DEFAULT_TEMPO,m=Pi(s,{autoMultivoice:i,maxVoices:o,showDebug:r}),{tracks:v,metadata:w}=m;let P=w.totalDuration;const g=Js,h=document.createElement("div");h.style.cssText=`
        font-family: 'PT Sans', sans-serif;
        background-color: ${g.background};
        color: ${g.text};
        padding: 16px;
        border-radius: 12px;
        width: 100%;
        max-width: ${Ti.MAX_WIDTH}px;
        min-width: ${Ti.MIN_WIDTH};
        border: 1px solid ${g.border};
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
    `;const p=document.createElement("style");p.textContent=`
        /* iOS audio improvements */
        .jmon-music-player-container {
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .jmon-music-player-play {
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        /* Button hover effects */
        .jmon-music-player-btn-vertical:hover {
            background-color: #555555 !important;
            transform: translateY(-1px);
        }
        .jmon-music-player-btn-vertical:active {
            transform: translateY(0px);
        }
        
        /* Large screens: Show vertical downloads, hide horizontal ones, horizontal track layout */
        @media (min-width: 600px) {
            .jmon-music-player-downloads {
                display: none !important;
            }
            .jmon-music-player-vertical-downloads {
                display: flex !important;
            }
            .jmon-music-player-top {
                gap: 32px !important;
            }
            .jmon-music-player-right {
                min-width: 140px !important;
                max-width: 160px !important;
            }
            .jmon-track-selector {
                flex-direction: row !important;
                align-items: center !important;
                gap: 16px !important;
            }
            .jmon-track-selector label {
                min-width: 120px !important;
                margin-bottom: 0 !important;
                flex-shrink: 0 !important;
            }
            .jmon-track-selector select {
                flex: 1 !important;
            }
        }
        
        /* Medium screens: Compact layout with horizontal track selectors */
        @media (min-width: 481px) and (max-width: 799px) {
            .jmon-music-player-downloads {
                display: none !important;
            }
            .jmon-music-player-vertical-downloads {
                display: flex !important;
            }
            .jmon-music-player-top {
                gap: 20px !important;
            }
            .jmon-music-player-right {
                min-width: 120px !important;
                max-width: 140px !important;
            }
            .jmon-track-selector {
                flex-direction: row !important;
                align-items: center !important;
                gap: 12px !important;
            }
            .jmon-track-selector label {
                min-width: 100px !important;
                margin-bottom: 0 !important;
                flex-shrink: 0 !important;
                font-size: 14px !important;
            }
            .jmon-track-selector select {
                flex: 1 !important;
            }
        }
        
        /* Small screens: Mobile layout */
        @media (max-width: 480px) {
            .jmon-music-player-downloads {
                display: flex !important;
            }
            .jmon-music-player-vertical-downloads {
                display: none !important;
            }
            .jmon-music-player-container {
                padding: 8px !important;
                border-radius: 8px !important;
                max-width: 100vw !important;
                min-width: 0 !important;
                box-shadow: none !important;
            }
            .jmon-music-player-top {
                flex-direction: column !important;
                gap: 12px !important;
                align-items: stretch !important;
            }
            .jmon-music-player-left, .jmon-music-player-right {
                width: 100% !important;
                min-width: 0 !important;
                max-width: none !important;
                flex: none !important;
            }
            .jmon-music-player-right {
                gap: 12px !important;
            }
            .jmon-track-selector {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 8px !important;
            }
            .jmon-track-selector label {
                min-width: auto !important;
                margin-bottom: 0 !important;
            }
            .jmon-track-selector select {
                flex: none !important;
            }
            .jmon-music-player-timeline {
                gap: 8px !important;
                margin: 6px 0 !important;
            }
            .jmon-music-player-downloads {
                flex-direction: column !important;
                gap: 8px !important;
                margin-top: 6px !important;
            }
            .jmon-music-player-btn {
                min-height: 40px !important;
                font-size: 14px !important;
                padding: 10px 0 !important;
            }
            .jmon-music-player-play {
                width: 40px !important;
                height: 40px !important;
                min-width: 40px !important;
                max-width: 40px !important;
                padding: 8px !important;
                margin: 0 4px !important;
                border-radius: 50% !important;
                flex-shrink: 0 !important;
            }
            .jmon-music-player-stop {
                width: 40px !important;
                height: 40px !important;
                min-width: 40px !important;
                max-width: 40px !important;
                padding: 8px !important;
                margin: 0 4px !important;
                flex-shrink: 0 !important;
            }
        }
    `,document.head.appendChild(p),h.classList.add("jmon-music-player-container");const u=document.createElement("div");u.style.cssText=`
        display: grid;
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto;
        gap: 12px;
        margin-bottom: 0px;
        font-family: 'PT Sans', sans-serif;
    `,u.classList.add("jmon-music-player-main");const f=document.createElement("div");f.style.cssText=`
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        font-family: 'PT Sans', sans-serif;
        gap: 24px;
        flex-wrap: wrap;
    `,f.classList.add("jmon-music-player-top");const y=document.createElement("div");y.style.cssText=`
        display: flex;
        flex-direction: column;
        flex: 1;
        min-width: 0;
        box-sizing: border-box;
    `,y.classList.add("jmon-music-player-left");const $=document.createElement("div");$.style.cssText=`
        display: flex;
        flex-direction: column;
        gap: 6px;
    `;const b=Ei(),S=s.tracks||[],x=[];S.forEach((G,U)=>{const K=v.find(he=>he.originalTrackIndex===U)?.analysis;K?.hasGlissando&&console.warn(`Track ${G.label||G.name||U+1} contient un glissando : la polyphonie sera dsactive pour cette piste.`);const H=document.createElement("div");H.style.cssText=`
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        `,H.classList.add("jmon-track-selector");const re=document.createElement("label");re.textContent=G.label||`Track ${U+1}`,re.style.cssText=`
            font-family: 'PT Sans', sans-serif;
            font-size: 16px;
            color: ${g.text};
            display: block;
            margin-bottom: 0;
            font-weight: normal;
            flex-shrink: 0;
        `;const ce=document.createElement("select");ce.style.cssText=`
            padding: 4px;
            border: 1px solid ${g.secondary};
            border-radius: 4px;
            background-color: ${g.background};
            color: ${g.text};
            font-size: 12px;
            width: 100%;
            height: 28px;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            margin: 0;
            outline: none;
        `;const _e=document.createElement("optgroup");_e.label="Synthesizers";const we=["PolySynth","Synth","AMSynth","DuoSynth","FMSynth","MembraneSynth","MetalSynth","MonoSynth","PluckSynth"],Re=s.audioGraph||[];if(Array.isArray(Re)&&Re.length>0){const he=s.tracks?.[U]?.synthRef;Re.forEach(ee=>{if(ee.id&&ee.type&&ee.type!=="Destination"){const $e=document.createElement("option");$e.value=`AudioGraph: ${ee.id}`,$e.textContent=ee.id,he===ee.id&&($e.selected=!0),_e.appendChild($e)}})}we.forEach(he=>{const ee=document.createElement("option");ee.value=he,ee.textContent=he,(K?.hasGlissando&&he==="Synth"||!K?.hasGlissando&&!s.tracks?.[U]?.synthRef&&he==="PolySynth")&&(ee.selected=!0),K?.hasGlissando&&(he==="PolySynth"||he==="DuoSynth")&&(ee.disabled=!0,ee.textContent+=" (mono only for glissando)"),_e.appendChild(ee)}),ce.appendChild(_e);const Le=document.createElement("optgroup");Le.label="Sampled Instruments";const ke={};b.forEach(he=>{ke[he.category]||(ke[he.category]=[]),ke[he.category].push(he)}),Object.keys(ke).sort().forEach(he=>{const ee=document.createElement("optgroup");ee.label=he,ke[he].forEach($e=>{const se=document.createElement("option");se.value=`GM: ${$e.name}`,se.textContent=$e.name,K?.hasGlissando&&(se.disabled=!0,se.textContent+=" (not suitable for glissando)"),ee.appendChild(se)}),ce.appendChild(ee)}),x.push(ce),H.append(re,ce),$.appendChild(H)}),y.appendChild($);const N=document.createElement("div");N.style.cssText=`
        display: flex;
        flex-direction: column;
        min-width: 120px;
        max-width: 150px;
        box-sizing: border-box;
        gap: 16px;
    `,N.classList.add("jmon-music-player-right");const z=document.createElement("div");z.style.cssText=`
        display: flex;
        flex-direction: column;
        width: 100%;
        min-width: 0;
        box-sizing: border-box;
    `;const q=document.createElement("label");q.textContent="Tempo",q.style.cssText=`
        font-family: 'PT Sans', sans-serif;
        font-size: 16px;
        font-weight: normal;
        margin-bottom: 8px;
        color: ${g.text};
    `;const L=document.createElement("input");L.type="number",L.min=60,L.max=240,L.value=l,L.style.cssText=`
        padding: 4px;
        border: 1px solid ${g.secondary};
        border-radius: 4px;
        background-color: ${g.background};
        color: ${g.text};
        font-size: 12px;
        text-align: center;
        width: 100%;
        height: 28px;
        box-sizing: border-box;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        margin: 0;
        outline: none;
    `,z.append(q,L);const F=document.createElement("div");F.style.cssText=`
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 8px;
    `,F.classList.add("jmon-music-player-vertical-downloads");const X=document.createElement("button");X.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-keyboard-music" style="margin-right: 8px;"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="M6 8h4"/><path d="M14 8h.01"/><path d="M18 8h.01"/><path d="M2 12h20"/><path d="M6 12v4"/><path d="M10 12v4"/><path d="M14 12v4"/><path d="M18 12v4"/></svg><span>MIDI</span>',X.style.cssText=`
        padding: 12px 16px;
        border: none;
        border-radius: 8px;
        background-color: #333333;
        color: white;
        font-family: 'PT Sans', sans-serif;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 44px;
        box-sizing: border-box;
    `,X.classList.add("jmon-music-player-btn-vertical");const oe=document.createElement("button");oe.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-audio-lines" style="margin-right: 8px;"><path d="M2 10v3"/><path d="M6 6v11"/><path d="M10 3v18"/><path d="M14 8v7"/><path d="M18 5v13"/><path d="M22 10v3"/></svg><span>WAV</span>',oe.style.cssText=`
        padding: 12px 16px;
        border: none;
        border-radius: 8px;
        background-color: #333333;
        color: white;
        font-family: 'PT Sans', sans-serif;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 44px;
        box-sizing: border-box;
    `,oe.classList.add("jmon-music-player-btn-vertical"),F.append(X,oe),F.style.display="none",N.append(z,F);const Se=document.createElement("div");Se.style.cssText=`
        position: relative;
        width: 100%;
        margin: ${Cr.MARGIN};
        display: flex;
        align-items: center;
        gap: ${Cr.GAP}px;
        min-width: 0;
        box-sizing: border-box;
    `,Se.classList.add("jmon-music-player-timeline");const ye=document.createElement("div");ye.textContent="0:00",ye.style.cssText=`
        font-family: 'PT Sans', sans-serif;
        font-size: 14px;
        color: ${g.text};
        min-width: 40px;
        text-align: center;
    `;const ne=document.createElement("div");ne.textContent="0:00",ne.style.cssText=`
        font-family: 'PT Sans', sans-serif;
        font-size: 14px;
        color: ${g.text};
        min-width: 40px;
        text-align: center;
    `;const de=document.createElement("input");de.type="range",de.min=0,de.max=100,de.value=0,de.style.cssText=`
        flex-grow: 1;
        -webkit-appearance: none;
        background: ${g.secondary};
        outline: none;
        border-radius: 15px;
        overflow: visible;
        height: 8px;
    `;const I=document.createElement("style");I.textContent=`
        input[type="range"].jmon-timeline-slider {
            background: ${g.secondary} !important;
            border: 1px solid ${g.border} !important;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1) !important;
        }
        input[type="range"].jmon-timeline-slider::-webkit-slider-track {
            background: ${g.secondary} !important;
            height: 8px !important;
            border-radius: 15px !important;
            border: 1px solid ${g.border} !important;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1) !important;
        }
        input[type="range"].jmon-timeline-slider::-moz-range-track {
            background: ${g.secondary} !important;
            height: 8px !important;
            border-radius: 15px !important;
            border: 1px solid ${g.border} !important;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1) !important;
        }
        input[type="range"].jmon-timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none !important;
            appearance: none !important;
            height: 20px !important;
            width: 20px !important;
            border-radius: 50% !important;
            background: ${g.primary} !important;
            cursor: pointer !important;
            border: 2px solid ${g.background} !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2) !important;
        }
        input[type="range"].jmon-timeline-slider::-moz-range-thumb {
            height: 20px !important;
            width: 20px !important;
            border-radius: 50% !important;
            background: ${g.primary} !important;
            cursor: pointer !important;
            border: 2px solid ${g.background} !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2) !important;
        }
    `,document.head.appendChild(I),de.classList.add("jmon-timeline-slider");const k=document.createElement("button");k.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>',k.style.cssText=`
        width: 40px;
        height: 40px;
        min-width: 40px;
        max-width: 40px;
        padding: 8px;
        border: none;
        border-radius: 50%;
        background-color: ${g.primary};
        color: ${g.background};
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0px 5px 0px 10px;
        box-sizing: border-box;
        flex-shrink: 0;
    `,k.classList.add("jmon-music-player-play");const O=document.createElement("button");O.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>',O.style.cssText=`
        width: 40px;
        height: 40px;
        min-width: 40px;
        max-width: 40px;
        padding: 8px;
        border: none;
        border-radius: 8px;
        background-color: ${g.secondary};
        color: ${g.text};
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0px 5px 0px 0px;
        box-sizing: border-box;
        flex-shrink: 0;
    `,O.classList.add("jmon-music-player-stop");const R=document.createElement("div");R.style.cssText=`
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: ${g.lightText};
        margin: 0px 0px 0px 10px;
    `;const _=document.createElement("div");_.style.cssText=`
        display: flex;
        align-items: center;
        gap: 0px;
    `,_.append(k,O),Se.append(ye,de,ne,_);const E=document.createElement("div");E.style.cssText=`
        display: flex;
        justify-content: space-between;
        margin-top: 8px;
        gap: 10px;
        min-width: 0;
        box-sizing: border-box;
    `,E.classList.add("jmon-music-player-downloads");const C=document.createElement("button");C.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-keyboard-music" style="margin-right: 5px;"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="M6 8h4"/><path d="M14 8h.01"/><path d="M18 8h.01"/><path d="M2 12h20"/><path d="M6 12v4"/><path d="M10 12v4"/><path d="M14 12v4"/><path d="M18 12v4"/></svg><span>MIDI</span>',C.style.cssText=`
        padding: 15px 30px;
        margin: 0 5px;
        border: none;
        border-radius: 8px;
        background-color: #333333;
        color: white;
        font-family: 'PT Sans', sans-serif;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s ease;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 50px;
        min-width: 0;
        box-sizing: border-box;
    `,C.classList.add("jmon-music-player-btn");const V=document.createElement("button");V.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-audio-lines" style="margin-right: 5px;"><path d="M2 10v3"/><path d="M6 6v11"/><path d="M10 3v18"/><path d="M14 8v7"/><path d="M18 5v13"/><path d="M22 10v3"/></svg><span>WAV</span>',V.style.cssText=`
        padding: 15px 30px;
        margin: 0 5px;
        border: none;
        border-radius: 8px;
        background-color: #333333;
        color: white;
        font-family: 'PT Sans', sans-serif;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s ease;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 50px;
        min-width: 0;
        box-sizing: border-box;
    `,V.classList.add("jmon-music-player-btn"),E.append(C,V),f.append(y,N),u.appendChild(f),u.appendChild(Se),h.append(u,E);let M,J=!1,W=[],T=[],A=[],j=null;const D=s.tracks||[],B=()=>{if(!M||!s.audioGraph||!Array.isArray(s.audioGraph))return null;const G={},U=K=>{const H={};return Object.entries(K||{}).forEach(([re,ce])=>{let _e=re;if(typeof re=="number"||/^\d+$/.test(String(re)))try{_e=M.Frequency(parseInt(re,10),"midi").toNote()}catch{}H[_e]=ce}),H};try{return s.audioGraph.forEach(K=>{const{id:H,type:re,options:ce={},target:_e}=K;if(!H||!re)return;let we=null;if(re==="Sampler"){const Re=U(ce.urls);let Le,ke;const he=new Promise(($e,se)=>{Le=$e,ke=se}),ee={urls:Re,onload:()=>Le&&Le(),onerror:$e=>{console.error(`[PLAYER] Sampler load error for ${H}:`,$e),ke&&ke($e)}};ce.baseUrl&&(ee.baseUrl=ce.baseUrl);try{console.log(`[PLAYER] Building Sampler ${H} with urls:`,Re,"baseUrl:",ee.baseUrl||"(none)"),we=new M.Sampler(ee)}catch($e){console.error("[PLAYER] Failed to create Sampler:",$e),we=null}A.push(he),we&&ce.envelope&&ce.envelope.enabled&&(typeof ce.envelope.attack=="number"&&(we.attack=ce.envelope.attack),typeof ce.envelope.release=="number"&&(we.release=ce.envelope.release))}else if(Hs.includes(re))try{we=new M[re](ce)}catch(Re){console.warn(`[PLAYER] Failed to create ${re} from audioGraph, using PolySynth:`,Re),we=new M.PolySynth}else if(Ys.includes(re))try{we=new M[re](ce),console.log(`[PLAYER] Created effect ${H} (${re}) with options:`,ce)}catch(Re){console.warn(`[PLAYER] Failed to create ${re} effect:`,Re),we=null}else re==="Destination"&&(G[H]=M.Destination);we&&(G[H]=we)}),Object.keys(G).length>0&&s.audioGraph.forEach(K=>{const{id:H,target:re}=K;if(!H||!G[H])return;const ce=G[H];if(ce!==M.Destination)if(re&&G[re])try{G[re]===M.Destination?(ce.toDestination(),console.log(`[PLAYER] Connected ${H} -> Destination`)):(ce.connect(G[re]),console.log(`[PLAYER] Connected ${H} -> ${re}`))}catch(_e){console.warn(`[PLAYER] Failed to connect ${H} -> ${re}:`,_e),ce.toDestination()}else ce.toDestination(),console.log(`[PLAYER] Connected ${H} -> Destination (no target specified)`)}),G}catch(K){return console.error("[PLAYER] Failed building audioGraph instruments:",K),null}},Q=()=>/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,le=G=>`${Math.floor(G/60)}:${Math.floor(G%60).toString().padStart(2,"0")}`;ne.textContent=le(P);const Te=async()=>{if(typeof window<"u"){const G=a||window.Tone||(typeof M<"u"?M:null);if(G)console.log("[PLAYER] Using existing Tone.js, version:",G.version||"unknown"),window.Tone=G;else try{if(typeof require<"u"){console.log("[PLAYER] Loading Tone.js via require()...");const K=await require("tone@14.8.49/build/Tone.js");window.Tone=K.default||K.Tone||K}else{console.log("[PLAYER] Loading Tone.js via import()...");const K=await import("https://esm.sh/tone@14.8.49");window.Tone=K.default||K.Tone||K}if(!window.Tone||typeof window.Tone!="object"||!window.Tone.PolySynth){console.warn("[PLAYER] First load attempt failed, trying alternative CDN...");try{const K=await import("https://cdn.skypack.dev/tone@14.8.49");if(window.Tone=K.default||K.Tone||K,!window.Tone||!window.Tone.PolySynth)throw new Error("Alternative CDN also failed")}catch{console.warn("[PLAYER] Alternative CDN failed, trying jsdelivr...");try{const H=await import("https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js");if(window.Tone=H.default||H.Tone||H,!window.Tone||!window.Tone.PolySynth)throw new Error("All CDN attempts failed")}catch{throw new Error("Loaded Tone.js but got invalid object from all CDNs")}}}console.log("[PLAYER] Tone.js loaded successfully, version:",window.Tone.version||"unknown")}catch(K){return console.warn("Could not auto-load Tone.js:",K.message),console.log("To use the player, load Tone.js manually first using one of these methods:"),console.log('Method 1: Tone = await require("tone@14.8.49/build/Tone.js")'),console.log('Method 2: Tone = await import("https://esm.sh/tone@14.8.49").then(m => m.default)'),console.log('Method 3: Tone = await import("https://cdn.skypack.dev/tone@14.8.49").then(m => m.default)'),!1}const U=window.Tone||G;if(U)return M=U,console.log("[PLAYER] Available Tone constructors:",{PolySynth:typeof M.PolySynth,Synth:typeof M.Synth,Part:typeof M.Part,Transport:typeof M.Transport,start:typeof M.start,context:!!M.context}),console.log("[PLAYER] Tone.js initialized, context state:",M.context?M.context.state:"no context"),Q()&&console.log("[PLAYER] iOS device detected - audio context will start on user interaction"),!0}return console.warn("Tone.js not available"),!1},fe=()=>{if(!M){console.warn("[PLAYER] Tone.js not available, cannot setup audio");return}const G=[];if(M.PolySynth||G.push("PolySynth"),M.Synth||G.push("Synth"),M.Part||G.push("Part"),M.Transport||G.push("Transport"),G.length>0){console.error("[PLAYER] Tone.js is missing required constructors:",G),console.error("[PLAYER] Available Tone properties:",Object.keys(M).filter(U=>typeof M[U]=="function").slice(0,20)),console.error("[PLAYER] Tone object:",M),console.error("[PLAYER] This usually means Tone.js did not load correctly. Try refreshing the page or loading Tone.js manually.");return}if(M.Transport.bpm.value=w.tempo,console.log(`[PLAYER] Set Transport BPM to ${w.tempo} before building instruments`),!j&&(j=B(),j)){const U=Object.keys(j).filter(K=>j[K]&&j[K].name==="Sampler");U.length>0&&console.log("[PLAYER] Using audioGraph Samplers for tracks with synthRef:",U)}console.log("[PLAYER] Cleaning up existing audio...",{synths:W.length,parts:T.length}),M.Transport.stop(),M.Transport.position=0,T.forEach((U,K)=>{try{U.stop()}catch(H){console.warn(`[PLAYER] Failed to stop part ${K}:`,H)}}),T.forEach((U,K)=>{try{U.dispose()}catch(H){console.warn(`[PLAYER] Failed to dispose part ${K}:`,H)}}),W.forEach((U,K)=>{if(!j||!Object.values(j).includes(U))try{U.disconnect&&typeof U.disconnect=="function"&&U.disconnect(),U.dispose()}catch(H){console.warn(`[PLAYER] Failed to dispose synth ${K}:`,H)}}),W=[],T=[],console.log("[PLAYER] Audio cleanup completed"),console.log("[PLAYER] Converted tracks:",v.length),v.forEach(U=>{const{originalTrackIndex:K,voiceIndex:H,totalVoices:re,trackInfo:ce,synthConfig:_e,partEvents:we}=U,Le=(D[K]||{}).synthRef,ke=60/w.tempo,he=(we||[]).map(se=>{const Y=typeof se.time=="number"?se.time*ke:se.time,ue=typeof se.duration=="number"?se.duration*ke:se.duration;return{...se,time:Y,duration:ue}});let ee=null;if(Le&&j&&j[Le])ee=j[Le];else{const se=x[K]?x[K].value:_e.type;try{if(se.startsWith("AudioGraph: ")){const Y=se.substring(12);if(j&&j[Y])ee=j[Y],console.log(`[PLAYER] Using audioGraph instrument: ${Y}`);else throw new Error(`AudioGraph instrument ${Y} not found`)}else if(se.startsWith("GM: ")){const Y=se.substring(4),ue=b.find(me=>me.name===Y);if(ue){console.log(`[PLAYER] Loading GM instrument: ${Y}`);const me=lt(ue.program,Rr[0],[36,84],"balanced");console.log(`[PLAYER] Loading GM instrument ${Y} with ${Object.keys(me).length} samples`),console.log("[PLAYER] Sample notes:",Object.keys(me).sort()),ee=new M.Sampler({urls:me,onload:()=>console.log(`[PLAYER] GM instrument ${Y} loaded successfully`),onerror:Ce=>{console.error(`[PLAYER] Failed to load GM instrument ${Y}:`,Ce)}}).toDestination()}else throw new Error(`GM instrument ${Y} not found`)}else{const Y=_e.reason==="glissando_compatibility"?_e.type:se;if(!M[Y]||typeof M[Y]!="function")throw new Error(`Tone.${Y} is not a constructor`);ee=new M[Y]().toDestination(),_e.reason==="glissando_compatibility"&&H===0&&console.warn(`[MULTIVOICE] Using ${Y} instead of ${_e.original} for glissando in ${ce.label}`)}}catch(Y){console.warn(`Failed to create ${se}, using PolySynth:`,Y);try{if(!M.PolySynth||typeof M.PolySynth!="function")throw new Error("Tone.PolySynth is not available");ee=new M.PolySynth().toDestination()}catch(ue){console.error("Fatal: Cannot create any synth, Tone.js may not be properly loaded:",ue);return}}}W.push(ee),re>1&&console.log(`[MULTIVOICE] Track "${ce.label}" voice ${H+1}: ${we.length} notes`);const $e=new M.Part((se,Y)=>{if(Array.isArray(Y.pitch))Y.pitch.forEach(ue=>{let me="C4";typeof ue=="number"?me=M.Frequency(ue,"midi").toNote():typeof ue=="string"?me=ue:Array.isArray(ue)&&typeof ue[0]=="string"&&(me=ue[0]),ee.triggerAttackRelease(me,Y.duration,se)});else if(Y.articulation==="glissando"&&Y.glissTarget!==void 0){let ue=typeof Y.pitch=="number"?M.Frequency(Y.pitch,"midi").toNote():Y.pitch,me=typeof Y.glissTarget=="number"?M.Frequency(Y.glissTarget,"midi").toNote():Y.glissTarget;console.log("[PLAYER] Glissando",{fromNote:ue,toNote:me,duration:Y.duration,time:se}),console.log("[PLAYER] Glissando effect starting from",ue,"to",me),ee.triggerAttack(ue,se,Y.velocity||.8);const Ce=M.Frequency(ue).toFrequency(),ji=M.Frequency(me).toFrequency(),Oi=1200*Math.log2(ji/Ce);if(ee.detune&&ee.detune.setValueAtTime&&ee.detune.linearRampToValueAtTime)ee.detune.setValueAtTime(0,se),ee.detune.linearRampToValueAtTime(Oi,se+Y.duration),console.log("[PLAYER] Applied detune glissando:",Oi,"cents over",Y.duration,"beats");else{const ha=M.Frequency(ue).toMidi(),fa=M.Frequency(me).toMidi(),sr=Math.max(3,Math.abs(fa-ha)),Ii=Y.duration/sr;for(let ar=1;ar<sr;ar++){const pa=ar/(sr-1),ma=Ce*Math.pow(ji/Ce,pa),ga=M.Frequency(ma).toNote(),ya=se+ar*Ii;ee.triggerAttackRelease(ga,Ii*.8,ya,(Y.velocity||.8)*.7)}console.log("[PLAYER] Applied chromatic glissando with",sr,"steps")}ee.triggerRelease(se+Y.duration)}else{let ue="C4";typeof Y.pitch=="number"?ue=M.Frequency(Y.pitch,"midi").toNote():typeof Y.pitch=="string"?ue=Y.pitch:Array.isArray(Y.pitch)&&typeof Y.pitch[0]=="string"&&(ue=Y.pitch[0]);let me=Y.duration,Ce=Y.velocity||.8;Y.articulation==="staccato"&&(me=Y.duration*.5),Y.articulation==="accent"&&(Ce=Math.min(Ce*2,1)),Y.articulation==="tenuto"&&(me=Y.duration*1.5,Ce=Math.min(Ce*1.3,1)),ee.triggerAttackRelease(ue,me,se,Ce)}},he);T.push($e)}),M.Transport.loopEnd=P,M.Transport.loop=!0,M.Transport.stop(),M.Transport.position=0,ne.textContent=le(P)};let be=0;const pe=Cr.UPDATE_INTERVAL,ze=()=>{const G=performance.now(),U=G-be>=pe;if(M&&J){const K=typeof M.Transport.loopEnd=="number"?M.Transport.loopEnd:M.Time(M.Transport.loopEnd).toSeconds();if(U){const H=M.Transport.seconds%K,re=H/K*100;de.value=Math.min(re,100),ye.textContent=le(H),ne.textContent=le(K),be=G}if(M.Transport.state==="started"&&J)requestAnimationFrame(ze);else if(M.Transport.state==="stopped"||M.Transport.state==="paused"){if(U){const H=M.Transport.seconds%K,re=H/K*100;de.value=Math.min(re,100),ye.textContent=le(H),be=G}M.Transport.state==="stopped"&&(M.Transport.seconds=0,de.value=0,ye.textContent=le(0),J=!1,k.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>')}}};k.addEventListener("click",async()=>{if(!M)if(await Te())fe();else{console.error("[PLAYER] Failed to initialize Tone.js");return}if(J)console.log("[PLAYER] Pausing playback..."),M.Transport.pause(),J=!1,k.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>',console.log("[PLAYER] Playback paused");else{if(!M.context||M.context.state!=="running")try{await M.start(),console.log("[PLAYER] Audio context started:",M.context?M.context.state:"unknown"),M.context&&typeof M.context.resume=="function"&&(await M.context.resume(),console.log("[PLAYER] Audio context resumed for iOS compatibility"))}catch(G){console.error("[PLAYER] Failed to start audio context:",G);let U="Failed to start audio. ";Q()?U+="On iOS, please ensure your device isn't in silent mode and try again.":U+="Please check your audio settings and try again.",alert(U);return}if(W.length===0&&(console.log("[PLAYER] No synths found, setting up audio..."),fe()),M.Transport.state!=="paused"?(M.Transport.stop(),M.Transport.position=0,console.log("[PLAYER] Starting from beginning")):console.log("[PLAYER] Resuming from paused position"),console.log("[PLAYER] Transport state before start:",M.Transport.state),console.log("[PLAYER] Transport position reset to:",M.Transport.position),console.log("[PLAYER] Audio context state:",M.context?M.context.state:"unknown"),console.log("[PLAYER] Parts count:",T.length),console.log("[PLAYER] Synths count:",W.length),j){const G=Object.values(j).filter(U=>U&&U.name==="Sampler");if(G.length>0&&A.length>0){console.log(`[PLAYER] Waiting for ${G.length} sampler(s) to load...`);try{await Promise.all(A),console.log("[PLAYER] All samplers loaded.")}catch(U){console.warn("[PLAYER] Sampler load wait error:",U);return}}}if(T.length===0){console.error("[PLAYER] No parts available to start. This usually means setupAudio() failed."),console.error("[PLAYER] Try refreshing the page or check if Tone.js is properly loaded.");return}M.Transport.state!=="paused"&&T.forEach((G,U)=>{if(!G||typeof G.start!="function"){console.error(`[PLAYER] Part ${U} is invalid:`,G);return}try{G.start(0)}catch(K){console.error(`[PLAYER] Failed to start part ${U}:`,K)}}),M.Transport.start(),J=!0,k.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-pause"><circle cx="12" cy="12" r="10"/><line x1="10" x2="10" y1="15" y2="9"/><line x1="14" x2="14" y1="15" y2="9"/></svg>',ze()}}),O.addEventListener("click",async()=>{M&&(console.log("[PLAYER] Stopping playback completely..."),M.Transport.stop(),M.Transport.cancel(),M.Transport.position=0,T.forEach((G,U)=>{try{G.stop()}catch(K){console.warn(`[PLAYER] Failed to stop part ${U} during complete stop:`,K)}}),J=!1,de.value=0,ye.textContent=le(0),k.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>',console.log("[PLAYER] Playback stopped completely"))}),de.addEventListener("input",()=>{if(M&&P>0){const G=de.value/100*P,U=J;U&&M.Transport.pause(),M.Transport.seconds=G,ye.textContent=le(G),U&&setTimeout(()=>{M.Transport.start()},50)}}),L.addEventListener("change",()=>{const G=parseInt(L.value);M&&G>=60&&G<=240?(console.log(`[PLAYER] Tempo changed to ${G} BPM`),M.Transport.bpm.value=G,console.log(`[PLAYER] Tempo changed to ${G} BPM`)):L.value=M?M.Transport.bpm.value:l}),x.forEach(G=>{G.addEventListener("change",()=>{if(M&&W.length>0){console.log("[PLAYER] Synthesizer selection changed, reinitializing audio...");const U=J;J&&(M.Transport.stop(),J=!1),fe(),U?setTimeout(()=>{M.Transport.start(),J=!0,k.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-pause"><circle cx="12" cy="12" r="10"/><line x1="10" x2="10" y1="15" y2="9"/><line x1="14" x2="14" y1="15" y2="9"/></svg>'},100):k.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>'}})});const Ee=()=>{console.log("MIDI download - requires MIDI converter implementation")},et=()=>{console.log("WAV download - requires WAV generator implementation")};C.addEventListener("click",Ee),V.addEventListener("click",et),X.addEventListener("click",Ee),oe.addEventListener("click",et);const tt=typeof window<"u"&&window.Tone||(typeof M<"u"?M:null);if(tt&&Te().then(()=>{fe(),t&&setTimeout(()=>{k.click()},500)}),t&&!tt){const G=setInterval(()=>{(typeof window<"u"&&window.Tone||(typeof M<"u"?M:null))&&(clearInterval(G),setTimeout(()=>{k.click()},500))},100);setTimeout(()=>{clearInterval(G)},1e4)}return h}function Ir(s,e=.25,t="nearest"){if(typeof s!="number"||!isFinite(s))return s;const r=s/e;let n;switch(t){case"floor":n=Math.floor(r);break;case"ceil":n=Math.ceil(r);break;case"nearest":default:n=Math.round(r)}return n*e}function xi(s,{grid:e=.25,fields:t=["time","duration"],mode:r="nearest"}={}){return Array.isArray(s)?s.map(n=>{const i={...n};return t.forEach(o=>{typeof i[o]=="number"&&(i[o]=Ir(i[o],e,r))}),i}):s}function ki(s,{grid:e=.25,mode:t="nearest"}={}){return!s||!Array.isArray(s.notes)?s:{...s,notes:xi(s.notes,{grid:e,fields:["time","duration"],mode:t})}}function Xs(s,{grid:e=.25,mode:t="nearest"}={}){return!s||!Array.isArray(s.tracks)?s:{...s,tracks:s.tracks.map(r=>ki(r,{grid:e,mode:t}))}}function Mi(s,e=.25){const t=Math.round(1/e),r=Math.round(s/e);return r<=0||r===t?"":r%t===0?String(r/t):`${r}/${t}`}const ir=Object.freeze(Object.defineProperty({__proto__:null,encodeAbcDuration:Mi,quantize:Ir,quantizeComposition:Xs,quantizeEvents:xi,quantizeTrack:ki},Symbol.toStringTag,{value:"Module"}));class Qs{static fromValidatedJmon(e){const t=new $r,{valid:r,normalized:n,errors:i}=t.validateAndNormalize(e);if(!r)throw console.warn("JMON non valide pour conversion ABC:",i),new Error("JMON non valide");return this.convertToAbc(n)}static parseTimeString(e,t){if(typeof e=="number")return e;if(typeof e!="string")return 0;try{if(jmonTone&&jmonTone._parseTimeString)return jmonTone._parseTimeString(e,t)}catch{}if(e.includes(":")){const r=e.split(":").map(parseFloat),n=r[0]||0,i=r[1]||0,o=r[2]||0,a=60/t,c=a*4,l=a/480;return n*c+i*a+o*l}if(e.match(/^\d+[nthq]$/)){const r=parseInt(e),n=e.slice(-1),i=60/t;switch(n){case"n":return i*(4/r);case"t":return i*(4/r)*(2/3);case"h":return i*2;case"q":return i;default:return i}}return parseFloat(e)||0}static convertToAbc(e,t={}){let r=`X:1
`;r+=`T:${e.metadata?.title||e.metadata?.name||e.meta?.title||e.meta?.name||e.label||"Untitled"}
`;const n=e.metadata?.composer||e.metadata?.author||e.meta?.composer||e.meta?.author;n&&(r+=`C:${n}
`),r+=`M:${e.timeSignature||"4/4"}
`,r+=`L:1/4
`,r+=`Q:1/4=${e.tempo||e.bpm||120}
`,r+=`K:${e.keySignature||"C"}
`;const i=e.timeSignature||"4/4",[o,a]=i.split("/").map(Number),c=o*(4/a),l=t.measuresPerLine||4,d=t.lineBreaks||[],m=t.renderMode||"merged",v=t.trackIndex||0,w=!!t.hideRests,P=t.showArticulations!==!1,g=Array.isArray(e.tracks)?e.tracks:Object.values(e.tracks||{});if(g.length===0)return r;const h=(()=>{let u=0;return g.forEach(f=>{const y=f.notes||f;Array.isArray(y)&&y.forEach($=>{const b=typeof $.time=="number"?$.time:0,S=typeof $.duration=="number"?$.duration:1,x=b+S;x>u&&(u=x)})}),u})(),p=Math.max(1,Math.ceil(h/c));if(m==="tracks"&&g.length>1)r+="%%score {",g.forEach((u,f)=>{f>0&&(r+=" | "),r+=`${f+1}`}),r+=`}
`,g.forEach((u,f)=>{const y=u.notes||u;if(y.length===0)return;const $=f+1,b=u.label||`Track ${f+1}`,S=b.length>12?b.substring(0,10)+"..":b,x=u.instrument?` [${u.instrument}]`:"";r+=`V:${$} name="${b}${x}" snm="${S}"
`;const N=y.filter(q=>q.pitch!==void 0).sort((q,L)=>(q.time||0)-(L.time||0)),{abcNotesStr:z}=this.convertNotesToAbc(N,c,l,d,{hideRests:w,showArticulations:P,padMeasures:p});z.trim()&&(r+=z+`
`)});else if(m==="drums"){r+=`V:1 clef=perc name="Drum Set" snm="Drums"
`;const u=t.percussionMap||{kick:"C,,",snare:"D,",hat:"F","hi-hat":"F",hihat:"F"},f=S=>{const x=(S||"").toLowerCase();for(const N of Object.keys(u))if(x.includes(N))return u[N];return"E"},y=[];g.forEach(S=>{const x=S.notes||S,N=S.label||"",z=f(N);(x||[]).forEach(q=>{q.pitch!==void 0&&y.push({time:typeof q.time=="number"?q.time:0,duration:typeof q.duration=="number"?q.duration:1,pitch:z,articulation:q.articulation})})});const $=y.sort((S,x)=>(S.time||0)-(x.time||0)),{abcNotesStr:b}=this.convertNotesToAbc($,c,l,d,{hideRests:w,showArticulations:P,padMeasures:p});b.trim()&&(r+=b+`
`)}else if(m==="single"){const u=g[v];if(u){const y=(u.notes||u).filter(b=>b.pitch!==void 0).sort((b,S)=>(b.time||0)-(S.time||0)),{abcNotesStr:$}=this.convertNotesToAbc(y,c,l,d,{hideRests:w,showArticulations:P,padMeasures:p});$.trim()&&(r+=$+`
`)}}else{const u=[];g.forEach($=>{($.notes||$).forEach(S=>{S.pitch!==void 0&&u.push(S)})});const f=u.sort(($,b)=>($.time||0)-(b.time||0)),{abcNotesStr:y}=this.convertNotesToAbc(f,c,l,d,{hideRests:w,showArticulations:P,padMeasures:p});y.trim()&&(r+=y+`
`)}return r}static convertNotesToAbc(e,t,r,n,i={}){let o="",a=0,c=0,l=0,d=0;const m=i?.quantizeBeats||.25,v=1e-6,w=y=>Ir(y,m,"nearest"),P=y=>Mi(y,m),g=y=>{o+=y+" "},h=()=>{for(;a>=t-1e-9;)g("|"),a-=t,c++,l++,(n.includes(c)||l>=r)&&(o+=`
`,l=0)},p=(y,{forceVisible:$=!1}={})=>{let b=y;for(;b>0;){const S=t-a,x=w(Math.min(b,S));let N=i.hideRests&&!$?"x":"z";N+=P(x),g(N),a=w(a+x),h(),b=w(b-x)}};for(const y of e){const $=typeof y.time=="number"?w(y.time):0,b=typeof y.duration=="number"?w(y.duration):1,S=w($-d);S>v&&p(S);let x="z";if(Array.isArray(y.pitch)){const z=q=>{const L=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],F=Math.floor(q/12)-1,X=q%12;let oe=L[X].replace("#","^");return F>=4?(oe=oe.toLowerCase(),F>4&&(oe+="'".repeat(F-4))):F<4&&(oe=oe.toUpperCase(),F<3&&(oe+=",".repeat(3-F))),oe};x="["+y.pitch.map(z).join("")+"]"}else if(typeof y.pitch=="number"){const z=y.pitch,q=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],L=Math.floor(z/12)-1,F=z%12;x=q[F].replace("#","^"),L>=4?(x=x.toLowerCase(),L>4&&(x+="'".repeat(L-4))):L<4&&(x=x.toUpperCase(),L<3&&(x+=",".repeat(3-L)))}else typeof y.pitch=="string"?x=y.pitch:y.pitch===null&&(x=i.hideRests?"x":"z");let N=x;N+=P(b),i.showArticulations&&(y.articulation==="staccato"&&(N+="."),y.articulation==="accent"&&(N+=">"),y.articulation==="tenuto"&&(N+="-"),y.articulation==="marcato"&&(N+="^")),g(N),a=w(a+b),h(),d=w($+b)}const u=i.padMeasures||0;for(;c<u;){const y=w(t-a);y>v&&p(y,{forceVisible:!0}),g("|"),a=0,c++}const f=o.trim();return f&&!f.endsWith("|")&&(o+="|"),{abcNotesStr:o}}}function Ai(s,e={}){return Qs.convertToAbc(s,e)}class qr{static midiToNoteName(e){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],r=Math.floor(e/12)-1,n=e%12;return t[n]+r}static convert(e){const t=e.tempo||e.bpm||120,r=e.tracks||[];return{header:{bpm:t,timeSignature:e.timeSignature||"4/4"},tracks:r.map(n=>({label:n.label,notes:n.notes.map(i=>({pitch:i.pitch,noteName:typeof i.pitch=="number"?qr.midiToNoteName(i.pitch):i.pitch,time:i.time,duration:i.duration,velocity:i.velocity||.8,articulation:i.articulation||null}))}))}}}function Zs(s){return qr.convert(s)}function ea(s,e={}){return{sampleRate:e.sampleRate||44100,duration:e.duration||10,channels:e.channels||1,tempo:s.tempo||s.bpm||120,notes:s.tracks?.flatMap(t=>t.notes)||[]}}class ta{static convert(e){let r=`// SuperCollider script generated from JMON
// Title: ${e.metadata?.name||"Untitled"}
`;return(e.tracks?.[0]?.notes||[]).forEach(i=>{r+=`Synth("default", ["freq", ${i.pitch}, "dur", ${i.duration}]);
`}),r}}function ra(s){return ta.convert(s)}function na(s){return new $r().validateAndNormalize(s)}function ia(s,e={}){if(!s||typeof s!="object")throw console.error("[RENDER] Invalid JMON object:",s),new Error("render() requires a valid JMON object");return!s.sequences&&!s.tracks&&!s.format&&console.warn("[RENDER] Object does not appear to be JMON format, attempting normalization"),Or(s,e)}function oa(s,e={}){const t={autoplay:!1,...e};return Or(s,t)}async function sa(s,e={}){const{scale:t=.9,staffwidth:r,showAbc:n=!0,responsive:i="resize",abcOptions:o={},ABCJS:a=null,abcjs:c=null,autoload:l=!0}=e,d=Ai(s,o),m=document.createElement("div");m.style.cssText=`
		margin: 15px 0;
		font-family: sans-serif;
	`;const v=document.createElement("div");if(v.id=`rendered-score-${Date.now()}`,v.style.cssText=`
		width: 100%;
		overflow-x: auto;
		margin: 10px 0;
	`,m.appendChild(v),n){const P=document.createElement("details");P.style.marginTop="15px";const g=document.createElement("summary");g.textContent="ABC Notation (click to expand)",g.style.cursor="pointer",P.appendChild(g);const h=document.createElement("pre");h.textContent=d,h.style.cssText=`
			background: #f5f5f5;
			padding: 10px;
			border-radius: 4px;
			overflow-x: auto;
			font-size: 12px;
		`,P.appendChild(h),m.appendChild(P)}let w=a||c||typeof window<"u"&&window.ABCJS||(typeof ABCJS<"u"?ABCJS:null);if(!w&&l)try{if(typeof require<"u")console.log("[SCORE] Loading ABCJS via require()..."),w=await require("abcjs");else{console.log("[SCORE] Loading ABCJS via import()...");const P=await import("https://cdn.skypack.dev/abcjs");w=P.default||P}if(!w||!w.renderAbc){console.warn("[SCORE] First load attempt failed, trying alternative CDN...");try{const P=await import("https://cdn.jsdelivr.net/npm/abcjs@6.4.0/dist/abcjs-basic-min.js");if(w=P.default||P.ABCJS||typeof window<"u"&&window.ABCJS,!w||!w.renderAbc)throw new Error("Alternative CDN also failed")}catch(P){console.warn("[SCORE] Could not auto-load ABCJS:",P.message),w=null}}w&&(console.log("[SCORE] ABCJS loaded successfully, version:",w.version||"unknown"),typeof window<"u"&&(window.ABCJS=w))}catch(P){console.warn("[SCORE] Could not auto-load ABCJS:",P.message),console.log("[SCORE] To use score rendering, load ABCJS manually first:"),console.log('Method 1: ABCJS = await require("abcjs")'),console.log('Method 2: ABCJS = await import("https://cdn.skypack.dev/abcjs").then(m => m.default)'),w=null}if(w&&w.renderAbc)try{const P=r||null,g={responsive:i,scale:t};P&&(g.staffwidth=P),w.renderAbc(v,d,g),setTimeout(()=>{if(v.children.length===0||v.innerHTML.trim()==="")try{w.renderAbc(v,d),v.children.length===0&&(v.innerHTML='<p style="color: red;">ABCJS rendering failed - no content generated</p><pre>'+d+"</pre>")}catch{v.innerHTML="<p>Error with alternative rendering</p><pre>"+d+"</pre>"}},200)}catch(P){console.error("[SCORE] Error rendering with ABCJS:",P),v.innerHTML="<p>Error rendering notation</p><pre>"+d+"</pre>"}else{const P=l?"ABCJS not available and auto-loading failed - showing text notation only":"ABCJS not provided and auto-loading disabled - showing text notation only";v.innerHTML=`<p>${P}</p><pre>`+d+"</pre>",!w&&l&&(console.log("[SCORE] To use visual score rendering, try:"),console.log('ABCJS = await require("abcjs"), then jm.score(composition, { ABCJS })'))}return m}const Dr={render:ia,play:oa,score:sa,validate:na,createPlayer:Or,converters:{abc:Ai,midi:Zs,tonejs:Pi,wav:ea,supercollider:ra},theory:ct.theory,generative:ct.generative,analysis:ct.analysis,constants:ct.constants,utils:{...ct.utils,JmonValidator:$r,quantize:(s,e,t)=>Promise.resolve().then(()=>ir).then(r=>r.quantize(s,e,t)),quantizeEvents:async(s,e)=>(await Promise.resolve().then(()=>ir)).quantizeEvents(s,e),quantizeTrack:async(s,e)=>(await Promise.resolve().then(()=>ir)).quantizeTrack(s,e),quantizeComposition:async(s,e)=>(await Promise.resolve().then(()=>ir)).quantizeComposition(s,e),jmon:ds},instruments:{GM_INSTRUMENTS:Qe,generateSamplerUrls:lt,createGMInstrumentNode:zs,findGMProgramByName:Si,getPopularInstruments:Ei},VERSION:"1.0.0"},aa={loops:{async plotLoops(s,e=4,t=1/4,r=null,n={}){const{LoopVisualizer:i}=await Promise.resolve().then(()=>Ni);return i.plotLoops(s,e,t,r,n)}}};Dr.visualization=aa;let Ze=null,Ri=!1;async function ca(){if(Ri)return Ze;Ri=!0;try{if(typeof window<"u"&&window.Plotly)return Ze=window.Plotly,Ze;if(typeof window>"u"){const e=await import("plotly.js");return Ze=e.default||e,Ze}return null}catch{return console.warn("Plotly.js not available. Visualization methods will return placeholder data."),null}}class or{static async line(e,t={},r="plot"){const n=await ca();if(!n)return{data:e,options:t,type:"line",message:"Plotly.js not available"};const{title:i,width:o=640,height:a=400,color:c="steelblue",xTitle:l="X",yTitle:d="Y"}=t,m={x:e.x,y:e.y,type:"scatter",mode:"lines",line:{color:c,width:2},name:"Line"},v={title:i?{text:i}:void 0,width:o,height:a,xaxis:{title:{text:l}},yaxis:{title:{text:d}}};await n.newPlot(r,[m],v)}static async scatter(e,t={},r="plot"){const{title:n,width:i=640,height:o=400,color:a="steelblue",xTitle:c="X",yTitle:l="Y"}=t,d={x:e.x,y:e.y,type:"scatter",mode:"markers",marker:{color:e.color||a,size:e.size||8},name:"Scatter"},m={title:n?{text:n}:void 0,width:i,height:o,xaxis:{title:{text:c}},yaxis:{title:{text:l}}};await plotly.newPlot(r,[d],m)}static async heatmap(e,t={},r="plot"){const{title:n,width:i=640,height:o=400,colorScale:a="Viridis",xTitle:c="X",yTitle:l="Y"}=t,d={z:e,type:"heatmap",colorscale:a,showscale:!0},m={title:n?{text:n}:void 0,width:i,height:o,xaxis:{title:{text:c}},yaxis:{title:{text:l}}};await plotly.newPlot(r,[d],m)}static async bar(e,t={},r="plot"){const{title:n,width:i=640,height:o=400,color:a="steelblue",xTitle:c="X",yTitle:l="Y"}=t,d={x:e.x.map(v=>v.toString()),y:e.y,type:"bar",marker:{color:e.color||a},name:"Bar"},m={title:n?{text:n}:void 0,width:i,height:o,xaxis:{title:{text:c}},yaxis:{title:{text:l}}};await plotly.newPlot(r,[d],m)}static async radar(e,t={},r="plot"){const{title:n,width:i=400,height:o=400,color:a="steelblue"}=t,c=[...e.x,e.x[0]],d={r:[...e.y,e.y[0]],theta:c,type:"scatterpolar",mode:"lines+markers",fill:"toself",line:{color:a},marker:{color:a,size:8},name:"Radar"},m={title:n?{text:n}:void 0,width:i,height:o,polar:{radialaxis:{visible:!0,range:[0,Math.max(...e.y)*1.1]}}};await plotly.newPlot(r,[d],m)}static async timeSeries(e,t={},r="plot"){const{title:n,width:i=640,height:o=400,xTitle:a="Time",yTitle:c="Value"}=t,l={x:e.x,y:e.y,type:"scatter",mode:"lines",line:{width:2},name:"Time Series"},d={title:n?{text:n}:void 0,width:i,height:o,xaxis:{title:{text:a}},yaxis:{title:{text:c}}};await plotly.newPlot(r,[l],d)}static async matrix(e,t={},r="plot"){const{title:n,width:i=640,height:o=400,xTitle:a="Position",yTitle:c="Time Step"}=t,d={z:e.slice().reverse(),type:"heatmap",colorscale:[[0,"white"],[1,"black"]],showscale:!1,hoverinfo:"none"},m={title:n?{text:n}:void 0,width:i,height:o,xaxis:{title:{text:a},showticklabels:!1},yaxis:{title:{text:c},showticklabels:!1}};await plotly.newPlot(r,[d],m)}static async surface(e,t={},r="plot"){const{title:n,width:i=640,height:o=400,colorScale:a="Viridis",xTitle:c="X",yTitle:l="Y",zTitle:d="Z"}=t,m={x:e.x,y:e.y,z:e.z,type:"surface",colorscale:a},v={title:n?{text:n}:void 0,width:i,height:o,scene:{xaxis:{title:{text:c}},yaxis:{title:{text:l}},zaxis:{title:{text:d}}}};await plotly.newPlot(r,[m],v)}static async multiLine(e,t={},r="plot"){const{title:n,width:i=640,height:o=400,xTitle:a="X",yTitle:c="Y"}=t,l=e.map((m,v)=>({x:m.x,y:m.y,type:"scatter",mode:"lines",name:`Series ${v+1}`,line:{width:2}})),d={title:n?{text:n}:void 0,width:i,height:o,xaxis:{title:{text:a}},yaxis:{title:{text:c}}};await plotly.newPlot(r,l,d)}static async histogram(e,t={},r="plot"){const{title:n,width:i=640,height:o=400,color:a="steelblue",xTitle:c="Value",yTitle:l="Frequency"}=t,d={x:e.x,type:"histogram",marker:{color:a},name:"Histogram"},m={title:n?{text:n}:void 0,width:i,height:o,xaxis:{title:{text:c}},yaxis:{title:{text:l}}};await plotly.newPlot(r,[d],m)}static async boxPlot(e,t={},r="plot"){const{title:n,width:i=640,height:o=400,yTitle:a="Value"}=t,c=e.map((d,m)=>({y:d.y,type:"box",name:`Dataset ${m+1}`})),l={title:n?{text:n}:void 0,width:i,height:o,yaxis:{title:{text:a}}};await plotly.newPlot(r,c,l)}static async violin(e,t={},r="plot"){const{title:n,width:i=640,height:o=400,yTitle:a="Value"}=t,c=e.map((d,m)=>({y:d.y,type:"violin",name:`Dataset ${m+1}`,box:{visible:!0},meanline:{visible:!0}})),l={title:n?{text:n}:void 0,width:i,height:o,yaxis:{title:{text:a}}};await plotly.newPlot(r,c,l)}static async contour(e,t={},r="plot"){const{title:n,width:i=640,height:o=400,colorScale:a="Viridis",xTitle:c="X",yTitle:l="Y"}=t,d={x:e.x,y:e.y,z:e.z,type:"contour",colorscale:a,showscale:!0},m={title:n?{text:n}:void 0,width:i,height:o,xaxis:{title:{text:c}},yaxis:{title:{text:l}}};await plotly.newPlot(r,[d],m)}static async scatter3D(e,t={},r="plot"){const{title:n,width:i=640,height:o=400,color:a="steelblue",xTitle:c="X",yTitle:l="Y",zTitle:d="Z"}=t,m={x:e.x,y:e.y,z:e.z,type:"scatter3d",mode:"markers",marker:{color:e.color||a,size:4,opacity:.8},name:"3D Scatter"},v={title:n?{text:n}:void 0,width:i,height:o,scene:{xaxis:{title:{text:c}},yaxis:{title:{text:l}},zaxis:{title:{text:d}}}};await plotly.newPlot(r,[m],v)}static async animate(e,t={},r="plot"){const{title:n,width:i=640,height:o=400,duration:a=500,transition:c=100}=t,l=e[0]?.data||[],d={title:n?{text:n}:void 0,width:i,height:o,updatemenus:[{type:"buttons",showactive:!1,buttons:[{label:"Play",method:"animate",args:[null,{frame:{duration:a,redraw:!0},transition:{duration:c},fromcurrent:!0}]},{label:"Pause",method:"animate",args:[[null],{frame:{duration:0,redraw:!1},mode:"immediate",transition:{duration:0}}]}]}],...e[0]?.layout},m=e.map((v,w)=>({name:w.toString(),data:v.data,layout:v.layout}));await Ze.newPlot(r,l,d),await plotly.addFrames(r,m)}static async candlestick(e,t={},r="plot"){const{title:n,width:i=640,height:o=400,xTitle:a="Time",yTitle:c="Price"}=t,l={x:e.x,open:e.open,high:e.high,low:e.low,close:e.close,type:"candlestick",name:"OHLC"},d={title:n?{text:n}:void 0,width:i,height:o,xaxis:{title:{text:a}},yaxis:{title:{text:c}}};await plotly.newPlot(r,[l],d)}}class la{static plotEvolution(e,t={}){const{title:r="Cellular Automata Evolution",width:n=600,height:i=400,colorScheme:o="binary",showAxis:a=!1}=t,c=[];return e.forEach((l,d)=>{l.forEach((m,v)=>{c.push({x:v,y:e.length-1-d,value:m})})}),or.matrix(e,{title:r,width:n,height:i,showAxis:a})}static plotGeneration(e,t={}){const{title:r="CA Generation",width:n=600,height:i=100}=t,o={x:e.map((a,c)=>c),y:e.map(()=>0),color:e.map(a=>a?"black":"white")};return or.scatter(o,{title:r,width:n,height:i,showAxis:!1})}static compareRules(e,t={}){const{width:r=300,height:n=200,colorScheme:i="binary"}=t;return e.map(({ruleNumber:o,history:a})=>this.plotEvolution(a,{title:`Rule ${o}`,width:r,height:n,colorScheme:i,showAxis:!1}))}static createAnimationData(e){return e.map((t,r)=>({frame:r,data:t.map((n,i)=>({x:i,y:0,value:n}))}))}static extractPatterns(e){const t=[],r=[],n=[],i=e[0]?.length||0;for(let o=0;o<i;o++){const a=e.map(l=>l[o]),c=this.findPeriod(a.filter(l=>l!==void 0));c>1&&c<10&&t.push({position:o,period:c})}if(e.length>5){const o=e[e.length-1],a=e[e.length-2];if(o&&a)for(let c=0;c<i-3;c++)o.slice(c,c+3).every((d,m)=>d===a[c+m]&&d===1)&&n.push({position:c,width:3})}return{oscillators:t,gliders:r,stillLifes:n}}static findPeriod(e){if(e.length<4)return 1;for(let t=1;t<=Math.floor(e.length/2);t++){let r=!0;for(let n=t;n<e.length;n++)if(e[n]!==e[n-t]){r=!1;break}if(r)return t}return 1}static plotDensity(e,t={}){const{title:r="CA Density Over Time",width:n=600,height:i=300}=t,o=e.map((c,l)=>({time:l,density:c.reduce((d,m)=>d+m,0)/c.length})),a={x:o.map(c=>c.time),y:o.map(c=>c.density)};return or.line(a,{title:r,width:n,height:i,color:"steelblue",showAxis:!0})}static plotSpacetime(e,t={}){const{title:r="Spacetime Diagram",width:n=600,height:i=400,showGrid:o=!1}=t,a=[];return e.forEach((c,l)=>{c.forEach((d,m)=>{a.push({x:m,y:e.length-1-l,value:d,border:o})})}),or.matrix(e,{title:r,width:n,height:i,showAxis:!1})}}const zr=Object.freeze(Object.defineProperty({__proto__:null,CAVisualizer:la},Symbol.toStringTag,{value:"Module"}));let ut=null,Ci=!1;async function ua(){if(Ci)return ut;Ci=!0;try{if(typeof window<"u"&&window.Plotly)return ut=window.Plotly,ut;if(typeof window>"u"){const e=await import("plotly.js");return ut=e.default||e,ut}return null}catch{return console.warn("Plotly.js not available. Visualization methods will return placeholder data."),null}}class da{static async plotLoops(e,t=4,r=1/4,n=null,i={}){const{container:o="loop-plot",title:a="Loop Visualization",showDurationArcs:c=!0,showMarkers:l=!0,showShapes:d=!0,colorScheme:m="colorblind"}=i,v=Object.values(e),w=n||this.generateColors(v.length,m),P=[];v.forEach(($,b)=>{if(!$.notes||$.notes.length===0)return;const S=$.notes.filter(x=>x.pitch!==null);if(S.length!==0&&((c||l)&&S.forEach(x=>{const N=x.time/t*360,z=x.duration/t*360;if(c&&z>1){const q=this.generateArcPoints(N,z,50),L=Array(50).fill(v.length-b-1);P.push({type:"scatterpolar",r:L,theta:q,mode:"lines",line:{color:"rgba(60, 60, 60, 0.65)",width:8},name:`${$.label} Duration`,showlegend:!1})}l&&[N,(N+z)%360].forEach(q=>{P.push({type:"scatterpolar",r:[v.length-b-.9,v.length-b-1.1],theta:[q,q],mode:"lines",line:{color:"Black",width:3},name:`${$.label} Markers`,showlegend:!1})})}),d)){const x=S.map(N=>N.time/t*360);x.length>1&&(x.push(x[0]),P.push({type:"scatterpolar",r:Array(x.length).fill(v.length-b-1),theta:x,mode:"lines",line:{color:"rgba(0, 0, 0, 0.65)",width:1},fill:"toself",fillcolor:w[b%w.length],name:$.label,showlegend:!1}))}});const g=this.generateTickValues(t,r),h=this.generateTickLabels(t,r),p=v.map($=>$.label).reverse(),u={title:{text:a},polar:{radialaxis:{visible:!0,range:[v.length,-.1],tickvals:Array.from({length:v.length},($,b)=>b),ticktext:p},angularaxis:{tickvals:g,ticktext:h,direction:"clockwise",rotation:90}},template:"none",showlegend:!1},f={responsive:!0,displayModeBar:!0},y=await ua();if(!y)throw new Error("Plotly.js not available for visualization");return y.newPlot(o,P,u,f)}static generateColors(e,t="colorblind"){const r=[];switch(t){case"colorblind":const n=["rgba(230, 159, 0, 0.65)","rgba(86, 180, 233, 0.65)","rgba(0, 158, 115, 0.65)","rgba(240, 228, 66, 0.65)","rgba(0, 114, 178, 0.65)","rgba(213, 94, 0, 0.65)","rgba(204, 121, 167, 0.65)"];for(let o=0;o<e;o++)r.push(n[o%n.length]);break;case"viridis":const i=["rgba(68, 1, 84, 0.65)","rgba(59, 82, 139, 0.65)","rgba(33, 144, 140, 0.65)","rgba(94, 201, 98, 0.65)","rgba(253, 231, 37, 0.65)"];for(let o=0;o<e;o++)if(e<=i.length)r.push(i[o]);else{const c=o/(e-1)*(i.length-1),l=Math.floor(c);r.push(i[l])}break;case"classic":default:for(let o=0;o<e;o++){const a=o/e,c=this.hsvToRgb(a,1,1);r.push(`rgba(${Math.round(c.r*255)}, ${Math.round(c.g*255)}, ${Math.round(c.b*255)}, 0.5)`)}break}return r}static hsvToRgb(e,t,r){let n,i,o;const a=Math.floor(e*6),c=e*6-a,l=r*(1-t),d=r*(1-c*t),m=r*(1-(1-c)*t);switch(a%6){case 0:n=r,i=m,o=l;break;case 1:n=d,i=r,o=l;break;case 2:n=l,i=r,o=m;break;case 3:n=l,i=d,o=r;break;case 4:n=m,i=l,o=r;break;case 5:n=r,i=l,o=d;break;default:n=i=o=0}return{r:n,g:i,b:o}}static generateArcPoints(e,t,r){const n=[];for(let i=0;i<r;i++){const o=e+i/(r-1)*t;n.push(o%360)}return n}static generateTickValues(e,t){const r=[],n=Math.floor(e/t);for(let i=0;i<n;i++)r.push(i*360/n);return r}static generateTickLabels(e,t){const r=[],n=Math.floor(e/t);for(let i=0;i<n;i++){const o=i*t%e;r.push(o.toString())}return r}}const Ni=Object.freeze(Object.defineProperty({__proto__:null,LoopVisualizer:da},Symbol.toStringTag,{value:"Module"}));Ge.default=Dr,Ge.jm=Dr,Object.defineProperties(Ge,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));

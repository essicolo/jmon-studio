<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Sampler Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        
        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #005a87;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .success {
            color: green;
            font-weight: bold;
        }
        
        .error {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Complete Instrument Sampler Test</h1>
    
    <div class="section">
        <h2>Test Complete Sampling (88 keys)</h2>
        <p>This test loads a complete MIDI range (21-108) with all semitones for maximum quality.</p>
        
        <button onclick="testCompleteSampling()">Load Complete Instrument</button>
        <button onclick="testPlayScale()">Play C Major Scale</button>
        <button onclick="testPlayChord()">Play C Major Chord</button>
        <button onclick="clearLog()">Clear Log</button>
        
        <div>
            <label>
                Instrument:
                <select id="instrumentSelect">
                    <option value="0">Acoustic Grand Piano</option>
                    <option value="24" selected>Acoustic Guitar (nylon)</option>
                    <option value="40">Violin</option>
                    <option value="56">Trumpet</option>
                    <option value="73">Flute</option>
                </select>
            </label>
        </div>
    </div>
    
    <div class="section">
        <h2>Loading Progress & Debug Log</h2>
        <div id="log" class="log">Ready to test complete sampling...\n</div>
    </div>

    <!-- Load Tone.js -->
    <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
    
    <!-- Load JMON library -->
    <script src="./dist/jmon.umd.js"></script>

    <script>
        let currentSampler = null;
        let logElement = document.getElementById('log');
        let loadedCount = 0;
        let totalSamples = 0;
        
        function log(message) {
            console.log(message);
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            logElement.textContent = '';
            loadedCount = 0;
            totalSamples = 0;
        }
        
        async function testCompleteSampling() {
            log('=== Testing Complete Sampling (21-108 MIDI range) ===');
            
            try {
                if (!window.Tone) {
                    log('❌ ERROR: Tone.js not loaded');
                    return;
                }
                
                if (!window.jmon || !window.jmon.instruments) {
                    log('❌ ERROR: JMON library not loaded properly');
                    return;
                }
                
                const instrumentSelect = document.getElementById('instrumentSelect');
                const gmProgram = parseInt(instrumentSelect.value);
                const instrumentName = instrumentSelect.options[instrumentSelect.selectedIndex].text;
                
                log(`✓ Starting complete sampling for ${instrumentName} (GM ${gmProgram})`);
                
                // Start audio context
                if (Tone.context.state !== 'running') {
                    await Tone.start();
                    log('✓ Audio context started');
                }
                
                // Generate complete URL map
                log('📋 Generating complete sample URLs...');
                const urls = jmon.instruments.generateSamplerUrls(gmProgram);
                totalSamples = Object.keys(urls).length;
                
                log(`📊 Generated ${totalSamples} sample URLs for complete range`);
                log(`📍 Range: ${Object.keys(urls).sort().join(', ')}`);
                
                // Show a few examples
                const urlEntries = Object.entries(urls);
                log(`📝 Sample URLs (first 5):`);
                urlEntries.slice(0, 5).forEach(([note, url]) => {
                    log(`   ${note}: ${url.substring(url.lastIndexOf('/') + 1)}`);
                });
                
                loadedCount = 0;
                
                // Create progress-tracking sampler
                log('🔄 Creating Tone.js Sampler with progress tracking...');
                
                currentSampler = new Tone.Sampler({
                    urls: urls,
                    release: 1.5,
                    baseUrl: '',
                    onload: (buffer, note) => {
                        loadedCount++;
                        const percentage = Math.round((loadedCount / totalSamples) * 100);
                        if (loadedCount % 10 === 0 || loadedCount === totalSamples) {
                            log(`⏳ Loading progress: ${loadedCount}/${totalSamples} (${percentage}%)`);
                        }
                        
                        if (loadedCount === totalSamples) {
                            log(`✅ SUCCESS: All ${totalSamples} samples loaded!`);
                            log('🎵 Ready to play music');
                        }
                    },
                    onerror: (error, note) => {
                        log(`❌ Error loading sample ${note || 'unknown'}: ${error}`);
                    }
                }).toDestination();
                
                log('⏱️ Sampler creation initiated, loading samples...');
                
                // Set a timeout to check final status
                setTimeout(() => {
                    if (loadedCount < totalSamples) {
                        log(`⚠️ Loading incomplete: ${loadedCount}/${totalSamples} loaded`);
                        log('🔄 Some samples may still be loading...');
                    }
                }, 10000); // Check after 10 seconds
                
            } catch (error) {
                log(`❌ FATAL ERROR: ${error.message}`);
                console.error(error);
            }
        }
        
        async function testPlayScale() {
            log('=== Testing C Major Scale Playback ===');
            
            if (!currentSampler) {
                log('❌ No sampler loaded. Run "Load Complete Instrument" first.');
                return;
            }
            
            if (loadedCount < totalSamples * 0.5) {
                log('⚠️ Warning: Less than 50% of samples loaded, playback may have gaps');
            }
            
            try {
                // C Major scale: C4, D4, E4, F4, G4, A4, B4, C5
                const scale = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
                
                log(`🎵 Playing C Major scale (${scale.join(' → ')})`);
                
                for (let i = 0; i < scale.length; i++) {
                    const note = scale[i];
                    const time = Tone.now() + (i * 0.5);
                    
                    currentSampler.triggerAttackRelease(note, '4n', time);
                    log(`♪ Scheduled ${note} at time ${time.toFixed(2)}s`);
                }
                
                log('✓ Scale playback scheduled');
                
            } catch (error) {
                log(`❌ Scale playback error: ${error.message}`);
            }
        }
        
        async function testPlayChord() {
            log('=== Testing C Major Chord Playback ===');
            
            if (!currentSampler) {
                log('❌ No sampler loaded. Run "Load Complete Instrument" first.');
                return;
            }
            
            try {
                // C Major chord: C4, E4, G4
                const chord = ['C4', 'E4', 'G4'];
                const time = Tone.now() + 0.1;
                
                log(`🎵 Playing C Major chord (${chord.join(' + ')})`);
                
                chord.forEach(note => {
                    currentSampler.triggerAttackRelease(note, '2n', time);
                    log(`♪ Triggered ${note}`);
                });
                
                log('✓ Chord playback triggered');
                
            } catch (error) {
                log(`❌ Chord playback error: ${error.message}`);
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            log('🚀 Page loaded');
            log(`✓ Tone.js available: ${!!window.Tone} (version: ${Tone?.version || 'unknown'})`);
            log(`✓ JMON available: ${!!window.jmon} (instruments: ${!!window.jmon?.instruments})`);
            
            if (window.jmon && window.jmon.instruments) {
                log(`✓ Available strategies: minimal, balanced, quality, complete`);
                log(`✓ Default strategy: complete (all 88 keys)`);
            }
            
            log('📖 Instructions:');
            log('  1. Select an instrument');
            log('  2. Click "Load Complete Instrument"');
            log('  3. Wait for all samples to load');
            log('  4. Test playback with scale or chord');
        });
    </script>
</body>
</html>

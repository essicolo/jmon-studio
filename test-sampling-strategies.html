<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sampling Strategies Comparison</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .strategy-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        
        .strategy-section.active {
            border-color: #007cba;
            background: #f0f8ff;
        }
        
        .note-visualization {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            margin: 15px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        
        .note {
            width: 30px;
            height: 20px;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            border-radius: 3px;
        }
        
        .note.sampled {
            background: #007cba;
            color: white;
            font-weight: bold;
        }
        
        .note.interpolated {
            background: #ffd700;
            color: black;
        }
        
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #005a87;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            margin: 5px;
        }
        
        .stats {
            margin: 10px 0;
            font-weight: bold;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .comparison-table th, .comparison-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .comparison-table th {
            background: #f5f5f5;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Tone.js Sampler: Sampling Strategies Explained</h1>
    
    <div class="controls">
        <label>Choose GM Instrument: 
            <select id="instrumentSelect">
                <option value="0">Acoustic Grand Piano</option>
                <option value="24" selected>Acoustic Guitar (nylon)</option>
                <option value="56">Trumpet</option>
                <option value="73">Flute</option>
            </select>
        </label>
        
        <label>MIDI Range: 
            <select id="rangeSelect">
                <option value="36,84" selected>C2 to C6 (Standard)</option>
                <option value="48,72">C3 to C5 (Compact)</option>
                <option value="21,108">A0 to C8 (Full Piano)</option>
            </select>
        </label>
        
        <button onclick="updateVisualizations()">Update Visualizations</button>
        <button onclick="testAllStrategies()">Test All Strategies</button>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: #007cba;"></div>
            <span>Sampled (direct audio file)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ffd700;"></div>
            <span>Interpolated (pitch-shifted)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: white; border: 1px solid #ccc;"></div>
            <span>Not covered</span>
        </div>
    </div>

    <div id="strategies-container"></div>

    <h2>Strategy Comparison</h2>
    <table class="comparison-table">
        <tr>
            <th>Strategy</th>
            <th>Sample Count</th>
            <th>Network Requests</th>
            <th>Memory Usage</th>
            <th>Sound Quality</th>
            <th>Loading Time</th>
            <th>Best For</th>
        </tr>
        <tr>
            <td><strong>Minimal</strong></td>
            <td>5-8</td>
            <td>Low</td>
            <td>~50-150 KB</td>
            <td>Basic</td>
            <td>Fast</td>
            <td>Simple melodies, testing</td>
        </tr>
        <tr>
            <td><strong>Balanced</strong></td>
            <td>12-16</td>
            <td>Medium</td>
            <td>~150-400 KB</td>
            <td>Good</td>
            <td>Medium</td>
            <td>Most musical applications</td>
        </tr>
        <tr>
            <td><strong>Quality</strong></td>
            <td>16-20</td>
            <td>Medium-High</td>
            <td>~250-600 KB</td>
            <td>Very Good</td>
            <td>Slower</td>
            <td>Professional music</td>
        </tr>
        <tr>
            <td><strong>Complete</strong></td>
            <td>48+</td>
            <td>Very High</td>
            <td>~800KB-2MB</td>
            <td>Perfect</td>
            <td>Slow</td>
            <td>Studio recording</td>
        </tr>
    </table>

    <!-- Load Tone.js and JMON library -->
    <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
    <script src="./dist/jmon.umd.js"></script>

    <script>
        const strategies = [
            { name: 'minimal', title: 'Minimal Strategy', description: 'Sample every octave + middle C' },
            { name: 'balanced', title: 'Balanced Strategy', description: 'Sample every major third (4 semitones)' },
            { name: 'quality', title: 'Quality Strategy', description: 'Sample every minor third (3 semitones)' },
            { name: 'complete', title: 'Complete Strategy', description: 'Sample every semitone' }
        ];

        let currentSamplers = {};

        function midiToNoteName(midi) {
            const noteNames = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
            const octave = Math.floor(midi / 12) - 1;
            const noteIndex = midi % 12;
            return `${noteNames[noteIndex]}${octave}`;
        }

        function createNoteVisualization(sampledNotes, minMidi, maxMidi) {
            const container = document.createElement('div');
            container.className = 'note-visualization';
            
            for (let midi = minMidi; midi <= maxMidi; midi++) {
                const noteName = midiToNoteName(midi);
                const noteDiv = document.createElement('div');
                noteDiv.className = 'note';
                noteDiv.textContent = noteName;
                noteDiv.title = `MIDI ${midi}: ${noteName}`;
                
                if (sampledNotes.includes(noteName)) {
                    noteDiv.classList.add('sampled');
                    noteDiv.title += ' (sampled)';
                } else {
                    // Find nearest sampled note
                    const sampledMidis = sampledNotes.map(note => {
                        const noteIdx = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B']
                            .indexOf(note.slice(0, -1));
                        const octave = parseInt(note.slice(-1));
                        return 12 * (octave + 1) + noteIdx;
                    }).filter(m => !isNaN(m));
                    
                    if (sampledMidis.length > 0) {
                        const nearest = sampledMidis.reduce((prev, curr) => 
                            Math.abs(curr - midi) < Math.abs(prev - midi) ? curr : prev
                        );
                        const distance = Math.abs(nearest - midi);
                        
                        if (distance <= 6) { // Within reasonable pitch-shift range
                            noteDiv.classList.add('interpolated');
                            noteDiv.title += ` (pitch-shifted from ${midiToNoteName(nearest)}, ${distance} semitones)`;
                        } else {
                            noteDiv.title += ' (poor quality - too far from samples)';
                            noteDiv.style.background = '#ff6b6b';
                            noteDiv.style.color = 'white';
                        }
                    }
                }
                
                container.appendChild(noteDiv);
            }
            
            return container;
        }

        function updateVisualizations() {
            const instrument = parseInt(document.getElementById('instrumentSelect').value);
            const [minMidi, maxMidi] = document.getElementById('rangeSelect').value.split(',').map(Number);
            
            const container = document.getElementById('strategies-container');
            container.innerHTML = '';
            
            strategies.forEach(strategy => {
                const section = document.createElement('div');
                section.className = 'strategy-section';
                
                // Generate URLs for this strategy
                const urls = jmon.instruments.generateSamplerUrls(instrument, undefined, [minMidi, maxMidi], strategy.name);
                const sampledNotes = Object.keys(urls).sort();
                
                section.innerHTML = `
                    <h3>${strategy.title}</h3>
                    <p>${strategy.description}</p>
                    <div class="stats">
                        Samples: ${sampledNotes.length} | 
                        Network requests: ${sampledNotes.length} | 
                        Estimated size: ~${Math.round(sampledNotes.length * 25)}KB
                    </div>
                    <details>
                        <summary>Sample Notes (${sampledNotes.length})</summary>
                        <p><strong>Notes:</strong> ${sampledNotes.join(', ')}</p>
                    </details>
                `;
                
                // Add visualization
                const visualization = createNoteVisualization(sampledNotes, minMidi, maxMidi);
                section.appendChild(visualization);
                
                // Add test button
                const testButton = document.createElement('button');
                testButton.textContent = `Test ${strategy.title}`;
                testButton.onclick = () => testStrategy(strategy.name, instrument, [minMidi, maxMidi], section);
                section.appendChild(testButton);
                
                container.appendChild(section);
            });
        }

        async function testStrategy(strategyName, instrument, range, sectionElement) {
            try {
                // Clear active states
                document.querySelectorAll('.strategy-section').forEach(s => s.classList.remove('active'));
                sectionElement.classList.add('active');
                
                if (Tone.context.state !== 'running') {
                    await Tone.start();
                }
                
                // Stop any existing samplers
                Object.values(currentSamplers).forEach(sampler => {
                    try { sampler.dispose(); } catch(e) {}
                });
                currentSamplers = {};
                
                console.log(`Testing ${strategyName} strategy...`);
                
                const urls = jmon.instruments.generateSamplerUrls(instrument, undefined, range, strategyName);
                
                const sampler = new Tone.Sampler({
                    urls: urls,
                    onload: () => {
                        console.log(`${strategyName} sampler loaded successfully`);
                        // Play a simple melody to demonstrate
                        const notes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
                        const now = Tone.now();
                        notes.forEach((note, i) => {
                            sampler.triggerAttackRelease(note, '8n', now + i * 0.2);
                        });
                    },
                    onerror: (error) => {
                        console.error(`Failed to load ${strategyName} sampler:`, error);
                    }
                }).toDestination();
                
                currentSamplers[strategyName] = sampler;
                
            } catch (error) {
                console.error(`Error testing ${strategyName}:`, error);
            }
        }

        async function testAllStrategies() {
            const instrument = parseInt(document.getElementById('instrumentSelect').value);
            const [minMidi, maxMidi] = document.getElementById('rangeSelect').value.split(',').map(Number);
            
            for (const strategy of strategies) {
                const section = document.querySelector('.strategy-section:nth-child(' + (strategies.indexOf(strategy) + 1) + ')');
                await testStrategy(strategy.name, instrument, [minMidi, maxMidi], section);
                await new Promise(resolve => setTimeout(resolve, 3000)); // Wait 3 seconds between tests
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            console.log('Sampling Strategies Demo loaded');
            console.log(`Tone.js available: ${!!window.Tone}`);
            console.log(`JMON library available: ${!!window.jmon}`);
            
            if (window.jmon && window.jmon.instruments) {
                updateVisualizations();
            } else {
                console.error('JMON library not properly loaded');
            }
        });
    </script>
</body>
</html>
